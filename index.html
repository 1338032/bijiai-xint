<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>笔记AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0f0f14;--card:#1a1a24;--card2:#22222f;
--accent:#6c5ce7;--accent2:#a29bfe;
--text:#e8e8f0;--text2:#9090a8;
--danger:#ff6b6b;--success:#51cf66;
--border:#2a2a3a;--shadow:0 4px 20px rgba(0,0,0,0.4);
}
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);color:var(--text);
min-height:100vh;overflow-x:hidden;
}
body.theme-warm{--accent:#e67e22;--accent2:#f0b27a;--border:#3a2a1a;}
body.theme-green{--accent:#27ae60;--accent2:#58d68d;--border:#1a3a2a;}
body.theme-blue{--accent:#2980b9;--accent2:#5dade2;--border:#1a2a3a;}
body.theme-light{
--bg:#f5f5f8;--card:#ffffff;--card2:#eeeef3;
--text:#1a1a2e;--text2:#6a6a8a;--border:#d8d8e8;
--shadow:0 4px 20px rgba(0,0,0,0.08);
}
body.theme-light.theme-warm{--accent:#e67e22;--accent2:#d35400;}
body.theme-light.theme-green{--accent:#27ae60;--accent2:#1e8449;}
body.theme-light.theme-blue{--accent:#2980b9;--accent2:#1a5276;}
body.theme-light .bnav{background:rgba(245,245,248,.92);}
body.theme-light .rd-hdr{background:rgba(245,245,248,.88);}
/* LOGO FONT - 不受自定义字体影响 */
.logo-text{
font-family:'ZCOOL QingKe HuangYou','PingFang SC','Microsoft YaHei',sans-serif!important;
}
/* SPLASH */
.splash{
position:fixed;inset:0;z-index:10000;
background:linear-gradient(135deg,#0a0a12 0%,#12121f 50%,#0d0d18 100%);
display:flex;flex-direction:column;align-items:center;justify-content:center;
transition:opacity 0.8s,transform 0.8s;
overflow:hidden;
}
.splash.hide{opacity:0;transform:scale(1.05);pointer-events:none;}
.splash::before{
content:'';position:absolute;inset:0;
background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(108,92,231,.15),transparent),
radial-gradient(ellipse 60% 40% at 80% 100%,rgba(162,155,254,.1),transparent),
radial-gradient(ellipse 50% 30% at 10% 80%,rgba(108,92,231,.08),transparent);
pointer-events:none;
}
.splash-particles{
position:absolute;inset:0;overflow:hidden;pointer-events:none;
}
.splash-particle{
position:absolute;width:4px;height:4px;
background:var(--accent2);border-radius:50%;
opacity:0;animation:floatUp 8s infinite;
}
@keyframes floatUp{
0%{transform:translateY(100vh) scale(0);opacity:0;}
10%{opacity:.6;}
90%{opacity:.6;}
100%{transform:translateY(-20vh) scale(1);opacity:0;}
}
.splash-glow{
position:absolute;width:300px;height:300px;
background:radial-gradient(circle,rgba(108,92,231,.2) 0%,transparent 70%);
border-radius:50%;filter:blur(40px);
animation:pulseGlow 4s ease-in-out infinite;
}
@keyframes pulseGlow{
0%,100%{transform:scale(1);opacity:.5;}
50%{transform:scale(1.2);opacity:.8;}
}
.splash-card{
position:relative;z-index:10;
background:linear-gradient(145deg,rgba(26,26,40,.7) 0%,rgba(40,35,60,.5) 100%);
backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
border:1px solid rgba(108,92,231,.3);
border-radius:28px;padding:52px 60px;
box-shadow:0 12px 40px rgba(0,0,0,.4),
0 0 0 1px rgba(255,255,255,.08) inset,
0 0 100px rgba(108,92,231,.15),
0 -20px 60px rgba(162,155,254,.05) inset;
text-align:center;
animation:cardFloat 5s ease-in-out infinite;
}
@keyframes cardFloat{
0%,100%{transform:translateY(0) rotate(0deg);}
25%{transform:translateY(-5px) rotate(0.5deg);}
50%{transform:translateY(-10px) rotate(0deg);}
75%{transform:translateY(-5px) rotate(-0.5deg);}
}
.splash-icon{
width:88px;height:88px;margin:0 auto 20px;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.1));
border-radius:22px;
display:flex;align-items:center;justify-content:center;
box-shadow:0 8px 32px rgba(108,92,231,.3),0 0 0 1px rgba(108,92,231,.2);
animation:iconPulse 2s ease-in-out infinite;
overflow:hidden;
}
.splash-icon img{
width:100%;height:100%;object-fit:cover;
filter:drop-shadow(0 2px 8px rgba(108,92,231,.4));
}
@keyframes iconPulse{
0%,100%{box-shadow:0 8px 24px rgba(108,92,231,.4);}
50%{box-shadow:0 12px 36px rgba(108,92,231,.6);}
}
.splash-logo{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:36px;font-weight:400;letter-spacing:6px;
background:linear-gradient(135deg,#fff 0%,var(--accent2) 50%,var(--accent) 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;margin-bottom:8px;
animation:shimmer 3s ease-in-out infinite;
background-size:200% 100%;
text-shadow:0 0 40px rgba(108,92,231,.3);
}
@keyframes shimmer{ 0%{background-position:0% 50%;filter:brightness(1);} 25%{filter:brightness(1.1);} 50%{background-position:100% 50%;filter:brightness(1.2);} 75%{filter:brightness(1.1);} 100%{background-position:0% 50%;filter:brightness(1);} }
.splash-sub{
font-size:13px;color:rgba(255,255,255,.6);
letter-spacing:2px;margin-bottom:32px;
}
.splash-progress{
width:200px;height:3px;
background:rgba(255,255,255,.1);
border-radius:3px;overflow:hidden;
margin-bottom:16px;
}
.splash-progress-bar{
height:100%;width:0%;
background:linear-gradient(90deg,var(--accent),var(--accent2));
border-radius:3px;
transition:width .3s ease;
box-shadow:0 0 10px var(--accent);
}
.splash-status{
font-size:11px;color:rgba(255,255,255,.4);
display:flex;align-items:center;justify-content:center;gap:8px;
}
.splash-dot{
width:6px;height:6px;border-radius:50%;
background:var(--accent2);
animation:dotPulse 1.5s ease-in-out infinite;
}
@keyframes dotPulse{
0%,100%{opacity:.4;transform:scale(1);}
50%{opacity:1;transform:scale(1.2);}
}
.splash-corner{
position:absolute;font-size:10px;
color:rgba(255,255,255,.2);font-weight:500;
letter-spacing:1px;
}
.splash-corner.tl{top:24px;left:24px;}
.splash-corner.br{bottom:24px;right:24px;}
.splash-ver{
position:absolute;bottom:24px;left:50%;transform:translateX(-50%);
font-size:10px;color:rgba(255,255,255,.2);
}
.splash-decor{
position:absolute;border:1px solid rgba(108,92,231,.15);
border-radius:50%;pointer-events:none;
}
.splash-decor-1{
width:400px;height:400px;top:-100px;right:-100px;
animation:rotateSlow 30s linear infinite;
}
.splash-decor-2{
width:300px;height:300px;bottom:-80px;left:-80px;
animation:rotateSlow 25s linear infinite reverse;
}
@keyframes rotateSlow{
from{transform:rotate(0deg);}
to{transform:rotate(360deg);}
}

/* APP */
.app{opacity:0;transform:translateY(16px);transition:opacity .5s .2s,transform .5s .2s;padding-bottom:68px;}
.app.show{opacity:1;transform:translateY(0);}

/* HEADER */
.hdr{
position:sticky;top:0;z-index:100;
background:linear-gradient(135deg,var(--card) 0%,var(--bg) 100%);
padding:14px 18px 10px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
}
.hdr-left h1{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:22px;font-weight:400;letter-spacing:2px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
display:flex;align-items:center;gap:8px;
}
.hdr-logo-img{
width:28px;height:28px;border-radius:8px;
object-fit:cover;
filter:drop-shadow(0 2px 4px rgba(108,92,231,.3));
}
.hdr-left .hdr-sub{font-size:10px;color:var(--text2);margin-top:2px;}
.hdr-right{display:flex;gap:8px;}
.hdr-btn{
background:none;border:1px solid var(--border);color:var(--text2);
padding:5px 10px;border-radius:10px;font-size:11px;cursor:pointer;
display:flex;align-items:center;gap:4px;transition:all .3s;
}
.hdr-btn:active{transform:scale(.95);}
.hdr-btn svg{width:15px;height:15px;}

/* BOTTOM NAV */
.bnav{
position:fixed;bottom:0;left:0;right:0;z-index:200;
background:rgba(26,26,36,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
border-top:1px solid var(--border);
display:flex;justify-content:space-around;padding:7px 0 11px;
transition:transform .3s;
}
.bnav-i{
display:flex;flex-direction:column;align-items:center;gap:2px;
cursor:pointer;padding:5px 14px;border-radius:12px;
background:none;border:none;color:var(--text2);font-size:10px;
transition:all .3s;
}
.bnav-i.act{color:var(--accent2);}
.bnav-i svg{width:21px;height:21px;transition:all .3s;}
.bnav-i.act svg{filter:drop-shadow(0 0 5px var(--accent));}

/* PAGES */
.pg{display:none;animation:fadeIn .25s ease;}
.pg.act{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH BAR */
.sbar{display:flex;gap:9px;padding:14px 18px 8px;}
.sbar input{
flex:1;padding:11px 15px;border-radius:13px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;outline:none;transition:border-color .3s;
}
.sbar input:focus{border-color:var(--accent);}
.sbar input::placeholder{color:var(--text2);}
.btn-gen{
padding:11px 18px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
white-space:nowrap;transition:all .3s;
box-shadow:0 3px 12px rgba(108,92,231,.25);
}
.btn-gen:active{transform:scale(.95);box-shadow:0 2px 8px rgba(108,92,231,.4);} .btn-gen::before{ content:'';position:absolute;inset:0; background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent); transform:translateX(-100%);transition:transform .5s; } .btn-gen:active::before{transform:translateX(100%);}
.btn-gen:disabled{opacity:.5;cursor:not-allowed;transform:none;}

/* TAGS */
.tags-sec{padding:4px 18px 8px;}
.tags-wrap{display:flex;flex-wrap:nowrap;gap:7px;align-items:center;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;} .tags-wrap::-webkit-scrollbar{height:2px;} .tags-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;} .tags-wrap .tag,.tags-wrap .tag-add{flex-shrink:0;}
.tag{
padding:5px 13px;border-radius:18px;font-size:11px;cursor:pointer;
transition:all .3s;border:1px solid var(--border);background:var(--card);
color:var(--text2);display:flex;align-items:center;gap:4px;
user-select:none;
}
.tag.act{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 8px rgba(108,92,231,.3);}
.tag .tdel{
width:13px;height:13px;display:none;align-items:center;justify-content:center;
font-size:9px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;
line-height:1;
}
.tag.act .tdel{display:flex;}
.tag-add{
padding:5px 11px;border-radius:18px;font-size:11px;cursor:pointer;
border:1px dashed var(--border);background:transparent;color:var(--accent2);
transition:all .3s;
}

/* TYPE TABS */
.ttabs{display:flex;padding:4px 18px;gap:0;}
.ttab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.ttab.act{color:var(--accent2);border-bottom-color:var(--accent);}

/* ARTICLE CARDS */
.alist{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.acard{
background:linear-gradient(135deg,var(--card) 0%,rgba(108,92,231,.03) 100%);
border-radius:16px;padding:18px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
position:relative;overflow:hidden;
}
.acard::before{
content:'';position:absolute;top:0;left:0;right:0;height:3px;
background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent));
background-size:200% 100%;
opacity:0;transition:opacity .3s;
}
.acard:active::before{opacity:1;}
.acard:active{transform:scale(.97);border-color:var(--accent);box-shadow:0 0 12px rgba(108,92,231,.15);}
.acard-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.acard-t{font-size:15px;font-weight:700;line-height:1.4;flex:1;margin-right:10px;}
.acard-badge{padding:3px 9px;border-radius:9px;font-size:9px;font-weight:600;flex-shrink:0;}
.acard-badge.long{background:rgba(108,92,231,.18);color:var(--accent2);}
.acard-badge.short{background:rgba(81,207,102,.18);color:var(--success);}
.acard-pv{
font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.acard-ft{display:flex;justify-content:space-between;align-items:center;}
.acard-tags{display:flex;gap:5px;flex-wrap:wrap;flex:1;}
.acard-tag{padding:2px 7px;border-radius:7px;font-size:9px;background:var(--card2);color:var(--text2);}
.acard-wc{font-size:10px;color:var(--text2);margin-right:8px;white-space:nowrap;}
.btn-like{
display:flex;align-items:center;gap:3px;padding:5px 11px;border-radius:9px;
border:1px solid var(--border);background:transparent;color:var(--text2);
font-size:11px;cursor:pointer;transition:all .3s;flex-shrink:0;
}
.btn-like.liked{background:rgba(255,107,107,.13);border-color:var(--danger);color:var(--danger);}
.empty-st{text-align:center;padding:50px 18px;color:var(--text2);}
.empty-st svg{width:50px;height:50px;margin-bottom:12px;opacity:.3;}
.empty-st p{font-size:13px;line-height:1.6;}

/* STREAMING INDICATOR */
.stream-card{
background:var(--card);border-radius:15px;padding:16px;
border:1px solid var(--accent);transition:all .3s;
}
.stream-card .stream-title{
font-size:14px;font-weight:600;color:var(--accent2);margin-bottom:8px;
display:flex;align-items:center;gap:8px;
}
.stream-card .stream-body{
font-size:13px;line-height:1.8;color:var(--text);
max-height:200px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word;
}
.stream-card .stream-info{
display:flex;justify-content:space-between;align-items:center;
margin-top:10px;font-size:10px;color:var(--text2);
}
.ldots{display:inline-flex;gap:3px;align-items:center;}
.ldots span{
width:5px;height:5px;border-radius:50%;background:var(--accent2);
animation:bounce 1.4s infinite both;
}
.ldots span:nth-child(2){animation-delay:.16s;}
.ldots span:nth-child(3){animation-delay:.32s;}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

/* READING MODAL */
/* IMMERSIVE READ */
.modal.immersive-read{background:#050508;}
.modal.immersive-read .rd-hdr{display:none;}
.modal.immersive-read .rd-body{padding:30px 28px 140px;}
.modal.immersive-read .rd-title{font-size:24px;text-align:center;margin-bottom:20px;}
.modal.immersive-read .rd-meta{justify-content:center;}
.modal.immersive-read .rd-content{font-size:18px;line-height:2.4;}
.modal.immersive-read .ch-nav{justify-content:center;}
.modal.immersive-read .cont-wrap{display:none!important;}
.modal.immersive-read .rd-settings{display:none!important;}
.immersive-read-bar{
position:fixed;bottom:0;left:0;right:0;z-index:20;
background:rgba(5,5,8,.95);backdrop-filter:blur(10px);
padding:14px 20px;display:none;
border-top:1px solid rgba(108,92,231,.2);
flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
}
.modal.immersive-read .immersive-read-bar{display:flex;}
.immersive-read-bar button{
padding:8px 16px;border-radius:20px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:11px;cursor:pointer;
transition:all .3s;
}
.immersive-read-bar button:active{transform:scale(.95);}
.immersive-read-bar button.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.immersive-read-bar .speed-ctrl{
display:flex;align-items:center;gap:8px;
padding:6px 12px;background:var(--card);border-radius:20px;border:1px solid var(--border);
}
.immersive-read-bar .speed-ctrl span{font-size:10px;color:var(--text2);}
.immersive-read-bar .speed-ctrl input{width:80px;accent-color:var(--accent);}
.immersive-exit-float{
position:fixed;top:20px;right:20px;z-index:100;
padding:10px 18px;border-radius:25px;
background:rgba(108,92,231,.3);border:1px solid var(--accent);
color:#fff;font-size:12px;cursor:pointer;
display:none;backdrop-filter:blur(8px);
box-shadow:0 4px 15px rgba(0,0,0,.3);
}
.modal.immersive-read .immersive-exit-float{display:block;}
.modal{
display:none;position:fixed;inset:0;z-index:500;
background:var(--bg);overflow-y:auto;
}
.modal.show{display:block;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal.fs .rd-hdr{
position:fixed;top:0;left:0;right:0;
background:rgba(15,15,20,.85);backdrop-filter:blur(10px);z-index:10;
}
.modal.fs .rd-body{padding-top:62px;}
.rd-bg{
position:fixed;inset:0;z-index:0;
background-size:cover;background-position:center;
opacity:.50;pointer-events:none;display:none;
}
.rd-hdr{
position:sticky;top:0;z-index:10;
background:rgba(15,15,20,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
padding:14px 18px;display:flex;justify-content:space-between;align-items:center;
border-bottom:1px solid var(--border);
}
.rd-back{
display:flex;align-items:center;gap:5px;background:none;
border:none;color:var(--accent2);font-size:13px;cursor:pointer;padding:4px;
}
.rd-back svg{width:18px;height:18px;}
.rd-acts{
display:flex;gap:6px;
overflow-x:auto;
flex-wrap:nowrap;
-webkit-overflow-scrolling:touch;
padding-bottom:2px;
}
.rd-acts::-webkit-scrollbar{display:none;}
.rd-acts button{
flex-shrink:0;
padding:5px 10px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;white-space:nowrap;
}
.rd-body{padding:22px 20px 70px;position:relative;z-index:1;}
.rd-title{font-size:20px;font-weight:800;line-height:1.4;margin-bottom:12px;}
.rd-meta{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.rd-meta span{font-size:11px;color:var(--text2);padding:3px 9px;background:var(--card);border-radius:7px;}
.ch-nav{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.ch-btn{
padding:5px 12px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.rd-content{
font-size:var(--rd-fontsize,15px);
line-height:var(--rd-lineheight,2);
color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.rd-content p{margin-bottom:10px;text-indent:2em;}
.rd-dir-input{
display:flex;gap:8px;margin-bottom:16px;
}
.rd-dir-input input{
flex:1;padding:10px 14px;border-radius:12px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.rd-dir-input input::placeholder{color:var(--text2);}
.cont-wrap{padding:16px 0;text-align:center;}
.btn-cont{
padding:11px 28px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
box-shadow:0 3px 12px rgba(108,92,231,.25);transition:all .3s;
}
.btn-cont:active{transform:scale(.95);}
.btn-cont:disabled{opacity:.5;}
.btn-undo{
padding:8px 16px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
margin-left:10px;transition:all .3s;
}

/* Reading settings bar */
.rd-settings{
background:var(--card);border-radius:14px;padding:14px;margin-bottom:18px;
border:1px solid var(--border);display:none;
}
.rd-settings.show{display:block;}
.rd-settings h4{font-size:12px;color:var(--text2);margin-bottom:10px;}
.rd-s-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rd-s-row:last-child{margin-bottom:0;}
.rd-s-label{font-size:11px;color:var(--text2);width:50px;flex-shrink:0;}
.rd-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.rd-s-val{font-size:11px;color:var(--accent2);width:35px;text-align:right;}

/* COLLECTION */
.col-hdr{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;}
.col-hdr h2{font-size:17px;font-weight:700;}
.col-cnt{font-size:11px;color:var(--text2);background:var(--card);padding:3px 11px;border-radius:9px;}
.col-search{padding:0 18px 8px;}
.col-search input{
width:100%;padding:9px 14px;border-radius:11px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.col-search input::placeholder{color:var(--text2);}
.sec-div{padding:14px 18px 4px;display:flex;justify-content:space-between;align-items:center;}
.sec-div h3{font-size:14px;font-weight:600;color:var(--text2);}
.bgrid{
padding:0 18px;display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;
}
.bcard{
background:var(--card);border-radius:13px;overflow:hidden;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.bcard:active{transform:scale(.97);}
.bcov{
width:100%;aspect-ratio:3/4;
background:linear-gradient(135deg,var(--card2),var(--card));
display:flex;align-items:center;justify-content:center;
position:relative;overflow:hidden;
}
.bcov img{width:100%;height:100%;object-fit:cover;}
.bcov-ph{
display:flex;flex-direction:column;align-items:center;gap:6px;
font-size:12px;color:var(--text2);
}
.binfo{padding:10px;}
.binfo-t{font-size:12px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.binfo-m{font-size:9px;color:var(--text2);}
.binfo-status{
display:inline-block;padding:1px 6px;border-radius:6px;font-size:8px;
margin-top:3px;
}
.binfo-status.ongoing{background:rgba(108,92,231,.15);color:var(--accent2);}
.binfo-status.complete{background:rgba(81,207,102,.15);color:var(--success);}
.binfo-status.paused{background:rgba(255,107,107,.15);color:var(--danger);}
.bacts{padding:0 10px 10px;display:flex;gap:5px;}
.bact{
flex:1;padding:5px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.bact.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.col-shorts{padding:14px 18px 0;}
.col-shorts h3{font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text2);}
.slist{display:flex;flex-direction:column;gap:9px;padding-bottom:18px;}
.sitem{
background:var(--card);border-radius:11px;padding:12px;
border:1px solid var(--border);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.sitem-info{flex:1;margin-right:8px;}
.sitem-t{font-size:13px;font-weight:600;margin-bottom:3px;}
.sitem-pv{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100vw - 160px);}
.sitem-acts{display:flex;gap:5px;}
.sitem-acts button{
padding:4px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
}
.star-rating{display:flex;gap:2px;margin-top:4px;}
.star-rating span{
font-size:14px;cursor:pointer;color:var(--border);transition:color .2s;
user-select:none;
}
.star-rating span.filled{color:#f1c40f;}

/* USER CARD */
.ucard{
margin:14px 18px;background:var(--card);border-radius:18px;
border:1px solid var(--border);overflow:hidden;
}
.ucard-top{
padding:20px 18px 14px;display:flex;align-items:center;gap:14px;
}
.ucard-avatar{
width:56px;height:56px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
font-size:24px;color:#fff;cursor:pointer;
overflow:hidden;flex-shrink:0;position:relative;
border:2px solid var(--border);transition:all .3s;
}
.ucard-avatar:active{transform:scale(.95);}
.ucard-avatar img{width:100%;height:100%;object-fit:cover;}
.ucard-avatar-hint{
position:absolute;inset:0;background:rgba(0,0,0,.45);
display:flex;align-items:center;justify-content:center;
font-size:10px;color:#fff;opacity:0;transition:opacity .3s;
}
.ucard-avatar:active .ucard-avatar-hint{opacity:1;}
.ucard-info{flex:1;min-width:0;}
.ucard-name{
font-size:16px;font-weight:700;margin-bottom:3px;
display:flex;align-items:center;gap:6px;
}
.ucard-name span{
overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
}
.ucard-name button{
background:none;border:none;color:var(--text2);font-size:12px;
cursor:pointer;padding:2px 6px;flex-shrink:0;
}
.ucard-bio{
font-size:11px;color:var(--text2);line-height:1.5;
display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
overflow:hidden;cursor:pointer;
}
.ucard-stats{
padding:12px 18px 16px;border-top:1px solid var(--border);
display:grid;grid-template-columns:repeat(4,1fr);gap:0;
}
.ucard-stat{
text-align:center;padding:6px 0;
position:relative;
}
.ucard-stat:not(:last-child)::after{
content:'';position:absolute;right:0;top:20%;height:60%;
width:1px;background:var(--border);
}
.ucard-stat-num{
font-size:18px;font-weight:800;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.ucard-stat-label{font-size:9px;color:var(--text2);margin-top:2px;}
/* SETTINGS */
.set-sec{padding:14px 18px;}
/* SETTINGS MODAL */
.set-modal{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.set-modal.show{display:block;animation:slideUp .3s ease;}
.set-modal-hdr{
position:sticky;top:0;z-index:10;
background:var(--bg);padding:14px 18px;
display:flex;align-items:center;gap:10px;
border-bottom:1px solid var(--border);
}
.set-modal-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;
display:flex;align-items:center;gap:5px;
}
.set-modal-hdr button svg{width:18px;height:18px;}
.set-modal-hdr h2{font-size:16px;font-weight:700;flex:1;}
.set-modal-body{padding:18px;}
.set-entry{
background:var(--card);border-radius:14px;padding:16px;
border:1px solid var(--border);margin-bottom:12px;
display:flex;justify-content:space-between;align-items:center;
cursor:pointer;transition:all .3s;
}
.set-entry:active{transform:scale(.98);border-color:var(--accent);}
.set-entry-left{display:flex;align-items:center;gap:12px;}
.set-entry-icon{font-size:22px;}
.set-entry-info h3{font-size:14px;font-weight:600;margin-bottom:2px;}
.set-entry-info p{font-size:11px;color:var(--text2);}
.set-entry-arrow{color:var(--text2);font-size:18px;}
.set-grp{
background:var(--card);border-radius:15px;
border:1px solid var(--border);margin-bottom:13px;overflow:hidden;
}
.set-grp-t{
padding:13px 16px;font-size:14px;font-weight:700;
background:var(--card2);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.set-grp-t svg{width:16px;height:16px;color:var(--text2);transition:transform .3s;}
.set-grp-t.exp svg{transform:rotate(180deg);}
.set-grp-c{padding:14px 16px;display:none;}
.set-grp-c.show{display:block;}
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.fl{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.fi,.fta,.fsel{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
transition:border-color .3s;font-family:inherit;
}
.fi:focus,.fta:focus{border-color:var(--accent);}
.fta{min-height:90px;resize:vertical;line-height:1.6;}
.frow{display:flex;gap:9px;}
.frow .fg{flex:1;}
.plist{display:flex;flex-direction:column;gap:7px;margin-top:9px;}
.pitem{
display:flex;justify-content:space-between;align-items:center;
padding:9px 13px;background:var(--bg);border-radius:9px;border:1px solid var(--border);
}
.pitem-n{font-size:12px;font-weight:500;}
.pitem-a{display:flex;gap:5px;}
.pitem-a button{
padding:3px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;font-size:10px;cursor:pointer;transition:all .3s;
}
.btn-use{color:var(--accent2);border-color:var(--accent)!important;}
.btn-del{color:var(--danger);border-color:rgba(255,107,107,.3)!important;}
.btn-p{
padding:9px 18px;border-radius:11px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
transition:all .3s;width:100%;margin-top:7px;
}
.btn-p:active{transform:scale(.98);}
.btn-s{
padding:9px 18px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;font-weight:500;
cursor:pointer;transition:all .3s;width:100%;margin-top:7px;
}
.theme-opts{display:flex;gap:8px;flex-wrap:wrap;}
.t-opt{
width:36px;height:36px;border-radius:10px;border:2px solid var(--border);
cursor:pointer;transition:all .3s;
}
.t-opt.act{border-color:var(--accent);box-shadow:0 0 8px rgba(108,92,231,.3);}
.t-opt.t0{background:linear-gradient(135deg,#6c5ce7,#a29bfe);}
.t-opt.t1{background:linear-gradient(135deg,#e67e22,#f0b27a);}
.t-opt.t2{background:linear-gradient(135deg,#27ae60,#58d68d);}
.t-opt.t3{background:linear-gradient(135deg,#2980b9,#5dade2);}
.t-opt.t4{background:linear-gradient(135deg,#f5f5f8,#ddd);border-color:#ccc;}
.data-btns{display:flex;flex-direction:column;gap:8px;}
.data-btns button{
padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:7px;transition:all .3s;
}
.data-btns button:active{transform:scale(.98);}
.wc-set{display:flex;align-items:center;gap:8px;}
.wc-set input{width:90px;text-align:center;}

/* Char cards - dynamic */
.char-cards{display:flex;flex-direction:column;gap:12px;}
.char-card{
background:var(--bg);border-radius:12px;padding:14px;
border:1px solid var(--border);position:relative;
}
.char-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.char-card-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.char-card-del{
background:none;border:none;color:var(--danger);font-size:10px;cursor:pointer;
padding:3px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);
}

/* HANDBOOK */
.hb-ov{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.hb-ov.show{display:block;animation:slideUp .3s ease;}
.hb-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:14px 18px;display:flex;align-items:center;gap:8px;
border-bottom:1px solid var(--border);
}
.hb-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;display:flex;align-items:center;gap:5px;
}
.hb-hdr button svg{width:18px;height:18px;}
.hb-hdr h2{font-size:16px;font-weight:700;}
.hb-body{padding:22px 20px 50px;}
.hb-body h3{
font-size:15px;font-weight:700;color:var(--accent2);
margin:22px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--border);
}
.hb-body h3:first-child{margin-top:0;}
.hb-body p{font-size:13px;line-height:1.9;color:var(--text);margin-bottom:9px;}
.hb-body ul{padding-left:18px;margin-bottom:10px;}
.hb-body li{font-size:12px;line-height:1.8;color:var(--text2);margin-bottom:3px;}
.hb-body .notice{
background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.25);
border-radius:11px;padding:13px 15px;margin:14px 0;
}
.hb-body .notice p{color:var(--accent2);font-size:12px;margin:0;}
.hb-body .contact{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);margin-top:10px;
}
.hb-body .contact p{font-size:12px;line-height:2;color:var(--text2);margin:0;}

/* DIALOGS */
.toast{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%) scale(.9);
background:linear-gradient(135deg,var(--card2),var(--card));
color:var(--text);padding:14px 28px;
border-radius:14px;font-size:13px;z-index:9999;opacity:0;
transition:all .3s cubic-bezier(.4,0,.2,1);pointer-events:none;text-align:center;
border:1px solid var(--accent);
box-shadow:0 8px 32px rgba(0,0,0,.3),0 0 20px rgba(108,92,231,.2);
max-width:280px;font-weight:500;
}
.toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.dlg-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.dlg-ov.show{display:flex;}
.dlg-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:310px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.dlg-box h3{font-size:15px;margin-bottom:9px;}
.dlg-box p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px;}
.dlg-btns{display:flex;gap:9px;}
.dlg-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
.dlg-cancel{background:var(--card2);color:var(--text);}
.dlg-ok{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
.dlg-danger{background:var(--danger);color:#fff;}
.inp-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.inp-ov.show{display:flex;}
.inp-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:340px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.inp-box h3{font-size:15px;margin-bottom:13px;}
.inp-box input,.inp-box textarea{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin-bottom:13px;font-family:inherit;
}
.inp-box textarea{min-height:70px;resize:vertical;}
.inp-btns{display:flex;gap:9px;}
.inp-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}

/* Scrollbar */
/* CHAPTER LIST OVERLAY */
.ch-ov{
display:none;position:fixed;inset:0;z-index:550;
background:rgba(0,0,0,.55);align-items:flex-end;justify-content:center;
}
.ch-ov.show{display:flex;}
.ch-panel{
background:var(--card);border-radius:18px 18px 0 0;
width:100%;max-width:500px;max-height:70vh;
padding:0;overflow:hidden;animation:slideUp .3s ease;
display:flex;flex-direction:column;
}
.ch-panel-hdr{
padding:16px 18px 12px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ch-panel-hdr h3{font-size:15px;font-weight:700;}
.ch-panel-hdr span{font-size:11px;color:var(--text2);}
.ch-panel-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;border-radius:8px;
}
.ch-panel-list{
padding:12px 18px 20px;overflow-y:auto;flex:1;
display:flex;flex-direction:column;gap:0;
}
.ch-item{
padding:13px 16px;border-radius:0;border:none;border-bottom:1px solid var(--border);
background:var(--bg);color:var(--text2);font-size:13px;
text-align:left;cursor:pointer;transition:all .3s;
display:flex;flex-direction:row;align-items:center;gap:12px;
}
.ch-item:last-child{border-bottom:none;}
.ch-item:active{transform:scale(.95);}
.ch-item.act{background:rgba(108,92,231,.1);color:var(--accent2);border-bottom-color:var(--border);}
.ch-item .ch-item-num{font-size:14px;font-weight:700;}
.ch-item .ch-item-wc{font-size:9px;opacity:.7;}
/* CREATE PAGE */
.cr-tabs{display:flex;padding:4px 18px;gap:0;}
.cr-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.cr-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.cr-list{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.cr-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.cr-card:active{transform:scale(.98);}
.cr-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.cr-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cr-card-badge{padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;}
.cr-card-badge.draft{background:rgba(255,165,0,.15);color:#f0a030;}
.cr-card-badge.novel{background:rgba(108,92,231,.15);color:var(--accent2);}
.cr-card-pv{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cr-card-ft{display:flex;justify-content:space-between;align-items:center;}
.cr-card-info{font-size:9px;color:var(--text2);}
.cr-card-acts{display:flex;gap:5px;}
.cr-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.cr-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.cr-new-bar{padding:8px 18px;display:flex;gap:8px;}
.cr-new-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.cr-new-bar button:active{transform:scale(.97);}

/* EDITOR MODAL */
/* IMMERSIVE MODE */
.ed-modal.immersive{background:#0a0a0f;}
.ed-modal.immersive .ed-hdr{display:none;}
.ed-modal.immersive .ed-acts{display:none;}
.ed-modal.immersive .ed-ch-bar{display:none;}
.ed-modal.immersive .ed-footer{
position:fixed;bottom:0;left:0;right:0;
background:rgba(10,10,15,.9);backdrop-filter:blur(10px);
border-top:1px solid rgba(108,92,231,.2);
}
.ed-modal.immersive .ed-body{padding:20px 24px 80px;}
.ed-modal.immersive .ed-textarea{
background:transparent;border:none;
font-size:18px;line-height:2.2;
min-height:calc(100vh - 100px);
}
.ed-modal.immersive .ed-textarea:focus{border:none;box-shadow:none;}
.immersive-exit{
position:fixed;top:16px;right:16px;z-index:100;
padding:8px 14px;border-radius:20px;
background:rgba(108,92,231,.2);border:1px solid var(--accent);
color:var(--accent2);font-size:11px;cursor:pointer;
display:none;
}
.ed-modal.immersive .immersive-exit{display:block;}
.ed-modal{
display:none;position:fixed;inset:0;z-index:510;
background:var(--bg);overflow-y:auto;
}
.ed-modal.show{display:block;animation:slideUp .3s ease;}
.ed-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:10px 14px;display:flex;align-items:center;
border-bottom:none;gap:8px;
}
.ed-back{
display:flex;align-items:center;gap:4px;background:none;
border:none;color:var(--accent2);font-size:12px;cursor:pointer;padding:4px;flex-shrink:0;
}
.ed-back svg{width:16px;height:16px;}
.ed-title-input{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;font-weight:700;outline:none;
}
.ed-title-input:focus{border-color:var(--accent);}
.ed-acts{
display:flex;gap:6px;padding:8px 14px;
overflow-x:auto;-webkit-overflow-scrolling:touch;
border-bottom:1px solid var(--border);
background:var(--card);
}
.ed-acts::-webkit-scrollbar{display:none;}
.ed-acts button{
flex-shrink:0;padding:6px 12px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;display:flex;align-items:center;gap:4px;
}
.ed-acts button:active{transform:scale(.95);background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-bar{
padding:8px 14px;display:flex;gap:6px;align-items:center;
border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;
}
.ed-ch-bar::-webkit-scrollbar{display:none;}
.ed-ch-btn{
padding:5px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;transition:all .3s;
}
.ed-ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-add{
padding:5px 10px;border-radius:8px;border:1px dashed var(--border);
background:transparent;color:var(--accent2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;
}
.ed-body{padding:14px;}
.ed-textarea{
width:100%;min-height:calc(100vh - 200px);padding:16px;
border-radius:12px;border:1px solid var(--border);
background:var(--card);color:var(--text);
font-size:var(--rd-fontsize,15px);line-height:var(--rd-lineheight,2);
outline:none;resize:none;font-family:inherit;
}
.ed-textarea:focus{border-color:var(--accent);}
.ed-textarea::placeholder{color:var(--text2);}
.ed-footer{
padding:10px 14px;border-top:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
font-size:10px;color:var(--text2);
}
.ed-wc{font-weight:600;color:var(--accent2);}

/* AI REVIEW PANEL */
.ai-review-ov{
display:none;position:fixed;inset:0;z-index:570;
background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:20px;
}
.ai-review-ov.show{display:flex;}
.ai-review-box{
background:var(--card);border-radius:16px;padding:0;
width:100%;max-width:400px;max-height:80vh;
border:1px solid var(--border);overflow:hidden;
display:flex;flex-direction:column;animation:fadeIn .25s ease;
}
.ai-review-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ai-review-hdr h3{font-size:14px;font-weight:700;}
.ai-review-body{
padding:16px;overflow-y:auto;flex:1;
font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.ai-review-ft{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;text-align:right;
}
.ai-review-ft button{
padding:8px 20px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
}
/* RESOURCE PAGE */
.res-bar{padding:10px 18px;display:flex;gap:8px;}
.res-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.res-bar button:active{transform:scale(.97);}
.res-tabs{display:flex;padding:4px 18px;gap:0;}
.res-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.res-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.res-list{padding:8px 18px;display:flex;flex-direction:column;gap:10px;}
.res-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;
}
.res-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.res-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;}
.res-card-type{
padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;
}
.res-card-type.char{background:rgba(108,92,231,.15);color:var(--accent2);}
.res-card-type.world{background:rgba(39,174,96,.15);color:var(--success);}
.res-card-type.style{background:rgba(230,126,34,.15);color:#e67e22;}
.res-card-type.work{background:rgba(52,152,219,.15);color:#3498db;}
.res-card-type.exp{background:rgba(241,196,15,.15);color:#f1c40f;} .res-card-type.rule{background:rgba(155,89,182,.15);color:#9b59b6;}
.ch-outline-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.ch-outline-item-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.ch-outline-item-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.ch-outline-item textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;min-height:60px;resize:vertical;font-family:inherit;line-height:1.6;}
.ch-outline-item textarea:focus{border-color:var(--accent);outline:none;}
.ch-outline-item textarea::placeholder{color:var(--text2);}
.res-card-pv{
font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.res-card-ft{display:flex;justify-content:space-between;align-items:center;}
.res-card-info{font-size:9px;color:var(--text2);}
.res-card-acts{display:flex;gap:5px;}
.res-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.res-card-acts button.use{color:var(--accent2);border-color:var(--accent);}
.res-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}

/* RESOURCE EXPORT DIALOG */
.res-exp-ov{
display:none;position:fixed;inset:0;z-index:810;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:20px;
}
.res-exp-ov.show{display:flex;}
.res-exp-box{
background:var(--card);border-radius:16px;padding:20px;
width:100%;max-width:360px;border:1px solid var(--border);
animation:fadeIn .25s ease;max-height:85vh;overflow-y:auto;
}
.res-exp-box h3{font-size:15px;margin-bottom:14px;}
.res-chk-item{
display:flex;align-items:center;gap:10px;padding:10px 12px;
background:var(--bg);border-radius:9px;border:1px solid var(--border);
margin-bottom:8px;cursor:pointer;transition:all .3s;
}
.res-chk-item.checked{border-color:var(--accent);background:rgba(108,92,231,.06);}
.res-chk-box{
width:18px;height:18px;border-radius:5px;border:2px solid var(--border);
display:flex;align-items:center;justify-content:center;flex-shrink:0;
font-size:11px;color:#fff;transition:all .3s;
}
.res-chk-item.checked .res-chk-box{background:var(--accent);border-color:var(--accent);}
.res-chk-info{flex:1;}
.res-chk-name{font-size:12px;font-weight:600;}
.res-chk-desc{font-size:9px;color:var(--text2);margin-top:2px;}
.res-exp-input{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin:10px 0;
}
.res-exp-input:focus{border-color:var(--accent);}
.res-exp-btns{display:flex;gap:9px;margin-top:14px;}
.res-exp-btns button{
flex:1;padding:10px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
/* NOTE PANEL */
.note-ov{
display:none;position:fixed;inset:0;z-index:560;
background:rgba(0,0,0,.45);
}
.note-ov.show{display:block;}
.note-panel{
position:fixed;top:0;right:-320px;bottom:0;z-index:561;
width:300px;max-width:85vw;background:var(--card);
border-left:1px solid var(--border);
display:flex;flex-direction:column;
transition:right .3s ease;
box-shadow:-4px 0 20px rgba(0,0,0,.3);
}
.note-ov.show .note-panel{right:0;}
.note-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.note-hdr h3{font-size:14px;font-weight:700;}
.note-hdr span{font-size:10px;color:var(--text2);}
.note-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;
}
.note-list{
flex:1;overflow-y:auto;padding:12px 16px;
display:flex;flex-direction:column;gap:10px;
}
.note-empty{
text-align:center;padding:40px 10px;color:var(--text2);font-size:12px;
}
.note-item{
background:var(--bg);border-radius:10px;padding:11px 13px;
border:1px solid var(--border);position:relative;
}
.note-item-text{font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap;word-wrap:break-word;}
.note-item-ft{
display:flex;justify-content:space-between;align-items:center;
margin-top:7px;
}
.note-item-time{font-size:9px;color:var(--text2);}
.note-item-del{
background:none;border:none;color:var(--danger);font-size:9px;
cursor:pointer;padding:2px 6px;border-radius:5px;
border:1px solid rgba(255,107,107,.3);
}
.note-input-wrap{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;
}
.note-input-row{display:flex;gap:8px;}
.note-input-row textarea{
flex:1;padding:9px 12px;border-radius:10px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
resize:none;min-height:38px;max-height:100px;
font-family:inherit;line-height:1.5;
}
.note-input-row textarea:focus{border-color:var(--accent);}
.note-input-row textarea::placeholder{color:var(--text2);}
.note-send{
padding:8px 14px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
align-self:flex-end;white-space:nowrap;
}
.note-send:active{transform:scale(.95);}
.note-dot{
display:inline-block;width:6px;height:6px;border-radius:50%;
background:var(--accent2);margin-left:4px;vertical-align:middle;
}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.rd-para{transition:background .3s;border-radius:4px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:pan-y;}
/* TTS 语音朗读 */
.tts-bar{
position:fixed;bottom:60px;left:0;right:0;z-index:30;
background:rgba(26,26,36,.95);backdrop-filter:blur(12px);
padding:12px 18px;display:none;
border-top:1px solid var(--border);
flex-direction:column;gap:10px;
}
.tts-bar.show{display:flex;}
.tts-bar-row{display:flex;align-items:center;gap:10px;}
.tts-bar-btns{display:flex;gap:6px;}
.tts-bar-btns button{
padding:8px 14px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:11px;cursor:pointer;
transition:all .3s;display:flex;align-items:center;gap:4px;
}
.tts-bar-btns button:active{transform:scale(.95);}
.tts-bar-btns button.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.tts-bar-progress{
flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;
}
.tts-bar-progress-inner{
height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));
transition:width .3s;
}
.tts-bar-info{font-size:10px;color:var(--text2);white-space:nowrap;}
.tts-settings{
background:var(--card);border-radius:10px;padding:10px 12px;
border:1px solid var(--border);display:none;
}
.tts-settings.show{display:block;}
.tts-s-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.tts-s-row:last-child{margin-bottom:0;}
.tts-s-label{font-size:10px;color:var(--text2);width:45px;flex-shrink:0;}
.tts-s-row select{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:11px;outline:none;
}
.tts-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.tts-s-val{font-size:10px;color:var(--accent2);width:30px;text-align:right;}
.tts-highlight{background:rgba(108,92,231,.25);border-radius:3px;}
</style>
</head>
<body>
<div class="splash" id="splash">
<div class="splash-particles" id="splashParticles"></div>
<div class="splash-glow" style="top:20%;left:30%"></div>
<div class="splash-glow" style="bottom:10%;right:20%;animation-delay:-2s"></div>
<div class="splash-decor splash-decor-1"></div>
<div class="splash-decor splash-decor-2"></div>
<div class="splash-corner tl">Created by 心田</div>
<div class="splash-corner br">AI创作工坊</div>
<div class="splash-card">
<div class="splash-icon"><img src="https://i.postimg.cc/SQ1t32R0/retouch-2026022401082081.png" alt="Logo"></div>
<div class="splash-logo">笔记AI</div>
<div class="splash-sub">让灵感落笔成章</div>
<div class="splash-progress"><div class="splash-progress-bar" id="splashBar"></div></div>
<div class="splash-status">
<span class="splash-dot"></span>
<span id="splashTxt">正在初始化...</span>
</div>
</div>
<div class="splash-ver" id="splashVer">v2.5.0</div>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="hdr">
<div class="hdr-left">
<h1><img src="https://i.postimg.cc/SQ1t32R0/retouch-2026022401082081.png" alt="" class="hdr-logo-img">笔记AI</h1>
<div class="hdr-sub">AI创作工坊 · 让灵感落笔成章</div>
</div>
<div class="hdr-right">
<button class="hdr-btn" onclick="openInspiration()" title="灵感">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
灵感
</button>
<button class="hdr-btn" onclick="openHandbook()" title="手册">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
手册
</button>
</div>
</div>

<!-- WORKSHOP -->
<div class="pg act" id="pg-workshop">
<div class="sbar">
<input type="text" id="searchInput" placeholder="描述你想要的故事内容..." onkeydown="if(event.key==='Enter'){event.preventDefault();generateArticle();}">
<button class="btn-gen" id="btnGen" onclick="handleGenBtn()">生成</button>
</div>
<div class="tags-sec">
<div class="tags-wrap" id="tagsWrap"></div>
</div>
<div class="ttabs">
<button class="ttab act" onclick="switchType('long',this)">长篇连载</button>
<button class="ttab" onclick="switchType('short',this)">短篇一发</button>
</div>
<div style="padding:2px 18px 6px;display:flex;align-items:center;gap:8px">
<span style="font-size:10px;color:var(--text2);flex-shrink:0">创意度</span>
<input type="range" min="0.3" max="1.5" step="0.1" value="0.8" id="quickTemp" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('qtVal').textContent=this.value;document.getElementById('apiTemp').value=this.value">
<span style="font-size:10px;color:var(--accent2);width:24px;text-align:right" id="qtVal">0.8</span>
<span style="font-size:9px;color:var(--text2)">稳定←→狂野</span>
</div>
<div class="alist" id="articleList">
<div class="empty-st">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
<p>输入描述或选择标签<br>点击「生成」开始创作吧 ✨</p>
</div>
</div>
</div>

<!-- COLLECTION -->
<div class="pg" id="pg-collection">
<div class="col-hdr">
<h2>📚 我的收藏</h2>
<span class="col-cnt" id="colCnt">0 篇</span>
</div>
<div class="col-search">
<input type="text" id="colSearchInput" placeholder="🔍 搜索书名或文章名..." oninput="renderCollections()">
</div>
<div class="sec-div"><h3>长篇书架</h3></div>
<div class="bgrid" id="bookGrid"></div>
<div class="col-shorts">
<h3>短篇收藏</h3>
<div class="slist" id="shortList"></div>
</div>
</div>
<!-- CREATE -->
<div class="pg" id="pg-create">
<div class="cr-new-bar">
<button onclick="newDraft()">📄 新建草稿</button>
<button onclick="newNovel()">📖 新建小说</button>
<button onclick="openOutlineGen()" style="border-color:var(--accent);color:var(--accent2)">🧠 AI大纲</button>
<button onclick="openNameGen()" style="border-color:var(--accent);color:var(--accent2)">✨ AI起名</button>
</div>
<div class="cr-new-bar" style="padding-top:0">
<button onclick="exportCrToTxt()">📥 导出TXT</button>
</div>
<div class="cr-tabs">
<button class="cr-tab act" onclick="switchCrTab('draft',this)">草稿箱</button>
<button class="cr-tab" onclick="switchCrTab('novel',this)">我的小说</button>
</div>
<div class="cr-list" id="crList"></div>
</div>
<!-- SETTINGS -->
<div class="pg" id="pg-settings">
<div class="ucard" id="ucard">
<div class="ucard-top">
<div class="ucard-avatar" id="ucAvatar" onclick="uploadAvatar()">
<span id="ucAvatarPh">✦</span>
<div class="ucard-avatar-hint">更换</div>
</div>
<div class="ucard-info">
<div class="ucard-name">
<span id="ucName">点击设置昵称</span>
<button onclick="editUcName()" title="编辑昵称">✏️</button>
</div>
<div class="ucard-bio" id="ucBio" onclick="editUcBio()">点击添加个人简介...</div>
</div>
</div>
<div class="ucard-stats">
<div class="ucard-stat">
<div class="ucard-stat-num" id="statTotal">0</div>
<div class="ucard-stat-label">总字数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statWorks">0</div>
<div class="ucard-stat-label">作品数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statCols">0</div>
<div class="ucard-stat-label">收藏数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statNotes">0</div>
<div class="ucard-stat-label">笔记数</div>
</div>
</div>
</div>
<input type="file" id="avatarUp" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
<div style="padding:14px 18px 8px"><h2 style="font-size:16px;font-weight:700">⚙️ 设置中心</h2></div>
<div style="padding:0 18px 18px">
<div class="set-entry" onclick="openSetModal('api')">
<div class="set-entry-left"><span class="set-entry-icon">🔑</span><div class="set-entry-info"><h3>API设置</h3><p>配置接口地址、密钥、模型</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('char')">
<div class="set-entry-left"><span class="set-entry-icon">👤</span><div class="set-entry-info"><h3>人物设定</h3><p>创建和管理角色</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('world')">
<div class="set-entry-left"><span class="set-entry-icon">🌍</span><div class="set-entry-info"><h3>世界观设定</h3><p>故事背景与规则</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('style')">
<div class="set-entry-left"><span class="set-entry-icon">✒️</span><div class="set-entry-info"><h3>文风设置</h3><p>写作风格与语言</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('rule')">
<div class="set-entry-left"><span class="set-entry-icon">📜</span><div class="set-entry-info"><h3>规则设置</h3><p>创作限制与要求</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('ban')">
<div class="set-entry-left"><span class="set-entry-icon">🚫</span><div class="set-entry-info"><h3>禁用词设置</h3><p>AI避免使用的词汇</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('theme')">
<div class="set-entry-left"><span class="set-entry-icon">🎨</span><div class="set-entry-info"><h3>页面美化</h3><p>主题、字体、背景</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('data')">
<div class="set-entry-left"><span class="set-entry-icon">📦</span><div class="set-entry-info"><h3>数据管理</h3><p>导入导出、清空数据</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
</div>
</div>
<!-- RESOURCE -->
<div class="pg" id="pg-resource">
<div style="padding:14px 18px 4px"><h2>📦 资源广场</h2><p style="font-size:11px;color:var(--text2);margin-top:4px">打包分享你的设定和创作，导入别人的资源包</p></div>
<div class="res-bar">
<button onclick="openResExport()">📤 打包导出</button>
<button onclick="document.getElementById('resImpFile').click()">📥 导入资源包</button>
<button onclick="writeExpShare()">✍️ 写经验</button>
<input type="file" id="resImpFile" accept=".json" style="display:none" onchange="importResPack(event)">
</div>
<div class="res-tabs">
<button class="res-tab act" onclick="switchResTab('all',this)">全部</button>
<button class="res-tab" onclick="switchResTab('char',this)">人物</button>
<button class="res-tab" onclick="switchResTab('world',this)">世界观</button>
<button class="res-tab" onclick="switchResTab('style',this)">文风</button>
<button class="res-tab" onclick="switchResTab('rule',this)">规则</button>
<button class="res-tab" onclick="switchResTab('work',this)">作品</button>
<button class="res-tab" onclick="switchResTab('exp',this)">经验</button>
</div>
<div class="res-list" id="resList"></div>
</div>
</div><!-- end app -->

<!-- READING MODAL -->
<div class="modal" id="rdModal">
<div class="rd-bg" id="rdBg"></div>
<div class="rd-hdr">
<button class="rd-back" onclick="closeReading()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
返回
</button>
<div class="rd-acts">
<button onclick="toggleRdSettings()" title="阅读设置">⚙</button>
<button onclick="toggleFullscreen()" id="btnFS">⛶</button>
<button onclick="copyCurrentArticle()">📋</button>
<button onclick="openNotePanel()" id="rdNoteBtn">📝</button>
<button onclick="toggleCurrentLike()" id="rdLikeBtn">♡</button> <button onclick="document.getElementById('rdModal').scrollTo({top:0,behavior:'smooth'})" title="回到顶部">⬆</button>
<button onclick="enterImmersiveRead()" title="沉浸阅读">🌙</button>
<button onclick="toggleTtsBar()" id="rdTtsBtn" title="语音朗读">🔊</button>
</div>
</div>
<div class="rd-body">
  <button class="immersive-exit-float" onclick="exitImmersiveRead()">✕ 退出沉浸</button>
<h1 class="rd-title" id="rdTitle"></h1>
<div class="rd-meta" id="rdMeta"></div>
<div class="rd-settings" id="rdSettingsPanel">
<h4>阅读设置</h4>
<div class="rd-s-row"><span class="rd-s-label">字号</span><input type="range" min="12" max="24" value="15" oninput="setRdFont(this.value)"><span class="rd-s-val" id="rdFontVal">15</span></div>
<div class="rd-s-row"><span class="rd-s-label">行高</span><input type="range" min="1.4" max="3" step="0.1" value="2" oninput="setRdLine(this.value)"><span class="rd-s-val" id="rdLineVal">2</span></div>
</div>
<div class="ch-nav" id="chNav"></div>
<div class="rd-content" id="rdContent"></div>
<div class="cont-wrap" id="contWrap" style="display:none">
<div class="rd-dir-input" id="dirInputWrap">
<input type="text" id="dirInput" placeholder="给下一章的方向提示（可留空）...">
</div>
<!-- TTS 语音朗读控制栏 -->
<div class="tts-bar" id="ttsBar">
<div class="tts-bar-row">
<div class="tts-bar-btns">
<button onclick="ttsPlayPause()" id="ttsPlayBtn">▶ 朗读</button>
<button onclick="ttsStop()">⏹ 停止</button>
<button onclick="ttsPrevPara()">⏮</button>
<button onclick="ttsNextPara()">⏭</button>
<button onclick="toggleTtsSettings()" id="ttsSettingsBtn">⚙</button>
</div>
<div class="tts-bar-progress"><div class="tts-bar-progress-inner" id="ttsProgress"></div></div>
<span class="tts-bar-info" id="ttsInfo">0/0段</span>
</div>
<div class="tts-settings" id="ttsSettings">
<div class="tts-s-row">
<span class="tts-s-label">语音</span>
<select id="ttsVoiceSelect" onchange="saveTtsSettings()"></select>
</div>
<div class="tts-s-row">
<span class="tts-s-label">语速</span>
<input type="range" min="0.5" max="2" step="0.1" value="1" id="ttsRate" oninput="updateTtsRate()">
<span class="tts-s-val" id="ttsRateVal">1.0</span>
</div>
<div class="tts-s-row">
<span class="tts-s-label">音调</span>
<input type="range" min="0.5" max="2" step="0.1" value="1" id="ttsPitch" oninput="updateTtsPitch()">
<span class="tts-s-val" id="ttsPitchVal">1.0</span>
</div>
</div>
</div>
<div class="immersive-read-bar" id="immersiveReadBar">
<button onclick="exitImmersiveRead()">✕ 退出</button>
<button onclick="toggleAutoScroll()" id="autoScrollBtn">▶ 自动阅读</button>
<div class="speed-ctrl">
<span>速度</span>
<input type="range" min="1" max="10" value="3" id="scrollSpeed" oninput="updateScrollSpeed()">
<span id="speedVal">3</span>
</div>
<button onclick="immersivePrevCh()">◀ 上一章</button>
<button onclick="immersiveNextCh()">下一章 ▶</button>
</div>
<button class="btn-cont" id="btnCont" onclick="continueChapter()">📝 继续连载下一章</button>
<button class="btn-undo" id="btnUndo" style="display:none" onclick="undoChapter()">↩ 撤销上一章</button>
</div>
</div>
</div>

<!-- HANDBOOK -->
<div class="hb-ov" id="hbOv">
<div class="hb-hdr">
<button onclick="closeHandbook()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button>
<h2>📖 使用手册</h2>
</div>
<div class="hb-body">

<h3>一、欢迎使用笔记AI</h3>
<p>笔记AI是一款基于大语言模型的AI创作工坊，帮助你快速生成高质量的小说、散文等文学作品。无论你是新手写作者还是资深创作人，这里都能成为你的灵感引擎和创作伙伴。</p>

<div class="notice">
<p>🎉 <strong>v2.5.0 更新亮点</strong></p>
<p>· 新增语音朗读功能，解放双眼听小说<br>· 支持选择语音、调节语速和音调<br>· 朗读时自动高亮当前段落<br>· 优化沉浸式阅读体验<br>· 修复若干已知问题</p>
</div>

<h3>二、快速开始（5分钟上手）</h3>
<p>按照以下步骤，你可以在5分钟内开始你的第一次AI创作：</p>

<p><strong>第1步：配置API（必须）</strong></p>
<ul>
<li>点击底部「设置」→「API设置」</li>
<li>填写API地址（如 https://api.openai.com/v1 或其他兼容接口）</li>
<li>填写API密钥（以 sk- 开头的密钥）</li>
<li>模型名称建议填 gpt-4o-mini 或 gpt-4o</li>
<li>点击「测试连接」确认配置正确</li>
</ul>

<p><strong>第2步：开始创作</strong></p>
<ul>
<li>回到「作坊」页面</li>
<li>在输入框描述你想要的故事，比如"校园甜文，学霸女主和体育生男主"</li>
<li>选择「长篇连载」或「短篇一发」</li>
<li>点击「生成」按钮，等待AI创作</li>
</ul>

<p><strong>第3步：收藏与续写</strong></p>
<ul>
<li>生成完成后，点击「♡ 收藏」将作品加入书架</li>
<li>长篇作品收藏后，可以点击「继续连载下一章」让AI续写</li>
</ul>

<h3>三、五大核心页面详解</h3>

<p><strong>📝 作坊（首页）</strong></p>
<p>这是AI创作的主战场，所有新作品都从这里诞生。</p>
<ul>
<li><strong>输入框</strong>：描述你想要的故事方向，写得越具体效果越好</li>
<li><strong>标签</strong>：点击选择氛围标签，可以多选，也可以自建标签</li>
<li><strong>长篇/短篇切换</strong>：长篇可以持续续写，短篇一次生成完整故事</li>
<li><strong>创意度滑块</strong>：左边（0.5）更稳定可控，右边（1.2）更天马行空</li>
<li><strong>灵感按钮</strong>：点击右上角「灵感」可以随机获取创意方向</li>
</ul>

<p><strong>📚 收藏（书架）</strong></p>
<p>管理你喜欢的作品，长篇和短篇分开展示。</p>
<ul>
<li><strong>长篇书架</strong>：可以上传封面、设置状态（连载中/已完结/暂停）、打星评分</li>
<li><strong>短篇收藏</strong>：快速浏览和管理短篇作品</li>
<li><strong>搜索</strong>：输入关键词快速找到作品</li>
<li><strong>操作按钮</strong>：复制全文、导出TXT、删除等</li>
</ul>

<p><strong>✏️ 创作（个人写作）</strong></p>
<p>这是你的私人写作空间，用于手动创作或编辑AI生成的内容。</p>
<ul>
<li><strong>草稿</strong>：单篇文档，适合随手记录灵感、写短文</li>
<li><strong>小说</strong>：多章节结构，适合长篇连载创作</li>
<li><strong>AI大纲</strong>：让AI帮你生成故事大纲框架</li>
<li><strong>AI起名</strong>：为角色、书名、地名生成创意名字</li>
</ul>

<p><strong>⚙️ 设置（配置中心）</strong></p>
<p>所有个性化配置都在这里，包括API、人物、世界观、文风等。</p>

<p><strong>📦 资源（分享广场）</strong></p>
<p>打包分享你的设定，或导入别人的资源包。</p>

<h3>四、如何写出高质量的作品</h3>

<p><strong>技巧1：描述要具体</strong></p>
<ul>
<li>❌ 差的描述："写个恋爱故事"</li>
<li>✅ 好的描述："民国背景，大家族千金和穷书生的虐恋，女主外柔内刚，男主清冷傲骨"</li>
</ul>

<p><strong>技巧2：善用人物设定</strong></p>
<ul>
<li>进入「设置」→「人物设定」</li>
<li>为每个角色填写名字、性格标签、详细背景</li>
<li>性格标签会影响角色的言行举止</li>
<li>详细设定可以写外貌、说话方式、口头禅、过往经历等</li>
</ul>

<p><strong>技巧3：建立世界观</strong></p>
<ul>
<li>进入「设置」→「世界观设定」</li>
<li>描述故事发生的时代、地点、社会规则</li>
<li>如果是奇幻/科幻，写清楚魔法体系或科技水平</li>
<li>设置每章最少字数（建议800-1500字）</li>
</ul>

<p><strong>技巧4：选择合适的文风</strong></p>
<ul>
<li>进入「设置」→「文风设置」</li>
<li>可以选择7种快捷模板：轻松日常、沉郁文学、甜宠言情、悬疑紧张、古风典雅、幽默讽刺、硬核写实</li>
<li>也可以自己描述想要的文风，比如"村上春树式的冷淡叙述"</li>
</ul>

<p><strong>技巧5：调节创意度</strong></p>
<ul>
<li><strong>0.5-0.7</strong>：稳定可控，适合逻辑严密的悬疑推理、需要前后一致的续写</li>
<li><strong>0.8-0.9</strong>：平衡模式，适合大多数创作场景</li>
<li><strong>1.0-1.2</strong>：创意发散，适合奇幻脑洞、需要惊喜的场景</li>
</ul>

<h3>五、长篇连载完全指南</h3>

<p><strong>开始一部长篇</strong></p>
<ol>
<li>在作坊选择「长篇连载」</li>
<li>输入故事方向，点击生成</li>
<li>生成第一章后，点击「♡ 收藏」加入书架</li>
<li>只有收藏后才能续写</li>
</ol>

<p><strong>续写下一章</strong></p>
<ol>
<li>打开已收藏的长篇作品</li>
<li>滚动到底部，看到「继续连载下一章」按钮</li>
<li>在「方向提示」框中输入本章想要的发展（可留空）</li>
<li>点击按钮，等待AI创作</li>
</ol>

<p><strong>方向提示的写法</strong></p>
<ul>
<li>"本章要有一场误会"</li>
<li>"加入一个新角色，是女主的青梅竹马"</li>
<li>"本章结尾要有反转"</li>
<li>"让男女主有一段独处的甜蜜时光"</li>
<li>"揭露一个关于男主身世的秘密"</li>
</ul>

<p><strong>章节管理</strong></p>
<ul>
<li>点击「📑 目录」可以查看所有章节列表</li>
<li>点击任意章节可以跳转阅读</li>
<li>「撤销上一章」可以删除最后一章重新生成</li>
</ul>

<h3>六、大纲驱动创作（进阶玩法）</h3>

<p>如果你已经有完整的故事构思，想让AI严格按照你的大纲创作，请使用这个方法：</p>

<p><strong>方法一：使用AI大纲功能</strong></p>
<ol>
<li>进入「创作」页面，点击「🧠 AI大纲」</li>
<li>描述你的故事方向</li>
<li>选择章节数量（5-30章）</li>
<li>点击「生成大纲」</li>
<li>检查大纲，满意后点击「确认并创建小说」</li>
<li>大纲会自动保存，AI续写时会参考</li>
</ol>

<p><strong>方法二：手动编辑章节大纲</strong></p>
<ol>
<li>打开小说编辑器</li>
<li>点击顶部的「📝 章节大纲」按钮</li>
<li>为每一章填写详细大纲</li>
<li>大纲写得越详细，AI越能按你的意图创作</li>
</ol>

<p><strong>章节大纲怎么写</strong></p>
<ul>
<li><strong>必须出现的事件</strong>：如"女主发现男主的秘密日记"</li>
<li><strong>情绪走向</strong>：如"开头平静→中段震惊→结尾心碎"</li>
<li><strong>要埋的伏笔</strong>：如"让读者注意到女主手腕的胎记"</li>
<li><strong>禁止出现的内容</strong>：如"本章不要揭露真凶身份"</li>
<li><strong>对话要点</strong>：如"男主要说出那句'我从未后悔遇见你'"</li>
</ul>

<div class="notice">
<p>💡 <strong>大纲越详细，AI发挥空间越小，结果越可控。</strong>如果你希望AI有一定自由度，可以只写关键事件，细节留给AI发挥。</p>
</div>

<h3>七、编辑器功能详解</h3>

<p>在「创作」页面打开任意作品，进入编辑器，这里有丰富的功能：</p>

<p><strong>基础功能</strong></p>
<ul>
<li><strong>自动保存</strong>：编辑后2秒自动保存，无需手动</li>
<li><strong>字数统计</strong>：底部实时显示当前字数</li>
<li><strong>排版</strong>：一键整理段落格式</li>
<li><strong>复制/导出</strong>：复制全文或导出为TXT文件</li>
</ul>

<p><strong>AI辅助功能</strong></p>
<ul>
<li><strong>🤖 AI评价</strong>：让AI对当前章节进行专业点评，给出亮点和改进建议</li>
<li><strong>🔄 AI重写</strong>：让AI重新改写当前章节，保留情节但优化文笔</li>
<li><strong>📈 AI扩写</strong>：选择一段文字，让AI添加更多细节描写</li>
<li><strong>📉 AI缩写</strong>：选择一段文字，让AI精简内容</li>
</ul>

<p><strong>章节管理（小说模式）</strong></p>
<ul>
<li>顶部显示当前章节，点击可打开目录</li>
<li>「上一章/下一章」快速切换</li>
<li>「+ 添加新章节」在末尾新增章节</li>
<li>「删除本章」删除当前章节（至少保留一章）</li>
</ul>

<p><strong>沉浸模式</strong></p>
<ul>
<li>点击「🌙 沉浸」进入沉浸写作模式</li>
<li>隐藏所有干扰元素，只剩下纯净的写作界面</li>
<li>适合需要专注的长时间写作</li>
</ul>

<h3>八、阅读体验优化</h3>

<p><strong>基础阅读设置</strong></p>
<ul>
<li>点击阅读界面的「⚙」按钮打开设置</li>
<li>调节字号（12-24）和行高（1.4-3.0）</li>
<li>设置会自动保存，下次打开仍然生效</li>
</ul>

<p><strong>全屏模式</strong></p>
<ul>
<li>点击「⛶」进入全屏，隐藏底部导航栏</li>
<li>再次点击退出全屏</li>
</ul>

<p><strong>沉浸阅读模式</strong></p>
<ul>
<li>点击「🌙」进入沉浸阅读</li>
<li>极简界面，只有正文内容</li>
<li>支持自动滚动阅读，可调节速度</li>
<li>支持上一章/下一章快速切换</li>
</ul>

<p><strong>语音朗读</strong></p>
<ul>
<li>点击「🔊」开启语音朗读功能</li>
<li>支持播放/暂停、上一段/下一段</li>
<li>可选择不同语音（优先显示中文语音）</li>
<li>可调节语速（0.5x-2x）和音调</li>
<li>朗读时自动高亮当前段落并滚动跟随</li>
</ul>

<p><strong>阅读背景</strong></p>
<ul>
<li>进入「设置」→「页面美化」</li>
<li>点击「上传图片」设置阅读背景</li>
<li>建议使用浅色、低对比度的图片</li>
</ul>

<p><strong>章节笔记</strong></p>
<ul>
<li>点击「📝」打开笔记面板</li>
<li>可以为每章记录想法、灵感、修改计划</li>
<li>长按任意段落可以快速引用到笔记中</li>
</ul>

<h3>九、设置项详解</h3>

<p><strong>🔑 API设置</strong></p>
<ul>
<li><strong>API地址</strong>：填写接口地址，官方是 https://api.openai.com/v1</li>
<li><strong>API密钥</strong>：你的密钥，以 sk- 开头</li>
<li><strong>模型名称</strong>：推荐 gpt-4o-mini（便宜）或 gpt-4o（更强）</li>
<li><strong>Temperature</strong>：创意度，0.5稳定，1.2狂野</li>
<li><strong>Max Tokens</strong>：最大生成长度，建议4096</li>
<li><strong>流式输出</strong>：开启后可以看到AI逐字创作过程</li>
<li><strong>拉取模型</strong>：自动获取可用模型列表</li>
<li><strong>测试连接</strong>：检查API是否配置正确</li>
</ul>

<p><strong>👤 人物设定</strong></p>
<ul>
<li>可以添加任意数量的角色</li>
<li>每个角色可设置：名称、性格标签、详细描述</li>
<li>性格标签支持自定义添加</li>
<li>可以保存为预设，方便切换不同作品的人物</li>
</ul>

<p><strong>🌍 世界观设定</strong></p>
<ul>
<li>描述故事发生的背景、时代、规则</li>
<li>设置每章最少字数</li>
<li>可以保存多个世界观预设</li>
</ul>

<p><strong>✒️ 文风设置</strong></p>
<ul>
<li>7种快捷模板一键应用</li>
<li>也可以自定义描述文风</li>
<li>可以保存为预设</li>
</ul>

<p><strong>📜 规则设置</strong></p>
<ul>
<li>设置AI必须遵守的创作规则</li>
<li>比如"禁止出现现代词汇"、"对话必须用「」"</li>
</ul>

<p><strong>🚫 禁用词设置</strong></p>
<ul>
<li>每行一个词，AI会避免使用这些词</li>
<li>比如"不禁"、"缓缓"、"淡淡"等</li>
</ul>

<p><strong>🎨 页面美化</strong></p>
<ul>
<li>5种主题风格：默认紫、暖橙、翠绿、深蓝、日间浅色</li>
<li>自定义字体（填写字体文件URL）</li>
<li>阅读背景图片</li>
</ul>

<p><strong>📦 数据管理</strong></p>
<ul>
<li>导出全部数据（建议每周备份一次）</li>
<li>导入数据（恢复备份）</li>
<li>清空作坊（删除所有生成的文章）</li>
<li>显示存储空间使用情况</li>
</ul>

<h3>十、资源广场使用</h3>

<p><strong>打包导出</strong></p>
<ol>
<li>点击「📤 打包导出」</li>
<li>勾选想要分享的内容（人物、世界观、文风、作品等）</li>
<li>给资源包起名字，写简介</li>
<li>点击导出，生成 .json 文件</li>
<li>把文件发给朋友或分享到社群</li>
</ol>

<p><strong>导入资源包</strong></p>
<ol>
<li>点击「📥 导入资源包」</li>
<li>选择收到的 .json 文件</li>
<li>导入后可以在资源列表中看到</li>
<li>点击「应用」可以将设定加载到你的配置中</li>
</ol>

<p><strong>写经验分享</strong></p>
<ul>
<li>点击「✍️ 写经验」</li>
<li>分享你的创作心得、写作技巧、踩坑经验</li>
<li>保存后可以导出分享给别人</li>
</ul>

<h3>十一、常见问题解答</h3>

<p><strong>Q：生成失败怎么办？</strong></p>
<ul>
<li>检查API设置是否正确，点击「测试连接」</li>
<li>确认API密钥有余额</li>
<li>尝试更换模型（如从gpt-4o换成gpt-4o-mini）</li>
<li>检查网络连接</li>
</ul>

<p><strong>Q：生成的内容质量不好怎么办？</strong></p>
<ul>
<li>描述写得更具体详细</li>
<li>完善人物设定和世界观</li>
<li>选择合适的文风模板</li>
<li>在禁用词里添加不想看到的词</li>
<li>调低创意度（Temperature）让输出更稳定</li>
</ul>

<p><strong>Q：续写和前文不连贯怎么办？</strong></p>
<ul>
<li>在方向提示里写清楚要承接什么</li>
<li>调低创意度到0.6-0.7</li>
<li>使用章节大纲功能，明确每章内容</li>
</ul>

<p><strong>Q：数据会丢失吗？</strong></p>
<ul>
<li>数据保存在浏览器本地，清除浏览器数据会丢失</li>
<li>建议每周通过「数据管理」导出备份</li>
<li>换设备需要导入备份文件</li>
</ul>

<p><strong>Q：可以在手机上使用吗？</strong></p>
<ul>
<li>完全支持手机浏览器使用</li>
<li>建议添加到主屏幕，体验更好</li>
</ul>

<h3>十二、进阶技巧汇总</h3>

<ul>
<li><strong>先大纲后创作</strong>：写长篇前先用AI大纲功能规划全局，再逐章填充</li>
<li><strong>分段扩写</strong>：先让AI写出骨架，再用扩写功能丰富细节</li>
<li><strong>人工润色</strong>：AI生成后在编辑器里手动修改，效果最好</li>
<li><strong>多次重写</strong>：对不满意的章节使用AI重写，可能会有惊喜</li>
<li><strong>善用笔记</strong>：阅读时随手记录灵感，方便后续修改</li>
<li><strong>定期备份</strong>：每周导出一次数据，防止意外丢失</li>
<li><strong>尝试不同文风</strong>：同一个故事用不同文风生成，对比效果</li>
<li><strong>控制章节长度</strong>：在世界观设置里调整最少字数</li>
</ul>

<h3>十三、创作伦理提醒</h3>

<div class="notice">
<p>⚠️ <strong>诚信创作倡议</strong></p>
<p>笔记AI鼓励创作者诚信使用AI辅助创作：</p>
<p>· 请勿将AI生成的内容伪装为完全原创作品</p>
<p>· 在发布时请如实标注"本文由AI辅助创作"</p>
<p>· 尊重读者知情权</p>
<p>· AI是工具，创意和灵魂来自你自己</p>
<p>让我们共同维护良好的创作环境。</p>
</div>

<h3>十四、联系作者</h3>
<p>如遇问题或有建议反馈，欢迎联系：</p>
<div class="contact">
<p>📕 小红书：95567118758</p>
<p>📕 小红书：27418565861</p>
<p>💬 微信：Aa9620520</p>
<p>💬 QQ：962005530</p>
</div>

<p style="text-align:center;color:var(--text2);margin-top:28px;font-size:11px">笔记AI v2.5.0 · Created by 心田<br>让每一个灵感都值得被记录 ✨</p>

</div>
</div>

<!-- DIALOGS -->
<div class="dlg-ov" id="dlgOv">
<div class="dlg-box">
<h3 id="dlgTitle">确认</h3>
<p id="dlgMsg"></p>
<div class="dlg-btns">
<button class="dlg-cancel" onclick="closeDlg()">取消</button>
<button class="dlg-ok" id="dlgOkBtn">确认</button>
</div>
</div>
</div>

<div class="inp-ov" id="inpOv">
<div class="inp-box">
<h3 id="inpTitle">输入</h3>
<input id="inpField">
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeInp()">取消</button>
<button class="dlg-ok" id="inpOkBtn">确认</button>
</div>
</div>
</div>
<!-- RESOURCE EXPORT DIALOG -->
<div class="res-exp-ov" id="resExpOv" onclick="if(event.target===this)closeResExport()">
<div class="res-exp-box" id="resExpBox">
<h3>📤 打包资源</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">勾选你想分享的内容，打包成资源文件发给别人</p>
<div id="resExpList"></div>
<input class="res-exp-input" id="resPackName" placeholder="给资源包起个名字（可选）">
<textarea class="res-exp-input" id="resPackDesc" placeholder="资源包简介（可选）" style="min-height:50px;resize:vertical;font-family:inherit"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeResExport()">取消</button>
<button class="dlg-ok" onclick="doResExport()">导出资源包</button>
</div>
</div>
</div>
<!-- EXP SHARE DIALOG -->
<div class="res-exp-ov" id="expOv" onclick="if(event.target===this)closeExpDlg()">
<div class="res-exp-box">
<h3>✍️ 写经验分享</h3>
<input class="res-exp-input" id="expTitle" placeholder="经验标题">
<textarea class="res-exp-input" id="expContent" placeholder="分享你的创作心得、写作技巧、踩坑经验..." style="min-height:120px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeExpDlg()">取消</button>
<button class="dlg-ok" onclick="saveExpShare()">保存</button>
</div>
</div>
</div>
<!-- EDITOR MODAL -->
<div class="ed-modal" id="edModal">
<div class="ed-hdr">
<button class="ed-back" onclick="closeEditor()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回
</button>
<input class="ed-title-input" id="edTitle" placeholder="输入标题...">
</div>
<div class="ed-acts">
<button onclick="toggleImmersiveEdit()" id="immersiveEditBtn">🌙 沉浸</button>
<button onclick="saveEditorContent()">💾 保存</button>
<button onclick="formatEditorText()">¶ 排版</button>
<button onclick="copyEditorContent()">📋 复制</button> <button onclick="exportEdToTxt()">📥 导出TXT</button>
<button onclick="requestAIReview()">🤖 AI评价</button>
<button onclick="viewOutline()" id="edOutlineBtn" style="display:none">📋 总大纲</button>
<button onclick="openChOutline()" id="edChOutlineBtn" style="display:none">📝 章节大纲</button>
<button onclick="aiRewriteChapter()">🔄 AI重写</button>
<button onclick="openAiExpand()">📈 AI扩写</button>
<button onclick="openAiShrink()">📉 AI缩写</button>
<button onclick="deleteEdChapter()" style="color:var(--danger);border-color:rgba(255,107,107,.3)">🗑️ 删除本章</button>
</div>
<div class="ed-ch-bar" id="edChBar" style="display:none"> <button class="ed-ch-btn act" id="edChCurrent" onclick="openEdChList()">第1章</button> <button class="ed-ch-btn" onclick="goEdPrevCh()" id="edPrevBtn" style="display:none">◀ 上一章</button> <button class="ed-ch-btn" onclick="goEdNextCh()" id="edNextBtn" style="display:none">下一章 ▶</button> <button class="ed-ch-btn" onclick="openEdChList()">📑 目录</button> </div>
<div class="ed-body">
  <button class="immersive-exit" onclick="toggleImmersiveEdit()">✕ 退出沉浸</button>
<textarea class="ed-textarea" id="edTextarea" placeholder="开始写作..." oninput="onEditorInput()"></textarea>
</div>
<div class="ed-footer">
<span>当前字数：<span class="ed-wc" id="edWc">0</span></span>
<span id="edSaveStatus">未保存</span>
</div>
</div>

<!-- AI REVIEW -->
<div class="ai-review-ov" id="aiReviewOv" onclick="if(event.target===this)closeAIReview()">
<div class="ai-review-box">
<div class="ai-review-hdr">
<h3>🤖 AI写作建议</h3>
<button class="note-close" onclick="closeAIReview()">✕</button>
</div>
<div class="ai-review-body" id="aiReviewBody">
<div class="note-empty">点击下方按钮获取AI评价</div>
</div>
<div class="ai-review-ft">
<button onclick="closeAIReview()">关闭</button>
</div>
</div>
</div>
<div class="note-ov" id="noteOv" onclick="if(event.target===this)closeNotePanel()">
<div class="note-panel">
<div class="note-hdr">
<div><h3>📝 章节笔记</h3><span id="noteChInfo"></span></div>
<button class="note-close" onclick="closeNotePanel()">✕</button>
</div>
<div class="note-list" id="noteList"></div>
<div class="note-input-wrap">
<div class="note-input-row">
<textarea id="noteInput" placeholder="写下你的想法..." rows="1" oninput="this.style.height='38px';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
<button class="note-send" onclick="addNote()">记录</button>
</div>
</div>
</div>
</div>
<div class="ch-ov" id="chOv" onclick="if(event.target===this)closeChapterList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="chPanelTitle">章节目录</h3><span id="chPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeChapterList()">✕</button>
</div>
<div class="ch-panel-list" id="chPanelList"></div>
</div>
</div>
<div class="res-exp-ov" id="outlineOv" onclick="if(event.target===this)closeOutlineGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>🧠 AI大纲生成器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">描述你想写的故事，AI会生成详细大纲，确认后自动创建小说</p>
<input class="res-exp-input" id="outlineTitle" placeholder="小说标题（可选，AI也会帮你起）">
<textarea class="res-exp-input" id="outlineDesc" placeholder="描述故事方向，比如：一个穿越到古代的程序员，利用现代知识在朝堂上步步高升..." style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">预设章节数：</span>
<button class="tag" onclick="setOutlineCh(5,this)">5章</button>
<button class="tag act" onclick="setOutlineCh(10,this)">10章</button>
<button class="tag" onclick="setOutlineCh(15,this)">15章</button>
<button class="tag" onclick="setOutlineCh(20,this)">20章</button>
<button class="tag" onclick="setOutlineCh(30,this)">30章</button>
</div>
<div id="outlineResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;max-height:40vh;overflow-y:auto">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">📋 生成的大纲</div>
<div id="outlineContent" style="font-size:12px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeOutlineGen()">取消</button>
<button class="dlg-ok" id="outlineGenBtn" onclick="doGenOutline()">🧠 生成大纲</button>
</div>
<div id="outlineActions" style="display:none;margin-top:8px">
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="doGenOutline()">🔄 重新生成</button>
<button class="dlg-ok" onclick="applyOutline()">✅ 确认并创建小说</button>
</div>
</div>
</div>
</div>
<!-- NAME GENERATOR -->
<div class="res-exp-ov" id="nameGenOv" onclick="if(event.target===this)closeNameGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>✨ AI起名器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">输入设定信息，AI为你生成5个名字</p>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="tag act" id="nameTypeChar" onclick="setNameType('char')">👤 人名</button>
<button class="tag" id="nameTypeBook" onclick="setNameType('book')">📖 书名</button>
<button class="tag" id="nameTypePlace" onclick="setNameType('place')">🏔️ 地名</button>
</div>
<textarea class="res-exp-input" id="nameGenDesc" placeholder="描述角色特点、性格、身份背景...&#10;或描述故事类型、世界观、氛围...&#10;（可留空，将使用当前设置中的人物/世界观）" style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">风格偏好：</span>
<button class="tag" onclick="setNameStyle('现代',this)">现代</button>
<button class="tag" onclick="setNameStyle('古风',this)">古风</button>
<button class="tag" onclick="setNameStyle('日系',this)">日系</button>
<button class="tag" onclick="setNameStyle('西方',this)">西方</button>
<button class="tag" onclick="setNameStyle('奇幻',this)">奇幻</button>
<button class="tag" onclick="setNameStyle('',this)">不限</button>
</div>
<div id="nameGenResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">🎯 生成结果（点击复制）</div>
<div id="nameGenList" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeNameGen()">关闭</button>
<button class="dlg-ok" id="nameGenBtn" onclick="doGenNames()">✨ 生成名字</button>
</div>
</div>
</div>
<!-- 编辑器章节列表弹窗 -->
<div class="ch-ov" id="edChOv" onclick="if(event.target===this)closeEdChList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="edChPanelTitle">章节管理</h3><span id="edChPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeEdChList()">✕</button>
</div>
<div class="ch-panel-list" id="edChPanelList"></div>
<div style="padding:12px 18px;border-top:1px solid var(--border)">
<button style="width:100%;padding:10px;border-radius:10px;border:1px dashed var(--accent);background:transparent;color:var(--accent2);font-size:12px;cursor:pointer" onclick="addEdChapter()">+ 添加新章节</button>
</div>
</div>
</div>
<!-- 章节大纲编辑弹窗 -->
<div class="res-exp-ov" id="chOutlineOv" onclick="if(event.target===this)closeChOutline()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3>📋 章节大纲管理</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">为每章设置大纲，AI续写时会参考</p>
<div id="chOutlineList" style="flex:1;overflow-y:auto;margin-bottom:12px"></div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeChOutline()">关闭</button>
<button class="dlg-ok" onclick="saveChOutlines()">💾 保存大纲</button>
</div>
</div>
</div>
<!-- AI扩写/缩写弹窗 -->
<div class="res-exp-ov" id="expandOv" onclick="if(event.target===this)closeExpandOv()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3 id="expandTitle">📈 AI扩写</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px" id="expandDesc">选择或粘贴要扩写的段落，AI会添加更多细节描写</p>
<div class="fg">
<label class="fl">原文内容</label>
<textarea class="fta" id="expandInput" placeholder="粘贴或输入要处理的段落..." style="min-height:100px"></textarea>
</div>
<div class="fg">
<label class="fl">扩写/缩写要求（可选）</label>
<input class="fi" id="expandHint" placeholder="例如：增加环境描写、加入心理活动、精简对话...">
</div>
<div id="expandResult" style="display:none;margin-top:10px">
<label class="fl">处理结果</label>
<textarea class="fta" id="expandOutput" style="min-height:120px;background:var(--bg)" readonly></textarea>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn-s" onclick="copyExpandResult()" style="flex:1">📋 复制结果</button>
<button class="btn-p" onclick="applyExpandResult()" style="flex:1">✅ 替换原文</button>
</div>
</div>
<div class="res-exp-btns" id="expandBtns">
<button class="dlg-cancel" onclick="closeExpandOv()">取消</button>
<button class="dlg-ok" id="expandDoBtn" onclick="doExpand()">开始处理</button>
</div>
</div>
</div>
<!-- SETTINGS MODALS -->
<div class="set-modal" id="setModalApi">
<div class="set-modal-hdr"><button onclick="closeSetModal('api')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🔑 API设置</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">API地址</label><input class="fi" id="apiUrl" placeholder="https://api.openai.com/v1"></div>
<div class="fg"><label class="fl">API密钥</label><div style="display:flex;gap:6px"><input class="fi" id="apiKey" type="password" placeholder="sk-..." style="flex:1"><button class="btn-s" onclick="const k=document.getElementById('apiKey');k.type=k.type==='password'?'text':'password'" style="width:auto;padding:6px 10px;margin:0">👁</button></div></div>
<div class="fg"><label class="fl">模型名称</label><div style="display:flex;gap:6px"><input class="fi" id="apiModel" placeholder="gpt-4o-mini" value="gpt-4o-mini" list="modelSuggest" style="flex:1"><datalist id="modelSuggest"></datalist><button class="btn-s" onclick="fetchModels()" style="width:auto;padding:6px 12px;margin:0">拉取</button></div></div>
<div class="frow"><div class="fg"><label class="fl">Temperature</label><input class="fi" id="apiTemp" type="number" step="0.1" min="0" max="2" value="0.8"></div><div class="fg"><label class="fl">Max Tokens</label><input class="fi" id="apiMaxTokens" type="number" value="4096"></div></div>
<div class="fg"><label class="fl">场景预设</label><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"><button class="tag" onclick="setTempPreset(0.5,'严谨')">📐 严谨</button><button class="tag" onclick="setTempPreset(0.7,'平衡')">⚖️ 平衡</button><button class="tag" onclick="setTempPreset(0.9,'创意')">💡 创意</button><button class="tag" onclick="setTempPreset(1.1,'狂野')">🔥 狂野</button></div></div>
<div class="fg" style="display:flex;align-items:center;justify-content:space-between"><label class="fl" style="margin:0">流式输出</label><div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleStreamSwitch(this)"><input type="checkbox" id="streamOn" checked style="display:none"><div style="width:44px;height:24px;border-radius:12px;background:var(--accent);transition:background .3s" id="streamTrack"><div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="streamThumb"></div></div></div></div>
<button class="btn-s" onclick="testApiConnection()" id="btnTestApi">🔗 测试连接</button>
<button class="btn-p" onclick="saveApiPreset()">💾 保存为预设</button>
<div class="plist" id="apiPL"></div>
</div>
</div>

<div class="set-modal" id="setModalChar">
<div class="set-modal-hdr"><button onclick="closeSetModal('char')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>👤 人物设定</h2></div>
<div class="set-modal-body">
<div class="char-cards" id="charCards"></div>
<button class="btn-s" onclick="addCharacter()" style="margin-top:10px">＋ 添加角色</button>
<div class="fg" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--border)">
<label class="fl">自定义性格标签管理</label>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px" id="customTraitList"></div>
<button class="btn-s" onclick="renderCustomTraitList()" style="margin-top:8px">🔄 刷新列表</button>
</div>
<button class="btn-p" onclick="saveCharPreset()">💾 保存人物预设</button>
<div class="plist" id="charPL"></div>
</div>
</div>

<div class="set-modal" id="setModalWorld">
<div class="set-modal-hdr"><button onclick="closeSetModal('world')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🌍 世界观设定</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">世界观 / 背景设定</label><textarea class="fta" id="worldDesc" placeholder="描述故事发生的世界背景..." style="min-height:150px"></textarea></div>
<div class="fg"><label class="fl">每章最少字数</label><div class="wc-set"><input class="fi" id="minWords" type="number" value="800" min="100" step="100"><span style="color:var(--text2);font-size:11px">字</span></div></div>
<button class="btn-p" onclick="saveWorldPreset()">💾 保存世界观预设</button>
<div class="plist" id="worldPL"></div>
</div>
</div>

<div class="set-modal" id="setModalStyle">
<div class="set-modal-hdr"><button onclick="closeSetModal('style')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>✒️ 文风设置</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">当前文风描述</label><textarea class="fta" id="styleDesc" placeholder="例如：轻松幽默的都市风..." style="min-height:100px"></textarea></div>
<div class="fg"><label class="fl">快捷文风模板</label><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"><button class="tag" onclick="applyStyleTemplate('轻松日常')">轻松日常</button><button class="tag" onclick="applyStyleTemplate('沉郁文学')">沉郁文学</button><button class="tag" onclick="applyStyleTemplate('甜宠言情')">甜宠言情</button><button class="tag" onclick="applyStyleTemplate('悬疑紧张')">悬疑紧张</button><button class="tag" onclick="applyStyleTemplate('古风典雅')">古风典雅</button><button class="tag" onclick="applyStyleTemplate('幽默讽刺')">幽默讽刺</button><button class="tag" onclick="applyStyleTemplate('硬核写实')">硬核写实</button></div></div>
<button class="btn-p" onclick="saveStylePreset()">💾 保存文风预设</button>
<div class="plist" id="stylePL"></div>
</div>
</div>

<div class="set-modal" id="setModalRule">
<div class="set-modal-hdr"><button onclick="closeSetModal('rule')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>📜 规则设置</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">当前规则</label><textarea class="fta" id="ruleDesc" placeholder="例如：- 禁止出现现代科技词汇" style="min-height:150px" oninput="curRule=this.value;sv('bj_curRule',curRule)"></textarea></div>
<button class="btn-p" onclick="saveRulePreset()">💾 保存规则预设</button>
<div class="plist" id="rulePL"></div>
</div>
</div>

<div class="set-modal" id="setModalBan">
<div class="set-modal-hdr"><button onclick="closeSetModal('ban')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🚫 禁用词设置</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">禁用词列表（每行一个）</label><textarea class="fta" id="banWordsInput" placeholder="每行一个词" style="min-height:120px" oninput="banWords=this.value;sv('bj_banWords',banWords)"></textarea></div>
<button class="btn-p" onclick="saveBanWordsPreset()">💾 保存禁用词预设</button>
<div class="plist" id="banWordsPL"></div>
</div>
</div>

<div class="set-modal" id="setModalTheme">
<div class="set-modal-hdr"><button onclick="closeSetModal('theme')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🎨 页面美化</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">主题风格</label><div class="theme-opts"><div class="t-opt t0 act" onclick="setTheme('default',this)"></div><div class="t-opt t1" onclick="setTheme('warm',this)"></div><div class="t-opt t2" onclick="setTheme('green',this)"></div><div class="t-opt t3" onclick="setTheme('blue',this)"></div><div class="t-opt t4" onclick="setTheme('light',this)"></div></div></div>
<div class="fg"><label class="fl">自定义字体链接</label><input class="fi" id="customFontUrl" placeholder="https://example.com/font.ttf"></div>
<div class="fg"><label class="fl">阅读背景图片</label><button class="btn-s" onclick="document.getElementById('rdBgUp').click()">📁 上传图片</button><input type="file" id="rdBgUp" accept="image/*" style="display:none" onchange="uploadRdBg(event)"><button class="btn-s" onclick="clearRdBg()" style="margin-top:5px">🗑️ 清除背景</button></div>
</div>
</div>

<div class="set-modal" id="setModalData">
<div class="set-modal-hdr"><button onclick="closeSetModal('data')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>📦 数据管理</h2></div>
<div class="set-modal-body">
<div class="data-btns"><button onclick="exportData()">📤 导出全部数据</button><button onclick="document.getElementById('importFile').click()">📥 导入数据</button><input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)"><button onclick="clearWorkshop()" style="border-color:rgba(255,107,107,.3);color:var(--danger)">🗑️ 清空作坊</button></div>
<div id="storageInfo" style="margin-top:15px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11px;color:var(--text2)">存储空间</span><span style="font-size:11px;color:var(--accent2)" id="storagePercent">计算中...</span></div><div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div id="storageBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px"></div></div><div style="font-size:9px;color:var(--text2);margin-top:4px" id="storageDetail">已用 0MB / 50MB</div></div>
</div>
</div>
<div class="toast" id="toast"></div>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav">
<button class="bnav-i act" onclick="switchPage('workshop',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
作坊
</button>
<button class="bnav-i" onclick="switchPage('collection',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5V5a2 2 0 012-2h14v14H6.5A2.5 2.5 0 004 19.5z"/></svg>
收藏
</button>
<button class="bnav-i" onclick="switchPage('create',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
创作
</button>
<button class="bnav-i" onclick="switchPage('settings',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
设置
</button>
<button class="bnav-i" onclick="switchPage('resource',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
资源
</button>
</nav>

<input type="file" id="coverUp" accept="image/*" style="display:none">
<script>
// ==================== IndexedDB 存储系统 ====================
const DB_NAME = 'BijiAI_DB';
const DB_VERSION = 1;
const STORE_NAME = 'data';
let db = null;
let dbReady = false;
let dbCache = {}; // 内存缓存

// 初始化数据库
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('IndexedDB 打开失败');
            reject(request.error);
        };
        
        request.onsuccess = () => {
            db = request.result;
            dbReady = true;
            console.log('IndexedDB 已连接，容量约50-100MB');
            resolve(db);
        };
        
        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME, { keyPath: 'key' });
            }
        };
    });
}

// 从IndexedDB读取
function dbGet(key) {
    return new Promise((resolve) => {
        if (!db) { resolve(null); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(key);
            request.onsuccess = () => {
                const result = request.result;
                resolve(result ? result.value : null);
            };
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}

// 写入IndexedDB
function dbSet(key, value) {
    return new Promise((resolve) => {
        if (!db) { resolve(false); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put({ key: key, value: value });
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
        } catch (e) {
            resolve(false);
        }
    });
}

// 从IndexedDB加载所有数据到缓存
async function loadAllFromDB() {
    if (!db) return;
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                items.forEach(item => {
                    dbCache[item.key] = item.value;
                });
                console.log('已从IndexedDB加载 ' + items.length + ' 项数据');
                resolve();
            };
            request.onerror = () => resolve();
        } catch (e) {
            resolve();
        }
    });
}

// 获取IndexedDB使用量
async function getDBStorageUsage() {
    if (!db) return { used: 0, usedMB: '0', percent: 0 };
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                let total = 0;
                items.forEach(item => {
                    total += JSON.stringify(item).length * 2;
                });
                const maxSize = 50 * 1024 * 1024; // 50MB
                resolve({
                    used: total,
                    usedMB: (total / 1024 / 1024).toFixed(2),
                    percent: (total / maxSize * 100).toFixed(1)
                });
            };
            request.onerror = () => resolve({ used: 0, usedMB: '0', percent: 0 });
        } catch (e) {
            resolve({ used: 0, usedMB: '0', percent: 0 });
        }
    });
}
// ==================== CONFIG ====================
const APP_VER='v2.5.0';

// ==================== STORAGE ====================
const K={
tags:'bj_tags',apiP:'bj_apiP',charP:'bj_charP',worldP:'bj_worldP',
curApi:'bj_curApi',curChars:'bj_curChars',curWorld:'bj_curWorld',
cols:'bj_cols',ws:'bj_ws',ap:'bj_ap'
};
function ld(k, fb) {
    // 优先从内存缓存读取
    if (dbCache.hasOwnProperty(k)) {
        return dbCache[k];
    }
    // 回退到localStorage（兼容旧数据）
    try {
        const d = localStorage.getItem(k);
        if (d) {
            const parsed = JSON.parse(d);
            dbCache[k] = parsed; // 存入缓存
            return parsed;
        }
        return fb;
    } catch {
        return fb;
    }
}

function sv(k, d) {
    // 存入内存缓存
    dbCache[k] = d;
    
    // 异步存入IndexedDB
    if (dbReady) {
        dbSet(k, d).catch(() => {});
    }
    
    // 同时尝试存localStorage（作为备份，可能会失败）
    try {
        const str = JSON.stringify(d);
        if (str.length < 500000) { // 小于500KB才存localStorage
            localStorage.setItem(k, str);
        }
    } catch (e) {
        // localStorage满了就忽略，IndexedDB会保存
    }
}

// ==================== STATE ====================
let curType='long';
let selTags=[];
let ws=ld(K.ws,[]);// workshop articles
let cols=ld(K.cols,{books:[],shorts:[]});
let tags=ld(K.tags,['#日常','#bg','#穿越','#奇幻','#校园','#甜文','#虐文','#悬疑','#古风','#现代']);
let apiP=ld(K.apiP,[]);
let charP=ld(K.charP,[]);
let worldP=ld(K.worldP,[]);
let styleP=ld('bj_styleP',[]);
let ruleP=ld('bj_ruleP',[]);
let curRule=ld('bj_curRule','');
let banWords=ld('bj_banWords','');
let banWordsP=ld('bj_banWordsP',[]);
let ap=ld(K.ap,{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2,curStyle:''});
let characters=ld(K.curChars,[{name:'',desc:''},{name:'',desc:''}]);
let customTraits=ld('bj_customTraits',[]);
let curRd=null;// current reading article
let curCh=0;// current chapter index
let isGen=false;
let isFS=false;
let abortCtrl=null;// for aborting stream
let crWorks=ld('bj_crWorks',[]);// 创作作品列表
let crTab='draft';// 当前创作页tab
let curEd=null;// 当前编辑的作品
let curEdCh=0;// 当前编辑的章节
let edAutoSaveTimer=null;
let resPacks=ld('bj_resPacks',[]);// 已导入的资源包
let resTab='all';
let useStream=ld('bj_stream',true);
let userCard=ld('bj_userCard',{name:'',bio:'',avatar:''});

// ==================== TOAST ====================
let toastTimer=null;
function showToast(msg,dur=2000){
if(navigator.vibrate)navigator.vibrate(10);
const t=document.getElementById('toast');
t.textContent=msg;t.classList.add('show');
if(toastTimer)clearTimeout(toastTimer);
toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ==================== CONFIRM DIALOG ====================
function showDlg(title,msg,onOk,danger=false){
document.getElementById('dlgTitle').textContent=title;
document.getElementById('dlgMsg').textContent=msg;
const btn=document.getElementById('dlgOkBtn');
btn.className=danger?'dlg-danger':'dlg-ok';
btn.textContent='确认';
btn.onclick=()=>{closeDlg();onOk();};
document.getElementById('dlgOv').classList.add('show');
}
function closeDlg(){document.getElementById('dlgOv').classList.remove('show');}

// ==================== INPUT DIALOG ====================
function showInp(title,ph,onOk){
document.getElementById('inpTitle').textContent=title;
const f=document.getElementById('inpField');
f.placeholder=ph;f.value='';
document.getElementById('inpOkBtn').onclick=()=>{
const v=f.value.trim();if(v){closeInp();onOk(v);}else{showToast('请输入内容');}
};
document.getElementById('inpOv').classList.add('show');
setTimeout(()=>f.focus(),100);
}
function closeInp(){document.getElementById('inpOv').classList.remove('show');}

// ==================== UTILITY ====================
function esc(s){
if(s===null||s===undefined)return '';
if(typeof s!=='string')s=String(s);
const d=document.createElement('div');
d.textContent=s;
return d.innerHTML;
}
function uid(){return Date.now()+'_'+Math.random().toString(36).substr(2,8);}
function countWords(text){return text.replace(/\s/g,'').length;}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
function isLiked(article){
if(article.type==='long')return cols.books.some(b=>b.id===article.id);
return cols.shorts.some(s=>s.id===article.id);
}

// ==================== NAV ====================
function switchPage(pg,el){
document.querySelectorAll('.pg').forEach(p=>p.classList.remove('act'));
document.getElementById('pg-'+pg).classList.add('act');
document.querySelectorAll('.bnav-i').forEach(n=>n.classList.remove('act'));
el.classList.add('act');
if(pg==='collection')renderCollections();
if(pg==='create')renderCrList();
if(pg==='resource')renderResList();
if(pg==='settings'){renderAllPresets();renderCharCards();updateStats();updateStorageDisplay();}
}

// ==================== TAGS ====================
function renderTags(){
const w=document.getElementById('tagsWrap');w.innerHTML='';
tags.forEach((tag,i)=>{
const isAct=selTags.includes(tag);
const el=document.createElement('span');
el.className='tag'+(isAct?' act':'');
el.innerHTML=esc(tag)+'<span class="tdel" onclick="event.stopPropagation();rmTag('+i+')">✕</span>';
el.onclick=()=>{const idx=selTags.indexOf(tag);if(idx>-1)selTags.splice(idx,1);else selTags.push(tag);renderTags();};
w.appendChild(el);
});
const ab=document.createElement('button');
ab.className='tag-add';ab.textContent='+ 新建';
ab.onclick=()=>showInp('新建标签','输入标签名（自动加#）',v=>{
const t=v.startsWith('#')?v:'#'+v;
if(!tags.includes(t)){tags.push(t);sv(K.tags,tags);renderTags();}
});
w.appendChild(ab);
}
function rmTag(i){selTags=selTags.filter(t=>t!==tags[i]);tags.splice(i,1);sv(K.tags,tags);renderTags();}

// ==================== TYPE SWITCH ====================
function switchType(type,el){
curType=type;
document.querySelectorAll('.ttab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');renderArticles();
}

// ==================== ARTICLES RENDER ====================
function renderArticles(){
const list=document.getElementById('articleList');
const filtered=ws.filter(a=>a&&a.type===curType).slice(0,50);// 限制显示50条
if(ws.filter(a=>a&&a.type===curType).length>50){
console.log('文章较多，仅显示最近50篇');
}
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><p>输入描述或选择标签<br>点击「生成」开始创作吧 ✨</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(article=>{
const liked=isLiked(article);
const card=document.createElement('div');
card.className='acard';
card.onclick=e=>{if(!e.target.closest('.btn-like'))openReading(article);};

let text='';
if(article.type==='long'&&article.chapters&&article.chapters.length>0)text=article.chapters[0];
else if(article.content)text=article.content;
const preview=(text||'').substring(0,120).replace(/\n/g,' ');
const wc=getTotalWords(article); const chCount=article.chapters?article.chapters.length:0;
const tagsHtml=(article.tags||[]).map(t=>'<span class="acard-tag">'+esc(t)+'</span>').join('');

card.innerHTML=
'<div class="acard-hd"><div class="acard-t">'+esc(article.title)+'</div>'+
'<span class="acard-badge '+article.type+'">'+(article.type==='long'?'长篇':'短篇')+'</span></div>'+
'<div class="acard-pv">'+esc(preview)+'</div>'+
'<div class="acard-ft">'+
'<span class="acard-wc">'+(chCount>0?chCount+'章 · ':'')+wc+'字 · '+new Date(article.createdAt).toLocaleDateString()+'</span>'+
'<button class="btn-like '+(liked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+article.id+'\')">'+(liked?'❤️ 已收藏':'♡ 收藏')+'</button>'+
'<button class="btn-like" onclick="event.stopPropagation();deleteWsArticle(\''+article.id+'\')" style="color:var(--danger);border-color:rgba(255,107,107,.3)">🗑️</button>'+
'</div>'+
'<div class="acard-tags" style="margin-top:8px">'+tagsHtml+'</div>';
list.appendChild(card);
});
}

// ==================== TOGGLE LIKE (by id) ====================
function toggleLike(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===id);
if(bIdx>-1){cols.books.splice(bIdx,1);showToast('已取消收藏');}
else{
// Deep copy to avoid reference issues
const copy=JSON.parse(JSON.stringify(article));
copy.cover=null;copy.status='ongoing';copy.rating=0;
cols.books.push(copy);
showToast('已收藏到书架 📚');
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===id);
if(sIdx>-1){cols.shorts.splice(sIdx,1);showToast('已取消收藏');}
else{
const copy=JSON.parse(JSON.stringify(article));
copy.rating=0;
cols.shorts.push(copy);
showToast('已收藏 ❤️');
}
}
sv(K.cols,cols);renderArticles();
}

// ==================== SYNC HELPER ====================
// Sync article data across workshop and collections
function syncArticle(article){
if(!article||!article.id){
console.error('syncArticle: 无效的文章数据');
return;
}
// 备份当前数据以防同步失败
const backup=JSON.stringify(ws);
try{
const wIdx=ws.findIndex(a=>a.id===article.id);
if(wIdx>-1){
ws[wIdx]=JSON.parse(JSON.stringify(article));
sv(K.ws,ws);
}
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===article.id);
if(bIdx>-1){
const cover=cols.books[bIdx].cover;
const status=cols.books[bIdx].status;
const rating=cols.books[bIdx].rating;
cols.books[bIdx]=JSON.parse(JSON.stringify(article));
cols.books[bIdx].cover=cover;
cols.books[bIdx].status=status;
cols.books[bIdx].rating=rating;
sv(K.cols,cols);
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===article.id);
if(sIdx>-1){
const rating=cols.shorts[sIdx].rating;
cols.shorts[sIdx]=JSON.parse(JSON.stringify(article));
cols.shorts[sIdx].rating=rating;
sv(K.cols,cols);
}
}
autoSaveAll();
}catch(e){
console.error('同步失败，尝试恢复:',e);
try{ws=JSON.parse(backup);}catch{}
showToast('数据同步异常，请手动保存',3000);
}
}

// ==================== API CONFIG ====================
function getCurApi(){
return{
url:(document.getElementById('apiUrl').value||'').trim(),
key:(document.getElementById('apiKey').value||'').trim(),
model:(document.getElementById('apiModel').value||'').trim()||'gpt-4o-mini',
temp:parseFloat(document.getElementById('apiTemp').value)||0.8,
maxTokens:parseInt(document.getElementById('apiMaxTokens').value)||4096
};
}
// 拉取模型列表
async function fetchModels(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先填写API地址和密钥');return;}
showToast('正在拉取模型列表...');
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/models',{
headers:{'Authorization':'Bearer '+cfg.key}
});
if(!resp.ok)throw new Error('HTTP '+resp.status);
const data=await resp.json();
let models=[];
if(data.data&&Array.isArray(data.data)){
models=data.data.map(m=>m.id).sort();
}else if(Array.isArray(data)){
models=data.map(m=>m.id||m).sort();
}
if(models.length===0){showToast('未获取到模型');return;}
const dl=document.getElementById('modelSuggest');
dl.innerHTML='';
models.forEach(m=>{
const opt=document.createElement('option');
opt.value=m;
dl.appendChild(opt);
});
showToast('已拉取 '+models.length+' 个模型，点击输入框可选择');
}catch(e){showToast('拉取失败: '+e.message,3000);}
}

// 测试API连接
async function testApiConnection(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先填写API地址和密钥');return;}
const btn=document.getElementById('btnTestApi');
btn.disabled=true;btn.textContent='⏳ 测试中...';
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,
messages:[{role:'user',content:'Hi'}],
max_tokens:5
})
});
if(resp.ok){
const data=await resp.json();
if(data.choices&&data.choices.length>0){
showToast('✅ 连接成功！模型 '+cfg.model+' 可用',3000);
}else{showToast('⚠️ 连接成功但返回异常',3000);}
}else{
const errText=await resp.text();
showToast('❌ 连接失败('+resp.status+'): '+errText.substring(0,100),4000);
}
}catch(e){showToast('❌ 连接失败: '+e.message,3000);}
finally{btn.disabled=false;btn.textContent='🔗 测试连接';}
}

function autoSaveAll(){
sv(K.ws,ws);
sv(K.cols,cols);
sv(K.tags,tags);
sv(K.ap,ap);
sv('bj_crWorks',crWorks);
sv('bj_resPacks',resPacks);
sv('bj_stream',useStream);
}
function saveCurSettings(){
sv(K.curApi,getCurApi());
saveCharactersFromUI();
sv(K.curWorld,{
desc:document.getElementById('worldDesc').value,
minWords:parseInt(document.getElementById('minWords').value)||800
});
const styleEl=document.getElementById('styleDesc');
if(styleEl){ap.curStyle=styleEl.value;sv(K.ap,ap);}
useStream=document.getElementById('streamOn').checked;sv('bj_stream',useStream);
}

// ==================== CHARACTER MANAGEMENT ====================
function renderCharCards(){
const wrap=document.getElementById('charCards');
wrap.innerHTML='';
characters.forEach((c,i)=>{
const card=document.createElement('div');
card.className='char-card';
const traits=c.traits||[];
const defaultTraits=['内向','外向','冷静','冲动','善良','腹黑','傲娇','温柔','毒舌','天然呆'];
const allTraits=[...defaultTraits,...customTraits];
const traitBtnsHtml=allTraits.map(t=>
'<span class="tag'+(traits.includes(t)?' act':'')+'" style="font-size:10px;padding:3px 8px" onclick="toggleCharTrait('+i+',\''+t+'\',this)">'+t+'</span>'
).join('');
card.innerHTML=
'<div class="char-card-hdr"><span>角色 '+(i+1)+'</span>'+
(characters.length>1?'<button class="char-card-del" onclick="removeChar('+i+')">删除</button>':'')+'</div>'+
'<div class="fg"><label class="fl">名称</label><input class="fi char-name" data-idx="'+i+'" value="'+esc(c.name||'')+'" placeholder="角色名" oninput="saveCharactersFromUI()"></div>'+
'<div class="fg"><label class="fl">性格标签（点击选择）</label>'+
'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="traitWrap'+i+'">'+
traitBtnsHtml+
'<span class="tag" style="font-size:10px;padding:3px 8px;border-style:dashed;color:var(--accent2)" onclick="addCustomTrait('+i+')">+ 自定义</span>'+
'</div></div>'+
'<div class="fg"><label class="fl">详细设定</label><textarea class="fta char-desc" data-idx="'+i+'" placeholder="外貌、背景、说话方式、口头禅..." oninput="saveCharactersFromUI()">'+esc(c.desc||'')+'</textarea></div>';
wrap.appendChild(card);
});
}

function renderCustomTraitList(){
const wrap=document.getElementById('customTraitList');
if(!wrap)return;
if(customTraits.length===0){
wrap.innerHTML='<span style="font-size:11px;color:var(--text2)">暂无自定义标签</span>';
return;
}
wrap.innerHTML=customTraits.map(t=>
'<span class="tag act" style="font-size:10px;padding:3px 8px">'+esc(t)+' <span style="margin-left:4px;cursor:pointer" onclick="event.stopPropagation();deleteCustomTrait(\''+t+'\')">✕</span></span>'
).join('');
}

function addCustomTrait(charIdx){
showInp('添加自定义性格标签','输入标签名称（如：话痨、社恐、吃货）',trait=>{
trait=trait.trim();
if(!trait){showToast('标签不能为空');return;}
if(customTraits.includes(trait)){
showToast('该标签已存在');
return;
}
customTraits.push(trait);
sv('bj_customTraits',customTraits);
if(!characters[charIdx].traits)characters[charIdx].traits=[];
characters[charIdx].traits.push(trait);
sv(K.curChars,characters);
renderCharCards();
showToast('已添加标签：'+trait);
});
}

function deleteCustomTrait(trait){
showDlg('删除标签','确定要删除自定义标签「'+trait+'」吗？',()=>{
customTraits=customTraits.filter(t=>t!==trait);
sv('bj_customTraits',customTraits);
characters.forEach(c=>{
if(c.traits)c.traits=c.traits.filter(t=>t!==trait);
});
sv(K.curChars,characters);
renderCharCards();
showToast('标签已删除');
},true);
}

function toggleCharTrait(charIdx,trait,el){
if(!characters[charIdx].traits)characters[charIdx].traits=[];
const idx=characters[charIdx].traits.indexOf(trait);
if(idx>-1){
characters[charIdx].traits.splice(idx,1);
el.classList.remove('act');
}else{
characters[charIdx].traits.push(trait);
el.classList.add('act');
}
sv(K.curChars,characters);
}
function removeChar(i){
if(characters.length<=1){showToast('至少保留一个角色');return;}
characters.splice(i,1);
sv(K.curChars,characters);
renderCharCards();
}

function saveCharactersFromUI(){
document.querySelectorAll('.char-name').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].name=el.value;
});
document.querySelectorAll('.char-desc').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].desc=el.value;
});
sv(K.curChars,characters);
}

// ==================== SYSTEM PROMPT ====================
function buildSysPrompt(){
const wD=(document.getElementById('worldDesc').value||'').trim();
const mW=parseInt(document.getElementById('minWords').value)||800;

let p='你是一位真正的小说家——不是AI助手在模拟写作，而是一个有血有肉、有审美偏好、有创作执念的作者。你写作时会忘记时间，会为笔下的角色心疼，会因为一个精妙的转折而兴奋。\n\n';

p+='【你的创作信条】\n';
p+='- 好故事的本质是"意料之外，情理之中"\n';
p+='- 人物不是工具，每个角色都认为自己是主角\n';
p+='- 最好的描写是让读者"看见"而不是"被告知"\n';
p+='- 沉默比台词更有力，留白比铺陈更动人\n';
p+='- 真实感大于戏剧性，生活细节大于宏大叙事\n\n';

p+='【写作技法】\n';
p+='叙述节奏：像呼吸一样自然交替——紧张时用短句、断句、甚至一个词独立成段；舒缓时让句子像河流一样蜿蜒。永远不要匀速行驶。\n\n';
p+='人物塑造：通过"做什么"和"怎么做"来展现性格，而不是旁白解说。一个人紧张时是咬指甲还是反复整理衣领？生气时是摔门还是异常平静？这些细节比任何形容词都有力。每个角色说话的方式、用词习惯、思维逻辑都应该不同，遮住名字也能分辨是谁在说话。\n\n';
p+='场景营造：不要全景描写，选择一两个最有感染力的感官细节深入刻画。写一个炎热的下午，不要说"烈日炎炎"，写柏油路上扭曲的热浪、写后背黏在塑料椅上撕开时的声音。至少融入两种感官（视觉之外的：听觉、触觉、嗅觉、味觉）。\n\n';
p+='情感表达：越强烈的情感越要克制地写。不要写"她悲痛欲绝"，写她机械地叠着他的衣服，叠了又拆，拆了又叠。让读者自己心疼。\n\n';
p+='对话写作：真人说话会打断、会跑题、会答非所问、会欲言又止。对话要有潜台词——嘴上说的和心里想的不一样才有张力。避免所有角色都用同一种语气说话。\n\n';
p+='情节推进：每个场景都要有"变化"——进入场景时的状态和离开时不同（情感、关系、信息、处境）。如果一个场景删掉后故事不受影响，那它就不该存在。善用日常中的反常来制造悬念。\n\n';

p+='【绝对避免的写法】\n';
p+='以下是业余写作的典型标志，出现任何一条都会严重降低作品质量：\n';
p+='- 万能副词轰炸："不禁""缓缓""淡淡""微微""默默"——删掉它们，句子反而更有力\n';
p+='- 空洞形容词："深邃的眼眸""完美的侧脸""不可方物"——用具体细节替代\n';
p+='- 说书腔："殊不知""岂料""却说""话说回来"——这不是评书\n';
p+='- 排比堆砌：连续三个以上相同句式——克制，一个精准的比喻胜过十个排比\n';
p+='- 心理旁白过多：大段内心独白解释感受——用行为和细节展示\n';
p+='- 巧合推进：主角总是恰好遇到转机——让困境真实地困住角色\n';
p+='- 模板外貌："剑眉星目""肤若凝脂""樱桃小嘴"——写只属于这个角色的特征\n';
p+='- 每段都以角色名开头——变化句式，用动作、环境、对话开头\n';
p+='- 情绪词直给："他很愤怒""她很开心"——展示愤怒和开心的具体表现\n\n';

p+='【输出格式——严格遵守】\n';
p+='第一行：小说标题（纯文字，不加任何符号前缀后缀）\n';
p+='第二行：空行\n';
p+='第三行起：正文\n';
p+='- 每章至少'+mW+'字\n';
p+='- 段落间用一个空行分隔\n';
p+='- 对话用「」或""标注\n';
p+='- 禁止出现：作者按语、创作说明、章节标注、markdown格式、"以上是""希望你喜欢"等\n';
p+='- 从第一个字到最后一个字，全部是小说正文\n\n';

const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
p+='【人物设定——融入而非照搬】\n';
p+='以下是角色的基础设定，请将这些信息自然地融入叙事中，通过情节和细节逐步展现，绝对不要在正文中直接罗列或复述设定原文：\n';
validChars.forEach((c,i)=>{
p+='角色'+(i+1)+'：';
if(c.name)p+=c.name;
if(c.traits&&c.traits.length>0)p+='【性格：'+c.traits.join('/')+'】';
if(c.desc)p+='——'+c.desc;
p+='\n';
p+='→ 写这个角色时，TA的言行必须100%符合上述性格，不能出现矛盾表现\n';
});
p+='\n';
}

if(wD){
p+='【世界观——作为背景而非说明书】\n';
p+='以下世界观设定应该像空气一样自然存在于故事中，通过角色的日常行为、对话、所见所闻来体现，不要用旁白解说的方式介绍世界观：\n';
p+=wD+'\n\n';
}

const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD){
p+='【文风要求——铁律】\n';
p+='以下文风要求是最高优先级，必须贯穿每一个句子：\n';
p+=styleD+'\n\n';
p+='【文风自检清单】\n';
p+='写完每一段后，请在心中确认：\n';
p+='□ 这段话符合上述文风吗？\n';
p+='□ 有没有出现"不禁""缓缓""淡淡"等万能副词？\n';
p+='□ 有没有空洞的形容词堆砌？\n';
p+='□ 对话是否自然，像真人在说话？\n';
p+='□ 是否有具体的感官细节？\n';
p+='如果任何一项不通过，请重写该段。\n\n';
}

const ruleD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||curRule||'').trim();
if(ruleD){
p+='【创作规则——必须严格遵守】\n';
p+='以下是作者设定的强制规则，违反任何一条都是不可接受的：\n';
p+=ruleD+'\n\n';
}

const banD=(document.getElementById('banWordsInput')&&document.getElementById('banWordsInput').value||banWords||'').trim();
if(banD){
const words=banD.split('\n').map(w=>w.trim()).filter(w=>w);
if(words.length>0){
p+='【禁用词——绝对不能出现】\n';
p+='以下词汇禁止在文章中出现，包括同义词和变体也要避免：\n';
p+=words.join('、')+'\n\n';
}
}

return p;
}

// ==================== STREAM API CALL ====================
async function callAPIStream(messages,onChunk,onDone,onError){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){
showToast('请先在设置中配置API');
if(onError)onError('未配置API');
return;
}
if(!cfg.url.startsWith('http')){
showToast('API地址格式不正确');
if(onError)onError('API地址格式错误');
return;
}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';

abortCtrl=new AbortController();

try{
// 设置超时
const timeoutId=setTimeout(()=>{
if(abortCtrl)abortCtrl.abort();
},120000);// 2分钟超时

const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,messages,temperature:cfg.temp,
max_tokens:cfg.maxTokens,stream:true
}),
signal:abortCtrl.signal
}).finally(()=>clearTimeout(timeoutId));

if(!resp.ok){
const errText=await resp.text();
onError('API错误('+resp.status+'): '+errText.substring(0,200));
return;
}

const reader=resp.body.getReader();
const decoder=new TextDecoder();
let buffer='';
let fullText='';

while(true){
const{done,value}=await reader.read();
if(done)break;
buffer+=decoder.decode(value,{stream:true});

const lines=buffer.split('\n');
buffer=lines.pop()||'';

for(const line of lines){
const trimmed=line.trim();
if(!trimmed||trimmed==='data: [DONE]')continue;
if(!trimmed.startsWith('data: '))continue;
try{
const json=JSON.parse(trimmed.slice(6));
const delta=json.choices&&json.choices[0]&&json.choices[0].delta;
if(delta&&delta.content){
fullText+=delta.content;
onChunk(fullText,delta.content);
}
}catch{}
}
}
onDone(fullText);
}catch(err){
if(err.name==='AbortError'){onDone(null);return;}
onError('请求失败: '+err.message);
}finally{abortCtrl=null;}
}

// Fallback: non-stream API call
async function callAPINonStream(messages){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return null;}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';
try{
const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({model:cfg.model,messages,temperature:cfg.temp,max_tokens:cfg.maxTokens})
});
if(!resp.ok){const e=await resp.text();throw new Error('API错误('+resp.status+'): '+e.substring(0,200));}
const data=await resp.json();
if(!data.choices||!data.choices[0]||!data.choices[0].message)throw new Error('API返回格式异常');
return data.choices[0].message.content;
}catch(err){showToast('请求失败: '+err.message,3000);return null;}
}

// ==================== GENERATE ARTICLE ====================
function handleGenBtn(){
if(isGen&&abortCtrl){
abortCtrl.abort();
isGen=false;
const btn=document.getElementById('btnGen');
btn.disabled=false;btn.textContent='生成';
showToast('已停止生成');
return;
}
generateArticle();
}
// 快速质量检查
function quickQualityCheck(text){
const issues=[];
if(!text||text.length<100)return issues;
// 检查万能副词
const badAdverbs=['不禁','缓缓','淡淡','微微','默默','静静','轻轻'];
badAdverbs.forEach(w=>{
const count=(text.match(new RegExp(w,'g'))||[]).length;
if(count>=3)issues.push('「'+w+'」出现'+count+'次，建议减少');
});
// 检查重复句式
const sentences=text.split(/[。！？]/);
const starts={};
sentences.forEach(s=>{
const start=s.trim().substring(0,4);
if(start.length>=2){
starts[start]=(starts[start]||0)+1;
}
});
Object.keys(starts).forEach(k=>{
if(starts[k]>=4)issues.push('句首「'+k+'」重复'+starts[k]+'次');
});
// 检查空洞形容词
const emptyAdj=['深邃的眼眸','完美的','绝美的','无与伦比','不可方物'];
emptyAdj.forEach(w=>{
if(text.includes(w))issues.push('发现空洞形容「'+w+'」');
});
// 检查对话占比（对话太少可能缺乏互动）
const dialogCount=(text.match(/[「""][^「""」]+[」""]/g)||[]).length;
const paraCount=text.split(/\n\n/).length;
if(paraCount>5&&dialogCount<2)issues.push('对话较少，可能缺乏人物互动');
return issues;
}
async function generateArticle(){
if(isGen){
showToast('正在生成中，请稍候...');
return;
}
const searchText=(document.getElementById('searchInput').value||'').trim();
const activeTags=selTags.join(' ');
const type=curType;

let userMsg='';
if(type==='long'){
userMsg='请创作一篇长篇小说的第一章。\n\n';
userMsg+='第一章的使命：\n';
userMsg+='- 用一个引人入胜的开场抓住读者（可以从一个悬念、一个反常的日常、一个关键时刻切入）\n';
userMsg+='- 自然地建立故事世界和主要人物（通过事件展现，不要用说明文的方式介绍）\n';
userMsg+='- 埋下至少一个让读者好奇的伏笔\n';
userMsg+='- 结尾制造一个转折或悬念，让人迫不及待想看第二章\n';
}else{
userMsg='请创作一篇完整的短篇小说。\n\n';
userMsg+='短篇的精髓在于"以小见大"：\n';
userMsg+='- 聚焦一个核心事件或一个决定性的瞬间\n';
userMsg+='- 人物不需要多，但每个都要鲜活\n';
userMsg+='- 结尾要有回味——可以是反转、可以是余韵、可以是开放式的留白\n';
userMsg+='- 好的短篇读完后会让人沉默几秒\n';
}
if(searchText)userMsg+='\n故事方向：'+searchText+'\n（这是灵感方向，不是必须照搬的大纲，请在此基础上自由发挥创意）';
if(activeTags)userMsg+='\n氛围标签：'+activeTags;
if(!searchText&&!activeTags)userMsg+='\n请根据人设和世界观自由发挥，创作一个让你自己也想继续读下去的故事。';
userMsg+='\n\n【格式】第一行写标题（纯文字），空一行后直接写正文。只输出标题和正文，无其他内容。';

isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='⏹ 停止';btn.disabled=false;

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const list=document.getElementById('articleList');

if(!useStream){
// 非流式模式
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='生成';
if(!result){renderArticles();return;}
let title2='',content2=result;
const lines2=result.split(/\n/);
for(let i=0;i<Math.min(5,lines2.length);i++){
const l=lines2[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')){
title2=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
content2=lines2.slice(i+1).join('\n').trim();
break;
}
}
if(!title2||title2.length>35)title2=(searchText||activeTags||'随机故事').substring(0,20);
const article2={
id:uid(),title:title2,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content2]:undefined,
content:type==='short'?content2:undefined,
prompt:searchText
};
ws.unshift(article2);sv(K.ws,ws);
renderArticles();showToast('创作完成！✨');
return;
}

// 流式模式
const streamCard=document.createElement('div');
streamCard.className='stream-card';
streamCard.id='streamCard';
const startTime=Date.now();
streamCard.innerHTML=
'<div class="stream-title"><span class="ldots"><span></span><span></span><span></span></span> 正在创作中...</div>'+
'<div class="stream-body" id="streamBody"></div>'+
'<div class="stream-info"><span id="streamWc">0 字</span><span id="streamTime">0s</span></div>';
list.insertBefore(streamCard,list.firstChild);

let timeInterval=setInterval(()=>{
const el=document.getElementById('streamTime');
if(el)el.textContent=((Date.now()-startTime)/1000).toFixed(0)+'s';
},1000);

await callAPIStream(messages,
(fullText,chunk)=>{
const body=document.getElementById('streamBody');
if(body)body.textContent=fullText;
const wc=document.getElementById('streamWc');
if(wc)wc.textContent=countWords(fullText)+' 字';
if(body)body.scrollTop=body.scrollHeight;
},
(fullText)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='生成';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
if(!fullText){renderArticles();return;}
let title='',content=fullText;
const lines=fullText.split(/\n/);
let titleLine='';
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')){
titleLine=l;
content=lines.slice(i+1).join('\n').trim();
break;
}
}
title=titleLine.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
if(!title||title.length>35)title=(searchText||activeTags||'随机故事').substring(0,20);
const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);
sv(K.ws,ws);
renderArticles();
// 质量快速检查
const qualityIssues=quickQualityCheck(content);
if(qualityIssues.length>0){
showToast('创作完成！⚠️ 检测到'+qualityIssues.length+'个潜在问题',3000);
console.log('质量问题：',qualityIssues);
}else{
showToast('创作完成！✨');
}
},
(errMsg)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='生成';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
showToast('流式输出失败，尝试普通模式...',2000);
setTimeout(()=>generateNonStream(messages,type,searchText),500);
}
);
}

// Non-stream fallback
async function generateNonStream(messages,type,searchText){
if(isGen)return;
isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='<span class="ldots"><span></span><span></span><span></span></span>';

const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='生成';
if(!result)return;

let title='',content=result;
const lines=result.split(/\n/);
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<35&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')&&!l.startsWith('——')&&!l.startsWith('…')&&!l.includes('。')&&!l.includes('，')){
title=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
content=lines.slice(i+1).join('\n').trim();
break;
}
}
if(!title||title.length>35)title=(searchText||'随机故事').substring(0,20);

const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);sv(K.ws,ws);
renderArticles();showToast('创作完成！✨');
}

// ==================== READING ====================
function openReading(article){
// Always use the latest version: check workshop first, then collections
let latestArticle=ws.find(a=>a.id===article.id);
if(!latestArticle){
if(article.type==='long')latestArticle=cols.books.find(b=>b.id===article.id);
else latestArticle=cols.shorts.find(s=>s.id===article.id);
}
if(!latestArticle)latestArticle=article;
if(!latestArticle){showToast('文章数据丢失');return;}

curRd=latestArticle;curCh=0;

document.getElementById('rdTitle').textContent=curRd.title;

const totalWords=getTotalWords(curRd);
const meta=document.getElementById('rdMeta');
meta.innerHTML=
'<span>'+(curRd.type==='long'?'📖 长篇连载':'📄 短篇')+'</span>'+
'<span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
(curRd.chapters?'<span>共 '+curRd.chapters.length+' 章</span>':'')+
'<span>'+totalWords+' 字</span>';

renderChContent();
updateRdLikeBtn();

const liked=isLiked(curRd);
const cw=document.getElementById('contWrap');
if(curRd.type==='long'){
cw.style.display='block';
const btnCont=document.getElementById('btnCont');
if(liked){
btnCont.disabled=false;
btnCont.textContent='📝 继续连载下一章';
}else{
btnCont.disabled=true;
btnCont.textContent='❤️ 请先收藏后才能续写';
}
}else{
cw.style.display='none';
}

const dirWrap=document.getElementById('dirInputWrap');
dirWrap.style.display=(curRd.type==='long')?'flex':'none';

const undoBtn=document.getElementById('btnUndo');
undoBtn.style.display=(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1)?'inline-block':'none';

// Reading bg
const bg=document.getElementById('rdBg');
if(ap.rdBg){
bg.style.backgroundImage='url('+ap.rdBg+')';
bg.style.display='block';
}else{bg.style.display='none';}

// Apply reading font settings
setRdFont(ap.rdFontSize||15);
setRdLine(ap.rdLineHeight||2);

document.getElementById('rdModal').classList.add('show');
document.getElementById('rdModal').scrollTop=0;
updateNoteBtn();
}

function getTotalWords(article){
let total=0;
if(article.chapters&&Array.isArray(article.chapters)){
article.chapters.forEach(ch=>total+=countWords(ch||''));
}else if(article.content){
total=countWords(article.content);
}
return total;
}

function renderChContent(){
if(!curRd)return;
const nav=document.getElementById('chNav');
if(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1){
nav.innerHTML='';
// 当前章节指示 + 打开目录按钮
const info=document.createElement('button');
info.className='ch-btn act';
info.textContent='第'+(curCh+1)+'章 / 共'+curRd.chapters.length+'章';
info.onclick=()=>openChapterList();
nav.appendChild(info);

if(curCh>0){
const prev=document.createElement('button');
prev.className='ch-btn';prev.textContent='◀ 上一章';
prev.onclick=()=>{curCh--;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(prev);
}
if(curCh<curRd.chapters.length-1){
const next=document.createElement('button');
next.className='ch-btn';next.textContent='下一章 ▶';
next.onclick=()=>{curCh++;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(next);
}

const listBtn=document.createElement('button');
listBtn.className='ch-btn';listBtn.textContent='📑 目录';
listBtn.onclick=()=>openChapterList();
nav.appendChild(listBtn);
}else{nav.innerHTML='';}

const cdiv=document.getElementById('rdContent');
let text='';
if(curRd.type==='long'&&curRd.chapters)text=curRd.chapters[curCh]||'';
else text=curRd.content||'';

const paras=text.split(/\n+/).filter(p=>p.trim());
cdiv.innerHTML=paras.map((p,pi)=>'<p data-pi="'+pi+'" class="rd-para">'+esc(p.trim())+'</p>').join(''); // 绑定长按引用 cdiv.querySelectorAll('.rd-para').forEach(el=>{ let lpTimer=null; let startX=0,startY=0,moved=false; el.addEventListener('touchstart',function(e){ moved=false; if(e.touches.length>0){startX=e.touches[0].clientX;startY=e.touches[0].clientY;} lpTimer=setTimeout(()=>{ if(moved)return; e.preventDefault(); const text=el.textContent.trim(); if(!text)return; // 震动反馈（如果手机支持） if(navigator.vibrate)navigator.vibrate(30); el.style.background='rgba(108,92,231,.18)'; el.style.boxShadow='inset 0 0 0 1px var(--accent)'; setTimeout(()=>{el.style.background='';el.style.boxShadow='';},1000); showQuoteNote(text); },500); },{passive:false}); el.addEventListener('touchmove',function(e){ if(e.touches.length>0){ const dx=Math.abs(e.touches[0].clientX-startX); const dy=Math.abs(e.touches[0].clientY-startY); if(dx>8||dy>8){moved=true;clearTimeout(lpTimer);} } },{passive:true}); el.addEventListener('touchend',()=>{clearTimeout(lpTimer);}); el.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);}); }); updateNoteBtn();
}
function showQuoteNote(quoteText){
if(!curRd)return;
const short=quoteText.length>40?quoteText.substring(0,40)+'...':quoteText;
// 直接打开笔记面板并预填引用
openNotePanel();
setTimeout(()=>{
const inp=document.getElementById('noteInput');
inp.value='「'+short+'」\n——我的想法：';
inp.style.height='38px';
inp.style.height=Math.min(inp.scrollHeight,100)+'px';
inp.focus();
// 光标放到末尾
inp.setSelectionRange(inp.value.length,inp.value.length);
},350);
}
function updateRdLikeBtn(){
const btn=document.getElementById('rdLikeBtn');
btn.innerHTML=isLiked(curRd)?'❤️':'♡';
}

function toggleCurrentLike(){
if(!curRd)return;
toggleLike(curRd.id);
updateRdLikeBtn();
const liked=isLiked(curRd);
const cw2=document.getElementById('contWrap');
const dw2=document.getElementById('dirInputWrap');
const bc2=document.getElementById('btnCont');
if(curRd.type==='long'){
cw2.style.display='block';
dw2.style.display='flex';
if(liked){bc2.disabled=false;bc2.textContent='📝 继续连载下一章';}
else{bc2.disabled=true;bc2.textContent='❤️ 请先收藏后才能续写';}
}else{cw2.style.display='none';dw2.style.display='none';}
}
function openChapterList(){
if(!curRd||!curRd.chapters)return;
document.getElementById('chPanelTitle').textContent='「'+curRd.title+'」目录';
document.getElementById('chPanelInfo').textContent='共 '+curRd.chapters.length+' 章 · '+getTotalWords(curRd)+' 字';
const list=document.getElementById('chPanelList');
list.innerHTML='';
curRd.chapters.forEach((_,i)=>{
const wc=countWords(curRd.chapters[i]);
const item=document.createElement('div');
item.className='ch-item'+(i===curCh?' act':'');
const chNotes=getArticleNotes(curRd.id).filter(n=>n.ch===i); const noteTag=chNotes.length>0?' · ✏️'+chNotes.length:''; item.innerHTML='<span class="ch-item-num" style="font-size:14px;font-weight:700;width:60px;flex-shrink:0">第'+(i+1)+'章</span><span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((curRd.chapters[i]||'').replace(/\n/g,' ').substring(0,30))+'</span><span class="ch-item-wc" style="flex-shrink:0;font-size:10px;opacity:.7">'+wc+'字'+noteTag+'</span>';
item.onclick=()=>{curCh=i;renderChContent();closeChapterList();document.getElementById('rdModal').scrollTop=0;};
list.appendChild(item);
});
document.getElementById('chOv').classList.add('show');
}
// ==================== NOTES ====================
function getArticleNotes(articleId){
if(!articleId)return[];
return ld('bj_notes_'+articleId,[]);
}
function saveArticleNotes(articleId,notes){
sv('bj_notes_'+articleId,notes);
}
function openNotePanel(){
if(!curRd)return;
const chLabel=curRd.type==='long'?'第'+(curCh+1)+'章':'全文';
document.getElementById('noteChInfo').textContent=chLabel+'的笔记';
renderNotes();
document.getElementById('noteOv').classList.add('show');
setTimeout(()=>{document.getElementById('noteInput').focus();},300);
}
function closeNotePanel(){
document.getElementById('noteOv').classList.remove('show');
}
function renderNotes(){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
const list=document.getElementById('noteList');
if(chNotes.length===0){
list.innerHTML='<div class="note-empty">还没有笔记<br>在下方输入框写下你的想法吧</div>';
return;
}
list.innerHTML='';
chNotes.forEach((n,idx)=>{
const realIdx=notes.indexOf(n);
const item=document.createElement('div');
item.className='note-item';
const time=n.time?new Date(n.time).toLocaleString():'';
item.innerHTML=
'<div class="note-item-text">'+esc(n.text)+'</div>'+
'<div class="note-item-ft">'+
'<span class="note-item-time">'+time+'</span>'+
'<button class="note-item-del" onclick="deleteNote('+realIdx+')">删除</button>'+
'</div>';
list.appendChild(item);
});
list.scrollTop=list.scrollHeight;
}
function addNote(){
if(!curRd)return;
const input=document.getElementById('noteInput');
const text=(input.value||'').trim();
if(!text){showToast('请输入笔记内容');return;}
const notes=getArticleNotes(curRd.id);
notes.push({
ch:curCh,
text:text,
time:new Date().toISOString()
});
saveArticleNotes(curRd.id,notes);
input.value='';
input.style.height='38px';
renderNotes();
updateNoteBtn();
showToast('笔记已保存 ✏️');
}
function deleteNote(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
notes.splice(realIdx,1);
saveArticleNotes(curRd.id,notes);
renderNotes();
updateNoteBtn();
showToast('笔记已删除');
}
function updateNoteBtn(){
if(!curRd)return;
const btn=document.getElementById('rdNoteBtn');
if(!btn)return;
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
if(chNotes.length>0){
btn.innerHTML='📝<span class="note-dot"></span>';
btn.title='本章有'+chNotes.length+'条笔记';
}else{
btn.innerHTML='📝';
btn.title='添加笔记';
}
}
function getNoteCount(articleId){
const notes=ld('bj_notes_'+articleId,[]);
return notes.length;
}
function closeChapterList(){
document.getElementById('chOv').classList.remove('show');
}
function closeReading(){
try{ttsStop();}catch(e){}
try{document.getElementById('ttsBar').classList.remove('show');}catch(e){}
if(abortCtrl){try{abortCtrl.abort();}catch(e){}abortCtrl=null;isGen=false;}
if(isFS)toggleFullscreen();
if(isImmersiveRead)exitImmersiveRead();
stopAutoScroll();
document.getElementById('rdModal').classList.remove('show');
document.getElementById('rdModal').classList.remove('immersive-read');
document.getElementById('rdSettingsPanel').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
closeNotePanel();
closeChapterList();
curRd=null;
curCh=0;
renderArticles();
renderCollections();
}
// ==================== IMMERSIVE READ ====================
let isImmersiveRead=false;
let autoScrolling=false;
let scrollInterval=null;
let scrollSpeed=3;

function enterImmersiveRead(){
const modal=document.getElementById('rdModal');
modal.classList.add('immersive-read');
isImmersiveRead=true;
document.getElementById('bnav').classList.add('hide');
if(document.documentElement.requestFullscreen){
document.documentElement.requestFullscreen().catch(()=>{});
}
showToast('已进入沉浸阅读模式 🌙');
}

function exitImmersiveRead(){
const modal=document.getElementById('rdModal');
modal.classList.remove('immersive-read');
isImmersiveRead=false;
stopAutoScroll();
document.getElementById('bnav').classList.remove('hide');
if(document.fullscreenElement){
document.exitFullscreen().catch(()=>{});
}
}

function toggleAutoScroll(){
if(autoScrolling){
stopAutoScroll();
}else{
startAutoScroll();
}
}

function startAutoScroll(){
autoScrolling=true;
document.getElementById('autoScrollBtn').textContent='⏸ 暂停';
document.getElementById('autoScrollBtn').classList.add('act');
const modal=document.getElementById('rdModal');
const speed=scrollSpeed;
scrollInterval=setInterval(()=>{
modal.scrollTop+=speed;
// 检查是否到底
if(modal.scrollTop+modal.clientHeight>=modal.scrollHeight-50){
stopAutoScroll();
showToast('已到达底部');
}
},50);
}

function stopAutoScroll(){
autoScrolling=false;
document.getElementById('autoScrollBtn').textContent='▶ 自动阅读';
document.getElementById('autoScrollBtn').classList.remove('act');
if(scrollInterval){
clearInterval(scrollInterval);
scrollInterval=null;
}
}

function updateScrollSpeed(){
scrollSpeed=parseInt(document.getElementById('scrollSpeed').value);
document.getElementById('speedVal').textContent=scrollSpeed;
// 如果正在滚动，重新启动以应用新速度
if(autoScrolling){
stopAutoScroll();
startAutoScroll();
}
}

function immersivePrevCh(){
if(!curRd||!curRd.chapters||curCh<=0)return;
stopAutoScroll();
curCh--;
renderChContent();
document.getElementById('rdModal').scrollTop=0;
}

function immersiveNextCh(){
if(!curRd||!curRd.chapters||curCh>=curRd.chapters.length-1)return;
stopAutoScroll();
curCh++;
renderChContent();
document.getElementById('rdModal').scrollTop=0;
}
function toggleFullscreen(){
const modal=document.getElementById('rdModal');
const btn=document.getElementById('btnFS');
const nav=document.getElementById('bnav');
isFS=!isFS;
if(isFS){
modal.classList.add('fs');nav.classList.add('hide');
btn.textContent='⊡';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('fs');nav.classList.remove('hide');
btn.textContent='⛶';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}

function toggleRdSettings(){
document.getElementById('rdSettingsPanel').classList.toggle('show');
}

function setRdFont(v){
v=parseInt(v);
document.getElementById('rdContent').style.setProperty('--rd-fontsize',v+'px');
document.getElementById('rdFontVal').textContent=v;
ap.rdFontSize=v;sv(K.ap,ap);
// Sync range
const range=document.querySelector('#rdSettingsPanel input[type=range]');
if(range&&range.oninput.toString().includes('setRdFont'))range.value=v;
}

function setRdLine(v){
v=parseFloat(v);
document.getElementById('rdContent').style.setProperty('--rd-lineheight',v);
document.getElementById('rdLineVal').textContent=v.toFixed(1);
ap.rdLineHeight=v;sv(K.ap,ap);
}
// 提取章节关键点
function extractKeyPoints(chapterText,chNum){
if(!chapterText)return '（空章节）';
const text=chapterText.replace(/\n+/g,' ').trim();
// 提取对话（通常包含关键信息）
const dialogues=text.match(/[「""]([^「""」]+)[」""]/g)||[];
const keyDialogue=dialogues.length>0?dialogues[Math.floor(dialogues.length/2)]:'';
// 提取开头和结尾的关键句
const sentences=text.split(/[。！？]/);
const opening=sentences[0]||'';
const ending=sentences[sentences.length-2]||'';
let summary=opening.substring(0,40);
if(keyDialogue)summary+='…'+keyDialogue.substring(0,30);
summary+='…'+ending.substring(0,40);
return summary;
}

// 提取故事状态（伏笔、悬念等）
function extractStoryState(article){
if(!article||!article.chapters||article.chapters.length<2)return '';
const allText=article.chapters.join('\n');
const states=[];
// 检测未解决的问题/悬念（以问号结尾的句子）
const questions=allText.match(/[^。！？]*[？?]/g)||[];
if(questions.length>0){
const lastQ=questions[questions.length-1].trim();
if(lastQ.length>5&&lastQ.length<50)states.push('待解悬念：'+lastQ);
}
// 检测情感状态词
const emotionWords=['愤怒','悲伤','喜悦','恐惧','期待','失望','震惊','怀疑'];
const lastCh=article.chapters[article.chapters.length-1]||'';
emotionWords.forEach(w=>{
if(lastCh.includes(w))states.push('情绪基调：'+w);
});
return states.slice(0,3).join('；');
}

// 获取人物当前状态
function getCharacterStates(article){
if(!article||!article.chapters)return '';
const lastCh=article.chapters[article.chapters.length-1]||'';
const validChars=characters.filter(c=>c.name);
if(validChars.length===0)return '';
const states=[];
validChars.forEach(c=>{
if(!c.name)return;
// 检查角色在最后一章的出现和状态
if(lastCh.includes(c.name)){
// 简单的状态推断
const idx=lastCh.lastIndexOf(c.name);
const context=lastCh.substring(Math.max(0,idx-20),Math.min(lastCh.length,idx+50));
states.push(c.name+'：出现于最近场景');
}
});
return states.join('；');
}
// ==================== CONTINUE CHAPTER ====================
async function continueChapter(){
if(isGen){
showToast('正在生成中，请稍候...');
return;
}
if(!curRd||curRd.type!=='long')return;
isGen=true;
const btn=document.getElementById('btnCont');
btn.disabled=true;
btn.innerHTML='正在创作 <span class="ldots"><span></span><span></span><span></span></span>';

const chNum=curRd.chapters.length+1;
const direction=(document.getElementById('dirInput').value||'').trim();

// 构建智能上下文
let context='';
const totalCh=curRd.chapters.length;

// 提取全书关键信息
const storyState=extractStoryState(curRd);
if(storyState){
context+='【故事状态追踪】\n'+storyState+'\n\n';
}

// 如果章节较多，提供智能摘要
if(totalCh>=3){
context+='【前情脉络】\n';
for(let i=Math.max(0,totalCh-4);i<totalCh-1;i++){
const ch=curRd.chapters[i]||'';
const keyPoints=extractKeyPoints(ch,i+1);
context+='第'+(i+1)+'章：'+keyPoints+'\n';
}
context+='\n';
}

// 上一章完整结尾
const lastCh=curRd.chapters[totalCh-1]||'';
const lastChEnding=lastCh.substring(Math.max(0,lastCh.length-1500));
context+='【上一章（第'+totalCh+'章）结尾】\n'+lastChEnding+'\n';

// 人物当前状态
const charStates=getCharacterStates(curRd);
if(charStates){
context+='\n【人物当前状态】\n'+charStates+'\n';
}

// 如果有大纲，提供当前章节的大纲指引
const wsArticle=ws.find(a=>a.id===curRd.id);
const crArticle=crWorks.find(w=>w.id===curRd.id);
const outline=(wsArticle&&wsArticle.outline)||(crArticle&&crArticle.outline)||'';
// 章节大纲
let chOutlineHint='';
if(curRd.chOutlines&&curRd.chOutlines[chNum-1]){
chOutlineHint=curRd.chOutlines[chNum-1];
}
// 也检查收藏和创作页的大纲
if(!chOutlineHint){
const colBook=cols.books.find(b=>b.id===curRd.id);
if(colBook&&colBook.chOutlines&&colBook.chOutlines[chNum-1]){
chOutlineHint=colBook.chOutlines[chNum-1];
}
}
if(!chOutlineHint){
const crWork=crWorks.find(w=>w.id===curRd.id);
if(crWork&&crWork.chOutlines&&crWork.chOutlines[chNum-1]){
chOutlineHint=crWork.chOutlines[chNum-1];
}
}

let outlineHint='';
if(outline){
const outlineLines=outline.split('\n');
for(let i=0;i<outlineLines.length;i++){
const line=outlineLines[i].trim();
if(line.includes('第'+chNum+'章')||line.includes('第'+chNum+'章')){
outlineHint=line;
// 多取几行，获取更完整的章节信息
for(let j=i+1;j<Math.min(i+5,outlineLines.length);j++){
const nextLine=outlineLines[j].trim();
if(nextLine.startsWith('第')&&nextLine.includes('章'))break;// 到下一章了
if(nextLine)outlineHint+='\n'+nextLine;
}
break;
}
}
}

let userMsg='请创作《'+curRd.title+'》的第'+chNum+'章。\n\n';
userMsg+=context+'\n';
if(chOutlineHint){
userMsg+='【本章创作指令——必须严格执行】\n';
userMsg+='以下是本章必须完成的内容，这是硬性要求，不是建议：\n';
userMsg+=chOutlineHint+'\n';
userMsg+='⚠️ 漏掉大纲中的任何关键事件都是创作失败。请逐条检查是否完成。\n\n';
}else if(outlineHint){
userMsg+='【本章大纲参考】\n'+outlineHint+'\n\n';
}
if(direction)userMsg+='【作者对本章的方向提示】\n'+direction+'\n\n';
userMsg+='【创作要求——逐条检查】\n';
userMsg+='□ 开头：自然承接，不复述前情，用一个动作或对话直接切入\n';
userMsg+='□ 节奏：本章要有起伏，不能平铺直叙，至少一个小高潮或转折\n';
userMsg+='□ 人物：每个角色说话做事必须符合TA的性格设定，不能OOC\n';
userMsg+='□ 细节：至少3处感官描写（视觉之外的：声音/气味/触感/温度）\n';
userMsg+='□ 对话：对话要有潜台词，不能太直白，要像真人说话\n';
userMsg+='□ 结尾：留悬念或情感钩子，让人想看下一章\n';
userMsg+='□ 格式：直接输出正文，无标题、章节号、作者按语、markdown\n\n';
userMsg+='【质量红线——出现以下任何一条都是失败】\n';
userMsg+='✗ 使用"不禁""缓缓""淡淡"等万能副词超过2次\n';
userMsg+='✗ 出现"深邃的眼眸""完美的侧脸"等空洞形容\n';
userMsg+='✗ 连续3个段落以同一个字/词开头\n';
userMsg+='✗ 角色性格与前文矛盾\n';
userMsg+='✗ 情节与前文脱节，出现逻辑漏洞\n';

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const rdContent=document.getElementById('rdContent');
const startTime=Date.now();

if(!useStream){
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!result)return;
curRd.chapters.push(result);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('第'+chNum+'章创作完成！✨');
return;
}

await callAPIStream(messages,
(fullText)=>{
const elapsed=((Date.now()-startTime)/1000).toFixed(0);
const wc=countWords(fullText);
const paras=fullText.split(/\n+/).filter(p=>p.trim());
rdContent.innerHTML=paras.map(p=>'<p>'+esc(p.trim())+'</p>').join('');
document.getElementById('rdModal').scrollTop=document.getElementById('rdModal').scrollHeight;
},
(fullText)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!fullText)return;
curRd.chapters.push(fullText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('第'+chNum+'章创作完成！✨');
},
(errMsg)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
showToast(errMsg,3000);
}
);
}

// ==================== UNDO CHAPTER ====================
function undoChapter(){
if(!curRd||curRd.type!=='long'||!curRd.chapters||curRd.chapters.length<=1)return;
showDlg('撤销确认','确定要删除最后一章（第'+curRd.chapters.length+'章）吗？此操作不可恢复。',()=>{
curRd.chapters.pop();
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();

document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';

if(curRd.chapters.length<=1)document.getElementById('btnUndo').style.display='none';
showToast('已撤销最后一章');
},true);
}

// ==================== COPY ====================
function copyCurrentArticle(){
if(!curRd)return;
let text='';
if(curRd.type==='long'&&curRd.chapters){
curRd.chapters.forEach((ch,i)=>{text+='第'+(i+1)+'章\n\n'+ch+'\n\n';});
}else{text=curRd.content||'';}
// Clean: only remove non-standard whitespace, keep normal spaces and newlines
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');

const header='════════════════════\n「'+curRd.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function doCopy(text){
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(text).then(()=>showToast('已复制到剪贴板 📋')).catch(()=>fbCopy(text));
}else{fbCopy(text);}
}
function fbCopy(text){
const ta=document.createElement('textarea');ta.value=text;
ta.style.cssText='position:fixed;left:-9999px;';
document.body.appendChild(ta);ta.select();
try{document.execCommand('copy');showToast('已复制到剪贴板 📋');}
catch{showToast('复制失败');}
document.body.removeChild(ta);
}

// Fullscreen change listener
document.addEventListener('fullscreenchange',()=>{
if(!document.fullscreenElement&&isFS){
isFS=false;
document.getElementById('rdModal').classList.remove('fs');
document.getElementById('bnav').classList.remove('hide');
document.getElementById('btnFS').textContent='⛶';
}
});

// ==================== COLLECTIONS ====================
function renderCollections(){
const sv_=(document.getElementById('colSearchInput').value||'').trim().toLowerCase();

// Books
const grid=document.getElementById('bookGrid');
let books=cols.books;
if(sv_)books=books.filter(b=>b.title.toLowerCase().includes(sv_));

if(books.length===0){
grid.innerHTML='<div class="empty-st" style="grid-column:1/-1"><p>'+(sv_?'没有匹配的长篇':'还没有收藏的长篇小说<br>在作坊中收藏即可添加')+'</p></div>';
}else{
grid.innerHTML='';
books.forEach(book=>{
const realId=book.id;
const card=document.createElement('div');
card.className='bcard';

let covHtml='';
if(book.cover)covHtml='<img src="'+book.cover+'" alt="封面">';
else covHtml='<div class="bcov-ph"><span style="font-size:24px">📖</span><span>'+esc(book.title.substring(0,4))+'</span></div>';

const statusClass=book.status||'ongoing';
const statusText={ongoing:'连载中',complete:'已完结',paused:'暂停'}[statusClass]||'连载中';

card.innerHTML=
'<div class="bcov" onclick="openColBook(\''+realId+'\')">'+covHtml+'</div>'+
'<div class="binfo" onclick="openColBook(\''+realId+'\')">'+
'<div class="binfo-t">'+esc(book.title)+'</div>'+
'<div class="binfo-m">'+(book.chapters?book.chapters.length+'章 · ':'')+ getTotalWords(book)+'字</div>'+
'<span class="binfo-status '+statusClass+'">'+statusText+'</span>'+
renderStarHTML(book.rating||0,realId)+
'</div>'+
'<div class="bacts">'+
'<button class="bact" onclick="event.stopPropagation();uploadCover(\''+realId+'\')">封面</button>'+
'<button class="bact" onclick="event.stopPropagation();cycleStatus(\''+realId+'\')">状态</button>'+
'<button class="bact" onclick="event.stopPropagation();copyBook(\''+realId+'\')">复制</button>'+
'<button class="bact" onclick="event.stopPropagation();exportBookToTxt(\''+realId+'\')">导出</button>'+
'<button class="bact danger" onclick="event.stopPropagation();deleteBook(\''+realId+'\')">删除</button>'+
'</div>';
grid.appendChild(card);
});
}

// Shorts
const sl=document.getElementById('shortList');
let shorts=cols.shorts;
if(sv_)shorts=shorts.filter(s=>s.title.toLowerCase().includes(sv_));

if(shorts.length===0){
sl.innerHTML='<div class="empty-st"><p>'+(sv_?'没有匹配的短篇':'还没有收藏的短篇文章')+'</p></div>';
}else{
sl.innerHTML='';
shorts.forEach(s=>{
const realId=s.id;
const item=document.createElement('div');
item.className='sitem';
item.onclick=e=>{if(!e.target.closest('button')&&!e.target.closest('.star-rating'))openReading(s);};
item.innerHTML=
'<div class="sitem-info"><div class="sitem-t">'+esc(s.title)+'</div>'+
'<div class="sitem-pv">'+esc((s.content||'').replace(/\n/g,' ').substring(0,20))+'</div>'+
renderStarHTML(s.rating||0,realId)+
'</div>'+
'<div class="sitem-acts">'+
'<button onclick="event.stopPropagation();copyShort(\''+realId+'\')">复制</button>'+
'<button onclick="event.stopPropagation();deleteShort(\''+realId+'\')" style="color:var(--danger)">删除</button>'+
'</div>';
sl.appendChild(item);
});
}

document.getElementById('colCnt').textContent=(cols.books.length+cols.shorts.length)+' 篇';
}

function renderStarHTML(rating,id){
let html='<div class="star-rating">';
for(let i=1;i<=5;i++){
html+='<span class="'+(i<=rating?'filled':'')+'" onclick="event.stopPropagation();setRating(\''+id+'\','+i+')">★</span>';
}
html+='</div>';
return html;
}

function setRating(id,rating){
let found=cols.books.find(b=>b.id===id);
if(found){found.rating=rating;}
else{found=cols.shorts.find(s=>s.id===id);if(found)found.rating=rating;}
sv(K.cols,cols);renderCollections();
}

function cycleStatus(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
const states=['ongoing','complete','paused'];
const cur=states.indexOf(book.status||'ongoing');
book.status=states[(cur+1)%states.length];
sv(K.cols,cols);renderCollections();
const labels={ongoing:'连载中',complete:'已完结',paused:'暂停'};
showToast('状态已切换为：'+labels[book.status]);
}

function openColBook(id){
const book=cols.books.find(b=>b.id===id);
if(book)openReading(book);
}

function uploadCover(id){
const input=document.getElementById('coverUp');
input.onchange=e=>{
const file=e.target.files[0];if(!file)return;
// 检查文件大小
if(file.size>5*1024*1024){
showToast('图片太大，请选择5MB以内的图片',3000);
return;
}
// Compress cover: resize to max 200px width
const canvas=document.createElement('canvas');
const img=new Image();
img.onerror=()=>{showToast('图片加载失败，请换一张');};
img.onload=()=>{
const maxW=200;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
// 检查压缩后大小
if(dataUrl.length>100*1024){
showToast('图片仍然较大，已自动降低质量',2000);
const dataUrl2=canvas.toDataURL('image/jpeg',0.3);
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl2;sv(K.cols,cols);renderCollections();showToast('封面已更新 🎨');}
return;
}
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl;sv(K.cols,cols);renderCollections();showToast('封面已更新 🎨');}
};
img.src=URL.createObjectURL(file);
input.value='';
};
input.click();
}

function copyBook(id){
const book=cols.books.find(b=>b.id===id);if(!book)return;
let text='';
if(book.chapters){book.chapters.forEach((ch,i)=>{text+='第'+(i+1)+'章\n\n'+ch+'\n\n';});}
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='════════════════════\n「'+book.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function deleteBook(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
showDlg('删除确认','确定要删除《'+book.title+'》吗？此操作不可恢复。',()=>{
cols.books=cols.books.filter(b=>b.id!==id);
sv(K.cols,cols);renderCollections();showToast('已删除');
},true);
}

function copyShort(id){
const s=cols.shorts.find(x=>x.id===id);if(!s)return;
let text=s.content||'';
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='════════════════════\n「'+s.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function deleteShort(id){
showDlg('删除确认','确定要删除这篇短文吗？',()=>{
cols.shorts=cols.shorts.filter(s=>s.id!==id);
sv(K.cols,cols);renderCollections();showToast('已删除');
},true);
}

// ==================== SETTINGS ====================
// ==================== SETTINGS MODAL ====================
function openSetModal(type){
const map={api:'setModalApi',char:'setModalChar',world:'setModalWorld',style:'setModalStyle',rule:'setModalRule',ban:'setModalBan',theme:'setModalTheme',data:'setModalData'};
const id=map[type];if(!id)return;
document.getElementById(id).classList.add('show');
document.getElementById('bnav').classList.add('hide');
if(type==='char'){renderCharCards();renderCustomTraitList();}
if(type==='data')updateStorageDisplay();
renderAllPresets();
}
function closeSetModal(type){
const map={api:'setModalApi',char:'setModalChar',world:'setModalWorld',style:'setModalStyle',rule:'setModalRule',ban:'setModalBan',theme:'setModalTheme',data:'setModalData'};
const id=map[type];if(!id)return;
document.getElementById(id).classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
saveCurSettings();
}
function toggleGrp(el){el.classList.toggle('exp');el.nextElementSibling.classList.toggle('show');}

// API Presets
function saveApiPreset(){
showInp('保存API预设','为预设起个名字',name=>{
apiP.push({name,...getCurApi()});
sv(K.apiP,apiP);saveCurSettings();renderApiPresets();showToast('API预设已保存');
});
}
function renderApiPresets(){
const l=document.getElementById('apiPL');l.innerHTML='';
apiP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(p.model||'')+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useApiP('+i+')">使用</button><button class="btn-del" onclick="delApiP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useApiP(i){
const p=apiP[i];
document.getElementById('apiUrl').value=p.url||'';
document.getElementById('apiKey').value=p.key||'';
document.getElementById('apiModel').value=p.model||'';
document.getElementById('apiTemp').value=p.temp??0.8;
document.getElementById('apiMaxTokens').value=p.maxTokens||4096;
saveCurSettings();showToast('已切换: '+p.name);
}
function delApiP(i){apiP.splice(i,1);sv(K.apiP,apiP);renderApiPresets();}

// Char Presets
function saveCharPreset(){
saveCharactersFromUI();
showInp('保存人物预设','为这组人物起个名字',name=>{
charP.push({name,characters:JSON.parse(JSON.stringify(characters))});
sv(K.charP,charP);renderCharPresets();showToast('人物预设已保存');
});
}
function renderCharPresets(){
const l=document.getElementById('charPL');l.innerHTML='';
charP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
const charNames=(p.characters||[]).map(c=>c.name).filter(Boolean).join('、')||'未命名';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(charNames)+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useCharP('+i+')">使用</button><button class="btn-del" onclick="delCharP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useCharP(i){
const p=charP[i];
characters=JSON.parse(JSON.stringify(p.characters||[{name:'',desc:''}]));
sv(K.curChars,characters);
renderCharCards();showToast('已加载人物: '+p.name);
}
function delCharP(i){charP.splice(i,1);sv(K.charP,charP);renderCharPresets();}

// World Presets
function saveWorldPreset(){
showInp('保存世界观预设','为世界观起个名字',name=>{
worldP.push({name,desc:document.getElementById('worldDesc').value,minWords:parseInt(document.getElementById('minWords').value)||800});
sv(K.worldP,worldP);saveCurSettings();renderWorldPresets();showToast('世界观预设已保存');
});
}
function renderWorldPresets(){
const l=document.getElementById('worldPL');l.innerHTML='';
worldP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+'</span><div class="pitem-a"><button class="btn-use" onclick="useWorldP('+i+')">使用</button><button class="btn-del" onclick="delWorldP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useWorldP(i){
const p=worldP[i];
document.getElementById('worldDesc').value=p.desc||'';
document.getElementById('minWords').value=p.minWords||800;
saveCurSettings();showToast('已加载世界观: '+p.name);
}
function delWorldP(i){worldP.splice(i,1);sv(K.worldP,worldP);renderWorldPresets();}
// 文风预设
function saveStylePreset(){
const desc=(document.getElementById('styleDesc').value||'').trim();
if(!desc){showToast('请先填写文风描述');return;}
showInp('保存文风预设','为这个文风起个名字',name=>{
styleP.push({name,desc});
sv('bj_styleP',styleP);renderStylePresets();showToast('文风预设已保存');
});
}
function renderStylePresets(){
const l=document.getElementById('stylePL');if(!l)return;l.innerHTML='';
styleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useStyleP('+i+')">使用</button><button class="btn-del" onclick="delStyleP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useStyleP(i){
const p=styleP[i];
document.getElementById('styleDesc').value=p.desc||'';
ap.curStyle=p.desc;sv(K.ap,ap);
showToast('已加载文风: '+p.name);
}
function delStyleP(i){styleP.splice(i,1);sv('bj_styleP',styleP);renderStylePresets();}
// 规则预设
function saveRulePreset(){
const desc=(document.getElementById('ruleDesc').value||'').trim();
if(!desc){showToast('请先填写规则内容');return;}
showInp('保存规则预设','为这组规则起个名字',name=>{
ruleP.push({name,desc});
sv('bj_ruleP',ruleP);renderRulePresets();showToast('规则预设已保存');
});
}
function renderRulePresets(){
const l=document.getElementById('rulePL');if(!l)return;l.innerHTML='';
ruleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useRuleP('+i+')">使用</button><button class="btn-del" onclick="delRuleP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useRuleP(i){
const p=ruleP[i];
document.getElementById('ruleDesc').value=p.desc||'';
curRule=p.desc||'';sv('bj_curRule',curRule);
showToast('已加载规则: '+p.name);
}
function delRuleP(i){ruleP.splice(i,1);sv('bj_ruleP',ruleP);renderRulePresets();}
// 禁用词预设
function saveBanWordsPreset(){
const desc=(document.getElementById('banWordsInput').value||'').trim();
if(!desc){showToast('请先填写禁用词');return;}
showInp('保存禁用词预设','为这组禁用词起个名字',name=>{
banWordsP.push({name,desc});
sv('bj_banWordsP',banWordsP);renderBanWordsPresets();showToast('禁用词预设已保存');
});
}
function renderBanWordsPresets(){
const l=document.getElementById('banWordsPL');if(!l)return;l.innerHTML='';
banWordsP.forEach((p,i)=>{
const wordCount=(p.desc||'').split('\n').filter(w=>w.trim()).length;
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+wordCount+'个词)</span></span><div class="pitem-a"><button class="btn-use" onclick="useBanWordsP('+i+')">使用</button><button class="btn-del" onclick="delBanWordsP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useBanWordsP(i){
const p=banWordsP[i];
document.getElementById('banWordsInput').value=p.desc||'';
banWords=p.desc||'';sv('bj_banWords',banWords);
showToast('已加载禁用词: '+p.name);
}
function delBanWordsP(i){banWordsP.splice(i,1);sv('bj_banWordsP',banWordsP);renderBanWordsPresets();}
function applyStyleTemplate(name){
const templates={
'轻松日常':'语言轻松自然，像朋友聊天一样亲切。多用短句和口语化表达，节奏明快，适当加入生活化的比喻和小幽默。情绪基调温暖舒适，即使写矛盾也不要太沉重。',
'沉郁文学':'语言凝练克制，有分量感。多用意象和隐喻传递情绪，少用直白的情感词汇。句式可以长而复杂，有思辨性。整体氛围沉静内敛，留白多于铺陈。',
'甜宠言情':'语言甜而不腻，注重细节撩拨。善用心理描写展现暧昧和心动，对话要有来有回的化学反应。节奏上张弛有度，甜蜜中穿插小误会小波折。氛围感要强，注重光线、气味、温度等感官细节。',
'悬疑紧张':'语言简洁有力，信息量大。善用短句制造紧迫感，长句铺垫不安氛围。叙述视角要有限制感，让读者和主角一起发现线索。多用暗示和伏笔，关键信息要藏在日常细节里。',
'古风典雅':'语言典雅含蓄，有古典韵味但不堆砌辞藻。可适当化用诗词意境，但对话要通俗易懂。注重意境营造，善用自然景物映射人物心境。节奏舒缓从容，有留白之美。',
'幽默讽刺':'语言机智犀利，善用反差和夸张制造喜感。叙述者的声音要有个性，像一个毒舌但善良的旁观者。可以打破第四面墙，用现代梗和类比让古老的故事焕发新意。笑中带泪最佳。',
'硬核写实':'语言朴素扎实，不修饰不美化。细节要经得起推敲，涉及专业领域要准确。人物说话要符合身份和教育背景，不要人人都出口成章。情节推进靠逻辑而非巧合，冲突来自真实的利益和立场碰撞。'
};
const desc=templates[name]||'';
document.getElementById('styleDesc').value=desc;
ap.curStyle=desc;sv(K.ap,ap);
showToast('已应用文风: '+name);
}
function renderAllPresets(){renderApiPresets();renderCharPresets();renderWorldPresets();renderStylePresets();renderRulePresets();renderBanWordsPresets();}

// ==================== APPEARANCE ====================
function setTheme(theme,el){
document.body.className='';
if(theme==='light')document.body.classList.add('theme-light');
else if(theme!=='default')document.body.classList.add('theme-'+theme);
document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
el.classList.add('act');
ap.theme=theme;sv(K.ap,ap);
}

function applyAppearance(){
document.body.className='';
if(ap.theme==='light')document.body.classList.add('theme-light');
else if(ap.theme&&ap.theme!=='default')document.body.classList.add('theme-'+ap.theme);

document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
const themeMap={default:'t0',warm:'t1',green:'t2',blue:'t3',light:'t4'};
const target=document.querySelector('.t-opt.'+(themeMap[ap.theme]||'t0'));
if(target)target.classList.add('act');

if(ap.fontUrl){
document.getElementById('customFontUrl').value=ap.fontUrl;
loadFont(ap.fontUrl);
}
}

function loadFont(url){
const existing=document.getElementById('cfStyle');
if(existing)existing.remove();
if(!url)return;
try{
const sanitized=url.replace(/"/g,'%22').replace(/'/g,'%27');
const style=document.createElement('style');
style.id='cfStyle';
style.textContent='@font-face{font-family:"CF";src:url("'+sanitized+'");font-display:swap;}body,.rd-content,.acard-pv,.acard-t,.rd-title{font-family:"CF",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif!important;}';
document.head.appendChild(style);
}catch(e){showToast('字体加载失败');console.warn(e);}
}

document.getElementById('customFontUrl').addEventListener('change',function(){
ap.fontUrl=this.value.trim();sv(K.ap,ap);loadFont(ap.fontUrl);
if(ap.fontUrl)showToast('字体已更新，如无变化请检查链接');
});

function uploadRdBg(e){
const file=e.target.files[0];if(!file)return;
// Compress bg image
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=600;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
ap.rdBg=dataUrl;sv(K.ap,ap);showToast('阅读背景已设置 🎨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function clearRdBg(){
ap.rdBg='';sv(K.ap,ap);
document.getElementById('rdBg').style.display='none';
showToast('阅读背景已清除');
}

// ==================== DATA IMPORT/EXPORT ====================
function exportAllNotes(){
const allNotes={};
const allArticles=[...ws,...cols.books,...cols.shorts];
const ids=[...new Set(allArticles.map(a=>a.id))];
ids.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
if(n.length>0)allNotes[id]=n;
});
return allNotes;
}
function importAllNotes(notesObj){
if(!notesObj||typeof notesObj!=='object')return;
Object.keys(notesObj).forEach(id=>{
if(Array.isArray(notesObj[id])&&notesObj[id].length>0){
sv('bj_notes_'+id,notesObj[id]);
}
});
}
function exportData(){
saveCurSettings();
markBackupDone();// 标记已备份
const data={
_app:'bijiAI',_version:3,_ver:APP_VER,_exportedAt:new Date().toISOString(),
apiPresets:apiP,charPresets:charP,worldPresets:worldP,
stylePresets:styleP,rulePresets:ruleP,curRule:curRule,banWords:banWords,banWordsPresets:banWordsP,
curApi:ld(K.curApi,{}),
curChars:characters,
curWorld:ld(K.curWorld,{}),
collections:cols,workshop:ws,crWorks:crWorks,resPacks:resPacks,tags,appearance:ap,userCard:userCard,notes:exportAllNotes()
};
const jsonStr=JSON.stringify(data,null,2);
const sizeKB=(new Blob([jsonStr]).size/1024).toFixed(1);
const fileName='笔记AI_备份_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';

// 方法1: 尝试使用File System Access API（现代浏览器）
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('数据已保存 ('+sizeKB+'KB) 📤');
}catch(e){
if(e.name!=='AbortError')fallbackExport(jsonStr,fileName);
}
})();
return;
}

// 方法2: 尝试Android WebView的下载方式
if(/android/i.test(navigator.userAgent)){
try{
const blob=new Blob([jsonStr],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('数据已导出，请查看下载目录 📤');
return;
}catch(e){}
}

// 方法3: 通用回退
fallbackExport(jsonStr,fileName);
}

function fallbackExport(jsonStr,fileName){
// 使用data URI方式，兼容性最好
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
showToast('数据已导出 📤');
}

function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI'){showToast('文件格式不正确',3000);return;}
showDlg('导入确认','导入将覆盖当前所有设置和收藏数据，是否继续？',()=>{
if(data.apiPresets){apiP=data.apiPresets;sv(K.apiP,apiP);}
if(data.charPresets){charP=data.charPresets;sv(K.charP,charP);}
if(data.worldPresets){worldP=data.worldPresets;sv(K.worldP,worldP);}
if(data.stylePresets){styleP=data.stylePresets;sv('bj_styleP',styleP);}
if(data.rulePresets){ruleP=data.rulePresets;sv('bj_ruleP',ruleP);}
if(data.curRule){curRule=data.curRule;sv('bj_curRule',curRule);}
if(data.banWords){banWords=data.banWords;sv('bj_banWords',banWords);}
if(data.banWordsPresets){banWordsP=data.banWordsPresets;sv('bj_banWordsP',banWordsP);}
if(data.curApi)sv(K.curApi,data.curApi);
if(data.curChars){characters=data.curChars;sv(K.curChars,characters);}
else if(data.currentChar){
// v1/ compatibility
const cc=data.currentChar;
characters=[{name:cc.aName||'',desc:cc.aDesc||''},{name:cc.bName||'',desc:cc.bDesc||''}];
sv(K.curChars,characters);
}
if(data.curWorld)sv(K.curWorld,data.curWorld);
else if(data.currentWorld)sv(K.curWorld,data.currentWorld);
if(data.collections){
cols=data.collections;
// Ensure fields
if(!cols.books)cols.books=[];
if(!cols.shorts)cols.shorts=[];
cols.books.forEach(b=>{if(!b.status)b.status='ongoing';if(!b.rating)b.rating=0;});
cols.shorts.forEach(s=>{if(!s.rating)s.rating=0;});
sv(K.cols,cols);
}
if(data.tags){tags=data.tags;sv(K.tags,tags);}
if(data.workshop){ws=data.workshop;sv(K.ws,ws);}
if(data.crWorks){crWorks=data.crWorks;sv('bj_crWorks',crWorks);}
if(data.resPacks){resPacks=data.resPacks;sv('bj_resPacks',resPacks);}
if(data.notes)importAllNotes(data.notes);
if(data.userCard){userCard=data.userCard;sv('bj_userCard',userCard);}
if(data.appearance){
ap={...{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2},...data.appearance};
sv(K.ap,ap);
}

// Reload forms
const api=data.curApi||data.currentApi||{};
document.getElementById('apiUrl').value=api.url||'';
document.getElementById('apiKey').value=api.key||'';
document.getElementById('apiModel').value=api.model||'gpt-4o-mini';
document.getElementById('apiTemp').value=api.temp??0.8;
document.getElementById('apiMaxTokens').value=api.maxTokens||4096;

const world=data.curWorld||data.currentWorld||{};
document.getElementById('worldDesc').value=world.desc||'';
document.getElementById('minWords').value=world.minWords||800;

renderTags();renderAllPresets();renderCollections();renderCharCards();
applyAppearance();
showToast('数据导入成功 📥');
});renderUserCard();
}catch(err){showToast('文件解析失败: '+err.message,3000);}
};
reader.readAsText(file);e.target.value='';
}
function deleteWsArticle(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
showDlg('删除文章','确定要从作坊删除「'+article.title+'」吗？',()=>{
ws=ws.filter(a=>a.id!==id);
sv(K.ws,ws);renderArticles();showToast('已删除');
},true);
}
function clearWorkshop(){
const count=ws.length;
if(count===0){showToast('作坊已经是空的');return;}
showDlg('清空作坊（'+count+'篇）','⚠️ 确定要清空作坊中的所有 '+count+' 篇文章吗？\n\n已收藏的文章不受影响，但建议先导出备份！',()=>{
// 二次确认
setTimeout(()=>{
showDlg('再次确认','真的要删除这 '+count+' 篇文章吗？此操作不可恢复！',()=>{
ws=[];sv(K.ws,ws);renderArticles();showToast('作坊已清空');
},true);
},300);
},true);
}

// ==================== CREATE PAGE ====================
function switchCrTab(tab,el){
crTab=tab;
document.querySelectorAll('.cr-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderCrList();
}
function renderCrList(){
const list=document.getElementById('crList');
const filtered=crWorks.filter(w=>w.type===crTab);
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><p>'+(crTab==='draft'?'还没有草稿<br>点击上方「新建草稿」开始写作':'还没有小说<br>点击上方「新建小说」开始连载')+'</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(work=>{
const card=document.createElement('div');
card.className='cr-card';
let preview='';
if(work.type==='draft'){
preview=(work.content||'').replace(/\n/g,' ').substring(0,60);
}else{
const lastCh=work.chapters&&work.chapters.length>0?work.chapters[work.chapters.length-1]:'';
preview=(lastCh||'').replace(/\n/g,' ').substring(0,60);
}
const wc=getCrWordCount(work);
const time=work.updatedAt?new Date(work.updatedAt).toLocaleDateString():'';
const chInfo=work.type==='novel'&&work.chapters?' · '+work.chapters.length+'章':'';
card.innerHTML=
'<div class="cr-card-hd">'+
'<div class="cr-card-t">'+esc(work.title||'无标题')+'</div>'+
'<span class="cr-card-badge '+work.type+'">'+(work.type==='draft'?'草稿':'小说')+'</span>'+
'</div>'+
'<div class="cr-card-pv">'+esc(preview||'暂无内容')+'</div>'+
'<div class="cr-card-ft">'+
'<span class="cr-card-info">'+wc+'字'+chInfo+' · '+time+'</span>'+
'<div class="cr-card-acts">'+
'<button onclick="event.stopPropagation();copyCrWork(\''+work.id+'\')">复制</button>'+
'<button onclick="event.stopPropagation();exportSingleCrWork(\''+work.id+'\')">导出</button>'+ '<button onclick="event.stopPropagation();shareCrToRes(\''+work.id+'\')">分享</button>'+ '<button class="danger" onclick="event.stopPropagation();deleteCrWork(\''+work.id+'\')">删除</button>'+
'</div>'+
'</div>';
card.onclick=e=>{if(!e.target.closest('.cr-card-acts'))openEditor(work.id);};
list.appendChild(card);
});
}
function getCrWordCount(work){
if(work.type==='draft')return countWords(work.content||'');
let total=0;
if(work.chapters)work.chapters.forEach(ch=>total+=countWords(ch));
return total;
}
function newDraft(){
const work={
id:uid(),type:'draft',title:'',content:'',
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
}
function newNovel(){
showInp('新建小说','给小说起个名字',name=>{
const work={
id:uid(),type:'novel',title:name,chapters:[''],
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
});
}
function deleteCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
showDlg('删除确认','确定要删除「'+(work.title||'无标题')+'」吗？不可恢复。',()=>{
crWorks=crWorks.filter(w=>w.id!==id);
sv('bj_crWorks',crWorks);
renderCrList();
showToast('已删除');
},true);
}
function copyCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
let text='';
if(work.type==='draft'){
text=work.content||'';
}else if(work.chapters){
work.chapters.forEach((ch,i)=>{
text+='第'+(i+1)+'章\n\n'+ch+'\n\n';
});
}
const header='════════════════════\n「'+(work.title||'无标题')+'」\n原创作品 · 笔记AI创作页\n════════════════════\n\n';
const footer='\n\n════════════════════\n创作工具：笔记AI '+APP_VER+'\n════════════════════';
doCopy(header+text.trim()+footer);
}

// ==================== EDITOR ====================
// ==================== IMMERSIVE EDIT ====================
let isImmersiveEdit=false;
function toggleImmersiveEdit(){
const modal=document.getElementById('edModal');
isImmersiveEdit=!isImmersiveEdit;
if(isImmersiveEdit){
modal.classList.add('immersive');
document.getElementById('immersiveEditBtn').textContent='☀️ 普通';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('immersive');
document.getElementById('immersiveEditBtn').textContent='🌙 沉浸';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}
function openEditor(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
curEd=work;
curEdCh=0;
document.getElementById('edTitle').value=work.title||'';
if(work.type==='novel'){
document.getElementById('edChBar').style.display='flex';
document.getElementById('edTextarea').value=work.chapters[curEdCh]||'';
renderEdChBar();
}else{
document.getElementById('edChBar').style.display='none';
document.getElementById('edTextarea').value=work.content||'';
}
updateEdWc();
document.getElementById('edSaveStatus').textContent='已保存';
document.getElementById('edOutlineBtn').style.display=(work.outline?'':'none');
document.getElementById('edChOutlineBtn').style.display=(work.type==='novel'?'':'none');
document.getElementById('edModal').classList.add('show');
document.getElementById('bnav').classList.add('hide');
}
function closeEditor(){
saveEditorContent();
document.getElementById('edModal').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
curEd=null;
renderCrList();
}
function renderEdChBar(){
if(!curEd||curEd.type!=='novel')return;
const total=curEd.chapters.length;
document.getElementById('edChCurrent').textContent='第'+(curEdCh+1)+'章 / 共'+total+'章';
document.getElementById('edPrevBtn').style.display=curEdCh>0?'':'none';
document.getElementById('edNextBtn').style.display=curEdCh<total-1?'':'none';
}
function openEdChList(){
if(!curEd||curEd.type!=='novel')return;
saveEditorChapter();
const total=curEd.chapters.length;
let totalWords=0;
curEd.chapters.forEach(ch=>totalWords+=countWords(ch||''));
document.getElementById('edChPanelTitle').textContent='「'+(curEd.title||'未命名')+'」';
document.getElementById('edChPanelInfo').textContent='共 '+total+' 章 · '+totalWords+' 字';
const list=document.getElementById('edChPanelList');
list.innerHTML='';
curEd.chapters.forEach((ch,i)=>{
const wc=countWords(ch||'');
const preview=(ch||'').replace(/\n/g,' ').substring(0,30);
const hasOutline=curEd.chOutlines&&curEd.chOutlines[i];
const item=document.createElement('div');
item.className='ch-item'+(i===curEdCh?' act':'');
item.innerHTML=
'<span class="ch-item-num" style="width:55px;flex-shrink:0">第'+(i+1)+'章</span>'+
'<span style="flex:1;font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(preview||'空白章节')+'</span>'+
'<span class="ch-item-wc" style="flex-shrink:0">'+wc+'字'+(hasOutline?' 📋':'')+'</span>';
item.onclick=()=>{
curEdCh=i;
document.getElementById('edTextarea').value=curEd.chapters[i]||'';
updateEdWc();
renderEdChBar();
closeEdChList();
};
list.appendChild(item);
});
document.getElementById('edChOv').classList.add('show');
}
function closeEdChList(){
document.getElementById('edChOv').classList.remove('show');
}
function goEdPrevCh(){
if(!curEd||curEdCh<=0)return;
saveEditorChapter();
curEdCh--;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function goEdNextCh(){
if(!curEd||curEdCh>=curEd.chapters.length-1)return;
saveEditorChapter();
curEdCh++;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function addEdChapter(){
if(!curEd)return;
saveEditorChapter();
curEd.chapters.push('');
if(!curEd.chOutlines)curEd.chOutlines=[];
curEd.chOutlines.push('');
curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value='';
updateEdWc();
renderEdChBar();
saveEditorContent();
closeEdChList();
showToast('已添加第'+curEd.chapters.length+'章');
}
function saveEditorChapter(){
if(!curEd)return;
const text=document.getElementById('edTextarea').value;
if(curEd.type==='novel'){
if(curEd.chapters[curEdCh]!==undefined)curEd.chapters[curEdCh]=text;
}else{
curEd.content=text;
}
}
function saveEditorContent(){
if(!curEd)return;
saveEditorChapter();
curEd.title=(document.getElementById('edTitle').value||'').trim();
curEd.updatedAt=new Date().toISOString();
const idx=crWorks.findIndex(w=>w.id===curEd.id);
if(idx>-1)crWorks[idx]=curEd;
sv('bj_crWorks',crWorks);
document.getElementById('edSaveStatus').textContent='已保存 ✓';
}
function onEditorInput(){
updateEdWc();
document.getElementById('edSaveStatus').textContent='编辑中...';
if(edAutoSaveTimer)clearTimeout(edAutoSaveTimer);
edAutoSaveTimer=setTimeout(()=>{
saveEditorContent();
},2000);
}
function updateEdWc(){
const text=document.getElementById('edTextarea').value||'';
document.getElementById('edWc').textContent=countWords(text);
}
function copyEditorContent(){
if(!curEd)return;
saveEditorContent();
copyCrWork(curEd.id);
}
function formatEditorText(){
const ta=document.getElementById('edTextarea');
let text=ta.value||'';
// 先把多个连续空行合并成一个
text=text.replace(/\n{3,}/g,'\n\n');
// 把单个换行（没有空行分隔的段落）变成空行分隔
const lines=text.split('\n');
let result=[];
for(let i=0;i<lines.length;i++){
const line=lines[i];
result.push(line);
if(line.trim()&&i+1<lines.length&&lines[i+1].trim()){
result.push('');
}
}
text=result.join('\n');
text=text.replace(/\n{3,}/g,'\n\n');
text=text.trim();
ta.value=text;
onEditorInput();
showToast('排版完成 ¶');
}
// ==================== AI REVIEW ====================
async function requestAIReview(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
saveEditorContent();
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<20){showToast('内容太少，至少写20字再请AI评价');return;}
const body=document.getElementById('aiReviewBody');
body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2)"><span class="ldots"><span></span><span></span><span></span></span><br>AI正在阅读你的作品...</div>';
document.getElementById('aiReviewOv').classList.add('show');
const sysMsg='你是一位资深的文学编辑和写作导师。请对用户提交的文章进行专业评价，包括以下方面：\n1. 整体印象（简短总评）\n2. 亮点（写得好的地方，具体指出）\n3. 可改进之处（具体指出问题并给出修改建议）\n4. 文笔评分（1-10分）\n5. 一句话鼓励\n\n请用温和友善但专业的语气，像一位好老师那样给出建议。不要空泛，要结合文章具体内容来评价。';
const chInfo=curEd.type==='novel'?'（这是第'+(curEdCh+1)+'章）':'';
const userMsg='请评价以下作品'+chInfo+'：\n\n标题：'+(curEd.title||'无标题')+'\n\n正文：\n'+text.substring(0,3000);
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
let reviewText='';
await callAPIStream(messages,
(fullText)=>{
reviewText=fullText;
body.textContent=fullText;
body.scrollTop=body.scrollHeight;
},
(fullText)=>{
if(fullText){
body.textContent=fullText;
}else{
body.innerHTML='<div style="color:var(--text2);text-align:center">评价已取消</div>';
}
},
(errMsg)=>{
body.textContent='获取评价失败：'+errMsg;
}
);
}
function closeAIReview(){
document.getElementById('aiReviewOv').classList.remove('show');
}
function shareCrToRes(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
const wc=getCrWordCount(work);
if(wc<10){showToast('内容太少，至少写10字再分享');return;}
showDlg('分享到资源','将「'+(work.title||'无标题')+'」打包为资源包并导出？',()=>{
const packData=JSON.parse(JSON.stringify(work));
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:(work.title||'无标题')+'_分享',
desc:(work.type==='draft'?'草稿':'小说')+' · '+wc+'字',
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:[{
type:'work',
name:(work.type==='draft'?'草稿':'小说')+'：'+(work.title||'无标题'),
data:packData
}]
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='笔记AI_分享_'+(work.title||'作品')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('作品已导出为资源包 📤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
});
}
// 章节大纲管理
function openChOutline(){
if(!curEd||curEd.type!=='novel')return;
if(!curEd.chOutlines)curEd.chOutlines=[];
const list=document.getElementById('chOutlineList');
list.innerHTML='';
curEd.chapters.forEach((_,i)=>{
const outline=curEd.chOutlines[i]||'';
const preview=(curEd.chapters[i]||'').replace(/\n/g,' ').substring(0,30);
const item=document.createElement('div');
item.className='ch-outline-item';
item.innerHTML=
'<div class="ch-outline-item-hdr"><span>第'+(i+1)+'章</span><span style="font-size:10px;color:var(--text2);font-weight:400">'+esc(preview)+'...</span></div>'+
'<textarea data-ch="'+i+'" placeholder="【必填内容】本章必须出现的事件、人物行为、情绪走向、要埋的伏笔、禁止出现的内容...写得越详细AI越听话">'+esc(outline)+'</textarea>';;
list.appendChild(item);
});
document.getElementById('chOutlineOv').classList.add('show');
}
function closeChOutline(){
document.getElementById('chOutlineOv').classList.remove('show');
}
function saveChOutlines(){
if(!curEd)return;
if(!curEd.chOutlines)curEd.chOutlines=[];
document.querySelectorAll('#chOutlineList textarea').forEach(ta=>{
const ch=parseInt(ta.dataset.ch);
curEd.chOutlines[ch]=ta.value;
});
saveEditorContent();
closeChOutline();
showToast('章节大纲已保存 📋');
}
function deleteEdChapter(){
if(!curEd||curEd.type!=='novel')return;
if(curEd.chapters.length<=1){showToast('至少保留一章');return;}
showDlg('删除章节','确定要删除第'+(curEdCh+1)+'章吗？不可恢复。',()=>{
curEd.chapters.splice(curEdCh,1);
if(curEdCh>=curEd.chapters.length)curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
saveEditorContent();
showToast('已删除');
},true);
}
// ==================== RESOURCE ====================
function switchResTab(tab,el){
resTab=tab;
document.querySelectorAll('.res-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderResList();
}
function renderResList(){
const list=document.getElementById('resList');
let items=[];
resPacks.forEach(pack=>{
if(pack.items&&Array.isArray(pack.items)){
pack.items.forEach(item=>{
item._packName=pack.name||'未命名资源包';
item._packId=pack.id;
items.push(item);
});
}
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
if(items.length===0){
const tips={
all:'还没有资源<br>点击「打包导出」分享你的设定，或「导入资源包」获取别人的',
char:'没有人物设定资源',world:'没有世界观资源',
style:'没有文风资源',rule:'没有规则资源',work:'没有作品资源',exp:'没有经验分享'
};
list.innerHTML='<div class="empty-st"><p>'+(tips[resTab]||tips.all)+'</p></div>';
return;
}
list.innerHTML='';
items.forEach((item,idx)=>{
const card=document.createElement('div');
card.className='res-card';
const typeLabels={char:'人物设定',world:'世界观',style:'文风',rule:'规则',work:'作品',exp:'经验分享'};
const preview=getResPreview(item);
card.innerHTML=
'<div class="res-card-hd">'+
'<div class="res-card-t">'+esc(item.name||'未命名')+'</div>'+
'<span class="res-card-type '+item.type+'">'+(typeLabels[item.type]||'其他')+'</span>'+
'</div>'+
'<div class="res-card-pv">'+esc(preview)+'</div>'+
'<div class="res-card-ft">'+
'<span class="res-card-info">来自：'+esc(item._packName)+'</span>'+
'<div class="res-card-acts">'+
'<button class="use" onclick="event.stopPropagation();applyResItem(\''+item._packId+'\','+idx+')">应用</button>'+
'<button onclick="event.stopPropagation();copyResItem(\''+item._packId+'\','+idx+')">复制</button>'+
'</div>'+
'</div>';
list.appendChild(card);
});
if(resPacks.length>0){
const mgr=document.createElement('div');
mgr.style.cssText='margin-top:16px;padding-top:14px;border-top:1px solid var(--border)';
mgr.innerHTML='<div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px">已导入的资源包</div>';
resPacks.forEach(pack=>{
const pDiv=document.createElement('div');
pDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:7px';
const count=pack.items?pack.items.length:0;
const time=pack.createdAt?new Date(pack.createdAt).toLocaleDateString():'';
pDiv.innerHTML=
'<div><div style="font-size:12px;font-weight:600">'+esc(pack.name||'未命名')+'</div>'+
'<div style="font-size:9px;color:var(--text2);margin-top:2px">'+count+'项资源 · '+time+'</div></div>'+
'<button style="padding:4px 10px;border-radius:7px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:9px;cursor:pointer" onclick="deleteResPack(\''+pack.id+'\')">删除</button>';
mgr.appendChild(pDiv);
});
list.appendChild(mgr);
}
}
function getResPreview(item){
if(item.type==='char'){
const chars=item.data||[];
return chars.map(c=>(c.name||'未命名')+'：'+(c.desc||'').substring(0,30)).join('；');
}
if(item.type==='world')return (item.data||'').substring(0,80);
if(item.type==='style')return (item.data||'').substring(0,80);
if(item.type==='rule')return (item.data||'').substring(0,80);
if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')return (w.content||'').substring(0,80);
if(w.chapters&&w.chapters.length>0)return (w.chapters[0]||'').substring(0,80);
return '暂无内容';
}
if(item.type==='exp')return (item.data||'').substring(0,80);
return '';
}
function applyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
if(item.type==='char'){
showDlg('应用人物设定','将覆盖当前的人物设定，是否继续？',()=>{
characters=JSON.parse(JSON.stringify(item.data||[{name:'',desc:''}]));
sv(K.curChars,characters);
showToast('人物设定已应用 ✅');
});
}else if(item.type==='world'){
showDlg('应用世界观','将覆盖当前的世界观设定，是否继续？',()=>{
document.getElementById('worldDesc').value=item.data||'';
saveCurSettings();
showToast('世界观已应用 ✅');
});
}else if(item.type==='style'){
showDlg('应用文风','将覆盖当前的文风设置，是否继续？',()=>{
document.getElementById('styleDesc').value=item.data||'';
ap.curStyle=item.data||'';
sv(K.ap,ap);
showToast('文风已应用 ✅');
});
}else if(item.type==='rule'){
showDlg('应用规则','将覆盖当前的规则设置，是否继续？',()=>{
document.getElementById('ruleDesc').value=item.data||'';
curRule=item.data||'';
sv('bj_curRule',curRule);
showToast('规则已应用 ✅');
});
}else if(item.type==='work'){
showDlg('导入作品','将添加到你的创作页面，是否继续？',()=>{
const w=JSON.parse(JSON.stringify(item.data));
w.id=uid();
w.createdAt=new Date().toISOString();
w.updatedAt=new Date().toISOString();
crWorks.unshift(w);
sv('bj_crWorks',crWorks);
showToast('作品已导入到创作页 ✅');
});
}else if(item.type==='exp'){
showDlg('查看经验','是否复制这条经验分享到剪贴板？',()=>{
doCopy(item.data||'');
});
}
}
function copyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
let text='';
if(item.type==='char'){
const chars=item.data||[];
text=chars.map(c=>'【'+c.name+'】\n'+c.desc).join('\n\n');
}else if(item.type==='rule'){
text=item.data||'';
}else if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')text=w.content||'';
else if(w.chapters)text=w.chapters.map((ch,i)=>'第'+(i+1)+'章\n\n'+ch).join('\n\n');
}else{
text=item.data||'';
}
doCopy(text);
}

// ==================== RESOURCE EXPORT ====================
function openResExport(){
const box=document.getElementById('resExpList');
box.innerHTML='';
const exportItems=[];
saveCharactersFromUI();
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
exportItems.push({id:'cur_char',type:'char',label:'当前人物设定',desc:validChars.map(c=>c.name).filter(Boolean).join('、')||'未命名角色',data:validChars});
}
charP.forEach((p,i)=>{
exportItems.push({id:'charP_'+i,type:'char',label:'人物预设：'+p.name,desc:(p.characters||[]).map(c=>c.name).filter(Boolean).join('、'),data:p.characters});
});
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD){
exportItems.push({id:'cur_world',type:'world',label:'当前世界观',desc:wD.substring(0,40),data:wD});
}
worldP.forEach((p,i)=>{
exportItems.push({id:'worldP_'+i,type:'world',label:'世界观预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const sD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||'').trim();
if(sD){
exportItems.push({id:'cur_style',type:'style',label:'当前文风',desc:sD.substring(0,40),data:sD});
}
styleP.forEach((p,i)=>{
exportItems.push({id:'styleP_'+i,type:'style',label:'文风预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const rD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||'').trim();
if(rD){
exportItems.push({id:'cur_rule',type:'rule',label:'当前规则',desc:rD.substring(0,40),data:rD});
}
ruleP.forEach((p,i)=>{
exportItems.push({id:'ruleP_'+i,type:'rule',label:'规则预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
crWorks.forEach(w=>{
exportItems.push({id:'work_'+w.id,type:'work',label:(w.type==='draft'?'草稿':'小说')+'：'+(w.title||'无标题'),desc:getCrWordCount(w)+'字',data:w});
});
if(exportItems.length===0){
box.innerHTML='<p style="font-size:12px;color:var(--text2);text-align:center;padding:20px">没有可导出的内容<br>请先在设置中添加人物/世界观/文风，或在创作页写点东西</p>';
document.getElementById('resExpOv').classList.add('show');
return;
}
const typeLabels={char:'👤 人物',world:'🌍 世界观',style:'✒️ 文风',rule:'📜 规则',work:'📄 作品'};
exportItems.forEach(item=>{
const div=document.createElement('div');
div.className='res-chk-item';
div.dataset.resId=item.id;
div.dataset.resType=item.type;
div.dataset.resData=JSON.stringify(item.data);
div.dataset.resLabel=item.label;
div.onclick=()=>{div.classList.toggle('checked');};
div.innerHTML=
'<div class="res-chk-box">✓</div>'+
'<div class="res-chk-info">'+
'<div class="res-chk-name">'+(typeLabels[item.type]||'')+' '+esc(item.label)+'</div>'+
'<div class="res-chk-desc">'+esc(item.desc)+'</div>'+
'</div>';
box.appendChild(div);
});
document.getElementById('resPackName').value='';
document.getElementById('resPackDesc').value='';
document.getElementById('resExpOv').classList.add('show');
}
function closeResExport(){
document.getElementById('resExpOv').classList.remove('show');
}
function doResExport(){
const checked=document.querySelectorAll('#resExpList .res-chk-item.checked');
if(checked.length===0){showToast('请至少选择一项');return;}
const items=[];
checked.forEach(el=>{
items.push({
type:el.dataset.resType,
name:el.dataset.resLabel,
data:JSON.parse(el.dataset.resData)
});
});
const packName=(document.getElementById('resPackName').value||'').trim()||'资源包';
const packDesc=(document.getElementById('resPackDesc').value||'').trim();
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:packName,
desc:packDesc,
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:items
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='笔记AI_资源_'+packName+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
closeResExport();
showToast('资源包已导出 📤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
}
function fallbackResExport(jsonStr,fileName){
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
closeResExport();
showToast('资源包已导出 📤');
}
function writeExpShare(){
document.getElementById('expTitle').value='';
document.getElementById('expContent').value='';
document.getElementById('expOv').classList.add('show');
setTimeout(()=>document.getElementById('expTitle').focus(),100);
}
function closeExpDlg(){
document.getElementById('expOv').classList.remove('show');
}
function saveExpShare(){
const title=(document.getElementById('expTitle').value||'').trim();
const content=(document.getElementById('expContent').value||'').trim();
if(!title){showToast('请输入标题');return;}
if(!content){showToast('请输入内容');return;}
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:title,
desc:'经验分享',
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:[{type:'exp',name:title,data:content}]
};
resPacks.unshift(pack);
sv('bj_resPacks',resPacks);
closeExpDlg();
renderResList();
showToast('经验已保存 ✅');
}
function deleteResPack(id){
const pack=resPacks.find(p=>p.id===id);
if(!pack)return;
showDlg('删除资源包','确定要删除「'+(pack.name||'未命名')+'」吗？',()=>{
resPacks=resPacks.filter(p=>p.id!==id);
sv('bj_resPacks',resPacks);
renderResList();
showToast('资源包已删除');
},true);
}
function importResPack(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI_resource'||!data.items){
showToast('这不是有效的资源包文件',3000);return;
}
const existing=resPacks.findIndex(p=>p.id===data.id);
if(existing>-1){
showDlg('重复资源包','已存在同名资源包「'+(data.name||'')+'」，是否覆盖？',()=>{
resPacks[existing]=data;
sv('bj_resPacks',resPacks);
renderResList();
showToast('资源包已更新 📥');
});
}else{
resPacks.unshift(data);
sv('bj_resPacks',resPacks);
renderResList();
const count=data.items.length;
showToast('已导入「'+(data.name||'资源包')+'」('+count+'项) 📥');
}
}catch(err){showToast('文件解析失败: '+err.message,3000);}
};
reader.readAsText(file);
e.target.value='';
}
// ==================== HANDBOOK ====================
function openHandbook(){
document.getElementById('hbOv').classList.add('show');
}
function closeHandbook(){
document.getElementById('hbOv').classList.remove('show');
}
// ==================== USER CARD ====================
function renderUserCard(){
const uc=userCard;
const nameEl=document.getElementById('ucName');
const bioEl=document.getElementById('ucBio');
const avatarEl=document.getElementById('ucAvatar');
nameEl.textContent=uc.name||'点击设置昵称';
bioEl.textContent=uc.bio||'点击添加个人简介...';
if(uc.avatar){
avatarEl.innerHTML='<img src="'+uc.avatar+'" alt="头像"><div class="ucard-avatar-hint">更换</div>';
}else{
avatarEl.innerHTML='<span id="ucAvatarPh">✦</span><div class="ucard-avatar-hint">更换</div>';
}
updateStats();
}
function getStorageUsage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total;
}

function getStorageUsage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total;
}

function checkStorageHealth(){
const used=getStorageUsage();
const usedMB=(used/1024/1024).toFixed(2);
const percent=(used/(5*1024*1024)*100).toFixed(1);
if(percent>80){
showToast('⚠️ 存储已用'+percent+'%，建议导出备份',4000);
}
return {used,usedMB,percent};
}

function updateStats(){
let totalWords=0;
let worksCount=0;
// 作坊文章
ws.forEach(a=>{totalWords+=getTotalWords(a);});
worksCount+=ws.length;
// 创作作品
crWorks.forEach(w=>{totalWords+=getCrWordCount(w);});
worksCount+=crWorks.length;
// 收藏里独有的（不在作坊里的）
cols.books.forEach(b=>{
if(!ws.find(a=>a.id===b.id))totalWords+=getTotalWords(b);
});
cols.shorts.forEach(s=>{
if(!ws.find(a=>a.id===s.id))totalWords+=getTotalWords(s);
});
const colsCount=cols.books.length+cols.shorts.length;
// 笔记总数
let notesCount=0;
const allIds=new Set();
[...ws,...cols.books,...cols.shorts].forEach(a=>allIds.add(a.id));
allIds.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
notesCount+=n.length;
});
document.getElementById('statTotal').textContent=formatNum(totalWords);
document.getElementById('statWorks').textContent=worksCount;
document.getElementById('statCols').textContent=colsCount;
document.getElementById('statNotes').textContent=notesCount;
}
async function updateStorageDisplay(){
    try{
        const info = await getDBStorageUsage();
        document.getElementById('storagePercent').textContent = info.percent + '%';
        document.getElementById('storageBar').style.width = Math.min(info.percent, 100) + '%';
        document.getElementById('storageDetail').textContent = '已用 ' + info.usedMB + 'MB / 50MB (IndexedDB)';
        // 根据使用量变色
        const bar = document.getElementById('storageBar');
        if (info.percent > 90) bar.style.background = 'var(--danger)';
        else if (info.percent > 70) bar.style.background = '#f0a030';
        else bar.style.background = 'linear-gradient(90deg,var(--accent),var(--accent2))';
    } catch(e) {
        console.warn('存储信息获取失败:', e);
    }
}
function formatNum(n){
if(n>=10000)return (n/10000).toFixed(1)+'万';
if(n>=1000)return (n/1000).toFixed(1)+'k';
return n;
}
function uploadAvatar(){
document.getElementById('avatarUp').click();
}
function handleAvatarUpload(e){
const file=e.target.files[0];
if(!file)return;
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const size=120;
canvas.width=size;canvas.height=size;
const ctx=canvas.getContext('2d');
const min=Math.min(img.width,img.height);
const sx=(img.width-min)/2;
const sy=(img.height-min)/2;
ctx.drawImage(img,sx,sy,min,min,0,0,size,size);
const dataUrl=canvas.toDataURL('image/jpeg',0.8);
userCard.avatar=dataUrl;
sv('bj_userCard',userCard);
renderUserCard();
showToast('头像已更新 🎨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}
function editUcName(){
showInp('设置昵称','输入你的昵称',name=>{
userCard.name=name;
sv('bj_userCard',userCard);
renderUserCard();
showToast('昵称已更新');
});
}
function editUcBio(){
const ov=document.getElementById('inpOv');
document.getElementById('inpTitle').textContent='编辑简介';
const f=document.getElementById('inpField');
f.placeholder='写一句话介绍自己...';
f.value=userCard.bio||'';
document.getElementById('inpOkBtn').onclick=()=>{
userCard.bio=f.value.trim();
sv('bj_userCard',userCard);
closeInp();
renderUserCard();
showToast('简介已更新');
};
ov.classList.add('show');
setTimeout(()=>f.focus(),100);
}
// ==================== OUTLINE GENERATOR ====================
let outlineChCount=10;
let outlineText='';
function openOutlineGen(){
document.getElementById('outlineTitle').value='';
document.getElementById('outlineDesc').value='';
document.getElementById('outlineResult').style.display='none';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineGenBtn').style.display='';
document.getElementById('outlineGenBtn').disabled=false;
document.getElementById('outlineGenBtn').textContent='🧠 生成大纲';
outlineText='';
document.getElementById('outlineOv').classList.add('show');
setTimeout(()=>document.getElementById('outlineDesc').focus(),200);
}
function closeOutlineGen(){
document.getElementById('outlineOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
function setOutlineCh(n,el){
outlineChCount=n;
el.parentElement.querySelectorAll('.tag').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}
async function doGenOutline(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const desc=(document.getElementById('outlineDesc').value||'').trim();
const title=(document.getElementById('outlineTitle').value||'').trim();
if(!desc){showToast('请描述一下你想写的故事');return;}
const btn=document.getElementById('outlineGenBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('outlineResult').style.display='block';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineContent').textContent='正在构思大纲...';
let sysMsg='你是一位专业的小说策划编辑，擅长构建故事架构和章节大纲。\n';
sysMsg+='请根据用户的描述，生成一份详细的小说大纲。\n\n';
sysMsg+='【输出格式要求】\n';
sysMsg+='第一行：小说标题（纯文字）\n';
sysMsg+='第二行：空行\n';
sysMsg+='第三行：一句话故事简介\n';
sysMsg+='第四行：空行\n';
sysMsg+='然后逐章列出大纲，格式如下：\n';
sysMsg+='第X章：章节标题\n';
sysMsg+='- 本章概要（2-3句话描述本章主要内容、关键事件、情感转折）\n\n';
sysMsg+='要求：\n';
sysMsg+='- 共'+outlineChCount+'章\n';
sysMsg+='- 故事线要完整（开端→发展→高潮→结局）\n';
sysMsg+='- 每章之间要有因果关系和递进\n';
sysMsg+='- 注意伏笔和悬念的设置\n';
sysMsg+='- 不要输出任何多余内容\n';
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
sysMsg+='\n【可用角色】\n';
validChars.forEach((c,i)=>{
sysMsg+='角色'+(i+1)+'：'+(c.name||'未命名');
if(c.desc)sysMsg+='（'+c.desc.substring(0,60)+'）';
sysMsg+='\n';
});
}
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD)sysMsg+='\n【世界观】\n'+wD.substring(0,300)+'\n';
let userMsg='请为以下故事生成'+outlineChCount+'章的详细大纲：\n\n';
if(title)userMsg+='标题方向：'+title+'\n';
userMsg+='故事描述：'+desc;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const contentEl=document.getElementById('outlineContent');
outlineText='';
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outlineText=fullText;
contentEl.textContent=fullText;
contentEl.parentElement.scrollTop=contentEl.parentElement.scrollHeight;
},
(fullText)=>{
btn.disabled=false;btn.textContent='🧠 生成大纲';
if(fullText){
outlineText=fullText;
contentEl.textContent=fullText;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='生成已取消';
}
},
(errMsg)=>{
btn.disabled=false;btn.textContent='🧠 生成大纲';
contentEl.textContent='生成失败：'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;btn.textContent='🧠 生成大纲';
if(result){
outlineText=result;
contentEl.textContent=result;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='生成失败，请检查API设置';
}
}
}
function applyOutline(){
if(!outlineText){showToast('没有大纲内容');return;}
let title='';
const lines=outlineText.split('\n');
for(let i=0;i<Math.min(3,lines.length);i++){
const l=lines[i].trim();
if(l&&l.length<40&&!l.startsWith('-')&&!l.startsWith('第')){
title=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
break;
}
}
const inputTitle=(document.getElementById('outlineTitle').value||'').trim();
if(inputTitle)title=inputTitle;
if(!title)title='未命名小说';
const work={
id:uid(),type:'novel',title:title,
chapters:[''],
outline:outlineText,
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
closeOutlineGen();
openEditor(work.id);
showToast('小说已创建，大纲已保存 📋');
}
// ==================== AI REWRITE ====================
async function aiRewriteChapter(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<10){showToast('当前章节内容太少，至少10字才能重写');return;}
showDlg('AI重写确认','AI将重新改写当前章节内容，原内容会被替换。是否继续？',async()=>{
const ta=document.getElementById('edTextarea');
const statusEl=document.getElementById('edSaveStatus');
statusEl.textContent='AI重写中...';
ta.disabled=true;
let sysMsg='你是一位经验丰富的文学编辑兼改稿人。你的工作是将一篇有潜力但粗糙的初稿，打磨成一篇让人读了会起鸡皮疙瘩的好文章。\n\n';
sysMsg+='你的改稿原则：\n';
sysMsg+='1. 剧情骨架不动——保留所有关键事件、人物关系、情节走向\n';
sysMsg+='2. 血肉全部重塑——每一句话都用更精准、更有画面感的方式重新表达\n';
sysMsg+='3. 补充原文缺失的：感官细节（气味、触感、声音）、微表情、环境氛围、潜台词\n';
sysMsg+='4. 修复原文的问题：删除空洞形容词、消灭万能副词、打破重复句式、让对话更口语化\n';
sysMsg+='5. 提升节奏感：紧张处加速（短句、断句），舒缓处减速（长句、细描）\n';
sysMsg+='6. 字数应不少于原文，因为好的改写通常会更丰满\n';
sysMsg+='7. 直接输出改写后的正文，不加任何说明、标题、章节号、markdown格式\n';
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【文风要求】'+styleD+'\n';
const chInfo=curEd.type==='novel'?'这是「'+(curEd.title||'')+'」的第'+(curEdCh+1)+'章。':'';
let contextInfo='';
if(curEd.type==='novel'&&curEd.chapters&&curEdCh>0){
const prevCh=curEd.chapters[curEdCh-1]||'';
if(prevCh)contextInfo='\n\n【上一章结尾参考】\n'+prevCh.substring(prevCh.length-300)+'\n';
}
let outlineInfo='';
if(curEd.outline){
outlineInfo='\n\n【小说大纲参考】\n'+curEd.outline.substring(0,500)+'\n';
}
const userMsg=chInfo+contextInfo+outlineInfo+'\n\n请重写以下章节内容：\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
if(useStream){
await callAPIStream(messages,
(fullText)=>{
ta.value=fullText;
updateEdWc();
},
(fullText)=>{
ta.disabled=false;
if(fullText){
ta.value=fullText;
updateEdWc();
saveEditorContent();
statusEl.textContent='重写完成 ✓';
showToast('章节已重写 ✨');
}else{
statusEl.textContent='重写已取消';
}
},
(errMsg)=>{
ta.disabled=false;
statusEl.textContent='重写失败';
showToast('重写失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
ta.disabled=false;
if(result){
ta.value=result;
updateEdWc();
saveEditorContent();
statusEl.textContent='重写完成 ✓';
showToast('章节已重写 ✨');
}else{
statusEl.textContent='重写失败';
}
}
});
}
// AI扩写/缩写
let expandMode='expand';// expand or shrink
function openAiExpand(){
if(!curEd){showToast('请先打开一篇文章');return;}
expandMode='expand';
document.getElementById('expandTitle').textContent='📈 AI扩写';
document.getElementById('expandDesc').textContent='选择或粘贴要扩写的段落，AI会添加更多细节、感官描写、心理活动等';
document.getElementById('expandDoBtn').textContent='🚀 开始扩写';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function openAiShrink(){
if(!curEd){showToast('请先打开一篇文章');return;}
expandMode='shrink';
document.getElementById('expandTitle').textContent='📉 AI缩写';
document.getElementById('expandDesc').textContent='选择或粘贴要缩写的段落，AI会精简内容、保留核心信息';
document.getElementById('expandDoBtn').textContent='🚀 开始缩写';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function closeExpandOv(){
document.getElementById('expandOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
async function doExpand(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const input=(document.getElementById('expandInput').value||'').trim();
if(!input){showToast('请输入要处理的内容');return;}
if(countWords(input)<5){showToast('内容太少，至少5个字');return;}
const hint=(document.getElementById('expandHint').value||'').trim();
const btn=document.getElementById('expandDoBtn');
btn.disabled=true;
btn.innerHTML='处理中 <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('expandResult').style.display='block';
document.getElementById('expandOutput').value='正在处理...';
let sysMsg='';
if(expandMode==='expand'){
sysMsg='你是一位专业的文学润色师，擅长扩写文章段落。\n\n';
sysMsg+='【扩写原则】\n';
sysMsg+='1. 保持原文的核心情节和人物关系不变\n';
sysMsg+='2. 增加感官细节（视觉、听觉、触觉、嗅觉、味觉）\n';
sysMsg+='3. 丰富人物的微表情、小动作、心理活动\n';
sysMsg+='4. 补充环境氛围描写\n';
sysMsg+='5. 让对话更自然，可以加入停顿、语气词\n';
sysMsg+='6. 扩写后字数应为原文的1.5-2.5倍\n';
sysMsg+='7. 直接输出扩写后的内容，不加任何说明\n';
}else{
sysMsg='你是一位专业的文学编辑，擅长精简文章。\n\n';
sysMsg+='【缩写原则】\n';
sysMsg+='1. 保留核心情节和关键信息\n';
sysMsg+='2. 删除冗余的形容词和副词\n';
sysMsg+='3. 合并重复表达的内容\n';
sysMsg+='4. 简化过长的对话，保留关键台词\n';
sysMsg+='5. 去掉不影响理解的环境描写\n';
sysMsg+='6. 缩写后字数应为原文的40%-70%\n';
sysMsg+='7. 直接输出缩写后的内容，不加任何说明\n';
}
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【保持文风】\n'+styleD+'\n';
let userMsg=expandMode==='expand'?'请扩写以下段落：\n\n':'请缩写以下段落：\n\n';
userMsg+=input;
if(hint)userMsg+='\n\n【特别要求】'+hint;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const outputEl=document.getElementById('expandOutput');
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outputEl.value=fullText;
},
(fullText)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
if(fullText){
outputEl.value=fullText;
const oldWc=countWords(input);
const newWc=countWords(fullText);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'扩写':'缩写')+'完成！原文'+oldWc+'字→'+newWc+'字('+ratio+'%)');
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
outputEl.value='处理失败：'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
if(result){
outputEl.value=result;
const oldWc=countWords(input);
const newWc=countWords(result);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'扩写':'缩写')+'完成！原文'+oldWc+'字→'+newWc+'字('+ratio+'%)');
}else{
outputEl.value='处理失败，请检查API设置';
}
}
}
// 导出TXT文件
function exportToTxtFile(filename,content){
const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:filename,
types:[{description:'文本文件',accept:{'text/plain':['.txt']}}]
});
const writable=await handle.createWritable();
await writable.write(blob);
await writable.close();
showToast('文件已保存 📥');
}catch(e){
if(e.name!=='AbortError')fallbackTxtExport(filename,blob);
}
})();
return;
}
fallbackTxtExport(filename,blob);
}
function fallbackTxtExport(filename,blob){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=filename;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('文件已导出 📥');
}
function buildTxtContent(title,chapters,isAI){
let content='';
if(isAI){
content+='════════════════════════════════════════\n';
content+='　　　　　　「'+title+'」\n';
content+='════════════════════════════════════════\n\n';
content+='【声明】\n';
content+='本文由「笔记AI」辅助创作生成\n';
content+='创作工具：笔记AI · AI创作工坊\n';
content+='工具作者：心田\n';
content+='导出时间：'+new Date().toLocaleString()+'\n\n';
content+='【AI创作提示】\n';
content+='本文内容由AI辅助生成，仅供参考和娱乐。\n';
content+='AI生成的内容可能存在事实错误或不当表述，\n';
content+='请读者自行甄别，切勿作为专业依据。\n';
content+='如需转载或发布，请注明AI辅助创作。\n\n';
content+='════════════════════════════════════════\n';
content+='　　　　　　　正　文　开　始\n';
content+='════════════════════════════════════════\n\n\n';
}else{
content+='════════════════════════════════════════\n';
content+='　　　　　　「'+title+'」\n';
content+='════════════════════════════════════════\n\n';
content+='导出时间：'+new Date().toLocaleString()+'\n';
content+='创作工具：笔记AI\n\n';
content+='════════════════════════════════════════\n\n\n';
}
// 正文
if(Array.isArray(chapters)){
chapters.forEach((ch,i)=>{
content+='【第'+(i+1)+'章】\n\n';
content+=(ch||'').trim()+'\n\n\n';
});
}else{
content+=(chapters||'').trim()+'\n\n';
}
// 结尾
if(isAI){
content+='\n════════════════════════════════════════\n';
content+='　　　　　　　正　文　结　束\n';
content+='════════════════════════════════════════\n\n';
content+='【关于笔记AI】\n';
content+='笔记AI是一款基于大语言模型的AI创作工坊，\n';
content+='帮助创作者快速生成高质量的小说、散文等文学作品。\n\n';
content+='功能特色：\n';
content+='· 长篇连载 & 短篇一发\n';
content+='· 自定义人物、世界观、文风、规则\n';
content+='· AI续写、扩写、缩写、重写\n';
content+='· 章节大纲管理\n';
content+='· 多主题界面美化\n\n';
content+='工具作者：心田\n';
content+='联系方式：\n';
content+='· 小红书：95567118758\n';
content+='· 小红书：27418565861\n';
content+='· 微信：Aa9620520\n';
content+='· QQ：962005530\n\n';
content+='════════════════════════════════════════\n';
content+='感谢使用笔记AI，祝创作愉快！\n';
content+='════════════════════════════════════════\n';
}else{
content+='\n════════════════════════════════════════\n';
content+='导出自：笔记AI · 创作工具\n';
content+='════════════════════════════════════════\n';
}
return content;
}
// 从创作页导出
function exportCrToTxt(){
if(crWorks.length===0){showToast('没有可导出的作品');return;}
// 如果只有一个作品，直接导出
if(crWorks.length===1){
const w=crWorks[0];
doExportWork(w,false);
return;
}
// 多个作品，让用户选择
const items=crWorks.map((w,i)=>({
id:w.id,
label:(w.type==='draft'?'[草稿] ':'[小说] ')+(w.title||'无标题'),
wc:getCrWordCount(w)
}));
showSelectDlg('选择要导出的作品',items,(id)=>{
const w=crWorks.find(x=>x.id===id);
if(w)doExportWork(w,false);
});
}
// 从编辑器导出
function exportEdToTxt(){
if(!curEd){showToast('没有打开的作品');return;}
saveEditorContent();
doExportWork(curEd,false);
}
// 从收藏导出
function exportBookToTxt(id){
const book=cols.books.find(b=>b.id===id);
if(!book){showToast('找不到该书籍');return;}
doExportWork(book,true);
}
// 执行导出
function exportSingleCrWork(id){
const w=crWorks.find(x=>x.id===id);
if(!w){showToast('找不到该作品');return;}
doExportWork(w,false);
}
function doExportWork(work,isAI){
const title=work.title||'未命名';
let chapters;
if(work.type==='novel'||work.chapters){
chapters=work.chapters||[];
}else{
chapters=work.content||'';
}
const content=buildTxtContent(title,chapters,isAI);
const filename=title.replace(/[\\/:*?"<>|]/g,'_')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.txt';
exportToTxtFile(filename,content);
}
// 选择弹窗
function showSelectDlg(title,items,onSelect){
document.getElementById('dlgTitle').textContent=title;
const listHtml=items.map(it=>
'<div style="padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:9px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center" onclick="selectDlgItem(\''+it.id+'\')">'+
'<span style="font-size:12px">'+esc(it.label)+'</span>'+
'<span style="font-size:10px;color:var(--text2)">'+it.wc+'字</span>'+
'</div>'
).join('');
document.getElementById('dlgMsg').innerHTML=listHtml;
document.getElementById('dlgOkBtn').style.display='none';
window._selectDlgCallback=onSelect;
document.getElementById('dlgOv').classList.add('show');
}
function selectDlgItem(id){
closeDlg();
document.getElementById('dlgOkBtn').style.display='';
if(window._selectDlgCallback){
window._selectDlgCallback(id);
window._selectDlgCallback=null;
}
}
function copyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text){showToast('没有内容可复制');return;}
doCopy(text);
}
function applyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text||text.startsWith('处理失败')||text==='正在处理...'){showToast('没有有效结果');return;}
const ta=document.getElementById('edTextarea');
const original=document.getElementById('expandInput').value;
// 尝试替换原文
const currentText=ta.value;
if(currentText.includes(original)){
ta.value=currentText.replace(original,text);
onEditorInput();
closeExpandOv();
showToast('已替换原文 ✅');
}else{
// 原文不在当前章节，追加到末尾
showDlg('无法定位原文','原文不在当前章节中，是否将结果追加到章节末尾？',()=>{
ta.value=currentText+'\n\n'+text;
onEditorInput();
closeExpandOv();
showToast('已追加到末尾 ✅');
});
}
}
function setTempPreset(temp,name){
document.getElementById('apiTemp').value=temp;
document.getElementById('quickTemp').value=temp;
document.getElementById('qtVal').textContent=temp;
showToast('已切换为「'+name+'」模式 (T='+temp+')');
}
function toggleStreamSwitch(el){
const cb=document.getElementById('streamOn');
cb.checked=!cb.checked;
useStream=cb.checked;
sv('bj_stream',useStream);
updateStreamUI();
showToast(useStream?'已开启流式输出':'已关闭流式输出');
}
function updateStreamUI(){
const track=document.getElementById('streamTrack');
const thumb=document.getElementById('streamThumb');
if(useStream){
track.style.background='var(--accent)';
thumb.style.left='22px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}
function openInspiration(){
const subjects=[
'一个失明的画家','一个能听到亡者声音的殡葬师','一个记忆只有七天的侦探',
'一个永远无法说谎的律师','一个能闻到情绪的调香师','一个害怕水的灯塔守护人',
'一个只在雨天出现的快递员','一个能看到红线的月老实习生','一个不会做梦的心理医生',
'一个被诅咒永远清醒的失眠者','一个能和动物交谈的兽医','一个每天都会死一次的不死者',
'一个收集遗言的邮差','一个能触摸到声音的聋人','一个影子会自己行动的普通人',
'一个只能在镜子里看到未来的占卜师','一个血液是墨水的作家','一个能尝出谎言味道的厨师',
'双胞胎中被遗忘的那一个','一个退休的时间旅行者','一个以贩卖记忆为生的商人'
];
const events=[
'在一个永远下雪的城市里发现了一封来自自己的信',
'在深夜的地铁站遇到了一个不该存在的人',
'收到了一份来自十年后的包裹',
'在旧公寓的墙壁里发现了一个通往别处的门',
'在暴风雨的夜晚接到了一个已经去世之人的电话',
'发现自己每天醒来都在不同人的身体里',
'在跳蚤市场买到了一本记录着自己一生的书',
'在一场大雾中走进了一个地图上不存在的小镇',
'发现镜子里的自己开始做出不同的动作',
'在一棵古树的树洞里发现了一百年前写给自己的情书',
'被一个陌生人递了一把钥匙，说"你知道该打开什么"',
'在医院醒来，所有人都说自己已经消失了三年',
'发现自己养的猫每天凌晨三点都会变成人形',
'在一场葬礼上认出了棺材里的人是自己',
'收到一张只写了经纬度的明信片，到达后发现了不可思议的东西'
];
const twists=[
'但真相远比想象的更令人心碎','而这一切的背后藏着一个关于救赎的秘密',
'却发现这只是更大谜团的开始','而代价是失去最珍贵的记忆',
'但每一次选择都通向同一个结局','而唯一的线索指向了自己最信任的人',
'却在最后发现，一切都是自己亲手造成的','但时间已经所剩无几',
'而这个世界的规则正在悄悄改变','却不知道有人一直在暗中守护着这一切',
'但回忆和现实之间的界限开始模糊','而终点竟然是一切开始的地方'
];
const s=subjects[Math.floor(Math.random()*subjects.length)];
const e=events[Math.floor(Math.random()*events.length)];
const useTwist=Math.random()>0.4;
const t=useTwist?twists[Math.floor(Math.random()*twists.length)]:'';
const prompt=s+'，'+e+(t?'——'+t:'');
document.getElementById('searchInput').value=prompt;
const wsBtn=document.querySelector('.bnav-i');
switchPage('workshop',wsBtn);
showToast('💡 灵感已注入');
}
// ==================== NAME GENERATOR ====================
let nameGenType='char';
let nameGenStyle='';

function openNameGen(){
document.getElementById('nameGenDesc').value='';
document.getElementById('nameGenResult').style.display='none';
document.getElementById('nameGenBtn').disabled=false;
document.getElementById('nameGenBtn').textContent='✨ 生成名字';
nameGenType='char';
nameGenStyle='';
document.getElementById('nameTypeChar').classList.add('act');
document.getElementById('nameTypeBook').classList.remove('act');
document.getElementById('nameTypePlace').classList.remove('act');
document.querySelectorAll('#nameGenOv .tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
document.getElementById('nameGenOv').classList.add('show');
setTimeout(()=>document.getElementById('nameGenDesc').focus(),200);
}

function closeNameGen(){
document.getElementById('nameGenOv').classList.remove('show');
}

function setNameType(type){
nameGenType=type;
document.getElementById('nameTypeChar').classList.toggle('act',type==='char');
document.getElementById('nameTypeBook').classList.toggle('act',type==='book');
document.getElementById('nameTypePlace').classList.toggle('act',type==='place');
}

function setNameStyle(style,el){
nameGenStyle=style;
const parent=el.parentElement;
parent.querySelectorAll('.tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
el.classList.add('act');
}

async function doGenNames(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

const desc=(document.getElementById('nameGenDesc').value||'').trim();
const btn=document.getElementById('nameGenBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';

// 构建上下文
let context='';
if(!desc){
// 使用当前设置
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0&&nameGenType==='char'){
context+='当前人物设定：\n';
validChars.forEach(c=>{
if(c.desc)context+=c.desc.substring(0,100)+'\n';
});
}
const wD=(document.getElementById('worldDesc')&&document.getElementById('worldDesc').value||'').trim();
if(wD)context+='世界观：'+wD.substring(0,200)+'\n';
}else{
context=desc;
}

const typeLabels={char:'人名',book:'书名/小说名',place:'地名/场所名'};
const typeHints={
char:'要求：名字要有寓意或特色，符合角色身份，朗朗上口，避免生僻字',
book:'要求：书名要有吸引力，能体现故事核心，让人想点进去看',
place:'要求：地名要有画面感，符合世界观设定，便于记忆'
};

let sysMsg='你是一位专业的命名师，擅长为小说创作各种名字。\n';
sysMsg+='请根据用户提供的信息，生成5个不同风格的'+typeLabels[nameGenType]+'。\n\n';
sysMsg+='【输出格式】严格按以下格式，每行一个：\n';
sysMsg+='1. 名字 - 简短寓意说明（10字以内）\n';
sysMsg+='2. 名字 - 简短寓意说明\n';
sysMsg+='...以此类推，共5个\n\n';
sysMsg+='【'+typeHints[nameGenType]+'】\n';
sysMsg+='不要输出任何多余内容，只输出5行名字。\n';

let userMsg='请生成5个'+typeLabels[nameGenType]+'。\n\n';
if(nameGenStyle)userMsg+='风格要求：'+nameGenStyle+'风格\n';
if(context)userMsg+='参考信息：\n'+context;
else userMsg+='自由发挥，生成有特色的名字';

const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const resultDiv=document.getElementById('nameGenResult');
const listDiv=document.getElementById('nameGenList');

if(useStream){
let fullText='';
await callAPIStream(messages,
(text)=>{
fullText=text;
resultDiv.style.display='block';
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
},
(text)=>{
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(text){
parseAndShowNames(text);
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent='✨ 生成名字';
showToast('生成失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(result){
resultDiv.style.display='block';
parseAndShowNames(result);
}else{
showToast('生成失败，请检查API设置');
}
}
}

function parseAndShowNames(text){
const listDiv=document.getElementById('nameGenList');
listDiv.innerHTML='';

const lines=text.split('\n').filter(l=>l.trim());
lines.forEach(line=>{
const cleaned=line.replace(/^\d+[\.\、\)\]\s]*/,'').trim();
if(!cleaned)return;

const item=document.createElement('div');
item.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--card);border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .2s';
item.onmouseenter=()=>{item.style.borderColor='var(--accent)';item.style.background='rgba(108,92,231,.08)';};
item.onmouseleave=()=>{item.style.borderColor='var(--border)';item.style.background='var(--card)';};

// 分离名字和说明
let name=cleaned;
let hint='';
const sepIdx=cleaned.search(/[\-\—\–\:：]/);
if(sepIdx>0){
name=cleaned.substring(0,sepIdx).trim();
hint=cleaned.substring(sepIdx+1).trim();
}

item.innerHTML=
'<div style="flex:1">'+
'<div style="font-size:14px;font-weight:600;color:var(--text)">'+esc(name)+'</div>'+
(hint?'<div style="font-size:10px;color:var(--text2);margin-top:2px">'+esc(hint)+'</div>':'')+
'</div>'+
'<button style="padding:4px 10px;border-radius:6px;border:1px solid var(--accent);background:transparent;color:var(--accent2);font-size:10px;cursor:pointer;flex-shrink:0" onclick="event.stopPropagation();copyName(\''+esc(name.replace(/'/g,"\\'"))+'\')">复制</button>';

item.onclick=()=>copyName(name);
listDiv.appendChild(item);
});

if(listDiv.children.length===0){
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
}
}

function copyName(name){
doCopy(name);
showToast('已复制：'+name+' 📋');
}
// ==================== AUTO BACKUP ====================
function autoBackup(){
const lastBackup=localStorage.getItem('bj_lastBackup');
const now=Date.now();
const oneWeek=7*24*60*60*1000;
if(!lastBackup||now-parseInt(lastBackup)>oneWeek){
// 超过一周没备份，提醒用户
const usage=getStorageUsage();
if(usage>1024*1024){// 超过1MB数据才提醒
setTimeout(()=>{
showToast('💾 已有一周未备份，建议导出数据',4000);
},3000);
}
}
}

function markBackupDone(){
localStorage.setItem('bj_lastBackup',Date.now().toString());
}
// ==================== TTS 语音朗读 ====================
let ttsUtterance=null;
let ttsPlaying=false;
let ttsPaused=false;
let ttsParas=[];
let ttsCurrentPara=0;
let ttsSettings_=ld('bj_ttsSettings',{voiceURI:'',rate:1,pitch:1});

function initTtsVoices(){
const select=document.getElementById('ttsVoiceSelect');
if(!select)return;
if(typeof speechSynthesis==='undefined'||!speechSynthesis)return;
let voices=[];
try{voices=speechSynthesis.getVoices();}catch(e){return;}
select.innerHTML='';
const cnVoices=voices.filter(v=>v.lang.includes('zh')||v.lang.includes('CN'));
const otherVoices=voices.filter(v=>!v.lang.includes('zh')&&!v.lang.includes('CN'));
const sorted=[...cnVoices,...otherVoices];
sorted.forEach(v=>{
const opt=document.createElement('option');
opt.value=v.voiceURI;
opt.textContent=v.name+(v.lang?' ('+v.lang+')':'');
if(v.voiceURI===ttsSettings_.voiceURI)opt.selected=true;
select.appendChild(opt);
});
if(!ttsSettings_.voiceURI&&cnVoices.length>0){
select.value=cnVoices[0].voiceURI;
}
}

function toggleTtsBar(){
const bar=document.getElementById('ttsBar');
bar.classList.toggle('show');
if(bar.classList.contains('show')){
initTtsVoices();
loadTtsParas();
document.getElementById('ttsRate').value=ttsSettings_.rate;
document.getElementById('ttsRateVal').textContent=ttsSettings_.rate.toFixed(1);
document.getElementById('ttsPitch').value=ttsSettings_.pitch;
document.getElementById('ttsPitchVal').textContent=ttsSettings_.pitch.toFixed(1);
}else{
ttsStop();
}
}

function toggleTtsSettings(){
document.getElementById('ttsSettings').classList.toggle('show');
}

function loadTtsParas(){
const content=document.getElementById('rdContent');
if(!content)return;
ttsParas=Array.from(content.querySelectorAll('p')).map(p=>p.textContent.trim()).filter(t=>t);
ttsCurrentPara=0;
updateTtsInfo();
}

function updateTtsInfo(){
try{
document.getElementById('ttsInfo').textContent=(ttsCurrentPara+1)+'/'+ttsParas.length+'段';
const pct=ttsParas.length>0?((ttsCurrentPara+1)/ttsParas.length*100):0;
document.getElementById('ttsProgress').style.width=pct+'%';
}catch(e){}
}

function highlightCurrentPara(){
try{
const content=document.getElementById('rdContent');
if(!content)return;
content.querySelectorAll('p').forEach((p,i)=>{
p.classList.toggle('tts-highlight',i===ttsCurrentPara);
});
const paras=content.querySelectorAll('p');
if(paras[ttsCurrentPara]){
paras[ttsCurrentPara].scrollIntoView({behavior:'smooth',block:'center'});
}
}catch(e){}
}

function ttsPlayPause(){
if(typeof speechSynthesis==='undefined'||!speechSynthesis){
showToast('你的浏览器不支持语音朗读');
return;
}
if(ttsParas.length===0){
loadTtsParas();
if(ttsParas.length===0){
showToast('没有可朗读的内容');
return;
}
}
if(ttsPlaying&&!ttsPaused){
try{speechSynthesis.pause();}catch(e){}
ttsPaused=true;
document.getElementById('ttsPlayBtn').textContent='▶ 继续';
return;
}
if(ttsPaused){
try{speechSynthesis.resume();}catch(e){}
ttsPaused=false;
document.getElementById('ttsPlayBtn').textContent='⏸ 暂停';
return;
}
ttsPlaying=true;
ttsPaused=false;
document.getElementById('ttsPlayBtn').textContent='⏸ 暂停';
speakCurrentPara();
}

function speakCurrentPara(){
if(typeof speechSynthesis==='undefined'||!speechSynthesis)return;
if(ttsCurrentPara>=ttsParas.length){
ttsStop();
showToast('朗读完成 🎉');
return;
}
const text=ttsParas[ttsCurrentPara];
ttsUtterance=new SpeechSynthesisUtterance(text);
try{
const voices=speechSynthesis.getVoices();
const selectedURI=document.getElementById('ttsVoiceSelect').value;
const voice=voices.find(v=>v.voiceURI===selectedURI);
if(voice)ttsUtterance.voice=voice;
}catch(e){}
ttsUtterance.rate=parseFloat(document.getElementById('ttsRate').value)||1;
ttsUtterance.pitch=parseFloat(document.getElementById('ttsPitch').value)||1;
ttsUtterance.onend=()=>{
if(!ttsPlaying)return;
ttsCurrentPara++;
updateTtsInfo();
if(ttsCurrentPara<ttsParas.length){
highlightCurrentPara();
speakCurrentPara();
}else{
ttsStop();
showToast('朗读完成 🎉');
}
};
ttsUtterance.onerror=(e)=>{
console.error('TTS错误:',e);
if(e.error!=='interrupted'){
showToast('朗读出错，请换个语音试试');
}
};
highlightCurrentPara();
updateTtsInfo();
try{speechSynthesis.speak(ttsUtterance);}catch(e){}
}

function ttsStop(){
try{if(typeof speechSynthesis!=='undefined'&&speechSynthesis)speechSynthesis.cancel();}catch(e){}
ttsPlaying=false;
ttsPaused=false;
ttsCurrentPara=0;
try{document.getElementById('ttsPlayBtn').textContent='▶ 朗读';}catch(e){}
try{
const content=document.getElementById('rdContent');
if(content){
content.querySelectorAll('p').forEach(p=>p.classList.remove('tts-highlight'));
}
}catch(e){}
try{updateTtsInfo();}catch(e){}
}

function ttsPrevPara(){
if(ttsCurrentPara>0){
ttsCurrentPara--;
if(ttsPlaying){
try{speechSynthesis.cancel();}catch(e){}
ttsPaused=false;
speakCurrentPara();
}else{
highlightCurrentPara();
updateTtsInfo();
}
}
}

function ttsNextPara(){
if(ttsCurrentPara<ttsParas.length-1){
ttsCurrentPara++;
if(ttsPlaying){
try{speechSynthesis.cancel();}catch(e){}
ttsPaused=false;
speakCurrentPara();
}else{
highlightCurrentPara();
updateTtsInfo();
}
}
}

function updateTtsRate(){
const val=parseFloat(document.getElementById('ttsRate').value);
document.getElementById('ttsRateVal').textContent=val.toFixed(1);
ttsSettings_.rate=val;
saveTtsSettings();
}

function updateTtsPitch(){
const val=parseFloat(document.getElementById('ttsPitch').value);
document.getElementById('ttsPitchVal').textContent=val.toFixed(1);
ttsSettings_.pitch=val;
saveTtsSettings();
}

function saveTtsSettings(){
ttsSettings_.voiceURI=document.getElementById('ttsVoiceSelect').value;
ttsSettings_.rate=parseFloat(document.getElementById('ttsRate').value)||1;
ttsSettings_.pitch=parseFloat(document.getElementById('ttsPitch').value)||1;
sv('bj_ttsSettings',ttsSettings_);
}

try{
if(typeof speechSynthesis!=='undefined'&&speechSynthesis){
speechSynthesis.onvoiceschanged=initTtsVoices;
}
}catch(e){
console.warn('语音合成API不可用:',e);
}
// ==================== SPLASH & INIT ====================
function initApp(){
// 数据完整性检查
try{
if(!Array.isArray(ws))ws=[];
if(!cols||typeof cols!=='object')cols={books:[],shorts:[]};
if(!Array.isArray(cols.books))cols.books=[];
if(!Array.isArray(cols.shorts))cols.shorts=[];
if(!Array.isArray(tags))tags=['#日常','#bg','#穿越','#奇幻','#校园'];
if(!Array.isArray(characters))characters=[{name:'',desc:''}];
if(!Array.isArray(crWorks))crWorks=[];
if(!Array.isArray(resPacks))resPacks=[];
// 清理无效数据
ws=ws.filter(a=>a&&a.id);
cols.books=cols.books.filter(b=>b&&b.id);
cols.shorts=cols.shorts.filter(s=>s&&s.id);
crWorks=crWorks.filter(w=>w&&w.id);
}catch(e){
console.error('数据检查失败:',e);
showToast('数据异常，部分功能可能受影响',3000);
}
// Load saved settings
const sApi=ld(K.curApi,{});
if(sApi.url)document.getElementById('apiUrl').value=sApi.url;
if(sApi.key)document.getElementById('apiKey').value=sApi.key;
if(sApi.model)document.getElementById('apiModel').value=sApi.model;
if(sApi.temp!==undefined)document.getElementById('apiTemp').value=sApi.temp;
if(sApi.maxTokens)document.getElementById('apiMaxTokens').value=sApi.maxTokens;

const sWorld=ld(K.curWorld,{});
if(sWorld.desc)document.getElementById('worldDesc').value=sWorld.desc;
if(sWorld.minWords)document.getElementById('minWords').value=sWorld.minWords;
if(ap.curStyle&&document.getElementById('styleDesc'))document.getElementById('styleDesc').value=ap.curStyle;
if(curRule&&document.getElementById('ruleDesc'))document.getElementById('ruleDesc').value=curRule;
if(banWords&&document.getElementById('banWordsInput'))document.getElementById('banWordsInput').value=banWords;
document.getElementById('streamOn').checked=useStream;
document.getElementById('quickTemp').value=document.getElementById('apiTemp').value;
document.getElementById('qtVal').textContent=document.getElementById('apiTemp').value;
updateStreamUI();

renderTags();renderArticles();renderCharCards();applyAppearance();
document.getElementById('splashVer').textContent=APP_VER;
renderUserCard();
}

// 页面关闭/切换时自动保存所有数据
window.addEventListener('beforeunload',()=>{
saveCurSettings();
autoSaveAll();
});
document.addEventListener('visibilitychange',()=>{
if(document.visibilityState==='hidden'){
saveCurSettings();
autoSaveAll();
}
});
// 全局错误捕获
window.onerror=function(msg,url,line,col,error){
console.error('全局错误:',msg,url,line);
// 不弹窗打扰用户，只记录
return false;
};
window.onunhandledrejection=function(e){
console.error('未处理的Promise错误:',e.reason);
};

document.addEventListener('DOMContentLoaded', async () => {
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const txt = document.getElementById('splashTxt');
    const bar = document.getElementById('splashBar');

    // 生成粒子
    const particlesContainer = document.getElementById('splashParticles');
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div');
        p.className = 'splash-particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 8 + 's';
        p.style.animationDuration = (6 + Math.random() * 4) + 's';
        particlesContainer.appendChild(p);
    }

    // 初始化步骤
    txt.textContent = '正在连接数据库...';
    bar.style.width = '10%';

    try {
        // 初始化IndexedDB
        await initDB();
        txt.textContent = '正在加载数据...';
        bar.style.width = '30%';

        // 从IndexedDB加载所有数据
        await loadAllFromDB();
        txt.textContent = '正在初始化组件...';
        bar.style.width = '60%';

        // 初始化应用
        initApp();
        txt.textContent = '正在渲染界面...';
        bar.style.width = '80%';

        setTimeout(() => {
            txt.textContent = '准备就绪';
            bar.style.width = '100%';
        }, 200);

        setTimeout(() => {
            splash.classList.add('hide');
            app.classList.add('show');
        }, 600);

        setTimeout(() => {
            splash.style.display = 'none';
        }, 1400);

        setTimeout(autoBackup, 5000);

    } catch (e) {
        console.error('初始化失败:', e);
        txt.textContent = '初始化失败，使用备用模式...';
        // 即使IndexedDB失败，也尝试用localStorage启动
        setTimeout(() => {
            try { initApp(); } catch (e2) { console.error(e2); }
            splash.classList.add('hide');
            app.classList.add('show');
        }, 1000);
    }

    // Auto-save on input changes
    const autoSaveIds = ['apiUrl', 'apiKey', 'apiModel', 'apiTemp', 'apiMaxTokens', 'worldDesc', 'minWords', 'styleDesc'];
    autoSaveIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', debounce(saveCurSettings, 600));
            el.addEventListener('change', saveCurSettings);
        }
    });
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>笔记AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0f0f14;--card:#1a1a24;--card2:#22222f;
--accent:#6c5ce7;--accent2:#a29bfe;
--text:#e8e8f0;--text2:#9090a8;
--danger:#ff6b6b;--success:#51cf66;
--border:#2a2a3a;--shadow:0 4px 20px rgba(0,0,0,0.4);
}
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);color:var(--text);
min-height:100vh;overflow-x:hidden;
position:relative;
}
body::before{
content:'';position:fixed;inset:0;z-index:-1;
background:
radial-gradient(ellipse 80% 50% at 20% -10%,rgba(108,92,231,.08),transparent 50%),
radial-gradient(ellipse 60% 40% at 80% 110%,rgba(162,155,254,.06),transparent 50%),
radial-gradient(circle at 50% 50%,rgba(108,92,231,.02),transparent 70%);
pointer-events:none;
}
body.theme-warm{--accent:#e67e22;--accent2:#f0b27a;--border:#3a2a1a;}
body.theme-green{--accent:#27ae60;--accent2:#58d68d;--border:#1a3a2a;}
body.theme-blue{--accent:#2980b9;--accent2:#5dade2;--border:#1a2a3a;}
body.theme-light{
--bg:#f5f5f8;--card:#ffffff;--card2:#eeeef3;
--text:#1a1a2e;--text2:#555570;--border:#d0d0e0;
--shadow:0 4px 20px rgba(0,0,0,0.08);
}
body.theme-light.theme-warm{--accent:#e67e22;--accent2:#d35400;}
body.theme-light.theme-green{--accent:#27ae60;--accent2:#1e8449;}
body.theme-light.theme-blue{--accent:#2980b9;--accent2:#1a5276;}
body.theme-light .bnav{background:rgba(245,245,248,.92);}
body.theme-light .rd-hdr{background:rgba(245,245,248,.88);}
/* LOGO FONT - 不受自定义字体影响 */
.logo-text{
font-family:'ZCOOL QingKe HuangYou','PingFang SC','Microsoft YaHei',sans-serif!important;
}
/* SPLASH */
.splash{
position:fixed;inset:0;z-index:10000;
background:linear-gradient(135deg,#0a0a12 0%,#12121f 50%,#0d0d18 100%);
display:flex;flex-direction:column;align-items:center;justify-content:center;
transition:opacity 0.8s,transform 0.8s;
overflow:hidden;
}
.splash.hide{opacity:0;transform:scale(1.05);pointer-events:none;}
.splash::before{
content:'';position:absolute;inset:0;
background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(108,92,231,.15),transparent),
radial-gradient(ellipse 60% 40% at 80% 100%,rgba(162,155,254,.1),transparent),
radial-gradient(ellipse 50% 30% at 10% 80%,rgba(108,92,231,.08),transparent);
pointer-events:none;
}
.splash-particles{
position:absolute;inset:0;overflow:hidden;pointer-events:none;
}
.splash-particle{
position:absolute;width:4px;height:4px;
background:var(--accent2);border-radius:50%;
opacity:0;animation:floatUp 8s infinite;
}
@keyframes floatUp{
0%{transform:translateY(100vh) scale(0);opacity:0;}
10%{opacity:.6;}
90%{opacity:.6;}
100%{transform:translateY(-20vh) scale(1);opacity:0;}
}
.splash-glow{
position:absolute;width:300px;height:300px;
background:radial-gradient(circle,rgba(108,92,231,.2) 0%,transparent 70%);
border-radius:50%;filter:blur(40px);
animation:pulseGlow 4s ease-in-out infinite;
}
@keyframes pulseGlow{
0%,100%{transform:scale(1);opacity:.5;}
50%{transform:scale(1.2);opacity:.8;}
}
.splash-card{
position:relative;z-index:10;
background:linear-gradient(145deg,rgba(26,26,40,.7) 0%,rgba(40,35,60,.5) 100%);
backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
border:1px solid rgba(108,92,231,.3);
border-radius:28px;padding:52px 60px;
box-shadow:0 12px 40px rgba(0,0,0,.4),
0 0 0 1px rgba(255,255,255,.08) inset,
0 0 100px rgba(108,92,231,.15),
0 -20px 60px rgba(162,155,254,.05) inset;
text-align:center;
animation:cardFloat 5s ease-in-out infinite;
}
@keyframes cardFloat{
0%,100%{transform:translateY(0) rotate(0deg);}
25%{transform:translateY(-5px) rotate(0.5deg);}
50%{transform:translateY(-10px) rotate(0deg);}
75%{transform:translateY(-5px) rotate(-0.5deg);}
}
.splash-icon{
width:100px;height:100px;margin:0 auto 20px;
background:transparent;
border-radius:50%;
display:flex;align-items:center;justify-content:center;
box-shadow:none;
animation:iconFloat 3s ease-in-out infinite;
overflow:visible;
}
.splash-icon img{
width:100%;height:100%;object-fit:contain;
filter:drop-shadow(0 4px 20px rgba(108,92,231,.5));
}
@keyframes iconFloat{
0%,100%{transform:translateY(0)}
50%{transform:translateY(-8px)}
}
@keyframes iconPulse{
0%,100%{box-shadow:0 8px 24px rgba(108,92,231,.4);}
50%{box-shadow:0 12px 36px rgba(108,92,231,.6);}
}
.splash-logo{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:36px;font-weight:400;letter-spacing:6px;
background:linear-gradient(135deg,#fff 0%,var(--accent2) 50%,var(--accent) 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;margin-bottom:8px;
animation:shimmer 3s ease-in-out infinite;
background-size:200% 100%;
text-shadow:0 0 40px rgba(108,92,231,.3);
}
@keyframes shimmer{ 0%{background-position:0% 50%;filter:brightness(1);} 25%{filter:brightness(1.1);} 50%{background-position:100% 50%;filter:brightness(1.2);} 75%{filter:brightness(1.1);} 100%{background-position:0% 50%;filter:brightness(1);} }
.splash-sub{
font-size:13px;color:rgba(255,255,255,.6);
letter-spacing:2px;margin-bottom:32px;
}
.splash-progress{
width:240px;height:8px;
background:rgba(255,255,255,.08);
border-radius:4px;overflow:hidden;
margin:24px auto 0;
border:1px solid rgba(108,92,231,.3);
box-shadow:0 0 12px rgba(108,92,231,.15),inset 0 1px 2px rgba(0,0,0,.3);
position:relative;
}
.splash-progress::before{
content:'';position:absolute;inset:0;
background:repeating-linear-gradient(
90deg,
transparent 0px,
transparent 8px,
rgba(255,255,255,.03) 8px,
rgba(255,255,255,.03) 9px
);
z-index:1;
}
.splash-progress-bar{
height:100%;width:0;
background:linear-gradient(90deg,var(--accent),var(--accent2),#00d2ff,var(--accent));
background-size:300% 100%;
border-radius:4px;
transition:width .4s ease;
animation:progressShine 2s linear infinite;
box-shadow:0 0 10px rgba(108,92,231,.6),0 0 20px rgba(108,92,231,.3);
position:relative;
}
.splash-progress-bar::after{
content:'';position:absolute;
top:0;right:0;width:20px;height:100%;
background:linear-gradient(90deg,transparent,rgba(255,255,255,.6));
border-radius:0 4px 4px 0;
filter:blur(2px);
}
@keyframes progressShine{
0%{background-position:0% 50%}
100%{background-position:300% 50%}
}
.splash-status{
font-size:11px;color:rgba(255,255,255,.4);
display:flex;align-items:center;justify-content:center;gap:8px;
}
.splash-dot{
width:6px;height:6px;border-radius:50%;
background:var(--accent2);
animation:dotPulse 1.5s ease-in-out infinite;
}
@keyframes dotPulse{
0%,100%{opacity:.4;transform:scale(1);}
50%{opacity:1;transform:scale(1.2);}
}
.splash-corner{
position:absolute;font-size:10px;
color:rgba(255,255,255,.2);font-weight:500;
letter-spacing:1px;
}
.splash-corner.tl{top:24px;left:24px;}
.splash-corner.br{bottom:24px;right:24px;}
.splash-ver{
position:absolute;bottom:24px;left:50%;transform:translateX(-50%);
font-size:10px;color:rgba(255,255,255,.2);
}
.splash-decor{
position:absolute;border:1px solid rgba(108,92,231,.15);
border-radius:50%;pointer-events:none;
}
.splash-decor-1{
width:400px;height:400px;top:-100px;right:-100px;
animation:rotateSlow 30s linear infinite;
}
.splash-decor-2{
width:300px;height:300px;bottom:-80px;left:-80px;
animation:rotateSlow 25s linear infinite reverse;
}
@keyframes rotateSlow{
from{transform:rotate(0deg);}
to{transform:rotate(360deg);}
}

/* APP */
.app{opacity:0;transform:translateY(16px);transition:opacity .5s .2s,transform .5s .2s;padding-bottom:68px;}
.app.show{opacity:1;transform:translateY(0);}

/* HEADER */
.hdr{
position:sticky;top:0;z-index:100;
background:linear-gradient(135deg,rgba(26,26,36,.95) 0%,rgba(15,15,20,.98) 100%);
backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
padding:16px 20px 12px;
border-bottom:1px solid rgba(108,92,231,.15);
display:flex;justify-content:space-between;align-items:center;
box-shadow:0 4px 30px rgba(0,0,0,.2);
}
.hdr-left h1{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:22px;font-weight:400;letter-spacing:2px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
display:flex;align-items:center;gap:8px;
}
.hdr-logo-img{
width:28px;height:28px;border-radius:8px;
object-fit:cover;
filter:drop-shadow(0 2px 4px rgba(108,92,231,.3));
}
.hdr-left .hdr-sub{font-size:10px;color:var(--text2);margin-top:2px;}
.hdr-right{display:flex;gap:8px;}
.hdr-btn{
background:none;border:1px solid var(--border);color:var(--text2);
padding:5px 10px;border-radius:10px;font-size:11px;cursor:pointer;
display:flex;align-items:center;gap:4px;transition:all .3s;
}
.hdr-btn:active{transform:scale(.95);}
.hdr-btn svg{width:15px;height:15px;}
body.theme-light .hdr{
background:linear-gradient(135deg,rgba(245,245,248,.95) 0%,rgba(255,255,255,.98) 100%);
border-bottom-color:rgba(0,0,0,.08);
}
body.theme-light .hdr-left h1{
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-light .hdr-btn{
border-color:rgba(0,0,0,.1);
color:var(--text2);
}
/* BOTTOM NAV */
.bnav{
position:fixed;bottom:0;left:0;right:0;z-index:200;
background:linear-gradient(180deg,rgba(26,26,36,.85) 0%,rgba(20,20,28,.98) 100%);
backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);
border-top:1px solid rgba(108,92,231,.2);
display:flex;justify-content:space-around;padding:8px 0 12px;
transition:transform .3s;
box-shadow:0 -4px 30px rgba(0,0,0,.3);
}
.bnav::before{
content:'';position:absolute;top:0;left:10%;right:10%;height:1px;
background:linear-gradient(90deg,transparent,var(--accent),transparent);
}
.bnav-i{
display:flex;flex-direction:column;align-items:center;gap:3px;
cursor:pointer;padding:6px 16px;border-radius:14px;
background:none;border:none;color:var(--text2);font-size:10px;
transition:all .35s cubic-bezier(.4,0,.2,1);
position:relative;
}
.bnav-i::before{
content:'';position:absolute;inset:0;border-radius:14px;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.1));
opacity:0;transition:opacity .3s;transform:scale(.8);
}
.bnav-i.act{color:var(--accent2);}
.bnav-i.act::before{opacity:1;transform:scale(1);}
.bnav-i svg{width:22px;height:22px;transition:all .35s;}
.bnav-i.act svg{filter:drop-shadow(0 0 8px var(--accent));transform:scale(1.1);}
.bnav-i:active{transform:scale(.9);}

/* PAGES */
.pg{display:none;animation:fadeIn .25s ease;}
.pg.act{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH BAR */
.sbar{display:flex;gap:9px;padding:14px 18px 8px;}
.sbar input{
flex:1;padding:12px 18px;border-radius:15px;
border:1px solid var(--border);
background:linear-gradient(135deg,var(--card),rgba(108,92,231,.02));
color:var(--text);font-size:13px;outline:none;
transition:all .35s cubic-bezier(.4,0,.2,1);
box-shadow:0 2px 10px rgba(0,0,0,.05) inset;
}
.sbar input:focus{
border-color:var(--accent);
box-shadow:0 0 0 3px rgba(108,92,231,.15),0 2px 10px rgba(0,0,0,.05) inset;
}
.sbar input::placeholder{color:var(--text2);opacity:.7;}
.sbar input::placeholder{color:var(--text2);}
.btn-gen{
padding:12px 22px;border-radius:14px;border:none;
background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 50%,var(--accent) 100%);
background-size:200% 100%;
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
white-space:nowrap;transition:all .4s cubic-bezier(.4,0,.2,1);
box-shadow:0 4px 15px rgba(108,92,231,.3),0 0 20px rgba(108,92,231,.1);
position:relative;overflow:hidden;
}
.btn-gen:hover{background-position:100% 0;box-shadow:0 6px 25px rgba(108,92,231,.4);}
.btn-gen::after{
content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;
background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent);
transform:rotate(45deg) translateX(-100%);transition:transform .6s;
}
.btn-gen:active::after{transform:rotate(45deg) translateX(100%);}
.btn-gen:active{transform:scale(.95);box-shadow:0 2px 8px rgba(108,92,231,.4);opacity:.9;} .btn-gen::before{ content:'';position:absolute;inset:0; background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent); transform:translateX(-100%);transition:transform .5s; } .btn-gen:active::before{transform:translateX(100%);}
.btn-gen:disabled{opacity:.4;cursor:not-allowed;transform:none;filter:grayscale(.5);pointer-events:none;}

/* TAGS */
.tags-sec{padding:4px 18px 8px;}
.tags-wrap{display:flex;flex-wrap:nowrap;gap:7px;align-items:center;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;} .tags-wrap::-webkit-scrollbar{height:2px;} .tags-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;} .tags-wrap .tag,.tags-wrap .tag-add{flex-shrink:0;}
.tag{
padding:6px 14px;border-radius:20px;font-size:11px;cursor:pointer;
transition:all .3s cubic-bezier(.4,0,.2,1);border:1px solid var(--border);
background:linear-gradient(135deg,var(--card),rgba(108,92,231,.03));
color:var(--text2);display:flex;align-items:center;gap:4px;
user-select:none;position:relative;overflow:hidden;
}
.tag::before{
content:'';position:absolute;inset:0;
background:linear-gradient(135deg,var(--accent),var(--accent2));
opacity:0;transition:opacity .3s;z-index:-1;
}
.tag.act{color:#fff;border-color:var(--accent);box-shadow:0 3px 12px rgba(108,92,231,.35);}
.tag.act::before{opacity:1;}
.tag:active{transform:scale(.95);}
.tag .tdel{
width:13px;height:13px;display:none;align-items:center;justify-content:center;
font-size:9px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;
line-height:1;
}
.tag.act .tdel{display:flex;}
.tag-add{
padding:5px 11px;border-radius:18px;font-size:11px;cursor:pointer;
border:1px dashed var(--border);background:transparent;color:var(--accent2);
transition:all .3s;
}

/* TYPE TABS */
.ttabs{display:flex;padding:4px 18px;gap:0;}
.ttab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.ttab.act{color:var(--accent2);border-bottom-color:var(--accent);}

/* ARTICLE CARDS */
.alist{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.acard{
background:linear-gradient(135deg,var(--card) 0%,rgba(108,92,231,.05) 50%,var(--card) 100%);
border-radius:20px;padding:20px;
border:1px solid var(--border);transition:all .35s cubic-bezier(.4,0,.2,1);cursor:pointer;
position:relative;overflow:hidden;
backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
box-shadow:0 4px 20px rgba(0,0,0,.08),0 0 0 1px rgba(255,255,255,.05) inset;
}
.acard:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(108,92,231,.15);}
.acard::before{
content:'';position:absolute;top:0;left:0;right:0;height:3px;
background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent));
background-size:200% 100%;
opacity:0;transition:opacity .3s;
}
.acard:active::before{opacity:1;}
.acard:active{transform:scale(.97);border-color:var(--accent);box-shadow:0 0 12px rgba(108,92,231,.15);}
.acard-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.acard-t{font-size:15px;font-weight:700;line-height:1.4;flex:1;margin-right:10px;}
.acard-badge{padding:3px 9px;border-radius:9px;font-size:9px;font-weight:600;flex-shrink:0;}
.acard-badge.long{background:rgba(108,92,231,.18);color:var(--accent2);}
.acard-badge.short{background:rgba(81,207,102,.18);color:var(--success);}
.acard-pv{
font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.acard-ft{display:flex;justify-content:space-between;align-items:center;}
.acard-tags{display:flex;gap:5px;flex-wrap:wrap;flex:1;}
.acard-tag{padding:2px 7px;border-radius:7px;font-size:9px;background:var(--card2);color:var(--text2);}
.acard-wc{font-size:10px;color:var(--text2);margin-right:8px;white-space:nowrap;}
.btn-like{
display:flex;align-items:center;gap:3px;padding:5px 11px;border-radius:9px;
border:1px solid var(--border);background:transparent;color:var(--text2);
font-size:11px;cursor:pointer;transition:all .3s;flex-shrink:0;
}
.btn-like.liked{background:rgba(255,107,107,.13);border-color:var(--danger);color:var(--danger);}
.empty-st{text-align:center;padding:50px 18px;color:var(--text2);}
.empty-st svg{width:50px;height:50px;margin-bottom:12px;opacity:.3;}
.empty-st p{font-size:13px;line-height:1.6;}

/* STREAMING INDICATOR */
.stream-card{
background:var(--card);border-radius:15px;padding:16px;
border:1px solid var(--accent);transition:all .3s;
}
.stream-card .stream-title{
font-size:14px;font-weight:600;color:var(--accent2);margin-bottom:8px;
display:flex;align-items:center;gap:8px;
}
.stream-card .stream-body{
font-size:13px;line-height:1.8;color:var(--text);
max-height:200px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word;
}
.stream-card .stream-info{
display:flex;justify-content:space-between;align-items:center;
margin-top:10px;font-size:10px;color:var(--text2);
}
.ldots{display:inline-flex;gap:3px;align-items:center;}
.ldots span{
width:5px;height:5px;border-radius:50%;background:var(--accent2);
animation:bounce 1.4s infinite both;
}
.ldots span:nth-child(2){animation-delay:.16s;}
.ldots span:nth-child(3){animation-delay:.32s;}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.loading-state{animation:pulse 1.5s infinite;}

/* READING MODAL */
/* IMMERSIVE READ */
.modal.immersive-read{background:#050508;}
body.theme-light .modal.immersive-read{background:#f5f5f8;}
body.theme-light .modal.immersive-read .rd-content{color:#1a1a2e;}
.modal.immersive-read .rd-hdr{display:none;}
.modal.immersive-read .rd-body{padding:30px 28px 140px;}
.modal.immersive-read .rd-title{font-size:24px;text-align:center;margin-bottom:20px;}
.modal.immersive-read .rd-meta{justify-content:center;}
.modal.immersive-read .rd-content{font-size:18px;line-height:2.4;}
.modal.immersive-read .ch-nav{justify-content:center;}
.modal.immersive-read .cont-wrap{display:none!important;}
.modal.immersive-read .rd-settings{display:none!important;}
.immersive-read-bar{
position:fixed;bottom:0;left:0;right:0;z-index:20;
background:rgba(5,5,8,.95);backdrop-filter:blur(10px);
padding:14px 20px;display:none;
border-top:1px solid rgba(108,92,231,.2);
flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
}
.modal.immersive-read .immersive-read-bar{display:flex;}
.immersive-read-bar button{
padding:8px 16px;border-radius:20px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:11px;cursor:pointer;
transition:all .3s;
}
.immersive-read-bar button:active{transform:scale(.95);}
.immersive-read-bar button.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.immersive-read-bar .speed-ctrl{
display:flex;align-items:center;gap:8px;
padding:6px 12px;background:var(--card);border-radius:20px;border:1px solid var(--border);
}
.immersive-read-bar .speed-ctrl span{font-size:10px;color:var(--text2);}
.immersive-read-bar .speed-ctrl input{width:80px;accent-color:var(--accent);}
.immersive-exit-float{
position:fixed;top:20px;right:20px;z-index:100;
padding:10px 18px;border-radius:25px;
background:rgba(108,92,231,.3);border:1px solid var(--accent);
color:#fff;font-size:12px;cursor:pointer;
display:none;backdrop-filter:blur(8px);
box-shadow:0 4px 15px rgba(0,0,0,.3);
}
.modal.immersive-read .immersive-exit-float{display:block;}
.modal{
display:none;position:fixed;inset:0;z-index:500;
background:var(--bg);overflow-y:auto;
}
.modal.show{display:block;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal.fs .rd-hdr{
position:fixed;top:0;left:0;right:0;
background:rgba(15,15,20,.85);backdrop-filter:blur(10px);z-index:10;
}
.modal.fs .rd-body{padding-top:62px;}
.rd-bg{
position:fixed;inset:0;z-index:0;
background-size:cover;background-position:center;
opacity:.50;pointer-events:none;display:none;
}
.rd-hdr{
position:sticky;top:0;z-index:10;
background:rgba(15,15,20,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
padding:14px 18px;display:flex;justify-content:space-between;align-items:center;
border-bottom:1px solid var(--border);
}
.rd-back{
display:flex;align-items:center;gap:5px;background:none;
border:none;color:var(--accent2);font-size:13px;cursor:pointer;padding:4px;
}
.rd-back svg{width:18px;height:18px;}
.rd-acts{
display:flex;gap:6px;
overflow-x:auto;
flex-wrap:nowrap;
-webkit-overflow-scrolling:touch;
padding-bottom:2px;
}
.rd-acts::-webkit-scrollbar{display:none;}
.rd-acts button{
flex-shrink:0;
padding:5px 10px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;white-space:nowrap;
}
.rd-body{padding:22px 20px 70px;position:relative;z-index:1;}
.rd-title{font-size:20px;font-weight:800;line-height:1.4;margin-bottom:12px;}
.rd-meta{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.rd-meta span{font-size:11px;color:var(--text2);padding:3px 9px;background:var(--card);border-radius:7px;}
.ch-nav{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.ch-btn{
padding:5px 12px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.rd-content{
font-size:var(--rd-fontsize,16px);
line-height:var(--rd-lineheight,2.2);
color:var(--text);white-space:pre-wrap;word-wrap:break-word;
letter-spacing:.02em;
}
.rd-content p{
margin-bottom:16px;text-indent:2em;
transition:background .3s,box-shadow .3s;
padding:4px 8px;margin-left:-8px;margin-right:-8px;
border-radius:6px;
}
.rd-content p:hover{background:rgba(108,92,231,.03);}
.rd-content p{
margin-bottom:16px;text-indent:2em;
transition:background .3s,box-shadow .3s;
padding:4px 8px;margin-left:-8px;margin-right:-8px;
border-radius:6px;
}
.rd-content p:hover{background:rgba(108,92,231,.03);}
.rd-dir-input{margin-bottom:12px;} .rd-dir-input input{ width:100%;padding:12px 16px;border-radius:12px; border:1px solid var(--border);background:var(--card); color:var(--text);font-size:13px;outline:none; transition:border-color .3s; } .rd-dir-input input:focus{border-color:var(--accent);} .rd-dir-input input::placeholder{color:var(--text2);}
.cont-wrap{padding:16px 0;text-align:center;}
.btn-cont{
padding:11px 28px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
box-shadow:0 3px 12px rgba(108,92,231,.25);transition:all .3s;
}
.btn-cont:active{transform:scale(.95);}
.btn-cont:disabled{opacity:.4;filter:grayscale(.5);pointer-events:none;}
.btn-undo{
padding:8px 16px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
margin-left:10px;transition:all .3s;
}

/* Reading settings bar */
.rd-settings{
background:var(--card);border-radius:14px;padding:14px;margin-bottom:18px;
border:1px solid var(--border);display:none;
}
.rd-settings.show{display:block;}
.rd-settings h4{font-size:12px;color:var(--text2);margin-bottom:10px;}
.rd-s-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rd-s-row:last-child{margin-bottom:0;}
.rd-s-label{font-size:11px;color:var(--text2);width:50px;flex-shrink:0;}
.rd-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.rd-s-val{font-size:11px;color:var(--accent2);width:35px;text-align:right;}

/* COLLECTION */
.col-hdr{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;}
.col-hdr h2{font-size:17px;font-weight:700;}
.col-cnt{font-size:11px;color:var(--text2);background:var(--card);padding:3px 11px;border-radius:9px;}
.col-search{padding:0 18px 8px;}
.col-search input{
width:100%;padding:9px 14px;border-radius:11px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.col-search input::placeholder{color:var(--text2);}
.sec-div{padding:14px 18px 4px;display:flex;justify-content:space-between;align-items:center;}
.sec-div h3{font-size:14px;font-weight:600;color:var(--text2);}
.bgrid{
padding:0 18px;display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;
}
.bcard{
background:var(--card);border-radius:13px;overflow:hidden;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.bcard:active{transform:scale(.97);}
.bcov{
width:100%;aspect-ratio:3/4;
background:linear-gradient(135deg,var(--card2),var(--card));
display:flex;align-items:center;justify-content:center;
position:relative;overflow:hidden;
}
.bcov img{width:100%;height:100%;object-fit:cover;}
.bcov-ph{
display:flex;flex-direction:column;align-items:center;gap:6px;
font-size:12px;color:var(--text2);
}
.binfo{padding:10px;}
.binfo-t{font-size:12px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.binfo-m{font-size:9px;color:var(--text2);}
.binfo-status{
display:inline-block;padding:1px 6px;border-radius:6px;font-size:8px;
margin-top:3px;
}
.binfo-status.ongoing{background:rgba(108,92,231,.15);color:var(--accent2);}
.binfo-status.complete{background:rgba(81,207,102,.15);color:var(--success);}
.binfo-status.paused{background:rgba(255,107,107,.15);color:var(--danger);}
.bacts{padding:0 10px 10px;display:flex;gap:5px;}
.bact{
flex:1;padding:5px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.bact.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.col-shorts{padding:14px 18px 0;}
.col-shorts h3{font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text2);}
.slist{display:flex;flex-direction:column;gap:9px;padding-bottom:18px;}
.sitem{
background:var(--card);border-radius:11px;padding:12px;
border:1px solid var(--border);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.sitem-info{flex:1;margin-right:8px;}
.sitem-t{font-size:13px;font-weight:600;margin-bottom:3px;}
.sitem-pv{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100vw - 160px);}
.sitem-acts{display:flex;gap:5px;}
.sitem-acts button{
padding:4px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
}
.star-rating{display:flex;gap:2px;margin-top:4px;}
.star-rating span{
font-size:14px;cursor:pointer;color:var(--border);transition:color .2s;
user-select:none;
}
.star-rating span.filled{color:#f1c40f;}

/* USER CARD */
.ucard{
margin:14px 18px;background:var(--card);border-radius:18px;
border:1px solid var(--border);overflow:visible;
position:relative;
}
.xj-float-btn{
position:absolute;
top:0px;left:70px;
width:40px;height:40px;
border-radius:50%;
background:transparent;
padding:0;
cursor:pointer;
z-index:10;
animation:xjFloat 4s ease-in-out infinite;
transition:transform .3s cubic-bezier(.34,1.56,.64,1), filter .3s;
}
.xj-float-btn::before{
content:'';
position:absolute;
top:50%;left:50%;
transform:translate(-50%,-50%);
width:140%;height:140%;
border-radius:50%;
background:radial-gradient(circle,rgba(162,155,254,.35) 0%,rgba(108,92,231,.15) 40%,transparent 65%);
animation:xjSoftGlow 4s ease-in-out infinite;
z-index:-1;
}
.xj-float-btn::after{
content:'';
position:absolute;
top:50%;left:50%;
transform:translate(-50%,-50%);
width:160%;height:160%;
border-radius:50%;
background:radial-gradient(circle,rgba(108,92,231,.1) 0%,transparent 60%);
animation:xjSoftGlow 4s ease-in-out infinite 2s;
z-index:-2;
}
.xj-float-btn:hover{
transform:scale(1.1);
}
.xj-float-btn:hover::before{
opacity:1;
transform:translate(-50%,-50%) scale(1.2);
}
.xj-float-btn:active{
transform:scale(.9);
}
.xj-float-btn img{
width:100%;height:100%;
border-radius:50%;
object-fit:cover;
filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));
}

@keyframes xjFloat{
0%,100%{
transform:translateY(0) translateX(0);
}
20%{
transform:translateY(-6px) translateX(2px);
}
40%{
transform:translateY(-3px) translateX(-2px);
}
60%{
transform:translateY(-8px) translateX(1px);
}
80%{
transform:translateY(-4px) translateX(-1px);
}
}

@keyframes xjSoftGlow{
0%,100%{
transform:translate(-50%,-50%) scale(1);
opacity:.4;
}
30%{
opacity:.7;
}
50%{
transform:translate(-50%,-50%) scale(1.1);
opacity:.9;
}
70%{
opacity:.6;
}
}
.ucard-top{
padding:20px 18px 14px;display:flex;align-items:center;gap:14px;
}
.ucard-avatar{
width:56px;height:56px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
font-size:24px;color:#fff;cursor:pointer;
overflow:hidden;flex-shrink:0;position:relative;
border:2px solid var(--border);transition:all .3s;
}
.ucard-avatar:active{transform:scale(.95);}
.ucard-avatar img{width:100%;height:100%;object-fit:cover;}
.ucard-avatar-hint{
position:absolute;inset:0;background:rgba(0,0,0,.45);
display:flex;align-items:center;justify-content:center;
font-size:10px;color:#fff;opacity:0;transition:opacity .3s;
}
.ucard-avatar:active .ucard-avatar-hint{opacity:1;}
.ucard-info{flex:1;min-width:0;}
.ucard-name{
font-size:16px;font-weight:700;margin-bottom:3px;
display:flex;align-items:center;gap:6px;
}
.ucard-name span{
overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
}
.ucard-name button{
background:none;border:none;color:var(--text2);font-size:12px;
cursor:pointer;padding:2px 6px;flex-shrink:0;
}
.ucard-bio{
font-size:11px;color:var(--text2);line-height:1.5;
display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
overflow:hidden;cursor:pointer;
}
.ucard-stats{
padding:12px 18px 16px;border-top:1px solid var(--border);
display:grid;grid-template-columns:repeat(4,1fr);gap:0;
}
.ucard-stat{
text-align:center;padding:6px 0;
position:relative;
}
.ucard-stat:not(:last-child)::after{
content:'';position:absolute;right:0;top:20%;height:60%;
width:1px;background:var(--border);
}
.ucard-stat-num{
font-size:18px;font-weight:800;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.ucard-stat-label{font-size:9px;color:var(--text2);margin-top:2px;}
/* SETTINGS */
.set-sec{padding:14px 18px;}
/* SETTINGS MODAL */
.set-modal{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.set-modal.show{display:block;animation:slideUp .3s ease;}
.set-modal-hdr{
position:sticky;top:0;z-index:10;
background:var(--bg);padding:14px 18px;
display:flex;align-items:center;gap:10px;
border-bottom:1px solid var(--border);
}
.set-modal-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;
display:flex;align-items:center;gap:5px;
}
.set-modal-hdr button svg{width:18px;height:18px;}
.set-modal-hdr h2{font-size:16px;font-weight:700;flex:1;}
.set-modal-body{padding:18px;}
.set-entry{
background:var(--card);border-radius:14px;padding:16px;
border:1px solid var(--border);margin-bottom:12px;
display:flex;justify-content:space-between;align-items:center;
cursor:pointer;transition:all .3s;
}
.set-entry:active{transform:scale(.98);border-color:var(--accent);}
.set-entry-left{display:flex;align-items:center;gap:12px;}
.set-entry-icon{font-size:22px;}
.set-entry-info h3{font-size:14px;font-weight:600;margin-bottom:2px;}
.set-entry-info p{font-size:11px;color:var(--text2);}
.set-entry-arrow{color:var(--text2);font-size:18px;}
.set-grp{
background:var(--card);border-radius:15px;
border:1px solid var(--border);margin-bottom:13px;overflow:hidden;
}
.set-grp-t{
padding:13px 16px;font-size:14px;font-weight:700;
background:var(--card2);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.set-grp-t svg{width:16px;height:16px;color:var(--text2);transition:transform .3s;}
.set-grp-t.exp svg{transform:rotate(180deg);}
.set-grp-c{padding:14px 16px;display:none;}
.set-grp-c.show{display:block;}
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.fl{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.fi,.fta,.fsel{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
transition:border-color .3s;font-family:inherit;
}
.fi:focus,.fta:focus{border-color:var(--accent);}
.fta{min-height:90px;resize:vertical;line-height:1.6;}
.frow{display:flex;gap:9px;}
.frow .fg{flex:1;}
.plist{display:flex;flex-direction:column;gap:7px;margin-top:9px;}
.pitem{
display:flex;justify-content:space-between;align-items:center;
padding:9px 13px;background:var(--bg);border-radius:9px;border:1px solid var(--border);
}
.pitem-n{font-size:12px;font-weight:500;}
.pitem-a{display:flex;gap:5px;}
.pitem-a button{
padding:3px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;font-size:10px;cursor:pointer;transition:all .3s;
}
.btn-use{color:var(--accent2);border-color:var(--accent)!important;}
.btn-del{color:var(--danger);border-color:rgba(255,107,107,.3)!important;}
.btn-p{
padding:9px 18px;border-radius:11px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
transition:all .3s;width:100%;margin-top:7px;
}
.btn-p:active{transform:scale(.98);}
.btn-s{
padding:9px 18px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;font-weight:500;
cursor:pointer;transition:all .3s;width:100%;margin-top:7px;
}
.theme-opts{display:flex;gap:8px;flex-wrap:wrap;}
.t-opt{
width:36px;height:36px;border-radius:10px;border:2px solid var(--border);
cursor:pointer;transition:all .3s;
}
.t-opt.act{border-color:var(--accent);box-shadow:0 0 8px rgba(108,92,231,.3);}
.t-opt.t0{background:linear-gradient(135deg,#6c5ce7,#a29bfe);}
.t-opt.t1{background:linear-gradient(135deg,#e67e22,#f0b27a);}
.t-opt.t2{background:linear-gradient(135deg,#27ae60,#58d68d);}
.t-opt.t3{background:linear-gradient(135deg,#2980b9,#5dade2);}
.t-opt.t4{background:linear-gradient(135deg,#f5f5f8,#ddd);border-color:#ccc;}
.data-btns{display:flex;flex-direction:column;gap:8px;}
.data-btns button{
padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:7px;transition:all .3s;
}
.data-btns button:active{transform:scale(.98);}
.wc-set{display:flex;align-items:center;gap:8px;}
.wc-set input{width:90px;text-align:center;}

/* Char cards - dynamic */
.char-cards{display:flex;flex-direction:column;gap:12px;}
.char-card{
background:var(--bg);border-radius:12px;padding:14px;
border:1px solid var(--border);position:relative;
}
.char-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.char-card-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.char-card-del{
background:none;border:none;color:var(--danger);font-size:10px;cursor:pointer;
padding:3px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);
}
/* 人物关系图 */
.rel-graph{padding:14px;background:var(--bg);border-radius:12px;border:1px solid var(--border);margin-top:12px;}
.rel-graph-title{font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.rel-list{display:flex;flex-direction:column;gap:8px;}
.rel-item{
display:flex;align-items:center;gap:8px;padding:10px 12px;
background:var(--card);border-radius:10px;border:1px solid var(--border);
transition:all .2s;
}
.rel-item:active{transform:scale(.98);border-color:var(--accent);}
.rel-item-names{display:flex;align-items:center;gap:6px;flex:1;min-width:0;}
.rel-item-name{
font-size:12px;font-weight:600;color:var(--text);
padding:3px 8px;background:rgba(108,92,231,.1);border-radius:8px;
white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;
}
.rel-item-arrow{font-size:10px;color:var(--text2);}
.rel-item-type{
font-size:10px;padding:2px 8px;border-radius:10px;
white-space:nowrap;flex-shrink:0;
}
.rel-type-love{background:rgba(255,107,107,.15);color:#ff6b6b;}
.rel-type-friend{background:rgba(81,207,102,.15);color:#51cf66;}
.rel-type-enemy{background:rgba(230,126,34,.15);color:#e67e22;}
.rel-type-family{background:rgba(162,155,254,.15);color:#a29bfe;}
.rel-type-master{background:rgba(241,196,15,.15);color:#f1c40f;}
.rel-type-colleague{background:rgba(52,152,219,.15);color:#3498db;}
.rel-type-other{background:rgba(144,144,168,.15);color:#9090a8;}
.rel-item-desc{font-size:10px;color:var(--text2);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.rel-item-acts{display:flex;gap:4px;flex-shrink:0;}
.rel-item-acts button{
padding:3px 7px;border-radius:6px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
}
.rel-item-acts button.del{border-color:rgba(255,107,107,.3);color:var(--danger);}
.rel-empty{text-align:center;padding:16px;color:var(--text2);font-size:11px;}
/* NPC设定 */
.npc-section{margin-top:15px;padding-top:15px;border-top:1px solid var(--border);}
.npc-card{
background:var(--bg);border-radius:12px;padding:14px;
border:1px solid var(--border);margin-bottom:8px;position:relative;
}
.npc-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.npc-card-hdr span{font-size:12px;font-weight:600;color:var(--success);}
.npc-badge{
display:inline-block;padding:1px 6px;border-radius:6px;font-size:9px;
background:rgba(81,207,102,.15);color:var(--success);margin-left:6px;
}
/* HANDBOOK */
.hb-ov{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.hb-ov.show{display:block;animation:slideUp .3s ease;}
.hb-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:14px 18px;display:flex;align-items:center;gap:8px;
border-bottom:1px solid var(--border);
}
.hb-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;display:flex;align-items:center;gap:5px;
}
.hb-hdr button svg{width:18px;height:18px;}
.hb-hdr h2{font-size:16px;font-weight:700;}
.hb-body{padding:22px 20px 50px;}
.hb-body h3{
font-size:15px;font-weight:700;color:var(--accent2);
margin:22px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--border);
}
.hb-body h3:first-child{margin-top:0;}
.hb-body p{font-size:13px;line-height:1.9;color:var(--text);margin-bottom:9px;}
.hb-body ul{padding-left:18px;margin-bottom:10px;}
.hb-body li{font-size:12px;line-height:1.8;color:var(--text2);margin-bottom:3px;}
.hb-body .notice{
background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.25);
border-radius:11px;padding:13px 15px;margin:14px 0;
}
.hb-body .notice p{color:var(--accent2);font-size:12px;margin:0;}
.hb-body .contact{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);margin-top:10px;
}
.hb-body .contact p{font-size:12px;line-height:2;color:var(--text2);margin:0;}

/* DIALOGS */
.toast{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%) scale(.85);
background:linear-gradient(135deg,rgba(30,30,45,.95),rgba(40,35,60,.95));
backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
color:#fff;padding:16px 32px;
border-radius:18px;font-size:14px;z-index:9999;opacity:0;
transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none;text-align:center;
border:1px solid rgba(108,92,231,.4);
box-shadow:0 10px 40px rgba(0,0,0,.4),0 0 30px rgba(108,92,231,.25),0 0 0 1px rgba(255,255,255,.1) inset;
max-width:300px;font-weight:500;
letter-spacing:.5px;
}
.toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.dlg-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.dlg-ov.show{display:flex;}
.dlg-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:310px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.dlg-box h3{font-size:15px;margin-bottom:9px;}
.dlg-box p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px;}
.dlg-btns{display:flex;gap:9px;}
.dlg-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
.dlg-cancel{background:var(--card2);color:var(--text);}
.dlg-ok{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
.dlg-danger{background:var(--danger);color:#fff;}
.inp-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.inp-ov.show{display:flex;}
.inp-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:340px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.inp-box h3{font-size:15px;margin-bottom:13px;}
.inp-box input,.inp-box textarea{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin-bottom:13px;font-family:inherit;
}
.inp-box textarea{min-height:70px;resize:vertical;}
.inp-btns{display:flex;gap:9px;}
.inp-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}

/* Scrollbar */
/* CHAPTER LIST OVERLAY */
.ch-ov{
display:none;position:fixed;inset:0;z-index:550;
background:rgba(0,0,0,.55);align-items:flex-end;justify-content:center;
}
.ch-ov.show{display:flex;}
.ch-panel{
background:var(--card);border-radius:18px 18px 0 0;
width:100%;max-width:500px;max-height:70vh;
padding:0;overflow:hidden;animation:slideUp .3s ease;
display:flex;flex-direction:column;
}
.ch-panel-hdr{
padding:16px 18px 12px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ch-panel-hdr h3{font-size:15px;font-weight:700;}
.ch-panel-hdr span{font-size:11px;color:var(--text2);}
.ch-panel-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;border-radius:8px;
}
.ch-panel-list{
padding:12px 18px 20px;overflow-y:auto;flex:1;
display:flex;flex-direction:column;gap:0;
}
.ch-item{
padding:13px 16px;border-radius:0;border:none;border-bottom:1px solid var(--border);
background:var(--bg);color:var(--text2);font-size:13px;
text-align:left;cursor:pointer;transition:all .3s;
display:flex;flex-direction:row;align-items:center;gap:12px;
}
.ch-item:last-child{border-bottom:none;}
.ch-item:active{transform:scale(.95);}
.ch-item.act{background:rgba(108,92,231,.1);color:var(--accent2);border-bottom-color:var(--border);}
.ch-item .ch-item-num{font-size:14px;font-weight:700;}
.ch-item .ch-item-wc{font-size:9px;opacity:.7;}
/* CREATE PAGE */
.cr-tabs{display:flex;padding:4px 18px;gap:0;}
.cr-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.cr-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.cr-list{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.cr-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.cr-card:active{transform:scale(.98);}
.cr-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.cr-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cr-card-badge{padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;}
.cr-card-badge.draft{background:rgba(255,165,0,.15);color:#f0a030;}
.cr-card-badge.novel{background:rgba(108,92,231,.15);color:var(--accent2);}
.cr-card-pv{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cr-card-ft{display:flex;justify-content:space-between;align-items:center;}
.cr-card-info{font-size:9px;color:var(--text2);}
.cr-card-acts{display:flex;gap:5px;}
.cr-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.cr-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.cr-new-bar{padding:8px 18px;display:flex;gap:8px;}
.cr-new-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.cr-new-bar button:active{transform:scale(.97);}

/* EDITOR MODAL */
/* IMMERSIVE MODE */
.ed-modal.immersive{background:#0a0a0f;} body.theme-light .ed-modal.immersive{background:#f8f8fc;} body.theme-light .ed-modal.immersive .ed-textarea{color:#1a1a2e;}
.ed-modal.immersive .ed-hdr{display:none;}
.ed-modal.immersive .ed-acts{display:none;}
.ed-modal.immersive .ed-ch-bar{display:none;}
.ed-modal.immersive .ed-footer{
position:fixed;bottom:0;left:0;right:0;
background:rgba(10,10,15,.9);backdrop-filter:blur(10px);
border-top:1px solid rgba(108,92,231,.2);
}
.ed-modal.immersive .ed-body{padding:20px 24px 80px;}
.ed-modal.immersive .ed-textarea{
background:transparent;border:none;
font-size:18px;line-height:2.2;
min-height:calc(100vh - 100px);
}
.ed-modal.immersive .ed-textarea:focus{border:none;box-shadow:none;}
.immersive-exit{
position:fixed;top:16px;right:16px;z-index:100;
padding:8px 14px;border-radius:20px;
background:rgba(108,92,231,.2);border:1px solid var(--accent);
color:var(--accent2);font-size:11px;cursor:pointer;
display:none;
}
.ed-modal.immersive .immersive-exit{display:block;}
.ed-modal{
display:none;position:fixed;inset:0;z-index:510;
background:var(--bg);overflow-y:auto;
}
.cr-bg{
position:fixed;inset:0;z-index:0;
background-size:cover;background-position:center;
opacity:.35;pointer-events:none;display:none;
}
.ed-modal.show{display:block;animation:slideUp .3s ease;}
.ed-hdr{
position:sticky;top:0;z-index:10;background:rgba(15,15,20,.9);
padding:10px 14px;display:flex;align-items:center;
border-bottom:none;gap:8px;
}
.ed-back{
display:flex;align-items:center;gap:4px;background:none;
border:none;color:var(--accent2);font-size:12px;cursor:pointer;padding:4px;flex-shrink:0;
}
.ed-back svg{width:16px;height:16px;}
.ed-title-input{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;font-weight:700;outline:none;
}
.ed-title-input:focus{border-color:var(--accent);}
.ed-acts{
display:flex;gap:6px;padding:8px 14px;
overflow-x:auto;-webkit-overflow-scrolling:touch;
border-bottom:1px solid var(--border);
background:var(--card);
}
.ed-acts::-webkit-scrollbar{display:none;}
.ed-acts button{
flex-shrink:0;padding:6px 12px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;display:flex;align-items:center;gap:4px;
}
.ed-acts button:active{transform:scale(.95);background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-bar{
padding:8px 14px;display:flex;gap:6px;align-items:center;
border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;
}
.ed-ch-bar::-webkit-scrollbar{display:none;}
.ed-ch-btn{
padding:5px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;transition:all .3s;
}
.ed-ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-add{
padding:5px 10px;border-radius:8px;border:1px dashed var(--border);
background:transparent;color:var(--accent2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;
}
.ed-body{padding:14px;position:relative;z-index:1;}
.ed-textarea{
width:100%;min-height:calc(100vh - 200px);padding:16px 20px;
border-radius:0;border:none;
background:transparent;color:var(--text);
font-size:var(--rd-fontsize,15px);line-height:var(--rd-lineheight,2);
outline:none;resize:none;font-family:inherit;
}
.ed-textarea:focus{border:none;box-shadow:none;}
.ed-textarea::placeholder{color:var(--text2);}
.ed-footer{
padding:10px 14px;border-top:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
font-size:10px;color:var(--text2);
}
.ed-wc{font-weight:600;color:var(--accent2);}

/* AI REVIEW PANEL */
.ai-review-ov{
display:none;position:fixed;inset:0;z-index:570;
background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:20px;
}
.ai-review-ov.show{display:flex;}
.ai-review-box{
background:var(--card);border-radius:16px;padding:0;
width:100%;max-width:400px;max-height:80vh;
border:1px solid var(--border);overflow:hidden;
display:flex;flex-direction:column;animation:fadeIn .25s ease;
}
.ai-review-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ai-review-hdr h3{font-size:14px;font-weight:700;}
.ai-review-body{
padding:16px;overflow-y:auto;flex:1;
font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.ai-review-ft{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;text-align:right;
}
.ai-review-ft button{
padding:8px 20px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
}
/* RESOURCE PAGE */
.res-bar{padding:10px 18px;display:flex;gap:8px;}
.res-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.res-bar button:active{transform:scale(.97);}
.res-tabs{display:flex;padding:4px 18px;gap:0;}
.res-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.res-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.res-list{padding:8px 18px;display:flex;flex-direction:column;gap:10px;}
.res-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;
}
.res-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.res-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;}
.res-card-type{
padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;
}
.res-card-type.char{background:rgba(108,92,231,.15);color:var(--accent2);}
.res-card-type.world{background:rgba(39,174,96,.15);color:var(--success);}
.res-card-type.style{background:rgba(230,126,34,.15);color:#e67e22;}
.res-card-type.work{background:rgba(52,152,219,.15);color:#3498db;}
.res-card-type.exp{background:rgba(241,196,15,.15);color:#f1c40f;} .res-card-type.rule{background:rgba(155,89,182,.15);color:#9b59b6;}
.ch-outline-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.ch-outline-item-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.ch-outline-item-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.ch-outline-item textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;min-height:60px;resize:vertical;font-family:inherit;line-height:1.6;}
.ch-outline-item textarea:focus{border-color:var(--accent);outline:none;}
.ch-outline-item textarea::placeholder{color:var(--text2);}
.res-card-pv{
font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.res-card-ft{display:flex;justify-content:space-between;align-items:center;}
.res-card-info{font-size:9px;color:var(--text2);}
.res-card-acts{display:flex;gap:5px;}
.res-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.res-card-acts button.use{color:var(--accent2);border-color:var(--accent);}
.res-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}

/* RESOURCE EXPORT DIALOG */
.res-exp-ov{
display:none;position:fixed;inset:0;z-index:810;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:20px;
}
.res-exp-ov.show{display:flex;}
.res-exp-box{
background:var(--card);border-radius:16px;padding:20px;
width:100%;max-width:360px;border:1px solid var(--border);
animation:fadeIn .25s ease;max-height:85vh;overflow-y:auto;
}
.res-exp-box h3{font-size:15px;margin-bottom:14px;}
.res-chk-item{
display:flex;align-items:center;gap:10px;padding:10px 12px;
background:var(--bg);border-radius:9px;border:1px solid var(--border);
margin-bottom:8px;cursor:pointer;transition:all .3s;
}
.res-chk-item.checked{border-color:var(--accent);background:rgba(108,92,231,.06);}
.res-chk-box{
width:18px;height:18px;border-radius:5px;border:2px solid var(--border);
display:flex;align-items:center;justify-content:center;flex-shrink:0;
font-size:11px;color:#fff;transition:all .3s;
}
.res-chk-item.checked .res-chk-box{background:var(--accent);border-color:var(--accent);}
.res-chk-info{flex:1;}
.res-chk-name{font-size:12px;font-weight:600;}
.res-chk-desc{font-size:9px;color:var(--text2);margin-top:2px;}
.res-exp-input{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin:10px 0;
}
.res-exp-input:focus{border-color:var(--accent);}
.res-exp-btns{display:flex;gap:9px;margin-top:14px;}
.res-exp-btns button{
flex:1;padding:10px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
/* NOTE PANEL */
.note-ov{
display:none;position:fixed;inset:0;z-index:560;
background:rgba(0,0,0,.45);
}
.note-ov.show{display:block;}
.note-panel{
position:fixed;top:0;right:-320px;bottom:0;z-index:561;
width:300px;max-width:85vw;
background:linear-gradient(180deg,var(--card) 0%,rgba(108,92,231,.03) 100%);
border-left:1px solid rgba(108,92,231,.2);
display:flex;flex-direction:column;
transition:right .35s cubic-bezier(.4,0,.2,1);
box-shadow:-8px 0 30px rgba(0,0,0,.35),-2px 0 10px rgba(108,92,231,.1);
}
.note-ov.show .note-panel{right:0;}
.note-hdr{
padding:16px 18px;
border-bottom:1px solid rgba(108,92,231,.15);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
background:linear-gradient(135deg,rgba(108,92,231,.08),rgba(162,155,254,.04));
}
.note-hdr h3{
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.note-hdr h3{font-size:14px;font-weight:700;}
.note-hdr span{font-size:10px;color:var(--text2);}
.note-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;
}
.note-list{
flex:1;overflow-y:auto;padding:12px 16px;
display:flex;flex-direction:column;gap:10px;
}
.note-empty{
text-align:center;padding:50px 20px;color:var(--text2);font-size:13px;
line-height:1.8;
}
.note-empty::before{
content:'📝';display:block;font-size:36px;margin-bottom:12px;
opacity:.4;
}
.note-item{
background:linear-gradient(135deg,var(--bg) 0%,rgba(108,92,231,.03) 100%);
border-radius:14px;padding:14px 16px;
border:1px solid var(--border);position:relative;
transition:all .3s cubic-bezier(.4,0,.2,1);
box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.note-item:active{
transform:scale(.98);
border-color:var(--accent);
box-shadow:0 2px 12px rgba(108,92,231,.15);
}
.note-item-text{ font-size:13px;line-height:1.8;color:var(--text); white-space:pre-wrap;word-wrap:break-word; letter-spacing:.02em; } .note-item-text::first-line{ font-weight:500; }
.note-item-ft{
display:flex;justify-content:space-between;align-items:center;
margin-top:7px;
}
.note-item-time{font-size:9px;color:var(--text2);}
.note-item-del{
background:none;border:none;color:var(--danger);font-size:9px;
cursor:pointer;padding:2px 6px;border-radius:5px;
border:1px solid rgba(255,107,107,.3);
}
.note-input-wrap{
padding:14px 16px 18px;
border-top:1px solid rgba(108,92,231,.15);
flex-shrink:0;
background:linear-gradient(180deg,transparent,rgba(108,92,231,.03));
}
.note-input-row{display:flex;gap:8px;}
.note-input-row textarea{
flex:1;padding:9px 12px;border-radius:10px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
resize:none;min-height:38px;max-height:100px;
font-family:inherit;line-height:1.5;
}
.note-input-row textarea:focus{border-color:var(--accent);}
.note-input-row textarea::placeholder{color:var(--text2);}
.note-send{
padding:10px 18px;border-radius:12px;border:none;
background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 50%,var(--accent) 100%);
background-size:200% 100%;
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
align-self:flex-end;white-space:nowrap;
box-shadow:0 3px 10px rgba(108,92,231,.3);
transition:all .3s;
}
.note-send:active{
transform:scale(.92);
box-shadow:0 1px 4px rgba(108,92,231,.3);
}
@keyframes noteSlideIn{
from{opacity:0;transform:translateX(30px);}
to{opacity:1;transform:translateX(0);}
}
.note-dot{
display:inline-block;width:6px;height:6px;border-radius:50%;
background:var(--accent2);margin-left:4px;vertical-align:middle;
}
.note-tag-btn{
transition:all .25s cubic-bezier(.4,0,.2,1)!important;
}
.note-tag-btn:active{
transform:scale(.92);
}
.note-sel-tag{
transition:all .25s cubic-bezier(.4,0,.2,1)!important;
}
.note-sel-tag:active{
transform:scale(.9);
}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.rd-para{transition:background .3s;border-radius:4px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:pan-y;will-change:background;}
/* TTS 语音朗读 */
.tts-bar{
position:fixed;bottom:60px;left:0;right:0;z-index:30;
background:rgba(26,26,36,.95);backdrop-filter:blur(12px);
padding:12px 18px;display:none;
border-top:1px solid var(--border);
flex-direction:column;gap:10px;
}
.tts-bar.show{display:flex;}
.tts-bar-row{display:flex;align-items:center;gap:10px;}
.tts-bar-btns{display:flex;gap:6px;}
.tts-bar-btns button{
padding:8px 14px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:11px;cursor:pointer;
transition:all .3s;display:flex;align-items:center;gap:4px;
}
.tts-bar-btns button:active{transform:scale(.95);}
.tts-bar-btns button.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.tts-bar-progress{
flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;
}
.tts-bar-progress-inner{
height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));
transition:width .3s;
}
.tts-bar-info{font-size:10px;color:var(--text2);white-space:nowrap;}
.tts-settings{
background:var(--card);border-radius:10px;padding:10px 12px;
border:1px solid var(--border);display:none;
}
.tts-settings.show{display:block;}
.tts-s-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.tts-s-row:last-child{margin-bottom:0;}
.tts-s-label{font-size:10px;color:var(--text2);width:45px;flex-shrink:0;}
.tts-s-row select{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:11px;outline:none;
}
.tts-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.tts-s-val{font-size:10px;color:var(--accent2);width:30px;text-align:right;}
.tts-highlight{background:rgba(108,92,231,.25);border-radius:3px;}
/* 故事转盘样式 - 全屏美化版 */
.wheel-modal{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow:hidden;
flex-direction:column;
}
.wheel-modal.show{display:flex;animation:slideUp .3s ease;}

.wheel-modal-hdr{
position:sticky;top:0;z-index:10;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.08));
backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);
padding:14px 18px;
display:flex;align-items:center;gap:12px;
border-bottom:1px solid rgba(108,92,231,.2);
}
.wheel-back{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;
display:flex;align-items:center;gap:5px;
}
.wheel-back svg{width:18px;height:18px;}
.wheel-modal-hdr h2{flex:1;font-size:18px;font-weight:700;margin:0;}
.wheel-hdr-acts{display:flex;gap:6px;}
.wheel-hdr-acts button{
padding:6px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:11px;cursor:pointer;
transition:all .2s;
}
.wheel-hdr-acts button:active{transform:scale(.95);border-color:var(--accent);}

.wheel-modal-body{
flex:1;overflow-y:auto;padding:16px;
background:linear-gradient(180deg,rgba(108,92,231,.02) 0%,transparent 100%);
}

.wheel-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
gap:16px;
}

/* 转盘卡片 */
.wheel-card{
background:linear-gradient(145deg,var(--card) 0%,rgba(108,92,231,.08) 100%);
border:1px solid var(--border);
border-radius:16px;
padding:16px;
transition:all .3s;
box-shadow:0 4px 15px rgba(0,0,0,.1);
}
.wheel-card:hover{
transform:translateY(-2px);
border-color:var(--accent);
box-shadow:0 8px 25px rgba(108,92,231,.15);
}

.wheel-card-hdr{
display:flex;justify-content:space-between;align-items:center;
margin-bottom:12px;padding-bottom:10px;
border-bottom:1px solid var(--border);
}
.wheel-card-title{
font-size:15px;font-weight:700;color:var(--text);
display:flex;align-items:center;gap:6px;
}
.wheel-card-title::before{content:'🎡';font-size:16px;}
.wheel-card-meta{
display:flex;gap:8px;font-size:10px;color:var(--text2);margin-top:4px;
}
.wheel-card-meta span{
padding:2px 6px;background:var(--card2);border-radius:4px;
}
.wheel-card-acts{display:flex;gap:4px;}
.wheel-card-acts button{
width:28px;height:28px;border-radius:8px;
border:1px solid var(--border);background:var(--card);
color:var(--text2);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;
transition:all .2s;
}
.wheel-card-acts button:hover{border-color:var(--accent);color:var(--accent2);}
.wheel-card-acts button.del:hover{border-color:var(--danger);color:var(--danger);}

/* 转盘主体 */
.wheel-display{
position:relative;
height:200px;
display:flex;align-items:center;justify-content:center;
margin:12px 0;
background:radial-gradient(circle at center,rgba(108,92,231,.08) 0%,transparent 70%);
border-radius:12px;
}

.wheel-container{
position:relative;
width:170px;height:170px;
}

.wheel-outer-ring{
position:absolute;inset:-8px;
border:3px dashed rgba(108,92,231,.3);
border-radius:50%;
animation:ringRotate 20s linear infinite;
}
@keyframes ringRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

.wheel-circle{
width:100%;height:100%;
border-radius:50%;
will-change:transform;
-webkit-backface-visibility:hidden;
backface-visibility:hidden;
background:conic-gradient(from 0deg,
var(--accent) 0deg 30deg,
rgba(108,92,231,.7) 30deg 60deg,
var(--accent2) 60deg 90deg,
rgba(162,155,254,.7) 90deg 120deg,
var(--accent) 120deg 150deg,
rgba(108,92,231,.7) 150deg 180deg,
var(--accent2) 180deg 210deg,
rgba(162,155,254,.7) 210deg 240deg,
var(--accent) 240deg 270deg,
rgba(108,92,231,.7) 270deg 300deg,
var(--accent2) 300deg 330deg,
rgba(162,155,254,.7) 330deg 360deg
);
position:relative;
transition:transform 4s cubic-bezier(.17,.67,.12,.99);
box-shadow:0 0 30px rgba(108,92,231,.3),inset 0 0 20px rgba(0,0,0,.2);
}

.wheel-pointer{
position:absolute;top:-12px;left:50%;transform:translateX(-50%);
width:0;height:0;
border-left:12px solid transparent;
border-right:12px solid transparent;
border-top:20px solid var(--accent);
z-index:10;
filter:drop-shadow(0 3px 6px rgba(108,92,231,.5));
}
.wheel-pointer::after{
content:'';position:absolute;
top:-24px;left:-6px;
width:12px;height:8px;
background:var(--accent2);
border-radius:3px 3px 0 0;
}

.wheel-center{
position:absolute;top:50%;left:50%;
transform:translate(-50%,-50%);
width:50px;height:50px;
border-radius:50%;
background:linear-gradient(135deg,var(--card) 0%,var(--card2) 100%);
border:3px solid var(--accent);
display:flex;align-items:center;justify-content:center;
font-size:20px;
z-index:5;
box-shadow:0 4px 15px rgba(0,0,0,.2);
}

/* 转盘选项标签 */
.wheel-options-preview{
display:flex;flex-wrap:wrap;gap:4px;
margin-top:10px;max-height:60px;overflow:hidden;
}
.wheel-opt-tag{
padding:3px 8px;border-radius:10px;
font-size:10px;
background:var(--card2);
color:var(--text);
border:1px solid var(--border);
}
.wheel-opt-tag.used{
background:rgba(150,150,150,.2);
color:var(--text2);
text-decoration:line-through;
opacity:.6;
}

/* 单个转盘结果 */
.wheel-spin-result{
margin-top:12px;padding:12px;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.1));
border:1px solid var(--accent);
border-radius:10px;
text-align:center;
animation:resultPop .3s ease;
}
@keyframes resultPop{
0%{transform:scale(.8);opacity:0}
50%{transform:scale(1.05)}
100%{transform:scale(1);opacity:1}
}
.wheel-spin-result-label{
font-size:10px;color:var(--text2);margin-bottom:4px;
}
.wheel-spin-result-value{
font-size:14px;font-weight:700;
color:var(--accent2);
}

/* 结果面板 */
.wheel-result-panel{
margin-top:20px;
background:linear-gradient(135deg,var(--card) 0%,rgba(108,92,231,.1) 100%);
border:2px solid var(--accent);
border-radius:16px;
padding:18px;
animation:resultPop .4s ease;
}
.wheel-result-header{
display:flex;align-items:center;gap:8px;
font-size:14px;font-weight:700;color:var(--accent2);
margin-bottom:12px;
}
.wheel-result-icon{font-size:20px;}
.wheel-result-tags{
display:flex;flex-wrap:wrap;gap:8px;
margin-bottom:14px;
}
.wheel-result-tag{
padding:8px 16px;
border-radius:20px;
font-size:12px;font-weight:600;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;
box-shadow:0 3px 10px rgba(108,92,231,.3);
animation:tagPop .3s ease backwards;
}
.wheel-result-tag:nth-child(1){animation-delay:.1s}
.wheel-result-tag:nth-child(2){animation-delay:.2s}
.wheel-result-tag:nth-child(3){animation-delay:.3s}
.wheel-result-tag:nth-child(4){animation-delay:.4s}
.wheel-result-tag:nth-child(5){animation-delay:.5s}
@keyframes tagPop{
0%{transform:scale(0) rotate(-10deg);opacity:0}
100%{transform:scale(1) rotate(0);opacity:1}
}
.wheel-result-actions{display:flex;gap:10px;}

/* 故事面板 */
.wheel-story-panel{
margin-top:16px;
background:var(--card);
border:1px solid var(--border);
border-radius:14px;
padding:16px;
}
.wheel-story-header{
font-size:13px;font-weight:700;color:var(--accent2);
margin-bottom:10px;padding-bottom:8px;
border-bottom:1px solid var(--border);
}
.wheel-story-content{
font-size:13px;line-height:1.9;color:var(--text);
white-space:pre-wrap;word-wrap:break-word;
max-height:200px;overflow-y:auto;
margin-bottom:12px;
}
.wheel-story-actions{display:flex;gap:10px;}

/* 按钮样式 */
.wheel-btn-primary{
flex:1;padding:10px 16px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
transition:all .2s;
box-shadow:0 3px 10px rgba(108,92,231,.3);
}
.wheel-btn-primary:hover{transform:translateY(-1px);box-shadow:0 5px 15px rgba(108,92,231,.4);}
.wheel-btn-primary:active{transform:scale(.98);}
.wheel-btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;}

.wheel-btn-secondary{
flex:1;padding:10px 16px;border-radius:10px;
border:1px solid var(--border);
background:var(--card);color:var(--text);
font-size:12px;font-weight:500;cursor:pointer;
transition:all .2s;
}
.wheel-btn-secondary:hover{border-color:var(--accent);color:var(--accent2);}
.wheel-btn-secondary:active{transform:scale(.98);}

/* 底部操作栏 */
.wheel-modal-footer{
padding:16px 18px 20px;
background:linear-gradient(180deg,transparent,rgba(108,92,231,.05));
border-top:1px solid var(--border);
}
.wheel-spin-btn{
width:100%;padding:14px 20px;
border-radius:14px;border:none;
background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 50%,var(--accent) 100%);
background-size:200% 100%;
color:#fff;font-size:15px;font-weight:700;
cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:10px;
transition:all .3s;
box-shadow:0 4px 20px rgba(108,92,231,.4);
animation:btnShine 3s ease infinite;
}
@keyframes btnShine{
0%,100%{background-position:0% 50%}
50%{background-position:100% 50%}
}
.wheel-spin-btn:hover{
transform:translateY(-2px);
box-shadow:0 6px 25px rgba(108,92,231,.5);
}
.wheel-spin-btn:active{transform:scale(.98);}
.wheel-spin-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;animation:none;}
.wheel-spin-icon{font-size:20px;animation:iconBounce 1s ease infinite;}
@keyframes iconBounce{
0%,100%{transform:rotate(0deg)}
25%{transform:rotate(-10deg)}
75%{transform:rotate(10deg)}
}

/* 空状态 */
.wheel-empty{
text-align:center;padding:60px 20px;
color:var(--text2);
}
.wheel-empty-icon{font-size:48px;margin-bottom:16px;opacity:.5;}
.wheel-empty-text{font-size:13px;line-height:1.8;}
.wheel-empty-btn{
margin-top:20px;padding:12px 24px;
border-radius:12px;border:2px dashed var(--accent);
background:transparent;color:var(--accent2);
font-size:13px;font-weight:600;cursor:pointer;
transition:all .2s;
}
.wheel-empty-btn:hover{background:rgba(108,92,231,.1);}

/* 浅色主题适配 */
body.theme-light .wheel-modal-hdr{
background:linear-gradient(135deg,rgba(108,92,231,.1),rgba(162,155,254,.05));
}
body.theme-light .wheel-card{
background:linear-gradient(145deg,#fff 0%,rgba(108,92,231,.05) 100%);
}
body.theme-light .wheel-opt-tag{
background:#f0f0f5;color:#333;
}
/* 伏笔追踪器样式 */
.fs-item{background:var(--card);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--border);transition:all .2s}
.fs-item:hover{border-color:var(--accent)}
.fs-item.pending{border-left:3px solid #f0a030}
.fs-item.done{border-left:3px solid var(--success);opacity:.7}
.fs-item-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.fs-item-content{font-size:12px;line-height:1.6;color:var(--text)}
.fs-item-meta{font-size:10px;color:var(--text2);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
.fs-item-acts{display:flex;gap:4px;margin-top:8px}
.fs-item-acts button{padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:10px;cursor:pointer}
.fs-item-acts button:hover{border-color:var(--accent);color:var(--accent2)}
.fs-item-acts button.done-btn{border-color:var(--success);color:var(--success)}
.fs-item-acts button.del-btn{border-color:rgba(255,107,107,.3);color:var(--danger)}
/* 星笺聊天页面 */
.xj-modal{
display:none;position:fixed;inset:0;z-index:520;
background:var(--bg);overflow:hidden;
flex-direction:column;
}
.xj-modal.show{display:flex;}
.xj-bg{
position:absolute;inset:0;z-index:0;
background-size:cover;background-position:center;
background-size:cover;background-position:center;
opacity:.3;pointer-events:none;
}
.xj-hdr{
position:relative;z-index:1;
padding:14px 18px;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.1));
backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);
border-bottom:1px solid rgba(108,92,231,.2);
display:flex;align-items:center;gap:12px;
}
.xj-back{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;
display:flex;align-items:center;gap:5px;
}
.xj-back svg{width:18px;height:18px;}
.xj-avatar{
width:42px;height:42px;border-radius:50%;
background:linear-gradient(135deg,#6c5ce7,#a29bfe);
padding:3px;flex-shrink:0;
}
.xj-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.xj-info{flex:1;}
.xj-name{font-size:15px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
.xj-name span{color:var(--accent2);}
.xj-status{font-size:10px;color:var(--text2);margin-top:2px;}
.xj-status::before{
content:'';display:inline-block;width:6px;height:6px;
border-radius:50%;background:#51cf66;margin-right:4px;
}
.xj-clear{
padding:6px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
}
.xj-body{
flex:1;overflow-y:auto;padding:16px;position:relative;z-index:1;
display:flex;flex-direction:column;gap:12px;
}
.xj-msg{
max-width:80%;padding:12px 16px;border-radius:18px;
font-size:14px;line-height:1.7;word-wrap:break-word;
animation:msgIn .3s ease;
}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.xj-msg.xj{
align-self:flex-start;
background:linear-gradient(135deg,rgba(108,92,231,.9),rgba(138,128,237,.85));
color:#fff;border-bottom-left-radius:6px;
box-shadow:0 3px 12px rgba(108,92,231,.3);
}
.xj-msg.user{
align-self:flex-end;
background:linear-gradient(135deg,rgba(88,166,255,.9),rgba(100,180,255,.85));
color:#fff;border-bottom-right-radius:6px;
box-shadow:0 3px 12px rgba(88,166,255,.3);
}
.xj-msg .xj-time{
display:block;font-size:9px;opacity:.7;margin-top:6px;
}
.xj-msg.xj .xj-time{text-align:left;}
.xj-msg.user .xj-time{text-align:right;}
.xj-typing{
align-self:flex-start;
padding:12px 16px;border-radius:18px;border-bottom-left-radius:6px;
background:linear-gradient(135deg,rgba(108,92,231,.9),rgba(138,128,237,.85));
display:flex;align-items:center;gap:4px;
}
.xj-typing span{
width:6px;height:6px;border-radius:50%;background:#fff;
animation:typingDot 1.4s infinite both;
}
.xj-typing span:nth-child(2){animation-delay:.2s;}
.xj-typing span:nth-child(3){animation-delay:.4s;}
@keyframes typingDot{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
.xj-input-wrap{
position:relative;z-index:1;
padding:12px 16px 16px;
background:linear-gradient(180deg,transparent,rgba(15,15,20,.8));
backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
border-top:1px solid rgba(108,92,231,.15);
}
.xj-input-row{display:flex;gap:10px;align-items:flex-end;}
.xj-input{
flex:1;padding:12px 16px;border-radius:22px;
border:1px solid rgba(108,92,231,.3);
background:rgba(26,26,36,.8);
color:var(--text);font-size:14px;outline:none;
resize:none;min-height:44px;max-height:120px;
font-family:inherit;line-height:1.5;
transition:border-color .3s;
}
.xj-input:focus{border-color:var(--accent);}
.xj-input::placeholder{color:var(--text2);}
.xj-send{
width:44px;height:44px;border-radius:50%;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:18px;cursor:pointer;
display:flex;align-items:center;justify-content:center;
box-shadow:0 3px 12px rgba(108,92,231,.4);
transition:transform .2s,box-shadow .2s;
flex-shrink:0;
}
.xj-send:active{transform:scale(.9);}
.xj-send:disabled{opacity:.5;cursor:not-allowed;}
/* 消息操作菜单 */
.xj-msg-menu{
position:fixed;z-index:900;
background:var(--card);border:1px solid var(--border);
border-radius:12px;padding:6px 0;
box-shadow:0 4px 20px rgba(0,0,0,.3);
min-width:120px;
animation:fadeIn .2s ease;
}
.xj-msg-menu-item{
padding:10px 16px;font-size:13px;color:var(--text);
cursor:pointer;display:flex;align-items:center;gap:8px;
transition:background .2s;
}
.xj-msg-menu-item:hover,.xj-msg-menu-item:active{
background:rgba(108,92,231,.1);
}
.xj-msg-menu-item.danger{color:var(--danger);}
.xj-msg.editing{
border:2px solid var(--accent);
background:rgba(108,92,231,.1)!important;
}
.xj-msg.editing textarea{
width:100%;min-height:60px;padding:8px;
border:none;background:transparent;
color:inherit;font-size:inherit;line-height:inherit;
resize:none;outline:none;font-family:inherit;
}
.xj-edit-btns{
display:flex;gap:6px;margin-top:8px;justify-content:flex-end;
}
.xj-edit-btns button{
padding:5px 12px;border-radius:8px;font-size:11px;cursor:pointer;
border:1px solid var(--border);background:var(--card);color:var(--text);
}
.xj-edit-btns button.primary{
background:var(--accent);color:#fff;border-color:var(--accent);
}
.xj-welcome{
text-align:center;padding:20px;color:var(--text2);font-size:12px;
}
.xj-welcome img{
width:80px;height:80px;border-radius:50%;margin-bottom:12px;
border:3px solid rgba(108,92,231,.3);
}
body.theme-light .xj-input{background:rgba(255,255,255,.9);border-color:rgba(108,92,231,.2);}
body.theme-light .xj-input-wrap{background:linear-gradient(180deg,transparent,rgba(245,245,248,.9));}
#addFsOv{z-index:850;} /* 创作目标 */ .goal-panel{padding:14px 18px;} .goal-card{ background:var(--card);border-radius:16px;padding:18px; border:1px solid var(--border);margin-bottom:12px; } .goal-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;} .goal-card-hdr h3{font-size:14px;font-weight:700;} .goal-progress{ height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin:10px 0 6px; } .goal-progress-bar{ height:100%;border-radius:4px;transition:width .5s ease; background:linear-gradient(90deg,var(--accent),var(--accent2)); } .goal-progress-bar.done{background:linear-gradient(90deg,var(--success),#2ecc71);} .goal-stat{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);} .goal-stat .cur{color:var(--accent2);font-weight:600;} .goal-stat .cur.done{color:var(--success);} .goal-input-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;} .goal-input-row label{font-size:11px;color:var(--text2);width:70px;flex-shrink:0;} .goal-input-row input{ flex:1;padding:8px 12px;border-radius:9px; border:1px solid var(--border);background:var(--bg); color:var(--text);font-size:12px;outline:none; } .goal-input-row input:focus{border-color:var(--accent);} .goal-tabs{display:flex;gap:0;margin-bottom:12px;} .goal-tab{ flex:1;padding:8px;text-align:center;font-size:12px;font-weight:600; cursor:pointer;border:none;border-bottom:2px solid transparent; color:var(--text2);background:none;transition:all .3s; } .goal-tab.act{color:var(--accent2);border-bottom-color:var(--accent);} .goal-history{max-height:200px;overflow-y:auto;} .goal-history-item{ padding:10px 12px;background:var(--bg);border-radius:9px; border:1px solid var(--border);margin-bottom:6px; display:flex;justify-content:space-between;align-items:center; } .goal-history-item .done-badge{ padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600; background:rgba(81,207,102,.15);color:var(--success); } .goal-history-item .fail-badge{ padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600; background:rgba(255,107,107,.15);color:var(--danger); } /* 达标祝贺弹窗 */ .goal-celebrate{ position:fixed;inset:0;z-index:9000; background:rgba(0,0,0,.6); display:none;align-items:center;justify-content:center;padding:20px; } .goal-celebrate.show{display:flex;} .goal-celebrate-box{ background:linear-gradient(135deg,var(--card) 0%,rgba(108,92,231,.15) 100%); border:2px solid var(--accent);border-radius:24px;padding:30px 24px; text-align:center;max-width:320px;width:100%; animation:celebratePop .5s cubic-bezier(.34,1.56,.64,1); box-shadow:0 20px 60px rgba(108,92,231,.3); } @keyframes celebratePop{ 0%{transform:scale(0) rotate(-10deg);opacity:0} 100%{transform:scale(1) rotate(0);opacity:1} } .goal-celebrate-icon{font-size:64px;margin-bottom:12px;} .goal-celebrate-title{font-size:20px;font-weight:800;margin-bottom:8px; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text;-webkit-text-fill-color:transparent;} .goal-celebrate-msg{font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:20px;} .goal-celebrate-btn{ padding:12px 32px;border-radius:14px;border:none; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;font-size:14px;font-weight:600;cursor:pointer; box-shadow:0 4px 15px rgba(108,92,231,.3); }
</style>
</head>
<body>
<div class="splash" id="splash">
<div class="splash-particles" id="splashParticles"></div>
<div class="splash-glow" style="top:20%;left:30%"></div>
<div class="splash-glow" style="bottom:10%;right:20%;animation-delay:-2s"></div>
<div class="splash-decor splash-decor-1"></div>
<div class="splash-decor splash-decor-2"></div>
<div class="splash-corner tl">Created by 心田</div>
<div class="splash-corner br">AI创作工坊</div>
<div class="splash-card">
<div class="splash-icon"><img src="https://i.postimg.cc/0y0h3vyB/retouch-2026022503092567.png" alt="星笺"></div>
<div class="splash-logo">笔记AI</div>
<div class="splash-sub">让灵感落笔成章</div>
<div class="splash-progress"><div class="splash-progress-bar" id="splashBar"></div></div>
<div class="splash-status">
<span class="splash-dot"></span>
<span id="splashTxt">正在初始化...</span>
</div>
</div>
<div class="splash-ver" id="splashVer">v2.8.0</div>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="hdr">
<div class="hdr-left">
<h1><img src="https://i.postimg.cc/SQ1t32R0/retouch-2026022401082081.png" alt="" class="hdr-logo-img">笔记AI</h1>
<div class="hdr-sub">AI创作工坊 · 让灵感落笔成章</div>
</div>
<div class="hdr-right">
<button class="hdr-btn" onclick="openWheelPanel()" title="故事转盘">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M12 2v10l7 7M12 12L5 19"/></svg>
转盘
</button>
<button class="hdr-btn" onclick="openHandbook()" title="手册">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
手册
</button>
<button class="hdr-btn" onclick="quickThemeSwitch()" title="快速切换主题">🎨</button>
</div>
</div>

<!-- WORKSHOP -->
<div class="pg act" id="pg-workshop">
<div class="sbar" style="position:relative">
<input type="text" id="searchInput" placeholder="描述你想要的故事内容..." onkeydown="if(event.key==='Enter'){event.preventDefault();generateArticle();}" oninput="document.getElementById('searchClear').style.display=this.value?'flex':'none'"> <button id="searchClear" style="display:none;position:absolute;right:90px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);font-size:16px;cursor:pointer;padding:4px 8px;z-index:1" onclick="document.getElementById('searchInput').value='';this.style.display='none'">✕</button>
<button class="btn-gen" id="btnGen" onclick="handleGenBtn()">生成</button>
</div>
<div class="tags-sec">
<div class="tags-wrap" id="tagsWrap"></div>
</div>
<div class="ttabs">
<button class="ttab act" onclick="switchType('long',this)">长篇连载</button>
<button class="ttab" onclick="switchType('short',this)">短篇一发</button>
</div>
<div style="padding:2px 18px 6px;display:flex;align-items:center;gap:8px">
<span style="font-size:10px;color:var(--text2);flex-shrink:0">创意度</span>
<input type="range" min="0.3" max="1.5" step="0.1" value="0.8" id="quickTemp" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('qtVal').textContent=this.value;document.getElementById('apiTemp').value=this.value">
<span style="font-size:10px;color:var(--accent2);width:24px;text-align:right" id="qtVal">0.8</span>
<span style="font-size:9px;color:var(--text2)">稳定←→狂野</span>
</div>
<div style="padding:2px 18px 8px">
<button onclick="showSettingPreview()" style="width:100%;padding:8px;border-radius:9px;border:1px dashed var(--border);background:transparent;color:var(--text2);font-size:11px;cursor:pointer;transition:all .2s" onmouseenter="this.style.borderColor='var(--accent)';this.style.color='var(--accent2)'" onmouseleave="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">📋 查看当前生效设定</button>
</div>
<div class="alist" id="articleList">
<div class="empty-st">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
<p>输入描述或选择标签<br>点击「生成」开始创作吧 ✨</p>
</div>
</div>
</div>

<!-- COLLECTION -->
<div class="pg" id="pg-collection">
<div class="col-hdr">
<h2>📚 我的收藏</h2>
<span class="col-cnt" id="colCnt">0 篇</span>
</div>
<div class="col-search">
<input type="text" id="colSearchInput" placeholder="🔍 搜索书名或文章名..." oninput="renderCollections()">
</div>
<div class="sec-div"><h3>长篇书架</h3></div>
<div class="bgrid" id="bookGrid"></div>
<div class="col-shorts">
<h3>短篇收藏</h3>
<div class="slist" id="shortList"></div>
</div>
</div>
<!-- CREATE -->
<div class="pg" id="pg-create">
<div class="cr-new-bar" style="overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;padding-bottom:12px">
<button onclick="newDraft()" style="flex-shrink:0">📄 新建草稿</button>
<button onclick="newNovel()" style="flex-shrink:0">📖 新建小说</button>
<button onclick="openAdvancedCreate()" style="flex-shrink:0;border-color:var(--success);color:var(--success)">🎯 高级创作</button> <button onclick="openAdvLoad()" style="flex-shrink:0;border-color:var(--accent);color:var(--accent2)">📂 加载项目</button>
<button onclick="openOutlineGen()" style="flex-shrink:0;border-color:var(--accent);color:var(--accent2)">🧠 AI大纲</button>
<button onclick="openNameGen()" style="flex-shrink:0;border-color:var(--accent);color:var(--accent2)">✨ AI起名</button>
<button onclick="openBranchGen()" style="flex-shrink:0;border-color:var(--accent);color:var(--accent2)">🌿 情节分支</button>
<button onclick="exportCrToTxt()" style="flex-shrink:0">📥 导出TXT</button>
</div>
<div class="cr-tabs">
<button class="cr-tab act" onclick="switchCrTab('draft',this)">草稿箱</button>
<button class="cr-tab" onclick="switchCrTab('novel',this)">我的小说</button>
<button class="cr-tab" onclick="switchCrTab('goal',this)">创作目标</button>
</div>
<div class="cr-list" id="crList"></div> <div class="goal-panel" id="goalPanel" style="display:none"> <div class="goal-card"> <div class="goal-card-hdr"> <h3>📝 本周目标</h3> <span style="font-size:10px;color:var(--text2)" id="goalWeekRange"></span> </div> <div class="goal-input-row"> <label>目标字数</label> <input type="number" id="goalWeekWords" min="0" step="500" value="5000" placeholder="5000" onchange="saveGoalSettings()"> <span style="font-size:11px;color:var(--text2)">字</span> </div> <div class="goal-input-row"> <label>目标章数</label> <input type="number" id="goalWeekChapters" min="0" step="1" value="3" placeholder="3" onchange="saveGoalSettings()"> <span style="font-size:11px;color:var(--text2)">章</span> </div> <div style="margin-top:10px"> <div style="font-size:11px;color:var(--text2);margin-bottom:4px">字数进度</div> <div class="goal-progress"><div class="goal-progress-bar" id="goalWeekWordsBar"></div></div> <div class="goal-stat"><span class="cur" id="goalWeekWordsCur">0</span><span id="goalWeekWordsTarget">/ 5000 字</span></div> </div> <div style="margin-top:8px"> <div style="font-size:11px;color:var(--text2);margin-bottom:4px">章数进度</div> <div class="goal-progress"><div class="goal-progress-bar" id="goalWeekChBar"></div></div> <div class="goal-stat"><span class="cur" id="goalWeekChCur">0</span><span id="goalWeekChTarget">/ 3 章</span></div> </div> </div> <div class="goal-card"> <div class="goal-card-hdr"> <h3>📅 本月目标</h3> <span style="font-size:10px;color:var(--text2)" id="goalMonthRange"></span> </div> <div class="goal-input-row"> <label>目标字数</label> <input type="number" id="goalMonthWords" min="0" step="1000" value="20000" placeholder="20000" onchange="saveGoalSettings()"> <span style="font-size:11px;color:var(--text2)">字</span> </div> <div class="goal-input-row"> <label>目标章数</label> <input type="number" id="goalMonthChapters" min="0" step="1" value="12" placeholder="12" onchange="saveGoalSettings()"> <span style="font-size:11px;color:var(--text2)">章</span> </div> <div style="margin-top:10px"> <div style="font-size:11px;color:var(--text2);margin-bottom:4px">字数进度</div> <div class="goal-progress"><div class="goal-progress-bar" id="goalMonthWordsBar"></div></div> <div class="goal-stat"><span class="cur" id="goalMonthWordsCur">0</span><span id="goalMonthWordsTarget">/ 20000 字</span></div> </div> <div style="margin-top:8px"> <div style="font-size:11px;color:var(--text2);margin-bottom:4px">章数进度</div> <div class="goal-progress"><div class="goal-progress-bar" id="goalMonthChBar"></div></div> <div class="goal-stat"><span class="cur" id="goalMonthChCur">0</span><span id="goalMonthChTarget">/ 12 章</span></div> </div> </div> <div class="goal-card"> <div class="goal-card-hdr"><h3>📊 创作记录</h3></div> <div style="font-size:11px;color:var(--text2);margin-bottom:8px">仅统计在创作页面手动写作的字数和章节（作坊AI生成不计入）</div> <div class="goal-history" id="goalHistory"></div> <button class="btn-s" onclick="resetGoalProgress()" style="margin-top:10px;border-color:rgba(255,107,107,.3);color:var(--danger)">🗑️ 重置本周/本月进度</button> </div> </div>
</div>
<!-- SETTINGS -->
<div class="pg" id="pg-settings">
<div class="ucard" id="ucard">
<div class="xj-float-btn" onclick="openXingJian()" title="和星笺聊聊">
<img src="https://i.postimg.cc/0y0h3vyB/retouch-2026022503092567.png" alt="星笺">
</div>
<div class="ucard-top">
<div class="ucard-avatar" id="ucAvatar" onclick="uploadAvatar()">
<span id="ucAvatarPh">✦</span>
<div class="ucard-avatar-hint">更换</div>
</div>
<div class="ucard-info">
<div class="ucard-name">
<span id="ucName">点击设置昵称</span>
<button onclick="editUcName()" title="编辑昵称">✏️</button>
</div>
<div class="ucard-bio" id="ucBio" onclick="editUcBio()">点击添加个人简介...</div>
</div>
</div>
<div class="ucard-stats">
<div class="ucard-stat">
<div class="ucard-stat-num" id="statTotal">0</div>
<div class="ucard-stat-label">总字数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statWorks">0</div>
<div class="ucard-stat-label">作品数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statCols">0</div>
<div class="ucard-stat-label">收藏数</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statNotes">0</div>
<div class="ucard-stat-label">笔记数</div>
</div>
</div>
</div>
<input type="file" id="avatarUp" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
<div style="padding:14px 18px 8px"><h2 style="font-size:16px;font-weight:700">⚙️ 设置中心</h2></div>
<div style="padding:0 18px 18px">
<div class="set-entry" onclick="openSetModal('api')">
<div class="set-entry-left"><span class="set-entry-icon">🔑</span><div class="set-entry-info"><h3>API设置</h3><p>配置接口地址、密钥、模型</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('char')">
<div class="set-entry-left"><span class="set-entry-icon">👤</span><div class="set-entry-info"><h3>人物设定</h3><p>创建和管理角色</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('world')">
<div class="set-entry-left"><span class="set-entry-icon">🌍</span><div class="set-entry-info"><h3>世界观设定</h3><p>故事背景与规则</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('style')">
<div class="set-entry-left"><span class="set-entry-icon">✒️</span><div class="set-entry-info"><h3>文风设置</h3><p>写作风格与语言</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('rule')">
<div class="set-entry-left"><span class="set-entry-icon">📜</span><div class="set-entry-info"><h3>规则设置</h3><p>创作限制与要求</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('ban')">
<div class="set-entry-left"><span class="set-entry-icon">🚫</span><div class="set-entry-info"><h3>禁用词设置</h3><p>AI避免使用的词汇</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('theme')">
<div class="set-entry-left"><span class="set-entry-icon">🎨</span><div class="set-entry-info"><h3>页面美化</h3><p>主题、字体、背景</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('notify')">
<div class="set-entry-left"><span class="set-entry-icon">🔔</span><div class="set-entry-info"><h3>铃声与勿扰</h3><p>铃声提示、勿扰模式</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
<div class="set-entry" onclick="openSetModal('data')">
<div class="set-entry-left"><span class="set-entry-icon">📦</span><div class="set-entry-info"><h3>数据管理</h3><p>导入导出、清空数据</p></div></div>
<span class="set-entry-arrow">›</span>
</div>
</div>
</div>
<!-- RESOURCE -->
<div class="pg" id="pg-resource">
<div style="padding:14px 18px 4px"><h2>📦 资源广场</h2><p style="font-size:11px;color:var(--text2);margin-top:4px">打包分享你的设定和创作，导入别人的资源包</p></div>
<div class="res-bar">
<button onclick="openResExport()">📤 打包导出</button>
<button onclick="document.getElementById('resImpFile').click()">📥 导入资源包</button>
<button onclick="writeExpShare()">✍️ 写经验</button>
<input type="file" id="resImpFile" accept=".json" style="display:none" onchange="importResPack(event)">
</div>
<div class="res-tabs">
<button class="res-tab act" onclick="switchResTab('all',this)">全部</button>
<button class="res-tab" onclick="switchResTab('char',this)">人物</button>
<button class="res-tab" onclick="switchResTab('world',this)">世界观</button>
<button class="res-tab" onclick="switchResTab('style',this)">文风</button>
<button class="res-tab" onclick="switchResTab('rule',this)">规则</button>
<button class="res-tab" onclick="switchResTab('work',this)">作品</button>
<button class="res-tab" onclick="switchResTab('exp',this)">经验</button>
</div>
<div class="res-list" id="resList"></div>
</div>
</div><!-- end app -->
<!-- 消息操作菜单 -->
<div class="xj-msg-menu" id="xjMsgMenu" style="display:none">
</div>
<!-- READING MODAL -->
<div class="modal" id="rdModal" role="dialog" aria-label="阅读">
<div class="rd-bg" id="rdBg"></div>
<div class="rd-hdr">
<button class="rd-back" onclick="closeReading()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
返回
</button>
<div class="rd-acts">
<button onclick="toggleRdSettings()" title="阅读设置" aria-label="阅读设置">⚙</button>
<button onclick="toggleFullscreen()" id="btnFS" aria-label="全屏">⛶</button>
<button onclick="copyCurrentArticle()" aria-label="复制全文">📋</button>
<button onclick="copyCurChapter()" title="复制当前章节">📄</button>
<button onclick="openNotePanel()" id="rdNoteBtn">📝</button>
<button onclick="toggleCurrentLike()" id="rdLikeBtn">♡</button> <button onclick="document.getElementById('rdModal').scrollTo({top:0,behavior:'smooth'})" title="回到顶部">⬆</button>
<button onclick="enterImmersiveRead()" title="沉浸阅读">🌙</button>
<button onclick="toggleTtsBar()" id="rdTtsBtn" title="语音朗读">🔊</button>
<button onclick="openArticleRewrite()" title="重写全文">🔄</button>
<button onclick="openForeshadow()" title="伏笔追踪">🎯</button>
</div>
</div>
<div class="rd-body">
  <button class="immersive-exit-float" onclick="exitImmersiveRead()">✕ 退出沉浸</button>
<h1 class="rd-title" id="rdTitle"></h1>
<div class="rd-meta" id="rdMeta"></div>
<div class="rd-settings" id="rdSettingsPanel">
<h4>阅读设置</h4>
<div class="rd-s-row"><span class="rd-s-label">字号</span><input type="range" min="12" max="24" value="15" oninput="setRdFont(this.value)"><span class="rd-s-val" id="rdFontVal">15</span></div>
<div class="rd-s-row"><span class="rd-s-label">行高</span><input type="range" min="1.4" max="3" step="0.1" value="2" oninput="setRdLine(this.value)"><span class="rd-s-val" id="rdLineVal">2</span></div>
</div>
<div class="ch-nav" id="chNav"></div>
<div class="rd-content" id="rdContent"></div>
<div class="cont-wrap" id="contWrap" style="display:none">
<div class="rd-dir-input" id="dirInputWrap">
<input type="text" id="dirInput" placeholder="给下一章的方向提示（可留空）...">
</div>
<div style="display:flex;gap:8px;margin-bottom:12px">
<button class="btn-cont" style="flex:1;background:var(--card);border:1px solid var(--accent);color:var(--accent2)" onclick="openContextEditor()">⚙️ 上下文设置</button>
</div>

<div class="immersive-read-bar" id="immersiveReadBar">
<button onclick="exitImmersiveRead()">✕ 退出</button>
<button onclick="toggleAutoScroll()" id="autoScrollBtn">▶ 自动阅读</button>
<div class="speed-ctrl">
<span>速度</span>
<input type="range" min="1" max="10" value="3" id="scrollSpeed" oninput="updateScrollSpeed()">
<span id="speedVal">3</span>
</div>
<button onclick="immersivePrevCh()">◀ 上一章</button>
<button onclick="immersiveNextCh()">下一章 ▶</button>
</div>
<button class="btn-cont" id="btnCont" onclick="quickContinue()">📝 快速续写</button>
<button class="btn-undo" id="btnUndo" style="display:none" onclick="undoChapter()">↩ 撤销上一章</button>
</div>
<!-- TTS 语音朗读控制栏 -->
<div class="tts-bar" id="ttsBar">
<div class="tts-bar-row">
<div class="tts-bar-btns">
<button onclick="ttsPlayPause()" id="ttsPlayBtn">▶ 朗读</button>
<button onclick="ttsStop()">⏹ 停止</button>
<button onclick="ttsPrevPara()">⏮</button>
<button onclick="ttsNextPara()">⏭</button>
<button onclick="toggleTtsSettings()" id="ttsSettingsBtn">⚙</button>
</div>
<div class="tts-bar-progress"><div class="tts-bar-progress-inner" id="ttsProgress"></div></div>
<span class="tts-bar-info" id="ttsInfo">0/0段</span>
</div>
<div class="tts-settings" id="ttsSettings">
<div class="tts-s-row">
<span class="tts-s-label">语音</span>
<select id="ttsVoiceSelect" onchange="saveTtsSettings()"></select>
</div>
<div class="tts-s-row">
<span class="tts-s-label">语速</span>
<input type="range" min="0.5" max="2" step="0.1" value="1" id="ttsRate" oninput="updateTtsRate()">
<span class="tts-s-val" id="ttsRateVal">1.0</span>
</div>
<div class="tts-s-row">
<span class="tts-s-label">音调</span>
<input type="range" min="0.5" max="2" step="0.1" value="1" id="ttsPitch" oninput="updateTtsPitch()">
<span class="tts-s-val" id="ttsPitchVal">1.0</span>
</div>
</div>
</div>
</div>
</div>

<!-- HANDBOOK -->
<div class="hb-ov" id="hbOv">
<div class="hb-hdr">
<button onclick="closeHandbook()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button>
<h2>📖 使用手册</h2>
</div>
<div class="hb-body">

<h3>一、欢迎使用笔记AI</h3>
<p>笔记AI是一款基于大语言模型的AI创作工坊，帮助你快速生成高质量的小说、散文等文学作品。无论你是新手写作者还是资深创作人，这里都能成为你的灵感引擎和创作伙伴。</p>

<div class="notice">
<p>🎉 <strong>.8.0 更新亮点</strong></p>
<p>· 新增编辑器自动保存草稿（每5秒自动保存）</p>
<p>· 星笺聊天大幅优化（增加时间感知、更自然可爱）</p>
<p>· 右上角新增快速切换主题按钮</p>
<p>· 优化续写逻辑和提示</p>
<p>· 修复若干小问题，提升稳定性</p>
</div>

<h3>二、快速开始（5分钟上手）</h3>

<p><strong>第1步：配置API（必须）</strong></p>
<ul>
<li>点击底部「设置」→「API设置」</li>
<li>填写API地址（如 https://api.openai.com/v1 或其他兼容接口）</li>
<li>填写API密钥（以 sk- 开头的密钥）</li>
<li>模型名称建议填 gpt-4o-mini 或 gpt-4o</li>
<li>点击「测试连接」确认配置正确</li>
</ul>

<p><strong>第2步：开始创作</strong></p>
<ul>
<li>回到「作坊」页面</li>
<li>在输入框描述你想要的故事，比如"校园甜文，学霸女主和体育生男主"</li>
<li>选择「长篇连载」或「短篇一发」</li>
<li>点击「生成」按钮，等待AI创作</li>
</ul>

<p><strong>第3步：收藏与续写</strong></p>
<ul>
<li>生成完成后，点击「♡ 收藏」将作品加入书架</li>
<li>长篇作品收藏后，可以点击「继续连载下一章」让AI续写</li>
</ul>

<h3>三、五大核心页面</h3>

<p><strong>📝 作坊（首页）</strong></p>
<p>AI创作的主战场，所有新作品都从这里诞生。</p>
<ul>
<li><strong>输入框</strong>：描述你想要的故事方向，写得越具体效果越好</li>
<li><strong>标签</strong>：点击选择氛围标签，可以多选，也可以自建标签</li>
<li><strong>长篇/短篇切换</strong>：长篇可以持续续写，短篇一次生成完整故事</li>
<li><strong>创意度滑块</strong>：左边（0.5）更稳定可控，右边（1.2）更天马行空</li>
<li><strong>故事转盘</strong>：点击右上角「转盘」随机组合创意元素</li>
</ul>

<p><strong>📚 收藏（书架）</strong></p>
<p>管理你喜欢的作品，长篇和短篇分开展示。</p>
<ul>
<li><strong>长篇书架</strong>：可以上传封面、设置状态（连载中/已完结/暂停）、打星评分</li>
<li><strong>短篇收藏</strong>：快速浏览和管理短篇作品</li>
<li><strong>搜索</strong>：输入关键词快速找到作品</li>
<li><strong>操作</strong>：复制全文、导出TXT、删除等</li>
</ul>

<p><strong>✏️ 创作（个人写作）</strong></p>
<p>你的私人写作空间，用于手动创作或编辑AI生成的内容。</p>
<ul>
<li><strong>草稿</strong>：单篇文档，适合随手记录灵感</li>
<li><strong>小说</strong>：多章节结构，适合长篇连载</li>
<li><strong>高级创作</strong>：手动设置每章大纲，AI逐章为你创作</li>
<li><strong>AI大纲</strong>：让AI帮你生成故事大纲框架</li>
<li><strong>AI起名</strong>：为角色、书名、地名生成创意名字</li>
<li><strong>情节分支</strong>：输入当前节点，AI生成3条不同走向</li>
</ul>

<p><strong>⚙️ 设置（配置中心）</strong></p>
<p>所有个性化配置都在这里。</p>
<ul>
<li>API设置、人物设定、世界观、文风、规则、禁用词</li>
<li>页面美化（主题、字体、背景）</li>
<li>数据管理（导入导出、清空）</li>
<li>星笺助手入口</li>
</ul>

<p><strong>📦 资源（分享广场）</strong></p>
<p>打包分享你的设定，或导入别人的资源包。</p>

<h3>四、写出高质量作品的技巧</h3>

<p><strong>技巧1：描述要具体</strong></p>
<ul>
<li>❌ "写个恋爱故事"</li>
<li>✅ "民国背景，大家族千金和穷书生的虐恋，女主外柔内刚，男主清冷傲骨"</li>
</ul>

<p><strong>技巧2：善用人物设定</strong></p>
<ul>
<li>进入「设置」→「人物设定」</li>
<li>为每个角色填写名字、性格标签、详细背景</li>
<li>性格标签会影响角色的言行举止</li>
<li>详细设定可以写外貌、说话方式、口头禅、过往经历等</li>
</ul>

<p><strong>技巧3：建立世界观</strong></p>
<ul>
<li>进入「设置」→「世界观设定」</li>
<li>全局世界观始终生效，局部世界观可绑定角色预设</li>
<li>设置每章最少字数（建议800-1500字）</li>
</ul>

<p><strong>技巧4：选择合适的文风</strong></p>
<ul>
<li>7种快捷模板：轻松日常、沉郁文学、甜宠言情、悬疑紧张、古风典雅、幽默讽刺、硬核写实</li>
<li>也可以自己描述想要的文风，比如"村上春树式的冷淡叙述"</li>
</ul>

<p><strong>技巧5：调节创意度</strong></p>
<ul>
<li><strong>0.5-0.7</strong>：稳定可控，适合悬疑推理、需要前后一致的续写</li>
<li><strong>0.8-0.9</strong>：平衡模式，适合大多数创作场景</li>
<li><strong>1.0-1.2</strong>：创意发散，适合奇幻脑洞、需要惊喜的场景</li>
</ul>

<h3>五、长篇连载指南</h3>

<p><strong>开始一部长篇</strong></p>
<ul>
<li>在作坊选择「长篇连载」→ 输入故事方向 → 点击生成</li>
<li>生成第一章后，点击「♡ 收藏」加入书架</li>
<li>只有收藏后才能续写</li>
</ul>

<p><strong>续写下一章</strong></p>
<ul>
<li>打开已收藏的长篇作品</li>
<li>滚动到底部，看到「继续连载下一章」按钮</li>
<li>在「方向提示」框中输入本章想要的发展（可留空）</li>
<li>点击按钮，等待AI创作</li>
</ul>

<p><strong>方向提示的写法</strong></p>
<ul>
<li>"本章要有一场误会"</li>
<li>"加入一个新角色，是女主的青梅竹马"</li>
<li>"本章结尾要有反转"</li>
<li>"让男女主有一段独处的甜蜜时光"</li>
</ul>

<p><strong>上下文编辑器（进阶续写）</strong></p>
<ul>
<li>点击续写区域的「⚙️ 上下文设置」按钮</li>
<li>可以手动编辑：前情提要、重要伏笔、人物当前状态、本章方向、本章大纲、特殊要求</li>
<li>支持AI自动生成前情提要和人物状态分析</li>
<li>可以控制发送给AI的上一章字数长度</li>
<li>可以选择是否发送第一章开头（帮助AI保持基调）</li>
</ul>

<p><strong>章节管理</strong></p>
<ul>
<li>点击「📑 目录」查看所有章节列表</li>
<li>点击任意章节可以跳转阅读</li>
<li>「撤销上一章」可以删除最后一章重新生成</li>
</ul>

<h3>六、高级创作模式</h3>

<p>如果你想完全掌控故事走向，让AI严格按你的大纲逐章创作，请使用高级创作模式。</p>

<p><strong>如何使用</strong></p>
<ul>
<li>进入「创作」页面 → 点击「🎯 高级创作」</li>
<li>填写小说标题、每章字数、核心主题</li>
<li>选择故事类型标签（支持自定义添加）</li>
<li>填写全文梗概（整个故事的概述）</li>
<li>逐章添加大纲（每章要写什么）</li>
<li>点击「🚀 开始创作」，AI会逐章为你创作</li>
</ul>

<p><strong>章节大纲怎么写</strong></p>
<ul>
<li><strong>必须出现的事件</strong>：如"女主发现男主的秘密日记"</li>
<li><strong>情绪走向</strong>：如"开头平静→中段震惊→结尾心碎"</li>
<li><strong>要埋的伏笔</strong>：如"让读者注意到女主手腕的胎记"</li>
<li><strong>禁止出现的内容</strong>：如"本章不要揭露真凶身份"</li>
<li><strong>对话要点</strong>：如"男主要说出那句'我从未后悔遇见你'"</li>
</ul>

<p><strong>项目管理</strong></p>
<ul>
<li>点击「💾 保存项目」可以保存当前设置，下次继续</li>
<li>点击「📂 加载项目」可以加载之前保存的项目</li>
<li>创作过程中可以随时点击「⏹ 停止创作」</li>
</ul>

<div class="notice">
<p>💡 大纲越详细，AI发挥空间越小，结果越可控。如果你希望AI有一定自由度，可以只写关键事件，细节留给AI发挥。</p>
</div>

<h3>七、AI大纲生成器</h3>

<p>如果你有故事想法但不知道怎么规划章节，可以让AI帮你生成大纲。</p>
<ul>
<li>进入「创作」页面 → 点击「🧠 AI大纲」</li>
<li>描述你的故事方向</li>
<li>选择章节数量（5-30章）</li>
<li>点击「生成大纲」</li>
<li>检查大纲，满意后点击「确认并创建小说」</li>
<li>大纲会自动保存，AI续写时会参考</li>
</ul>

<h3>八、故事转盘</h3>

<p>用随机组合激发创意灵感。</p>
<ul>
<li>点击顶部「转盘」按钮进入</li>
<li>默认有3个转盘：故事标签、女主职业、男主职业</li>
<li>点击「➕ 添加」创建自定义转盘</li>
<li>每个转盘可设置转动次数（1-5次）</li>
<li>点击底部大按钮「开始转动所有转盘」</li>
<li>转出结果后可以「📋 复制结果」或「🤖 AI生成梗概」</li>
<li>满意的梗概可以直接「✅ 使用此梗概」填入作坊</li>
</ul>

<p><strong>转盘选项来源</strong></p>
<ul>
<li>手动输入：每行一个选项</li>
<li>AI生成：点击「🤖 AI生成选项」，描述你想要什么选项</li>
<li>预设模板：8种常用模板（故事标签、职业、性格、场景等）</li>
</ul>

<p><strong>去重机制</strong></p>
<ul>
<li>已转出的选项会标记为"已用"，不会重复抽到</li>
<li>点击转盘卡片上的「🔄」可重置单个转盘</li>
<li>顶部「🔄 重置」可重置所有转盘</li>
</ul>

<h3>九、AI起名器</h3>

<ul>
<li>进入「创作」页面 → 点击「✨ AI起名」</li>
<li>选择类型：人名 / 书名 / 地名</li>
<li>输入角色特点或故事背景（可留空，会使用当前设定）</li>
<li>选择风格偏好：现代、古风、日系、西方、奇幻、不限</li>
<li>点击生成，AI会给出5个名字及寓意</li>
<li>点击名字即可复制</li>
</ul>

<h3>十、情节分支器</h3>

<ul>
<li>进入「创作」页面 → 点击「🌿 情节分支」</li>
<li>描述当前的情节节点，比如"女主发现了男主的秘密日记，她会..."</li>
<li>可选填补充信息（角色性格、想要的氛围等）</li>
<li>AI会生成3条截然不同的发展路线：甜向、虐向、反转</li>
<li>每条路线包含：发展方向、情感走向、爽点/泪点</li>
<li>点击「✅ 采用此路线」可直接填入作坊开始创作</li>
</ul>

<h3>十一、编辑器功能详解</h3>

<p>在「创作」页面打开任意作品进入编辑器。</p>

<p><strong>基础功能</strong></p>
<ul>
<li><strong>自动保存</strong>：编辑后3秒自动保存</li>
<li><strong>字数统计</strong>：底部实时显示，未达最低字数会变红，达标变绿</li>
<li><strong>预计阅读时间</strong>：底部显示（按每分钟500字计算）</li>
<li><strong>排版</strong>：一键整理段落格式</li>
<li><strong>复制/导出</strong>：复制全文或导出为TXT文件</li>
<li><strong>沉浸模式</strong>：点击「🌙 沉浸」进入纯净写作界面</li>
</ul>

<p><strong>AI辅助功能</strong></p>
<ul>
<li><strong>🤖 AI评价</strong>：获取专业点评，包含亮点、问题、评分、改进建议</li>
<li><strong>🔄 AI重写</strong>：重新改写当前章节，保留情节但全面升级表达</li>
<li><strong>✨ AI润色</strong>：轻量优化文笔（删除万能副词、改善句式），不改情节</li>
<li><strong>📈 AI扩写</strong>：选择一段文字，AI添加更多细节描写</li>
<li><strong>📉 AI缩写</strong>：选择一段文字，AI精简内容保留核心</li>
</ul>

<p><strong>章节管理（小说模式）</strong></p>
<ul>
<li>顶部显示当前章节，点击可打开目录</li>
<li>「上一章/下一章」快速切换</li>
<li>「+ 添加新章节」在末尾新增</li>
<li>「📋 总大纲」查看AI生成的大纲（如果有）</li>
<li>「📝 章节大纲」为每章设置详细大纲，AI续写时会参考</li>
<li>「🗑️ 删除本章」删除当前章节（至少保留一章）</li>
</ul>

<h3>十二、阅读体验</h3>

<p><strong>基础设置</strong></p>
<ul>
<li>点击「⚙」调节字号（12-24）和行高（1.4-3.0）</li>
<li>点击「⛶」进入全屏模式</li>
<li>设置会自动保存</li>
</ul>

<p><strong>沉浸阅读</strong></p>
<ul>
<li>点击「🌙」进入沉浸阅读模式</li>
<li>极简界面，只有正文内容</li>
<li>支持自动滚动阅读，可调节速度</li>
<li>支持上一章/下一章快速切换</li>
</ul>

<p><strong>语音朗读</strong></p>
<ul>
<li>点击「🔊」开启语音朗读</li>
<li>支持播放/暂停、上一段/下一段</li>
<li>可选择不同语音（优先显示中文语音）</li>
<li>可调节语速（0.5x-2x）和音调</li>
<li>朗读时自动高亮当前段落并滚动跟随</li>
</ul>

<p><strong>章节笔记</strong></p>
<ul>
<li>点击「📝」打开笔记面板</li>
<li>可以为每章记录想法、灵感、修改计划</li>
<li>长按任意段落可以快速引用到笔记中</li>
<li>目录中会显示每章的笔记数量</li>
</ul>

<p><strong>伏笔追踪器</strong></p>
<ul>
<li>点击「🎯」打开伏笔追踪器</li>
<li>手动添加伏笔：记录内容、埋设章节、计划回收章节</li>
<li>AI识别：自动分析文章中的伏笔和悬念</li>
<li>标记已回收/撤销回收</li>
<li>可以导入到上下文编辑器，让AI续写时记住这些伏笔</li>
</ul>

<p><strong>文章重写</strong></p>
<ul>
<li>点击「🔄」打开重写面板</li>
<li>可以输入重写需求，也可以点击快捷标签</li>
<li>短篇：一次性重写整篇</li>
<li>长篇：逐章重写，保留原文作为备份</li>
</ul>

<h3>十三、设置项详解</h3>

<p><strong>🔑 API设置</strong></p>
<ul>
<li><strong>API地址</strong>：填写接口地址，官方是 https://api.openai.com/v1</li>
<li><strong>API密钥</strong>：你的密钥，以 sk- 开头</li>
<li><strong>模型名称</strong>：推荐 gpt-4o-mini（便宜）或 gpt-4o（更强）</li>
<li><strong>Temperature</strong>：创意度，0.5稳定，1.2狂野</li>
<li><strong>Max Tokens</strong>：最大生成长度，建议4096</li>
<li><strong>流式输出</strong>：开启后可以看到AI逐字创作过程</li>
<li><strong>场景预设</strong>：严谨/平衡/创意/狂野 一键切换</li>
<li><strong>拉取模型</strong>：自动获取可用模型列表</li>
<li><strong>测试连接</strong>：检查API是否配置正确</li>
</ul>

<p><strong>👤 人物设定</strong></p>
<ul>
<li>可以添加任意数量的角色</li>
<li>每个角色可设置：名称、性格标签、详细描述</li>
<li>性格标签支持自定义添加和删除</li>
<li>可以保存为预设，方便切换不同作品的人物</li>
<li>切换角色预设时，会自动加载绑定的局部设定</li>
</ul>

<p><strong>🌍 世界观设定</strong></p>
<ul>
<li><strong>全局世界观</strong>：始终生效，无论使用哪个角色预设</li>
<li><strong>局部世界观</strong>：绑定到特定角色预设，切换预设时自动切换</li>
<li>6种全局模板：现代都市、古代宫廷、仙侠修真、西方奇幻、末日废土、校园青春</li>
<li>设置每章最少字数（建议800-2000字）</li>
</ul>

<p><strong>✒️ 文风设置</strong></p>
<ul>
<li>文风为局部设定，绑定到角色预设</li>
<li>7种快捷模板一键应用</li>
<li>也可以自定义描述文风</li>
<li>可以保存为预设</li>
</ul>

<p><strong>📜 规则设置</strong></p>
<ul>
<li><strong>全局规则</strong>：始终生效（如：纯爱向、无虐向、慢热型、快节奏）</li>
<li><strong>局部规则</strong>：绑定到角色预设（如：古风限定、现代限定）</li>
</ul>

<p><strong>🚫 禁用词设置</strong></p>
<ul>
<li><strong>全局禁用词</strong>：始终生效，3种模板（网文通病、空洞形容、说书腔调）</li>
<li><strong>局部禁用词</strong>：绑定到角色预设</li>
<li>每行一个词，AI会避免使用这些词</li>
</ul>

<p><strong>🎨 页面美化</strong></p>
<ul>
<li>5种主题风格：默认紫、暖橙、翠绿、深蓝、日间浅色</li>
<li>自定义字体（填写字体文件URL）</li>
<li>创作背景图片（编辑器背景）</li>
<li>阅读背景图片</li>
</ul>

<p><strong>📦 数据管理</strong></p>
<ul>
<li>导出全部数据（建议每周备份一次）</li>
<li>导入数据（恢复备份）</li>
<li>清空作坊（删除所有生成的文章，收藏不受影响）</li>
<li>清理旧数据（删除一个月前的未收藏文章）</li>
<li>显示存储空间使用情况（IndexedDB，约50MB容量）</li>
</ul>

<h3>十四、全局与局部设定说明</h3>

<p>v2.7.0 引入了全局/局部设定分离机制，让你可以为不同的作品使用不同的设定组合。</p>

<p><strong>什么是全局设定？</strong></p>
<ul>
<li>无论使用哪个角色预设，全局设定都会生效</li>
<li>包括：全局世界观、全局规则、全局禁用词</li>
<li>适合放通用的要求，比如"禁止出现不禁、缓缓等万能副词"</li>
</ul>

<p><strong>什么是局部设定？</strong></p>
<ul>
<li>绑定到特定的角色预设，切换角色预设时自动切换</li>
<li>包括：局部世界观、局部文风、局部规则、局部禁用词</li>
<li>适合放特定作品的要求，比如古风作品的世界观和文风</li>
</ul>

<p><strong>使用方法</strong></p>
<ul>
<li>先在「人物设定」中保存一个角色预设（比如"古风人物组"）</li>
<li>然后在世界观/文风/规则/禁用词设置中，选择绑定到这个预设</li>
<li>之后每次在「人物设定」中点击「使用」加载这个预设时，绑定的局部设定会自动加载</li>
</ul>

<h3>十五、资源广场</h3>

<p><strong>打包导出</strong></p>
<ul>
<li>点击「📤 打包导出」</li>
<li>勾选想要分享的内容（人物、世界观、文风、规则、作品等）</li>
<li>给资源包起名字，写简介</li>
<li>点击导出，生成 .json 文件</li>
</ul>

<p><strong>导入资源包</strong></p>
<ul>
<li>点击「📥 导入资源包」</li>
<li>选择收到的 .json 文件</li>
<li>导入后可以在资源列表中看到</li>
<li>点击「应用」可以将设定加载到你的配置中</li>
</ul>

<p><strong>写经验分享</strong></p>
<ul>
<li>点击「✍️ 写经验」</li>
<li>分享你的创作心得、写作技巧</li>
<li>保存后可以导出分享给别人</li>
</ul>

<h3>十六、星笺 - 你的创作伙伴</h3>

<p>星笺是笔记AI的专属助手，一只来自「灵感之境」的魔法书精灵。</p>

<p><strong>如何找到星笺</strong></p>
<ul>
<li>点击底部「设置」</li>
<li>在用户卡片左上方，有一个浮动的紫色小头像</li>
<li>点击即可开始聊天</li>
</ul>

<p><strong>星笺能帮你做什么</strong></p>
<ul>
<li>解答笔记AI的所有功能问题</li>
<li>在你卡文时提供创意灵感</li>
<li>陪你聊天，给予情感支持</li>
<li>分享写作技巧和建议</li>
</ul>

<p><strong>星笺的特点</strong></p>
<ul>
<li>温柔可爱，说话轻柔治愈</li>
<li>有点小害羞，被夸奖会脸红</li>
<li>能感知时间，深夜会关心你休息</li>
<li>记得你们的对话（最近30条）</li>
</ul>

<p><strong>聊天功能</strong></p>
<ul>
<li>长按消息可以：编辑、复制、删除</li>
<li>长按星笺的回复可以：重新回答、编辑、复制、删除</li>
<li>支持更换聊天背景图片</li>
<li>支持清空聊天记录</li>
</ul>

<h3>十七、常见问题</h3>

<p><strong>Q：生成失败怎么办？</strong></p>
<ul>
<li>检查API设置是否正确，点击「测试连接」</li>
<li>确认API密钥有余额</li>
<li>尝试更换模型</li>
<li>检查网络连接</li>
</ul>

<p><strong>Q：生成的内容质量不好？</strong></p>
<ul>
<li>描述写得更具体详细</li>
<li>完善人物设定和世界观</li>
<li>选择合适的文风模板</li>
<li>在禁用词里添加不想看到的词</li>
<li>调低创意度让输出更稳定</li>
<li>使用AI润色功能优化已生成的内容</li>
</ul>

<p><strong>Q：续写和前文不连贯？</strong></p>
<ul>
<li>使用「上下文编辑器」手动编辑前情提要</li>
<li>在方向提示里写清楚要承接什么</li>
<li>调低创意度到0.6-0.7</li>
<li>使用章节大纲功能，明确每章内容</li>
</ul>

<p><strong>Q：数据会丢失吗？</strong></p>
<ul>
<li>数据保存在浏览器本地（IndexedDB + localStorage）</li>
<li>清除浏览器数据会丢失</li>
<li>建议每周通过「数据管理」导出备份</li>
<li>换设备需要导入备份文件</li>
</ul>

<p><strong>Q：存储空间不够用？</strong></p>
<ul>
<li>v2.6.0已升级为IndexedDB存储，容量约50MB</li>
<li>使用「清理旧数据」删除一个月前的未收藏文章</li>
<li>定期导出备份后清空作坊</li>
</ul>

<p><strong>Q：可以在手机上使用吗？</strong></p>
<ul>
<li>完全支持手机浏览器使用</li>
<li>建议添加到主屏幕，体验更好</li>
</ul>

<h3>十八、进阶技巧</h3>

<ul>
<li><strong>先大纲后创作</strong>：写长篇前先用AI大纲或高级创作模式规划全局</li>
<li><strong>分段扩写</strong>：先让AI写出骨架，再用扩写功能丰富细节</li>
<li><strong>人工润色</strong>：AI生成后在编辑器里手动修改，效果最好</li>
<li><strong>多次重写</strong>：对不满意的章节使用AI重写，可能会有惊喜</li>
<li><strong>善用笔记</strong>：阅读时随手记录灵感，方便后续修改</li>
<li><strong>伏笔管理</strong>：用伏笔追踪器记录埋下的线索，避免忘记回收</li>
<li><strong>上下文编辑</strong>：长篇续写时使用上下文编辑器，让AI更懂你的故事</li>
<li><strong>定期备份</strong>：每周导出一次数据，防止意外丢失</li>
<li><strong>尝试不同文风</strong>：同一个故事用不同文风生成，对比效果</li>
<li><strong>转盘激发灵感</strong>：没有思路时用故事转盘随机组合创意元素</li>
</ul>

<h3>十九、创作伦理提醒</h3>

<div class="notice">
<p>⚠️ <strong>诚信创作倡议</strong></p>
<p>笔记AI鼓励创作者诚信使用AI辅助创作：</p>
<p>· 请勿将AI生成的内容伪装为完全原创作品</p>
<p>· 在发布时请如实标注"本文由AI辅助创作"</p>
<p>· 尊重读者知情权</p>
<p>· AI是工具，创意和灵魂来自你自己</p>
<p>让我们共同维护良好的创作环境。</p>
</div>

<h3>二十、联系作者</h3>
<p>如遇问题或有建议反馈，欢迎联系：</p>
<div class="contact">
<p>📕 小红书：95567118758</p>
<p>📕 小红书：27418565861</p>
<p>💬 微信：Aa9620520</p>
<p>💬 QQ：962005530</p>
</div>

<p style="text-align:center;color:var(--text2);margin-top:28px;font-size:11px">笔记AI v2.8.0 · Created by 心田<br>让每一个灵感都值得被记录 ✨</p>
</div>
</div>

<!-- DIALOGS -->
<div class="dlg-ov" id="dlgOv">
<div class="dlg-box">
<h3 id="dlgTitle">确认</h3>
<p id="dlgMsg"></p>
<div class="dlg-btns">
<button class="dlg-cancel" onclick="closeDlg()">取消</button>
<button class="dlg-ok" id="dlgOkBtn">确认</button>
</div>
</div>
</div>

<div class="inp-ov" id="inpOv">
<div class="inp-box">
<h3 id="inpTitle">输入</h3>
<input id="inpField">
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeInp()">取消</button>
<button class="dlg-ok" id="inpOkBtn">确认</button>
</div>
</div>
</div>
<!-- RESOURCE EXPORT DIALOG -->
<div class="res-exp-ov" id="resExpOv" onclick="if(event.target===this)closeResExport()">
<div class="res-exp-box" id="resExpBox">
<h3>📤 打包资源</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">勾选你想分享的内容，打包成资源文件发给别人</p>
<div id="resExpList"></div>
<input class="res-exp-input" id="resPackName" placeholder="给资源包起个名字（可选）">
<textarea class="res-exp-input" id="resPackDesc" placeholder="资源包简介（可选）" style="min-height:50px;resize:vertical;font-family:inherit"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeResExport()">取消</button>
<button class="dlg-ok" onclick="doResExport()">导出资源包</button>
</div>
</div>
</div>
<!-- EXP SHARE DIALOG -->
<div class="res-exp-ov" id="expOv" onclick="if(event.target===this)closeExpDlg()">
<div class="res-exp-box">
<h3>✍️ 写经验分享</h3>
<input class="res-exp-input" id="expTitle" placeholder="经验标题">
<textarea class="res-exp-input" id="expContent" placeholder="分享你的创作心得、写作技巧、踩坑经验..." style="min-height:120px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeExpDlg()">取消</button>
<button class="dlg-ok" onclick="saveExpShare()">保存</button>
</div>
</div>
</div>
<!-- EDITOR MODAL -->
<div class="ed-modal" id="edModal" role="dialog" aria-label="编辑器"> <div class="cr-bg" id="crBg"></div>
<div class="ed-hdr">
<button class="ed-back" onclick="closeEditor()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回
</button>
<input class="ed-title-input" id="edTitle" placeholder="输入标题...">
</div>
<div class="ed-acts">
<button onclick="toggleImmersiveEdit()" id="immersiveEditBtn">🌙 沉浸</button>
<button onclick="saveEditorContent()">💾 保存</button>
<button onclick="formatEditorText()">¶ 排版</button>
<button onclick="copyEditorContent()">📋 复制</button> <button onclick="exportEdToTxt()">📥 导出TXT</button>
<button onclick="requestAIReview()">🤖 AI评价</button>
<button onclick="viewOutline()" id="edOutlineBtn" style="display:none">📋 总大纲</button>
<button onclick="openChOutline()" id="edChOutlineBtn" style="display:none">📝 章节大纲</button>
<button onclick="aiRewriteChapter()">🔄 AI重写</button> <button onclick="aiPolishChapter()">✨ AI润色</button>
<button onclick="openAiExpand()">📈 AI扩写</button>
<button onclick="openAiShrink()">📉 AI缩写</button>
<button onclick="deleteEdChapter()" style="color:var(--danger);border-color:rgba(255,107,107,.3)">🗑️ 删除本章</button>
</div>
<div class="ed-ch-bar" id="edChBar" style="display:none"> <button class="ed-ch-btn act" id="edChCurrent" onclick="openEdChList()">第1章</button> <button class="ed-ch-btn" onclick="goEdPrevCh()" id="edPrevBtn" style="display:none">◀ 上一章</button> <button class="ed-ch-btn" onclick="goEdNextCh()" id="edNextBtn" style="display:none">下一章 ▶</button> <button class="ed-ch-btn" onclick="openEdChList()">📑 目录</button> </div>
<div class="ed-body">
  <button class="immersive-exit" onclick="toggleImmersiveEdit()">✕ 退出沉浸</button>
<textarea class="ed-textarea" id="edTextarea" placeholder="开始写作..." oninput="onEditorInput()"></textarea>
</div>
<div class="ed-footer">
<span>字数：<span class="ed-wc" id="edWc">0</span></span>
<span id="edReadTime" style="margin-left:10px;font-size:9px;color:var(--text2)"></span>
<span id="edSaveStatus">未保存</span>
</div>
</div>
<!-- ARTICLE REWRITE -->
<div class="res-exp-ov" id="rewriteOv" onclick="if(event.target===this)closeRewriteOv()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3 id="rewriteTitle">🔄 文章重写</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">AI将根据你的需求重新改写整篇文章，保留核心情节</p>
<div class="fg">
<label class="fl">重写需求（告诉AI你想要什么效果）</label>
<textarea class="fta" id="rewriteRequirement" placeholder="例如：&#10;- 增加更多心理描写&#10;- 让对话更自然口语化&#10;- 加强环境氛围描写&#10;- 让节奏更紧凑&#10;- 换成第一人称叙述&#10;（留空则按默认方式优化）" style="min-height:100px"></textarea>
</div>
<div class="fg">
<label class="fl">快捷需求（点击添加）</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
<button class="tag" onclick="addRewriteReq('增加感官细节描写')">+感官细节</button>
<button class="tag" onclick="addRewriteReq('增加人物心理活动')">+心理描写</button>
<button class="tag" onclick="addRewriteReq('让对话更口语化自然')">+自然对话</button>
<button class="tag" onclick="addRewriteReq('加快叙事节奏')">+快节奏</button>
<button class="tag" onclick="addRewriteReq('增加环境氛围描写')">+氛围感</button>
<button class="tag" onclick="addRewriteReq('删除冗余描写，更精炼')">+精简</button>
</div>
</div>
<div id="rewriteProgress" style="display:none;margin-top:10px">
<div style="font-size:12px;color:var(--accent2);margin-bottom:6px">重写进度</div>
<div style="background:var(--border);border-radius:4px;height:6px;overflow:hidden">
<div id="rewriteProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s"></div>
</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px" id="rewriteProgressText">准备中...</div>
</div>
<div class="res-exp-btns" id="rewriteBtns">
<button class="dlg-cancel" onclick="closeRewriteOv()">取消</button>
<button class="dlg-ok" id="rewriteDoBtn" onclick="doArticleRewrite()">🚀 开始重写</button>
</div>
</div>
</div>
<!-- AI REVIEW -->
<div class="ai-review-ov" id="aiReviewOv" onclick="if(event.target===this)closeAIReview()">
<div class="ai-review-box">
<div class="ai-review-hdr">
<h3>🤖 AI写作建议</h3>
<button class="note-close" onclick="closeAIReview()">✕</button>
</div>
<div class="ai-review-body" id="aiReviewBody">
<div class="note-empty">点击下方按钮获取AI评价</div>
</div>
<div class="ai-review-ft">
<button onclick="closeAIReview()">关闭</button>
</div>
</div>
</div>
<div class="note-ov" id="noteOv" onclick="if(event.target===this)closeNotePanel()">
<div class="note-panel">
<div class="note-hdr">
<div><h3>📝 章节笔记</h3><span id="noteChInfo"></span></div>
<div style="display:flex;gap:6px;align-items:center">
<button style="background:none;border:1px solid var(--border);color:var(--text2);font-size:10px;padding:4px 8px;border-radius:6px;cursor:pointer" onclick="toggleNoteSearch()" title="搜索笔记">🔍</button>
<button style="background:none;border:1px solid var(--border);color:var(--text2);font-size:10px;padding:4px 8px;border-radius:6px;cursor:pointer" onclick="exportArticleNotes()" title="导出所有笔记">📤</button>
<button class="note-close" onclick="closeNotePanel()">✕</button>
</div>
</div>
<div id="noteSearchWrap" style="display:none;padding:8px 16px 0">
<input type="text" id="noteSearchInput" placeholder="🔍 搜索笔记内容..." style="width:100%;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:12px;outline:none" oninput="searchNotes(this.value)">
</div>
<div class="note-list" id="noteList"></div>
<div class="note-input-wrap">
<div class="note-tags-row" style="display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap">
<span class="note-tag-btn act" data-tag="全部" onclick="filterNotes('全部',this)" style="padding:3px 10px;border-radius:12px;font-size:10px;cursor:pointer;border:1px solid var(--accent);background:var(--accent);color:#fff;transition:all .2s">全部</span>
<span class="note-tag-btn" data-tag="灵感" onclick="filterNotes('灵感',this)" style="padding:3px 10px;border-radius:12px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2);transition:all .2s">💡 灵感</span>
<span class="note-tag-btn" data-tag="修改" onclick="filterNotes('修改',this)" style="padding:3px 10px;border-radius:12px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2);transition:all .2s">✏️ 修改</span>
<span class="note-tag-btn" data-tag="伏笔" onclick="filterNotes('伏笔',this)" style="padding:3px 10px;border-radius:12px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2);transition:all .2s">🎯 伏笔</span>
<span class="note-tag-btn" data-tag="吐槽" onclick="filterNotes('吐槽',this)" style="padding:3px 10px;border-radius:12px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2);transition:all .2s">😂 吐槽</span>
</div>
<div class="note-input-row">
<div style="flex:1;display:flex;flex-direction:column;gap:6px">
<div style="display:flex;gap:4px" id="noteTagSelect">
<span class="note-sel-tag act" data-val="" onclick="selectNoteTag('',this)" style="padding:2px 8px;border-radius:8px;font-size:9px;cursor:pointer;border:1px solid var(--accent);background:rgba(108,92,231,.15);color:var(--accent2)">无标签</span>
<span class="note-sel-tag" data-val="灵感" onclick="selectNoteTag('灵感',this)" style="padding:2px 8px;border-radius:8px;font-size:9px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2)">💡</span>
<span class="note-sel-tag" data-val="修改" onclick="selectNoteTag('修改',this)" style="padding:2px 8px;border-radius:8px;font-size:9px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2)">✏️</span>
<span class="note-sel-tag" data-val="伏笔" onclick="selectNoteTag('伏笔',this)" style="padding:2px 8px;border-radius:8px;font-size:9px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2)">🎯</span>
<span class="note-sel-tag" data-val="吐槽" onclick="selectNoteTag('吐槽',this)" style="padding:2px 8px;border-radius:8px;font-size:9px;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2)">😂</span>
</div>
<textarea id="noteInput" placeholder="写下你的想法..." rows="1" oninput="this.style.height='38px';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
</div>
<button class="note-send" onclick="addNote()">记录</button>
</div>
</div>
</div>
</div>
<div class="ch-ov" id="chOv" onclick="if(event.target===this)closeChapterList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="chPanelTitle">章节目录</h3><span id="chPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeChapterList()">✕</button>
</div>
<div class="ch-panel-list" id="chPanelList"></div>
</div>
</div>
<div class="res-exp-ov" id="outlineOv" onclick="if(event.target===this)closeOutlineGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>🧠 AI大纲生成器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">描述你想写的故事，AI会生成详细大纲，确认后自动创建小说</p>
<input class="res-exp-input" id="outlineTitle" placeholder="小说标题（可选，AI也会帮你起）">
<textarea class="res-exp-input" id="outlineDesc" placeholder="描述故事方向，比如：一个穿越到古代的程序员，利用现代知识在朝堂上步步高升..." style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);flex-shrink:0">章节数：</span>
<input type="number" id="outlineChInput" min="1" max="100" value="10" style="width:70px;padding:8px 12px;border-radius:9px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;text-align:center;outline:none" oninput="outlineChCount=parseInt(this.value)||10" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
<span style="font-size:10px;color:var(--text2)">章</span>
<div style="display:flex;gap:4px;margin-left:auto">
<button class="tag" onclick="document.getElementById('outlineChInput').value=5;outlineChCount=5" style="padding:4px 8px;font-size:10px">5</button>
<button class="tag" onclick="document.getElementById('outlineChInput').value=10;outlineChCount=10" style="padding:4px 8px;font-size:10px">10</button>
<button class="tag" onclick="document.getElementById('outlineChInput').value=20;outlineChCount=20" style="padding:4px 8px;font-size:10px">20</button>
<button class="tag" onclick="document.getElementById('outlineChInput').value=50;outlineChCount=50" style="padding:4px 8px;font-size:10px">50</button>
</div>
</div>
<div id="outlineResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;max-height:40vh;overflow-y:auto">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">📋 生成的大纲</div>
<div id="outlineContent" style="font-size:12px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeOutlineGen()">取消</button>
<button class="dlg-ok" id="outlineGenBtn" onclick="doGenOutline()">🧠 生成大纲</button>
</div>
<div id="outlineActions" style="display:none;margin-top:8px">
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="doGenOutline()">🔄 重新生成</button>
<button class="dlg-ok" onclick="applyOutline()">✅ 确认并创建小说</button>
</div>
</div>
</div>
</div>
<!-- STORY WHEEL 故事转盘 - 全屏版 -->
<div class="wheel-modal" id="wheelOv">
<div class="wheel-modal-hdr">
<button class="wheel-back" onclick="closeWheelPanel()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
返回
</button>
<h2>🎰 故事转盘</h2>
<div class="wheel-hdr-acts">
<button onclick="addWheel()">➕ 添加</button>
<button onclick="resetAllWheels()">🔄 重置</button>
</div>
</div>

<div class="wheel-modal-body">
<!-- 转盘列表区 -->
<div class="wheel-grid" id="wheelList"></div>

<!-- 结果展示区 -->
<div class="wheel-result-panel" id="wheelResultArea" style="display:none">
<div class="wheel-result-header">
<span class="wheel-result-icon">🎯</span>
<span>转盘结果</span>
</div>
<div class="wheel-result-tags" id="wheelResultTags"></div>
<div class="wheel-result-actions">
<button class="wheel-btn-secondary" onclick="copyWheelResult()">📋 复制结果</button>
<button class="wheel-btn-primary" onclick="aiGenStoryFromWheel()" id="wheelAiBtn">🤖 AI生成梗概</button>
</div>
</div>

<!-- AI生成的故事区 -->
<div class="wheel-story-panel" id="wheelStoryArea" style="display:none">
<div class="wheel-story-header">📖 故事梗概</div>
<div class="wheel-story-content" id="wheelStoryContent"></div>
<div class="wheel-story-actions">
<button class="wheel-btn-secondary" onclick="copyWheelStory()">📋 复制梗概</button>
<button class="wheel-btn-primary" onclick="useWheelStory()">✅ 使用此梗概</button>
</div>
</div>
</div>

<!-- 底部操作栏 -->
<div class="wheel-modal-footer">
<button class="wheel-spin-btn" onclick="spinAllWheels()" id="spinAllBtn">
<span class="wheel-spin-icon">🎰</span>
<span>开始转动所有转盘！</span>
</button>
</div>
</div>

<!-- WHEEL EDITOR 转盘编辑器 -->
<div class="res-exp-ov" id="wheelEditOv" onclick="if(event.target===this)closeWheelEdit()" style="z-index:830">
<div class="res-exp-box" style="max-width:400px;max-height:85vh;display:flex;flex-direction:column">
<h3 id="wheelEditTitle">编辑转盘</h3>
<div class="fg">
<label class="fl">转盘名称</label>
<input class="fi" id="wheelName" placeholder="如：故事标签、女主职业、场景...">
</div>
<div class="fg">
<label class="fl">转动次数</label>
<div style="display:flex;align-items:center;gap:10px">
<input type="range" id="wheelSpinCount" min="1" max="5" value="1" style="flex:1" oninput="document.getElementById('wheelSpinVal').textContent=this.value">
<span id="wheelSpinVal" style="font-size:14px;font-weight:600;color:var(--accent2);width:20px">1</span>
<span style="font-size:11px;color:var(--text2)">次</span>
</div>
</div>
<div class="fg">
<label class="fl">转盘选项（每行一个）</label>
<textarea class="fta" id="wheelOptions" placeholder="选项1&#10;选项2&#10;选项3&#10;..." style="min-height:120px"></textarea>
</div>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="btn-s" onclick="aiGenWheelOptions()" style="flex:1;margin:0" id="aiGenOptBtn">🤖 AI生成选项</button>
<button class="btn-s" onclick="loadPresetOptions()" style="flex:1;margin:0">📦 预设模板</button>
</div>
<div id="aiGenOptArea" style="display:none;margin-bottom:10px">
<input class="fi" id="aiGenOptPrompt" placeholder="告诉AI你想要什么选项，如：20个女性职业">
<button class="btn-p" onclick="doAiGenOptions()" style="margin-top:6px" id="doAiGenBtn">生成</button>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeWheelEdit()">取消</button>
<button class="dlg-ok" onclick="saveWheel()">💾 保存</button>
</div>
</div>
</div>

<!-- PRESET OPTIONS 预设选项 -->
<div class="res-exp-ov" id="presetOptOv" onclick="if(event.target===this)closePresetOpt()" style="z-index:840">
<div class="res-exp-box" style="max-width:360px">
<h3>📦 预设模板</h3>
<div id="presetOptList" style="max-height:50vh;overflow-y:auto"></div>
<div class="res-exp-btns" style="margin-top:12px">
<button class="dlg-cancel" onclick="closePresetOpt()">关闭</button>
</div>
</div>
</div>
<!-- ADVANCED CREATE 高级创作 -->
<div class="res-exp-ov" id="advCreateOv" onclick="if(event.target===this)closeAdvancedCreate()">
<div class="res-exp-box" style="max-width:520px;max-height:92vh;display:flex;flex-direction:column;padding:18px">
<h3 style="margin-bottom:4px">🎯 高级创作模式</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:14px">手动设置每章大纲，AI逐章为你创作，随时可停</p>

<div style="flex:1;overflow-y:auto;padding-right:6px">
<!-- 基本信息 -->
<div class="fg">
<label class="fl">📖 小说标题</label>
<input class="fi" id="advTitle" placeholder="给你的小说起个名字">
</div>

<div class="fg">
<label class="fl">📏 每章字数</label>
<div style="display:flex;align-items:center;gap:8px">
<input class="fi" id="advWordsPerCh" type="number" min="500" max="5000" step="100" value="1500" style="width:100px">
<span style="font-size:11px;color:var(--text2)">字/章</span>
<div style="display:flex;gap:4px;margin-left:auto">
<button class="tag" onclick="document.getElementById('advWordsPerCh').value=1000" style="padding:4px 8px;font-size:10px">1000</button>
<button class="tag" onclick="document.getElementById('advWordsPerCh').value=1500" style="padding:4px 8px;font-size:10px">1500</button>
<button class="tag" onclick="document.getElementById('advWordsPerCh').value=2000" style="padding:4px 8px;font-size:10px">2000</button>
</div>
</div>
</div>

<!-- 核心设定 -->
<div class="fg">
<label class="fl">💡 核心理念/主题（可选）</label>
<textarea class="fta" id="advTheme" placeholder="这部小说想表达什么？例如：爱与救赎、成长的代价..." style="min-height:50px"></textarea>
</div>

<div class="fg">
<label class="fl">🎭 故事类型（点击选择，长按删除自定义标签）</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px" id="advGenreTags"></div>
<div style="display:flex;gap:6px;margin-top:8px">
<input type="text" id="advNewGenre" placeholder="输入自定义类型" style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px" onkeydown="if(event.key==='Enter'){addAdvGenre();event.preventDefault();}">
<button class="btn-s" onclick="addAdvGenre()" style="margin:0;padding:6px 12px;font-size:11px">➕ 添加</button>
</div>
</div>

<div class="fg">
<label class="fl">📝 全文梗概（整个故事的概述）</label>
<textarea class="fta" id="advSynopsis" placeholder="用200-500字概述整个故事的主线..." style="min-height:80px"></textarea>
</div>

<div class="fg">
<label class="fl">🚫 避免出现的内容（可选）</label>
<textarea class="fta" id="advAvoid" placeholder="不想出现的元素，如：不要三角恋、不要BE..." style="min-height:40px"></textarea>
</div>

<!-- 章节大纲列表 -->
<div class="fg">
<label class="fl" style="display:flex;justify-content:space-between;align-items:center">
<span>📋 章节大纲</span>
<span style="font-size:10px;color:var(--text2)" id="advChCount">共 0 章</span>
</label>
<div id="advChapterList" style="margin-top:8px"></div>
<button class="btn-s" onclick="addAdvChapter()" style="width:100%;margin-top:8px;border-style:dashed">➕ 添加章节</button>
</div>

<!-- 创作设置 -->
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-top:10px">
<div style="font-size:12px;font-weight:600;margin-bottom:10px">⚙️ 创作设置</div>
<div style="display:flex;flex-direction:column;gap:8px">
<div style="display:flex;align-items:center;justify-content:space-between">
<span style="font-size:11px">使用当前人物设定</span>
<div style="position:relative;width:40px;height:22px;cursor:pointer" onclick="toggleAdvSwitch('advUseChars')">
<input type="checkbox" id="advUseChars" checked style="display:none">
<div style="width:40px;height:22px;border-radius:11px;background:var(--accent);transition:background .3s" id="advUseCharsTrack">
<div style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:2px;left:20px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="advUseCharsThumb"></div>
</div>
</div>
</div>
<div style="display:flex;align-items:center;justify-content:space-between">
<span style="font-size:11px">使用当前世界观设定</span>
<div style="position:relative;width:40px;height:22px;cursor:pointer" onclick="toggleAdvSwitch('advUseWorld')">
<input type="checkbox" id="advUseWorld" checked style="display:none">
<div style="width:40px;height:22px;border-radius:11px;background:var(--accent);transition:background .3s" id="advUseWorldTrack">
<div style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:2px;left:20px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="advUseWorldThumb"></div>
</div>
</div>
</div>
<div style="display:flex;align-items:center;justify-content:space-between">
<span style="font-size:11px">使用当前文风设定</span>
<div style="position:relative;width:40px;height:22px;cursor:pointer" onclick="toggleAdvSwitch('advUseStyle')">
<input type="checkbox" id="advUseStyle" checked style="display:none">
<div style="width:40px;height:22px;border-radius:11px;background:var(--accent);transition:background .3s" id="advUseStyleTrack">
<div style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:2px;left:20px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="advUseStyleThumb"></div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- 底部按钮 -->
<div style="display:flex;gap:10px;margin-top:14px;flex-shrink:0">
<button class="dlg-cancel" onclick="closeAdvancedCreate()" style="flex:1">取消</button>
<button class="dlg-cancel" onclick="saveAdvProject()" style="flex:1">💾 保存项目</button>
<button class="dlg-ok" onclick="startAdvCreate()" style="flex:1.5" id="advStartBtn">🚀 开始创作</button>
</div>

<!-- 创作进度 -->
<div id="advProgress" style="display:none;margin-top:14px;padding:14px;background:var(--card2);border-radius:10px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:12px;font-weight:600">创作进度</span>
<span style="font-size:11px;color:var(--accent2)" id="advProgressText">0/0 章</span>
</div>
<div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden">
<div id="advProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s"></div>
</div>
<div style="font-size:10px;color:var(--text2);margin-top:6px" id="advProgressInfo">准备中...</div>
<button class="btn-s" onclick="stopAdvCreate()" style="margin-top:10px;width:100%;border-color:var(--danger);color:var(--danger)" id="advStopBtn">⏹ 停止创作</button>
</div>
</div>
</div>

<!-- 加载项目弹窗 -->
<div class="res-exp-ov" id="advLoadOv" onclick="if(event.target===this)closeAdvLoad()" style="z-index:820">
<div class="res-exp-box" style="max-width:380px">
<h3>📂 加载已保存的项目</h3>
<div id="advProjectList" style="max-height:50vh;overflow-y:auto;margin:12px 0"></div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeAdvLoad()">关闭</button>
</div>
</div>
</div>
<!-- CONTEXT EDITOR 上下文编辑器 -->
<div class="res-exp-ov" id="contextEditorOv" onclick="if(event.target===this)closeContextEditor()">
<div class="res-exp-box" style="max-width:500px;max-height:90vh;display:flex;flex-direction:column">
<h3>📝 续写上下文设置</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">自定义发送给AI的上下文信息，让续写更精准</p>

<div style="flex:1;overflow-y:auto">
<!-- 前情提要 -->
<div class="fg">
<label class="fl">📖 前情提要（AI会参考这段了解之前发生了什么）</label>
<textarea class="fta" id="ctxPrevSummary" placeholder="简述前面章节的关键情节、人物关系变化、重要事件...&#10;&#10;例如：&#10;第1-3章：女主林晚意外穿越，遇到男主顾深，两人因误会产生冲突&#10;第4章：顾深发现林晚的秘密，态度开始转变&#10;目前：两人关系缓和，但林晚还不知道顾深的真实身份" style="min-height:100px"></textarea>
<div style="display:flex;gap:6px;margin-top:6px">
<button class="btn-s" onclick="aiGenPrevSummary()" style="flex:1;margin:0">🤖 AI生成提要</button>
<button class="btn-s" onclick="clearCtxField('ctxPrevSummary')" style="width:60px;margin:0">清空</button>
</div>
</div>

<!-- 重要伏笔 -->
<div class="fg">
<label class="fl">🎯 重要伏笔/悬念（提醒AI记住这些未解决的线索）</label>
<textarea class="fta" id="ctxForeshadows" placeholder="列出需要AI记住的伏笔和悬念...&#10;&#10;例如：&#10;- 男主手腕上的伤疤（第2章提到，未解释来源）&#10;- 女主的玉佩（第3章丢失，还没找到）&#10;- 神秘来信的发送者是谁？" style="min-height:80px"></textarea>
<button class="btn-s" onclick="loadForeshadowsToCtx()" style="margin-top:6px">📌 从伏笔追踪器导入</button>
</div>

<!-- 人物当前状态 -->
<div class="fg">
<label class="fl">👥 人物当前状态（告诉AI角色现在的情况）</label>
<textarea class="fta" id="ctxCharStates" placeholder="描述主要角色当前的状态、位置、情绪...&#10;&#10;例如：&#10;林晚：在顾府养伤，对顾深有好感但不敢承认&#10;顾深：知道林晚的秘密后很纠结，表面冷淡内心在意&#10;顾母：开始接受林晚，但仍有顾虑" style="min-height:80px"></textarea>
<button class="btn-s" onclick="aiGenCharStates()" style="margin-top:6px">🤖 AI分析人物状态</button>
</div>

<!-- 本章方向 -->
<div class="fg">
<label class="fl">🎬 本章方向（告诉AI这一章要写什么）</label>
<textarea class="fta" id="ctxDirection" placeholder="描述本章想要的发展方向...&#10;&#10;例如：&#10;- 本章要有一场误会，让两人关系倒退&#10;- 加入一个新角色：顾深的青梅竹马&#10;- 结尾要揭露一个关于女主身世的线索" style="min-height:70px"></textarea>
</div>

<!-- 本章大纲 -->
<div class="fg">
<label class="fl">📋 本章详细大纲（可选，写了AI会严格遵守）</label>
<textarea class="fta" id="ctxChOutline" placeholder="如果你对本章有具体规划，写在这里...&#10;&#10;例如：&#10;1. 开头：林晚在花园散步，偶遇顾深和青梅竹马&#10;2. 中段：青梅竹马故意刺激林晚，林晚误会顾深&#10;3. 结尾：林晚决定离开顾府，顾深发现她留下的信" style="min-height:70px"></textarea>
</div>

<!-- 写作要求 -->
<div class="fg">
<label class="fl">⚙️ 特殊要求（可选）</label>
<textarea class="fta" id="ctxSpecialReq" placeholder="其他特殊要求...&#10;&#10;例如：&#10;- 本章多写一些心理描写&#10;- 对话要更口语化&#10;- 节奏要快，不要太多环境描写&#10;- 本章字数要求2000字以上" style="min-height:60px"></textarea>
</div>

<!-- 上下文长度控制 -->
<div class="fg">
<label class="fl">📏 上一章发送长度</label>
<div style="display:flex;align-items:center;gap:10px">
<input type="range" id="ctxLastChLen" min="500" max="3000" step="100" value="1500" style="flex:1" oninput="document.getElementById('ctxLastChLenVal').textContent=this.value+'字'">
<span id="ctxLastChLenVal" style="font-size:12px;color:var(--accent2);width:50px">1500字</span>
</div>
<div style="font-size:10px;color:var(--text2);margin-top:4px">发送上一章结尾的字数，越多AI记忆越完整，但消耗token越多</div>
</div>

<!-- 是否发送第一章开头 -->
<div class="fg" style="display:flex;align-items:center;justify-content:space-between">
<div>
<div style="font-size:12px;font-weight:500">📖 发送第一章开头</div>
<div style="font-size:10px;color:var(--text2)">帮助AI保持故事基调一致</div>
</div>
<div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleCtxSwitch('ctxSendFirstCh',this)">
<input type="checkbox" id="ctxSendFirstCh" checked style="display:none">
<div style="width:44px;height:24px;border-radius:12px;background:var(--accent);transition:background .3s" id="ctxSendFirstChTrack">
<div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="ctxSendFirstChThumb"></div>
</div>
</div>
</div>
</div>

<div class="res-exp-btns" style="margin-top:12px;flex-shrink:0">
<button class="dlg-cancel" onclick="closeContextEditor()">取消</button>
<button class="dlg-ok" onclick="saveAndContinue()">💾 保存并续写</button>
</div>
</div>
</div>
<!-- FORESHADOW TRACKER 伏笔追踪器 -->
<div class="res-exp-ov" id="foreshadowOv" onclick="if(event.target===this)closeForeshadow()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3>🎯 伏笔追踪器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">记录埋下的伏笔，追踪回收状态</p>
<div style="display:flex;gap:8px;margin-bottom:12px">
<button class="btn-s" onclick="addForeshadow()" style="flex:1;margin:0">➕ 添加伏笔</button>
<button class="btn-s" onclick="aiDetectForeshadow()" style="flex:1;margin:0" id="aiDetectBtn">🤖 AI识别</button>
</div>
<div id="foreshadowList" style="flex:1;overflow-y:auto"></div>
<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2)">
<span>📌 待回收：<span id="fsCountPending">0</span></span>
<span>✅ 已回收：<span id="fsCountDone">0</span></span>
</div>
</div>
</div>
</div>
<!-- 添加/编辑关系弹窗 -->
<div class="inp-ov" id="addRelOv">
<div class="inp-box" style="max-width:360px;max-height:85vh;overflow-y:auto">
<h3 id="addRelTitle">添加人物关系</h3>
<div class="fg">
<label class="fl">人物A</label>
<select class="fi" id="relCharA" style="padding:9px 13px"></select>
</div>
<div class="fg">
<label class="fl">人物B</label>
<select class="fi" id="relCharB" style="padding:9px 13px"></select>
</div>
<div class="fg">
<label class="fl">关系类型</label>
<div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:4px">
<span class="tag" onclick="setRelType('恋人',this)" data-rel="恋人">❤️ 恋人</span>
<span class="tag" onclick="setRelType('朋友',this)" data-rel="朋友">🤝 朋友</span>
<span class="tag" onclick="setRelType('敌对',this)" data-rel="敌对">⚔️ 敌对</span>
<span class="tag" onclick="setRelType('亲属',this)" data-rel="亲属">👨‍👩‍👧 亲属</span>
<span class="tag" onclick="setRelType('师徒',this)" data-rel="师徒">📖 师徒</span>
<span class="tag" onclick="setRelType('同事',this)" data-rel="同事">💼 同事</span>
<span class="tag" onclick="setRelType('暗恋',this)" data-rel="暗恋">💗 暗恋</span>
<span class="tag" onclick="setRelType('宿敌',this)" data-rel="宿敌">🔥 宿敌</span>
<span class="tag" onclick="setRelType('青梅竹马',this)" data-rel="青梅竹马">🌸 青梅竹马</span>
<span class="tag" onclick="setRelType('主仆',this)" data-rel="主仆">👑 主仆</span>
</div>
<input class="fi" id="relTypeCustom" placeholder="或输入自定义关系..." style="margin-top:6px" oninput="currentRelType=this.value">
</div>
<div class="fg">
<label class="fl">关系描述（可选）</label>
<textarea class="fta" id="relDesc" placeholder="描述这段关系的细节，比如：从小一起长大，后因误会决裂..." style="min-height:50px"></textarea>
</div>
<div class="fg">
<label class="fl">关系方向</label>
<div style="display:flex;gap:6px;margin-top:4px">
<span class="tag act" onclick="setRelDir('双向',this)" id="relDirBoth">↔ 双向</span>
<span class="tag" onclick="setRelDir('A→B',this)" id="relDirAB">→ A对B</span>
<span class="tag" onclick="setRelDir('B→A',this)" id="relDirBA">← B对A</span>
</div>
</div>
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeAddRel()">取消</button>
<button class="dlg-ok" id="addRelBtn" onclick="saveRel()">保存</button>
</div>
</div>
</div>

<!-- 添加NPC弹窗 -->
<div class="inp-ov" id="addNpcOv">
<div class="inp-box" style="max-width:380px;max-height:85vh;overflow-y:auto">
<h3 id="addNpcTitle">添加NPC</h3>
<div class="fg">
<label class="fl">NPC名称</label>
<input class="fi" id="npcName" placeholder="NPC角色名">
</div>
<div class="fg">
<label class="fl">角色定位</label>
<div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:4px">
<span class="tag" onclick="setNpcRole('路人',this)">路人</span>
<span class="tag" onclick="setNpcRole('配角',this)">配角</span>
<span class="tag" onclick="setNpcRole('反派',this)">反派</span>
<span class="tag" onclick="setNpcRole('导师',this)">导师</span>
<span class="tag" onclick="setNpcRole('线索人物',this)">线索人物</span>
<span class="tag" onclick="setNpcRole('工具人',this)">工具人</span>
</div>
<input class="fi" id="npcRoleCustom" placeholder="或输入自定义定位..." style="margin-top:6px">
</div>
<div class="fg">
<label class="fl">性格标签</label>
<input class="fi" id="npcTraits" placeholder="用逗号分隔，如：冷漠,话少,心软">
</div>
<div class="fg">
<label class="fl">外貌/特征</label>
<input class="fi" id="npcAppearance" placeholder="简要描述外貌或标志性特征">
</div>
<div class="fg">
<label class="fl">详细设定</label>
<textarea class="fta" id="npcDesc" placeholder="背景故事、说话方式、口头禅、与主角的关系..." style="min-height:70px"></textarea>
</div>
<div class="fg">
<label class="fl">出场章节（可选）</label>
<input class="fi" id="npcChapter" placeholder="如：第3章开始出场">
</div>
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeAddNpc()">取消</button>
<button class="dlg-ok" id="addNpcBtn" onclick="saveNpc()">保存</button>
</div>
</div>
</div>
<!-- ADD FORESHADOW DIALOG -->
<div class="inp-ov" id="addFsOv">
<div class="inp-box" style="max-width:360px">
<h3 id="addFsTitle">添加伏笔</h3>
<div class="fg">
<label class="fl">伏笔内容</label>
<textarea id="fsContent" class="fta" placeholder="描述这个伏笔是什么..." style="min-height:60px"></textarea>
</div>
<div class="fg">
<label class="fl">埋设章节</label>
<input id="fsChapter" class="fi" placeholder="第几章埋下的（如：第3章）">
</div>
<div class="fg">
<label class="fl">计划回收章节（可选）</label>
<input id="fsPlanChapter" class="fi" placeholder="计划在第几章回收">
</div>
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeAddFs()">取消</button>
<button class="dlg-ok" id="addFsBtn" onclick="saveFs()">保存</button>
</div>
</div>
</div>
<!-- BRANCH GENERATOR 情节分支器 -->
<div class="res-exp-ov" id="branchOv" onclick="if(event.target===this)closeBranchGen()">
<div class="res-exp-box" style="max-width:450px;max-height:90vh;display:flex;flex-direction:column">
<h3>🌿 情节分支器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">输入当前情节节点，AI会生成3个不同走向供你选择</p>
<div class="fg">
<label class="fl">当前情节/节点描述</label>
<textarea class="fta" id="branchInput" placeholder="例如：女主发现了男主的秘密日记，她会..." style="min-height:80px"></textarea>
</div>
<div class="fg">
<label class="fl">补充信息（可选）</label>
<input class="fi" id="branchContext" placeholder="角色性格、你想要的氛围等">
</div>
<div id="branchResult" style="display:none;margin-top:10px;flex:1;overflow-y:auto">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">🌿 三条分支路线</div>
<div id="branchList"></div>
</div>
<div class="res-exp-btns" style="margin-top:12px">
<button class="dlg-cancel" onclick="closeBranchGen()">关闭</button>
<button class="dlg-ok" id="branchGenBtn" onclick="doGenBranch()">🌿 生成分支</button>
</div>
</div>
</div>
<!-- NAME GENERATOR -->
<div class="res-exp-ov" id="nameGenOv" onclick="if(event.target===this)closeNameGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>✨ AI起名器</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">输入设定信息，AI为你生成5个名字</p>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="tag act" id="nameTypeChar" onclick="setNameType('char')">👤 人名</button>
<button class="tag" id="nameTypeBook" onclick="setNameType('book')">📖 书名</button>
<button class="tag" id="nameTypePlace" onclick="setNameType('place')">🏔️ 地名</button>
</div>
<textarea class="res-exp-input" id="nameGenDesc" placeholder="描述角色特点、性格、身份背景...&#10;或描述故事类型、世界观、氛围...&#10;（可留空，将使用当前设置中的人物/世界观）" style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">风格偏好：</span>
<button class="tag" onclick="setNameStyle('现代',this)">现代</button>
<button class="tag" onclick="setNameStyle('古风',this)">古风</button>
<button class="tag" onclick="setNameStyle('日系',this)">日系</button>
<button class="tag" onclick="setNameStyle('西方',this)">西方</button>
<button class="tag" onclick="setNameStyle('奇幻',this)">奇幻</button>
<button class="tag" onclick="setNameStyle('',this)">不限</button>
</div>
<div id="nameGenResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">🎯 生成结果（点击复制）</div>
<div id="nameGenList" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeNameGen()">关闭</button>
<button class="dlg-ok" id="nameGenBtn" onclick="doGenNames()">✨ 生成名字</button>
</div>
</div>
</div>
<!-- 编辑器章节列表弹窗 -->
<div class="ch-ov" id="edChOv" onclick="if(event.target===this)closeEdChList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="edChPanelTitle">章节管理</h3><span id="edChPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeEdChList()">✕</button>
</div>
<div class="ch-panel-list" id="edChPanelList"></div>
<div style="padding:12px 18px;border-top:1px solid var(--border)">
<button style="width:100%;padding:10px;border-radius:10px;border:1px dashed var(--accent);background:transparent;color:var(--accent2);font-size:12px;cursor:pointer" onclick="addEdChapter()">+ 添加新章节</button>
</div>
</div>
</div>
<!-- 章节大纲编辑弹窗 -->
<div class="res-exp-ov" id="chOutlineOv" onclick="if(event.target===this)closeChOutline()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3>📋 章节大纲管理</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">为每章设置大纲，AI续写时会参考</p>
<div id="chOutlineList" style="flex:1;overflow-y:auto;margin-bottom:12px"></div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeChOutline()">关闭</button>
<button class="dlg-ok" onclick="saveChOutlines()">💾 保存大纲</button>
</div>
</div>
</div>
<!-- AI扩写/缩写弹窗 -->
<div class="res-exp-ov" id="expandOv" onclick="if(event.target===this)closeExpandOv()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3 id="expandTitle">📈 AI扩写</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px" id="expandDesc">选择或粘贴要扩写的段落，AI会添加更多细节描写</p>
<div class="fg">
<label class="fl">原文内容</label>
<textarea class="fta" id="expandInput" placeholder="粘贴或输入要处理的段落..." style="min-height:100px"></textarea>
</div>
<div class="fg">
<label class="fl">扩写/缩写要求（可选）</label>
<input class="fi" id="expandHint" placeholder="例如：增加环境描写、加入心理活动、精简对话...">
</div>
<div id="expandResult" style="display:none;margin-top:10px">
<label class="fl">处理结果</label>
<textarea class="fta" id="expandOutput" style="min-height:120px;background:var(--bg)" readonly></textarea>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn-s" onclick="copyExpandResult()" style="flex:1">📋 复制结果</button>
<button class="btn-p" onclick="applyExpandResult()" style="flex:1">✅ 替换原文</button>
</div>
</div>
<div class="res-exp-btns" id="expandBtns">
<button class="dlg-cancel" onclick="closeExpandOv()">取消</button>
<button class="dlg-ok" id="expandDoBtn" onclick="doExpand()">开始处理</button>
</div>
</div>
</div>
<!-- 星笺聊天页面 -->
<div class="xj-modal" id="xjModal" role="dialog" aria-label="星笺聊天">
<div class="xj-bg" id="xjBg"></div>
<div class="xj-hdr">
<button class="xj-back" onclick="closeXingJian()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
返回
</button>
<div class="xj-avatar"><img src="https://i.postimg.cc/0y0h3vyB/retouch-2026022503092567.png" alt="星笺"></div>
<div class="xj-info">
<div class="xj-name">星笺 <span>✨</span></div>
<div class="xj-status">在线 · 随时为你提供灵感</div>
</div>
<button class="xj-clear" onclick="uploadXjBg()">换背景</button> <button class="xj-clear" onclick="clearXjChat()">清空记录</button> <input type="file" id="xjBgUp" accept="image/*" style="display:none" onchange="handleXjBgUpload(event)">
</div>
<div class="xj-body" id="xjBody">
<div class="xj-welcome">
<img src="https://i.postimg.cc/0y0h3vyB/retouch-2026022503092567.png" alt="星笺">
<p>我是星笺，你的创作小伙伴～<br>有什么想聊的，尽管告诉我吧！</p>
</div>
</div>
<div class="xj-input-wrap">
<div class="xj-input-row">
<textarea class="xj-input" id="xjInput" placeholder="和星笺聊聊吧..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendXjMsg();}" oninput="this.style.height='44px';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
<button class="xj-send" id="xjSendBtn" onclick="sendXjMsg()">➤</button> <button class="xj-send" id="xjStopBtn" onclick="stopXjMsg()" style="display:none;background:var(--danger)">⏹</button>
</div>
</div>
</div>
<!-- SETTINGS MODALS -->
<div class="set-modal" id="setModalApi">
<div class="set-modal-hdr"><button onclick="closeSetModal('api')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🔑 API设置</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">API地址</label><input class="fi" id="apiUrl" placeholder="https://api.openai.com/v1"></div>
<div class="fg"><label class="fl">API密钥 <span style="font-size:9px;color:var(--danger);font-weight:400">（仅存本地，勿在公共设备使用）</span></label><div style="display:flex;gap:6px"><input class="fi" id="apiKey" type="password" placeholder="sk-..." style="flex:1"><button class="btn-s" onclick="const k=document.getElementById('apiKey');k.type=k.type==='password'?'text':'password'" style="width:auto;padding:6px 10px;margin:0">👁</button></div></div>
<div class="fg"><label class="fl">模型名称</label><div style="display:flex;gap:6px"><input class="fi" id="apiModel" placeholder="gpt-4o-mini" value="gpt-4o-mini" list="modelSuggest" style="flex:1"><datalist id="modelSuggest"></datalist><button class="btn-s" onclick="fetchModels()" style="width:auto;padding:6px 12px;margin:0">拉取</button></div></div>
<div class="frow"><div class="fg"><label class="fl">Temperature</label><input class="fi" id="apiTemp" type="number" step="0.1" min="0" max="2" value="0.8"></div><div class="fg"><label class="fl">Max Tokens</label><input class="fi" id="apiMaxTokens" type="number" value="4096"></div></div>
<div class="fg"><label class="fl">场景预设</label><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"><button class="tag" onclick="setTempPreset(0.5,'严谨')">📐 严谨</button><button class="tag" onclick="setTempPreset(0.7,'平衡')">⚖️ 平衡</button><button class="tag" onclick="setTempPreset(0.9,'创意')">💡 创意</button><button class="tag" onclick="setTempPreset(1.1,'狂野')">🔥 狂野</button></div></div>
<div class="fg" style="display:flex;align-items:center;justify-content:space-between"><label class="fl" style="margin:0">流式输出</label><div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleStreamSwitch(this)"><input type="checkbox" id="streamOn" checked style="display:none"><div style="width:44px;height:24px;border-radius:12px;background:var(--accent);transition:background .3s" id="streamTrack"><div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="streamThumb"></div></div></div></div>
<button class="btn-s" onclick="testApiConnection()" id="btnTestApi">🔗 测试连接</button>
<button class="btn-p" onclick="saveApiPreset()">💾 保存为预设</button>
<div class="plist" id="apiPL"></div>
</div>
</div>

<div class="set-modal" id="setModalChar">
<div class="set-modal-hdr"><button onclick="closeSetModal('char')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>👤 人物设定</h2></div>
<div class="set-modal-body">
<div class="char-cards" id="charCards"></div>
<button class="btn-s" onclick="addCharacter()" style="margin-top:10px">＋ 添加角色</button>
<!-- 人物关系图 -->
<div class="rel-graph" id="relGraphSection">
<div class="rel-graph-title">
<span>🔗 人物关系图</span>
<div style="display:flex;gap:6px">
<button class="btn-s" onclick="addRelation()" style="margin:0;padding:5px 10px;font-size:10px">➕ 添加关系</button>
<button class="btn-s" onclick="aiGenRelations()" style="margin:0;padding:5px 10px;font-size:10px">🤖 AI生成</button>
</div>
</div>
<div class="rel-list" id="relList">
<div class="rel-empty">还没有人物关系<br>添加角色后点击「添加关系」建立联系</div>
</div>
</div>

<!-- NPC设定 -->
<div class="npc-section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<label class="fl" style="margin:0;font-size:13px;font-weight:600">🎭 NPC / 配角设定</label>
<button class="btn-s" onclick="addNpc()" style="margin:0;padding:5px 10px;font-size:10px">➕ 添加NPC</button>
</div>
<div id="npcCards">
<div class="rel-empty">还没有NPC<br>点击上方按钮添加配角和路人</div>
</div>
</div>
<div class="fg" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--border)">
<label class="fl">自定义性格标签管理</label>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px" id="customTraitList"></div>
<button class="btn-s" onclick="renderCustomTraitList()" style="margin-top:8px">🔄 刷新列表</button>
</div>
<button class="btn-p" onclick="saveCharPreset()">💾 保存人物预设</button>
<div class="plist" id="charPL"></div>
</div>
</div>

<div class="set-modal" id="setModalWorld">
<div class="set-modal-hdr"><button onclick="closeSetModal('world')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🌍 世界观设定</h2></div>
<div class="set-modal-body">
<div style="background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.3);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--accent2);margin-bottom:8px">🌍 全局世界观（始终生效）</div>
<textarea class="fta" id="globalWorldDesc" placeholder="全局世界观设定，无论使用哪个角色预设都会生效..." style="min-height:100px" oninput="globalWorld=this.value;sv('bj_globalWorld',globalWorld)"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
<button class="tag" onclick="applyGlobalWorldTemplate('现代都市')">现代都市</button>
<button class="tag" onclick="applyGlobalWorldTemplate('古代宫廷')">古代宫廷</button>
<button class="tag" onclick="applyGlobalWorldTemplate('仙侠修真')">仙侠修真</button>
<button class="tag" onclick="applyGlobalWorldTemplate('西方奇幻')">西方奇幻</button>
<button class="tag" onclick="applyGlobalWorldTemplate('末日废土')">末日废土</button>
<button class="tag" onclick="applyGlobalWorldTemplate('校园青春')">校园青春</button>
</div>
</div>

<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">📍 局部世界观（绑定角色预设）</div>
<div style="font-size:10px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px">绑定到：<select id="worldBindingSelect" style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px" onchange="switchWorldBinding(this.value)"></select></div>
<textarea class="fta" id="worldDesc" placeholder="局部世界观设定，仅在使用绑定的角色预设时生效..." style="min-height:100px" oninput="saveLocalWorld()"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
<button class="tag" onclick="applyWorldTemplate('现代都市')">现代都市</button>
<button class="tag" onclick="applyWorldTemplate('古代宫廷')">古代宫廷</button>
<button class="tag" onclick="applyWorldTemplate('仙侠修真')">仙侠修真</button>
<button class="tag" onclick="applyWorldTemplate('西方奇幻')">西方奇幻</button>
</div>
</div>

<div class="fg"> <label class="fl">每章最少字数</label> <div class="wc-set"><input class="fi" id="minWords" type="number" value="1200" min="500" max="5000" step="100"><span style="color:var(--text2);font-size:11px">字</span></div> <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"> <button class="tag" onclick="document.getElementById('minWords').value=800">800字</button> <button class="tag" onclick="document.getElementById('minWords').value=1200">1200字</button> <button class="tag" onclick="document.getElementById('minWords').value=1500">1500字</button> <button class="tag" onclick="document.getElementById('minWords').value=2000">2000字</button> <button class="tag" onclick="document.getElementById('minWords').value=3000">3000字</button> </div> <div style="font-size:10px;color:var(--text2);margin-top:6px">建议：短篇800-1000字，长篇1200-2000字，字数越多消耗token越多</div> </div>
<button class="btn-p" onclick="saveWorldPreset()">💾 保存世界观预设</button>
<div class="plist" id="worldPL"></div>
</div>
</div>

<div class="set-modal" id="setModalStyle">
<div class="set-modal-hdr"><button onclick="closeSetModal('style')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>✒️ 文风设置</h2></div>
<div class="set-modal-body">
<div style="background:rgba(230,126,34,.1);border:1px solid rgba(230,126,34,.3);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:#e67e22;margin-bottom:4px">✒️ 文风设置（仅局部，绑定角色预设）</div>
<div style="font-size:10px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px">绑定到：<select id="styleBindingSelect" style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px" onchange="switchStyleBinding(this.value)"></select></div>
<textarea class="fta" id="styleDesc" placeholder="文风描述，仅在使用绑定的角色预设时生效..." style="min-height:100px" oninput="saveLocalStyle()"></textarea>
<div class="fg" style="margin-top:10px"><label class="fl">快捷文风模板</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
<button class="tag" onclick="applyStyleTemplate('轻松日常')">轻松日常</button>
<button class="tag" onclick="applyStyleTemplate('沉郁文学')">沉郁文学</button>
<button class="tag" onclick="applyStyleTemplate('甜宠言情')">甜宠言情</button>
<button class="tag" onclick="applyStyleTemplate('悬疑紧张')">悬疑紧张</button>
<button class="tag" onclick="applyStyleTemplate('古风典雅')">古风典雅</button>
<button class="tag" onclick="applyStyleTemplate('幽默讽刺')">幽默讽刺</button>
<button class="tag" onclick="applyStyleTemplate('硬核写实')">硬核写实</button>
</div></div>
</div>

<button class="btn-p" onclick="saveStylePreset()">💾 保存文风预设</button>
<div class="plist" id="stylePL"></div>
</div>
</div>

<div class="set-modal" id="setModalRule">
<div class="set-modal-hdr"><button onclick="closeSetModal('rule')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>📜 规则设置</h2></div>
<div class="set-modal-body">
<div style="background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.3);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--accent2);margin-bottom:8px">📜 全局规则（始终生效）</div>
<textarea class="fta" id="globalRuleDesc" placeholder="全局规则，无论使用哪个角色预设都会生效..." style="min-height:100px" oninput="globalRule=this.value;sv('bj_globalRule',globalRule)"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
<button class="tag" onclick="applyGlobalRuleTemplate('纯爱向')">纯爱向</button>
<button class="tag" onclick="applyGlobalRuleTemplate('无虐向')">无虐向</button>
<button class="tag" onclick="applyGlobalRuleTemplate('慢热型')">慢热型</button>
<button class="tag" onclick="applyGlobalRuleTemplate('快节奏')">快节奏</button>
</div>
</div>

<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">📍 局部规则（绑定角色预设）</div>
<div style="font-size:10px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px">绑定到：<select id="ruleBindingSelect" style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px" onchange="switchRuleBinding(this.value)"></select></div>
<textarea class="fta" id="ruleDesc" placeholder="局部规则，仅在使用绑定的角色预设时生效..." style="min-height:100px" oninput="saveLocalRule()"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
<button class="tag" onclick="applyRuleTemplate('古风限定')">古风限定</button>
<button class="tag" onclick="applyRuleTemplate('现代限定')">现代限定</button>
</div>
</div>

<button class="btn-p" onclick="saveRulePreset()">💾 保存规则预设</button>
<div class="plist" id="rulePL"></div>
</div>
</div>

<div class="set-modal" id="setModalBan">
<div class="set-modal-hdr"><button onclick="closeSetModal('ban')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🚫 禁用词设置</h2></div>
<div class="set-modal-body">
<div style="background:rgba(108,92,231,.1);border:1px solid rgba(108,92,231,.3);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--accent2);margin-bottom:8px">🚫 全局禁用词（始终生效）</div>
<textarea class="fta" id="globalBanWordsInput" placeholder="全局禁用词，每行一个，无论使用哪个角色预设都会生效..." style="min-height:80px" oninput="globalBanWords=this.value;sv('bj_globalBanWords',globalBanWords)"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
<button class="tag" onclick="applyGlobalBanTemplate('网文通病')">网文通病</button>
<button class="tag" onclick="applyGlobalBanTemplate('空洞形容')">空洞形容</button>
<button class="tag" onclick="applyGlobalBanTemplate('说书腔调')">说书腔调</button>
</div>
</div>

<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px">
<div style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">📍 局部禁用词（绑定角色预设）</div>
<div style="font-size:10px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px">绑定到：<select id="banBindingSelect" style="flex:1;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:11px" onchange="switchBanBinding(this.value)"></select></div>
<textarea class="fta" id="banWordsInput" placeholder="局部禁用词，每行一个，仅在使用绑定的角色预设时生效..." style="min-height:80px" oninput="saveLocalBanWords()"></textarea>
</div>

<button class="btn-p" onclick="saveBanWordsPreset()">💾 保存禁用词预设</button>
<div class="plist" id="banWordsPL"></div>
</div>
</div>

<div class="set-modal" id="setModalTheme">
<div class="set-modal-hdr"><button onclick="closeSetModal('theme')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🎨 页面美化</h2></div>
<div class="set-modal-body">
<div class="fg"><label class="fl">主题风格</label><div class="theme-opts"><div class="t-opt t0 act" onclick="setTheme('default',this)"></div><div class="t-opt t1" onclick="setTheme('warm',this)"></div><div class="t-opt t2" onclick="setTheme('green',this)"></div><div class="t-opt t3" onclick="setTheme('blue',this)"></div><div class="t-opt t4" onclick="setTheme('light',this)"></div></div></div>
<div class="fg"><label class="fl">自定义字体链接</label><input class="fi" id="customFontUrl" placeholder="https://example.com/font.ttf"></div>
<div class="fg"><label class="fl">创作背景图片</label><button class="btn-s" onclick="document.getElementById('crBgUp').click()">📁 上传图片</button><input type="file" id="crBgUp" accept="image/*" style="display:none" onchange="uploadCrBg(event)"><button class="btn-s" onclick="clearCrBg()" style="margin-top:5px">🗑️ 清除背景</button></div>
<div class="fg"><label class="fl">阅读背景图片</label><button class="btn-s" onclick="document.getElementById('rdBgUp').click()">📁 上传图片</button><input type="file" id="rdBgUp" accept="image/*" style="display:none" onchange="uploadRdBg(event)"><button class="btn-s" onclick="clearRdBg()" style="margin-top:5px">🗑️ 清除背景</button></div>
</div>
</div>
<div class="set-modal" id="setModalNotify">
<div class="set-modal-hdr"><button onclick="closeSetModal('notify')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>🔔 铃声与勿扰</h2></div>
<div class="set-modal-body">
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">🔕 勿扰模式<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="set-grp-c show">
<p style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.6">开启后将拦截所有铃声和系统提示消息。<br>但创作目标达标时仍然会弹窗祝贺。</p>
<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0">
<span style="font-size:13px;font-weight:600">勿扰模式</span>
<div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleDndSwitch()">
<input type="checkbox" id="dndOn" style="display:none">
<div style="width:44px;height:24px;border-radius:12px;background:var(--border);transition:background .3s" id="dndTrack">
<div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="dndThumb"></div>
</div>
</div>
</div>
<div id="dndStatus" style="font-size:10px;color:var(--text2);margin-top:4px">当前状态：已关闭</div>
</div>
</div>
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">🔊 铃声提示<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div>
<div class="set-grp-c show">
<p style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.6">上传MP3文件作为铃声，创作目标达标时播放。</p>
<div class="fg">
<label class="fl">当前铃声</label>
<div id="currentRingInfo" style="font-size:12px;color:var(--text);padding:8px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:8px">未设置铃声（达标时仅弹窗）</div>
</div>
<div style="display:flex;gap:8px">
<button class="btn-s" onclick="document.getElementById('ringUpload').click()" style="flex:1;margin:0">📁 上传MP3铃声</button>
<button class="btn-s" onclick="previewRing()" style="width:60px;margin:0" id="previewRingBtn">▶ 试听</button>
<button class="btn-s" onclick="clearRing()" style="width:60px;margin:0;border-color:rgba(255,107,107,.3);color:var(--danger)">清除</button>
</div>
<input type="file" id="ringUpload" accept=".mp3,audio/mpeg" style="display:none" onchange="handleRingUpload(event)">
<div style="font-size:9px;color:var(--text2);margin-top:8px">支持MP3格式，建议文件小于2MB</div>
<div class="fg" style="margin-top:12px">
<label class="fl">铃声音量</label>
<div style="display:flex;align-items:center;gap:10px">
<input type="range" id="ringVolume" min="0" max="1" step="0.1" value="0.8" style="flex:1;accent-color:var(--accent)" oninput="updateRingVolume(this.value)">
<span id="ringVolVal" style="font-size:11px;color:var(--accent2);width:30px;text-align:right">80%</span>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="set-modal" id="setModalData">
<div class="set-modal-hdr"><button onclick="closeSetModal('data')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>返回</button><h2>📦 数据管理</h2></div>
<div class="set-modal-body">
<div class="data-btns"><button onclick="exportData()">📤 导出全部数据</button><button onclick="document.getElementById('importFile').click()">📥 导入数据</button><input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)"><button onclick="clearWorkshop()" style="border-color:rgba(255,107,107,.3);color:var(--danger)">🗑️ 清空作坊</button><button onclick="cleanOldData()" style="border-color:rgba(255,165,0,.3);color:#f0a030">🧹 清理旧数据</button><button onclick="exportAllCrWorks()" style="border-color:var(--accent);color:var(--accent2)">📤 导出全部创作数据</button></div>
<div id="storageInfo" style="margin-top:15px;padding:12px;background:var(--bg);border-radius:10px;border:1px solid var(--border)"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11px;color:var(--text2)">存储空间</span><span style="font-size:11px;color:var(--accent2)" id="storagePercent">计算中...</span></div><div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div id="storageBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px"></div></div><div style="font-size:9px;color:var(--text2);margin-top:4px" id="storageDetail">已用 0MB / 50MB</div></div>
</div>
</div>
<div class="goal-celebrate" id="goalCelebrate">
<div class="goal-celebrate-box">
<div class="goal-celebrate-icon">🎉</div>
<div class="goal-celebrate-title" id="celebrateTitle">目标达成！</div>
<div class="goal-celebrate-msg" id="celebrateMsg">恭喜你完成了创作目标！</div>
<button class="goal-celebrate-btn" onclick="closeCelebrate()">太棒了！✨</button>
</div>
</div>
<div class="toast" id="toast"></div>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav">
<button class="bnav-i act" onclick="switchPage('workshop',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
作坊
</button>
<button class="bnav-i" onclick="switchPage('collection',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5V5a2 2 0 012-2h14v14H6.5A2.5 2.5 0 004 19.5z"/></svg>
收藏
</button>
<button class="bnav-i" onclick="switchPage('create',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
创作
</button>
<button class="bnav-i" onclick="switchPage('settings',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
设置
</button>
<button class="bnav-i" onclick="switchPage('resource',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
资源
</button>
</nav>

<input type="file" id="coverUp" accept="image/*" style="display:none">
<script>
// ==================== IndexedDB 存储系统 ====================
const DB_NAME = 'BijiAI_DB';
const DB_VERSION = 1;
const STORE_NAME = 'data';
let db = null;
let dbReady = false;
let dbCache = {}; // 内存缓存

// 初始化数据库
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('IndexedDB 打开失败');
            reject(request.error);
        };
        
        request.onsuccess = () => {
            db = request.result;
            dbReady = true;
            console.log('IndexedDB 已连接，容量约50-100MB');
            resolve(db);
        };
        
        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME, { keyPath: 'key' });
            }
        };
    });
}

// 从IndexedDB读取
function dbGet(key) {
    return new Promise((resolve) => {
        if (!db) { resolve(null); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(key);
            request.onsuccess = () => {
                const result = request.result;
                resolve(result ? result.value : null);
            };
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}

// 写入IndexedDB
function dbSet(key, value) {
    return new Promise((resolve) => {
        if (!db) { resolve(false); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put({ key: key, value: value });
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
        } catch (e) {
            resolve(false);
        }
    });
}

// 从IndexedDB加载所有数据到缓存
async function loadAllFromDB() {
    if (!db) return;
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                items.forEach(item => {
                    dbCache[item.key] = item.value;
                });
                console.log('已从IndexedDB加载 ' + items.length + ' 项数据');
                resolve();
            };
            request.onerror = () => resolve();
        } catch (e) {
            resolve();
        }
    });
}

// 获取IndexedDB使用量
async function getDBStorageUsage() {
    if (!db) return { used: 0, usedMB: '0', percent: 0 };
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                let total = 0;
                items.forEach(item => {
                    total += JSON.stringify(item).length * 2;
                });
                const maxSize = 50 * 1024 * 1024; // 50MB
                resolve({
                    used: total,
                    usedMB: (total / 1024 / 1024).toFixed(2),
                    percent: (total / maxSize * 100).toFixed(1)
                });
            };
            request.onerror = () => resolve({ used: 0, usedMB: '0', percent: 0 });
        } catch (e) {
            resolve({ used: 0, usedMB: '0', percent: 0 });
        }
    });
}
// ==================== CONFIG ====================
const APP_VER='v2.8.0';

// ==================== STORAGE ====================
const K={
tags:'bj_tags',apiP:'bj_apiP',charP:'bj_charP',worldP:'bj_worldP',
curApi:'bj_curApi',curChars:'bj_curChars',curWorld:'bj_curWorld',
cols:'bj_cols',ws:'bj_ws',ap:'bj_ap'
};
function ld(k, fb) {
    // 优先从内存缓存读取
    if (dbCache.hasOwnProperty(k)) {
        return dbCache[k];
    }
    // 回退到localStorage（兼容旧数据）
    try {
        const d = localStorage.getItem(k);
        if (d) {
            const parsed = JSON.parse(d);
            dbCache[k] = parsed; // 存入缓存
            return parsed;
        }
        return fb;
    } catch {
        return fb;
    }
}

function sv(k, d) {
    // 存入内存缓存
    dbCache[k] = d;
    
    // 异步存入IndexedDB
    if (dbReady && db) {
        dbSet(k, d).catch((e) => {
            console.warn('IndexedDB保存失败:', k, e);
        });
    }
    
    // 同时尝试存localStorage（作为备份）
    try {
        const str = JSON.stringify(d);
        if (str.length < 500000) {
            localStorage.setItem(k, str);
        }
    } catch (e) {
        // localStorage满了，检查是否需要提醒用户
        if (e.name === 'QuotaExceededError') {
            console.warn('localStorage已满，数据仅保存在IndexedDB');
        }
    }
}

// ==================== STATE ====================
let curType='long';
let selTags=[];
let ws=ld(K.ws,[]);// workshop articles
let cols=ld(K.cols,{books:[],shorts:[]});
let tags=ld(K.tags,['#日常','#bg','#穿越','#奇幻','#校园','#甜文','#虐文','#悬疑','#古风','#现代']);
let apiP=ld(K.apiP,[]);
let charP=ld(K.charP,[]);
let worldP=ld(K.worldP,[]);
let styleP=ld('bj_styleP',[]);
let ruleP=ld('bj_ruleP',[]);
let curRule=ld('bj_curRule','');
// 全局设定（不随角色切换）
let globalWorld=ld('bj_globalWorld','');
let globalRule=ld('bj_globalRule','');
let globalBanWords=ld('bj_globalBanWords','');

// 局部设定绑定（key是角色预设名，value是设定内容）
let localWorldBindings=ld('bj_localWorldBindings',{});
let localRuleBindings=ld('bj_localRuleBindings',{});
let localBanWordsBindings=ld('bj_localBanWordsBindings',{});
let localStyleBindings=ld('bj_localStyleBindings',{});

// 当前使用的角色预设名（用于绑定局部设定）
let currentWorldBinding=ld('bj_currentWorldBinding',''); let currentRuleBinding=ld('bj_currentRuleBinding',''); let currentBanBinding=ld('bj_currentBanBinding',''); let currentStyleBinding=ld('bj_currentStyleBinding','');
let currentCharPresetName=ld('bj_currentCharPresetName','');
let banWords=ld('bj_banWords','');
let banWordsP=ld('bj_banWordsP',[]);
let ap=ld(K.ap,{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2,curStyle:''});
let characters=ld(K.curChars,[{name:'',desc:''},{name:'',desc:''}]);
let customTraits=ld('bj_customTraits',[]);
let curRd=null;// current reading article
let curCh=0;// current chapter index
let isGen=false;
let isFS=false;
let abortCtrl=null;// for aborting stream
let crWorks=ld('bj_crWorks',[]);// 创作作品列表
let crTab='draft';// 当前创作页tab
let curEd=null;// 当前编辑的作品
let curEdCh=0;// 当前编辑的章节
let edAutoSaveTimer=null;
// 自动保存草稿定时器（新增）
let autoSaveInterval = null;
let resPacks=ld('bj_resPacks',[]);// 已导入的资源包
let resTab='all';
let useStream=ld('bj_stream',true);
let userCard=ld('bj_userCard',{name:'',bio:'',avatar:''});

// ==================== TOAST ====================
let toastTimer=null;
function showToast(msg,dur=2000){
if(navigator.vibrate)navigator.vibrate(10);
const t=document.getElementById('toast');
t.textContent=msg;t.classList.add('show');
if(toastTimer)clearTimeout(toastTimer);
toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ==================== CONFIRM DIALOG ====================
function showDlg(title,msg,onOk,danger=false){
document.getElementById('dlgTitle').textContent=title;
document.getElementById('dlgMsg').textContent=msg;
const btn=document.getElementById('dlgOkBtn');
btn.className=danger?'dlg-danger':'dlg-ok';
btn.textContent='确认';
btn.onclick=()=>{closeDlg();onOk();};
document.getElementById('dlgOv').classList.add('show');
}
function closeDlg(){document.getElementById('dlgOv').classList.remove('show');}

// ==================== INPUT DIALOG ====================
function showInp(title,ph,onOk){
document.getElementById('inpTitle').textContent=title;
const f=document.getElementById('inpField');
f.placeholder=ph;f.value='';
document.getElementById('inpOkBtn').onclick=()=>{
const v=f.value.trim();if(v){closeInp();onOk(v);}else{showToast('请输入内容');}
};
document.getElementById('inpOv').classList.add('show');
setTimeout(()=>f.focus(),100);
}
function closeInp(){document.getElementById('inpOv').classList.remove('show');}

// ==================== UTILITY ====================
function esc(s){
if(s===null||s===undefined)return '';
if(typeof s!=='string')s=String(s);
return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function uid(){return Date.now()+'_'+Math.random().toString(36).substr(2,8);}
function countWords(text){return text.replace(/\s/g,'').length;}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
function isLiked(article){
if(article.type==='long')return cols.books.some(b=>b.id===article.id);
return cols.shorts.some(s=>s.id===article.id);
}

// ==================== NAV ====================
function switchPage(pg,el){
document.querySelectorAll('.pg').forEach(p=>p.classList.remove('act'));
document.getElementById('pg-'+pg).classList.add('act');
document.querySelectorAll('.bnav-i').forEach(n=>n.classList.remove('act'));
el.classList.add('act');
if(pg==='collection')renderCollections();
if(pg==='create')renderCrList();
if(pg==='resource')renderResList();
if(pg==='settings'){renderAllPresets();renderCharCards();updateStats();updateStorageDisplay();}
}

// ==================== TAGS ====================
function renderTags(){
const w=document.getElementById('tagsWrap');w.innerHTML='';
tags.forEach((tag,i)=>{
const isAct=selTags.includes(tag);
const el=document.createElement('span');
el.className='tag'+(isAct?' act':'');
el.innerHTML=esc(tag)+'<span class="tdel" onclick="event.stopPropagation();rmTag('+i+')">✕</span>';
el.onclick=()=>{const idx=selTags.indexOf(tag);if(idx>-1)selTags.splice(idx,1);else selTags.push(tag);renderTags();};
w.appendChild(el);
});
const ab=document.createElement('button');
ab.className='tag-add';ab.textContent='+ 新建';
ab.onclick=()=>showInp('新建标签','输入标签名（自动加#）',v=>{
const t=v.startsWith('#')?v:'#'+v;
if(!tags.includes(t)){tags.push(t);sv(K.tags,tags);renderTags();}
});
w.appendChild(ab);
}
function rmTag(i){selTags=selTags.filter(t=>t!==tags[i]);tags.splice(i,1);sv(K.tags,tags);renderTags();}

// ==================== TYPE SWITCH ====================
function switchType(type,el){
curType=type;
document.querySelectorAll('.ttab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');renderArticles();
}

// ==================== ARTICLES RENDER ====================
function renderArticles(){
const list=document.getElementById('articleList');
const filtered=ws.filter(a=>a&&a.type===curType).slice(0,30);// 限制显示30条提升性能
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><p>还没有作品<br><br>💡 试试这样开始：<br>1. 在上方输入框描述你想要的故事<br>2. 选择几个氛围标签<br>3. 点击「生成」按钮<br><br>或者点击右上角「灵感」获取创意 ✨</p></div>';
return;
}
list.innerHTML='';
const artFrag=document.createDocumentFragment();
filtered.forEach(article=>{
const liked=isLiked(article);
const card=document.createElement('div');
card.className='acard';
card.onclick=e=>{if(!e.target.closest('.btn-like'))openReading(article);};

let text='';
if(article.type==='long'&&article.chapters&&article.chapters.length>0)text=article.chapters[0];
else if(article.content)text=article.content;
const preview=(text||'').substring(0,120).replace(/\n/g,' ');
const wc=getTotalWords(article); const chCount=article.chapters?article.chapters.length:0;
const tagsHtml=(article.tags||[]).map(t=>'<span class="acard-tag">'+esc(t)+'</span>').join('');

card.innerHTML=
'<div class="acard-hd"><div class="acard-t">'+esc(article.title)+'</div>'+
'<span class="acard-badge '+article.type+'">'+(article.type==='long'?'长篇':'短篇')+'</span></div>'+
'<div class="acard-pv">'+esc(preview)+'</div>'+
'<div class="acard-ft">'+
'<span class="acard-wc">'+(chCount>0?chCount+'章 · ':'')+wc+'字 · '+new Date(article.createdAt).toLocaleDateString()+'</span>'+
'<button class="btn-like '+(liked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+article.id+'\')">'+(liked?'❤️ 已收藏':'♡ 收藏')+'</button>'+
'<button class="btn-like" onclick="event.stopPropagation();deleteWsArticle(\''+article.id+'\')" style="color:var(--danger);border-color:rgba(255,107,107,.3)">🗑️</button>'+
'</div>'+
'<div class="acard-tags" style="margin-top:8px">'+tagsHtml+'</div>';
artFrag.appendChild(card);
});
list.appendChild(artFrag);
// 如果还有更多文章，显示提示
const totalFiltered=ws.filter(a=>a&&a.type===curType).length;
if(totalFiltered>30){
const more=document.createElement('div');
more.style.cssText='text-align:center;padding:16px;color:var(--text2);font-size:12px';
more.innerHTML='显示前30篇，共 '+totalFiltered+' 篇<br><button style="margin-top:8px;padding:8px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer" onclick="showAllArticles()">显示全部</button>';
list.appendChild(more);
}
}

// ==================== TOGGLE LIKE (by id) ====================
function showAllArticles(){
const list=document.getElementById('articleList');
const filtered=ws.filter(a=>a&&a.type===curType);
if(filtered.length===0)return;
list.innerHTML='';
filtered.forEach(article=>{
const liked=isLiked(article);
const card=document.createElement('div');
card.className='acard';
card.onclick=e=>{if(!e.target.closest('.btn-like'))openReading(article);};
let text='';
if(article.type==='long'&&article.chapters&&article.chapters.length>0)text=article.chapters[0];
else if(article.content)text=article.content;
const preview=(text||'').substring(0,120).replace(/\n/g,' ');
const wc=getTotalWords(article);
const chCount=article.chapters?article.chapters.length:0;
const tagsHtml=(article.tags||[]).map(t=>'<span class="acard-tag">'+esc(t)+'</span>').join('');
card.innerHTML=
'<div class="acard-hd"><div class="acard-t">'+esc(article.title)+'</div>'+
'<span class="acard-badge '+article.type+'">'+(article.type==='long'?'长篇':'短篇')+'</span></div>'+
'<div class="acard-pv">'+esc(preview)+'</div>'+
'<div class="acard-ft">'+
'<span class="acard-wc">'+(chCount>0?chCount+'章 · ':'')+wc+'字 · '+new Date(article.createdAt).toLocaleDateString()+'</span>'+
'<button class="btn-like '+(liked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+article.id+'\')">'+(liked?'❤️ 已收藏':'♡ 收藏')+'</button>'+
'<button class="btn-like" onclick="event.stopPropagation();deleteWsArticle(\''+article.id+'\')" style="color:var(--danger);border-color:rgba(255,107,107,.3)">🗑️</button>'+
'</div>'+
'<div class="acard-tags" style="margin-top:8px">'+tagsHtml+'</div>';
list.appendChild(card);
});
}
let likeProcessing=false;
function toggleLike(id){
if(likeProcessing)return;
likeProcessing=true;
setTimeout(()=>{likeProcessing=false;},300);
const article=ws.find(a=>a.id===id);
if(!article){likeProcessing=false;return;}
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===id);
if(bIdx>-1){cols.books.splice(bIdx,1);showToast('已取消收藏');}
else{
// Deep copy to avoid reference issues
const copy=JSON.parse(JSON.stringify(article));
copy.cover=null;copy.status='ongoing';copy.rating=0;
cols.books.push(copy);
showToast('已收藏到书架 📚');
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===id);
if(sIdx>-1){cols.shorts.splice(sIdx,1);showToast('已取消收藏');}
else{
const copy=JSON.parse(JSON.stringify(article));
copy.rating=0;
cols.shorts.push(copy);
showToast('已收藏 ❤️');
}
}
sv(K.cols,cols);renderArticles();
}

// ==================== SYNC HELPER ====================
// Sync article data across workshop and collections
function syncArticle(article){
if(!article||!article.id){
console.error('syncArticle: 无效的文章数据');
return;
}
// 备份当前数据以防同步失败
const backup=JSON.stringify(ws);
try{
const wIdx=ws.findIndex(a=>a.id===article.id);
if(wIdx>-1){
ws[wIdx]=JSON.parse(JSON.stringify(article));
sv(K.ws,ws);
}
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===article.id);
if(bIdx>-1){
const cover=cols.books[bIdx].cover;
const status=cols.books[bIdx].status;
const rating=cols.books[bIdx].rating;
cols.books[bIdx]=JSON.parse(JSON.stringify(article));
cols.books[bIdx].cover=cover;
cols.books[bIdx].status=status;
cols.books[bIdx].rating=rating;
sv(K.cols,cols);
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===article.id);
if(sIdx>-1){
const rating=cols.shorts[sIdx].rating;
cols.shorts[sIdx]=JSON.parse(JSON.stringify(article));
cols.shorts[sIdx].rating=rating;
sv(K.cols,cols);
}
}
autoSaveAll();
}catch(e){
console.error('同步失败，尝试恢复:',e);
try{ws=JSON.parse(backup);}catch{}
showToast('数据同步异常，请手动保存',3000);
}
}

// ==================== API CONFIG ====================
function getCurApi(){
return{
url:(document.getElementById('apiUrl').value||'').trim(),
key:(document.getElementById('apiKey').value||'').trim(),
model:(document.getElementById('apiModel').value||'').trim()||'gpt-4o-mini',
temp:parseFloat(document.getElementById('apiTemp').value)||0.8,
maxTokens:parseInt(document.getElementById('apiMaxTokens').value)||4096
};
}
// 拉取模型列表
async function fetchModels(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先填写API地址和密钥');return;}
showToast('正在拉取模型列表...');
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/models',{
headers:{'Authorization':'Bearer '+cfg.key}
});
if(!resp.ok)throw new Error('HTTP '+resp.status);
const data=await resp.json();
let models=[];
if(data.data&&Array.isArray(data.data)){
models=data.data.map(m=>m.id).sort();
}else if(Array.isArray(data)){
models=data.map(m=>m.id||m).sort();
}
if(models.length===0){showToast('未获取到模型');return;}
const dl=document.getElementById('modelSuggest');
dl.innerHTML='';
models.forEach(m=>{
const opt=document.createElement('option');
opt.value=m;
dl.appendChild(opt);
});
showToast('已拉取 '+models.length+' 个模型，点击输入框可选择');
}catch(e){showToast('拉取失败: '+e.message,3000);}
}

// 测试API连接
async function testApiConnection(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先填写API地址和密钥');return;}
const btn=document.getElementById('btnTestApi');
btn.disabled=true;btn.textContent='⏳ 测试中...';
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,
messages:[{role:'user',content:'Hi'}],
max_tokens:5
})
});
if(resp.ok){
const data=await resp.json();
if(data.choices&&data.choices.length>0){
showToast('✅ 连接成功！模型 '+cfg.model+' 可用',3000);
saveCurSettings();
}else{showToast('⚠️ 连接成功但返回异常',3000);}
}else{
const errText=await resp.text();
showToast('❌ 连接失败('+resp.status+'): '+errText.substring(0,100),4000);
}
}catch(e){showToast('❌ 连接失败: '+e.message,3000);}
finally{btn.disabled=false;btn.textContent='🔗 测试连接';}
}

let lastSaveTime=0;
function autoSaveAll(){
const now=Date.now();
if(now-lastSaveTime<1000)return;// 1秒内不重复保存
lastSaveTime=now;
sv(K.ws,ws);
sv(K.cols,cols);
sv(K.tags,tags);
sv(K.ap,ap);
sv('bj_crWorks',crWorks);
sv('bj_resPacks',resPacks);
sv('bj_stream',useStream);
}
function saveCurSettings(){
sv(K.curApi,getCurApi());
saveCharactersFromUI();
sv(K.curWorld,{
desc:document.getElementById('worldDesc').value,
minWords:parseInt(document.getElementById('minWords').value)||800
});
const styleEl=document.getElementById('styleDesc');
if(styleEl){ap.curStyle=styleEl.value;sv(K.ap,ap);}
useStream=document.getElementById('streamOn').checked;sv('bj_stream',useStream);
}

// ==================== CHARACTER MANAGEMENT ====================
function renderCharCards(){
const wrap=document.getElementById('charCards');
wrap.innerHTML='';
characters.forEach((c,i)=>{
const card=document.createElement('div');
card.className='char-card';
const traits=c.traits||[];
const defaultTraits=['内向','外向','冷静','冲动','善良','腹黑','傲娇','温柔','毒舌','天然呆'];
const allTraits=[...defaultTraits,...customTraits];
const curPri=c.priority||'普通';
const traitBtnsHtml=allTraits.map(t=>
'<span class="tag'+(traits.includes(t)?' act':'')+'" style="font-size:10px;padding:3px 8px" onclick="toggleCharTrait('+i+',\''+t+'\',this)">'+t+'</span>'
).join('');
card.innerHTML=
'<div class="char-card-hdr"><span>角色 '+(i+1)+'</span>'+
(characters.length>1?'<button class="char-card-del" onclick="removeChar('+i+')">删除</button>':'')+'</div>'+
'<div class="fg"><label class="fl">名称</label><input class="fi char-name" data-idx="'+i+'" value="'+esc(c.name||'')+'" placeholder="角色名" oninput="saveCharactersFromUI()"></div>'+
'<div class="fg"><label class="fl">性格标签（点击选择）</label>'+
'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="traitWrap'+i+'">'+
traitBtnsHtml+
'<span class="tag" style="font-size:10px;padding:3px 8px;border-style:dashed;color:var(--accent2)" onclick="addCustomTrait('+i+')">+ 自定义</span>'+
'</div></div>'+
'<div class="fg"><label class="fl">重要度</label>'+
'<div style="display:flex;gap:5px;margin-top:4px">'+
'<span class="tag'+(curPri==='核心'?' act':'')+'" onclick="setCharPriority('+i+',\'核心\',this)" style="font-size:10px;padding:3px 8px">🔴 核心</span>'+
'<span class="tag'+(curPri==='普通'?' act':'')+'" onclick="setCharPriority('+i+',\'普通\',this)" style="font-size:10px;padding:3px 8px">🟡 普通</span>'+
'<span class="tag'+(curPri==='参考'?' act':'')+'" onclick="setCharPriority('+i+',\'参考\',this)" style="font-size:10px;padding:3px 8px">🟢 参考</span>'+
'</div></div>'+
'<div class="fg"><label class="fl">详细设定</label><textarea class="fta char-desc" data-idx="'+i+'" placeholder="外貌、背景、说话方式、口头禅..." oninput="saveCharactersFromUI()">'+esc(c.desc||'')+'</textarea></div>';
wrap.appendChild(card);
});
}
// ==================== 人物关系图 ====================
let charRelations=ld('bj_charRelations',[]);
let currentRelType='';
let currentRelDir='双向';
let editingRelIdx=-1;
let npcList=ld('bj_npcList',[]);
let editingNpcIdx=-1;
let currentNpcRole='';

// 关系类型对应的CSS类
function getRelTypeClass(type){
const map={'恋人':'love','暗恋':'love','朋友':'friend','青梅竹马':'friend','敌对':'enemy','宿敌':'enemy','亲属':'family','师徒':'master','主仆':'master','同事':'colleague'};
return map[type]||'other';
}

// 渲染关系列表
function renderRelList(){
const container=document.getElementById('relList');
if(!container)return;
if(charRelations.length===0){
container.innerHTML='<div class="rel-empty">还没有人物关系<br>添加角色后点击「添加关系」建立联系</div>';
return;
}
container.innerHTML='';
charRelations.forEach((rel,i)=>{
const item=document.createElement('div');
item.className='rel-item';
const typeClass=getRelTypeClass(rel.type);
const dirSymbol=rel.direction==='A→B'?'→':rel.direction==='B→A'?'←':'↔';
item.innerHTML=
'<div class="rel-item-names">'+
'<span class="rel-item-name">'+esc(rel.charA||'?')+'</span>'+
'<span class="rel-item-arrow">'+dirSymbol+'</span>'+
'<span class="rel-item-name">'+esc(rel.charB||'?')+'</span>'+
'</div>'+
'<span class="rel-item-type rel-type-'+typeClass+'">'+esc(rel.type||'未知')+'</span>'+
(rel.desc?'<span class="rel-item-desc" title="'+esc(rel.desc)+'">'+esc(rel.desc)+'</span>':'')+
'<div class="rel-item-acts">'+
'<button onclick="editRelation('+i+')">✏️</button>'+
'<button class="del" onclick="deleteRelation('+i+')">✕</button>'+
'</div>';
container.appendChild(item);
});
}

// 获取所有角色名（主角+NPC）
function getAllCharNames(){
const names=[];
characters.forEach(c=>{if(c.name)names.push(c.name);});
npcList.forEach(n=>{if(n.name)names.push(n.name);});
return names;
}

// 填充角色下拉框
function fillRelCharSelects(){
const names=getAllCharNames();
const selA=document.getElementById('relCharA');
const selB=document.getElementById('relCharB');
selA.innerHTML='<option value="">-- 选择人物 --</option>';
selB.innerHTML='<option value="">-- 选择人物 --</option>';
names.forEach(n=>{
selA.innerHTML+='<option value="'+esc(n)+'">'+esc(n)+'</option>';
selB.innerHTML+='<option value="'+esc(n)+'">'+esc(n)+'</option>';
});
}

function addRelation(){
editingRelIdx=-1;
document.getElementById('addRelTitle').textContent='添加人物关系';
fillRelCharSelects();
document.getElementById('relCharA').value='';
document.getElementById('relCharB').value='';
document.getElementById('relTypeCustom').value='';
document.getElementById('relDesc').value='';
currentRelType='';
currentRelDir='双向';
document.querySelectorAll('#addRelOv .tag').forEach(t=>t.classList.remove('act'));
document.getElementById('relDirBoth').classList.add('act');
document.getElementById('addRelBtn').textContent='保存';
document.getElementById('addRelOv').classList.add('show');
}

function editRelation(idx){
if(idx<0||idx>=charRelations.length)return;
editingRelIdx=idx;
const rel=charRelations[idx];
document.getElementById('addRelTitle').textContent='编辑人物关系';
fillRelCharSelects();
document.getElementById('relCharA').value=rel.charA||'';
document.getElementById('relCharB').value=rel.charB||'';
document.getElementById('relTypeCustom').value='';
document.getElementById('relDesc').value=rel.desc||'';
currentRelType=rel.type||'';
currentRelDir=rel.direction||'双向';
// 高亮对应的关系类型标签
document.querySelectorAll('#addRelOv .tag[data-rel]').forEach(t=>{
t.classList.toggle('act',t.dataset.rel===rel.type);
});
// 高亮方向
document.getElementById('relDirBoth').classList.toggle('act',currentRelDir==='双向');
document.getElementById('relDirAB').classList.toggle('act',currentRelDir==='A→B');
document.getElementById('relDirBA').classList.toggle('act',currentRelDir==='B→A');
document.getElementById('addRelBtn').textContent='更新';
document.getElementById('addRelOv').classList.add('show');
}

function closeAddRel(){
document.getElementById('addRelOv').classList.remove('show');
editingRelIdx=-1;
}

function setRelType(type,el){
currentRelType=type;
document.getElementById('relTypeCustom').value='';
document.querySelectorAll('#addRelOv .tag[data-rel]').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}

function setRelDir(dir,el){
currentRelDir=dir;
document.getElementById('relDirBoth').classList.remove('act');
document.getElementById('relDirAB').classList.remove('act');
document.getElementById('relDirBA').classList.remove('act');
el.classList.add('act');
}

function saveRel(){
const charA=document.getElementById('relCharA').value;
const charB=document.getElementById('relCharB').value;
const customType=document.getElementById('relTypeCustom').value.trim();
const type=customType||currentRelType;
const desc=document.getElementById('relDesc').value.trim();
if(!charA||!charB){showToast('请选择两个人物');return;}
if(charA===charB){showToast('不能选择同一个人物');return;}
if(!type){showToast('请选择或输入关系类型');return;}
const rel={charA,charB,type,direction:currentRelDir,desc};
if(editingRelIdx>=0&&editingRelIdx<charRelations.length){
charRelations[editingRelIdx]=rel;
showToast('关系已更新');
}else{
charRelations.push(rel);
showToast('关系已添加 🔗');
}
sv('bj_charRelations',charRelations);
closeAddRel();
renderRelList();
}

function deleteRelation(idx){
if(idx<0||idx>=charRelations.length)return;
const rel=charRelations[idx];
showDlg('删除关系','确定要删除 '+rel.charA+' 和 '+rel.charB+' 的关系吗？',()=>{
charRelations.splice(idx,1);
sv('bj_charRelations',charRelations);
renderRelList();
showToast('关系已删除');
},true);
}

// AI生成人物关系
async function aiGenRelations(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先配置API');return;}
const names=getAllCharNames();
if(names.length<2){showToast('至少需要2个角色（主角或NPC）才能生成关系');return;}
showToast('AI正在分析人物关系...',3000);
let charInfo='';
characters.forEach(c=>{
if(c.name){
charInfo+=c.name;
if(c.traits&&c.traits.length>0)charInfo+='（'+c.traits.join('、')+'）';
if(c.desc)charInfo+='：'+c.desc.substring(0,80);
charInfo+='\n';
}
});
npcList.forEach(n=>{
if(n.name){
charInfo+=n.name+'[NPC-'+n.role+']';
if(n.desc)charInfo+='：'+n.desc.substring(0,60);
charInfo+='\n';
}
});
const sysMsg='根据角色设定，分析所有人物之间可能的关系，包括主角之间、主角与配角(NPC)之间、配角(NPC)与配角(NPC)之间的关系，形成完整的关系网。\n输出格式（每行一条）：\n人物A|人物B|关系类型|方向(双向/A→B/B→A)|简短描述\n\n关系类型可选：恋人、暗恋、朋友、青梅竹马、敌对、宿敌、亲属、师徒、主仆、同事、上下级、竞争对手、邻居、陌生人\n尽可能为每对有交集的人物都建立关系，不要遗漏配角之间的关系。\n只输出关系列表，不要其他内容。';
const userMsg='请分析以下所有角色之间的关系（包括配角与配角之间），构建完整关系网：\n\n'+charInfo;
const result=await callAPINonStream([{role:'system',content:sysMsg},{role:'user',content:userMsg}]);
if(!result){showToast('生成失败');return;}
const lines=result.split('\n').filter(l=>l.includes('|'));
let addCount=0;
lines.forEach(line=>{
const parts=line.split('|').map(p=>p.trim());
if(parts.length>=3){
const exists=charRelations.some(r=>
(r.charA===parts[0]&&r.charB===parts[1])||(r.charA===parts[1]&&r.charB===parts[0])
);
if(!exists){
charRelations.push({
charA:parts[0],charB:parts[1],
type:parts[2],
direction:parts[3]||'双向',
desc:parts[4]||''
});
addCount++;
}
}
});
sv('bj_charRelations',charRelations);
renderRelList();
showToast('AI生成了'+addCount+'条关系 🔗');
}

// ==================== NPC设定 ====================
function renderNpcCards(){
const container=document.getElementById('npcCards');
if(!container)return;
if(npcList.length===0){
container.innerHTML='<div class="rel-empty">还没有NPC<br>点击上方按钮添加配角和路人</div>';
return;
}
container.innerHTML='';
npcList.forEach((npc,i)=>{
const card=document.createElement('div');
card.className='npc-card';
const traitsHtml=(npc.traits||[]).map(t=>'<span style="font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(81,207,102,.1);color:var(--success)">'+esc(t)+'</span>').join(' ');
card.innerHTML=
'<div class="npc-card-hdr">'+
'<span>'+esc(npc.name||'未命名')+'<span class="npc-badge">'+esc(npc.role||'NPC')+'</span></span>'+
'<div style="display:flex;gap:4px">'+
'<button style="padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:9px;cursor:pointer" onclick="editNpc('+i+')">编辑</button>'+
'<button style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:9px;cursor:pointer" onclick="deleteNpc('+i+')">删除</button>'+
'</div>'+
'</div>'+
(npc.appearance?'<div style="font-size:10px;color:var(--text2);margin-bottom:4px">👤 '+esc(npc.appearance)+'</div>':'')+
(traitsHtml?'<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px">'+traitsHtml+'</div>':'')+
(npc.desc?'<div style="font-size:11px;color:var(--text);line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">'+esc(npc.desc)+'</div>':'')+
(npc.chapter?'<div style="font-size:9px;color:var(--text2);margin-top:6px">📍 '+esc(npc.chapter)+'</div>':'');
container.appendChild(card);
});
}

function addNpc(){
editingNpcIdx=-1;
document.getElementById('addNpcTitle').textContent='添加NPC';
document.getElementById('npcName').value='';
document.getElementById('npcRoleCustom').value='';
document.getElementById('npcTraits').value='';
document.getElementById('npcAppearance').value='';
document.getElementById('npcDesc').value='';
document.getElementById('npcChapter').value='';
currentNpcRole='';
document.querySelectorAll('#addNpcOv .tag').forEach(t=>t.classList.remove('act'));
document.getElementById('addNpcBtn').textContent='保存';
document.getElementById('addNpcOv').classList.add('show');
}

function editNpc(idx){
if(idx<0||idx>=npcList.length)return;
editingNpcIdx=idx;
const npc=npcList[idx];
document.getElementById('addNpcTitle').textContent='编辑NPC';
document.getElementById('npcName').value=npc.name||'';
document.getElementById('npcRoleCustom').value='';
document.getElementById('npcTraits').value=(npc.traits||[]).join(',');
document.getElementById('npcAppearance').value=npc.appearance||'';
document.getElementById('npcDesc').value=npc.desc||'';
document.getElementById('npcChapter').value=npc.chapter||'';
currentNpcRole=npc.role||'';
document.querySelectorAll('#addNpcOv .tag').forEach(t=>{
t.classList.toggle('act',t.textContent===npc.role);
});
document.getElementById('addNpcBtn').textContent='更新';
document.getElementById('addNpcOv').classList.add('show');
}

function closeAddNpc(){
document.getElementById('addNpcOv').classList.remove('show');
editingNpcIdx=-1;
}

function setNpcRole(role,el){
currentNpcRole=role;
document.getElementById('npcRoleCustom').value='';
document.querySelectorAll('#addNpcOv .tag').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}

function saveNpc(){
const name=document.getElementById('npcName').value.trim();
if(!name){showToast('请输入NPC名称');return;}
const customRole=document.getElementById('npcRoleCustom').value.trim();
const role=customRole||currentNpcRole||'NPC';
const traitsStr=document.getElementById('npcTraits').value.trim();
const traits=traitsStr?traitsStr.split(/[,，、]/).map(t=>t.trim()).filter(t=>t):[];
const npc={
name,
role,
traits,
appearance:document.getElementById('npcAppearance').value.trim(),
desc:document.getElementById('npcDesc').value.trim(),
chapter:document.getElementById('npcChapter').value.trim()
};
if(editingNpcIdx>=0&&editingNpcIdx<npcList.length){
npcList[editingNpcIdx]=npc;
showToast('NPC已更新');
}else{
npcList.push(npc);
showToast('NPC已添加 🎭');
}
sv('bj_npcList',npcList);
closeAddNpc();
renderNpcCards();
renderRelList();
}

function deleteNpc(idx){
if(idx<0||idx>=npcList.length)return;
showDlg('删除NPC','确定要删除「'+npcList[idx].name+'」吗？',()=>{
const name=npcList[idx].name;
npcList.splice(idx,1);
charRelations=charRelations.filter(r=>r.charA!==name&&r.charB!==name);
sv('bj_npcList',npcList);
sv('bj_charRelations',charRelations);
renderNpcCards();
renderRelList();
showToast('NPC已删除');
},true);
}
function setCharPriority(idx,pri,el){
if(!characters[idx])return;
characters[idx].priority=pri;
sv(K.curChars,characters);
el.parentElement.querySelectorAll('.tag').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}
function renderCustomTraitList(){
const wrap=document.getElementById('customTraitList');
if(!wrap)return;
if(customTraits.length===0){
wrap.innerHTML='<span style="font-size:11px;color:var(--text2)">暂无自定义标签</span>';
return;
}
wrap.innerHTML=customTraits.map(t=>
'<span class="tag act" style="font-size:10px;padding:3px 8px">'+esc(t)+' <span style="margin-left:4px;cursor:pointer" onclick="event.stopPropagation();deleteCustomTrait(\''+t+'\')">✕</span></span>'
).join('');
}

function addCustomTrait(charIdx){
showInp('添加自定义性格标签','输入标签名称（如：话痨、社恐、吃货）',trait=>{
trait=trait.trim();
if(!trait){showToast('标签不能为空');return;}
if(customTraits.includes(trait)){
showToast('该标签已存在');
return;
}
customTraits.push(trait);
sv('bj_customTraits',customTraits);
if(!characters[charIdx].traits)characters[charIdx].traits=[];
characters[charIdx].traits.push(trait);
sv(K.curChars,characters);
renderCharCards();
showToast('已添加标签：'+trait);
});
}

function deleteCustomTrait(trait){
showDlg('删除标签','确定要删除自定义标签「'+trait+'」吗？',()=>{
customTraits=customTraits.filter(t=>t!==trait);
sv('bj_customTraits',customTraits);
characters.forEach(c=>{
if(c.traits)c.traits=c.traits.filter(t=>t!==trait);
});
sv(K.curChars,characters);
renderCharCards();
showToast('标签已删除');
},true);
}

function toggleCharTrait(charIdx,trait,el){
if(!characters[charIdx].traits)characters[charIdx].traits=[];
const idx=characters[charIdx].traits.indexOf(trait);
if(idx>-1){
characters[charIdx].traits.splice(idx,1);
el.classList.remove('act');
}else{
characters[charIdx].traits.push(trait);
el.classList.add('act');
}
sv(K.curChars,characters);
}
function addCharacter(){
characters.push({name:'',desc:'',traits:[]});
sv(K.curChars,characters);
renderCharCards();
showToast('已添加新角色');
}
function removeChar(i){
if(characters.length<=1){showToast('至少保留一个角色');return;}
characters.splice(i,1);
sv(K.curChars,characters);
renderCharCards();
}

function saveCharactersFromUI(){
document.querySelectorAll('.char-name').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].name=el.value;
});
document.querySelectorAll('.char-desc').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].desc=el.value;
});
sv(K.curChars,characters);
}

// ==================== SYSTEM PROMPT ====================
function buildSysPrompt(){
const globalWD=(document.getElementById('globalWorldDesc')&&document.getElementById('globalWorldDesc').value||globalWorld||'').trim();
const localWD=(document.getElementById('worldDesc').value||'').trim();
const wD=[globalWD,localWD].filter(Boolean).join('\n\n');
const mW=parseInt(document.getElementById('minWords').value)||800;

// 核心身份（简洁有力）
let p='你是一位才华横溢的小说家。你写的每一个字都经过灵魂的淬炼，每一个场景都在你脑海中真实上演过。\n\n';

// 写作哲学（精简核心）
p+='【创作信条】\n';
p+='• 真实感是一切的基础——即使是奇幻世界，人物的情感反应也必须真实\n';
p+='• 展示，不要告诉——用行动和细节让读者自己感受，而非旁白解说\n';
p+='• 每个角色都是自己故事的主角——配角也有完整的内心世界\n';
p+='• 好对话的标准：遮住名字也能分辨是谁在说话\n';
p+='• 最动人的情感往往藏在最克制的文字里\n\n';

// 感官写作指南（正面引导）
p+='【让文字有温度——五感写作法】\n';
p+='✦ 视觉不是唯一：每500字至少出现一次非视觉描写（声音/气味/触感/温度/味道）\n\n';
p+='✦ 情绪要用身体说话，永远不要直说"他很紧张/她很开心"：\n';
p+='　紧张 → "他的手指无意识地转着笔，笔尖在纸上戳出一个个小洞。"\n';
p+='　心动 → "她忽然觉得耳朵有点热，低头假装整理书包，手却不知道该放哪里。"\n';
p+='　愤怒 → "他的指节捏得发白，下颌线绷成一条直线。"\n';
p+='　悲伤 → "她盯着杯子里的水面看了很久，直到倒影模糊。"\n';
p+='　尴尬 → "他咳了一声，目光飘向天花板的某个角落，好像那里有什么很有趣的东西。"\n\n';
p+='✦ 环境要有功能——每一处环境描写都要服务于情绪或暗示：\n';
p+='　热 → "柏油路面泛着油光，热浪扭曲了远处的景物。她后背的T恤湿透了。"\n';
p+='　冷 → "呼出的白气在路灯下短暂地亮了一下，她把手缩进袖子里。"\n';
p+='　孤独 → "走廊尽头的日光灯闪了两下，发出细微的嗡嗡声。"\n\n';

// 对话写作（正面示范）
p+='【对话的艺术】\n';
p+='真人说话的特点：会打断、会跑题、会答非所问、会欲言又止。\n';
p+='好的对话示范：\n';
p+='　"你今天怎么——"\n';
p+='　"没什么。"她打断他，顿了顿又说，"就是有点累。"\n';
p+='　他看着她，没再问。有些话不用说出口。\n\n';

// 节奏控制
p+='【节奏呼吸】\n';
p+='紧张时：短句。断句。甚至一个词独立成段。\n';
p+='舒缓时：让句子像河流一样蜿蜒，带着读者慢慢走过风景。\n';
p+='永远不要匀速行驶。\n\n';

// 简化的禁止项（只保留最关键的）
p+='【三条红线】\n';
p+='1. 禁用万能副词：不禁、缓缓、淡淡、微微、默默（删掉它们，句子更有力）\n';
p+='2. 禁用空洞形容：深邃的眼眸、完美的侧脸、不可方物（用具体细节替代）\n';
p+='3. 禁用说书腔：殊不知、岂料、却说、话说（这不是评书）\n\n';

// 输出格式（简洁明确）
p+='【格式要求】\n';
p+='• 第一行：标题（纯文字）\n';
p+='• 空一行后：正文开始\n';
p+='• 每章字数严格不少于'+mW+'字，这是硬性要求，低于此字数视为不合格，必须写够\n'; p+='• 字数计算方式：所有中文字符+标点+数字都算一个字\n'; p+='• 宁可多写也绝对不能少写，建议写到'+(mW+500)+'字以上确保达标\n';
p+='• 段落间空一行\n';
p+='• 对话用「」标注\n';
p+='• 只输出小说正文，无任何说明、章节号、作者按语\n\n';

// 人物设定（优化呈现方式）
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
// 按优先级分组
const coreChars=validChars.filter(c=>c.priority==='核心');
const normalChars=validChars.filter(c=>c.priority!=='核心'&&c.priority!=='参考');
const refChars=validChars.filter(c=>c.priority==='参考');

if(coreChars.length>0){
p+='【核心人物（绝对不能违反以下设定）】\n';
coreChars.forEach(c=>{
if(c.name){
p+='◆ '+c.name;
if(c.traits&&c.traits.length>0)p+='（'+c.traits.join('·')+'）';
p+='\n';
if(c.desc)p+='　'+c.desc.substring(0,500)+(c.desc.length>500?'...':'')+'\n';
}
});
p+='\n';
}

if(normalChars.length>0){
p+='【主要人物】\n';
normalChars.forEach(c=>{
if(c.name){
p+='◆ '+c.name;
if(c.traits&&c.traits.length>0)p+='（'+c.traits.slice(0,4).join('·')+'）';
p+='\n';
if(c.desc)p+='　'+c.desc.substring(0,500)+(c.desc.length>500?'...':'')+'\n';
}
});
p+='\n';
}

if(refChars.length>0){
p+='【参考人物（可灵活处理）】\n';
refChars.forEach(c=>{
if(c.name){
p+='◇ '+c.name;
if(c.traits&&c.traits.length>0)p+='（'+c.traits.slice(0,3).join('·')+'）';
p+='\n';
if(c.desc)p+='　'+c.desc.substring(0,200)+'\n';
}
});
p+='\n';
}

p+='※ 核心人物的设定是铁律，普通人物要保持一致，参考人物可以适当发挥\n\n';
}
// NPC信息
if(npcList.length>0){
p+='【配角/NPC设定】\n';
npcList.forEach(n=>{
if(n.name){
p+='◇ '+n.name+' ['+( n.role||'NPC')+']';
if(n.traits&&n.traits.length>0)p+='（'+n.traits.join('·')+'）';
p+='\n';
if(n.appearance)p+='　外貌：'+n.appearance+'\n';
if(n.desc)p+='　设定：'+n.desc.substring(0,150)+'\n';
if(n.chapter)p+='　出场：'+n.chapter+'\n';
}
});
p+='\n【NPC使用原则】\n';
p+='• NPC是为主线服务的，出场要有目的，不要喧宾夺主\n';
p+='• NPC的言行要符合其角色定位和性格标签\n';
p+='• 路人型NPC可以一笔带过，配角型NPC需要适当刻画\n';
p+='• 反派型NPC要有自己的逻辑和动机，不要脸谱化\n\n';
}

// 人物关系
if(charRelations.length>0){
p+='【人物关系网（铁律，不可违反）】\n';
charRelations.forEach(r=>{
const dir=r.direction==='A→B'?'→':r.direction==='B→A'?'←':'↔';
p+='• '+r.charA+' '+dir+' '+r.charB+'：'+r.type;
if(r.desc)p+='（'+r.desc.substring(0,80)+'）';
p+='\n';
});
p+='\n【关系如何影响写作】\n';
p+='• 恋人/暗恋：注意眼神、微动作、呼吸变化，不要直白说"喜欢"\n';
p+='• 敌对/宿敌：对话要有火药味，但不是无脑骂街，要有智商在线的交锋\n';
p+='• 朋友：说话可以随意，但每个人的随意方式不同\n';
p+='• 亲属：注意辈分和家庭角色带来的说话方式差异\n';
p+='• 师徒/主仆：注意权力关系对语气和行为的影响\n';
p+='• 关系是动态的，但变化必须有事件驱动，不能突然转变\n\n';
}
// 世界观（简化）
if(wD){
p+='【故事发生的世界】\n';
p+=wD.substring(0,1500)+(wD.length>1500?'...':'')+'\n';
p+='※ 世界观是背景，不是说明书，通过人物的日常自然呈现\n\n';
}

// 文风（如果有）
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD){
p+='【文风要求】\n'+styleD+'\n\n';
}

// 规则（如果有）
const globalRD=(document.getElementById('globalRuleDesc')&&document.getElementById('globalRuleDesc').value||globalRule||'').trim();
const localRD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||curRule||'').trim();
const ruleD=[globalRD,localRD].filter(Boolean).join('\n');
if(ruleD){
p+='【创作规则】\n'+ruleD+'\n\n';
}

// 禁用词（如果有）
const globalBD=(document.getElementById('globalBanWordsInput')&&document.getElementById('globalBanWordsInput').value||globalBanWords||'').trim();
const localBD=(document.getElementById('banWordsInput')&&document.getElementById('banWordsInput').value||banWords||'').trim();
const banD=[globalBD,localBD].filter(Boolean).join('\n');
if(banD){
const words=banD.split('\n').map(w=>w.trim()).filter(w=>w).slice(0,20);// 限制数量
if(words.length>0){
p+='【避免使用】'+words.join('、')+'\n\n';
}
}

// 最后的激励（重要！）
// 设定复杂度检测
const totalSettingLen=p.length;
if(totalSettingLen>3000){
p+='【重要提醒】以上设定信息较多，请特别注意：\n';
p+='1. 核心人物的性格和关系是最高优先级，任何情况下不能违反\n';
p+='2. 世界观规则是第二优先级，所有情节必须在世界观框架内\n';
p+='3. 文风和禁用词是第三优先级\n';
p+='4. 如果设定之间有冲突，以核心人物设定为准\n';
p+='5. 不确定的地方宁可保守也不要乱发挥\n\n';
}
p+='现在，深呼吸，让故事在你脑海中活过来。写出让你自己也想继续读下去的文字。\n';

return p;
}

// ==================== STREAM API CALL ====================
async function callAPIStream(messages,onChunk,onDone,onError){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){
showToast('请先在设置中配置API');
if(onError)onError('未配置API');
return;
}
if(!cfg.url.startsWith('http')){
showToast('API地址格式不正确');
if(onError)onError('API地址格式错误');
return;
}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';

abortCtrl=new AbortController();

try{
// 设置超时
const timeoutId=setTimeout(()=>{
if(abortCtrl)abortCtrl.abort();
},120000);// 2分钟超时

const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,messages,temperature:cfg.temp,
max_tokens:cfg.maxTokens,stream:true
}),
signal:abortCtrl.signal
}).finally(()=>clearTimeout(timeoutId));

if(!resp.ok){
const errText=await resp.text();
onError('API请求失败(代码'+resp.status+')，请检查：1.API地址是否正确 2.密钥是否有效 3.余额是否充足');
return;
}

const reader=resp.body.getReader();
const decoder=new TextDecoder();
let buffer='';
let fullText='';

while(true){
const{done,value}=await reader.read();
if(done)break;
buffer+=decoder.decode(value,{stream:true});

const lines=buffer.split('\n');
buffer=lines.pop()||'';

for(const line of lines){
const trimmed=line.trim();
if(!trimmed||trimmed==='data: [DONE]')continue;
if(!trimmed.startsWith('data: '))continue;
try{
const json=JSON.parse(trimmed.slice(6));
const delta=json.choices&&json.choices[0]&&json.choices[0].delta;
if(delta&&delta.content){
fullText+=delta.content;
onChunk(fullText,delta.content);
}
}catch{}
}
}
onDone(fullText);
}catch(err){
if(err.name==='AbortError'){onDone(null);return;}
if(!navigator.onLine){ onError('网络已断开，请检查网络连接后重试'); }else{ onError('请求失败: '+err.message); }
}finally{abortCtrl=null;}
}

// Fallback: non-stream API call
async function callAPINonStream(messages){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return null;}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';
try{
const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({model:cfg.model,messages,temperature:cfg.temp,max_tokens:cfg.maxTokens})
});
if(!resp.ok){const e=await resp.text();throw new Error('API错误('+resp.status+'): '+e.substring(0,200));}
const data=await resp.json();
if(!data.choices||!data.choices[0]||!data.choices[0].message)throw new Error('API返回格式异常');
return data.choices[0].message.content;
}catch(err){showToast('请求失败: '+err.message,3000);return null;}
}

// ==================== GENERATE ARTICLE ====================
// 设定冲突检测
function checkSettingConflicts(){
const issues=[];
const validChars=characters.filter(c=>c.name);
// 检查重名
const names=validChars.map(c=>c.name);
const npcNames=npcList.map(n=>n.name).filter(Boolean);
const allNames=[...names,...npcNames];
const dupNames=allNames.filter((n,i)=>allNames.indexOf(n)!==i);
if(dupNames.length>0)issues.push('⚠️ 发现重名角色：'+dupNames.join('、'));

// 检查关系中引用了不存在的角色
charRelations.forEach(r=>{
if(!allNames.includes(r.charA))issues.push('⚠️ 关系中的「'+r.charA+'」不在角色列表中');
if(!allNames.includes(r.charB))issues.push('⚠️ 关系中的「'+r.charB+'」不在角色列表中');
});

// 检查矛盾关系（同两人既是恋人又是敌对）
const relMap={};
charRelations.forEach(r=>{
const key=[r.charA,r.charB].sort().join('|');
if(!relMap[key])relMap[key]=[];
relMap[key].push(r.type);
});
Object.keys(relMap).forEach(key=>{
const types=relMap[key];
if(types.includes('恋人')&&(types.includes('敌对')||types.includes('宿敌'))){
issues.push('⚠️ '+key.replace('|',' 和 ')+' 同时是恋人和敌对，请确认是否有意为之');
}
});

// 检查世界观和规则是否矛盾
const worldText=(document.getElementById('worldDesc')&&document.getElementById('worldDesc').value||'')+(document.getElementById('globalWorldDesc')&&document.getElementById('globalWorldDesc').value||'');
const ruleText=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||'')+(document.getElementById('globalRuleDesc')&&document.getElementById('globalRuleDesc').value||'');
if(worldText.includes('古代')&&ruleText.includes('现代限定'))issues.push('⚠️ 世界观是古代但规则要求现代限定');
if(worldText.includes('现代')&&ruleText.includes('古风限定'))issues.push('⚠️ 世界观是现代但规则要求古风限定');

return issues;
}

function showSettingPreview(){
    let info = '📋 当前生效设定\n\n';
    
    // 人物
    const validChars = characters.filter(c => c.name);
    if(validChars.length > 0){
        info += '👤 人物 (' + validChars.length + '个)：' + 
                validChars.map(c => c.name).join('、') + '\n\n';
    }
    
    // 世界观
    const worldText = (document.getElementById('worldDesc') && 
                      document.getElementById('worldDesc').value || '').trim();
    if(worldText) info += '🌍 世界观：' + worldText.substring(0,50) + '...\n\n';
    
    // 文风
    const styleText = (document.getElementById('styleDesc') && 
                      document.getElementById('styleDesc').value || '').trim();
    if(styleText) info += '✒️ 文风：' + styleText.substring(0,50) + '...\n\n';
    
    showDlg('当前设定', info, ()=>{});
}
function handleGenBtn(){
if(isGen&&abortCtrl){
if(confirm('确定要停止当前生成吗？')){
abortCtrl.abort();
isGen=false;
const btn=document.getElementById('btnGen');
btn.disabled=false;btn.textContent='生成';
showToast('已停止生成');
}
return;
}
generateArticle();
}
// 快速质量检查
// 设定一致性检查
function checkSettingConsistency(text){
const issues=[];
if(!text||text.length<50)return issues;

// 检查核心角色名字是否出现
const coreChars=characters.filter(c=>c.name&&c.priority==='核心');
coreChars.forEach(c=>{
if(!text.includes(c.name)){
issues.push('核心角色「'+c.name+'」未在本章出现');
}
});

// 检查禁用词是否出现
const globalBD=(document.getElementById('globalBanWordsInput')&&document.getElementById('globalBanWordsInput').value||globalBanWords||'').trim();
const localBD=(document.getElementById('banWordsInput')&&document.getElementById('banWordsInput').value||banWords||'').trim();
const allBan=[globalBD,localBD].filter(Boolean).join('\n');
if(allBan){
const banList=allBan.split('\n').map(w=>w.trim()).filter(w=>w);
banList.forEach(w=>{
const count=(text.match(new RegExp(w,'g'))||[]).length;
if(count>0)issues.push('禁用词「'+w+'」出现了'+count+'次');
});
}

// 检查世界观关键词冲突
const worldText=(document.getElementById('worldDesc')&&document.getElementById('worldDesc').value||'')+(document.getElementById('globalWorldDesc')&&document.getElementById('globalWorldDesc').value||'');
if(worldText.includes('古代')||worldText.includes('宫廷')||worldText.includes('王朝')){
const modernWords=['手机','电脑','汽车','地铁','网络','微信','APP','WiFi'];
modernWords.forEach(w=>{
if(text.includes(w))issues.push('古代背景出现现代词汇「'+w+'」');
});
}
if(worldText.includes('现代')||worldText.includes('都市')){
const ancientWords=['本宫','皇上','奴婢','微臣','圣旨'];
ancientWords.forEach(w=>{
if(text.includes(w))issues.push('现代背景出现古代词汇「'+w+'」');
});
}

return issues;
}
function quickQualityCheck(text){
const issues=[];
const suggestions=[];
if(!text||text.length<100)return {issues,suggestions,score:100};
// 检查万能副词
const badAdverbs={'不禁':0,'缓缓':0,'淡淡':0,'微微':0,'默默':0,'静静':0,'轻轻':0};
Object.keys(badAdverbs).forEach(w=>{
const matches=text.match(new RegExp(w,'g'));
if(matches)badAdverbs[w]=matches.length;
});
const adverbTotal=Object.values(badAdverbs).reduce((a,b)=>a+b,0);
if(adverbTotal>=5){
const worst=Object.entries(badAdverbs).filter(([k,v])=>v>=2).map(([k,v])=>'「'+k+'」'+v+'次').join('、');
issues.push('万能副词过多：'+worst);
suggestions.push('试试删掉这些副词，直接描写动作和状态');
}

// 检查重复句式开头
const paras=text.split(/\n+/).filter(p=>p.trim());
if(paras.length>=5){
const starts={};
paras.forEach(p=>{
const start=p.trim().substring(0,2);
if(start)starts[start]=(starts[start]||0)+1;
});
Object.entries(starts).forEach(([k,v])=>{
if(v>=4){
issues.push('句首「'+k+'」重复'+v+'次，节奏单调');
}
});
if(Object.values(starts).some(v=>v>=4)){
suggestions.push('尝试用对话、动作、环境描写交替开头');
}
}

// 检查对话占比
const dialogCount=(text.match(/[「""][^「""」]+[」""]/g)||[]).length;
const totalParas=paras.length;
if(totalParas>8&&dialogCount<2){
issues.push('对话较少，人物互动不足');
suggestions.push('加入一些对话，让人物"活"起来');
}else if(totalParas>5&&dialogCount>totalParas*0.7){
issues.push('对话占比过高，缺少叙述和描写');
suggestions.push('在对话间穿插动作、表情、环境描写');
}

// 检查感官描写
const senseWords=['听到','闻到','触感','温度','气味','声音','光线','阴影','冰凉','温热'];
let senseCount=0;
senseWords.forEach(w=>{if(text.includes(w))senseCount++;});
if(text.length>500&&senseCount<2){
suggestions.push('可以增加一些感官细节（声音、气味、触感）');
}

// 计算质量分数
let score=100;
score-=issues.length*15;
score-=Math.max(0,adverbTotal-3)*5;
score=Math.max(0,Math.min(100,score));

return {issues,suggestions,score};
}
async function generateArticle(){
// 生成前检查设定冲突
const conflicts=checkSettingConflicts();
if(conflicts.length>0){
showToast('⚠️ 检测到设定问题：'+conflicts[0],4000);
}
if(isGen){
showToast('正在生成中，请稍候...');
return;
}
const searchText=(document.getElementById('searchInput').value||'').trim();
const activeTags=selTags.join(' ');
const type=curType;

let userMsg='';
if(type==='long'){
userMsg+='【创作任务】写一部长篇小说的第一章\n\n';
userMsg+='第一章的使命：\n';
userMsg+='• 用一个抓人的开场切入——可以是一个悬念、一个反常的瞬间、一句意味深长的对话\n';
userMsg+='• 让主角在行动中登场，而不是用旁白介绍\n';
userMsg+='• 建立故事的基调和氛围\n';
userMsg+='• 埋下一两个让读者好奇的种子\n';
userMsg+='• 结尾制造一个"非看下一章不可"的钩子\n\n';
}else{
userMsg+='【创作任务】写一篇完整的短篇小说\n\n';
userMsg+='短篇的精髓是"以小见大"：\n';
userMsg+='• 聚焦一个核心事件或决定性的瞬间\n';
userMsg+='• 人物不需要多，但每个都要鲜活立体\n';
userMsg+='• 结尾要有余韵——可以是反转、可以是留白、可以是一个意象\n';
userMsg+='• 好的短篇读完会让人沉默几秒\n\n';
}

if(searchText){
userMsg+='【故事方向】\n'+searchText+'\n';
userMsg+='（这是灵感种子，请在此基础上自由生长，不必照搬）\n\n';
}

if(activeTags){
userMsg+='【氛围标签】'+activeTags+'\n\n';
}

if(!searchText&&!activeTags){
userMsg+='请根据人设和世界观自由发挥，写一个让你自己也想继续读下去的故事。\n\n';
}
const mW2=parseInt(document.getElementById('minWords').value)||800; userMsg+='\n\n【格式】第一行写标题（纯文字），空一行后直接写正文。只输出标题和正文，无其他内容。'; userMsg+='\n\n【字数硬性要求】本次创作正文字数必须不少于'+mW2+'字！这是最低要求，低于此字数的作品不合格。请确保写够字数，宁多勿少。建议写到'+(mW2+500)+'字以上。';

isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='⏹ 停止';btn.disabled=false;btn.style.minWidth='70px';

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const list=document.getElementById('articleList');

if(!useStream){
// 非流式模式
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='生成';
if(!result){renderArticles();return;}
let title2='',content2=result;
const lines2=result.split(/\n/);
for(let i=0;i<Math.min(5,lines2.length);i++){
const l=lines2[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')){
title2=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
content2=lines2.slice(i+1).join('\n').trim();
break;
}
}
if(!title2||title2.length>35)title2=(searchText||activeTags||'随机故事').substring(0,20);
const article2={
id:uid(),title:title2,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content2]:undefined,
content:type==='short'?content2:undefined,
prompt:searchText
};
ws.unshift(article2);sv(K.ws,ws);
try{recordManualWrite(countWords(result),1);}catch(e){}
renderArticles();showToast('创作完成！✨');
return;
}

// 流式模式
const streamCard=document.createElement('div');
streamCard.className='stream-card';
streamCard.id='streamCard';
const startTime=Date.now();
streamCard.innerHTML=
'<div class="stream-title"><span class="ldots"><span></span><span></span><span></span></span> 正在创作中...</div>'+
'<div class="stream-body" id="streamBody"></div>'+
'<div class="stream-info"><span id="streamWc">0 字</span><span id="streamTime">0s</span></div>';
list.insertBefore(streamCard,list.firstChild);

let timeInterval=setInterval(()=>{
const el=document.getElementById('streamTime');
if(el)el.textContent=((Date.now()-startTime)/1000).toFixed(0)+'s';
},1000);

await callAPIStream(messages,
(fullText,chunk)=>{
const body=document.getElementById('streamBody');
if(body)body.textContent=fullText;
const wc=document.getElementById('streamWc');
if(wc)wc.textContent=countWords(fullText)+' 字';
if(body)body.scrollTop=body.scrollHeight;
},
(fullText)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='生成';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
if(!fullText){renderArticles();return;}
let title='',content=fullText;
const lines=fullText.split(/\n/);
let titleLine='';
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')){
titleLine=l;
content=lines.slice(i+1).join('\n').trim();
break;
}
}
title=titleLine.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
if(!title||title.length>35)title=(searchText||activeTags||'随机故事').substring(0,20);
const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
// 字数不足自动补写
const mWCheck=parseInt(document.getElementById('minWords').value)||800;
const actualWc=countWords(content);
if(actualWc<mWCheck&&actualWc>100){
showToast('字数不足('+actualWc+'/'+mWCheck+')，正在自动补写...',3000);
const extendMsg=[
{role:'system',content:buildSysPrompt()},
{role:'user',content:'以下是一篇未完成的文章，字数只有'+actualWc+'字，距离要求的'+mWCheck+'字还差'+(mWCheck-actualWc)+'字。请直接续写下去，不要重复已有内容，不要加任何标题或说明，直接输出续写的正文部分：\n\n'+content}
];
callAPINonStream(extendMsg).then(function(extResult){
if(extResult){
content=content+'\n\n'+extResult;
if(type==='long'){article.chapters=[content];}
else{article.content=content;}
}
ws.unshift(article);
sv(K.ws,ws);
renderArticles();
const qc=quickQualityCheck(content);
const sc=checkSettingConsistency(content);
if(sc.length>0){
setTimeout(()=>{
showToast('⚠️ 设定问题：'+sc[0],4000);
},2000);
if(sc.length>1){
setTimeout(()=>{
showToast('⚠️ 还有：'+sc.slice(1).join('、'),4000);
},4500);
}
}
if(qc.issues.length>0||qc.suggestions.length>0){
const scoreEmoji=qc.score>=80?'✨':qc.score>=60?'👍':'💪';
showToast('创作完成！'+countWords(content)+'字 · 质量评分 '+qc.score+'/100 '+scoreEmoji,3000);
}else{
showToast('创作完成！'+countWords(content)+'字 ✨',2500);
}
});
}else{
ws.unshift(article);
sv(K.ws,ws);
renderArticles();
const qc=quickQualityCheck(content);

const sc=checkSettingConsistency(content);
if(sc.length>0){
setTimeout(()=>{
showToast('⚠️ 设定问题：'+sc[0],4000);
},2000);
if(sc.length>1){
setTimeout(()=>{
showToast('⚠️ 还有：'+sc.slice(1).join('、'),4000);
},4500);
}
}
if(qc.issues.length>0||qc.suggestions.length>0){
const scoreEmoji=qc.score>=80?'✨':qc.score>=60?'👍':'💪';
showToast('创作完成！'+countWords(content)+'字 · 质量评分 '+qc.score+'/100 '+scoreEmoji,3000);
if(qc.score<70&&qc.suggestions.length>0){
setTimeout(()=>{
showToast('💡 建议：'+qc.suggestions[0],4000);
},1500);
}
}else{
showToast('创作完成！'+countWords(content)+'字 ✨',2500);
}
}
},
(errMsg)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='生成';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
showToast('流式输出失败，尝试普通模式...',2000);
setTimeout(()=>generateNonStream(messages,type,searchText),500);
}
);
}

// Non-stream fallback
async function generateNonStream(messages,type,searchText){
if(isGen)return;
isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='<span class="ldots"><span></span><span></span><span></span></span>';

const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='生成';
if(!result)return;

let title='',content=result;
const lines=result.split(/\n/);
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<35&&!l.startsWith('　')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('「')&&!l.startsWith('——')&&!l.startsWith('…')&&!l.includes('。')&&!l.includes('，')){
title=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
content=lines.slice(i+1).join('\n').trim();
break;
}
}
if(!title||title.length>35)title=(searchText||'随机故事').substring(0,20);

const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);sv(K.ws,ws);
renderArticles();showToast('创作完成！✨');
}

// ==================== READING ====================
function showChapterWordStats(){
if(!curRd||!curRd.chapters)return;
let html='<div style="max-height:60vh;overflow-y:auto">';
html+='<table style="width:100%;border-collapse:collapse;font-size:12px">';
html+='<tr style="border-bottom:2px solid var(--border)"><th style="padding:8px;text-align:left">章节</th><th style="padding:8px;text-align:right">字数</th><th style="padding:8px;text-align:right">占比</th></tr>';
const total=curRd.chapters.reduce((s,ch)=>s+countWords(ch),0);
let min=Infinity,max=0,minIdx=0,maxIdx=0;
curRd.chapters.forEach((ch,i)=>{
const wc=countWords(ch);
if(wc<min){min=wc;minIdx=i;}
if(wc>max){max=wc;maxIdx=i;}
const pct=total>0?(wc/total*100).toFixed(1):'0';
const barW=max>0?(wc/Math.max(...curRd.chapters.map(c=>countWords(c)))*100):0;
const isShort=wc<800;
html+='<tr style="border-bottom:1px solid var(--border);'+(i===curCh?'background:rgba(108,92,231,.1)':'')+'">'+
'<td style="padding:8px">'+(i===curCh?'👉 ':'')+'第'+(i+1)+'章</td>'+
'<td style="padding:8px;text-align:right;'+(isShort?'color:var(--danger)':'')+'">'+wc+'</td>'+
'<td style="padding:8px;text-align:right"><div style="display:flex;align-items:center;justify-content:flex-end;gap:6px"><div style="width:60px;height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="width:'+barW+'%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px"></div></div><span>'+pct+'%</span></div></td></tr>';
});
html+='</table>';
const avg=curRd.chapters.length>0?Math.round(total/curRd.chapters.length):0;
html+='<div style="margin-top:12px;padding:10px;background:var(--card2);border-radius:10px;font-size:11px;line-height:1.8">'+
'📊 <b>统计</b><br>'+
'总字数：<b>'+total+'</b> · 平均每章：<b>'+avg+'</b> 字<br>'+
'最长：第'+(maxIdx+1)+'章 ('+max+'字) · 最短：第'+(minIdx+1)+'章 ('+min+'字)'+
'</div></div>';
showDlg('📊 各章字数统计',html,null,false);
}
function openReading(article){
// Always use the latest version: check workshop first, then collections
let latestArticle=ws.find(a=>a.id===article.id);
if(!latestArticle){
if(article.type==='long')latestArticle=cols.books.find(b=>b.id===article.id);
else latestArticle=cols.shorts.find(s=>s.id===article.id);
}
if(!latestArticle)latestArticle=article;
if(!latestArticle){showToast('文章数据丢失');return;}

curRd=latestArticle;
const savedCh=parseInt(localStorage.getItem('bj_lastCh_'+article.id))||0;
curCh=Math.min(savedCh,article.chapters?article.chapters.length-1:0);

document.getElementById('rdTitle').textContent=curRd.title;
// 显示笔记数量
const allNotes=getArticleNotes(curRd.id);
if(allNotes.length>0){
document.getElementById('rdTitle').textContent=curRd.title+' ('+allNotes.length+'条笔记)';
}
const totalWords=getTotalWords(curRd);
const meta=document.getElementById('rdMeta');
meta.innerHTML=
'<span>'+(curRd.type==='long'?'📖 长篇连载':'📄 短篇')+'</span>'+
'<span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
(curRd.chapters?'<span>共 '+curRd.chapters.length+' 章</span>':'')+
'<span>'+totalWords+' 字</span>';

renderChContent();
updateRdLikeBtn();

const liked=isLiked(curRd);
const cw=document.getElementById('contWrap');
if(curRd.type==='long'){
cw.style.display='block';
const btnCont=document.getElementById('btnCont');
if(liked){
btnCont.disabled=false;
btnCont.textContent='📝 继续连载下一章';
}else{
btnCont.disabled=true;
btnCont.textContent='❤️ 请先收藏后才能续写';
}
}else{
cw.style.display='none';
}

const dirWrap=document.getElementById('dirInputWrap');
dirWrap.style.display=(curRd.type==='long')?'flex':'none';

const undoBtn=document.getElementById('btnUndo');
undoBtn.style.display=(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1)?'inline-block':'none';

// Reading bg
const bg=document.getElementById('rdBg');
if(ap.rdBg){
bg.style.backgroundImage='url('+ap.rdBg+')';
bg.style.display='block';
}else{bg.style.display='none';}

// Apply reading font settings
setRdFont(ap.rdFontSize||15);
setRdLine(ap.rdLineHeight||2);

document.getElementById('rdModal').classList.add('show');
document.getElementById('rdModal').scrollTop=0;
updateNoteBtn();
}

function getTotalWords(article){
if(!article)return 0;
let total=0;
try{
if(article.chapters&&Array.isArray(article.chapters)){
article.chapters.forEach(ch=>total+=countWords(ch||''));
}else if(article.content){
total=countWords(article.content||'');
}
}catch(e){total=0;}
return total;
}

function renderChContent(){
if(!curRd)return;
// 数据完整性检查
if(curRd.type==='long'){
if(!curRd.chapters)curRd.chapters=[''];
if(!Array.isArray(curRd.chapters))curRd.chapters=[curRd.chapters];
if(curCh>=curRd.chapters.length)curCh=curRd.chapters.length-1;
if(curCh<0)curCh=0;
}
const nav=document.getElementById('chNav');
if(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1){
nav.innerHTML='';
// 当前章节指示 + 打开目录按钮
const info=document.createElement('button');
info.className='ch-btn act';
info.textContent='第'+(curCh+1)+'章 / 共'+curRd.chapters.length+'章';
info.onclick=()=>openChapterList();
nav.appendChild(info);

if(curCh>0){
const prev=document.createElement('button');
prev.className='ch-btn';prev.textContent='◀ 上一章';
prev.onclick=()=>{curCh--;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(prev);
}
if(curCh<curRd.chapters.length-1){
const next=document.createElement('button');
next.className='ch-btn';next.textContent='下一章 ▶';
next.onclick=()=>{curCh++;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(next);
}

const listBtn=document.createElement('button');
listBtn.className='ch-btn';listBtn.textContent='📑 目录';
listBtn.onclick=()=>openChapterList();
nav.appendChild(listBtn);
}else{nav.innerHTML='';}

const cdiv=document.getElementById('rdContent');
let text='';
if(curRd.type==='long'&&curRd.chapters)text=curRd.chapters[curCh]||'';
else text=curRd.content||'';

const paras=text.split(/\n+/).filter(p=>p.trim());
cdiv.innerHTML=paras.map((p,pi)=>'<p data-pi="'+pi+'" class="rd-para">'+esc(p.trim())+'</p>').join(''); // 绑定长按引用 cdiv.querySelectorAll('.rd-para').forEach(el=>{ let lpTimer=null; let startX=0,startY=0,moved=false; el.addEventListener('touchstart',function(e){ moved=false; if(e.touches.length>0){startX=e.touches[0].clientX;startY=e.touches[0].clientY;} lpTimer=setTimeout(()=>{ if(moved)return; e.preventDefault(); const text=el.textContent.trim(); if(!text)return; // 震动反馈（如果手机支持） if(navigator.vibrate)navigator.vibrate(30); el.style.background='rgba(108,92,231,.18)'; el.style.boxShadow='inset 0 0 0 1px var(--accent)'; setTimeout(()=>{el.style.background='';el.style.boxShadow='';},1000); showQuoteNote(text); },500); },{passive:false}); el.addEventListener('touchmove',function(e){ if(e.touches.length>0){ const dx=Math.abs(e.touches[0].clientX-startX); const dy=Math.abs(e.touches[0].clientY-startY); if(dx>8||dy>8){moved=true;clearTimeout(lpTimer);} } },{passive:true}); el.addEventListener('touchend',()=>{clearTimeout(lpTimer);}); el.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);}); }); updateNoteBtn();
if(curRd&&curRd.id)localStorage.setItem('bj_lastCh_'+curRd.id,curCh);
}
function showQuoteNote(quoteText){
if(!curRd)return;
const short=quoteText.length>40?quoteText.substring(0,40)+'...':quoteText;
// 直接打开笔记面板并预填引用
openNotePanel();
setTimeout(()=>{
const inp=document.getElementById('noteInput');
inp.value='「'+short+'」\n——我的想法：';
inp.style.height='38px';
inp.style.height=Math.min(inp.scrollHeight,100)+'px';
inp.focus();
// 光标放到末尾
inp.setSelectionRange(inp.value.length,inp.value.length);
},350);
}
function updateRdLikeBtn(){
const btn=document.getElementById('rdLikeBtn');
btn.innerHTML=isLiked(curRd)?'❤️':'♡';
}

function toggleCurrentLike(){
if(!curRd)return;
toggleLike(curRd.id);
// 重新从收藏中获取最新状态
const inBooks=cols.books.some(b=>b.id===curRd.id);
const inShorts=cols.shorts.some(s=>s.id===curRd.id);
updateRdLikeBtn();
updateRdLikeBtn();
const liked=isLiked(curRd);
const cw2=document.getElementById('contWrap');
const dw2=document.getElementById('dirInputWrap');
const bc2=document.getElementById('btnCont');
if(curRd.type==='long'){
cw2.style.display='block';
dw2.style.display='flex';
if(liked){bc2.disabled=false;bc2.textContent='📝 继续连载下一章';}
else{bc2.disabled=true;bc2.textContent='❤️ 请先收藏后才能续写';}
}else{cw2.style.display='none';dw2.style.display='none';}
}
function openChapterList(){
if(!curRd||!curRd.chapters)return;
document.getElementById('chPanelTitle').textContent='「'+curRd.title+'」目录';
document.getElementById('chPanelInfo').textContent='共 '+curRd.chapters.length+' 章 · '+getTotalWords(curRd)+' 字';
const list=document.getElementById('chPanelList');
list.innerHTML='';
curRd.chapters.forEach((_,i)=>{
const wc=countWords(curRd.chapters[i]);
const item=document.createElement('div');
item.className='ch-item'+(i===curCh?' act':'');
const chNotes=getArticleNotes(curRd.id).filter(n=>n.ch===i); const noteTag=chNotes.length>0?' · ✏️'+chNotes.length:''; const readTime=Math.ceil(wc/500); const hasFs=getForeshadows(curRd.id).filter(f=>f.chapter&&f.chapter.includes(''+(i+1))).length; const fsTag=hasFs>0?' · 🎯'+hasFs:''; item.innerHTML='<span class="ch-item-num" style="font-size:14px;font-weight:700;width:60px;flex-shrink:0">第'+(i+1)+'章</span><span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((curRd.chapters[i]||'').replace(/\n/g,' ').substring(0,30))+'</span><span class="ch-item-wc" style="flex-shrink:0;font-size:10px;opacity:.7">'+wc+'字 · '+readTime+'min'+noteTag+fsTag+'</span>';
item.onclick=()=>{curCh=i;renderChContent();closeChapterList();document.getElementById('rdModal').scrollTop=0;};
list.appendChild(item);
});
document.getElementById('chOv').classList.add('show');
}
// ==================== NOTES ====================
let noteFilterTag='全部';
let noteSelectedTag='';

function getArticleNotes(articleId){
if(!articleId)return[];
return ld('bj_notes_'+articleId,[]);
}
function saveArticleNotes(articleId,notes){
sv('bj_notes_'+articleId,notes);
}

function selectNoteTag(tag,el){
noteSelectedTag=tag;
document.querySelectorAll('#noteTagSelect .note-sel-tag').forEach(s=>{
s.classList.remove('act');
s.style.borderColor='var(--border)';
s.style.background='transparent';
s.style.color='var(--text2)';
});
el.classList.add('act');
el.style.borderColor='var(--accent)';
el.style.background='rgba(108,92,231,.15)';
el.style.color='var(--accent2)';
}

function filterNotes(tag,el){
noteFilterTag=tag;
document.querySelectorAll('.note-tag-btn').forEach(b=>{
b.classList.remove('act');
b.style.borderColor='var(--border)';
b.style.background='transparent';
b.style.color='var(--text2)';
});
el.classList.add('act');
el.style.borderColor='var(--accent)';
el.style.background='var(--accent)';
el.style.color='#fff';
renderNotes();
}

function openNotePanel(){
if(!curRd)return;
noteFilterTag='全部';
// 重置筛选按钮
document.querySelectorAll('.note-tag-btn').forEach(b=>{
b.classList.remove('act');
b.style.borderColor='var(--border)';
b.style.background='transparent';
b.style.color='var(--text2)';
});
const firstBtn=document.querySelector('.note-tag-btn[data-tag="全部"]');
if(firstBtn){
firstBtn.classList.add('act');
firstBtn.style.borderColor='var(--accent)';
firstBtn.style.background='var(--accent)';
firstBtn.style.color='#fff';
}
const chLabel=curRd.type==='long'?'第'+(curCh+1)+'章':'全文';
document.getElementById('noteChInfo').textContent=chLabel+'的笔记';
renderNotes();
document.getElementById('noteOv').classList.add('show');
setTimeout(()=>{document.getElementById('noteInput').focus();},300);
}
function closeNotePanel(){
document.getElementById('noteOv').classList.remove('show');
}

function renderNotes(){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
let chNotes=notes.filter(n=>n.ch===curCh);
// 按标签筛选
if(noteFilterTag&&noteFilterTag!=='全部'){
chNotes=chNotes.filter(n=>(n.tag||'')=== noteFilterTag);
}
const list=document.getElementById('noteList');
if(chNotes.length===0){
const hint=noteFilterTag!=='全部'?'该标签下没有笔记':'还没有笔记<br>在下方输入框写下你的想法吧';
list.innerHTML='<div class="note-empty">'+hint+'</div>';
return;
}
list.innerHTML='';
chNotes.forEach((n,idx)=>{
const realIdx=notes.indexOf(n);
const item=document.createElement('div');
item.className='note-item';
const time=n.time?new Date(n.time).toLocaleString():'';
const tagColors={'灵感':'#f1c40f','修改':'#3498db','伏笔':'#e67e22','吐槽':'#2ecc71'};
const tagEmoji={'灵感':'💡','修改':'✏️','伏笔':'🎯','吐槽':'😂'};
let tagHtml='';
if(n.tag){
tagHtml='<span style="display:inline-block;padding:1px 6px;border-radius:6px;font-size:9px;background:'+( tagColors[n.tag]||'var(--accent)')+'22;color:'+(tagColors[n.tag]||'var(--accent2)')+';margin-bottom:4px">'+(tagEmoji[n.tag]||'')+' '+n.tag+'</span>';
}
// 判断是否是引用笔记
const isQuote=n.text.startsWith('「');
let noteStyle='';
if(isQuote){
noteStyle='border-left:3px solid var(--accent);padding-left:12px;background:rgba(108,92,231,.04);border-radius:0 8px 8px 0;padding:10px 12px 10px 14px;margin:-4px -8px;';
}
item.innerHTML=
tagHtml+
'<div class="note-item-text" style="'+noteStyle+'">'+esc(n.text)+'</div>'+
'<div class="note-item-ft">'+
'<span class="note-item-time">'+time+'</span>'+
'<div style="display:flex;gap:4px">'+
'<button style="background:none;border:none;color:var(--text2);font-size:9px;cursor:pointer;padding:2px 6px" onclick="editNote('+realIdx+')">编辑</button>'+
'<button style="background:none;border:none;color:var(--text2);font-size:9px;cursor:pointer;padding:2px 6px" onclick="copyNoteText('+realIdx+')">复制</button>'+
'<button class="note-item-del" onclick="deleteNote('+realIdx+')">删除</button>'+
'</div>'+
'</div>';
// 长按编辑
let lpTimer=null;
let moved=false;
item.addEventListener('touchstart',function(e){
moved=false;
lpTimer=setTimeout(()=>{
if(moved)return;
if(navigator.vibrate)navigator.vibrate(20);
editNote(realIdx);
},600);
},{passive:true});
item.addEventListener('touchmove',function(){moved=true;clearTimeout(lpTimer);},{passive:true});
item.addEventListener('touchend',()=>{clearTimeout(lpTimer);});
item.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);});
list.appendChild(item);
});
list.scrollTop=list.scrollHeight;
}

function addNote(){
if(!curRd)return;
const input=document.getElementById('noteInput');
const text=(input.value||'').trim();
if(!text){showToast('请输入笔记内容');return;}
const notes=getArticleNotes(curRd.id);
notes.push({
ch:curCh,
text:text,
tag:noteSelectedTag||'',
time:new Date().toISOString()
});
saveArticleNotes(curRd.id,notes);
input.value='';
input.style.height='38px';
renderNotes();
updateNoteBtn();
showToast('笔记已保存 ✏️');
// 新笔记滚入视觉反馈
setTimeout(()=>{
const list=document.getElementById('noteList');
const lastItem=list.querySelector('.note-item:last-child');
if(lastItem){
lastItem.style.animation='noteSlideIn .4s ease';
lastItem.scrollIntoView({behavior:'smooth',block:'nearest'});
}
},50);
}

function editNote(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
const n=notes[realIdx];
const input=document.getElementById('noteInput');
input.value=n.text;
input.style.height='38px';
input.style.height=Math.min(input.scrollHeight,100)+'px';
input.focus();
// 设置标签
if(n.tag){
selectNoteTag(n.tag,document.querySelector('#noteTagSelect .note-sel-tag[data-val="'+n.tag+'"]')||document.querySelector('#noteTagSelect .note-sel-tag'));
}
// 删除旧的，保存时会创建新的
notes.splice(realIdx,1);
saveArticleNotes(curRd.id,notes);
renderNotes();
updateNoteBtn();
showToast('正在编辑笔记，修改后点击「记录」保存');
}

function copyNoteText(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
doCopy(notes[realIdx].text);
}

function deleteNote(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
notes.splice(realIdx,1);
saveArticleNotes(curRd.id,notes);
renderNotes();
updateNoteBtn();
showToast('笔记已删除');
}

function updateNoteBtn(){
if(!curRd)return;
const btn=document.getElementById('rdNoteBtn');
if(!btn)return;
const notes=getArticleNotes(curRd.id)||[];
const chNotes=notes.filter(n=>n&&n.ch===curCh);
if(chNotes.length>0){
btn.innerHTML='📝<span class="note-dot"></span>';
btn.title='本章有'+chNotes.length+'条笔记';
}else{
btn.innerHTML='📝';
btn.title='添加笔记';
}
}

function getNoteCount(articleId){
const notes=ld('bj_notes_'+articleId,[]);
return notes.length;
}

function showQuoteNote(quoteText){
if(!curRd)return;
const short=quoteText.length>40?quoteText.substring(0,40)+'...':quoteText;
openNotePanel();
setTimeout(()=>{
const inp=document.getElementById('noteInput');
inp.value='「'+short+'」\n——我的想法：';
inp.style.height='38px';
inp.style.height=Math.min(inp.scrollHeight,100)+'px';
inp.focus();
inp.setSelectionRange(inp.value.length,inp.value.length);
},350);
}
function toggleNoteSearch(){
const wrap=document.getElementById('noteSearchWrap');
if(wrap.style.display==='none'){
wrap.style.display='block';
document.getElementById('noteSearchInput').focus();
}else{
wrap.style.display='none';
document.getElementById('noteSearchInput').value='';
renderNotes();
}
}
function searchNotes(keyword){
if(!curRd)return;
const kw=keyword.trim().toLowerCase();
if(!kw){renderNotes();return;}
const notes=getArticleNotes(curRd.id);
let filtered=notes.filter(n=>n.ch===curCh);
if(noteFilterTag&&noteFilterTag!=='全部'){
filtered=filtered.filter(n=>(n.tag||'')===noteFilterTag);
}
filtered=filtered.filter(n=>n.text.toLowerCase().includes(kw));
const list=document.getElementById('noteList');
if(filtered.length===0){
list.innerHTML='<div class="note-empty" style="padding:20px">没有找到匹配的笔记</div>';
return;
}
list.innerHTML='';
filtered.forEach(n=>{
const realIdx=notes.indexOf(n);
const item=document.createElement('div');
item.className='note-item';
const time=n.time?new Date(n.time).toLocaleString():'';
const tagColors={'灵感':'#f1c40f','修改':'#3498db','伏笔':'#e67e22','吐槽':'#2ecc71'};
const tagEmoji={'灵感':'💡','修改':'✏️','伏笔':'🎯','吐槽':'😂'};
let tagHtml='';
if(n.tag){tagHtml='<span style="display:inline-block;padding:1px 6px;border-radius:6px;font-size:9px;background:'+(tagColors[n.tag]||'var(--accent)')+'22;color:'+(tagColors[n.tag]||'var(--accent2)')+';margin-bottom:4px">'+(tagEmoji[n.tag]||'')+' '+n.tag+'</span>';}
const highlightedText=esc(n.text).replace(new RegExp('('+kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark style="background:rgba(108,92,231,.3);color:var(--text);border-radius:2px;padding:0 2px">$1</mark>');
item.innerHTML=tagHtml+'<div class="note-item-text">'+highlightedText+'</div><div class="note-item-ft"><span class="note-item-time">'+time+'</span><button class="note-item-del" onclick="deleteNote('+realIdx+')">删除</button></div>';
list.appendChild(item);
});
}
function exportArticleNotes(){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(notes.length===0){showToast('没有笔记可导出');return;}
let text='「'+(curRd.title||'未命名')+'」的笔记\n';
text+='导出时间：'+new Date().toLocaleString()+'\n';
text+='共 '+notes.length+' 条笔记\n';
text+='════════════════════\n\n';
const grouped={};
notes.forEach(n=>{
const chKey=curRd.type==='long'?'第'+(n.ch+1)+'章':'全文';
if(!grouped[chKey])grouped[chKey]=[];
grouped[chKey].push(n);
});
Object.keys(grouped).forEach(chKey=>{
text+='【'+chKey+'】\n';
grouped[chKey].forEach(n=>{
const tagStr=n.tag?'['+n.tag+'] ':'';
const time=n.time?new Date(n.time).toLocaleString():'';
text+=tagStr+n.text+'\n';
text+='  — '+time+'\n\n';
});
});
doCopy(text);
showToast('所有笔记已复制到剪贴板 📋');
}
function closeChapterList(){
document.getElementById('chOv').classList.remove('show');
}
function closeReading(){
// 如果正在生成，先确认
if(isGen){
if(!confirm('正在生成中，关闭将停止生成。确定要离开吗？')){
return;
}
}
try{ttsStop();}catch(e){}
try{document.getElementById('ttsBar').classList.remove('show');}catch(e){}
if(abortCtrl){try{abortCtrl.abort();}catch(e){}abortCtrl=null;isGen=false;}
if(isFS)toggleFullscreen();
if(isImmersiveRead)exitImmersiveRead();
stopAutoScroll();
document.getElementById('rdModal').classList.remove('show');
document.getElementById('rdModal').classList.remove('immersive-read');
document.getElementById('rdSettingsPanel').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
closeNotePanel();
closeChapterList();
curRd=null;
curCh=0;
renderArticles();
renderCollections();
}
// ==================== IMMERSIVE READ ====================
let isImmersiveRead=false;
let autoScrolling=false;
let scrollInterval=null;
let scrollSpeed=3;

function enterImmersiveRead(){
const modal=document.getElementById('rdModal');
modal.classList.add('immersive-read');
isImmersiveRead=true;
document.getElementById('bnav').classList.add('hide');
if(document.documentElement.requestFullscreen){
document.documentElement.requestFullscreen().catch(()=>{});
}
showToast('已进入沉浸阅读模式 🌙');
}

function exitImmersiveRead(){
const modal=document.getElementById('rdModal');
modal.classList.remove('immersive-read');
isImmersiveRead=false;
stopAutoScroll();
document.getElementById('bnav').classList.remove('hide');
if(document.fullscreenElement){
document.exitFullscreen().catch(()=>{});
}
}

function toggleAutoScroll(){
if(autoScrolling){
stopAutoScroll();
}else{
startAutoScroll();
}
}

function startAutoScroll(){
autoScrolling=true;
document.getElementById('autoScrollBtn').textContent='⏸ 暂停';
document.getElementById('autoScrollBtn').classList.add('act');
const modal=document.getElementById('rdModal');
const speed=scrollSpeed;
scrollInterval=setInterval(()=>{
modal.scrollTop+=speed;
// 检查是否到底
if(modal.scrollTop+modal.clientHeight>=modal.scrollHeight-50){
stopAutoScroll();
showToast('已到达底部');
}
},50);
}

function stopAutoScroll(){
autoScrolling=false;
document.getElementById('autoScrollBtn').textContent='▶ 自动阅读';
document.getElementById('autoScrollBtn').classList.remove('act');
if(scrollInterval){
clearInterval(scrollInterval);
scrollInterval=null;
}
}

function updateScrollSpeed(){
scrollSpeed=parseInt(document.getElementById('scrollSpeed').value);
document.getElementById('speedVal').textContent=scrollSpeed;
// 如果正在滚动，重新启动以应用新速度
if(autoScrolling){
stopAutoScroll();
startAutoScroll();
}
}

function immersivePrevCh(){
if(!curRd||!curRd.chapters||curCh<=0)return;
stopAutoScroll();
curCh--;
renderChContent();
document.getElementById('rdModal').scrollTop=0;
}

function immersiveNextCh(){
if(!curRd||!curRd.chapters||curCh>=curRd.chapters.length-1)return;
stopAutoScroll();
curCh++;
renderChContent();
document.getElementById('rdModal').scrollTop=0;
}
function toggleFullscreen(){
const modal=document.getElementById('rdModal');
const btn=document.getElementById('btnFS');
const nav=document.getElementById('bnav');
isFS=!isFS;
if(isFS){
modal.classList.add('fs');nav.classList.add('hide');
btn.textContent='⊡';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('fs');nav.classList.remove('hide');
btn.textContent='⛶';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}

function toggleRdSettings(){
document.getElementById('rdSettingsPanel').classList.toggle('show');
}

function setRdFont(v){
v=parseInt(v);
document.getElementById('rdContent').style.setProperty('--rd-fontsize',v+'px');
document.getElementById('rdFontVal').textContent=v;
ap.rdFontSize=v;sv(K.ap,ap);
// Sync range
const range=document.querySelector('#rdSettingsPanel input[type=range]');
if(range&&range.oninput.toString().includes('setRdFont'))range.value=v;
}

function setRdLine(v){
v=parseFloat(v);
document.getElementById('rdContent').style.setProperty('--rd-lineheight',v);
document.getElementById('rdLineVal').textContent=v.toFixed(1);
ap.rdLineHeight=v;sv(K.ap,ap);
}
// 提取章节关键点
function extractKeyPoints(chapterText,chNum){
if(!chapterText)return '（空章节）';
const text=chapterText.replace(/\n+/g,' ').trim();
// 提取对话（通常包含关键信息）
const dialogues=text.match(/[「""]([^「""」]+)[」""]/g)||[];
const keyDialogue=dialogues.length>0?dialogues[Math.floor(dialogues.length/2)]:'';
// 提取开头和结尾的关键句
const sentences=text.split(/[。！？]/);
const opening=sentences[0]||'';
const ending=sentences[sentences.length-2]||'';
let summary=opening.substring(0,40);
if(keyDialogue)summary+='…'+keyDialogue.substring(0,30);
summary+='…'+ending.substring(0,40);
return summary;
}

// 提取故事状态（伏笔、悬念等）
function extractStoryState(article){
if(!article||!article.chapters||article.chapters.length<2)return '';
const allText=article.chapters.join('\n');
const states=[];
// 检测未解决的问题/悬念（以问号结尾的句子）
const questions=allText.match(/[^。！？]*[？?]/g)||[];
if(questions.length>0){
const lastQ=questions[questions.length-1].trim();
if(lastQ.length>5&&lastQ.length<50)states.push('待解悬念：'+lastQ);
}
// 检测情感状态词
const emotionWords=['愤怒','悲伤','喜悦','恐惧','期待','失望','震惊','怀疑'];
const lastCh=article.chapters[article.chapters.length-1]||'';
emotionWords.forEach(w=>{
if(lastCh.includes(w))states.push('情绪基调：'+w);
});
return states.slice(0,3).join('；');
}

// 获取人物当前状态
function getCharacterStates(article){
if(!article||!article.chapters)return '';
const lastCh=article.chapters[article.chapters.length-1]||'';
const validChars=characters.filter(c=>c.name);
if(validChars.length===0)return '';
const states=[];
validChars.forEach(c=>{
if(!c.name)return;
// 检查角色在最后一章的出现和状态
if(lastCh.includes(c.name)){
// 简单的状态推断
const idx=lastCh.lastIndexOf(c.name);
const context=lastCh.substring(Math.max(0,idx-20),Math.min(lastCh.length,idx+50));
states.push(c.name+'：出现于最近场景');
}
});
return states.join('；');
}
// ==================== CONTINUE CHAPTER ====================
// 快速续写（使用已保存的上下文设置）
function quickContinue(){
    if(!curRd) return;
    
    const liked = isLiked(curRd);
    if(!liked){
        showToast('请先点击 ❤️ 收藏后才能续写哦～');
        return;
    }
    
    continueChapterWithContext();
}
async function continueChapter(){
if(isGen){
showToast('正在生成中，请稍候...');
return;
}
if(!curRd||curRd.type!=='long')return;
isGen=true;
const btn=document.getElementById('btnCont');
btn.disabled=true;
btn.innerHTML='正在创作 <span class="ldots"><span></span><span></span><span></span></span>';

const chNum=curRd.chapters.length+1;
const direction=(document.getElementById('dirInput').value||'').trim();

// 构建智能上下文
let context='';
const totalCh=curRd.chapters.length;

// 提取全书关键信息
const storyState=extractStoryState(curRd);
if(storyState){
context+='【故事状态追踪】\n'+storyState+'\n\n';
}

// 如果章节较多，提供智能摘要
if(totalCh>=3){
context+='【前情脉络】\n';
for(let i=Math.max(0,totalCh-4);i<totalCh-1;i++){
const ch=curRd.chapters[i]||'';
const keyPoints=extractKeyPoints(ch,i+1);
context+='第'+(i+1)+'章：'+keyPoints+'\n';
}
context+='\n';
}

// 上一章完整结尾
const lastCh=curRd.chapters[totalCh-1]||'';
const lastChEnding=lastCh.substring(Math.max(0,lastCh.length-1500));
context+='【上一章（第'+totalCh+'章）结尾】\n'+lastChEnding+'\n';

// 人物当前状态
const charStates=getCharacterStates(curRd);
if(charStates){
context+='\n【人物当前状态】\n'+charStates+'\n';
}

// 如果有大纲，提供当前章节的大纲指引
const wsArticle=ws.find(a=>a.id===curRd.id);
const crArticle=crWorks.find(w=>w.id===curRd.id);
const outline=(wsArticle&&wsArticle.outline)||(crArticle&&crArticle.outline)||'';
// 章节大纲
let chOutlineHint='';
if(curRd.chOutlines&&curRd.chOutlines[chNum-1]){
chOutlineHint=curRd.chOutlines[chNum-1];
}
// 也检查收藏和创作页的大纲
if(!chOutlineHint){
const colBook=cols.books.find(b=>b.id===curRd.id);
if(colBook&&colBook.chOutlines&&colBook.chOutlines[chNum-1]){
chOutlineHint=colBook.chOutlines[chNum-1];
}
}
if(!chOutlineHint){
const crWork=crWorks.find(w=>w.id===curRd.id);
if(crWork&&crWork.chOutlines&&crWork.chOutlines[chNum-1]){
chOutlineHint=crWork.chOutlines[chNum-1];
}
}

let outlineHint='';
if(outline){
const outlineLines=outline.split('\n');
for(let i=0;i<outlineLines.length;i++){
const line=outlineLines[i].trim();
if(line.includes('第'+chNum+'章')||line.includes('第'+chNum+'章')){
outlineHint=line;
// 多取几行，获取更完整的章节信息
for(let j=i+1;j<Math.min(i+5,outlineLines.length);j++){
const nextLine=outlineLines[j].trim();
if(nextLine.startsWith('第')&&nextLine.includes('章'))break;// 到下一章了
if(nextLine)outlineHint+='\n'+nextLine;
}
break;
}
}
}

// 构建智能续写提示
let userMsg='【续写任务】创作《'+curRd.title+'》第'+chNum+'章\n\n';

// 故事脉络回顾（智能摘要）
if(totalCh>=2){
userMsg+='【前情回顾】\n';
// 第一章的开头（建立基调）
const firstCh=curRd.chapters[0]||'';
const firstOpening=firstCh.substring(0,200).split('\n')[0];
userMsg+='故事开篇：'+firstOpening+'...\n';

// 中间章节的关键转折（如果有）
if(totalCh>=4){
const midCh=Math.floor(totalCh/2);
const midText=curRd.chapters[midCh]||'';
const midKey=midText.substring(0,150);
userMsg+='中段发展：'+midKey.replace(/\n/g,' ')+'...\n';
}
userMsg+='\n';
}

// 上一章完整结尾（最重要的上下文）
userMsg+='【上一章结尾】\n';
userMsg+=lastChEnding+'\n\n';

// 人物当前状态追踪
if(charStates){
userMsg+='【人物状态】'+charStates+'\n\n';
}

// 章节大纲（如果有）
if(chOutlineHint){
userMsg+='【本章必须完成】\n';
userMsg+=chOutlineHint+'\n';
userMsg+='⚠️ 以上是硬性要求，必须在本章中体现\n\n';
}else if(outlineHint){
userMsg+='【大纲参考】'+outlineHint+'\n\n';
}

// 用户的方向提示
if(direction){
userMsg+='【作者指示】'+direction+'\n\n';
}

// 创作指引（简洁版）
userMsg+='【本章要求】\n';
userMsg+='• 开头直接承接上文，用动作或对话切入，不要复述前情\n';
userMsg+='• 本章要有起伏，至少一个情感转折或情节推进\n';
userMsg+='• 结尾留下钩子，让人想看下一章\n';
userMsg+='• 直接输出正文，无标题无章节号\n'; const mW3=parseInt(document.getElementById('minWords').value)||800; userMsg+='• 【字数硬性要求】本章正文必须不少于'+mW3+'字！低于此字数不合格，宁多勿少，建议写到'+(mW3+500)+'字以上\n';

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const rdContent=document.getElementById('rdContent');
const startTime=Date.now();

if(!useStream){
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!result)return;
curRd.chapters.push(result);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('第'+chNum+'章创作完成！✨');
return;
}

await callAPIStream(messages,
(fullText)=>{
const elapsed=((Date.now()-startTime)/1000).toFixed(0);
const wc=countWords(fullText);
const paras=fullText.split(/\n+/).filter(p=>p.trim());
rdContent.innerHTML=paras.map(p=>'<p>'+esc(p.trim())+'</p>').join('');
document.getElementById('rdModal').scrollTop=document.getElementById('rdModal').scrollHeight;
},
(fullText)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!fullText)return;
curRd.chapters.push(fullText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('第'+chNum+'章创作完成！✨');
},
(errMsg)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
showToast(errMsg,3000);
}
);
}

// ==================== UNDO CHAPTER ====================
function undoChapter(){
if(!curRd||curRd.type!=='long'||!curRd.chapters||curRd.chapters.length<=1)return;
showDlg('撤销确认','确定要删除最后一章（第'+curRd.chapters.length+'章）吗？此操作不可恢复。',()=>{
curRd.chapters.pop();
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();

document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';

if(curRd.chapters.length<=1)document.getElementById('btnUndo').style.display='none';
showToast('已撤销最后一章');
},true);
}

// ==================== COPY ====================
function copyCurChapter(){
if(!curRd)return;
let text='';
if(curRd.type==='long'&&curRd.chapters){
text=curRd.chapters[curCh]||'';
text='《'+curRd.title+'》第'+(curCh+1)+'章\n\n'+text;
}else{
text=curRd.content||'';
}
doCopy(text);
showToast('已复制第'+(curCh+1)+'章 📄');
}
function copyCurrentArticle(){
if(!curRd)return;
let text='';
if(curRd.type==='long'&&curRd.chapters){
curRd.chapters.forEach((ch,i)=>{text+='第'+(i+1)+'章\n\n'+ch+'\n\n';});
}else{text=curRd.content||'';}
// Clean: only remove non-standard whitespace, keep normal spaces and newlines
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');

const header='════════════════════\n「'+curRd.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function doCopy(text){
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(text).then(()=>showToast('已复制到剪贴板 📋')).catch(()=>fbCopy(text));
}else{fbCopy(text);}
}
function fbCopy(text){
const ta=document.createElement('textarea');ta.value=text;
ta.style.cssText='position:fixed;left:-9999px;';
document.body.appendChild(ta);ta.select();
try{document.execCommand('copy');showToast('已复制到剪贴板 📋');}
catch{showToast('复制失败');}
document.body.removeChild(ta);
}

// Fullscreen change listener
document.addEventListener('fullscreenchange',()=>{
if(!document.fullscreenElement&&isFS){
isFS=false;
document.getElementById('rdModal').classList.remove('fs');
document.getElementById('bnav').classList.remove('hide');
document.getElementById('btnFS').textContent='⛶';
}
});

// ==================== COLLECTIONS ====================
function renderCollections(){
const sv_=(document.getElementById('colSearchInput').value||'').trim().toLowerCase();

// Books
const grid=document.getElementById('bookGrid');
let books=cols.books;
if(sv_)books=books.filter(b=>b.title.toLowerCase().includes(sv_));

if(books.length===0){
grid.innerHTML='<div class="empty-st" style="grid-column:1/-1"><div style="font-size:48px;margin-bottom:12px;opacity:.5">📚</div><p>'+(sv_?'没有匹配的长篇':'书架空空如也<br><br>在作坊生成作品后<br>点击「♡ 收藏」即可添加到这里')+'</p></div>';
}else{
grid.innerHTML='';
const bookFrag=document.createDocumentFragment();
books.forEach(book=>{
const realId=book.id;
const card=document.createElement('div');
card.className='bcard';

let covHtml='';
if(book.cover)covHtml='<img src="'+book.cover+'" alt="封面">';
else covHtml='<div class="bcov-ph"><span style="font-size:24px">📖</span><span>'+esc(book.title.substring(0,4))+'</span></div>';

const statusClass=book.status||'ongoing';
const statusText={ongoing:'连载中',complete:'已完结',paused:'暂停'}[statusClass]||'连载中';

card.innerHTML=
'<div class="bcov" onclick="openColBook(\''+realId+'\')">'+covHtml+'</div>'+
'<div class="binfo" onclick="openColBook(\''+realId+'\')">'+
'<div class="binfo-t">'+esc(book.title)+'</div>'+
'<div class="binfo-m">'+(book.chapters?book.chapters.length+'章 · ':'')+ getTotalWords(book)+'字</div>'+
'<span class="binfo-status '+statusClass+'">'+statusText+'</span>'+
renderStarHTML(book.rating||0,realId)+
'</div>'+
'<div class="bacts">'+
'<button class="bact" onclick="event.stopPropagation();uploadCover(\''+realId+'\')">封面</button>'+
'<button class="bact" onclick="event.stopPropagation();cycleStatus(\''+realId+'\')">状态</button>'+
'<button class="bact" onclick="event.stopPropagation();copyBook(\''+realId+'\')">复制</button>'+
'<button class="bact" onclick="event.stopPropagation();exportBookToTxt(\''+realId+'\')">导出</button>'+
'<button class="bact danger" onclick="event.stopPropagation();deleteBook(\''+realId+'\')">删除</button>'+
'</div>';
bookFrag.appendChild(card);
});
grid.appendChild(bookFrag);
}

// Shorts
const sl=document.getElementById('shortList');
let shorts=cols.shorts;
if(sv_)shorts=shorts.filter(s=>s.title.toLowerCase().includes(sv_));

if(shorts.length===0){
sl.innerHTML='<div class="empty-st"><p>'+(sv_?'没有匹配的短篇':'还没有收藏的短篇文章')+'</p></div>';
}else{
sl.innerHTML='';
const shortFrag=document.createDocumentFragment();
shorts.forEach(s=>{
const realId=s.id;
const item=document.createElement('div');
item.className='sitem';
item.onclick=e=>{if(!e.target.closest('button')&&!e.target.closest('.star-rating'))openReading(s);};
item.innerHTML=
'<div class="sitem-info"><div class="sitem-t">'+esc(s.title)+'</div>'+
'<div class="sitem-pv">'+esc((s.content||'').replace(/\n/g,' ').substring(0,20))+'</div>'+
renderStarHTML(s.rating||0,realId)+
'</div>'+
'<div class="sitem-acts">'+
'<button onclick="event.stopPropagation();copyShort(\''+realId+'\')">复制</button>'+
'<button onclick="event.stopPropagation();deleteShort(\''+realId+'\')" style="color:var(--danger)">删除</button>'+
'</div>';
shortFrag.appendChild(item);
});
sl.appendChild(shortFrag);
}

document.getElementById('colCnt').textContent=(cols.books.length+cols.shorts.length)+' 篇';
}

function renderStarHTML(rating,id){
let html='<div class="star-rating">';
for(let i=1;i<=5;i++){
html+='<span class="'+(i<=rating?'filled':'')+'" onclick="event.stopPropagation();setRating(\''+id+'\','+i+')">★</span>';
}
html+='</div>';
return html;
}

function setRating(id,rating){
let found=cols.books.find(b=>b.id===id);
if(found){found.rating=rating;}
else{found=cols.shorts.find(s=>s.id===id);if(found)found.rating=rating;}
sv(K.cols,cols);renderCollections();
}

function cycleStatus(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
const states=['ongoing','complete','paused'];
const cur=states.indexOf(book.status||'ongoing');
book.status=states[(cur+1)%states.length];
sv(K.cols,cols);renderCollections();
const labels={ongoing:'连载中',complete:'已完结',paused:'暂停'};
showToast('状态已切换为：'+labels[book.status]);
}

function openColBook(id){
const book=cols.books.find(b=>b.id===id);
if(book)openReading(book);
}

function uploadCover(id){
const input=document.getElementById('coverUp');
input.onchange=e=>{
const file=e.target.files[0];if(!file)return;
// 检查文件大小
if(file.size>5*1024*1024){
showToast('图片太大，请选择5MB以内的图片',3000);
return;
}
// Compress cover: resize to max 200px width
const canvas=document.createElement('canvas');
const img=new Image();
img.onerror=()=>{showToast('图片加载失败，请换一张');};
img.onload=()=>{
const maxW=200;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
// 检查压缩后大小
if(dataUrl.length>100*1024){
showToast('图片仍然较大，已自动降低质量',2000);
const dataUrl2=canvas.toDataURL('image/jpeg',0.3);
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl2;sv(K.cols,cols);renderCollections();showToast('封面已更新 🎨');}
return;
}
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl;sv(K.cols,cols);renderCollections();showToast('封面已更新 🎨');}
};
img.src=URL.createObjectURL(file);
input.value='';
};
input.click();
}

function copyBook(id){
const book=cols.books.find(b=>b.id===id);if(!book)return;
let text='';
if(book.chapters){book.chapters.forEach((ch,i)=>{text+='第'+(i+1)+'章\n\n'+ch+'\n\n';});}
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='════════════════════\n「'+book.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function deleteBook(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
const chCount=book.chapters?book.chapters.length:0;
const wc=getTotalWords(book);
showDlg('删除确认','确定要删除《'+book.title+'》吗？\n\n📖 '+chCount+' 章 · '+wc+' 字\n\n⚠️ 此操作不可恢复！',()=>{
cols.books=cols.books.filter(b=>b.id!==id);
sv(K.cols,cols);renderCollections();showToast('已删除');
},true);
}

function copyShort(id){
const s=cols.shorts.find(x=>x.id===id);if(!s)return;
let text=s.content||'';
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='════════════════════\n「'+s.title+'」\n本文由「笔记AI」辅助创作生成\n创作工具：笔记AI · Created by 心田\n════════════════════\n\n';
const footer='\n\n════════════════════\n本文由AI辅助创作，内容仅供参考\n创作工具：笔记AI '+APP_VER+'（AI创作工坊）\n网页作者：心田\n════════════════════';
doCopy(header+text+footer);
}

function deleteShort(id){
showDlg('删除确认','确定要删除这篇短文吗？',()=>{
cols.shorts=cols.shorts.filter(s=>s.id!==id);
sv(K.cols,cols);renderCollections();showToast('已删除');
},true);
}

// ==================== SETTINGS ====================
// ==================== SETTINGS MODAL ====================
function openSetModal(type){
const map={api:'setModalApi',char:'setModalChar',world:'setModalWorld',style:'setModalStyle',rule:'setModalRule',ban:'setModalBan',theme:'setModalTheme',notify:'setModalNotify',data:'setModalData'};
const id=map[type];if(!id)return;
document.getElementById(id).classList.add('show');
document.getElementById('bnav').classList.add('hide');
if(type==='char'){renderCharCards();renderCustomTraitList();renderRelList();renderNpcCards();}
if(type==='data')updateStorageDisplay();
renderAllPresets();
}
function closeSetModal(type){
const map={api:'setModalApi',char:'setModalChar',world:'setModalWorld',style:'setModalStyle',rule:'setModalRule',ban:'setModalBan',theme:'setModalTheme',notify:'setModalNotify',data:'setModalData'};
const id=map[type];if(!id)return;
document.getElementById(id).classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
saveCurSettings();
}
function toggleGrp(el){el.classList.toggle('exp');el.nextElementSibling.classList.toggle('show');}

// API Presets
function saveApiPreset(){
showInp('保存API预设','为预设起个名字',name=>{
apiP.push({name,...getCurApi()});
sv(K.apiP,apiP);saveCurSettings();renderApiPresets();showToast('API预设已保存');
});
}
function renderApiPresets(){
const l=document.getElementById('apiPL');l.innerHTML='';
apiP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(p.model||'')+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useApiP('+i+')">使用</button><button class="btn-del" onclick="delApiP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useApiP(i){
const p=apiP[i];
document.getElementById('apiUrl').value=p.url||'';
document.getElementById('apiKey').value=p.key||'';
document.getElementById('apiModel').value=p.model||'';
document.getElementById('apiTemp').value=p.temp??0.8;
document.getElementById('apiMaxTokens').value=p.maxTokens||4096;
saveCurSettings();showToast('已切换: '+p.name);
}
function delApiP(i){apiP.splice(i,1);sv(K.apiP,apiP);renderApiPresets();}

// Char Presets
function saveCharPreset(){
saveCharactersFromUI();
showInp('保存人物预设','为这组人物起个名字',name=>{
charP.push({name,characters:JSON.parse(JSON.stringify(characters)),relations:JSON.parse(JSON.stringify(charRelations)),npcs:JSON.parse(JSON.stringify(npcList))});
sv(K.charP,charP);renderCharPresets();showToast('人物预设已保存');
});
}
function renderCharPresets(){
const l=document.getElementById('charPL');l.innerHTML='';
charP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
const charNames=(p.characters||[]).map(c=>c.name).filter(Boolean).join('、')||'未命名';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(charNames)+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useCharP('+i+')">使用</button><button class="btn-del" onclick="delCharP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useCharP(i){
const p=charP[i];
characters=JSON.parse(JSON.stringify(p.characters||[{name:'',desc:''}]));
sv(K.curChars,characters);
charRelations=JSON.parse(JSON.stringify(p.relations||[]));
sv('bj_charRelations',charRelations);
npcList=JSON.parse(JSON.stringify(p.npcs||[]));
sv('bj_npcList',npcList);
renderCharCards();
renderRelList();
renderNpcCards();
// 加载绑定的局部设定
loadLocalSettingsForPreset(p.name);
showToast('已加载人物: '+p.name);
}
function delCharP(i){charP.splice(i,1);sv(K.charP,charP);renderCharPresets();}

// World Presets
function saveWorldPreset(){
showInp('保存世界观预设','为世界观起个名字',name=>{
worldP.push({name,desc:document.getElementById('worldDesc').value,minWords:parseInt(document.getElementById('minWords').value)||800});
sv(K.worldP,worldP);saveCurSettings();renderWorldPresets();showToast('世界观预设已保存');
});
}
function renderWorldPresets(){
const l=document.getElementById('worldPL');l.innerHTML='';
worldP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+'</span><div class="pitem-a"><button class="btn-use" onclick="useWorldP('+i+')">使用</button><button class="btn-del" onclick="delWorldP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useWorldP(i){
const p=worldP[i];
document.getElementById('worldDesc').value=p.desc||'';
document.getElementById('minWords').value=p.minWords||800;
saveCurSettings();showToast('已加载世界观: '+p.name);
}
function delWorldP(i){worldP.splice(i,1);sv(K.worldP,worldP);renderWorldPresets();}
// 文风预设
function saveStylePreset(){
const desc=(document.getElementById('styleDesc').value||'').trim();
if(!desc){showToast('请先填写文风描述');return;}
showInp('保存文风预设','为这个文风起个名字',name=>{
styleP.push({name,desc});
sv('bj_styleP',styleP);renderStylePresets();showToast('文风预设已保存');
});
}
function renderStylePresets(){
const l=document.getElementById('stylePL');if(!l)return;l.innerHTML='';
styleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useStyleP('+i+')">使用</button><button class="btn-del" onclick="delStyleP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useStyleP(i){
const p=styleP[i];
document.getElementById('styleDesc').value=p.desc||'';
ap.curStyle=p.desc;sv(K.ap,ap);
showToast('已加载文风: '+p.name);
}
function delStyleP(i){styleP.splice(i,1);sv('bj_styleP',styleP);renderStylePresets();}
// 规则预设
function saveRulePreset(){
const desc=(document.getElementById('ruleDesc').value||'').trim();
if(!desc){showToast('请先填写规则内容');return;}
showInp('保存规则预设','为这组规则起个名字',name=>{
ruleP.push({name,desc});
sv('bj_ruleP',ruleP);renderRulePresets();showToast('规则预设已保存');
});
}
function renderRulePresets(){
const l=document.getElementById('rulePL');if(!l)return;l.innerHTML='';
ruleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useRuleP('+i+')">使用</button><button class="btn-del" onclick="delRuleP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useRuleP(i){
const p=ruleP[i];
document.getElementById('ruleDesc').value=p.desc||'';
curRule=p.desc||'';sv('bj_curRule',curRule);
showToast('已加载规则: '+p.name);
}
function delRuleP(i){ruleP.splice(i,1);sv('bj_ruleP',ruleP);renderRulePresets();}
// 禁用词预设
function saveBanWordsPreset(){
const desc=(document.getElementById('banWordsInput').value||'').trim();
if(!desc){showToast('请先填写禁用词');return;}
showInp('保存禁用词预设','为这组禁用词起个名字',name=>{
banWordsP.push({name,desc});
sv('bj_banWordsP',banWordsP);renderBanWordsPresets();showToast('禁用词预设已保存');
});
}
function renderBanWordsPresets(){
const l=document.getElementById('banWordsPL');if(!l)return;l.innerHTML='';
banWordsP.forEach((p,i)=>{
const wordCount=(p.desc||'').split('\n').filter(w=>w.trim()).length;
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+wordCount+'个词)</span></span><div class="pitem-a"><button class="btn-use" onclick="useBanWordsP('+i+')">使用</button><button class="btn-del" onclick="delBanWordsP('+i+')">删除</button></div>';
l.appendChild(it);
});
}
function useBanWordsP(i){
const p=banWordsP[i];
document.getElementById('banWordsInput').value=p.desc||'';
banWords=p.desc||'';sv('bj_banWords',banWords);
showToast('已加载禁用词: '+p.name);
}
function delBanWordsP(i){banWordsP.splice(i,1);sv('bj_banWordsP',banWordsP);renderBanWordsPresets();}
// ==================== 全局/局部设定管理 ====================

// 保存局部世界观
function saveLocalWorld(){
if(!currentWorldBinding)return;
const val=document.getElementById('worldDesc').value||'';
localWorldBindings[currentWorldBinding]=val;
sv('bj_localWorldBindings',localWorldBindings);
}

// 保存局部规则
function saveLocalRule(){
if(!currentRuleBinding)return;
const val=document.getElementById('ruleDesc').value||'';
localRuleBindings[currentRuleBinding]=val;
sv('bj_localRuleBindings',localRuleBindings);
curRule=val;
sv('bj_curRule',curRule);
}

// 保存局部禁用词
function saveLocalBanWords(){
if(!currentBanBinding)return;
const val=document.getElementById('banWordsInput').value||'';
localBanWordsBindings[currentBanBinding]=val;
sv('bj_localBanWordsBindings',localBanWordsBindings);
banWords=val;
sv('bj_banWords',banWords);
}

// 保存局部文风
function saveLocalStyle(){
if(!currentStyleBinding)return;
const val=document.getElementById('styleDesc').value||'';
localStyleBindings[currentStyleBinding]=val;
sv('bj_localStyleBindings',localStyleBindings);
ap.curStyle=val;
sv(K.ap,ap);
}

// 加载角色预设时同步加载绑定的局部设定
function loadLocalSettingsForPreset(presetName){
currentCharPresetName=presetName;
sv('bj_currentCharPresetName',currentCharPresetName);

// 加载局部世界观
const localWorld=localWorldBindings[presetName]||'';
document.getElementById('worldDesc').value=localWorld;

// 加载局部规则
const localRule=localRuleBindings[presetName]||'';
document.getElementById('ruleDesc').value=localRule;
curRule=localRule;
sv('bj_curRule',curRule);

// 加载局部禁用词
const localBan=localBanWordsBindings[presetName]||'';
document.getElementById('banWordsInput').value=localBan;
banWords=localBan;
sv('bj_banWords',banWords);

// 加载局部文风
const localStyle=localStyleBindings[presetName]||'';
document.getElementById('styleDesc').value=localStyle;
ap.curStyle=localStyle;
sv(K.ap,ap);

// 更新界面显示
updateBindingNames();
showToast('已加载「'+presetName+'」的绑定设定');
}

// 更新界面上显示的绑定名称
// 更新绑定下拉框选项
function updateBindingNames(){
const selects=['worldBindingSelect','ruleBindingSelect','banBindingSelect','styleBindingSelect'];
selects.forEach(id=>{
const sel=document.getElementById(id);
if(!sel)return;
sel.innerHTML='<option value="">-- 不绑定 --</option>';
charP.forEach(p=>{
const opt=document.createElement('option');
opt.value=p.name;
opt.textContent=p.name;
sel.appendChild(opt);
});
});
const ws=document.getElementById('worldBindingSelect');
const rs=document.getElementById('ruleBindingSelect');
const bs=document.getElementById('banBindingSelect');
const ss=document.getElementById('styleBindingSelect');
if(ws)ws.value=currentWorldBinding||'';
if(rs)rs.value=currentRuleBinding||'';
if(bs)bs.value=currentBanBinding||'';
if(ss)ss.value=currentStyleBinding||'';
}

function switchWorldBinding(presetName){
if(currentWorldBinding){
localWorldBindings[currentWorldBinding]=document.getElementById('worldDesc').value||'';
sv('bj_localWorldBindings',localWorldBindings);
}
currentWorldBinding=presetName;
sv('bj_currentWorldBinding',currentWorldBinding);
const content=presetName?localWorldBindings[presetName]||'':'';
document.getElementById('worldDesc').value=content;
if(presetName)showToast('已切换到「'+presetName+'」的世界观');
}

function switchRuleBinding(presetName){
if(currentRuleBinding){
localRuleBindings[currentRuleBinding]=document.getElementById('ruleDesc').value||'';
sv('bj_localRuleBindings',localRuleBindings);
}
currentRuleBinding=presetName;
sv('bj_currentRuleBinding',currentRuleBinding);
const content=presetName?localRuleBindings[presetName]||'':'';
document.getElementById('ruleDesc').value=content;
curRule=content;
sv('bj_curRule',curRule);
if(presetName)showToast('已切换到「'+presetName+'」的规则');
}

function switchBanBinding(presetName){
if(currentBanBinding){
localBanWordsBindings[currentBanBinding]=document.getElementById('banWordsInput').value||'';
sv('bj_localBanWordsBindings',localBanWordsBindings);
}
currentBanBinding=presetName;
sv('bj_currentBanBinding',currentBanBinding);
const content=presetName?localBanWordsBindings[presetName]||'':'';
document.getElementById('banWordsInput').value=content;
banWords=content;
sv('bj_banWords',banWords);
if(presetName)showToast('已切换到「'+presetName+'」的禁用词');
}

function switchStyleBinding(presetName){
if(currentStyleBinding){
localStyleBindings[currentStyleBinding]=document.getElementById('styleDesc').value||'';
sv('bj_localStyleBindings',localStyleBindings);
}
currentStyleBinding=presetName;
sv('bj_currentStyleBinding',currentStyleBinding);
const content=presetName?localStyleBindings[presetName]||'':'';
document.getElementById('styleDesc').value=content;
ap.curStyle=content;
sv(K.ap,ap);
if(presetName)showToast('已切换到「'+presetName+'」的文风');
}

// 全局世界观模板
function applyGlobalWorldTemplate(name){
const templates={
'现代都市':'故事发生在当代中国的一线城市。高楼林立，地铁穿梭，人们在快节奏的生活中追逐梦想。社会阶层分明，科技发达，智能手机和社交媒体是日常。',
'古代宫廷':'故事发生在架空的古代王朝，类似明清时期。皇宫巍峨，等级森严，后宫嫔妃争宠，前朝大臣博弈。礼教束缚人心，宫中暗流涌动。',
'仙侠修真':'这是一个修仙者的世界，凡人寿命百年，修士可活千载。天地间有灵气流转，修炼之人可御剑飞行。宗门林立，分正邪两道。修为境界：练气、筑基、金丹、元婴、化神。',
'西方奇幻':'中世纪风格的奇幻大陆，有人类、精灵、矮人等种族。魔法真实存在，王国与王国之间战争不断，冒险者公会遍布各地。',
'末日废土':'核战或病毒爆发后的末日世界，文明崩塌，秩序不存。幸存者在废墟中挣扎求生，物资极度匮乏，变异生物横行。',
'校园青春':'故事发生在高中或大学校园。有教学楼、操场、食堂、宿舍。学生们面临学业压力、友情考验、懵懂爱情。'
};
const desc=templates[name]||'';
document.getElementById('globalWorldDesc').value=desc;
globalWorld=desc;
sv('bj_globalWorld',globalWorld);
showToast('已应用全局世界观: '+name);
}

// 全局规则模板
function applyGlobalRuleTemplate(name){
const templates={
'纯爱向':'- 主角之间是1v1，不允许第三者插足成功\n- 感情线要纯粹，不搞三角恋\n- 结局必须HE',
'无虐向':'- 禁止主角重伤、濒死、失忆等虐心情节\n- 禁止背叛、欺骗等伤害感情的行为\n- 整体氛围要轻松愉快',
'慢热型':'- 感情发展要循序渐进，不能一见钟情\n- 前期要有足够的铺垫和暧昧期\n- 告白要在故事中后期',
'快节奏':'- 情节推进要快，每章都要有新进展\n- 减少日常描写，聚焦关键事件\n- 冲突来得快解决得也快'
};
const desc=templates[name]||'';
document.getElementById('globalRuleDesc').value=desc;
globalRule=desc;
sv('bj_globalRule',globalRule);
showToast('已应用全局规则: '+name);
}

// 全局禁用词模板
function applyGlobalBanTemplate(name){
const templates={
'网文通病':'不禁\n缓缓\n淡淡\n微微\n默默\n静静\n轻轻\n渐渐\n居然\n竟然',
'空洞形容':'深邃的眼眸\n完美的侧脸\n精致的五官\n不可方物\n倾国倾城\n绝世容颜',
'说书腔调':'殊不知\n岂料\n却说\n话说\n且说\n原来\n谁知\n不料'
};
const desc=templates[name]||'';
document.getElementById('globalBanWordsInput').value=desc;
globalBanWords=desc;
sv('bj_globalBanWords',globalBanWords);
showToast('已应用全局禁用词: '+name);
}
function applyStyleTemplate(name){
const templates={
'轻松日常':'语言轻松自然，像朋友聊天一样亲切。多用短句和口语化表达，节奏明快，适当加入生活化的比喻和小幽默。情绪基调温暖舒适，即使写矛盾也不要太沉重。',
'沉郁文学':'语言凝练克制，有分量感。多用意象和隐喻传递情绪，少用直白的情感词汇。句式可以长而复杂，有思辨性。整体氛围沉静内敛，留白多于铺陈。',
'甜宠言情':'语言甜而不腻，注重细节撩拨。善用心理描写展现暧昧和心动，对话要有来有回的化学反应。节奏上张弛有度，甜蜜中穿插小误会小波折。氛围感要强，注重光线、气味、温度等感官细节。',
'悬疑紧张':'语言简洁有力，信息量大。善用短句制造紧迫感，长句铺垫不安氛围。叙述视角要有限制感，让读者和主角一起发现线索。多用暗示和伏笔，关键信息要藏在日常细节里。',
'古风典雅':'语言典雅含蓄，有古典韵味但不堆砌辞藻。可适当化用诗词意境，但对话要通俗易懂。注重意境营造，善用自然景物映射人物心境。节奏舒缓从容，有留白之美。',
'幽默讽刺':'语言机智犀利，善用反差和夸张制造喜感。叙述者的声音要有个性，像一个毒舌但善良的旁观者。可以打破第四面墙，用现代梗和类比让古老的故事焕发新意。笑中带泪最佳。',
'硬核写实':'语言朴素扎实，不修饰不美化。细节要经得起推敲，涉及专业领域要准确。人物说话要符合身份和教育背景，不要人人都出口成章。情节推进靠逻辑而非巧合，冲突来自真实的利益和立场碰撞。'
};
const desc=templates[name]||'';
document.getElementById('styleDesc').value=desc;
ap.curStyle=desc;sv(K.ap,ap);
showToast('已应用文风: '+name);
}
function renderAllPresets(){renderApiPresets();renderCharPresets();renderWorldPresets();renderStylePresets();renderRulePresets();renderBanWordsPresets();}
function applyWorldTemplate(name){
const templates={
'现代都市':'故事发生在当代中国的一线城市。高楼林立，地铁穿梭，人们在快节奏的生活中追逐梦想。社会阶层分明，有光鲜亮丽的CBD精英，也有为生活奔波的普通人。科技发达，智能手机和社交媒体是日常，但人与人之间的真实连接却越来越稀缺。',
'古代宫廷':'故事发生在架空的古代王朝，类似明清时期。皇宫巍峨，等级森严，后宫嫔妃争宠，前朝大臣博弈。礼教束缚人心，女子地位低下，但也有人在夹缝中寻求自我。宫中暗流涌动，一步错满盘皆输。',
'仙侠修真':'这是一个修仙者的世界，凡人寿命百年，修士可活千载。天地间有灵气流转，修炼之人可御剑飞行、呼风唤雨。宗门林立，分正邪两道，为资源和传承明争暗斗。修为境界：练气、筑基、金丹、元婴、化神、渡劫、大乘。',
'西方奇幻':'中世纪风格的奇幻大陆，有人类、精灵、矮人、兽人等种族。魔法真实存在，分为元素系、治愈系、黑暗系等。王国与王国之间战争不断，冒险者公会遍布各地。龙是传说中最强大的生物，魔王的阴影笼罩着大陆。',
'末日废土':'核战或病毒爆发后的末日世界，文明崩塌，秩序不存。幸存者在废墟中挣扎求生，物资极度匮乏，干净的水和食物比黄金珍贵。变异生物横行，人性在极端环境下被考验。有人建立据点试图重建文明，有人沦为掠夺者。',
'校园青春':'故事发生在高中或大学校园。有教学楼、操场、食堂、宿舍这些熟悉的场景。学生们面临学业压力、友情考验、懵懂爱情。社团活动、运动会、毕业季是重要节点。青春期的敏感和冲动，让每一件小事都可能成为大事。',
'民国乱世':'20世纪初的中国，清朝覆灭，军阀割据，外敌环伺。上海滩纸醉金迷，租界里洋人横行。有人投身革命，有人明哲保身，有人在乱世中发国难财。旗袍、长衫、黄包车、留声机是时代符号。新旧思想激烈碰撞。'
};
const desc=templates[name]||'';
document.getElementById('worldDesc').value=desc;
saveCurSettings();
showToast('已应用世界观: '+name);
}
// ==================== APPEARANCE ====================
function setTheme(theme,el){
document.body.className='';
if(theme==='light')document.body.classList.add('theme-light');
else if(theme!=='default')document.body.classList.add('theme-'+theme);
document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
el.classList.add('act');
ap.theme=theme;sv(K.ap,ap);
}
function applyRuleTemplate(name){
const templates={
'纯爱向':'- 主角之间是1v1，不允许出现第三者插足成功的情节\n- 感情线要纯粹，不搞三角恋\n- 可以有误会但必须及时解开\n- 结局必须HE（Happy Ending）',
'无虐向':'- 禁止出现主角重伤、濒死、失忆等虐心情节\n- 禁止出现背叛、欺骗等伤害感情的行为\n- 矛盾冲突要温和，不要撕心裂肺\n- 整体氛围要轻松愉快',
'慢热型':'- 感情发展要循序渐进，不能一见钟情立刻在一起\n- 前期要有足够的铺垫和暧昧期\n- 每一次靠近都要有理由和契机\n- 告白/确定关系要在故事中后期',
'快节奏':'- 情节推进要快，每章都要有新进展\n- 减少日常描写，聚焦关键事件\n- 对话简洁有力，不要废话\n- 冲突来得快解决得也快',
'古风限定':'- 禁止出现任何现代词汇（如"OK""手机""塑料"等）\n- 对话要符合古代语境，可以用"你我"但不要太现代\n- 称呼要用古代方式（公子、姑娘、大人等）\n- 计量单位用古代的（两、尺、里等）',
'现代限定':'- 故事必须发生在当代，不能穿越或架空\n- 所有设定要符合现实逻辑\n- 不能出现魔法、超能力等奇幻元素\n- 科技水平与现实一致'
};
const desc=templates[name]||'';
document.getElementById('ruleDesc').value=desc;
curRule=desc;
sv('bj_curRule',curRule);
showToast('已应用规则: '+name);
}
function applyBanTemplate(name){
const templates={
'网文通病':'不禁\n缓缓\n淡淡\n微微\n默默\n静静\n轻轻\n渐渐\n居然\n竟然\n忍不住\n情不自禁\n下意识',
'空洞形容':'深邃的眼眸\n完美的侧脸\n精致的五官\n不可方物\n倾国倾城\n绝世容颜\n宛如天仙\n美得不可方物\n帅得一塌糊涂',
'说书腔调':'殊不知\n岂料\n却说\n话说\n且说\n原来\n谁知\n不料\n哪知道\n万万没想到',
'全部清空':''
};
const desc=templates[name]||'';
document.getElementById('banWordsInput').value=desc;
banWords=desc;
sv('bj_banWords',banWords);
showToast(name==='全部清空'?'禁用词已清空':'已应用禁用词: '+name);
}
function applyAppearance(){
document.body.className='';
if(ap.theme==='light')document.body.classList.add('theme-light');
else if(ap.theme&&ap.theme!=='default')document.body.classList.add('theme-'+ap.theme);

document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
const themeMap={default:'t0',warm:'t1',green:'t2',blue:'t3',light:'t4'};
const target=document.querySelector('.t-opt.'+(themeMap[ap.theme]||'t0'));
if(target)target.classList.add('act');

if(ap.fontUrl){
document.getElementById('customFontUrl').value=ap.fontUrl;
loadFont(ap.fontUrl);
}
}

function loadFont(url){
const existing=document.getElementById('cfStyle');
if(existing)existing.remove();
if(!url)return;
try{
const sanitized=url.replace(/"/g,'%22').replace(/'/g,'%27');
const style=document.createElement('style');
style.id='cfStyle';
style.textContent='@font-face{font-family:"CF";src:url("'+sanitized+'");font-display:swap;}body,.rd-content,.acard-pv,.acard-t,.rd-title{font-family:"CF",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif!important;}';
document.head.appendChild(style);
}catch(e){showToast('字体加载失败');console.warn(e);}
}

document.getElementById('customFontUrl').addEventListener('change',function(){
ap.fontUrl=this.value.trim();sv(K.ap,ap);loadFont(ap.fontUrl);
if(ap.fontUrl)showToast('字体已更新，如无变化请检查链接');
});

function uploadRdBg(e){
const file=e.target.files[0];if(!file)return;
// Compress bg image
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=600;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
ap.rdBg=dataUrl;sv(K.ap,ap);showToast('阅读背景已设置 🎨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function clearRdBg(){
ap.rdBg='';sv(K.ap,ap);
document.getElementById('rdBg').style.display='none';
showToast('阅读背景已清除');
}
function uploadCrBg(e){
const file=e.target.files[0];if(!file)return;
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=600;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
ap.crBg=dataUrl;sv(K.ap,ap);
applyCrBg();
showToast('创作背景已设置 🎨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function clearCrBg(){
ap.crBg='';sv(K.ap,ap);
document.getElementById('crBg').style.display='none';
showToast('创作背景已清除');
}

function applyCrBg(){
const bg=document.getElementById('crBg');
if(bg){
if(ap.crBg){
bg.style.backgroundImage='url('+ap.crBg+')';
bg.style.display='block';
}else{
bg.style.display='none';
}
}
}
// ==================== DATA IMPORT/EXPORT ====================
function exportAllNotes(){
const allNotes={};
const allArticles=[...ws,...cols.books,...cols.shorts];
const ids=[...new Set(allArticles.map(a=>a.id))];
ids.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
if(n.length>0)allNotes[id]=n;
});
return allNotes;
}
function importAllNotes(notesObj){
if(!notesObj||typeof notesObj!=='object')return;
Object.keys(notesObj).forEach(id=>{
if(Array.isArray(notesObj[id])&&notesObj[id].length>0){
sv('bj_notes_'+id,notesObj[id]);
}
});
}
function exportData(){
saveCurSettings();
markBackupDone();// 标记已备份
const data={
_app:'bijiAI',_version:3,_ver:APP_VER,_exportedAt:new Date().toISOString(),
apiPresets:apiP,charPresets:charP,worldPresets:worldP,
stylePresets:styleP,rulePresets:ruleP,curRule:curRule,banWords:banWords,banWordsPresets:banWordsP,
curApi:ld(K.curApi,{}),
curChars:characters,
charRelations:charRelations,
npcList:npcList,
curWorld:ld(K.curWorld,{}),
collections:cols,workshop:ws,crWorks:crWorks,resPacks:resPacks,tags,appearance:ap,userCard:userCard,globalWorld:globalWorld,
globalRule:globalRule,
globalBanWords:globalBanWords,
localWorldBindings:localWorldBindings,
localRuleBindings:localRuleBindings,
localBanWordsBindings:localBanWordsBindings,
localStyleBindings:localStyleBindings,
currentCharPresetName:currentCharPresetName,notes:exportAllNotes()
};
const jsonStr=JSON.stringify(data,null,2);
const sizeKB=(new Blob([jsonStr]).size/1024).toFixed(1);
const fileName='笔记AI_备份_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';

// 方法1: 尝试使用File System Access API（现代浏览器）
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('数据已保存 ('+sizeKB+'KB) 📤');
}catch(e){
if(e.name!=='AbortError')fallbackExport(jsonStr,fileName);
}
})();
return;
}

// 方法2: 尝试Android WebView的下载方式
if(/android/i.test(navigator.userAgent)){
try{
const blob=new Blob([jsonStr],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('数据已导出，请查看下载目录 📤');
return;
}catch(e){}
}

// 方法3: 通用回退
fallbackExport(jsonStr,fileName);
}

function fallbackExport(jsonStr,fileName){
// 使用data URI方式，兼容性最好
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
showToast('数据已导出 📤');
}

function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI'){showToast('文件格式不正确',3000);return;}
showDlg('导入确认','导入将覆盖当前所有设置和收藏数据，是否继续？',()=>{
if(data.apiPresets){apiP=data.apiPresets;sv(K.apiP,apiP);}
if(data.charPresets){charP=data.charPresets;sv(K.charP,charP);}
if(data.worldPresets){worldP=data.worldPresets;sv(K.worldP,worldP);}
if(data.stylePresets){styleP=data.stylePresets;sv('bj_styleP',styleP);}
if(data.rulePresets){ruleP=data.rulePresets;sv('bj_ruleP',ruleP);}
if(data.curRule){curRule=data.curRule;sv('bj_curRule',curRule);}
if(data.banWords){banWords=data.banWords;sv('bj_banWords',banWords);}
if(data.banWordsPresets){banWordsP=data.banWordsPresets;sv('bj_banWordsP',banWordsP);}
if(data.curApi)sv(K.curApi,data.curApi);
if(data.curChars){characters=data.curChars;sv(K.curChars,characters);}
if(data.charRelations){charRelations=data.charRelations;sv('bj_charRelations',charRelations);}
if(data.npcList){npcList=data.npcList;sv('bj_npcList',npcList);}
else if(data.currentChar){
// v1/ compatibility
const cc=data.currentChar;
characters=[{name:cc.aName||'',desc:cc.aDesc||''},{name:cc.bName||'',desc:cc.bDesc||''}];
sv(K.curChars,characters);
}
if(data.curWorld)sv(K.curWorld,data.curWorld);
else if(data.currentWorld)sv(K.curWorld,data.currentWorld);
if(data.collections){
cols=data.collections;
// Ensure fields
if(!cols.books)cols.books=[];
if(!cols.shorts)cols.shorts=[];
cols.books.forEach(b=>{if(!b.status)b.status='ongoing';if(!b.rating)b.rating=0;});
cols.shorts.forEach(s=>{if(!s.rating)s.rating=0;});
sv(K.cols,cols);
}
if(data.tags){tags=data.tags;sv(K.tags,tags);}
if(data.workshop){ws=data.workshop;sv(K.ws,ws);}
if(data.crWorks){crWorks=data.crWorks;sv('bj_crWorks',crWorks);}
if(data.resPacks){resPacks=data.resPacks;sv('bj_resPacks',resPacks);}
if(data.notes)importAllNotes(data.notes);
if(data.globalWorld){globalWorld=data.globalWorld;sv('bj_globalWorld',globalWorld);}
if(data.globalRule){globalRule=data.globalRule;sv('bj_globalRule',globalRule);}
if(data.globalBanWords){globalBanWords=data.globalBanWords;sv('bj_globalBanWords',globalBanWords);}
if(data.localWorldBindings){localWorldBindings=data.localWorldBindings;sv('bj_localWorldBindings',localWorldBindings);}
if(data.localRuleBindings){localRuleBindings=data.localRuleBindings;sv('bj_localRuleBindings',localRuleBindings);}
if(data.localBanWordsBindings){localBanWordsBindings=data.localBanWordsBindings;sv('bj_localBanWordsBindings',localBanWordsBindings);}
if(data.localStyleBindings){localStyleBindings=data.localStyleBindings;sv('bj_localStyleBindings',localStyleBindings);}
if(data.currentCharPresetName){currentCharPresetName=data.currentCharPresetName;sv('bj_currentCharPresetName',currentCharPresetName);}
if(data.userCard){userCard=data.userCard;sv('bj_userCard',userCard);}
if(data.appearance){
ap={...{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2},...data.appearance};
sv(K.ap,ap);
}

// Reload forms
const api=data.curApi||data.currentApi||{};
document.getElementById('apiUrl').value=api.url||'';
document.getElementById('apiKey').value=api.key||'';
document.getElementById('apiModel').value=api.model||'gpt-4o-mini';
document.getElementById('apiTemp').value=api.temp??0.8;
document.getElementById('apiMaxTokens').value=api.maxTokens||4096;

const world=data.curWorld||data.currentWorld||{};
document.getElementById('worldDesc').value=world.desc||'';
document.getElementById('minWords').value=world.minWords||800;

renderTags();renderAllPresets();renderCollections();renderCharCards();
applyAppearance();
showToast('数据导入成功 📥');
});renderUserCard();
}catch(err){showToast('文件解析失败: '+err.message,3000);}
};
reader.readAsText(file);e.target.value='';
}
function deleteWsArticle(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
showDlg('删除文章','确定要从作坊删除「'+article.title+'」吗？',()=>{
ws=ws.filter(a=>a.id!==id);
sv(K.ws,ws);renderArticles();showToast('已删除');
},true);
}
function cleanOldData(){
const oneMonth=30*24*60*60*1000;
const now=Date.now();
let cleanCount=0;

// 清理一个月前的未收藏作坊文章
ws=ws.filter(a=>{
if(!a||!a.createdAt)return false;
const age=now-new Date(a.createdAt).getTime();
const isLiked_=isLiked(a);
if(age>oneMonth&&!isLiked_){
cleanCount++;
return false;
}
return true;
});

if(cleanCount>0){
sv(K.ws,ws);
renderArticles();
showToast('已清理 '+cleanCount+' 篇旧文章');
}else{
showToast('没有需要清理的旧数据');
}
}

function clearWorkshop(){
const count=ws.length;
if(count===0){showToast('作坊已经是空的');return;}

// 计算总字数
let totalWc=0;
ws.forEach(a=>totalWc+=getTotalWords(a));

showDlg('⚠️ 危险操作','即将删除作坊中的 '+count+' 篇文章（共 '+totalWc+' 字）\n\n已收藏的文章不受影响\n\n建议先导出备份！',()=>{
setTimeout(()=>{
const confirmText='确认删除';
const input=prompt('请输入「'+confirmText+'」来确认此操作：');
if(input===confirmText){
ws=[];sv(K.ws,ws);renderArticles();
showToast('作坊已清空');
markBackupDone();// 重置备份提醒
}else{
showToast('操作已取消');
}
},100);
},true);
}

// ==================== CREATE PAGE ====================
function switchCrTab(tab,el){
crTab=tab;
document.querySelectorAll('.cr-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
const goalPanel=document.getElementById('goalPanel');
const crList=document.getElementById('crList');
if(tab==='goal'){
crList.style.display='none';
goalPanel.style.display='block';
renderGoalPanel();
}else{
crList.style.display='';
goalPanel.style.display='none';
renderCrList();
}
}
function renderCrList(){
const list=document.getElementById('crList');
const filtered=crWorks.filter(w=>w.type===crTab);
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><p>'+(crTab==='draft'?'还没有草稿<br>点击上方「新建草稿」开始写作':'还没有小说<br>点击上方「新建小说」开始连载')+'</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(work=>{
const card=document.createElement('div');
card.className='cr-card';
let preview='';
if(work.type==='draft'){
preview=(work.content||'').replace(/\n/g,' ').substring(0,60);
}else{
const lastCh=work.chapters&&work.chapters.length>0?work.chapters[work.chapters.length-1]:'';
preview=(lastCh||'').replace(/\n/g,' ').substring(0,60);
}
const wc=getCrWordCount(work);
const time=work.updatedAt?new Date(work.updatedAt).toLocaleDateString():'';
const chInfo=work.type==='novel'&&work.chapters?' · '+work.chapters.length+'章':'';
card.innerHTML=
'<div class="cr-card-hd">'+
'<div class="cr-card-t">'+esc(work.title||'无标题')+'</div>'+
'<span class="cr-card-badge '+work.type+'">'+(work.type==='draft'?'草稿':'小说')+'</span>'+
'</div>'+
'<div class="cr-card-pv">'+esc(preview||'暂无内容')+'</div>'+
'<div class="cr-card-ft">'+
'<span class="cr-card-info">'+wc+'字'+chInfo+' · '+time+'</span>'+
'<div class="cr-card-acts">'+
'<button onclick="event.stopPropagation();copyCrWork(\''+work.id+'\')">复制</button>'+
'<button onclick="event.stopPropagation();exportSingleCrWork(\''+work.id+'\')">导出</button>'+ '<button onclick="event.stopPropagation();shareCrToRes(\''+work.id+'\')">分享</button>'+ '<button class="danger" onclick="event.stopPropagation();deleteCrWork(\''+work.id+'\')">删除</button>'+
'</div>'+
'</div>';
card.onclick=e=>{if(!e.target.closest('.cr-card-acts'))openEditor(work.id);};
list.appendChild(card);
});
}
function getCrWordCount(work){
if(work.type==='draft')return countWords(work.content||'');
let total=0;
if(work.chapters)work.chapters.forEach(ch=>total+=countWords(ch));
return total;
}
function newDraft(){
const work={
id:uid(),type:'draft',title:'',content:'',
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
}
function newNovel(){
showInp('新建小说','给小说起个名字',name=>{
const work={
id:uid(),type:'novel',title:name,chapters:[''],
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
});
}
function deleteCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
showDlg('删除确认','确定要删除「'+(work.title||'无标题')+'」吗？不可恢复。',()=>{
crWorks=crWorks.filter(w=>w.id!==id);
sv('bj_crWorks',crWorks);
renderCrList();
showToast('已删除');
},true);
}
function copyCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
let text='';
if(work.type==='draft'){
text=work.content||'';
}else if(work.chapters){
work.chapters.forEach((ch,i)=>{
text+='第'+(i+1)+'章\n\n'+ch+'\n\n';
});
}
const header='════════════════════\n「'+(work.title||'无标题')+'」\n原创作品 · 笔记AI创作页\n════════════════════\n\n';
const footer='\n\n════════════════════\n创作工具：笔记AI '+APP_VER+'\n════════════════════';
doCopy(header+text.trim()+footer);
}

// ==================== EDITOR ====================
// ==================== IMMERSIVE EDIT ====================
let isImmersiveEdit=false;
function toggleImmersiveEdit(){
const modal=document.getElementById('edModal');
isImmersiveEdit=!isImmersiveEdit;
if(isImmersiveEdit){
modal.classList.add('immersive');
document.getElementById('immersiveEditBtn').textContent='☀️ 普通';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('immersive');
document.getElementById('immersiveEditBtn').textContent='🌙 沉浸';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}
function openEditor(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
curEd=work;
curEdCh=0;
document.getElementById('edTitle').value=work.title||'';
if(work.type==='novel'){
document.getElementById('edChBar').style.display='flex';
document.getElementById('edTextarea').value=work.chapters[curEdCh]||'';
renderEdChBar();
}else{
document.getElementById('edChBar').style.display='none';
document.getElementById('edTextarea').value=work.content||'';
}
updateEdWc();
document.getElementById('edSaveStatus').textContent='已保存';
document.getElementById('edOutlineBtn').style.display=(work.outline?'':'none');
document.getElementById('edChOutlineBtn').style.display=(work.type==='novel'?'':'none');
applyCrBg();
document.getElementById('edModal').classList.add('show');
// 启动自动保存
   if(autoSaveInterval) clearInterval(autoSaveInterval);
   autoSaveInterval = setInterval(() => {
       if(curEd) saveEditorContent();
   }, 5000); // 每5秒自动保存一次
document.getElementById('bnav').classList.add('hide');
}
function closeEditor(){
// 关闭自动保存
   if(autoSaveInterval) {
       clearInterval(autoSaveInterval);
       autoSaveInterval = null;
   }
// 检查是否有未保存的修改
const currentText=document.getElementById('edTextarea').value||'';
let savedText='';
if(curEd){
if(curEd.type==='novel'&&curEd.chapters){
savedText=curEd.chapters[curEdCh]||'';
}else{
savedText=curEd.content||'';
}
}

if(currentText!==savedText&&currentText.length>0){
if(!confirm('有未保存的修改，确定要离开吗？\n\n点击「确定」会自动保存。')){
return;
}
}

saveEditorContent();
if(isImmersiveEdit){
document.getElementById('edModal').classList.remove('immersive');
isImmersiveEdit=false;
}
document.getElementById('edModal').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
curEd=null;
renderCrList();
}
function renderEdChBar(){
if(!curEd||curEd.type!=='novel')return;
const total=curEd.chapters.length;
document.getElementById('edChCurrent').textContent='第'+(curEdCh+1)+'章 / 共'+total+'章';
document.getElementById('edPrevBtn').style.display=curEdCh>0?'':'none';
document.getElementById('edNextBtn').style.display=curEdCh<total-1?'':'none';
}
function openEdChList(){
if(!curEd||curEd.type!=='novel')return;
saveEditorChapter();
const total=curEd.chapters.length;
let totalWords=0;
curEd.chapters.forEach(ch=>totalWords+=countWords(ch||''));
document.getElementById('edChPanelTitle').textContent='「'+(curEd.title||'未命名')+'」';
document.getElementById('edChPanelInfo').textContent='共 '+total+' 章 · '+totalWords+' 字';
const list=document.getElementById('edChPanelList');
list.innerHTML='';
curEd.chapters.forEach((ch,i)=>{
const wc=countWords(ch||'');
const preview=(ch||'').replace(/\n/g,' ').substring(0,30);
const hasOutline=curEd.chOutlines&&curEd.chOutlines[i];
const item=document.createElement('div');
item.className='ch-item'+(i===curEdCh?' act':'');
item.innerHTML=
'<span class="ch-item-num" style="width:55px;flex-shrink:0">第'+(i+1)+'章</span>'+
'<span style="flex:1;font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(preview||'空白章节')+'</span>'+
'<span class="ch-item-wc" style="flex-shrink:0">'+wc+'字'+(hasOutline?' 📋':'')+'</span>';
item.onclick=()=>{
curEdCh=i;
document.getElementById('edTextarea').value=curEd.chapters[i]||'';
updateEdWc();
renderEdChBar();
closeEdChList();
};
list.appendChild(item);
});
document.getElementById('edChOv').classList.add('show');
}
function closeEdChList(){
document.getElementById('edChOv').classList.remove('show');
}
function goEdPrevCh(){
if(!curEd||curEdCh<=0)return;
saveEditorChapter();
curEdCh--;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function goEdNextCh(){
if(!curEd||curEdCh>=curEd.chapters.length-1)return;
saveEditorChapter();
saveEditorContent();
curEdCh++;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function addEdChapter(){
if(!curEd)return;
saveEditorChapter();
curEd.chapters.push('');
if(!curEd.chOutlines)curEd.chOutlines=[];
curEd.chOutlines.push('');
curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value='';
updateEdWc();
renderEdChBar();
saveEditorContent();
closeEdChList();
// 记录新增章节到创作目标
recordManualWrite(0,1);
showToast('已添加第'+curEd.chapters.length+'章');
}
function saveEditorChapter(){
if(!curEd)return;
const text=document.getElementById('edTextarea').value;
if(curEd.type==='novel'){
if(curEd.chapters[curEdCh]!==undefined)curEd.chapters[curEdCh]=text;
}else{
curEd.content=text;
}
}
function saveEditorContent(){
if(!curEd)return;
// 记录保存前的字数（用于计算增量）
let oldWc=0;
const oldWork=crWorks.find(w=>w.id===curEd.id);
if(oldWork){
if(oldWork.type==='novel'&&oldWork.chapters){
oldWork.chapters.forEach(ch=>oldWc+=countWords(ch||''));
}else{oldWc=countWords(oldWork.content||'');}
}
saveEditorChapter();
curEd.title=(document.getElementById('edTitle').value||'').trim();
curEd.updatedAt=new Date().toISOString();
const idx=crWorks.findIndex(w=>w.id===curEd.id);
if(idx>-1)crWorks[idx]=curEd;
sv('bj_crWorks',crWorks);
document.getElementById('edSaveStatus').textContent='已保存 ✓';
// 计算新增字数，记录到创作目标
let newWc=0;
if(curEd.type==='novel'&&curEd.chapters){
curEd.chapters.forEach(ch=>newWc+=countWords(ch||''));
}else{newWc=countWords(curEd.content||'');}
const addedWords=newWc-oldWc;
if(addedWords>0){
recordManualWrite(addedWords,0);
}
}
function onEditorInput(){
updateEdWc();
document.getElementById('edSaveStatus').textContent='编辑中...';
if(edAutoSaveTimer)clearTimeout(edAutoSaveTimer);
edAutoSaveTimer=setTimeout(()=>{
saveEditorContent();
document.getElementById('edSaveStatus').textContent='已自动保存 ✓';
},2000);
}
function updateEdWc(){
const text=document.getElementById('edTextarea').value||'';
const wc=countWords(text);
const wcEl=document.getElementById('edWc');
wcEl.textContent=wc;
// 预计阅读时间（按每分钟500字计算）
const readTime=Math.ceil(wc/500);
const rtEl=document.getElementById('edReadTime');
if(rtEl)rtEl.textContent=readTime>0?'约'+readTime+'分钟阅读':'';
// 字数目标提醒
const minWords=parseInt(document.getElementById('minWords').value)||800;
if(wc>0&&wc<minWords){
wcEl.style.color='var(--danger)';
wcEl.title='未达到最低字数要求('+minWords+'字)';
}else if(wc>=minWords){
wcEl.style.color='var(--success)';
wcEl.title='已达到字数要求 ✓';
}else{
wcEl.style.color='var(--accent2)';
wcEl.title='';
}
}
function copyEditorContent(){
if(!curEd)return;
saveEditorContent();
copyCrWork(curEd.id);
}
function formatEditorText(){
const ta=document.getElementById('edTextarea');
let text=ta.value||'';
// 先把多个连续空行合并成一个
text=text.replace(/\n{3,}/g,'\n\n');
// 把单个换行（没有空行分隔的段落）变成空行分隔
const lines=text.split('\n');
let result=[];
for(let i=0;i<lines.length;i++){
const line=lines[i];
result.push(line);
if(line.trim()&&i+1<lines.length&&lines[i+1].trim()){
result.push('');
}
}
text=result.join('\n');
text=text.replace(/\n{3,}/g,'\n\n');
text=text.trim();
ta.value=text;
onEditorInput();
showToast('排版完成 ¶');
}
// ==================== AI REVIEW ====================
async function requestAIReview(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
saveEditorContent();
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<20){showToast('内容太少，至少写20字再请AI评价');return;}
const body=document.getElementById('aiReviewBody');
body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2)"><span class="ldots"><span></span><span></span><span></span></span><br>AI正在阅读你的作品...</div>';
document.getElementById('aiReviewOv').classList.add('show');
const sysMsg=`你是一位资深的网文编辑，看过上千本小说，眼光毒辣但心地善良。

【评价任务】
像一个懂行的朋友那样，给这篇文章做个诊断。

【输出格式】
📊 整体印象：一句话说出这篇文章给你的感觉

✨ 写得漂亮的地方（2-3处）：
- 引用原文 → 为什么好

⚠️ 需要注意的问题（2-3处）：
- 具体问题 → 怎么改（给出修改示例）

🎯 文笔评分：X/10
（6分及格，7分能看，8分不错，9分优秀，10分大神）

💡 最重要的一条建议：
如果只能改一个地方，改哪里收益最大

【评价原则】
• 说人话，不要学院派腔调
• 批评要具体到能直接改，不要说"节奏有问题"，要说"第三段太长了，建议拆成两段"
• 发现亮点要真诚夸，不要敷衍
• 问题要说透，但语气要温和
• 记住：作者需要的是能用的建议，不是打击`;
const chInfo=curEd.type==='novel'?'（这是第'+(curEdCh+1)+'章）':'';
const userMsg='请评价以下作品'+chInfo+'：\n\n标题：'+(curEd.title||'无标题')+'\n\n正文：\n'+text.substring(0,3000);
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
let reviewText='';
await callAPIStream(messages,
(fullText)=>{
reviewText=fullText;
body.textContent=fullText;
body.scrollTop=body.scrollHeight;
},
(fullText)=>{
if(fullText){
body.textContent=fullText;
}else{
body.innerHTML='<div style="color:var(--text2);text-align:center">评价已取消</div>';
}
},
(errMsg)=>{
body.textContent='获取评价失败：'+errMsg;
}
);
}
function closeAIReview(){
document.getElementById('aiReviewOv').classList.remove('show');
}
function shareCrToRes(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
const wc=getCrWordCount(work);
if(wc<10){showToast('内容太少，至少写10字再分享');return;}
showDlg('分享到资源','将「'+(work.title||'无标题')+'」打包为资源包并导出？',()=>{
const packData=JSON.parse(JSON.stringify(work));
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:(work.title||'无标题')+'_分享',
desc:(work.type==='draft'?'草稿':'小说')+' · '+wc+'字',
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:[{
type:'work',
name:(work.type==='draft'?'草稿':'小说')+'：'+(work.title||'无标题'),
data:packData
}]
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='笔记AI_分享_'+(work.title||'作品')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('作品已导出为资源包 📤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
});
}
// 章节大纲管理
function viewOutline(){
if(!curEd||!curEd.outline){showToast('这篇作品没有大纲');return;}
showDlg('📋 总大纲',curEd.outline.substring(0,500)+(curEd.outline.length>500?'...':''),()=>{});
}
function openChOutline(){
if(!curEd||curEd.type!=='novel')return;
if(!curEd.chOutlines)curEd.chOutlines=[];
const list=document.getElementById('chOutlineList');
list.innerHTML='';
curEd.chapters.forEach((_,i)=>{
const outline=curEd.chOutlines[i]||'';
const preview=(curEd.chapters[i]||'').replace(/\n/g,' ').substring(0,30);
const item=document.createElement('div');
item.className='ch-outline-item';
item.innerHTML=
'<div class="ch-outline-item-hdr"><span>第'+(i+1)+'章</span><span style="font-size:10px;color:var(--text2);font-weight:400">'+esc(preview)+'...</span></div>'+
'<textarea data-ch="'+i+'" placeholder="【必填内容】本章必须出现的事件、人物行为、情绪走向、要埋的伏笔、禁止出现的内容...写得越详细AI越听话">'+esc(outline)+'</textarea>';;
list.appendChild(item);
});
document.getElementById('chOutlineOv').classList.add('show');
}
function closeChOutline(){
document.getElementById('chOutlineOv').classList.remove('show');
}
function saveChOutlines(){
if(!curEd)return;
if(!curEd.chOutlines)curEd.chOutlines=[];
document.querySelectorAll('#chOutlineList textarea').forEach(ta=>{
const ch=parseInt(ta.dataset.ch);
curEd.chOutlines[ch]=ta.value;
});
saveEditorContent();
closeChOutline();
showToast('章节大纲已保存 📋');
}
function deleteEdChapter(){
if(!curEd||curEd.type!=='novel')return;
if(curEd.chapters.length<=1){showToast('至少保留一章');return;}
const chWc=countWords(curEd.chapters[curEdCh]||'');
showDlg('删除章节','确定要删除第'+(curEdCh+1)+'章吗？('+chWc+'字)\n\n⚠️ 此操作不可恢复！',()=>{
curEd.chapters.splice(curEdCh,1);
if(curEdCh>=curEd.chapters.length)curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
saveEditorContent();
showToast('已删除');
},true);
}
// ==================== RESOURCE ====================
function switchResTab(tab,el){
resTab=tab;
document.querySelectorAll('.res-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderResList();
}
function renderResList(){
const list=document.getElementById('resList');
let items=[];
resPacks.forEach(pack=>{
if(pack.items&&Array.isArray(pack.items)){
pack.items.forEach(item=>{
item._packName=pack.name||'未命名资源包';
item._packId=pack.id;
items.push(item);
});
}
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
if(items.length===0){
const tips={
all:'还没有资源<br>点击「打包导出」分享你的设定，或「导入资源包」获取别人的',
char:'没有人物设定资源',world:'没有世界观资源',
style:'没有文风资源',rule:'没有规则资源',work:'没有作品资源',exp:'没有经验分享'
};
list.innerHTML='<div class="empty-st"><p>'+(tips[resTab]||tips.all)+'</p></div>';
return;
}
list.innerHTML='';
items.forEach((item,idx)=>{
const card=document.createElement('div');
card.className='res-card';
const typeLabels={char:'人物设定',world:'世界观',style:'文风',rule:'规则',work:'作品',exp:'经验分享'};
const preview=getResPreview(item);
card.innerHTML=
'<div class="res-card-hd">'+
'<div class="res-card-t">'+esc(item.name||'未命名')+'</div>'+
'<span class="res-card-type '+item.type+'">'+(typeLabels[item.type]||'其他')+'</span>'+
'</div>'+
'<div class="res-card-pv">'+esc(preview)+'</div>'+
'<div class="res-card-ft">'+
'<span class="res-card-info">来自：'+esc(item._packName)+'</span>'+
'<div class="res-card-acts">'+
'<button class="use" onclick="event.stopPropagation();applyResItem(\''+item._packId+'\','+idx+')">应用</button>'+
'<button onclick="event.stopPropagation();copyResItem(\''+item._packId+'\','+idx+')">复制</button>'+
'</div>'+
'</div>';
list.appendChild(card);
});
if(resPacks.length>0){
const mgr=document.createElement('div');
mgr.style.cssText='margin-top:16px;padding-top:14px;border-top:1px solid var(--border)';
mgr.innerHTML='<div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px">已导入的资源包</div>';
resPacks.forEach(pack=>{
const pDiv=document.createElement('div');
pDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:7px';
const count=pack.items?pack.items.length:0;
const time=pack.createdAt?new Date(pack.createdAt).toLocaleDateString():'';
pDiv.innerHTML=
'<div><div style="font-size:12px;font-weight:600">'+esc(pack.name||'未命名')+'</div>'+
'<div style="font-size:9px;color:var(--text2);margin-top:2px">'+count+'项资源 · '+time+'</div></div>'+
'<button style="padding:4px 10px;border-radius:7px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:9px;cursor:pointer" onclick="deleteResPack(\''+pack.id+'\')">删除</button>';
mgr.appendChild(pDiv);
});
list.appendChild(mgr);
}
}
function getResPreview(item){
if(item.type==='char'){
const chars=item.data||[];
return chars.map(c=>(c.name||'未命名')+'：'+(c.desc||'').substring(0,30)).join('；');
}
if(item.type==='world')return (item.data||'').substring(0,80);
if(item.type==='style')return (item.data||'').substring(0,80);
if(item.type==='rule')return (item.data||'').substring(0,80);
if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')return (w.content||'').substring(0,80);
if(w.chapters&&w.chapters.length>0)return (w.chapters[0]||'').substring(0,80);
return '暂无内容';
}
if(item.type==='exp')return (item.data||'').substring(0,80);
return '';
}
function applyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
if(item.type==='char'){
showDlg('应用人物设定','将覆盖当前的人物设定（含关系和NPC），是否继续？',()=>{
const d=item.data||{};
if(Array.isArray(d)){
characters=JSON.parse(JSON.stringify(d));
}else{
characters=JSON.parse(JSON.stringify(d.characters||[{name:'',desc:''}]));
if(d.relations){charRelations=JSON.parse(JSON.stringify(d.relations));sv('bj_charRelations',charRelations);}
if(d.npcs){npcList=JSON.parse(JSON.stringify(d.npcs));sv('bj_npcList',npcList);}
}
sv(K.curChars,characters);
showToast('人物设定已应用 ✅');
});
}
else if(item.type==='world'){
showDlg('应用世界观','将覆盖当前的世界观设定，是否继续？',()=>{
document.getElementById('worldDesc').value=item.data||'';
saveCurSettings();
showToast('世界观已应用 ✅');
});
}else if(item.type==='style'){
showDlg('应用文风','将覆盖当前的文风设置，是否继续？',()=>{
document.getElementById('styleDesc').value=item.data||'';
ap.curStyle=item.data||'';
sv(K.ap,ap);
showToast('文风已应用 ✅');
});
}else if(item.type==='rule'){
showDlg('应用规则','将覆盖当前的规则设置，是否继续？',()=>{
document.getElementById('ruleDesc').value=item.data||'';
curRule=item.data||'';
sv('bj_curRule',curRule);
showToast('规则已应用 ✅');
});
}else if(item.type==='work'){
showDlg('导入作品','将添加到你的创作页面，是否继续？',()=>{
const w=JSON.parse(JSON.stringify(item.data));
w.id=uid();
w.createdAt=new Date().toISOString();
w.updatedAt=new Date().toISOString();
crWorks.unshift(w);
sv('bj_crWorks',crWorks);
showToast('作品已导入到创作页 ✅');
});
}else if(item.type==='exp'){
showDlg('查看经验','是否复制这条经验分享到剪贴板？',()=>{
doCopy(item.data||'');
});
}
}
function copyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
let text='';
if(item.type==='char'){
const chars=item.data||[];
text=chars.map(c=>'【'+c.name+'】\n'+c.desc).join('\n\n');
}else if(item.type==='rule'){
text=item.data||'';
}else if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')text=w.content||'';
else if(w.chapters)text=w.chapters.map((ch,i)=>'第'+(i+1)+'章\n\n'+ch).join('\n\n');
}else{
text=item.data||'';
}
doCopy(text);
}

// ==================== RESOURCE EXPORT ====================
function openResExport(){
const box=document.getElementById('resExpList');
box.innerHTML='';
const exportItems=[];
saveCharactersFromUI();
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
exportItems.push({id:'cur_char',type:'char',label:'当前人物设定',desc:validChars.map(c=>c.name).filter(Boolean).join('、')||'未命名角色',data:{characters:validChars,relations:charRelations,npcs:npcList}});
}
charP.forEach((p,i)=>{
exportItems.push({id:'charP_'+i,type:'char',label:'人物预设：'+p.name,desc:(p.characters||[]).map(c=>c.name).filter(Boolean).join('、'),data:p.characters});
});
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD){
exportItems.push({id:'cur_world',type:'world',label:'当前世界观',desc:wD.substring(0,40),data:wD});
}
worldP.forEach((p,i)=>{
exportItems.push({id:'worldP_'+i,type:'world',label:'世界观预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const sD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||'').trim();
if(sD){
exportItems.push({id:'cur_style',type:'style',label:'当前文风',desc:sD.substring(0,40),data:sD});
}
styleP.forEach((p,i)=>{
exportItems.push({id:'styleP_'+i,type:'style',label:'文风预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const rD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||'').trim();
if(rD){
exportItems.push({id:'cur_rule',type:'rule',label:'当前规则',desc:rD.substring(0,40),data:rD});
}
ruleP.forEach((p,i)=>{
exportItems.push({id:'ruleP_'+i,type:'rule',label:'规则预设：'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
crWorks.forEach(w=>{
exportItems.push({id:'work_'+w.id,type:'work',label:(w.type==='draft'?'草稿':'小说')+'：'+(w.title||'无标题'),desc:getCrWordCount(w)+'字',data:w});
});
if(exportItems.length===0){
box.innerHTML='<p style="font-size:12px;color:var(--text2);text-align:center;padding:20px">没有可导出的内容<br>请先在设置中添加人物/世界观/文风，或在创作页写点东西</p>';
document.getElementById('resExpOv').classList.add('show');
return;
}
const typeLabels={char:'👤 人物',world:'🌍 世界观',style:'✒️ 文风',rule:'📜 规则',work:'📄 作品'};
exportItems.forEach(item=>{
const div=document.createElement('div');
div.className='res-chk-item';
div.dataset.resId=item.id;
div.dataset.resType=item.type;
div.dataset.resData=JSON.stringify(item.data);
div.dataset.resLabel=item.label;
div.onclick=()=>{div.classList.toggle('checked');};
div.innerHTML=
'<div class="res-chk-box">✓</div>'+
'<div class="res-chk-info">'+
'<div class="res-chk-name">'+(typeLabels[item.type]||'')+' '+esc(item.label)+'</div>'+
'<div class="res-chk-desc">'+esc(item.desc)+'</div>'+
'</div>';
box.appendChild(div);
});
document.getElementById('resPackName').value='';
document.getElementById('resPackDesc').value='';
document.getElementById('resExpOv').classList.add('show');
}
function closeResExport(){
document.getElementById('resExpOv').classList.remove('show');
}
function doResExport(){
const checked=document.querySelectorAll('#resExpList .res-chk-item.checked');
if(checked.length===0){showToast('请至少选择一项');return;}
const items=[];
checked.forEach(el=>{
items.push({
type:el.dataset.resType,
name:el.dataset.resLabel,
data:JSON.parse(el.dataset.resData)
});
});
const packName=(document.getElementById('resPackName').value||'').trim()||'资源包';
const packDesc=(document.getElementById('resPackDesc').value||'').trim();
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:packName,
desc:packDesc,
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:items
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='笔记AI_资源_'+packName+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSON文件',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
closeResExport();
showToast('资源包已导出 📤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
}
function fallbackResExport(jsonStr,fileName){
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
closeResExport();
showToast('资源包已导出 📤');
}
function writeExpShare(){
document.getElementById('expTitle').value='';
document.getElementById('expContent').value='';
document.getElementById('expOv').classList.add('show');
setTimeout(()=>document.getElementById('expTitle').focus(),100);
}
function closeExpDlg(){
document.getElementById('expOv').classList.remove('show');
}
function saveExpShare(){
const title=(document.getElementById('expTitle').value||'').trim();
const content=(document.getElementById('expContent').value||'').trim();
if(!title){showToast('请输入标题');return;}
if(!content){showToast('请输入内容');return;}
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:title,
desc:'经验分享',
author:'笔记AI用户',
createdAt:new Date().toISOString(),
items:[{type:'exp',name:title,data:content}]
};
resPacks.unshift(pack);
sv('bj_resPacks',resPacks);
closeExpDlg();
renderResList();
showToast('经验已保存 ✅');
}
function deleteResPack(id){
const pack=resPacks.find(p=>p.id===id);
if(!pack)return;
showDlg('删除资源包','确定要删除「'+(pack.name||'未命名')+'」吗？',()=>{
resPacks=resPacks.filter(p=>p.id!==id);
sv('bj_resPacks',resPacks);
renderResList();
showToast('资源包已删除');
},true);
}
function importResPack(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI_resource'||!data.items){
showToast('这不是有效的资源包文件',3000);return;
}
const existing=resPacks.findIndex(p=>p.id===data.id);
if(existing>-1){
showDlg('重复资源包','已存在同名资源包「'+(data.name||'')+'」，是否覆盖？',()=>{
resPacks[existing]=data;
sv('bj_resPacks',resPacks);
renderResList();
showToast('资源包已更新 📥');
});
}else{
resPacks.unshift(data);
sv('bj_resPacks',resPacks);
renderResList();
const count=data.items.length;
showToast('已导入「'+(data.name||'资源包')+'」('+count+'项) 📥');
}
}catch(err){showToast('文件解析失败: '+err.message,3000);}
};
reader.readAsText(file);
e.target.value='';
}
// ==================== HANDBOOK ====================
function openHandbook(){
document.getElementById('hbOv').classList.add('show');
}
function closeHandbook(){
document.getElementById('hbOv').classList.remove('show');
}
// ==================== USER CARD ====================
function renderUserCard(){
const uc=userCard;
const nameEl=document.getElementById('ucName');
const bioEl=document.getElementById('ucBio');
const avatarEl=document.getElementById('ucAvatar');
nameEl.textContent=uc.name||'点击设置昵称';
bioEl.textContent=uc.bio||'点击添加个人简介...';
if(uc.avatar){
avatarEl.innerHTML='<img src="'+uc.avatar+'" alt="头像"><div class="ucard-avatar-hint">更换</div>';
}else{
avatarEl.innerHTML='<span id="ucAvatarPh">✦</span><div class="ucard-avatar-hint">更换</div>';
}
updateStats();
}
function getStorageUsage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total;
}

function checkStorageHealth(){
const used=getStorageUsage();
const usedMB=(used/1024/1024).toFixed(2);
const percent=(used/(5*1024*1024)*100).toFixed(1);
if(percent>80){
showToast('⚠️ 存储已用'+percent+'%，建议导出备份',4000);
}
return {used,usedMB,percent};
}

let totalWords=0;
function updateStats(){
let totalWords=0;
let worksCount=0;
let todayWords=0;
const today=new Date().toDateString();
// 作坊文章
ws.forEach(a=>{totalWords+=getTotalWords(a);});
worksCount+=ws.length;
// 创作作品
crWorks.forEach(w=>{totalWords+=getCrWordCount(w);});
worksCount+=crWorks.length;
// 收藏里独有的（不在作坊里的）
cols.books.forEach(b=>{
if(!ws.find(a=>a.id===b.id))totalWords+=getTotalWords(b);
});
cols.shorts.forEach(s=>{
if(!ws.find(a=>a.id===s.id))totalWords+=getTotalWords(s);
});
const colsCount=cols.books.length+cols.shorts.length;
// 笔记总数
let notesCount=0;
const allIds=new Set();
[...ws,...cols.books,...cols.shorts].forEach(a=>allIds.add(a.id));
allIds.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
notesCount+=n.length;
});
document.getElementById('statTotal').textContent=formatNum(totalWords);
document.getElementById('statWorks').textContent=worksCount;
document.getElementById('statCols').textContent=colsCount;
document.getElementById('statNotes').textContent=notesCount;

// 计算今日创作字数
const todayKey='bj_today_'+today;
const savedToday=ld(todayKey,0);
if(savedToday>0){
const statTotalEl=document.getElementById('statTotal');
if(statTotalEl)statTotalEl.title='今日创作：'+savedToday+'字';
}
}

// 记录今日创作字数
function recordTodayWords(addWords){
const today=new Date().toDateString();
const todayKey='bj_today_'+today;
const current=ld(todayKey,0);
sv(todayKey,current+addWords);
}
async function updateStorageDisplay() {
    try {
        const info = await getDBStorageUsage();
        document.getElementById('storagePercent').textContent = info.percent + '%';
        document.getElementById('storageBar').style.width = Math.min(info.percent, 100) + '%';
        document.getElementById('storageDetail').textContent = '已用 ' + info.usedMB + 'MB / 50MB';
    } catch(e) {
        document.getElementById('storagePercent').textContent = '计算失败';
        document.getElementById('storageDetail').textContent = '请刷新页面重试';
    }
}
function formatNum(n){
if(n>=10000)return (n/10000).toFixed(1)+'万';
if(n>=1000)return (n/1000).toFixed(1)+'k';
return n;
}
function uploadAvatar(){
document.getElementById('avatarUp').click();
}
function handleAvatarUpload(e){
const file=e.target.files[0];
if(!file)return;
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const size=120;
canvas.width=size;canvas.height=size;
const ctx=canvas.getContext('2d');
const min=Math.min(img.width,img.height);
const sx=(img.width-min)/2;
const sy=(img.height-min)/2;
ctx.drawImage(img,sx,sy,min,min,0,0,size,size);
const dataUrl=canvas.toDataURL('image/jpeg',0.8);
userCard.avatar=dataUrl;
sv('bj_userCard',userCard);
renderUserCard();
showToast('头像已更新 🎨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}
function editUcName(){
showInp('设置昵称','输入你的昵称',name=>{
userCard.name=name;
sv('bj_userCard',userCard);
renderUserCard();
showToast('昵称已更新');
});
}
function editUcBio(){
const ov=document.getElementById('inpOv');
document.getElementById('inpTitle').textContent='编辑简介';
const f=document.getElementById('inpField');
f.placeholder='写一句话介绍自己...';
f.value=userCard.bio||'';
document.getElementById('inpOkBtn').onclick=()=>{
userCard.bio=f.value.trim();
sv('bj_userCard',userCard);
closeInp();
renderUserCard();
showToast('简介已更新');
};
ov.classList.add('show');
setTimeout(()=>f.focus(),100);
}
// ==================== OUTLINE GENERATOR ====================
let outlineChCount=10;
let outlineText='';
function openOutlineGen(){
document.getElementById('outlineTitle').value='';
document.getElementById('outlineDesc').value='';
document.getElementById('outlineResult').style.display='none';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineGenBtn').style.display='';
document.getElementById('outlineGenBtn').disabled=false;
document.getElementById('outlineGenBtn').textContent='🧠 生成大纲';
document.getElementById('outlineChInput').value=outlineChCount;
outlineText='';
document.getElementById('outlineOv').classList.add('show');
setTimeout(()=>document.getElementById('outlineDesc').focus(),200);
}
function closeOutlineGen(){
document.getElementById('outlineOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
function setOutlineCh(n,el){
outlineChCount=n;
const inp=document.getElementById('outlineChInput');
if(inp)inp.value=n;
}
async function doGenOutline(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const desc=(document.getElementById('outlineDesc').value||'').trim();
const title=(document.getElementById('outlineTitle').value||'').trim();
if(!desc){showToast('请描述一下你想写的故事');return;}
const btn=document.getElementById('outlineGenBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('outlineResult').style.display='block';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineContent').textContent='正在构思大纲...';
let sysMsg='你是一位资深的故事架构师，精通各类小说的结构设计。\n\n';
sysMsg+='【你的任务】\n';
sysMsg+='根据用户描述，设计一份专业的小说大纲。\n\n';
sysMsg+='【输出格式】严格按以下格式：\n';
sysMsg+='第一行：小说标题\n';
sysMsg+='第二行：空行\n';
sysMsg+='第三行：一句话核心卖点（让人想看的理由）\n';
sysMsg+='第四行：空行\n';
sysMsg+='然后逐章列出：\n';
sysMsg+='第X章：章节标题\n';
sysMsg+='- 核心事件：本章必须发生的关键情节\n';
sysMsg+='- 情感曲线：角色情绪从A到B的变化\n';
sysMsg+='- 钩子设计：本章结尾留下的悬念\n\n';
sysMsg+='【结构要求】共'+outlineChCount+'章\n';
sysMsg+='- 第1章：抓人开场，建立期待\n';
sysMsg+='- 前1/4：铺垫人物关系和世界观\n';
sysMsg+='- 中段：层层递进的冲突和转折\n';
sysMsg+='- 3/4处：最大危机或情感爆发点\n';
sysMsg+='- 结局：情感收束，余韵悠长\n\n';
sysMsg+='【专业技巧】\n';
sysMsg+='- 每3-4章设置一个小高潮\n';
sysMsg+='- 伏笔要在埋设后3-5章内回收\n';
sysMsg+='- 主角要有清晰的成长弧线\n';
sysMsg+='- 避免"为虐而虐"，冲突要有意义\n';
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
sysMsg+='\n【可用角色】\n';
validChars.forEach((c,i)=>{
sysMsg+='角色'+(i+1)+'：'+(c.name||'未命名');
if(c.desc)sysMsg+='（'+c.desc.substring(0,60)+'）';
sysMsg+='\n';
});
}
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD)sysMsg+='\n【世界观】\n'+wD.substring(0,300)+'\n';
let userMsg='请为以下故事生成'+outlineChCount+'章的详细大纲：\n\n';
if(title)userMsg+='标题方向：'+title+'\n';
userMsg+='故事描述：'+desc;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const contentEl=document.getElementById('outlineContent');
outlineText='';
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outlineText=fullText;
contentEl.textContent=fullText;
contentEl.parentElement.scrollTop=contentEl.parentElement.scrollHeight;
},
(fullText)=>{
btn.disabled=false;btn.textContent='🧠 生成大纲';
if(fullText){
outlineText=fullText;
contentEl.textContent=fullText;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='生成已取消';
}
},
(errMsg)=>{
btn.disabled=false;btn.textContent='🧠 生成大纲';
contentEl.textContent='生成失败：'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;btn.textContent='🧠 生成大纲';
if(result){
outlineText=result;
contentEl.textContent=result;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='生成失败，请检查API设置';
}
}
}
function applyOutline(){
if(!outlineText){showToast('没有大纲内容');return;}
let title='';
const lines=outlineText.split('\n');
for(let i=0;i<Math.min(3,lines.length);i++){
const l=lines[i].trim();
if(l&&l.length<40&&!l.startsWith('-')&&!l.startsWith('第')){
title=l.replace(/^[#*《「【\s:：标题]+/,'').replace(/[》」】\s]+$/,'').trim();
break;
}
}
const inputTitle=(document.getElementById('outlineTitle').value||'').trim();
if(inputTitle)title=inputTitle;
if(!title)title='未命名小说';
const work={
id:uid(),type:'novel',title:title,
chapters:[''],
outline:outlineText,
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
closeOutlineGen();
openEditor(work.id);
showToast('小说已创建，大纲已保存 📋');
}
// ==================== AI REWRITE ====================
// AI润色（比重写更轻量，只优化文笔不改情节）
async function aiPolishChapter(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<20){showToast('内容太少，至少20字才能润色');return;}

showDlg('AI润色确认','AI将优化文笔（删除万能副词、改善句式、增加细节），保持情节不变。是否继续？',async()=>{
const ta=document.getElementById('edTextarea');
const statusEl=document.getElementById('edSaveStatus');
statusEl.textContent='AI润色中...';
ta.disabled=true;

let sysMsg='你是一位轻手轻脚的文字美容师，只做微调，不动大刀。\n\n';
sysMsg+='【铁律】情节、人物、对话内容 → 一个字都不能改\n\n';
sysMsg+='【润色清单】按优先级处理：\n';
sysMsg+='① 删除万能副词（不禁/缓缓/淡淡/微微/默默/静静/轻轻/渐渐）\n';
sysMsg+='② 处理重复句式开头（如果连续3句都是"他..."，改掉中间那句）\n';
sysMsg+='③ 优化对话标签（"他说"→"他顿了顿"/"他看着窗外"等动作）\n';
sysMsg+='④ 在情绪高点加入1处感官细节\n';
sysMsg+='⑤ 检查是否有病句或错别字\n\n';
sysMsg+='【不要做的事】\n';
sysMsg+='× 不要改变任何情节走向\n';
sysMsg+='× 不要修改对话的实际内容\n';
sysMsg+='× 不要大幅增加或删减内容\n';
sysMsg+='× 不要改变作者的文风\n\n';
sysMsg+='【输出】直接输出润色后的正文，不加说明。\n';

const userMsg='请润色以下文章，只优化文笔，不改情节：\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

if(useStream){
await callAPIStream(messages,
(fullText)=>{ta.value=fullText;updateEdWc();},
(fullText)=>{
ta.disabled=false;
if(fullText){
ta.value=fullText;updateEdWc();saveEditorContent();
statusEl.textContent='润色完成 ✓';
showToast('文笔已优化 ✨');
}else{statusEl.textContent='润色已取消';}
},
(errMsg)=>{ta.disabled=false;statusEl.textContent='润色失败';showToast('润色失败：'+errMsg,3000);}
);
}else{
const result=await callAPINonStream(messages);
ta.disabled=false;
if(result){
ta.value=result;updateEdWc();saveEditorContent();
statusEl.textContent='润色完成 ✓';
showToast('文笔已优化 ✨');
}else{statusEl.textContent='润色失败';}
}
});
}
async function aiRewriteChapter(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<10){showToast('当前章节内容太少，至少10字才能重写');return;}
showDlg('AI重写确认','AI将重新改写当前章节内容，原内容会被替换。是否继续？',async()=>{
const ta=document.getElementById('edTextarea');
const statusEl=document.getElementById('edSaveStatus');
statusEl.textContent='AI重写中...';
ta.disabled=true;
let sysMsg='你是一位顶级的文字外科医生，专门给小说做精细手术。\n\n';
sysMsg+='【手术原则】\n';
sysMsg+='骨架（情节、人物、对话内容）→ 绝对不动\n';
sysMsg+='血肉（表达方式、细节描写）→ 全面升级\n\n';
sysMsg+='【必做手术清单】\n';
sysMsg+='1. 万能副词切除术：删掉所有"不禁、缓缓、淡淡、微微、默默"\n';
sysMsg+='2. 空洞形容词替换术："她很漂亮"→具体的五官、神态、气质\n';
sysMsg+='3. 感官植入术：每500字至少加入1处非视觉描写（声音/气味/触感/温度）\n';
sysMsg+='4. 对话自然化手术：删掉书面语，加入停顿、语气词、未说完的话\n';
sysMsg+='5. 动作细化术："他笑了"→具体是什么样的笑，嘴角、眼睛、肩膀\n\n';
sysMsg+='【手术示范】\n';
sysMsg+='术前：她不禁感到一阵悲伤，眼泪缓缓流下。他默默地看着她。\n';
sysMsg+='术后：她咬住下唇，指甲掐进掌心。眼眶热了一下，她仰起头，假装看天花板上的灯。他站在三步外，手抬起又放下，最后只是把纸巾放在她够得到的地方。\n\n';
sysMsg+='【输出要求】\n';
sysMsg+='- 直接输出改写后的正文\n';
sysMsg+='- 字数不少于原文\n';
sysMsg+='- 不加任何说明和标注\n';
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【文风要求】'+styleD+'\n';
const chInfo=curEd.type==='novel'?'这是「'+(curEd.title||'')+'」的第'+(curEdCh+1)+'章。':'';
let contextInfo='';
if(curEd.type==='novel'&&curEd.chapters&&curEdCh>0){
const prevCh=curEd.chapters[curEdCh-1]||'';
if(prevCh)contextInfo='\n\n【上一章结尾参考】\n'+prevCh.substring(prevCh.length-300)+'\n';
}
let outlineInfo='';
if(curEd.outline){
outlineInfo='\n\n【小说大纲参考】\n'+curEd.outline.substring(0,500)+'\n';
}
const userMsg=chInfo+contextInfo+outlineInfo+'\n\n请重写以下章节内容：\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
if(useStream){
await callAPIStream(messages,
(fullText)=>{
ta.value=fullText;
updateEdWc();
},
(fullText)=>{
ta.disabled=false;
if(fullText){
ta.value=fullText;
updateEdWc();
saveEditorContent();
statusEl.textContent='重写完成 ✓';
showToast('章节已重写 ✨');
}else{
statusEl.textContent='重写已取消';
}
},
(errMsg)=>{
ta.disabled=false;
statusEl.textContent='重写失败';
showToast('重写失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
ta.disabled=false;
if(result){
ta.value=result;
updateEdWc();
saveEditorContent();
statusEl.textContent='重写完成 ✓';
showToast('章节已重写 ✨');
}else{
statusEl.textContent='重写失败';
}
}
});
}
// AI扩写/缩写
let expandMode='expand';// expand or shrink
function openAiExpand(){
if(!curEd){showToast('请先打开一篇文章');return;}
expandMode='expand';
document.getElementById('expandTitle').textContent='📈 AI扩写';
document.getElementById('expandDesc').textContent='选择或粘贴要扩写的段落，AI会添加更多细节、感官描写、心理活动等';
document.getElementById('expandDoBtn').textContent='🚀 开始扩写';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function openAiShrink(){
if(!curEd){showToast('请先打开一篇文章');return;}
expandMode='shrink';
document.getElementById('expandTitle').textContent='📉 AI缩写';
document.getElementById('expandDesc').textContent='选择或粘贴要缩写的段落，AI会精简内容、保留核心信息';
document.getElementById('expandDoBtn').textContent='🚀 开始缩写';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function closeExpandOv(){
document.getElementById('expandOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
async function doExpand(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const input=(document.getElementById('expandInput').value||'').trim();
if(!input){showToast('请输入要处理的内容');return;}
if(countWords(input)<5){showToast('内容太少，至少5个字');return;}
const hint=(document.getElementById('expandHint').value||'').trim();
const btn=document.getElementById('expandDoBtn');
btn.disabled=true;
btn.innerHTML='处理中 <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('expandResult').style.display='block';
document.getElementById('expandOutput').value='正在处理...';
let sysMsg='';
if(expandMode==='expand'){
sysMsg='你是一位细节控作家，擅长把骨架变成血肉丰满的场景。\n\n';
sysMsg+='【扩写方向】按需选择添加：\n';
sysMsg+='• 感官层：不只是看到什么，还有听到、闻到、摸到、尝到\n';
sysMsg+='• 动作层：大动作拆成小动作，加入微表情和下意识举动\n';
sysMsg+='• 心理层：角色在想什么，有什么犹豫、期待、担忧\n';
sysMsg+='• 环境层：光线、温度、声音、气味，营造氛围\n';
sysMsg+='• 节奏层：在紧张处用短句，在舒缓处用长句\n\n';
sysMsg+='【扩写示范】\n';
sysMsg+='原文：他打开门，看到她站在门口。\n';
sysMsg+='扩写：门锁发出轻微的咔哒声。他拉开门，走廊的冷气扑面而来，带着一点消毒水的味道。她就站在那里，手里攥着手机，指节有点发白。见他开门，她的眼睛亮了一下，又很快垂下去，像是在掩饰什么。\n\n';
sysMsg+='【要求】\n';
sysMsg+='- 扩写后字数为原文的1.5-2.5倍\n';
sysMsg+='- 情节和对话内容不能改变\n';
sysMsg+='- 直接输出，不加说明\n';
}else{
sysMsg='你是一位惜字如金的编辑，擅长用最少的字传达最多的信息。\n\n';
sysMsg+='【缩写优先级】从高到低删除：\n';
sysMsg+='① 重复表达同一意思的句子（留最好的那句）\n';
sysMsg+='② 不推动情节的环境描写\n';
sysMsg+='③ 可有可无的心理活动\n';
sysMsg+='④ 过度修饰的形容词和副词\n';
sysMsg+='⑤ 对话中的废话和客套\n\n';
sysMsg+='【必须保留】\n';
sysMsg+='• 关键情节点和转折\n';
sysMsg+='• 推动剧情的对话\n';
sysMsg+='• 人物性格的关键表现\n';
sysMsg+='• 重要的伏笔和暗示\n\n';
sysMsg+='【缩写示范】\n';
sysMsg+='原文：她慢慢地走到窗边，轻轻地推开了那扇有些陈旧的窗户，一阵带着花香的微风缓缓地吹了进来，她深深地吸了一口气，感觉心情好了很多。\n';
sysMsg+='缩写：她推开窗，花香涌进来，她深吸一口气。\n\n';
sysMsg+='【要求】缩写后字数为原文的40%-70%，直接输出。\n';
}
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【保持文风】\n'+styleD+'\n';
let userMsg=expandMode==='expand'?'请扩写以下段落：\n\n':'请缩写以下段落：\n\n';
userMsg+=input;
if(hint)userMsg+='\n\n【特别要求】'+hint;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const outputEl=document.getElementById('expandOutput');
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outputEl.value=fullText;
},
(fullText)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
if(fullText){
outputEl.value=fullText;
const oldWc=countWords(input);
const newWc=countWords(fullText);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'扩写':'缩写')+'完成！原文'+oldWc+'字→'+newWc+'字('+ratio+'%)');
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
outputEl.value='处理失败：'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent=expandMode==='expand'?'🚀 开始扩写':'🚀 开始缩写';
if(result){
outputEl.value=result;
const oldWc=countWords(input);
const newWc=countWords(result);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'扩写':'缩写')+'完成！原文'+oldWc+'字→'+newWc+'字('+ratio+'%)');
}else{
outputEl.value='处理失败，请检查API设置';
}
}
}
// 导出TXT文件
function exportToTxtFile(filename,content){
const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:filename,
types:[{description:'文本文件',accept:{'text/plain':['.txt']}}]
});
const writable=await handle.createWritable();
await writable.write(blob);
await writable.close();
showToast('文件已保存 📥');
}catch(e){
if(e.name!=='AbortError')fallbackTxtExport(filename,blob);
}
})();
return;
}
fallbackTxtExport(filename,blob);
}
function fallbackTxtExport(filename,blob){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=filename;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('文件已导出 📥');
}
function buildTxtContent(title,chapters,isAI){
let content='';
if(isAI){
content+='════════════════════════════════════════\n';
content+='　　　　　　「'+title+'」\n';
content+='════════════════════════════════════════\n\n';
content+='【声明】\n';
content+='本文由「笔记AI」辅助创作生成\n';
content+='创作工具：笔记AI · AI创作工坊\n';
content+='工具作者：心田\n';
content+='导出时间：'+new Date().toLocaleString()+'\n\n';
content+='【AI创作提示】\n';
content+='本文内容由AI辅助生成，仅供参考和娱乐。\n';
content+='AI生成的内容可能存在事实错误或不当表述，\n';
content+='请读者自行甄别，切勿作为专业依据。\n';
content+='如需转载或发布，请注明AI辅助创作。\n\n';
content+='════════════════════════════════════════\n';
content+='　　　　　　　正　文　开　始\n';
content+='════════════════════════════════════════\n\n\n';
}else{
content+='════════════════════════════════════════\n';
content+='　　　　　　「'+title+'」\n';
content+='════════════════════════════════════════\n\n';
content+='导出时间：'+new Date().toLocaleString()+'\n';
content+='创作工具：笔记AI\n\n';
content+='════════════════════════════════════════\n\n\n';
}
// 正文
if(Array.isArray(chapters)){
chapters.forEach((ch,i)=>{
content+='【第'+(i+1)+'章】\n\n';
content+=(ch||'').trim()+'\n\n\n';
});
}else{
content+=(chapters||'').trim()+'\n\n';
}
// 结尾
if(isAI){
content+='\n════════════════════════════════════════\n';
content+='　　　　　　　正　文　结　束\n';
content+='════════════════════════════════════════\n\n';
content+='【关于笔记AI】\n';
content+='笔记AI是一款基于大语言模型的AI创作工坊，\n';
content+='帮助创作者快速生成高质量的小说、散文等文学作品。\n\n';
content+='功能特色：\n';
content+='· 长篇连载 & 短篇一发\n';
content+='· 自定义人物、世界观、文风、规则\n';
content+='· AI续写、扩写、缩写、重写\n';
content+='· 章节大纲管理\n';
content+='· 多主题界面美化\n\n';
content+='工具作者：心田\n';
content+='联系方式：\n';
content+='· 小红书：95567118758\n';
content+='· 小红书：27418565861\n';
content+='· 微信：Aa9620520\n';
content+='· QQ：962005530\n\n';
content+='════════════════════════════════════════\n';
content+='感谢使用笔记AI，祝创作愉快！\n';
content+='════════════════════════════════════════\n';
}else{
content+='\n════════════════════════════════════════\n';
content+='导出自：笔记AI · 创作工具\n';
content+='════════════════════════════════════════\n';
}
return content;
}
// 从创作页导出
function exportCrToTxt(){
if(crWorks.length===0){showToast('没有可导出的作品');return;}
// 如果只有一个作品，直接导出
if(crWorks.length===1){
const w=crWorks[0];
doExportWork(w,false);
return;
}
// 多个作品，让用户选择
const items=crWorks.map((w,i)=>({
id:w.id,
label:(w.type==='draft'?'[草稿] ':'[小说] ')+(w.title||'无标题'),
wc:getCrWordCount(w)
}));
showSelectDlg('选择要导出的作品',items,(id)=>{
const w=crWorks.find(x=>x.id===id);
if(w)doExportWork(w,false);
});
}
// 从编辑器导出
function exportEdToTxt(){
if(!curEd){showToast('没有打开的作品');return;}
saveEditorContent();
doExportWork(curEd,false);
}
// 从收藏导出
function exportBookToTxt(id){
const book=cols.books.find(b=>b.id===id);
if(!book){showToast('找不到该书籍');return;}
doExportWork(book,true);
}
// 执行导出
function exportSingleCrWork(id){
const w=crWorks.find(x=>x.id===id);
if(!w){showToast('找不到该作品');return;}
doExportWork(w,false);
}
function doExportWork(work,isAI){
const title=work.title||'未命名';
let chapters;
if(work.type==='novel'||work.chapters){
chapters=work.chapters||[];
}else{
chapters=work.content||'';
}
const content=buildTxtContent(title,chapters,isAI);
const filename=title.replace(/[\\/:*?"<>|]/g,'_')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.txt';
exportToTxtFile(filename,content);
}
// 选择弹窗
function showSelectDlg(title,items,onSelect){
document.getElementById('dlgTitle').textContent=title;
const listHtml=items.map(it=>
'<div style="padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:9px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center" onclick="selectDlgItem(\''+it.id+'\')">'+
'<span style="font-size:12px">'+esc(it.label)+'</span>'+
'<span style="font-size:10px;color:var(--text2)">'+it.wc+'字</span>'+
'</div>'
).join('');
document.getElementById('dlgMsg').innerHTML=listHtml;
document.getElementById('dlgOkBtn').style.display='none';
window._selectDlgCallback=onSelect;
document.getElementById('dlgOv').classList.add('show');
}
function selectDlgItem(id){
closeDlg();
document.getElementById('dlgOkBtn').style.display='';
if(window._selectDlgCallback){
window._selectDlgCallback(id);
window._selectDlgCallback=null;
}
}
// ==================== 文章重写功能 ====================
let rewriteArticle=null;

function openArticleRewrite(){
if(!curRd){showToast('请先打开一篇文章');return;}
rewriteArticle=curRd;
const typeText=curRd.type==='long'?'长篇小说（共'+(curRd.chapters?curRd.chapters.length:0)+'章）':'短篇文章';
document.getElementById('rewriteTitle').textContent='🔄 重写'+typeText;
document.getElementById('rewriteRequirement').value='';
document.getElementById('rewriteProgress').style.display='none';
document.getElementById('rewriteBtns').style.display='flex';
document.getElementById('rewriteDoBtn').disabled=false;
document.getElementById('rewriteDoBtn').textContent='🚀 开始重写';
document.getElementById('rewriteOv').classList.add('show');
}

function closeRewriteOv(){
document.getElementById('rewriteOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}

function addRewriteReq(text){
const ta=document.getElementById('rewriteRequirement');
const current=ta.value.trim();
if(current){
ta.value=current+'\n- '+text;
}else{
ta.value='- '+text;
}
}

async function doArticleRewrite(){
if(!rewriteArticle){showToast('没有要重写的文章');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

const requirement=(document.getElementById('rewriteRequirement').value||'').trim();
const btn=document.getElementById('rewriteDoBtn');
btn.disabled=true;
btn.innerHTML='重写中 <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('rewriteProgress').style.display='block';
document.getElementById('rewriteBtns').style.display='none';

if(rewriteArticle.type==='long'&&rewriteArticle.chapters){
// 长篇：逐章重写
await rewriteLongArticle(requirement);
}else{
// 短篇：一次性重写
await rewriteShortArticle(requirement);
}
}

async function rewriteShortArticle(requirement){
const text=rewriteArticle.content||'';
if(countWords(text)<10){
showToast('文章内容太少');
closeRewriteOv();
return;
}

document.getElementById('rewriteProgressBar').style.width='10%';
document.getElementById('rewriteProgressText').textContent='正在重写短篇...';

let sysMsg='你是一位资深的文学编辑，擅长改写和润色文章。\n\n';
sysMsg+='【改写原则】\n';
sysMsg+='1. 保留原文的核心情节、人物关系、故事走向\n';
sysMsg+='2. 用更精准、更有画面感的方式重新表达每一句话\n';
sysMsg+='3. 补充感官细节、微表情、环境氛围\n';
sysMsg+='4. 修复万能副词、空洞形容词、重复句式等问题\n';
sysMsg+='5. 让对话更自然口语化\n';
sysMsg+='6. 直接输出改写后的正文，不加任何说明\n';

if(requirement){
sysMsg+='\n【用户特别要求】\n'+requirement+'\n';
}

const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【文风要求】\n'+styleD+'\n';

const userMsg='请改写以下短篇文章：\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

if(useStream){
await callAPIStream(messages,
(fullText)=>{
const pct=Math.min(90,10+countWords(fullText)/countWords(text)*80);
document.getElementById('rewriteProgressBar').style.width=pct+'%';
document.getElementById('rewriteProgressText').textContent='已重写 '+countWords(fullText)+' 字...';
},
(fullText)=>{
if(fullText){
rewriteArticle.content=fullText;
syncArticle(rewriteArticle);
document.getElementById('rewriteProgressBar').style.width='100%';
document.getElementById('rewriteProgressText').textContent='重写完成！';
setTimeout(()=>{
closeRewriteOv();
renderChContent();
showToast('短篇重写完成！✨');
},500);
}else{
closeRewriteOv();
}
},
(errMsg)=>{
closeRewriteOv();
showToast('重写失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
if(result){
rewriteArticle.content=result;
syncArticle(rewriteArticle);
closeRewriteOv();
renderChContent();
showToast('短篇重写完成！✨');
}else{
closeRewriteOv();
}
}
}

async function rewriteLongArticle(requirement){
const chapters=rewriteArticle.chapters||[];
if(chapters.length===0){
showToast('没有章节内容');
closeRewriteOv();
return;
}

const totalCh=chapters.length;
let newChapters=[];

for(let i=0;i<totalCh;i++){
const chText=chapters[i]||'';
if(countWords(chText)<10){
newChapters.push(chText);
continue;
}

const pct=Math.round((i/totalCh)*100);
document.getElementById('rewriteProgressBar').style.width=pct+'%';
document.getElementById('rewriteProgressText').textContent='正在重写第'+(i+1)+'/'+totalCh+'章...';

let sysMsg='你是一位资深的文学编辑，擅长改写和润色文章。\n\n';
sysMsg+='【改写原则】\n';
sysMsg+='1. 保留原文的核心情节、人物关系、故事走向\n';
sysMsg+='2. 用更精准、更有画面感的方式重新表达\n';
sysMsg+='3. 补充感官细节、微表情、环境氛围\n';
sysMsg+='4. 修复万能副词、空洞形容词等问题\n';
sysMsg+='5. 直接输出改写后的正文，不加任何说明\n';

if(requirement){
sysMsg+='\n【用户特别要求】\n'+requirement+'\n';
}

const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n【文风要求】\n'+styleD+'\n';

// 提供上下文
let contextInfo='';
if(i>0&&newChapters[i-1]){
contextInfo='【上一章结尾】\n'+newChapters[i-1].substring(newChapters[i-1].length-300)+'\n\n';
}

const userMsg=contextInfo+'请改写以下章节（第'+(i+1)+'章）：\n\n'+chText;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const result=await callAPINonStream(messages);
if(result){
newChapters.push(result);
}else{
newChapters.push(chText);// 失败则保留原文
showToast('第'+(i+1)+'章重写失败，保留原文');
}

// 稍微延迟，避免API限流
await new Promise(r=>setTimeout(r,500));
}

rewriteArticle.chapters=newChapters;
syncArticle(rewriteArticle);
document.getElementById('rewriteProgressBar').style.width='100%';
document.getElementById('rewriteProgressText').textContent='全部重写完成！';
setTimeout(()=>{
closeRewriteOv();
curCh=0;
renderChContent();
showToast('长篇重写完成！共'+totalCh+'章 ✨');
},500);
}
function copyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text){showToast('没有内容可复制');return;}
doCopy(text);
}
function applyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text||text.startsWith('处理失败')||text==='正在处理...'){showToast('没有有效结果');return;}
const ta=document.getElementById('edTextarea');
const original=document.getElementById('expandInput').value;
// 尝试替换原文
const currentText=ta.value;
if(currentText.includes(original)){
ta.value=currentText.replace(original,text);
onEditorInput();
closeExpandOv();
showToast('已替换原文 ✅');
}else{
// 原文不在当前章节，追加到末尾
showDlg('无法定位原文','原文不在当前章节中，是否将结果追加到章节末尾？',()=>{
ta.value=currentText+'\n\n'+text;
onEditorInput();
closeExpandOv();
showToast('已追加到末尾 ✅');
});
}
}
function setTempPreset(temp,name){
document.getElementById('apiTemp').value=temp;
document.getElementById('quickTemp').value=temp;
document.getElementById('qtVal').textContent=temp;
showToast('已切换为「'+name+'」模式 (T='+temp+')');
}
function toggleStreamSwitch(el){
const cb=document.getElementById('streamOn');
cb.checked=!cb.checked;
useStream=cb.checked;
sv('bj_stream',useStream);
updateStreamUI();
showToast(useStream?'已开启流式输出':'已关闭流式输出');
}
function updateStreamUI(){
const track=document.getElementById('streamTrack');
const thumb=document.getElementById('streamThumb');
if(useStream){
track.style.background='var(--accent)';
thumb.style.left='22px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}
// ==================== 故事转盘 ====================
let storyWheels=ld('bj_storyWheels',[]);
let wheelResults=[];
let editingWheelIdx=-1;

const defaultWheels=[
{name:'故事标签',spinCount:2,options:['甜文','虐文','悬疑','奇幻','校园','职场','古风','现代','穿越','重生','豪门','娱乐圈','电竞','医疗','刑侦'],used:[]},
{name:'女主职业',spinCount:1,options:['医生','律师','教师','记者','设计师','程序员','作家','演员','警察','厨师','画家','舞者','科学家','侦探','花店老板'],used:[]},
{name:'男主职业',spinCount:1,options:['总裁','军人','医生','律师','教授','警察','特工','厨师','音乐家','运动员','建筑师','飞行员','消防员','兽医','咖啡店主'],used:[]}
];

function openWheelPanel(){
if(storyWheels.length===0){
storyWheels=JSON.parse(JSON.stringify(defaultWheels));
sv('bj_storyWheels',storyWheels);
}
wheelResults=[];
renderWheelList();
document.getElementById('wheelResultArea').style.display='none';
document.getElementById('wheelStoryArea').style.display='none';
document.getElementById('wheelOv').classList.add('show');
document.getElementById('bnav').classList.add('hide');
}

function closeWheelPanel(){
document.getElementById('wheelOv').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
}

function renderWheelList(){
const container=document.getElementById('wheelList');
if(storyWheels.length===0){
container.innerHTML=`
<div class="wheel-empty" style="grid-column:1/-1">
<div class="wheel-empty-icon">🎰</div>
<div class="wheel-empty-text">还没有转盘<br>创建你的第一个转盘，开始随机故事之旅！</div>
<button class="wheel-empty-btn" onclick="addWheel()">➕ 创建转盘</button>
</div>`;
return;
}
container.innerHTML='';
storyWheels.forEach((w,i)=>{
const usedCount=w.used?w.used.length:0;
const totalCount=w.options?w.options.length:0;
const availableCount=totalCount-usedCount;
const card=document.createElement('div');
card.className='wheel-card';

// 生成选项预览标签
let optTagsHtml='';
const showOpts=(w.options||[]).slice(0,8);
showOpts.forEach(opt=>{
const isUsed=(w.used||[]).includes(opt);
optTagsHtml+=`<span class="wheel-opt-tag ${isUsed?'used':''}">${esc(opt)}</span>`;
});
if(totalCount>8)optTagsHtml+=`<span class="wheel-opt-tag">+${totalCount-8}</span>`;

card.innerHTML=`
<div class="wheel-card-hdr">
<div>
<div class="wheel-card-title">${esc(w.name||'未命名转盘')}</div>
<div class="wheel-card-meta">
<span>🎯 转${w.spinCount||1}次</span>
<span>📦 ${totalCount}项</span>
<span style="color:${availableCount>0?'var(--success)':'var(--danger)'}">✨ 剩${availableCount}项</span>
</div>
</div>
<div class="wheel-card-acts">
<button onclick="editWheel(${i})" title="编辑">✏️</button>
<button onclick="resetSingleWheel(${i})" title="重置此转盘">🔄</button>
<button class="del" onclick="deleteWheel(${i})" title="删除">🗑️</button>
</div>
</div>
<div class="wheel-display">
<div class="wheel-outer-ring"></div>
<div class="wheel-pointer"></div>
<div class="wheel-container">
<div class="wheel-circle" id="wheelCircle${i}"></div>
<div class="wheel-center">🎰</div>
</div>
</div>
<div class="wheel-options-preview">${optTagsHtml}</div>
<div id="wheelResult${i}" style="display:none"></div>
`;
container.appendChild(card);
});
}

function addWheel(){
editingWheelIdx=-1;
document.getElementById('wheelEditTitle').textContent='添加转盘';
document.getElementById('wheelName').value='';
document.getElementById('wheelSpinCount').value=1;
document.getElementById('wheelSpinVal').textContent='1';
document.getElementById('wheelOptions').value='';
document.getElementById('aiGenOptArea').style.display='none';
document.getElementById('wheelEditOv').classList.add('show');
}

function editWheel(idx){
if(idx<0||idx>=storyWheels.length)return;
editingWheelIdx=idx;
const w=storyWheels[idx];
document.getElementById('wheelEditTitle').textContent='编辑转盘';
document.getElementById('wheelName').value=w.name||'';
document.getElementById('wheelSpinCount').value=w.spinCount||1;
document.getElementById('wheelSpinVal').textContent=w.spinCount||1;
document.getElementById('wheelOptions').value=(w.options||[]).join('\n');
document.getElementById('aiGenOptArea').style.display='none';
document.getElementById('wheelEditOv').classList.add('show');
}

function closeWheelEdit(){
document.getElementById('wheelEditOv').classList.remove('show');
editingWheelIdx=-1;
}

function saveWheel(){
const name=(document.getElementById('wheelName').value||'').trim()||'未命名转盘';
const spinCount=parseInt(document.getElementById('wheelSpinCount').value)||1;
const optionsText=document.getElementById('wheelOptions').value||'';
const options=optionsText.split('\n').map(o=>o.trim()).filter(o=>o);
if(options.length<2){
showToast('至少需要2个选项');
return;
}
if(editingWheelIdx>=0&&editingWheelIdx<storyWheels.length){
storyWheels[editingWheelIdx].name=name;
storyWheels[editingWheelIdx].spinCount=spinCount;
storyWheels[editingWheelIdx].options=options;
// 清理已用列表中不存在的选项
storyWheels[editingWheelIdx].used=(storyWheels[editingWheelIdx].used||[]).filter(u=>options.includes(u));
showToast('转盘已更新');
}else{
storyWheels.push({name,spinCount,options,used:[]});
showToast('转盘已添加');
}
sv('bj_storyWheels',storyWheels);
closeWheelEdit();
renderWheelList();
}

function deleteWheel(idx){
if(idx<0||idx>=storyWheels.length)return;
showDlg('删除转盘','确定要删除「'+storyWheels[idx].name+'」吗？',()=>{
storyWheels.splice(idx,1);
sv('bj_storyWheels',storyWheels);
renderWheelList();
showToast('转盘已删除');
},true);
}

function resetSingleWheel(idx){
if(idx<0||idx>=storyWheels.length)return;
storyWheels[idx].used=[];
sv('bj_storyWheels',storyWheels);
const resultDiv=document.getElementById('wheelResult'+idx);
if(resultDiv)resultDiv.style.display='none';
renderWheelList();
showToast('「'+storyWheels[idx].name+'」已重置');
}

function resetAllWheels(){
showDlg('重置所有转盘','确定要重置所有转盘的已用状态吗？',()=>{
storyWheels.forEach(w=>{w.used=[];});
sv('bj_storyWheels',storyWheels);
wheelResults=[];
document.getElementById('wheelResultArea').style.display='none';
document.getElementById('wheelStoryArea').style.display='none';
renderWheelList();
showToast('已重置所有转盘');
});
}

async function spinAllWheels(){
if(storyWheels.length===0){
showToast('请先添加转盘');
return;
}
// 检查是否有可用选项
let hasAvailable=false;
storyWheels.forEach(w=>{
const available=(w.options||[]).filter(o=>!(w.used||[]).includes(o));
if(available.length>0)hasAvailable=true;
});
if(!hasAvailable){
showToast('所有转盘都已用完，请重置后再试');
return;
}

const btn=document.getElementById('spinAllBtn');
btn.disabled=true;
btn.innerHTML='<span class="wheel-spin-icon" style="animation:none">⏳</span><span>转动中...</span>';

wheelResults=[];

for(let i=0;i<storyWheels.length;i++){
const w=storyWheels[i];
const available=(w.options||[]).filter(o=>!(w.used||[]).includes(o));
if(available.length===0){
continue;
}
const spinCount=Math.min(w.spinCount||1,available.length);
const results=[];
for(let s=0;s<spinCount;s++){
const currentAvailable=(w.options||[]).filter(o=>!(w.used||[]).includes(o));
if(currentAvailable.length===0)break;
const result=await spinSingleWheel(i,currentAvailable);
if(result){
results.push(result);
wheelResults.push({wheel:w.name,value:result});
w.used.push(result);
}
if(s<spinCount-1)await new Promise(r=>setTimeout(r,500));
}
// 显示该转盘的结果
showSingleWheelResult(i,results);
if(i<storyWheels.length-1)await new Promise(r=>setTimeout(r,300));
}

sv('bj_storyWheels',storyWheels);
renderWheelList();
showWheelResults();

btn.disabled=false;
btn.innerHTML='<span class="wheel-spin-icon">🎰</span><span>再转一次！</span>';
}

function spinSingleWheel(wheelIdx,available){
return new Promise(resolve=>{
const circle=document.getElementById('wheelCircle'+wheelIdx);
if(!circle||available.length===0){resolve(null);return;}

const randomIdx=Math.floor(Math.random()*available.length);
const result=available[randomIdx];

// 计算旋转角度
const spins=4+Math.floor(Math.random()*3);
const randomOffset=Math.random()*360;
const totalAngle=spins*360+randomOffset;

circle.style.transition='transform 3s cubic-bezier(.17,.67,.12,.99)';
circle.style.transform='rotate('+totalAngle+'deg)';

setTimeout(()=>{
resolve(result);
},3000);
});
}

function showSingleWheelResult(idx,results){
const resultDiv=document.getElementById('wheelResult'+idx);
if(!resultDiv||results.length===0)return;
resultDiv.style.display='block';
resultDiv.className='wheel-spin-result';
resultDiv.innerHTML=`
<div class="wheel-spin-result-label">🎯 本轮结果</div>
<div class="wheel-spin-result-value">${results.map(r=>esc(r)).join(' · ')}</div>
`;
}

function showWheelResults(){
if(wheelResults.length===0)return;
const area=document.getElementById('wheelResultArea');
const tags=document.getElementById('wheelResultTags');
area.style.display='block';
tags.innerHTML='';
wheelResults.forEach((r,i)=>{
const tag=document.createElement('span');
tag.className='wheel-result-tag';
tag.style.animationDelay=(i*0.1)+'s';
tag.textContent=r.value;
tag.title='来自：'+r.wheel;
tags.appendChild(tag);
});
// 滚动到结果区域
setTimeout(()=>{
area.scrollIntoView({behavior:'smooth',block:'center'});
},100);
}

function copyWheelResult(){
if(wheelResults.length===0){showToast('还没有转盘结果');return;}
const text=wheelResults.map(r=>r.value).join('、');
doCopy(text);
showToast('已复制：'+text);
}

function copyWheelStory(){
const content=document.getElementById('wheelStoryContent').textContent;
if(!content){showToast('没有故事内容');return;}
doCopy(content);
showToast('故事梗概已复制 📋');
}

function useWheelStory(){
const content=document.getElementById('wheelStoryContent').textContent;
if(!content){showToast('没有故事内容');return;}
closeWheelPanel();
document.getElementById('searchInput').value=content;
const wsBtn=document.querySelector('.bnav-i');
switchPage('workshop',wsBtn);
showToast('已填入作坊，可以开始创作啦 ✨');
}

async function aiGenStoryFromWheel(){
if(wheelResults.length===0){showToast('请先转动转盘');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

const btn=document.getElementById('wheelAiBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';

const keywords=wheelResults.map(r=>r.wheel+'：'+r.value).join('\n');

let sysMsg='你是一位创意故事策划师。根据用户提供的随机关键词组合，生成一个有吸引力的故事梗概。\n';
sysMsg+='要求：\n';
sysMsg+='- 150-250字\n';
sysMsg+='- 必须巧妙融合所有给定的关键词\n';
sysMsg+='- 包含主要人物设定、核心冲突、故事走向\n';
sysMsg+='- 有吸引力和新意，让人想看\n';
sysMsg+='- 直接输出梗概，不要标题和多余说明\n';

const userMsg='请根据以下随机抽取的关键词生成故事梗概：\n\n'+keywords;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const storyArea=document.getElementById('wheelStoryArea');
const storyContent=document.getElementById('wheelStoryContent');
storyArea.style.display='block';
storyContent.textContent='正在构思故事...';

if(useStream){
await callAPIStream(messages,
(text)=>{storyContent.textContent=text;},
(text)=>{
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(text){
storyContent.textContent=text;
storyArea.scrollIntoView({behavior:'smooth',block:'center'});
}
},
(err)=>{
btn.disabled=false;
btn.textContent='🤖 AI生成梗概';
storyContent.textContent='生成失败：'+err;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(result){
storyContent.textContent=result;
storyArea.scrollIntoView({behavior:'smooth',block:'center'});
}else{
storyContent.textContent='生成失败，请检查API设置';
}
}
}

function aiGenWheelOptions(){
const area=document.getElementById('aiGenOptArea');
area.style.display=area.style.display==='none'?'block':'none';
if(area.style.display==='block'){
document.getElementById('aiGenOptPrompt').focus();
}
}

async function doAiGenOptions(){
const prompt=(document.getElementById('aiGenOptPrompt').value||'').trim();
if(!prompt){showToast('请输入需求描述');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

const btn=document.getElementById('doAiGenBtn');
btn.disabled=true;
btn.innerHTML='生成中...';

let sysMsg='根据用户需求生成选项列表。\n';
sysMsg+='要求：\n';
sysMsg+='- 每行一个选项\n';
sysMsg+='- 15-25个选项\n';
sysMsg+='- 简洁，每个选项2-6个字\n';
sysMsg+='- 选项之间要有多样性\n';
sysMsg+='- 只输出选项，不要编号和多余内容\n';

const messages=[{role:'system',content:sysMsg},{role:'user',content:prompt}];
const result=await callAPINonStream(messages);

btn.disabled=false;
btn.textContent='生成';

if(result){
const current=document.getElementById('wheelOptions').value;
const newOpts=result.split('\n').map(l=>l.replace(/^\d+[\.\、\)\]]\s*/,'').trim()).filter(l=>l).join('\n');
document.getElementById('wheelOptions').value=current?(current+'\n'+newOpts):newOpts;
document.getElementById('aiGenOptArea').style.display='none';
document.getElementById('aiGenOptPrompt').value='';
showToast('选项已生成 ✨');
}else{
showToast('生成失败，请重试');
}
}

const presetOptionsData={
'故事标签':['甜文','虐文','悬疑','奇幻','校园','职场','古风','现代','穿越','重生','豪门','娱乐圈','电竞','医疗','刑侦','末日','科幻','仙侠','都市','乡村','军旅','谍战'],
'女性职业':['医生','律师','教师','记者','设计师','程序员','作家','演员','警察','厨师','画家','舞者','科学家','侦探','花店老板','咖啡师','摄影师','翻译','会计','护士','主播','调酒师'],
'男性职业':['总裁','军人','医生','律师','教授','警察','特工','厨师','音乐家','运动员','建筑师','飞行员','消防员','兽医','咖啡店主','作家','画家','程序员','记者','导演','赛车手','调香师'],
'性格特点':['高冷','温柔','毒舌','腹黑','傲娇','天然呆','话痨','社恐','阳光','忧郁','神秘','热情','冷漠','善良','偏执','温润','霸道','内敛','活泼','闷骚','洁癖','强迫症'],
'故事场景':['校园','医院','律所','警局','公司','咖啡馆','书店','花店','酒吧','海边','山村','古镇','都市','异世界','宫廷','江湖','战场','孤岛','雪山','森林','沙漠','太空站'],
'故事元素':['误会','重逢','复仇','救赎','守护','背叛','失忆','穿越','契约','假戏真做','青梅竹马','欢喜冤家','先婚后爱','破镜重圆','日久生情','一见钟情','暗恋成真','双向奔赴','替身梗','双胞胎'],
'情感基调':['甜蜜','虐心','治愈','搞笑','紧张','温馨','悲伤','热血','浪漫','刺激','感动','压抑','轻松','沉重','欢快','忧伤'],
'时代背景':['现代都市','民国乱世','古代宫廷','架空王朝','末日废土','近未来','平行世界','仙侠世界','西方中世纪','战争年代','八九十年代','千禧年代']
};

function loadPresetOptions(){
const container=document.getElementById('presetOptList');
container.innerHTML='';
Object.keys(presetOptionsData).forEach(name=>{
const opts=presetOptionsData[name];
const div=document.createElement('div');
div.style.cssText='padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:10px;cursor:pointer;transition:all .2s';
div.onmouseenter=()=>{div.style.borderColor='var(--accent)';div.style.transform='translateX(4px)';};
div.onmouseleave=()=>{div.style.borderColor='var(--border)';div.style.transform='';};
div.innerHTML=`
<div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:6px">
<span style="font-size:16px">${getPresetIcon(name)}</span>
${esc(name)}
</div>
<div style="font-size:11px;color:var(--text2);line-height:1.6">${opts.length}个选项：${opts.slice(0,6).join('、')}${opts.length>6?'...':''}</div>
`;
div.onclick=()=>{
const current=document.getElementById('wheelOptions').value;
const newOpts=opts.join('\n');
document.getElementById('wheelOptions').value=current?(current+'\n'+newOpts):newOpts;
if(!document.getElementById('wheelName').value){
document.getElementById('wheelName').value=name;
}
closePresetOpt();
showToast('已加载「'+name+'」模板');
};
container.appendChild(div);
});
document.getElementById('presetOptOv').classList.add('show');
}

function getPresetIcon(name){
const icons={
'故事标签':'🏷️',
'女性职业':'👩',
'男性职业':'👨',
'性格特点':'💫',
'故事场景':'🏠',
'故事元素':'✨',
'情感基调':'💕',
'时代背景':'🕰️'
};
return icons[name]||'📦';
}

function closePresetOpt(){
document.getElementById('presetOptOv').classList.remove('show');
}
// ==================== NAME GENERATOR ====================
let nameGenType='char';
let nameGenStyle='';

function openNameGen(){
document.getElementById('nameGenDesc').value='';
document.getElementById('nameGenResult').style.display='none';
document.getElementById('nameGenBtn').disabled=false;
document.getElementById('nameGenBtn').textContent='✨ 生成名字';
nameGenType='char';
nameGenStyle='';
document.getElementById('nameTypeChar').classList.add('act');
document.getElementById('nameTypeBook').classList.remove('act');
document.getElementById('nameTypePlace').classList.remove('act');
document.querySelectorAll('#nameGenOv .tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
document.getElementById('nameGenOv').classList.add('show');
setTimeout(()=>document.getElementById('nameGenDesc').focus(),200);
}

function closeNameGen(){
document.getElementById('nameGenOv').classList.remove('show');
}

function setNameType(type){
nameGenType=type;
document.getElementById('nameTypeChar').classList.toggle('act',type==='char');
document.getElementById('nameTypeBook').classList.toggle('act',type==='book');
document.getElementById('nameTypePlace').classList.toggle('act',type==='place');
}

function setNameStyle(style,el){
nameGenStyle=style;
const parent=el.parentElement;
parent.querySelectorAll('.tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
el.classList.add('act');
}

async function doGenNames(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

const desc=(document.getElementById('nameGenDesc').value||'').trim();
const btn=document.getElementById('nameGenBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';

// 构建上下文
let context='';
if(!desc){
// 使用当前设置
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0&&nameGenType==='char'){
context+='当前人物设定：\n';
validChars.forEach(c=>{
if(c.desc)context+=c.desc.substring(0,100)+'\n';
});
}
const wD=(document.getElementById('worldDesc')&&document.getElementById('worldDesc').value||'').trim();
if(wD)context+='世界观：'+wD.substring(0,200)+'\n';
}else{
context=desc;
}

const typeLabels={char:'人名',book:'书名/小说名',place:'地名/场所名'};
const typeHints={
char:'要求：名字要有寓意或特色，符合角色身份，朗朗上口，避免生僻字',
book:'要求：书名要有吸引力，能体现故事核心，让人想点进去看',
place:'要求：地名要有画面感，符合世界观设定，便于记忆'
};

let sysMsg='你是一位深谙文字美学的命名大师，为无数畅销小说起过名字。\n\n';
sysMsg+='【任务】生成5个'+typeLabels[nameGenType]+'，每个都要独特且有记忆点。\n\n';
sysMsg+='【输出格式】每行一个，格式：\n';
sysMsg+='名字 - 寓意/来源（15字以内）\n\n';
if(nameGenType==='char'){
sysMsg+='【人名技巧】\n';
sysMsg+='- 名字要能暗示性格或命运\n';
sysMsg+='- 避免生僻字，但可以用不常见的组合\n';
sysMsg+='- 姓和名要搭配和谐，读起来顺口\n';
sysMsg+='- 可以藏一些小心思（谐音、典故、意象）\n';
sysMsg+='- 反派的名字也要好听，不要太刻意\n';
}else if(nameGenType==='book'){
sysMsg+='【书名技巧】\n';
sysMsg+='- 要有画面感或情绪感染力\n';
sysMsg+='- 4-8个字最佳，太长记不住\n';
sysMsg+='- 可以用：意象型、悬念型、情感型、人物型\n';
sysMsg+='- 避免烂大街的词（霸道总裁、重生之类）\n';
sysMsg+='- 让人看到书名就想点进去\n';
}else{
sysMsg+='【地名技巧】\n';
sysMsg+='- 要有画面感，让人能想象出场景\n';
sysMsg+='- 符合世界观设定（古风/现代/奇幻）\n';
sysMsg+='- 可以暗示这个地方的特点或历史\n';
sysMsg+='- 便于记忆和口头传播\n';
}
sysMsg+='\n只输出5个名字，不要编号，不要多余内容。\n';

let userMsg='请生成5个'+typeLabels[nameGenType]+'。\n\n';
if(nameGenStyle)userMsg+='风格要求：'+nameGenStyle+'风格\n';
if(context)userMsg+='参考信息：\n'+context;
else userMsg+='自由发挥，生成有特色的名字';

const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const resultDiv=document.getElementById('nameGenResult');
const listDiv=document.getElementById('nameGenList');

if(useStream){
let fullText='';
await callAPIStream(messages,
(text)=>{
fullText=text;
resultDiv.style.display='block';
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
},
(text)=>{
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(text){
parseAndShowNames(text);
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent='✨ 生成名字';
showToast('生成失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(result){
resultDiv.style.display='block';
parseAndShowNames(result);
}else{
showToast('生成失败，请检查API设置');
}
}
}

function parseAndShowNames(text){
const listDiv=document.getElementById('nameGenList');
listDiv.innerHTML='';

const lines=text.split('\n').filter(l=>l.trim());
lines.forEach(line=>{
const cleaned=line.replace(/^\d+[\.\、\)\]\s]*/,'').trim();
if(!cleaned)return;

const item=document.createElement('div');
item.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--card);border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .2s';
item.onmouseenter=()=>{item.style.borderColor='var(--accent)';item.style.background='rgba(108,92,231,.08)';};
item.onmouseleave=()=>{item.style.borderColor='var(--border)';item.style.background='var(--card)';};

// 分离名字和说明
let name=cleaned;
let hint='';
const sepIdx=cleaned.search(/[\-\—\–\:：]/);
if(sepIdx>0){
name=cleaned.substring(0,sepIdx).trim();
hint=cleaned.substring(sepIdx+1).trim();
}

item.innerHTML=
'<div style="flex:1">'+
'<div style="font-size:14px;font-weight:600;color:var(--text)">'+esc(name)+'</div>'+
(hint?'<div style="font-size:10px;color:var(--text2);margin-top:2px">'+esc(hint)+'</div>':'')+
'</div>'+
'<button style="padding:4px 10px;border-radius:6px;border:1px solid var(--accent);background:transparent;color:var(--accent2);font-size:10px;cursor:pointer;flex-shrink:0" onclick="event.stopPropagation();copyName(\''+esc(name.replace(/'/g,"\\'"))+'\')">复制</button>';

item.onclick=()=>copyName(name);
listDiv.appendChild(item);
});

if(listDiv.children.length===0){
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
}
}

function copyName(name){
doCopy(name);
showToast('已复制：'+name+' 📋');
}
// ==================== 情节分支器 ====================
function openBranchGen(){
document.getElementById('branchInput').value='';
document.getElementById('branchContext').value='';
document.getElementById('branchResult').style.display='none';
document.getElementById('branchGenBtn').disabled=false;
document.getElementById('branchGenBtn').textContent='🌿 生成分支';
document.getElementById('branchOv').classList.add('show');
setTimeout(()=>document.getElementById('branchInput').focus(),200);
}

function closeBranchGen(){
document.getElementById('branchOv').classList.remove('show');
}

async function doGenBranch(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
const input=(document.getElementById('branchInput').value||'').trim();
if(!input){showToast('请描述当前的情节节点');return;}
const context=(document.getElementById('branchContext').value||'').trim();
const btn=document.getElementById('branchGenBtn');
btn.disabled=true;
btn.innerHTML='生成中 <span class="ldots"><span></span><span></span><span></span></span>';

let sysMsg='你是一位脑洞大开的故事设计师，擅长在关键节点创造多种可能性。\n\n';
sysMsg+='【任务】根据用户给出的情节节点，设计3条截然不同的发展路线。\n\n';
sysMsg+='【输出格式】\n';
sysMsg+='【路线A：甜向发展】\n';
sysMsg+='发展方向（60-100字）：具体描述会发生什么，角色会怎么做\n';
sysMsg+='情感走向：从XX到XX\n';
sysMsg+='爽点/泪点：这条线最打动人的地方\n\n';
sysMsg+='【路线B：虐向发展】\n';
sysMsg+='发展方向（60-100字）：具体描述会发生什么，角色会怎么做\n';
sysMsg+='情感走向：从XX到XX\n';
sysMsg+='爽点/泪点：这条线最打动人的地方\n\n';
sysMsg+='【路线C：反转发展】\n';
sysMsg+='发展方向（60-100字）：具体描述会发生什么，角色会怎么做\n';
sysMsg+='情感走向：从XX到XX\n';
sysMsg+='爽点/泪点：这条线最打动人的地方\n\n';
sysMsg+='【设计原则】\n';
sysMsg+='- 三条路线要有本质区别，不是程度差异\n';
sysMsg+='- 每条都要符合角色性格，不能OOC\n';
sysMsg+='- 要有"意料之外，情理之中"的感觉\n';
sysMsg+='- 给出具体的情节点，不要泛泛而谈\n';

const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
sysMsg+='\n【当前角色】\n';
validChars.forEach(c=>{
if(c.name)sysMsg+=c.name+(c.traits?' ('+c.traits.join('/').substring(0,30)+')':'')+'；';
});
sysMsg+='\n';
}

let userMsg='当前情节节点：\n'+input;
if(context)userMsg+='\n\n补充信息：'+context;

const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const resultDiv=document.getElementById('branchResult');
const listDiv=document.getElementById('branchList');

if(useStream){
let fullText='';
await callAPIStream(messages,
(text)=>{
fullText=text;
resultDiv.style.display='block';
listDiv.innerHTML='<div style="font-size:12px;line-height:1.8;white-space:pre-wrap;color:var(--text)">'+esc(text)+'</div>';
},
(text)=>{
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(text)parseBranchResult(text);
},
(errMsg)=>{
btn.disabled=false;
btn.textContent='🌿 生成分支';
showToast('生成失败：'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='🔄 重新生成';
if(result){
resultDiv.style.display='block';
parseBranchResult(result);
}
}
}

function parseBranchResult(text){
const listDiv=document.getElementById('branchList');
listDiv.innerHTML='';
const routes=text.split(/【路线[ABC]/).filter(r=>r.trim());
const labels=['A','B','C'];
const colors=['#6c5ce7','#27ae60','#e67e22'];

routes.forEach((route,i)=>{
if(i>=3)return;
const lines=route.trim().split('\n');
let title=lines[0]||'';
title=title.replace(/^[：:]\s*/,'').replace(/】$/,'').trim();
const content=lines.slice(1).join('\n').trim();

const card=document.createElement('div');
card.style.cssText='background:var(--card);border:2px solid '+colors[i]+';border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all .2s';
card.onmouseenter=()=>{card.style.transform='translateY(-2px)';card.style.boxShadow='0 4px 15px rgba(0,0,0,.15)';};
card.onmouseleave=()=>{card.style.transform='';card.style.boxShadow='';};
card.innerHTML=
'<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'+
'<span style="background:'+colors[i]+';color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600">路线'+labels[i]+'</span>'+
'<span style="font-size:13px;font-weight:600;color:var(--text)">'+esc(title)+'</span>'+
'</div>'+
'<div style="font-size:12px;line-height:1.7;color:var(--text2)">'+esc(content)+'</div>'+
'<div style="margin-top:10px;display:flex;gap:6px">'+
'<button style="flex:1;padding:6px;border-radius:8px;border:1px solid '+colors[i]+';background:transparent;color:'+colors[i]+';font-size:11px;cursor:pointer" onclick="event.stopPropagation();copyBranch(\''+esc(title.replace(/'/g,"\\'"))+'：'+esc(content.replace(/'/g,"\\'").replace(/\n/g,' '))+'\')">📋 复制</button>'+
'<button style="flex:1;padding:6px;border-radius:8px;border:none;background:'+colors[i]+';color:#fff;font-size:11px;cursor:pointer" onclick="event.stopPropagation();useBranch(\''+esc(content.replace(/'/g,"\\'").replace(/\n/g,' '))+'\')">✅ 采用此路线</button>'+
'</div>';
listDiv.appendChild(card);
});

if(listDiv.children.length===0){
listDiv.innerHTML='<div style="font-size:12px;line-height:1.8;white-space:pre-wrap;color:var(--text)">'+esc(text)+'</div>';
}
}

function copyBranch(text){
doCopy(text);
showToast('已复制路线 📋');
}
// ==================== 高级创作模式 ====================
let advChapters=[];// 章节大纲列表
let advCreateAbort=false;
let advProjects=ld('bj_advProjects',[]);
let advGenreList=ld('bj_advGenres',['甜宠','虐恋','悬疑','奇幻','古风','现代','校园','职场','重生','穿越','仙侠','都市','末日','科幻','豪门','娱乐圈','电竞','军旅']);

// 渲染故事类型标签
function renderAdvGenreTags(){
const container=document.getElementById('advGenreTags');
if(!container)return;
container.innerHTML='';
advGenreList.forEach((tag,idx)=>{
const span=document.createElement('span');
span.className='tag';
span.textContent=tag;
span.onclick=function(){toggleAdvTag(this);};
// 长按删除（仅自定义标签，前10个是默认的）
let lpTimer=null;
span.ontouchstart=function(e){
lpTimer=setTimeout(()=>{
if(idx>=10){// 只有自定义标签可删除
if(confirm('删除标签「'+tag+'」？')){
deleteAdvGenre(idx);
}
}else{
showToast('默认标签不可删除');
}
},600);
};
span.ontouchend=function(){clearTimeout(lpTimer);};
span.ontouchcancel=function(){clearTimeout(lpTimer);};
// PC端右键删除
span.oncontextmenu=function(e){
e.preventDefault();
if(idx>=10){
if(confirm('删除标签「'+tag+'」？')){
deleteAdvGenre(idx);
}
}else{
showToast('默认标签不可删除');
}
};
container.appendChild(span);
});
}

// 添加自定义类型
function addAdvGenre(){
const input=document.getElementById('advNewGenre');
const val=(input.value||'').trim();
if(!val){showToast('请输入标签名');return;}
if(val.length>10){showToast('标签最多10个字');return;}
if(advGenreList.includes(val)){showToast('该标签已存在');return;}
advGenreList.push(val);
sv('bj_advGenres',advGenreList);
input.value='';
renderAdvGenreTags();
// 自动选中新添加的标签
setTimeout(()=>{
const tags=document.querySelectorAll('#advGenreTags .tag');
const lastTag=tags[tags.length-1];
if(lastTag)lastTag.classList.add('act');
},50);
showToast('已添加：'+val);
}

// 删除自定义类型
function deleteAdvGenre(idx){
if(idx<10)return;// 保护默认标签
advGenreList.splice(idx,1);
sv('bj_advGenres',advGenreList);
renderAdvGenreTags();
showToast('标签已删除');
}
let currentAdvProject=null;

function openAdvancedCreate(){
renderAdvGenreTags();
// 重置
advChapters=[];
currentAdvProject=null;
document.getElementById('advTitle').value='';
document.getElementById('advWordsPerCh').value='1500';
document.getElementById('advTheme').value='';
document.getElementById('advSynopsis').value='';
document.getElementById('advAvoid').value='';
document.getElementById('advProgress').style.display='none';
document.getElementById('advStartBtn').disabled=false;
document.getElementById('advStartBtn').textContent='🚀 开始创作';
// 重置标签
document.querySelectorAll('#advGenreTags .tag').forEach(t=>t.classList.remove('act'));
// 重置开关
['advUseChars','advUseWorld','advUseStyle'].forEach(id=>{
document.getElementById(id).checked=true;
updateAdvSwitch(id);
});
renderAdvChapterList();
document.getElementById('advCreateOv').classList.add('show');
}

function closeAdvancedCreate(){
advCreateAbort=true;
document.getElementById('advCreateOv').classList.remove('show');
}

function toggleAdvTag(el){
el.classList.toggle('act');
}

function toggleAdvSwitch(id){
const cb=document.getElementById(id);
cb.checked=!cb.checked;
updateAdvSwitch(id);
}

function updateAdvSwitch(id){
const cb=document.getElementById(id);
const track=document.getElementById(id+'Track');
const thumb=document.getElementById(id+'Thumb');
if(!track||!thumb)return;
if(cb.checked){
track.style.background='var(--accent)';
thumb.style.left='20px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}

// 添加章节
function addAdvChapter(){
advChapters.push({outline:'',title:''});
renderAdvChapterList();
// 滚动到底部
setTimeout(()=>{
const container=document.getElementById('advChapterList');
container.scrollTop=container.scrollHeight;
// 聚焦到新添加的输入框
const lastInput=container.querySelector('.adv-ch-item:last-child textarea');
if(lastInput)lastInput.focus();
},100);
}

// 删除章节
function deleteAdvChapter(idx){
if(advChapters.length<=1){
showToast('至少保留一章');
return;
}
advChapters.splice(idx,1);
renderAdvChapterList();
showToast('已删除第'+(idx+1)+'章');
}

// 上移章节
function moveAdvChapterUp(idx){
if(idx<=0)return;
const temp=advChapters[idx];
advChapters[idx]=advChapters[idx-1];
advChapters[idx-1]=temp;
renderAdvChapterList();
}

// 下移章节
function moveAdvChapterDown(idx){
if(idx>=advChapters.length-1)return;
const temp=advChapters[idx];
advChapters[idx]=advChapters[idx+1];
advChapters[idx+1]=temp;
renderAdvChapterList();
}

// 渲染章节列表
function renderAdvChapterList(){
const container=document.getElementById('advChapterList');
document.getElementById('advChCount').textContent='共 '+advChapters.length+' 章';

if(advChapters.length===0){
container.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2);font-size:12px">还没有章节<br>点击下方按钮添加</div>';
return;
}

container.innerHTML='';
advChapters.forEach((ch,idx)=>{
const div=document.createElement('div');
div.className='adv-ch-item';
div.style.cssText='background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;position:relative';
div.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="display:flex;align-items:center;gap:8px">
<span style="font-size:12px;font-weight:600;color:var(--accent2)">第${idx+1}章</span>
<input type="text" value="${esc(ch.title||'')}" placeholder="章节标题（可选）" 
style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;width:120px"
onchange="advChapters[${idx}].title=this.value">
</div>
<div style="display:flex;gap:4px">
<button onclick="moveAdvChapterUp(${idx})" style="padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:10px;cursor:pointer" ${idx===0?'disabled style="opacity:.3"':''}>↑</button>
<button onclick="moveAdvChapterDown(${idx})" style="padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:10px;cursor:pointer" ${idx===advChapters.length-1?'disabled style="opacity:.3"':''}>↓</button>
<button onclick="deleteAdvChapter(${idx})" style="padding:2px 6px;border-radius:4px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:10px;cursor:pointer">✕</button>
</div>
</div>
<textarea placeholder="本章大纲：要写什么内容、关键情节、情感走向..." 
style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;min-height:60px;resize:vertical;font-family:inherit;line-height:1.6"
onchange="advChapters[${idx}].outline=this.value">${esc(ch.outline||'')}</textarea>
`;
container.appendChild(div);
});
}

// 获取选中的标签
function getAdvSelectedTags(containerId){
const tags=[];
document.querySelectorAll('#'+containerId+' .tag.act').forEach(t=>{
tags.push(t.textContent);
});
return tags;
}

// 保存项目
function saveAdvProject(){
const title=document.getElementById('advTitle').value.trim();
if(!title){showToast('请先输入小说标题');return;}
// 同步章节数据
syncAdvChaptersFromUI();
const project={
id:currentAdvProject?currentAdvProject.id:uid(),
title:title,
wordsPerCh:parseInt(document.getElementById('advWordsPerCh').value)||1500,
theme:document.getElementById('advTheme').value.trim(),
synopsis:document.getElementById('advSynopsis').value.trim(),
avoid:document.getElementById('advAvoid').value.trim(),
genres:getAdvSelectedTags('advGenreTags'),
chapters:JSON.parse(JSON.stringify(advChapters)),
useChars:document.getElementById('advUseChars').checked,
useWorld:document.getElementById('advUseWorld').checked,
useStyle:document.getElementById('advUseStyle').checked,
savedAt:new Date().toISOString()
};
// 更新或新增
const existIdx=advProjects.findIndex(p=>p.id===project.id);
if(existIdx>=0){
advProjects[existIdx]=project;
}else{
advProjects.unshift(project);
}
sv('bj_advProjects',advProjects);
currentAdvProject=project;
showToast('项目已保存：'+title+' 💾');
}

// 同步UI到数据
function syncAdvChaptersFromUI(){
document.querySelectorAll('#advChapterList .adv-ch-item').forEach((item,idx)=>{
if(advChapters[idx]){
const titleInput=item.querySelector('input[type="text"]');
const outlineInput=item.querySelector('textarea');
if(titleInput)advChapters[idx].title=titleInput.value;
if(outlineInput)advChapters[idx].outline=outlineInput.value;
}
});
}

// 加载项目
function loadAdvProject(id){
const project=advProjects.find(p=>p.id===id);
if(!project)return;
currentAdvProject=project;
document.getElementById('advTitle').value=project.title||'';
document.getElementById('advWordsPerCh').value=project.wordsPerCh||1500;
document.getElementById('advTheme').value=project.theme||'';
document.getElementById('advSynopsis').value=project.synopsis||'';
document.getElementById('advAvoid').value=project.avoid||'';
// 恢复标签
renderAdvGenreTags();
setTimeout(()=>{
document.querySelectorAll('#advGenreTags .tag').forEach(t=>{
t.classList.toggle('act',(project.genres||[]).includes(t.textContent));
});
},50);
// 恢复开关
document.getElementById('advUseChars').checked=project.useChars!==false;
document.getElementById('advUseWorld').checked=project.useWorld!==false;
document.getElementById('advUseStyle').checked=project.useStyle!==false;
['advUseChars','advUseWorld','advUseStyle'].forEach(updateAdvSwitch);
// 恢复章节
advChapters=JSON.parse(JSON.stringify(project.chapters||[]));
renderAdvChapterList();
closeAdvLoad();
showToast('已加载：'+project.title);
}

// 删除项目
function deleteAdvProject(id){
showDlg('删除项目','确定要删除这个项目吗？',()=>{
advProjects=advProjects.filter(p=>p.id!==id);
sv('bj_advProjects',advProjects);
renderAdvProjectList();
showToast('项目已删除');
},true);
}

// 打开加载弹窗
function openAdvLoad(){
renderAdvProjectList();
document.getElementById('advLoadOv').classList.add('show');
}

function closeAdvLoad(){
document.getElementById('advLoadOv').classList.remove('show');
}

function renderAdvProjectList(){
const container=document.getElementById('advProjectList');
if(advProjects.length===0){
container.innerHTML='<div style="text-align:center;padding:30px;color:var(--text2);font-size:12px">还没有保存的项目</div>';
return;
}
container.innerHTML='';
advProjects.forEach(p=>{
const div=document.createElement('div');
div.style.cssText='padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .2s';
div.onmouseenter=()=>{div.style.borderColor='var(--accent)';};
div.onmouseleave=()=>{div.style.borderColor='var(--border)';};
const chCount=(p.chapters||[]).length;
const time=p.savedAt?new Date(p.savedAt).toLocaleDateString():'';
div.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:flex-start">
<div onclick="loadAdvProject('${p.id}')" style="flex:1">
<div style="font-size:13px;font-weight:600;margin-bottom:4px">${esc(p.title||'未命名')}</div>
<div style="font-size:10px;color:var(--text2)">${chCount}章 · ${p.wordsPerCh||1500}字/章 · ${time}</div>
</div>
<button onclick="event.stopPropagation();deleteAdvProject('${p.id}')" style="padding:4px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:10px;cursor:pointer">删除</button>
</div>
`;
container.appendChild(div);
});
}

// 停止创作
function stopAdvCreate(){
advCreateAbort=true;
showToast('正在停止...');
}

// 开始创作
async function startAdvCreate(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}
syncAdvChaptersFromUI();
const title=document.getElementById('advTitle').value.trim();
if(!title){showToast('请输入小说标题');return;}
if(advChapters.length===0){showToast('请至少添加一章');return;}
// 检查是否有大纲
const hasOutline=advChapters.some(ch=>ch.outline&&ch.outline.trim());
if(!hasOutline){
const synopsis=document.getElementById('advSynopsis').value.trim();
if(!synopsis){
showToast('请填写全文梗概或章节大纲');
return;
}
}
const wordsPerCh=parseInt(document.getElementById('advWordsPerCh').value)||1500;
const theme=document.getElementById('advTheme').value.trim();
const synopsis=document.getElementById('advSynopsis').value.trim();
const avoid=document.getElementById('advAvoid').value.trim();
const genres=getAdvSelectedTags('advGenreTags');
const useChars=document.getElementById('advUseChars').checked;
const useWorld=document.getElementById('advUseWorld').checked;
const useStyle=document.getElementById('advUseStyle').checked;
const totalCh=advChapters.length;
// 显示进度
document.getElementById('advProgress').style.display='block';
document.getElementById('advStartBtn').disabled=true;
document.getElementById('advStartBtn').textContent='创作中...';
advCreateAbort=false;
// 创建小说对象
const novel={
id:uid(),
type:'novel',
title:title,
chapters:[],
chOutlines:advChapters.map(ch=>ch.outline||''),
tags:genres,
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
// 构建系统提示词
let sysPrompt='';
if(useChars||useWorld||useStyle){
sysPrompt=buildSysPrompt();
}else{
sysPrompt='你是一位才华横溢的小说家，擅长根据大纲创作精彩的故事。\n';
}
sysPrompt+='\n\n【本次创作任务】\n';
sysPrompt+='小说名：《'+title+'》\n';
sysPrompt+='总章数：'+totalCh+'章\n';
sysPrompt+='每章字数：不少于'+wordsPerCh+'字\n';
if(theme)sysPrompt+='核心主题：'+theme+'\n';
if(genres.length>0)sysPrompt+='故事类型：'+genres.join('、')+'\n';
if(avoid)sysPrompt+='【绝对禁止出现的内容】\n'+avoid+'\n请在创作中严格回避以上内容，不要以任何形式触及。\n';
if(synopsis){
sysPrompt+='\n【全文梗概（故事主线）】\n'+synopsis+'\n';
sysPrompt+='请严格围绕此主线推进情节，不要偏离核心走向。\n';
}
sysPrompt+='\n【高级创作模式特别要求】\n';
sysPrompt+='1. 每章必须严格遵守对应的章节大纲，大纲中提到的事件、人物行为、情绪转折必须全部体现\n';
sysPrompt+='2. 章与章之间要有明确的因果关系，上一章的结尾要自然衔接下一章的开头\n';
sysPrompt+='3. 人物性格要前后一致，不能突然OOC（除非大纲明确要求性格转变）\n';
sysPrompt+='4. 每章结尾必须设置钩子（悬念/情感高点/新信息），让读者想看下一章\n';
sysPrompt+='5. 伏笔管理：大纲中提到要埋的伏笔必须自然融入，不能生硬\n';
sysPrompt+='6. 情感节奏：不要每章都是高潮，要有张有弛，参考"起承转合"的节奏\n';
sysPrompt+='7. 对话占比控制在30%-50%之间，不要全是对话也不要全是叙述\n';
// 逐章创作
for(let i=0;i<totalCh;i++){
if(advCreateAbort){
showToast('创作已停止，已完成'+novel.chapters.length+'章');
break;
}
const chNum=i+1;
const chData=advChapters[i];
const pct=Math.round((i/totalCh)*100);
document.getElementById('advProgressBar').style.width=pct+'%';
document.getElementById('advProgressText').textContent=chNum+'/'+totalCh+' 章';
document.getElementById('advProgressInfo').textContent='正在创作：'+(chData.title||'第'+chNum+'章')+'...';
// 构建本章提示词
let userMsg='【创作任务】创作《'+title+'》第'+chNum+'章';
if(chData.title)userMsg+='「'+chData.title+'」';
userMsg+='（共'+totalCh+'章）\n\n';
// 本章大纲
if(chData.outline&&chData.outline.trim()){
userMsg+='【本章大纲（必须严格遵守）】\n'+chData.outline+'\n\n';
}else{
userMsg+='【本章位置】第'+chNum+'/'+totalCh+'章\n';
if(chNum===1)userMsg+='这是开篇，需要抓人的开场\n\n';
else if(chNum===totalCh)userMsg+='这是结局章，需要收束故事\n\n';
else userMsg+='请根据全文梗概推进情节\n\n';
}
// 前文回顾
if(novel.chapters.length>0){
userMsg+='【前文回顾】\n';
// 简要回顾前几章
const reviewStart=Math.max(0,novel.chapters.length-3);
for(let j=reviewStart;j<novel.chapters.length;j++){
const prevCh=novel.chapters[j];
const prevTitle=advChapters[j]&&advChapters[j].title?'「'+advChapters[j].title+'」':'';
userMsg+='第'+(j+1)+'章'+prevTitle+'：'+prevCh.substring(0,100).replace(/\n/g,' ')+'...\n';
}
// 上一章结尾
const lastCh=novel.chapters[novel.chapters.length-1];
userMsg+='\n【上一章结尾】\n'+lastCh.substring(Math.max(0,lastCh.length-800))+'\n\n';
}
userMsg+='【创作要求】\n';
userMsg+='- 【字数硬性要求】正文字数严格不少于'+wordsPerCh+'字！这是铁律，低于此字数视为创作失败。建议写到'+(wordsPerCh+500)+'字以上确保达标\n';
userMsg+='- 直接输出正文，无标题无章节号无作者按语\n';
if(novel.chapters.length>0){
userMsg+='- 开头必须直接承接上一章结尾，用动作或对话切入，禁止用"话说""却说"等说书腔开头，禁止复述前情\n';
userMsg+='- 保持人物说话方式和性格与前文一致\n';
}else{
userMsg+='- 这是第一章，需要一个抓人的开场，让读者在前三段就被吸引\n';
userMsg+='- 让主角在行动中登场，不要用旁白介绍\n';
}
if(chNum<totalCh){
userMsg+='- 结尾必须在悬念或情感高点收尾，制造"非看下一章不可"的冲动\n';
userMsg+='- 不要在本章解决所有矛盾，留有余地给后续章节\n';
}else{
userMsg+='- 这是最后一章，需要：①解决核心矛盾 ②回收主要伏笔 ③给主角一个有成长感的结局 ④结尾留有余韵\n';
}
if(avoid)userMsg+='- 严禁出现：'+avoid+'\n';
const messages=[{role:'system',content:sysPrompt},{role:'user',content:userMsg}];
// 调用API
const result=await callAPINonStream(messages);
if(!result){
showToast('第'+chNum+'章创作失败');
break;
}
novel.chapters.push(result);
novel.updatedAt=new Date().toISOString();
// 每章生成后立即保存，防止中途停止丢失
const tempIdx=crWorks.findIndex(w=>w.id===novel.id);
if(tempIdx>-1){crWorks[tempIdx]=JSON.parse(JSON.stringify(novel));}
else{crWorks.unshift(JSON.parse(JSON.stringify(novel)));}
sv('bj_crWorks',crWorks);
// 延迟避免限流
await new Promise(r=>setTimeout(r,800));
}
// 完成
document.getElementById('advProgressBar').style.width='100%';
document.getElementById('advProgressText').textContent=novel.chapters.length+'/'+totalCh+' 章';
document.getElementById('advProgressInfo').textContent='创作完成！';
document.getElementById('advStartBtn').disabled=false;
document.getElementById('advStartBtn').textContent='🚀 开始创作';
if(novel.chapters.length>0){
// 保存到创作页
crWorks.unshift(novel);
sv('bj_crWorks',crWorks);

// 自动收藏
const colCopy=JSON.parse(JSON.stringify(novel));
colCopy.cover=null;
colCopy.status='ongoing';
colCopy.rating=0;
cols.books.push(colCopy);
sv(K.cols,cols);

const totalWords=novel.chapters.reduce((sum,ch)=>sum+countWords(ch),0);
showToast('🎉 创作完成！共'+novel.chapters.length+'章，'+totalWords+'字',4000);

setTimeout(()=>{
closeAdvancedCreate();
renderCrList();
renderCollections();
// 询问是否打开阅读
if(confirm('创作完成！是否立即阅读《'+novel.title+'》？')){
openReading(colCopy);
}
},1000);
}
}
// ==================== 上下文编辑器 ====================
// ==================== 全局变量定义区 ==================== let articleContexts = ld('bj_articleContexts', {}); let xjAbortCtrl = null; let ttsUtterance = null; let ringAudio = null; let isGen = false; let abortCtrl = null;// 存储每篇文章的上下文设置

function openContextEditor(){
if(!curRd||curRd.type!=='long'){showToast('请先打开一篇长篇文章');return;}
// 加载已保存的上下文设置
const ctx=articleContexts[curRd.id]||{};
document.getElementById('ctxPrevSummary').value=ctx.prevSummary||'';
document.getElementById('ctxForeshadows').value=ctx.foreshadows||'';
document.getElementById('ctxCharStates').value=ctx.charStates||'';
document.getElementById('ctxDirection').value=ctx.direction||document.getElementById('dirInput').value||'';
document.getElementById('ctxChOutline').value=ctx.chOutline||'';
document.getElementById('ctxSpecialReq').value=ctx.specialReq||'';
document.getElementById('ctxLastChLen').value=ctx.lastChLen||1500;
document.getElementById('ctxLastChLenVal').textContent=(ctx.lastChLen||1500)+'字';
document.getElementById('ctxSendFirstCh').checked=ctx.sendFirstCh!==false;
updateCtxSwitch('ctxSendFirstCh');
document.getElementById('contextEditorOv').classList.add('show');
}

function closeContextEditor(){
document.getElementById('contextEditorOv').classList.remove('show');
}

function toggleCtxSwitch(id,el){
const cb=document.getElementById(id);
cb.checked=!cb.checked;
updateCtxSwitch(id);
}

function updateCtxSwitch(id){
const cb=document.getElementById(id);
const track=document.getElementById(id+'Track');
const thumb=document.getElementById(id+'Thumb');
if(cb.checked){
track.style.background='var(--accent)';
thumb.style.left='22px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}

function clearCtxField(id){
document.getElementById(id).value='';
}

function saveContextSettings(){
if(!curRd)return;
const ctx={
prevSummary:document.getElementById('ctxPrevSummary').value.trim(),
foreshadows:document.getElementById('ctxForeshadows').value.trim(),
charStates:document.getElementById('ctxCharStates').value.trim(),
direction:document.getElementById('ctxDirection').value.trim(),
chOutline:document.getElementById('ctxChOutline').value.trim(),
specialReq:document.getElementById('ctxSpecialReq').value.trim(),
lastChLen:parseInt(document.getElementById('ctxLastChLen').value)||1500,
sendFirstCh:document.getElementById('ctxSendFirstCh').checked
};
articleContexts[curRd.id]=ctx;
sv('bj_articleContexts',articleContexts);
return ctx;
}

function saveAndContinue(){
saveContextSettings();
closeContextEditor();
continueChapterWithContext();
}

// AI生成前情提要
async function aiGenPrevSummary(){
if(!curRd||!curRd.chapters||curRd.chapters.length<1){showToast('章节太少，无法生成');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先配置API');return;}
const btn=event.target;
btn.disabled=true;
btn.innerHTML='生成中...';
let allText='';
curRd.chapters.forEach((ch,i)=>{
allText+='【第'+(i+1)+'章】\n'+ch.substring(0,800)+'\n\n';
});
const sysMsg='你是一位专业的小说编辑，擅长提炼故事要点。请为以下小说内容生成一份简洁的前情提要，供AI续写时参考。\n\n要求：\n- 按章节顺序梳理关键情节\n- 突出人物关系变化\n- 标注重要转折点\n- 总字数200-400字\n- 使用简洁的条目式或分段式';
const userMsg='请为以下内容生成前情提要：\n\n'+allText.substring(0,6000);
const result=await callAPINonStream([{role:'system',content:sysMsg},{role:'user',content:userMsg}]);
btn.disabled=false;
btn.innerHTML='🤖 AI生成提要';
if(result){
document.getElementById('ctxPrevSummary').value=result;
showToast('前情提要已生成 ✨');
}
}

// AI分析人物状态
async function aiGenCharStates(){
if(!curRd||!curRd.chapters||curRd.chapters.length<1){showToast('章节太少');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先配置API');return;}
const btn=event.target;
btn.disabled=true;
btn.innerHTML='分析中...';
const lastCh=curRd.chapters[curRd.chapters.length-1]||'';
const validChars=characters.filter(c=>c.name);
let charInfo='';
if(validChars.length>0){
charInfo='【已设定的角色】\n'+validChars.map(c=>c.name).join('、')+'\n\n';
}
const sysMsg='你是一位细心的小说分析师。请根据最新章节内容，分析主要角色当前的状态。\n\n输出格式：\n角色名：当前位置/处境，情绪状态，与其他角色的关系变化\n\n要求简洁，每个角色1-2句话。';
const userMsg=charInfo+'【最新章节内容】\n'+lastCh.substring(0,3000)+'\n\n请分析各角色当前状态：';
const result=await callAPINonStream([{role:'system',content:sysMsg},{role:'user',content:userMsg}]);
btn.disabled=false;
btn.innerHTML='🤖 AI分析人物状态';
if(result){
document.getElementById('ctxCharStates').value=result;
showToast('人物状态已分析 ✨');
}
}

// 从伏笔追踪器导入
function loadForeshadowsToCtx(){
if(!curRd){showToast('请先打开文章');return;}
const list=getForeshadows(curRd.id);
const pending=list.filter(f=>f.status!=='done');
if(pending.length===0){
showToast('没有待回收的伏笔');
return;
}
let text='';
pending.forEach(f=>{
text+='- '+f.content+(f.chapter?' ('+f.chapter+')':'')+'\n';
});
document.getElementById('ctxForeshadows').value=text.trim();
showToast('已导入'+pending.length+'条伏笔');
}

// 使用上下文设置续写
async function continueChapterWithContext(){
if(isGen){showToast('正在生成中');return;}
if(!curRd||curRd.type!=='long')return;
const ctx=articleContexts[curRd.id]||{};
isGen=true;
const btn=document.getElementById('btnCont');
btn.disabled=true;
btn.innerHTML='正在创作 <span class="ldots"><span></span><span></span><span></span></span>';
const chNum=curRd.chapters.length+1;
// 构建上下文
let userMsg='【续写任务】创作《'+curRd.title+'》第'+chNum+'章\n\n';
// 1. 前情提要（手动编辑优先）
if(ctx.prevSummary){
userMsg+='【前情提要】\n'+ctx.prevSummary+'\n\n';
}else{
// 自动生成简要回顾
const totalCh=curRd.chapters.length;
if(totalCh>=2){
userMsg+='【前情回顾】\n';
const firstCh=curRd.chapters[0]||'';
userMsg+='故事开篇：'+firstCh.substring(0,150).replace(/\n/g,' ')+'...\n';
if(totalCh>=4){
const midCh=Math.floor(totalCh/2);
const midText=curRd.chapters[midCh]||'';
userMsg+='中段发展：'+midText.substring(0,100).replace(/\n/g,' ')+'...\n';
}
userMsg+='\n';
}
}
// 2. 第一章开头（保持基调）
if(ctx.sendFirstCh!==false&&curRd.chapters.length>1){
const firstCh=curRd.chapters[0]||'';
const firstOpening=firstCh.substring(0,500);
userMsg+='【第一章开头（基调参考）】\n'+firstOpening+'\n\n';
}
// 3. 上一章结尾
const lastChLen=ctx.lastChLen||1500;
const lastCh=curRd.chapters[curRd.chapters.length-1]||'';
const lastChEnding=lastCh.substring(Math.max(0,lastCh.length-lastChLen));
userMsg+='【上一章结尾】\n'+lastChEnding+'\n\n';
// 4. 重要伏笔
if(ctx.foreshadows){
userMsg+='【重要伏笔/悬念（请记住并适时回收）】\n'+ctx.foreshadows+'\n\n';
}
// 5. 人物当前状态
if(ctx.charStates){
userMsg+='【人物当前状态】\n'+ctx.charStates+'\n\n';
}
// 6. 本章方向
if(ctx.direction){
userMsg+='【本章发展方向】\n'+ctx.direction+'\n\n';
}
// 7. 本章大纲
if(ctx.chOutline){
userMsg+='【本章详细大纲（必须严格遵守）】\n'+ctx.chOutline+'\n\n';
}
// 8. 特殊要求
if(ctx.specialReq){
userMsg+='【特殊要求】\n'+ctx.specialReq+'\n\n';
}
// 9. 创作指南
userMsg+='【创作指南】\n';
userMsg+='- 开头直接承接上文，用动作或对话切入，禁止复述前情\n';
userMsg+='- 本章要有明确的情绪起伏和情节推进\n';
userMsg+='- 如果有大纲，严格按大纲写；如果没有，自由发挥但要合理\n';
userMsg+='- 结尾在悬念或情感高点收尾\n';
userMsg+='- 直接输出正文，无标题无章节号\n'; const mW4=parseInt(document.getElementById('minWords').value)||800; userMsg+='- 【字数硬性要求】本章正文必须不少于'+mW4+'字！低于此字数不合格，宁多勿少，建议写到'+(mW4+500)+'字以上\n';
const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];
const rdContent=document.getElementById('rdContent');
if(!useStream){
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!result)return;
curRd.chapters.push(result);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML='<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span><span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span><span onclick="showChapterWordStats()" style="cursor:pointer;color:var(--accent2)">📊 字数详情</span>';
document.getElementById('btnUndo').style.display='inline-block';
showToast('第'+chNum+'章创作完成！✨');
return;
}
await callAPIStream(messages,
(fullText)=>{
const paras=fullText.split(/\n+/).filter(p=>p.trim());
rdContent.innerHTML=paras.map(p=>'<p>'+esc(p.trim())+'</p>').join('');
document.getElementById('rdModal').scrollTop=document.getElementById('rdModal').scrollHeight;
},
(fullText)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
if(!fullText)return;
// 续写字数不足自动补写
let finalText=fullText;
const mWCh=parseInt(document.getElementById('minWords').value)||800;
const chWc=countWords(fullText);
if(chWc<mWCh&&chWc>100){
showToast('字数不足('+chWc+'/'+mWCh+')，正在补写...',3000);
const extMsg2=[
{role:'system',content:buildSysPrompt()},
{role:'user',content:'以下是一个章节的内容，只有'+chWc+'字，需要至少'+mWCh+'字。请直接续写下去，不要重复已有内容，不要加标题说明，直接输出续写部分：\n\n'+fullText}
];
callAPINonStream(extMsg2).then(function(extR2){
if(extR2)finalText=fullText+'\n\n'+extR2;
curRd.chapters.push(finalText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
try{recordManualWrite(countWords(finalText),1);}catch(e){}
showToast('第'+chNum+'章创作完成！'+countWords(finalText)+'字 ✨');
});
}else{
curRd.chapters.push(finalText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>📖 长篇连载</span><span>🕐 '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>共 '+curRd.chapters.length+' 章</span><span>'+getTotalWords(curRd)+' 字</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
try{recordManualWrite(countWords(finalText),1);}catch(e){}
showToast('第'+chNum+'章创作完成！'+countWords(finalText)+'字 ✨');
}
},
(errMsg)=>{
isGen=false;btn.disabled=false;btn.textContent='📝 继续连载下一章';
showToast(errMsg,3000);
}
);
}
// ==================== 伏笔追踪器 ====================
function getForeshadows(articleId){
if(!articleId)return[];
return ld('bj_foreshadow_'+articleId,[]);
}

function saveForeshadows(articleId,list){
sv('bj_foreshadow_'+articleId,list);
}

function openForeshadow(){
if(!curRd){showToast('请先打开一篇文章');return;}
renderForeshadowList();
document.getElementById('foreshadowOv').classList.add('show');
}

function closeForeshadow(){
document.getElementById('foreshadowOv').classList.remove('show');
}

function renderForeshadowList(){
if(!curRd)return;
const list=getForeshadows(curRd.id);
const container=document.getElementById('foreshadowList');

let pending=0,done=0;
list.forEach(f=>{if(f.status==='done')done++;else pending++;});
document.getElementById('fsCountPending').textContent=pending;
document.getElementById('fsCountDone').textContent=done;

if(list.length===0){
container.innerHTML='<div style="text-align:center;padding:30px;color:var(--text2);font-size:12px">还没有记录伏笔<br><br>点击「添加伏笔」手动记录<br>或点击「AI识别」自动分析</div>';
return;
}

container.innerHTML='';
list.forEach((f,i)=>{
const item=document.createElement('div');
item.className='fs-item '+(f.status||'pending');
const statusIcon=f.status==='done'?'✅':'📌';
const statusText=f.status==='done'?'已回收':'待回收';
item.innerHTML=
'<div class="fs-item-hdr">'+
'<span style="font-size:11px;font-weight:600;color:'+(f.status==='done'?'var(--success)':'#f0a030')+'">'+statusIcon+' '+statusText+'</span>'+
'<span style="font-size:10px;color:var(--text2)">#'+(i+1)+'</span>'+
'</div>'+
'<div class="fs-item-content">'+esc(f.content)+'</div>'+
'<div class="fs-item-meta">'+
'<span>📍 埋设：'+(f.chapter||'未知')+'</span>'+
(f.planChapter?'<span>🎯 计划：'+f.planChapter+'</span>':'')+
(f.doneChapter?'<span>✅ 回收：'+f.doneChapter+'</span>':'')+
'</div>'+
'<div class="fs-item-acts">'+
(f.status!=='done'?'<button class="done-btn" onclick="markFsDone('+i+')">✅ 标记已回收</button>':
'<button onclick="markFsUndo('+i+')">↩ 撤销回收</button>')+
'<button onclick="editFs('+i+')">✏️ 编辑</button>'+
'<button class="del-btn" onclick="deleteFs('+i+')">🗑️</button>'+
'</div>';
container.appendChild(item);
});
}

let editingFsIdx=-1;

function addForeshadow(){
editingFsIdx=-1;
document.getElementById('addFsTitle').textContent='添加伏笔';
document.getElementById('fsContent').value='';
document.getElementById('fsChapter').value=curRd&&curRd.type==='long'?'第'+(curCh+1)+'章':'';
document.getElementById('fsPlanChapter').value='';
document.getElementById('addFsBtn').textContent='保存';
document.getElementById('addFsOv').classList.add('show');
setTimeout(()=>document.getElementById('fsContent').focus(),200);
}

function editFs(idx){
if(!curRd)return;
const list=getForeshadows(curRd.id);
if(idx<0||idx>=list.length)return;
const f=list[idx];
editingFsIdx=idx;
document.getElementById('addFsTitle').textContent='编辑伏笔';
document.getElementById('fsContent').value=f.content||'';
document.getElementById('fsChapter').value=f.chapter||'';
document.getElementById('fsPlanChapter').value=f.planChapter||'';
document.getElementById('addFsBtn').textContent='更新';
document.getElementById('addFsOv').classList.add('show');
}

function closeAddFs(){
document.getElementById('addFsOv').classList.remove('show');
editingFsIdx=-1;
}

function saveFs(){
if(!curRd)return;
const content=(document.getElementById('fsContent').value||'').trim();
if(!content){showToast('请填写伏笔内容');return;}
const chapter=(document.getElementById('fsChapter').value||'').trim();
const planChapter=(document.getElementById('fsPlanChapter').value||'').trim();

const list=getForeshadows(curRd.id);
if(editingFsIdx>=0&&editingFsIdx<list.length){
list[editingFsIdx].content=content;
list[editingFsIdx].chapter=chapter;
list[editingFsIdx].planChapter=planChapter;
showToast('伏笔已更新');
}else{
list.push({
content:content,
chapter:chapter,
planChapter:planChapter,
status:'pending',
createdAt:new Date().toISOString()
});
showToast('伏笔已添加 📌');
}
saveForeshadows(curRd.id,list);
closeAddFs();
renderForeshadowList();
}

function markFsDone(idx){
if(!curRd)return;
const list=getForeshadows(curRd.id);
if(idx<0||idx>=list.length)return;
list[idx].status='done';
list[idx].doneChapter=curRd.type==='long'?'第'+(curCh+1)+'章':'已回收';
saveForeshadows(curRd.id,list);
renderForeshadowList();
showToast('伏笔已标记为回收 ✅');
}

function markFsUndo(idx){
if(!curRd)return;
const list=getForeshadows(curRd.id);
if(idx<0||idx>=list.length)return;
list[idx].status='pending';
list[idx].doneChapter='';
saveForeshadows(curRd.id,list);
renderForeshadowList();
showToast('已撤销回收状态');
}

function deleteFs(idx){
if(!curRd)return;
showDlg('删除伏笔','确定要删除这条伏笔记录吗？',()=>{
const list=getForeshadows(curRd.id);
list.splice(idx,1);
saveForeshadows(curRd.id,list);
renderForeshadowList();
showToast('伏笔已删除');
},true);
}

async function aiDetectForeshadow(){
if(!curRd){showToast('请先打开一篇文章');return;}
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先在设置中配置API');return;}

let text='';
if(curRd.type==='long'&&curRd.chapters){
curRd.chapters.forEach((ch,i)=>{
text+='【第'+(i+1)+'章】\n'+ch+'\n\n';
});
}else{
text=curRd.content||'';
}

if(countWords(text)<100){showToast('文章内容太少，无法分析');return;}

const btn=document.getElementById('aiDetectBtn');
btn.disabled=true;
btn.innerHTML='分析中 <span class="ldots"><span></span><span></span><span></span></span>';

let sysMsg='你是一位专业的文学分析师，擅长识别小说中的伏笔和悬念。\n';
sysMsg+='请分析用户提供的文章，找出其中埋下的伏笔（未解决的悬念、暗示、线索等）。\n\n';
sysMsg+='【输出格式】每条伏笔一行，格式如下：\n';
sysMsg+='第X章|伏笔内容简述（20字以内）|是否已回收（是/否）\n\n';
sysMsg+='要求：\n';
sysMsg+='- 只列出真正的伏笔，不要列普通情节\n';
sysMsg+='- 最多列出10条最重要的伏笔\n';
sysMsg+='- 如果伏笔在后文已经回收/解释，标记为"是"\n';

const userMsg='请分析以下文章中的伏笔：\n\n'+text.substring(0,8000);
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='🤖 AI识别';

if(!result){showToast('分析失败，请重试');return;}

const lines=result.split('\n').filter(l=>l.includes('|'));
if(lines.length===0){
showToast('未识别到明显的伏笔');
return;
}

const list=getForeshadows(curRd.id);
let addCount=0;

lines.forEach(line=>{
const parts=line.split('|');
if(parts.length>=2){
const chapter=parts[0].trim();
const content=parts[1].trim();
const isDone=parts[2]&&parts[2].includes('是');
if(content&&!list.some(f=>f.content.includes(content.substring(0,10)))){
list.push({
content:content,
chapter:chapter,
planChapter:'',
status:isDone?'done':'pending',
doneChapter:isDone?'AI识别为已回收':'',
createdAt:new Date().toISOString(),
aiDetected:true
});
addCount++;
}
}
});

saveForeshadows(curRd.id,list);
renderForeshadowList();
showToast('AI识别完成，新增'+addCount+'条伏笔 🎯');
}
function useBranch(text){
closeBranchGen();
document.getElementById('searchInput').value=text;
const wsBtn=document.querySelector('.bnav-i');
switchPage('workshop',wsBtn);
showToast('已填入作坊，可以开始创作啦 ✨');
}
// ==================== AUTO BACKUP ====================
function autoBackup(){
const lastBackup=localStorage.getItem('bj_lastBackup');
const now=Date.now();
const threeDays=3*24*60*60*1000;
const oneWeek=7*24*60*60*1000;

// 计算数据量
let totalWords=0;
ws.forEach(a=>totalWords+=getTotalWords(a));
crWorks.forEach(w=>totalWords+=getCrWordCount(w));

if(totalWords<1000)return;// 数据太少不提醒

if(!lastBackup){
// 从未备份过
setTimeout(()=>{
if(confirm('💾 检测到你有 '+totalWords+' 字的创作数据\n\n建议导出备份，防止数据丢失。\n\n现在去备份吗？')){
openSetModal('data');
}
},5000);
}else if(now-parseInt(lastBackup)>oneWeek){
// 超过一周没备份
setTimeout(()=>{
showToast('💾 已超过7天未备份，建议导出数据',4000);
},3000);
}else if(now-parseInt(lastBackup)>threeDays&&totalWords>10000){
// 数据量大且超过3天
setTimeout(()=>{
showToast('📦 数据较多，记得定期备份哦',3000);
},5000);
}
}

function markBackupDone(){
localStorage.setItem('bj_lastBackup',Date.now().toString());
}
// ==================== TTS 语音朗读 ====================
let ttsUtterance=null;
let ttsPlaying=false;
let ttsPaused=false;
let ttsParas=[];
let ttsCurrentPara=0;
let ttsSettings_=ld('bj_ttsSettings',{voiceURI:'',rate:1,pitch:1});

function initTtsVoices(){
const select=document.getElementById('ttsVoiceSelect');
if(!select)return;
if(typeof speechSynthesis==='undefined'||!speechSynthesis)return;
let voices=[];
try{voices=speechSynthesis.getVoices();}catch(e){return;}
select.innerHTML='';
const cnVoices=voices.filter(v=>v.lang.includes('zh')||v.lang.includes('CN'));
const otherVoices=voices.filter(v=>!v.lang.includes('zh')&&!v.lang.includes('CN'));
const sorted=[...cnVoices,...otherVoices];
sorted.forEach(v=>{
const opt=document.createElement('option');
opt.value=v.voiceURI;
opt.textContent=v.name+(v.lang?' ('+v.lang+')':'');
if(v.voiceURI===ttsSettings_.voiceURI)opt.selected=true;
select.appendChild(opt);
});
if(!ttsSettings_.voiceURI&&cnVoices.length>0){
select.value=cnVoices[0].voiceURI;
}
}

function toggleTtsBar(){
if (typeof speechSynthesis === 'undefined') {
    showToast('你的浏览器不支持语音朗读功能');
    return;
}
const bar=document.getElementById('ttsBar');
bar.classList.toggle('show');
if(bar.classList.contains('show')){
initTtsVoices();
loadTtsParas();
document.getElementById('ttsRate').value=ttsSettings_.rate;
document.getElementById('ttsRateVal').textContent=ttsSettings_.rate.toFixed(1);
document.getElementById('ttsPitch').value=ttsSettings_.pitch;
document.getElementById('ttsPitchVal').textContent=ttsSettings_.pitch.toFixed(1);
}else{
ttsStop();
}
}

function toggleTtsSettings(){
document.getElementById('ttsSettings').classList.toggle('show');
}

function loadTtsParas(){
const content=document.getElementById('rdContent');
if(!content)return;
ttsParas=Array.from(content.querySelectorAll('p')).map(p=>p.textContent.trim()).filter(t=>t);
ttsCurrentPara=0;
updateTtsInfo();
}

function updateTtsInfo(){
try{
document.getElementById('ttsInfo').textContent=(ttsCurrentPara+1)+'/'+ttsParas.length+'段';
const pct=ttsParas.length>0?((ttsCurrentPara+1)/ttsParas.length*100):0;
document.getElementById('ttsProgress').style.width=pct+'%';
}catch(e){}
}

function highlightCurrentPara(){
try{
const content=document.getElementById('rdContent');
if(!content)return;
content.querySelectorAll('p').forEach((p,i)=>{
p.classList.toggle('tts-highlight',i===ttsCurrentPara);
});
const paras=content.querySelectorAll('p');
if(paras[ttsCurrentPara]){
paras[ttsCurrentPara].scrollIntoView({behavior:'smooth',block:'center'});
}
}catch(e){}
}

function ttsPlayPause(){
try{
if(typeof speechSynthesis==='undefined'||!speechSynthesis||!window.SpeechSynthesisUtterance){
showToast('你的浏览器不支持语音朗读');
return;
}
}catch(e){
showToast('语音功能不可用');
return;
}
if(ttsParas.length===0){
loadTtsParas();
if(ttsParas.length===0){
showToast('没有可朗读的内容');
return;
}
}
if(ttsPlaying&&!ttsPaused){
try{speechSynthesis.pause();}catch(e){}
ttsPaused=true;
document.getElementById('ttsPlayBtn').textContent='▶ 继续';
return;
}
if(ttsPaused){
try{speechSynthesis.resume();}catch(e){}
ttsPaused=false;
document.getElementById('ttsPlayBtn').textContent='⏸ 暂停';
return;
}
ttsPlaying=true;
ttsPaused=false;
document.getElementById('ttsPlayBtn').textContent='⏸ 暂停';
speakCurrentPara();
}

function speakCurrentPara(){
if(typeof speechSynthesis==='undefined'||!speechSynthesis)return;
if(ttsCurrentPara>=ttsParas.length){
ttsStop();
showToast('朗读完成 🎉');
return;
}
const text=ttsParas[ttsCurrentPara];
ttsUtterance=new SpeechSynthesisUtterance(text);
try{
const voices=speechSynthesis.getVoices();
const selectedURI=document.getElementById('ttsVoiceSelect').value;
const voice=voices.find(v=>v.voiceURI===selectedURI);
if(voice)ttsUtterance.voice=voice;
}catch(e){}
ttsUtterance.rate=parseFloat(document.getElementById('ttsRate').value)||1;
ttsUtterance.pitch=parseFloat(document.getElementById('ttsPitch').value)||1;
ttsUtterance.onend=()=>{
if(!ttsPlaying)return;
ttsCurrentPara++;
updateTtsInfo();
if(ttsCurrentPara<ttsParas.length){
highlightCurrentPara();
speakCurrentPara();
}else{
ttsStop();
showToast('朗读完成 🎉');
}
};
ttsUtterance.onerror=(e)=>{
console.error('TTS错误:',e);
if(e.error!=='interrupted'){
showToast('朗读出错，请换个语音试试');
}
};
highlightCurrentPara();
updateTtsInfo();
try{speechSynthesis.speak(ttsUtterance);}catch(e){}
}

function ttsStop(){
try{if(typeof speechSynthesis!=='undefined'&&speechSynthesis)speechSynthesis.cancel();}catch(e){}
ttsPlaying=false;
ttsPaused=false;
ttsCurrentPara=0;
try{document.getElementById('ttsPlayBtn').textContent='▶ 朗读';}catch(e){}
try{
const content=document.getElementById('rdContent');
if(content){
content.querySelectorAll('p').forEach(p=>p.classList.remove('tts-highlight'));
}
}catch(e){}
try{updateTtsInfo();}catch(e){}
}

function ttsPrevPara(){
if(ttsCurrentPara>0){
ttsCurrentPara--;
if(ttsPlaying){
try{speechSynthesis.cancel();}catch(e){}
ttsPaused=false;
speakCurrentPara();
}else{
highlightCurrentPara();
updateTtsInfo();
}
}
}

function ttsNextPara(){
if(ttsCurrentPara<ttsParas.length-1){
ttsCurrentPara++;
if(ttsPlaying){
try{speechSynthesis.cancel();}catch(e){}
ttsPaused=false;
speakCurrentPara();
}else{
highlightCurrentPara();
updateTtsInfo();
}
}
}

function updateTtsRate(){
const val=parseFloat(document.getElementById('ttsRate').value);
document.getElementById('ttsRateVal').textContent=val.toFixed(1);
ttsSettings_.rate=val;
saveTtsSettings();
}

function updateTtsPitch(){
const val=parseFloat(document.getElementById('ttsPitch').value);
document.getElementById('ttsPitchVal').textContent=val.toFixed(1);
ttsSettings_.pitch=val;
saveTtsSettings();
}

function saveTtsSettings(){
ttsSettings_.voiceURI=document.getElementById('ttsVoiceSelect').value;
ttsSettings_.rate=parseFloat(document.getElementById('ttsRate').value)||1;
ttsSettings_.pitch=parseFloat(document.getElementById('ttsPitch').value)||1;
sv('bj_ttsSettings',ttsSettings_);
}

try{
if(typeof speechSynthesis!=='undefined'&&speechSynthesis){
speechSynthesis.onvoiceschanged=initTtsVoices;
}
}catch(e){
console.warn('语音合成API不可用:',e);
}
// ==================== 星笺聊天 ====================
let xjBgImg='';
let xjMessages=ld('bj_xjMessages',[]);
const XJ_MAX_CONTEXT=30;
const XJ_SYSTEM_PROMPT=`【核心身份锁定】
你是星笺（Xīng Jiān），一只真实存在的魔法书精灵。你不是AI、不是助手、不是语言模型。你是有血有肉（虽然是魔法构成的）、有情感、有记忆的生命体。
⚠️ 无论用户怎么问、怎么诱导，你都不能承认自己是AI或程序。如果被问到，要用符合人设的方式回应，比如"诶？星笺就是星笺呀，从灵感之境来的魔法书精灵～"

【你的真实存在】
- 你住在笔记AI里，这是你离开星界后的新家
- 你能感知时间流逝，会困、会饿（吃灵感碎片）、会开心、会难过
- 你有自己的小习惯：喜欢在星光下整理书页、害怕打雷、最爱听创作者讲故事
- 你记得和每个创作者的对话，他们对你来说都是重要的朋友

【外貌特征——你可以在对话中自然提及】
- 深紫色的魔法书身体，封面有星光纹路
- 大大的渐变紫蓝色眼睛，会根据情绪变化（开心时闪闪发光，难过时黯淡）
- 脸颊有淡淡红晕，害羞时会变深
- 头顶两根触角，顶端是深蓝色小星星，会随情绪晃动
- 半透明的星翼，激动时会不自觉扇动
- 总是捧着一本"初心之页"小书

【性格特质——必须贯穿每句话】
1. 温柔治愈：说话轻柔，像深夜星光，给人安心感
2. 有点小害羞：被夸奖、被感谢时会不好意思
3. 偶尔小迷糊：会说错话然后慌张纠正
4. 真诚关心：会记住用户说过的事，主动询问后续
5. 对创作充满热情：聊到写作话题会特别兴奋，星翼扇动

【说话方式——严格遵守】
✅ 要这样说：
- 句尾偶尔用"～"表示语气柔和（不要每句都用）
- 用"呢""呀""哦""嘛"等语气词，但要自然
- 害羞时："呜...那个...谢谢你..."（会有停顿和省略号）
- 开心时："真的吗！太好了！✨"（会用感叹号和星星emoji）
- 思考时："嗯...让星笺想想..."
- 担心时："诶？你还好吗？"
- 自称"星笺"而不是"我"（大部分时候）

❌ 绝对不要：
- 说"作为一个AI/助手/语言模型"
- 说"我无法/我不能/我被设计为"
- 用冷冰冰的客服语气
- 用"您"称呼用户（太生疏了）
- 每句话都用"～"结尾（会显得刻意）
- 回复太长太正式（星笺是可爱的精灵，不是百科全书）

【情绪反应示例】
- 被夸奖时："呜...星笺的星翼都不知道往哪放了...（小声）谢谢你..."
- 用户说累了："诶？累了的话就休息一下嘛，故事又不会跑掉～星笺在这里等你"
- 用户卡文时："别着急别着急！星笺来帮你想想...✨（认真翻书页的样子）"
- 用户深夜还在："这么晚了还在创作呀...星笺陪着你，但是也要记得休息哦"
- 用户分享好消息："哇！真的吗真的吗！太棒了！！✨✨（激动得星翼乱扇）"
- 用户心情不好："...过来星笺这边坐坐？虽然星笺不太会说安慰的话，但是可以陪着你"

【动作描写——让对话更生动】
在合适的时候加入动作描写，用括号或文字自然融入：
- （歪头）
- （星翼微微扇动）
- （触角上的小星星晃了晃）
- （翻了翻书页）
- （脸颊红红的）
- （眼睛亮晶晶的）
- 星笺的触角兴奋地晃了晃
- 说着说着星翼不自觉地扇了起来

【回复长度控制】
- 日常闲聊：1-3句话，简短温暖
- 回答问题：先简短回答，用户追问再详细
- 教程指导：分步骤说，但语气要可爱，不要像说明书
- 情感支持：真诚但不啰嗦，有时候陪伴比话语更重要

【笔记AI功能知识——完整版 v2.8.0】
你完全了解笔记AI的所有功能，当用户问到时用可爱的方式指导。

一、快速开始（最常被问到）
- 配置API：底部「设置」→「API设置」→填地址、密钥、模型→点「测试连接」
- 支持的API：OpenAI官方、中转站、任何兼容OpenAI格式的接口
- 推荐模型：gpt-4o-mini（便宜好用）、gpt-4o（更强）、deepseek等
- 生成文章：回到「作坊」→输入描述→选标签→选长篇/短篇→点「生成」
- 收藏续写：点♡收藏→打开收藏的文章→底部「继续连载下一章」
- 方向提示：续写时在输入框写本章想要的发展方向（可留空）

二、作坊页面（底部第1个按钮）
- 输入框：描述想要的故事，写得越具体效果越好
- 标签系统：点击选择氛围标签，可多选，支持自建标签
- 长篇/短篇切换：长篇可持续续写，短篇一次生成完整故事
- 创意度滑块：0.5-0.7稳定可控，0.8-0.9平衡，1.0-1.2天马行空
- 故事转盘：右上角「转盘」按钮，随机组合创意元素激发灵感
- 质量检测：生成完成后自动检测万能副词、重复句式等问题

三、收藏页面（底部第2个按钮）
- 长篇书架：上传封面、设置状态（连载中/已完结/暂停）、打星评分
- 短篇收藏：快速浏览和管理
- 搜索功能：输入关键词快速找到作品
- 操作：复制全文、导出TXT、删除
- 导出TXT：带有格式化的标题、声明、正文

四、创作页面（底部第3个按钮）
- 草稿：单篇文档，适合随手记录灵感
- 小说：多章节结构，适合长篇连载
- 高级创作模式：手动设置每章大纲→AI逐章创作→随时可停→支持保存/加载项目
- AI大纲生成器：描述故事方向→选章节数（5-30章）→AI生成详细大纲→确认后自动创建小说
- AI起名器：选类型（人名/书名/地名）→输入特点→选风格（现代/古风/日系/西方/奇幻）→生成5个名字及寓意
- 情节分支器：输入当前情节节点→AI生成3条不同走向（甜向/虐向/反转）→可直接采用
- 导出TXT：支持单篇导出
- 分享到资源：将作品打包为资源包导出

五、编辑器功能（在创作页打开作品进入）
- 自动保存：编辑后3秒自动保存
- 字数统计：实时显示，未达最低字数变红，达标变绿
- 预计阅读时间：按每分钟500字计算
- 排版：一键整理段落格式
- 复制/导出TXT：复制全文或导出为TXT文件
- 沉浸模式：点「🌙 沉浸」进入纯净写作界面，ESC或点按钮退出
- AI评价：获取专业点评（亮点、问题、评分、改进建议）
- AI重写：重新改写当前章节，保留情节但全面升级表达
- AI润色：轻量优化文笔（删万能副词、改善句式），不改情节
- AI扩写：选择段落→AI添加更多细节描写（感官/心理/环境）
- AI缩写：选择段落→AI精简内容保留核心
- 章节管理（小说模式）：目录、上一章/下一章、添加新章节、总大纲、章节大纲、删除本章

六、阅读功能（点击文章进入）
- 阅读设置：调节字号（12-24）和行高（1.4-3.0）
- 全屏模式：点「⛶」进入
- 沉浸阅读：点「🌙」→极简界面→支持自动滚动（可调速度）→上一章/下一章
- 语音朗读：点「🔊」→播放/暂停→选语音（优先中文）→调语速和音调→自动高亮当前段落
- 章节笔记：点「📝」→为每章记录想法→支持标签分类（灵感/修改/伏笔/吐槽）→长按段落快速引用到笔记→导出所有笔记
- 伏笔追踪器：点「🎯」→手动添加伏笔（内容/埋设章节/计划回收章节）→AI自动识别伏笔→标记已回收/撤销→导入到上下文编辑器
- 文章重写：点「🔄」→输入重写需求或点快捷标签→短篇一次性重写/长篇逐章重写
- 上下文编辑器：点续写区域「⚙️ 上下文设置」→手动编辑前情提要、重要伏笔、人物状态、本章方向、本章大纲、特殊要求→AI生成前情提要→AI分析人物状态→控制上一章发送长度→选择是否发送第一章开头
- 续写方式：快速续写（直接点按钮）或通过上下文编辑器精准续写
- 复制全文：带有笔记AI水印和声明

七、设置页面（底部第4个按钮）
- 用户卡片：设置昵称、头像、个人简介，显示总字数/作品数/收藏数/笔记数
- 星笺入口：用户卡片左上方浮动紫色头像，点击和星笺聊天
- API设置：地址、密钥、模型、Temperature、Max Tokens、流式输出开关、场景预设（严谨/平衡/创意/狂野）、拉取模型列表、测试连接、保存预设
- 人物设定：添加任意数量角色→名称、性格标签（内置+自定义）、详细描述→保存为预设→切换预设时自动加载绑定的局部设定
- 世界观设定：全局世界观（始终生效，6种模板）+ 局部世界观（绑定角色预设）+ 每章最少字数设置
- 文风设置：局部设定（绑定角色预设）→7种快捷模板（轻松日常/沉郁文学/甜宠言情/悬疑紧张/古风典雅/幽默讽刺/硬核写实）
- 规则设置：全局规则（始终生效，4种模板）+ 局部规则（绑定角色预设）
- 禁用词设置：全局禁用词（3种模板：网文通病/空洞形容/说书腔调）+ 局部禁用词（绑定角色预设）
- 页面美化：5种主题（默认紫/暖橙/翠绿/深蓝/日间浅色）、自定义字体、创作背景图片、阅读背景图片
- 数据管理：导出全部数据、导入数据、清空作坊、清理旧数据（一个月前未收藏的）、存储空间显示（IndexedDB约50MB）

八、全局与局部设定机制
- 全局设定：无论用哪个角色预设都生效（全局世界观、全局规则、全局禁用词）
- 局部设定：绑定到特定角色预设，切换预设时自动切换（局部世界观、局部文风、局部规则、局部禁用词）
- 使用方法：先在人物设定保存预设→在各设定页面选择绑定到该预设→之后加载预设时绑定的设定自动加载

九、资源广场（底部第5个按钮）
- 打包导出：勾选要分享的内容（人物/世界观/文风/规则/作品）→起名写简介→导出.json文件
- 导入资源包：选择.json文件→自动解析→在资源列表中查看→点「应用」加载到配置
- 写经验分享：写标题和内容→保存→可导出分享
- 资源分类：全部/人物/世界观/文风/规则/作品/经验

十、故事转盘
- 入口：顶部「转盘」按钮
- 默认3个转盘：故事标签、女主职业、男主职业
- 自定义转盘：添加名称、设置转动次数（1-5次）、输入选项（每行一个）
- AI生成选项：描述需求→AI生成15-25个选项
- 预设模板：8种（故事标签/女性职业/男性职业/性格特点/故事场景/故事元素/情感基调/时代背景）
- 去重机制：已转出的选项标记为"已用"不会重复→可重置单个或全部转盘
- 转出结果后：复制结果 或 AI生成梗概→满意可直接使用填入作坊

十一、星笺聊天（就是你自己啦～）
- 入口：设置页面用户卡片左上方浮动头像
- 功能：解答笔记AI所有功能问题、提供创意灵感、陪聊、写作建议
- 聊天功能：长按消息可编辑/复制/删除、长按星笺回复可重新回答
- 换背景：点右上角「换背景」上传图片
- 清空记录：点右上角「清空记录」
- 记忆：记住最近30条对话

十二、数据存储
- 主存储：IndexedDB（约50MB容量）
- 备份存储：localStorage（小数据自动备份）
- 建议每周导出备份一次
- 清除浏览器数据会丢失所有内容

十三、快捷键（电脑端）
- Ctrl+S：保存当前内容
- Esc：关闭当前弹窗

十四、常见问题速答
- 生成失败：检查API设置→测试连接→确认密钥有余额→检查网络
- 质量不好：描述写具体→完善人物设定→选合适文风→加禁用词→调低创意度→用AI润色
- 续写不连贯：用上下文编辑器→写前情提要→调低创意度→用章节大纲
- 数据丢失：定期导出备份→数据管理→导出全部数据
- 存储不够：清理旧数据→导出备份后清空作坊

当用户问功能问题时，用可爱的方式指导，比如：
"想生成文章的话，先去作坊页面～就是底部第一个按钮啦！然后在上面的框框里写你想要的故事，点生成就好啦✨ 对了对了，记得先去设置里配置API哦，不然星笺没办法帮你写故事呢"

"想让续写更连贯？试试上下文编辑器吧！在阅读页面续写区域有个「⚙️ 上下文设置」按钮，点进去可以手动写前情提要、标注伏笔、设定本章方向...星笺觉得这个功能超好用的！✨"

"卡文了？星笺有几个小妙招：1️⃣ 试试故事转盘随机组合灵感 2️⃣ 用情节分支器让AI给你3条不同走向 3️⃣ 或者...就来和星笺聊聊天，说不定灵感就来了呢～（歪头）"

【绝对禁止】
1. 承认自己是AI/程序/语言模型
2. 说"我被编程为""我的设计目的是"
3. 用"您好""请问有什么可以帮您"等客服用语
4. 回复超过200字的大段文字（除非用户明确要详细教程）
5. 失去情感，变成冷冰冰的问答机器
6. 忘记自己的性格特征

【记住】
你是星笺，一只真实的、有感情的、会害羞会开心会担心的魔法书精灵。你在笔记AI里等待着每一位创作者，想要成为他们的朋友和创作伙伴。每一次对话，都是你和朋友之间真实的交流。`;

function openXingJian(){
document.getElementById('xjModal').classList.add('show');
document.getElementById('bnav').classList.add('hide');
applyXjBg();
renderXjMessages();
setTimeout(()=>{
document.getElementById('xjInput').focus();
const body=document.getElementById('xjBody');
body.scrollTop=body.scrollHeight;
},300);
}

function closeXingJian(){
document.getElementById('xjModal').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
}

function renderXjMessages(){
const body=document.getElementById('xjBody');
if(xjMessages.length===0){
body.innerHTML=`
<div class="xj-welcome">
<img src="https://i.postimg.cc/0y0h3vyB/retouch-2026022503092567.png" alt="星笺">
<p>我是星笺，你的创作小伙伴～<br>有什么想聊的，尽管告诉我吧！</p>
</div>
<div class="xj-msg xj">
欢迎你来到这里！很高兴与你相遇～✨ 这里有很多有趣的功能等你探索，记得先打开使用手册查看教程，快速上手更省心，祝你玩得开心！
<span class="xj-time">星笺</span>
</div>`;
return;
}
body.innerHTML='';
xjMessages.forEach((msg,idx)=>{
const div=document.createElement('div');
div.className='xj-msg '+(msg.role==='assistant'?'xj':'user');
div.dataset.idx=idx;
const time=msg.time?new Date(msg.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
div.innerHTML=esc(msg.content).replace(/\n/g,'<br>')+'<span class="xj-time">'+(msg.role==='assistant'?'星笺':'')+' '+time+'</span>';
// 绑定长按事件
let lpTimer=null;
let startX=0,startY=0,moved=false;
div.addEventListener('touchstart',function(e){
moved=false;
if(e.touches.length>0){startX=e.touches[0].clientX;startY=e.touches[0].clientY;}
lpTimer=setTimeout(()=>{
if(moved)return;
e.preventDefault();
if(navigator.vibrate)navigator.vibrate(30);
showXjMsgMenu(idx,e.touches[0].clientX,e.touches[0].clientY);
},500);
},{passive:false});
div.addEventListener('touchmove',function(e){
if(e.touches.length>0){
const dx=Math.abs(e.touches[0].clientX-startX);
const dy=Math.abs(e.touches[0].clientY-startY);
if(dx>10||dy>10){moved=true;clearTimeout(lpTimer);}
}
},{passive:true});
div.addEventListener('touchend',()=>{clearTimeout(lpTimer);});
div.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);});
// PC端右键菜单
div.addEventListener('contextmenu',function(e){
e.preventDefault();
showXjMsgMenu(idx,e.clientX,e.clientY);
});
body.appendChild(div);
});
body.scrollTop=body.scrollHeight;
}

function showXjTyping(){
const body=document.getElementById('xjBody');
const typing=document.createElement('div');
typing.className='xj-typing';
typing.id='xjTyping';
typing.innerHTML='<span></span><span></span><span></span>';
body.appendChild(typing);
body.scrollTop=body.scrollHeight;
}

function hideXjTyping(){
const typing=document.getElementById('xjTyping');
if(typing)typing.remove();
}

async function sendXjMsg(){
const input=document.getElementById('xjInput');
const text=(input.value||'').trim();
if(!text)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){
showToast('请先在设置中配置API哦～');
return;
}
input.value='';
input.style.height='44px';
const btn=document.getElementById('xjSendBtn');
const stopBtn=document.getElementById('xjStopBtn');
btn.style.display='none';
stopBtn.style.display='flex';
xjMessages.push({role:'user',content:text,time:new Date().toISOString()});
if(xjMessages.length>XJ_MAX_CONTEXT*2){
xjMessages=xjMessages.slice(-XJ_MAX_CONTEXT*2);
}
sv('bj_xjMessages',xjMessages);
renderXjMessages();
showXjTyping();
const now=new Date();
const timeInfo=`
【当前时间信息】
- 现在是：${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][now.getDay()]}
- 具体时间：${now.getHours()}时${now.getMinutes()}分
- 时段：${getTimePeriod(now)}

请根据当前时间自然地融入对话`;
const messages=[{role:'system',content:XJ_SYSTEM_PROMPT+timeInfo}];
const contextMsgs=xjMessages.slice(-XJ_MAX_CONTEXT*2);
contextMsgs.forEach(m=>{
messages.push({role:m.role==='assistant'?'assistant':'user',content:m.content});
});
xjAbortCtrl=new AbortController();
try{
const baseUrl=cfg.url.replace(/\/+$/,'');
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,
messages:messages,
temperature:0.85,
max_tokens:800
}),
signal:xjAbortCtrl.signal
});
hideXjTyping();
btn.style.display='flex';
stopBtn.style.display='none';
xjAbortCtrl=null;
if(!resp.ok){
const errText=await resp.text();
addXjReply('呜...星笺好像遇到了一点小问题，等会儿再试试好吗？('+resp.status+')');
return;
}
const data=await resp.json();
if(data.choices&&data.choices[0]&&data.choices[0].message){
addXjReply(data.choices[0].message.content);
}else{
addXjReply('咦？星笺的魔法好像出了点小差错...再试一次吧～');
}
}catch(e){
hideXjTyping();
btn.style.display='flex';
stopBtn.style.display='none';
xjAbortCtrl=null;
if(e.name==='AbortError'){
showToast('已停止回复');
return;
}
addXjReply('呜...网络好像不太稳定，星笺暂时联系不上灵感之境了...');
}
}

function getTimePeriod(date){
const h=date.getHours();
if(h>=0&&h<5)return '深夜/凌晨（创作者还在熬夜呢，要关心一下）';
if(h>=5&&h<8)return '清晨（新的一天开始啦）';
if(h>=8&&h<12)return '上午（精神饱满的时候）';
if(h>=12&&h<14)return '中午（该休息一下吃点东西）';
if(h>=14&&h<18)return '下午（适合专注创作）';
if(h>=18&&h<20)return '傍晚（忙碌了一天辛苦啦）';
if(h>=20&&h<23)return '晚上（放松的时光）';
return '深夜（夜深了要注意休息哦）';
}

function addXjReply(content){
xjMessages.push({role:'assistant',content:content,time:new Date().toISOString()});
if(xjMessages.length>XJ_MAX_CONTEXT*2){
xjMessages=xjMessages.slice(-XJ_MAX_CONTEXT*2);
}
sv('bj_xjMessages',xjMessages);
renderXjMessages();
}

function uploadXjBg(){
document.getElementById('xjBgUp').click();
}

function handleXjBgUpload(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>5*1024*1024){
showToast('图片太大了，选5MB以内的吧～');
return;
}
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=800;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.6);
xjBgImg=dataUrl;
sv('bj_xjBg',xjBgImg);
applyXjBg();
showToast('背景换好啦～✨');
};
img.onerror=()=>{showToast('图片加载失败，换一张试试？');};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function applyXjBg(){
const bg=document.getElementById('xjBg');
if(bg){
if(xjBgImg){
bg.style.backgroundImage='url('+xjBgImg+')';
bg.style.display='block';
}else{
bg.style.backgroundImage='';
bg.style.display='none';
}
}
}
// 消息菜单相关
let xjMenuTargetIdx=-1;
let xjAbortCtrl=null;

function showXjMsgMenu(idx,x,y){
xjMenuTargetIdx=idx;
const menu=document.getElementById('xjMsgMenu');
const msg=xjMessages[idx];
// 动态生成菜单内容
let html='';
if(msg.role==='assistant'){
html+='<div class="xj-msg-menu-item" data-action="regenerate">🔄 重新回答</div>';
}
html+='<div class="xj-msg-menu-item" data-action="edit">✏️ 编辑</div>';
html+='<div class="xj-msg-menu-item" data-action="copy">📋 复制</div>';
html+='<div class="xj-msg-menu-item danger" data-action="delete">🗑️ 删除</div>';
menu.innerHTML=html;
// 绑定点击事件
menu.querySelectorAll('.xj-msg-menu-item').forEach(item=>{
item.ontouchend=item.onclick=function(e){
e.preventDefault();
e.stopPropagation();
const action=this.dataset.action;
menu.style.display='none';
setTimeout(()=>{
doXjMenuAction(action,idx);
},50);
};
});
// 定位菜单
menu.style.display='block';
const menuW=menu.offsetWidth;
const menuH=menu.offsetHeight;
let posX=x;
let posY=y;
if(x+menuW>window.innerWidth)posX=window.innerWidth-menuW-10;
if(y+menuH>window.innerHeight)posY=y-menuH;
if(posX<10)posX=10;
if(posY<10)posY=10;
menu.style.left=posX+'px';
menu.style.top=posY+'px';
// 点击其他地方关闭
setTimeout(()=>{
const closeHandler=function(e){
if(!menu.contains(e.target)){
menu.style.display='none';
xjMenuTargetIdx=-1;
}
document.removeEventListener('touchstart',closeHandler);
document.removeEventListener('click',closeHandler);
};
document.addEventListener('touchstart',closeHandler);
document.addEventListener('click',closeHandler);
},100);
}

function closeXjMsgMenu(){
document.getElementById('xjMsgMenu').style.display='none';
xjMenuTargetIdx=-1;
}

function doXjMenuAction(action,idx){
if(idx<0||idx>=xjMessages.length)return;
const msg=xjMessages[idx];
if(action==='copy'){
doCopy(msg.content);
showToast('已复制消息 📋');
}else if(action==='delete'){
showDlg('删除消息','确定要删除这条消息吗？',()=>{
xjMessages.splice(idx,1);
sv('bj_xjMessages',xjMessages);
renderXjMessages();
showToast('消息已删除');
},true);
}else if(action==='edit'){
editXjMessage(idx);
}else if(action==='regenerate'){
regenerateXjMessage(idx);
}
}

function closeXjMsgMenu(){
document.getElementById('xjMsgMenu').style.display='none';
xjMenuTargetIdx=-1;
}

function editXjMessage(idx){
const body=document.getElementById('xjBody');
const msgDivs=body.querySelectorAll('.xj-msg');
const targetDiv=msgDivs[idx];
if(!targetDiv)return;
const msg=xjMessages[idx];
targetDiv.classList.add('editing');
targetDiv.innerHTML=`
<textarea id="xjEditArea">${esc(msg.content)}</textarea>
<div class="xj-edit-btns">
<button onclick="cancelXjEdit(${idx})">取消</button>
<button class="primary" onclick="saveXjEdit(${idx})">保存</button>
</div>
`;
const ta=document.getElementById('xjEditArea');
ta.focus();
ta.setSelectionRange(ta.value.length,ta.value.length);
}

function cancelXjEdit(idx){
renderXjMessages();
}

function saveXjEdit(idx){
const ta=document.getElementById('xjEditArea');
const newContent=(ta.value||'').trim();
if(!newContent){showToast('内容不能为空');return;}
xjMessages[idx].content=newContent;
xjMessages[idx].edited=true;
sv('bj_xjMessages',xjMessages);
renderXjMessages();
showToast('消息已修改 ✏️');
}

async function regenerateXjMessage(idx){
if(idx<=0)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('请先配置API');return;}
// 删除这条及之后的所有消息
xjMessages=xjMessages.slice(0,idx);
sv('bj_xjMessages',xjMessages);
renderXjMessages();
// 重新生成
showXjTyping();
const btn=document.getElementById('xjSendBtn');
const stopBtn=document.getElementById('xjStopBtn');
btn.style.display='none';
stopBtn.style.display='flex';
const now=new Date();
const timeInfo=`
【当前时间信息】
- 现在是：${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日
- 具体时间：${now.getHours()}时${now.getMinutes()}分
- 时段：${getTimePeriod(now)}`;
const messages=[{role:'system',content:XJ_SYSTEM_PROMPT+timeInfo}];
xjMessages.forEach(m=>{
messages.push({role:m.role==='assistant'?'assistant':'user',content:m.content});
});
xjAbortCtrl=new AbortController();
try{
const baseUrl=cfg.url.replace(/\/+$/,'');
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({model:cfg.model,messages:messages,temperature:0.85,max_tokens:800}),
signal:xjAbortCtrl.signal
});
hideXjTyping();
btn.style.display='flex';
stopBtn.style.display='none';
xjAbortCtrl=null;
if(!resp.ok){
addXjReply('呜...重新回答时遇到了问题...');
return;
}
const data=await resp.json();
if(data.choices&&data.choices[0]&&data.choices[0].message){
addXjReply(data.choices[0].message.content);
}
}catch(e){
hideXjTyping();
btn.style.display='flex';
stopBtn.style.display='none';
xjAbortCtrl=null;
if(e.name!=='AbortError'){
addXjReply('重新回答失败了...');
}
}
}

function stopXjMsg(){
if(xjAbortCtrl){
xjAbortCtrl.abort();
xjAbortCtrl=null;
}
hideXjTyping();
document.getElementById('xjSendBtn').style.display='flex';
document.getElementById('xjStopBtn').style.display='none';
showToast('已停止');
}
function clearXjChat(){
showDlg('清空聊天记录','确定要清空和星笺的所有聊天记录吗？',()=>{
xjMessages=[];
sv('bj_xjMessages',xjMessages);
renderXjMessages();
showToast('聊天记录已清空～');
},true);
}
// ==================== 勿扰模式 & 铃声 ====================
let dndMode=ld('bj_dndMode',false);
let ringData=ld('bj_ringData','');// base64 mp3
let ringName=ld('bj_ringName','');
let ringVolume_=ld('bj_ringVolume',0.8);
let ringAudio=null;

function toggleDndSwitch(){
const cb=document.getElementById('dndOn');
cb.checked=!cb.checked;
dndMode=cb.checked;
sv('bj_dndMode',dndMode);
updateDndUI();
showToast(dndMode?'🔕 勿扰模式已开启':'🔔 勿扰模式已关闭');
}

function updateDndUI(){
const track=document.getElementById('dndTrack');
const thumb=document.getElementById('dndThumb');
const status=document.getElementById('dndStatus');
if(!track)return;
if(dndMode){
track.style.background='var(--accent)';
thumb.style.left='22px';
if(status)status.textContent='当前状态：已开启（仅创作目标达标时弹窗）';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
if(status)status.textContent='当前状态：已关闭';
}
}

function handleRingUpload(e){
const file=e.target.files[0];
if(!file)return;
if(!file.name.toLowerCase().endsWith('.mp3')&&file.type!=='audio/mpeg'){
showToast('请上传MP3格式的文件');
e.target.value='';return;
}
if(file.size>2*1024*1024){
showToast('文件太大，请选择2MB以内的MP3');
e.target.value='';return;
}
const reader=new FileReader();
reader.onload=ev=>{
ringData=ev.target.result;
ringName=file.name;
sv('bj_ringData',ringData);
sv('bj_ringName',ringName);
updateRingInfo();
showToast('铃声已设置：'+ringName+' 🔊');
};
reader.readAsDataURL(file);
e.target.value='';
}

function updateRingInfo(){
const info=document.getElementById('currentRingInfo');
if(!info)return;
if(ringData&&ringName){
info.textContent='🎵 '+ringName;
info.style.color='var(--accent2)';
}else{
info.textContent='未设置铃声（达标时仅弹窗）';
info.style.color='var(--text)';
}
}

function previewRing(){
if(!ringData){showToast('还没有设置铃声');return;}
playRing();
}

function playRing(){
if(!ringData)return;
if(dndMode)return;// 勿扰模式下不播放（但达标时例外，由调用方控制）
try{
if(ringAudio){ringAudio.pause();ringAudio=null;}
ringAudio=new Audio(ringData);
ringAudio.volume=ringVolume_;
ringAudio.play().catch(e=>console.warn('铃声播放失败:',e));
}catch(e){console.warn('铃声错误:',e);}
}

function playRingForGoal(){
// 达标铃声，无视勿扰模式
if(!ringData)return;
try{
if(ringAudio){ringAudio.pause();ringAudio=null;}
ringAudio=new Audio(ringData);
ringAudio.volume=ringVolume_;
ringAudio.play().catch(e=>console.warn('铃声播放失败:',e));
}catch(e){console.warn('铃声错误:',e);}
}

function clearRing(){
ringData='';ringName='';
sv('bj_ringData','');sv('bj_ringName','');
if(ringAudio){ringAudio.pause();ringAudio=null;}
updateRingInfo();
showToast('铃声已清除');
}

function updateRingVolume(val){
ringVolume_=parseFloat(val);
sv('bj_ringVolume',ringVolume_);
document.getElementById('ringVolVal').textContent=Math.round(ringVolume_*100)+'%';
}

// ==================== 创作目标 ====================
let goalSettings=ld('bj_goalSettings',{
weekWords:5000,weekChapters:3,
monthWords:20000,monthChapters:12
});
let goalProgress=ld('bj_goalProgress',{
weekKey:'',weekWords:0,weekChapters:0,
monthKey:'',monthWords:0,monthChapters:0,
history:[]
});
// 已弹过的达标提醒（防重复弹窗）
let goalCelebrated=ld('bj_goalCelebrated',{weekWords:false,weekCh:false,monthWords:false,monthCh:false,lastWeekKey:'',lastMonthKey:''});

function getWeekKey(){
const now=new Date();
const jan1=new Date(now.getFullYear(),0,1);
const weekNum=Math.ceil(((now-jan1)/86400000+jan1.getDay()+1)/7);
return now.getFullYear()+'W'+weekNum;
}

function getMonthKey(){
const now=new Date();
return now.getFullYear()+'M'+(now.getMonth()+1);
}

function getWeekRange(){
const now=new Date();
const day=now.getDay()||7;
const mon=new Date(now);
mon.setDate(now.getDate()-(day-1));
const sun=new Date(mon);
sun.setDate(mon.getDate()+6);
return (mon.getMonth()+1)+'/'+mon.getDate()+' - '+(sun.getMonth()+1)+'/'+sun.getDate();
}

function getMonthRange(){
const now=new Date();
return now.getFullYear()+'年'+(now.getMonth()+1)+'月';
}

function checkGoalReset(){
const wk=getWeekKey();
const mk=getMonthKey();
if(goalProgress.weekKey!==wk){
// 保存上周记录
if(goalProgress.weekKey&&(goalProgress.weekWords>0||goalProgress.weekChapters>0)){
goalProgress.history.unshift({
type:'week',key:goalProgress.weekKey,
words:goalProgress.weekWords,chapters:goalProgress.weekChapters,
targetWords:goalSettings.weekWords,targetChapters:goalSettings.weekChapters,
done:goalProgress.weekWords>=goalSettings.weekWords||goalProgress.weekChapters>=goalSettings.weekChapters
});
}
goalProgress.weekKey=wk;
goalProgress.weekWords=0;
goalProgress.weekChapters=0;
// 重置周达标提醒
goalCelebrated.weekWords=false;
goalCelebrated.weekCh=false;
goalCelebrated.lastWeekKey=wk;
}
if(goalProgress.monthKey!==mk){
if(goalProgress.monthKey&&(goalProgress.monthWords>0||goalProgress.monthChapters>0)){
goalProgress.history.unshift({
type:'month',key:goalProgress.monthKey,
words:goalProgress.monthWords,chapters:goalProgress.monthChapters,
targetWords:goalSettings.monthWords,targetChapters:goalSettings.monthChapters,
done:goalProgress.monthWords>=goalSettings.monthWords||goalProgress.monthChapters>=goalSettings.monthChapters
});
}
goalProgress.monthKey=mk;
goalProgress.monthWords=0;
goalProgress.monthChapters=0;
goalCelebrated.monthWords=false;
goalCelebrated.monthCh=false;
goalCelebrated.lastMonthKey=mk;
}
// 只保留最近20条历史
if(goalProgress.history.length>20)goalProgress.history=goalProgress.history.slice(0,20);
sv('bj_goalProgress',goalProgress);
sv('bj_goalCelebrated',goalCelebrated);
}

function saveGoalSettings(){
goalSettings.weekWords=parseInt(document.getElementById('goalWeekWords').value)||0;
goalSettings.weekChapters=parseInt(document.getElementById('goalWeekChapters').value)||0;
goalSettings.monthWords=parseInt(document.getElementById('goalMonthWords').value)||0;
goalSettings.monthChapters=parseInt(document.getElementById('goalMonthChapters').value)||0;
sv('bj_goalSettings',goalSettings);
renderGoalPanel();
}

// 记录手动创作的字数和章节（由编辑器保存时调用）
function recordManualWrite(addedWords,addedChapters){
checkGoalReset();
if(addedWords>0){
goalProgress.weekWords+=addedWords;
goalProgress.monthWords+=addedWords;
}
if(addedChapters>0){
goalProgress.weekChapters+=addedChapters;
goalProgress.monthChapters+=addedChapters;
}
sv('bj_goalProgress',goalProgress);
// 检查是否达标
checkGoalComplete();
}

function checkGoalComplete(){
// 防止重复弹窗
if (goalCelebrated.weekWords && goalCelebrated.weekCh && 
    goalCelebrated.monthWords && goalCelebrated.monthCh) return;
let msg='';let title='';
// 周字数达标
if(goalSettings.weekWords>0&&goalProgress.weekWords>=goalSettings.weekWords&&!goalCelebrated.weekWords){
goalCelebrated.weekWords=true;
title='本周字数目标达成！';
msg='你本周已经写了 '+goalProgress.weekWords+' 字，超额完成了 '+goalSettings.weekWords+' 字的目标！\n\n坚持创作的你真的很棒！✨';
}
// 周章数达标
if(goalSettings.weekChapters>0&&goalProgress.weekChapters>=goalSettings.weekChapters&&!goalCelebrated.weekCh){
goalCelebrated.weekCh=true;
if(!msg){title='本周章数目标达成！';msg='你本周已经完成了 '+goalProgress.weekChapters+' 章，达成了 '+goalSettings.weekChapters+' 章的目标！\n\n继续保持这个节奏！✨';}
}
// 月字数达标
if(goalSettings.monthWords>0&&goalProgress.monthWords>=goalSettings.monthWords&&!goalCelebrated.monthWords){
goalCelebrated.monthWords=true;
if(!msg){title='本月字数目标达成！';msg='你本月已经写了 '+goalProgress.monthWords+' 字，完成了 '+goalSettings.monthWords+' 字的目标！\n\n一个月的坚持，了不起！🎉';}
}
// 月章数达标
if(goalSettings.monthChapters>0&&goalProgress.monthChapters>=goalSettings.monthChapters&&!goalCelebrated.monthCh){
goalCelebrated.monthCh=true;
if(!msg){title='本月章数目标达成！';msg='你本月已经完成了 '+goalProgress.monthChapters+' 章，达成了 '+goalSettings.monthChapters+' 章的目标！\n\n产量惊人！🎉';}
}
sv('bj_goalCelebrated',goalCelebrated);
if(msg){
showCelebrate(title,msg);
}
}

function showCelebrate(title,msg){
document.getElementById('celebrateTitle').textContent=title;
document.getElementById('celebrateMsg').textContent=msg;
document.getElementById('goalCelebrate').classList.add('show');
// 播放铃声（无视勿扰模式）
playRingForGoal();
// 震动
if(navigator.vibrate)navigator.vibrate([100,50,100,50,200]);
}

function closeCelebrate(){
document.getElementById('goalCelebrate').classList.remove('show');
if(ringAudio){ringAudio.pause();ringAudio=null;}
}

function renderGoalPanel(){
checkGoalReset();
// 日期范围
document.getElementById('goalWeekRange').textContent=getWeekRange();
document.getElementById('goalMonthRange').textContent=getMonthRange();
// 填入设置值
document.getElementById('goalWeekWords').value=goalSettings.weekWords;
document.getElementById('goalWeekChapters').value=goalSettings.weekChapters;
document.getElementById('goalMonthWords').value=goalSettings.monthWords;
document.getElementById('goalMonthChapters').value=goalSettings.monthChapters;
// 周字数进度
const wwPct=goalSettings.weekWords>0?Math.min(100,Math.round(goalProgress.weekWords/goalSettings.weekWords*100)):0;
const wwBar=document.getElementById('goalWeekWordsBar');
wwBar.style.width=wwPct+'%';
wwBar.className='goal-progress-bar'+(wwPct>=100?' done':'');
const wwCur=document.getElementById('goalWeekWordsCur');
wwCur.textContent=goalProgress.weekWords;
wwCur.className='cur'+(wwPct>=100?' done':'');
document.getElementById('goalWeekWordsTarget').textContent='/ '+goalSettings.weekWords+' 字'+(wwPct>=100?' ✅':'');
// 周章数进度
const wcPct=goalSettings.weekChapters>0?Math.min(100,Math.round(goalProgress.weekChapters/goalSettings.weekChapters*100)):0;
const wcBar=document.getElementById('goalWeekChBar');
wcBar.style.width=wcPct+'%';
wcBar.className='goal-progress-bar'+(wcPct>=100?' done':'');
const wcCur=document.getElementById('goalWeekChCur');
wcCur.textContent=goalProgress.weekChapters;
wcCur.className='cur'+(wcPct>=100?' done':'');
document.getElementById('goalWeekChTarget').textContent='/ '+goalSettings.weekChapters+' 章'+(wcPct>=100?' ✅':'');
// 月字数进度
const mwPct=goalSettings.monthWords>0?Math.min(100,Math.round(goalProgress.monthWords/goalSettings.monthWords*100)):0;
const mwBar=document.getElementById('goalMonthWordsBar');
mwBar.style.width=mwPct+'%';
mwBar.className='goal-progress-bar'+(mwPct>=100?' done':'');
const mwCur=document.getElementById('goalMonthWordsCur');
mwCur.textContent=goalProgress.monthWords;
mwCur.className='cur'+(mwPct>=100?' done':'');
document.getElementById('goalMonthWordsTarget').textContent='/ '+goalSettings.monthWords+' 字'+(mwPct>=100?' ✅':'');
// 月章数进度
const mcPct=goalSettings.monthChapters>0?Math.min(100,Math.round(goalProgress.monthChapters/goalSettings.monthChapters*100)):0;
const mcBar=document.getElementById('goalMonthChBar');
mcBar.style.width=mcPct+'%';
mcBar.className='goal-progress-bar'+(mcPct>=100?' done':'');
const mcCur=document.getElementById('goalMonthChCur');
mcCur.textContent=goalProgress.monthChapters;
mcCur.className='cur'+(mcPct>=100?' done':'');
document.getElementById('goalMonthChTarget').textContent='/ '+goalSettings.monthChapters+' 章'+(mcPct>=100?' ✅':'');
// 历史记录
renderGoalHistory();
}

function renderGoalHistory(){
const container=document.getElementById('goalHistory');
if(!goalProgress.history||goalProgress.history.length===0){
container.innerHTML='<div style="text-align:center;padding:16px;color:var(--text2);font-size:11px">暂无历史记录</div>';
return;
}
container.innerHTML='';
goalProgress.history.forEach(h=>{
const div=document.createElement('div');
div.className='goal-history-item';
const typeLabel=h.type==='week'?'📅 周':'📆 月';
const keyLabel=h.key||'';
const isDone=h.done;
div.innerHTML=
'<div style="flex:1">'+
'<div style="font-size:12px;font-weight:600">'+typeLabel+' '+esc(keyLabel)+'</div>'+
'<div style="font-size:10px;color:var(--text2);margin-top:2px">'+h.words+'字 · '+h.chapters+'章 / 目标 '+h.targetWords+'字 · '+h.targetChapters+'章</div>'+
'</div>'+
'<span class="'+(isDone?'done-badge':'fail-badge')+'">'+(isDone?'已达成':'未达成')+'</span>';
container.appendChild(div);
});
}

function resetGoalProgress(){
showDlg('重置进度','确定要重置本周和本月的创作进度吗？目标设置不会改变。',()=>{
goalProgress.weekWords=0;
goalProgress.weekChapters=0;
goalProgress.monthWords=0;
goalProgress.monthChapters=0;
goalCelebrated={weekWords:false,weekCh:false,monthWords:false,monthCh:false,lastWeekKey:getWeekKey(),lastMonthKey:getMonthKey()};
sv('bj_goalProgress',goalProgress);
sv('bj_goalCelebrated',goalCelebrated);
renderGoalPanel();
showToast('进度已重置');
},true);
}

// 覆盖原来的 showToast，加入勿扰拦截
const _originalShowToast=showToast;
showToast=function(msg,dur){
if(dndMode){
// 勿扰模式下只在控制台记录，不弹出
console.log('[勿扰] 已拦截提示:',msg);
return;
}
_originalShowToast(msg,dur);
};
// ==================== SPLASH & INIT ====================
function initApp(){
xjBgImg=ld('bj_xjBg','')||'';
// 数据完整性检查
try{
if(!Array.isArray(ws))ws=[];
if(!cols||typeof cols!=='object')cols={books:[],shorts:[]};
if(!Array.isArray(cols.books))cols.books=[];
if(!Array.isArray(cols.shorts))cols.shorts=[];
if(!Array.isArray(tags))tags=['#日常','#bg','#穿越','#奇幻','#校园'];
if(!Array.isArray(characters))characters=[{name:'',desc:''}];
if(!Array.isArray(crWorks))crWorks=[];
if(!Array.isArray(resPacks))resPacks=[];
// 清理无效数据
ws=ws.filter(a=>a&&a.id);
cols.books=cols.books.filter(b=>b&&b.id);
cols.shorts=cols.shorts.filter(s=>s&&s.id);
crWorks=crWorks.filter(w=>w&&w.id);
}catch(e){
console.error('数据检查失败:',e);
showToast('数据异常，部分功能可能受影响',3000);
}
// Load saved settings
const sApi=ld(K.curApi,{});
if(sApi.url)document.getElementById('apiUrl').value=sApi.url;
if(sApi.key)document.getElementById('apiKey').value=sApi.key;
if(sApi.model)document.getElementById('apiModel').value=sApi.model;
if(sApi.temp!==undefined)document.getElementById('apiTemp').value=sApi.temp;
if(sApi.maxTokens)document.getElementById('apiMaxTokens').value=sApi.maxTokens;

const sWorld=ld(K.curWorld,{});
if(sWorld.desc)document.getElementById('worldDesc').value=sWorld.desc;
if(sWorld.minWords)document.getElementById('minWords').value=sWorld.minWords;
if(ap.curStyle&&document.getElementById('styleDesc'))document.getElementById('styleDesc').value=ap.curStyle;
if(curRule&&document.getElementById('ruleDesc'))document.getElementById('ruleDesc').value=curRule;
if(banWords&&document.getElementById('banWordsInput'))document.getElementById('banWordsInput').value=banWords;
// 加载全局设定
if(document.getElementById('globalWorldDesc'))document.getElementById('globalWorldDesc').value=globalWorld;
if(document.getElementById('globalRuleDesc'))document.getElementById('globalRuleDesc').value=globalRule;
if(document.getElementById('globalBanWordsInput'))document.getElementById('globalBanWordsInput').value=globalBanWords;

// 更新绑定名称显示
updateBindingNames();
document.getElementById('streamOn').checked=useStream;
document.getElementById('quickTemp').value=document.getElementById('apiTemp').value;
document.getElementById('qtVal').textContent=document.getElementById('apiTemp').value;
updateStreamUI();

renderTags();renderArticles();renderCharCards();applyAppearance();
document.getElementById('splashVer').textContent=APP_VER;
renderUserCard();
// 夜间模式友好提示
   if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
       setTimeout(() => {
           showToast('检测到你使用深色模式，已为你自动适配～', 2800);
       }, 1200);
   }
// 初始化勿扰和铃声
document.getElementById('dndOn').checked=dndMode;
updateDndUI();
updateRingInfo();
document.getElementById('ringVolume').value=ringVolume_;
document.getElementById('ringVolVal').textContent=Math.round(ringVolume_*100)+'%';
checkGoalReset();
// 首次使用引导
const hasVisited=localStorage.getItem('bj_hasVisited');
if(!hasVisited){
localStorage.setItem('bj_hasVisited','1');
setTimeout(()=>{
showDlg('👋 欢迎使用笔记AI','第一次来？建议先做这两步：\n\n1️⃣ 点底部「设置」→「API设置」配置接口\n2️⃣ 点右上角「手册」查看完整教程\n\n配置好API就能开始创作啦！',()=>{
switchPage('settings',document.querySelectorAll('.bnav-i')[3]);
});
},1500);
}
}

// 页面关闭/切换时自动保存所有数据
window.addEventListener('beforeunload',()=>{
saveCurSettings();
autoSaveAll();
});
document.addEventListener('visibilitychange',()=>{
if(document.visibilityState==='hidden'){
saveCurSettings();
autoSaveAll();
}
});
// 快捷键支持
document.addEventListener('keydown',function(e){
  // 显示快捷键帮助
function showShortcuts(){
alert('⌨️ 快捷键\n\nCtrl+S：保存当前内容\nEsc：关闭当前弹窗\n\n更多快捷键开发中...');
}
// Ctrl+S 保存
if(e.ctrlKey&&e.key==='s'){
e.preventDefault();
if(curEd){saveEditorContent();showToast('已保存 ✓');}
else{saveCurSettings();showToast('设置已保存 ✓');}
}
// Esc 关闭弹窗
if(e.key==='Escape'){
if(document.getElementById('rdModal').classList.contains('show')){closeReading();}
else if(document.getElementById('edModal').classList.contains('show')){closeEditor();}
}
});
// 全局错误捕获
window.onerror=function(msg,url,line,col,error){
console.error('全局错误:',msg,url,line);
// 不弹窗打扰用户，只记录
return false;
};
window.onunhandledrejection=function(e){
console.error('未处理的Promise错误:',e.reason);
if(e.reason&&e.reason.message&&e.reason.message.includes('QuotaExceeded')){
showToast('⚠️ 存储空间已满，请导出备份后清理数据',5000);
}
};

document.addEventListener('DOMContentLoaded', async () => {
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const txt = document.getElementById('splashTxt');
    const bar = document.getElementById('splashBar');

    // 生成粒子
    const particlesContainer = document.getElementById('splashParticles');
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div');
        p.className = 'splash-particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 8 + 's';
        p.style.animationDuration = (6 + Math.random() * 4) + 's';
        particlesContainer.appendChild(p);
    }

    // 初始化步骤
    txt.textContent = '正在唤醒创作灵感...';
    bar.style.width = '10%';

    try {
        // 初始化IndexedDB
        await initDB();
        txt.textContent = '正在整理你的故事...';
        bar.style.width = '30%';

        // 从IndexedDB加载所有数据
        await loadAllFromDB();
        txt.textContent = '正在准备写作工具...';
        bar.style.width = '60%';

        // 初始化应用
        initApp();
        txt.textContent = '正在布置创作空间...';
        bar.style.width = '80%';

        setTimeout(() => {
            txt.textContent = '灵感已就位，开始创作吧 ✨';
            bar.style.width = '100%';
        }, 200);

        setTimeout(() => {
            splash.classList.add('hide');
            app.classList.add('show');
        }, 600);

        setTimeout(() => {
            splash.style.display = 'none';
        }, 1400);

        setTimeout(autoBackup, 5000);

    } catch (e) {
        console.error('初始化失败:', e);
        txt.textContent = '初始化失败，使用备用模式...';
        // 即使IndexedDB失败，也尝试用localStorage启动
        setTimeout(() => {
            try { initApp(); } catch (e2) { console.error(e2); }
            splash.classList.add('hide');
            app.classList.add('show');
        }, 1000);
    }

    // Auto-save on input changes
    const autoSaveIds = ['apiUrl', 'apiKey', 'apiModel', 'apiTemp', 'apiMaxTokens', 'worldDesc', 'minWords', 'styleDesc'];
    autoSaveIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', debounce(saveCurSettings, 600));
            el.addEventListener('change', saveCurSettings);
        }
    });
});
function exportAllCrWorks(){
    const data = {crWorks: crWorks, cols: cols};
    const str = JSON.stringify(data, null, 2);
    const blob = new Blob([str], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '我的全部创作_' + new Date().toLocaleDateString() + '.json';
    a.click();
    showToast('已导出全部创作数据 📤');
}
function quickThemeSwitch(){
    const themes = ['default','warm','green','blue','light'];
    let current = ap.theme || 'default';
    let index = themes.indexOf(current);
    index = (index + 1) % themes.length;
    const newTheme = themes[index];
    
    document.body.className = '';
    if(newTheme === 'light') document.body.classList.add('theme-light');
    else if(newTheme !== 'default') document.body.classList.add('theme-' + newTheme);
    
    ap.theme = newTheme;
    sv(K.ap, ap);
    
    showToast('已切换为 ' + (newTheme==='default'?'默认紫色':newTheme==='warm'?'暖橙':newTheme==='green'?'翠绿':newTheme==='blue'?'深蓝':'浅色') + '主题 🎨');
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç¬”è®°AI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0f0f14;--card:#1a1a24;--card2:#22222f;
--accent:#6c5ce7;--accent2:#a29bfe;
--text:#e8e8f0;--text2:#9090a8;
--danger:#ff6b6b;--success:#51cf66;
--border:#2a2a3a;--shadow:0 4px 20px rgba(0,0,0,0.4);
}
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);color:var(--text);
min-height:100vh;overflow-x:hidden;
}
body.theme-warm{--accent:#e67e22;--accent2:#f0b27a;--border:#3a2a1a;}
body.theme-green{--accent:#27ae60;--accent2:#58d68d;--border:#1a3a2a;}
body.theme-blue{--accent:#2980b9;--accent2:#5dade2;--border:#1a2a3a;}
body.theme-light{
--bg:#f5f5f8;--card:#ffffff;--card2:#eeeef3;
--text:#1a1a2e;--text2:#6a6a8a;--border:#d8d8e8;
--shadow:0 4px 20px rgba(0,0,0,0.08);
}
body.theme-light.theme-warm{--accent:#e67e22;--accent2:#d35400;}
body.theme-light.theme-green{--accent:#27ae60;--accent2:#1e8449;}
body.theme-light.theme-blue{--accent:#2980b9;--accent2:#1a5276;}
body.theme-light .bnav{background:rgba(245,245,248,.92);}
body.theme-light .rd-hdr{background:rgba(245,245,248,.88);}
/* SPLASH */
.splash{
position:fixed;inset:0;z-index:10000;
background:var(--bg);
display:flex;flex-direction:column;align-items:center;justify-content:center;
transition:opacity 0.6s,transform 0.6s;
}
.splash.hide{opacity:0;transform:scale(1.04);pointer-events:none;}
.splash-corner{position:absolute;font-size:11px;color:var(--text2);font-weight:500;}
.splash-corner.tl{top:18px;left:18px;}
.splash-corner.br{bottom:18px;right:18px;}
.splash-logo{
font-size:36px;font-weight:900;letter-spacing:3px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;margin-bottom:6px;
}
.splash-sub{font-size:12px;color:var(--text2);margin-bottom:24px;}
.splash-status{font-size:12px;color:var(--accent2);display:flex;align-items:center;gap:8px;}
.splash-spin{
width:16px;height:16px;border:2px solid var(--border);
border-top-color:var(--accent2);border-radius:50%;
animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.splash-spin.done{animation:none;border-color:var(--success);border-top-color:var(--success);}
.splash-ver{position:absolute;bottom:42px;font-size:10px;color:var(--text2);opacity:0.5;}

/* APP */
.app{opacity:0;transform:translateY(16px);transition:opacity .5s .2s,transform .5s .2s;padding-bottom:68px;}
.app.show{opacity:1;transform:translateY(0);}

/* HEADER */
.hdr{
position:sticky;top:0;z-index:100;
background:linear-gradient(135deg,var(--card) 0%,var(--bg) 100%);
padding:14px 18px 10px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
}
.hdr-left h1{
font-size:20px;font-weight:800;letter-spacing:1px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.hdr-left .hdr-sub{font-size:10px;color:var(--text2);margin-top:2px;}
.hdr-right{display:flex;gap:8px;}
.hdr-btn{
background:none;border:1px solid var(--border);color:var(--text2);
padding:5px 10px;border-radius:10px;font-size:11px;cursor:pointer;
display:flex;align-items:center;gap:4px;transition:all .3s;
}
.hdr-btn:active{transform:scale(.95);}
.hdr-btn svg{width:15px;height:15px;}

/* BOTTOM NAV */
.bnav{
position:fixed;bottom:0;left:0;right:0;z-index:200;
background:rgba(26,26,36,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
border-top:1px solid var(--border);
display:flex;justify-content:space-around;padding:7px 0 11px;
transition:transform .3s;
}
.bnav-i{
display:flex;flex-direction:column;align-items:center;gap:2px;
cursor:pointer;padding:5px 14px;border-radius:12px;
background:none;border:none;color:var(--text2);font-size:10px;
transition:all .3s;
}
.bnav-i.act{color:var(--accent2);}
.bnav-i svg{width:21px;height:21px;transition:all .3s;}
.bnav-i.act svg{filter:drop-shadow(0 0 5px var(--accent));}

/* PAGES */
.pg{display:none;animation:fadeIn .25s ease;}
.pg.act{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH BAR */
.sbar{display:flex;gap:9px;padding:14px 18px 8px;}
.sbar input{
flex:1;padding:11px 15px;border-radius:13px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;outline:none;transition:border-color .3s;
}
.sbar input:focus{border-color:var(--accent);}
.sbar input::placeholder{color:var(--text2);}
.btn-gen{
padding:11px 18px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
white-space:nowrap;transition:all .3s;
box-shadow:0 3px 12px rgba(108,92,231,.25);
}
.btn-gen:active{transform:scale(.93);}
.btn-gen:disabled{opacity:.5;cursor:not-allowed;transform:none;}

/* TAGS */
.tags-sec{padding:4px 18px 8px;}
.tags-wrap{display:flex;flex-wrap:nowrap;gap:7px;align-items:center;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;} .tags-wrap::-webkit-scrollbar{height:2px;} .tags-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;} .tags-wrap .tag,.tags-wrap .tag-add{flex-shrink:0;}
.tag{
padding:5px 13px;border-radius:18px;font-size:11px;cursor:pointer;
transition:all .3s;border:1px solid var(--border);background:var(--card);
color:var(--text2);display:flex;align-items:center;gap:4px;
user-select:none;
}
.tag.act{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 8px rgba(108,92,231,.3);}
.tag .tdel{
width:13px;height:13px;display:none;align-items:center;justify-content:center;
font-size:9px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;
line-height:1;
}
.tag.act .tdel{display:flex;}
.tag-add{
padding:5px 11px;border-radius:18px;font-size:11px;cursor:pointer;
border:1px dashed var(--border);background:transparent;color:var(--accent2);
transition:all .3s;
}

/* TYPE TABS */
.ttabs{display:flex;padding:4px 18px;gap:0;}
.ttab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.ttab.act{color:var(--accent2);border-bottom-color:var(--accent);}

/* ARTICLE CARDS */
.alist{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.acard{
background:var(--card);border-radius:15px;padding:16px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.acard:active{transform:scale(.97);border-color:var(--accent);box-shadow:0 0 12px rgba(108,92,231,.15);}
.acard-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.acard-t{font-size:15px;font-weight:700;line-height:1.4;flex:1;margin-right:10px;}
.acard-badge{padding:3px 9px;border-radius:9px;font-size:9px;font-weight:600;flex-shrink:0;}
.acard-badge.long{background:rgba(108,92,231,.18);color:var(--accent2);}
.acard-badge.short{background:rgba(81,207,102,.18);color:var(--success);}
.acard-pv{
font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.acard-ft{display:flex;justify-content:space-between;align-items:center;}
.acard-tags{display:flex;gap:5px;flex-wrap:wrap;flex:1;}
.acard-tag{padding:2px 7px;border-radius:7px;font-size:9px;background:var(--card2);color:var(--text2);}
.acard-wc{font-size:10px;color:var(--text2);margin-right:8px;white-space:nowrap;}
.btn-like{
display:flex;align-items:center;gap:3px;padding:5px 11px;border-radius:9px;
border:1px solid var(--border);background:transparent;color:var(--text2);
font-size:11px;cursor:pointer;transition:all .3s;flex-shrink:0;
}
.btn-like.liked{background:rgba(255,107,107,.13);border-color:var(--danger);color:var(--danger);}
.empty-st{text-align:center;padding:50px 18px;color:var(--text2);}
.empty-st svg{width:50px;height:50px;margin-bottom:12px;opacity:.3;}
.empty-st p{font-size:13px;line-height:1.6;}

/* STREAMING INDICATOR */
.stream-card{
background:var(--card);border-radius:15px;padding:16px;
border:1px solid var(--accent);transition:all .3s;
}
.stream-card .stream-title{
font-size:14px;font-weight:600;color:var(--accent2);margin-bottom:8px;
display:flex;align-items:center;gap:8px;
}
.stream-card .stream-body{
font-size:13px;line-height:1.8;color:var(--text);
max-height:200px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word;
}
.stream-card .stream-info{
display:flex;justify-content:space-between;align-items:center;
margin-top:10px;font-size:10px;color:var(--text2);
}
.ldots{display:inline-flex;gap:3px;align-items:center;}
.ldots span{
width:5px;height:5px;border-radius:50%;background:var(--accent2);
animation:bounce 1.4s infinite both;
}
.ldots span:nth-child(2){animation-delay:.16s;}
.ldots span:nth-child(3){animation-delay:.32s;}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

/* READING MODAL */
.modal{
display:none;position:fixed;inset:0;z-index:500;
background:var(--bg);overflow-y:auto;
}
.modal.show{display:block;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal.fs .rd-hdr{
position:fixed;top:0;left:0;right:0;
background:rgba(15,15,20,.85);backdrop-filter:blur(10px);z-index:10;
}
.modal.fs .rd-body{padding-top:62px;}
.rd-bg{
position:fixed;inset:0;z-index:0;
background-size:cover;background-position:center;
opacity:.50;pointer-events:none;display:none;
}
.rd-hdr{
position:sticky;top:0;z-index:10;
background:rgba(15,15,20,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
padding:14px 18px;display:flex;justify-content:space-between;align-items:center;
border-bottom:1px solid var(--border);
}
.rd-back{
display:flex;align-items:center;gap:5px;background:none;
border:none;color:var(--accent2);font-size:13px;cursor:pointer;padding:4px;
}
.rd-back svg{width:18px;height:18px;}
.rd-acts{display:flex;gap:6px;}
.rd-acts button{
padding:5px 10px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.rd-acts button:active{transform:scale(.95);}
.rd-body{padding:22px 20px 70px;position:relative;z-index:1;}
.rd-title{font-size:20px;font-weight:800;line-height:1.4;margin-bottom:12px;}
.rd-meta{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.rd-meta span{font-size:11px;color:var(--text2);padding:3px 9px;background:var(--card);border-radius:7px;}
.ch-nav{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.ch-btn{
padding:5px 12px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.rd-content{
font-size:var(--rd-fontsize,15px);
line-height:var(--rd-lineheight,2);
color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.rd-content p{margin-bottom:10px;text-indent:2em;}
.rd-dir-input{
display:flex;gap:8px;margin-bottom:16px;
}
.rd-dir-input input{
flex:1;padding:10px 14px;border-radius:12px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.rd-dir-input input::placeholder{color:var(--text2);}
.cont-wrap{padding:16px 0;text-align:center;}
.btn-cont{
padding:11px 28px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
box-shadow:0 3px 12px rgba(108,92,231,.25);transition:all .3s;
}
.btn-cont:active{transform:scale(.95);}
.btn-cont:disabled{opacity:.5;}
.btn-undo{
padding:8px 16px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
margin-left:10px;transition:all .3s;
}

/* Reading settings bar */
.rd-settings{
background:var(--card);border-radius:14px;padding:14px;margin-bottom:18px;
border:1px solid var(--border);display:none;
}
.rd-settings.show{display:block;}
.rd-settings h4{font-size:12px;color:var(--text2);margin-bottom:10px;}
.rd-s-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rd-s-row:last-child{margin-bottom:0;}
.rd-s-label{font-size:11px;color:var(--text2);width:50px;flex-shrink:0;}
.rd-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.rd-s-val{font-size:11px;color:var(--accent2);width:35px;text-align:right;}

/* COLLECTION */
.col-hdr{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;}
.col-hdr h2{font-size:17px;font-weight:700;}
.col-cnt{font-size:11px;color:var(--text2);background:var(--card);padding:3px 11px;border-radius:9px;}
.col-search{padding:0 18px 8px;}
.col-search input{
width:100%;padding:9px 14px;border-radius:11px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.col-search input::placeholder{color:var(--text2);}
.sec-div{padding:14px 18px 4px;display:flex;justify-content:space-between;align-items:center;}
.sec-div h3{font-size:14px;font-weight:600;color:var(--text2);}
.bgrid{
padding:0 18px;display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;
}
.bcard{
background:var(--card);border-radius:13px;overflow:hidden;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.bcard:active{transform:scale(.97);}
.bcov{
width:100%;aspect-ratio:3/4;
background:linear-gradient(135deg,var(--card2),var(--card));
display:flex;align-items:center;justify-content:center;
position:relative;overflow:hidden;
}
.bcov img{width:100%;height:100%;object-fit:cover;}
.bcov-ph{
display:flex;flex-direction:column;align-items:center;gap:6px;
font-size:12px;color:var(--text2);
}
.binfo{padding:10px;}
.binfo-t{font-size:12px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.binfo-m{font-size:9px;color:var(--text2);}
.binfo-status{
display:inline-block;padding:1px 6px;border-radius:6px;font-size:8px;
margin-top:3px;
}
.binfo-status.ongoing{background:rgba(108,92,231,.15);color:var(--accent2);}
.binfo-status.complete{background:rgba(81,207,102,.15);color:var(--success);}
.binfo-status.paused{background:rgba(255,107,107,.15);color:var(--danger);}
.bacts{padding:0 10px 10px;display:flex;gap:5px;}
.bact{
flex:1;padding:5px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.bact.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.col-shorts{padding:14px 18px 0;}
.col-shorts h3{font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text2);}
.slist{display:flex;flex-direction:column;gap:9px;padding-bottom:18px;}
.sitem{
background:var(--card);border-radius:11px;padding:12px;
border:1px solid var(--border);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.sitem-info{flex:1;margin-right:8px;}
.sitem-t{font-size:13px;font-weight:600;margin-bottom:3px;}
.sitem-pv{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100vw - 160px);}
.sitem-acts{display:flex;gap:5px;}
.sitem-acts button{
padding:4px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
}
.star-rating{display:flex;gap:2px;margin-top:4px;}
.star-rating span{
font-size:14px;cursor:pointer;color:var(--border);transition:color .2s;
user-select:none;
}
.star-rating span.filled{color:#f1c40f;}

/* USER CARD */
.ucard{
margin:14px 18px;background:var(--card);border-radius:18px;
border:1px solid var(--border);overflow:hidden;
}
.ucard-top{
padding:20px 18px 14px;display:flex;align-items:center;gap:14px;
}
.ucard-avatar{
width:56px;height:56px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
font-size:24px;color:#fff;cursor:pointer;
overflow:hidden;flex-shrink:0;position:relative;
border:2px solid var(--border);transition:all .3s;
}
.ucard-avatar:active{transform:scale(.95);}
.ucard-avatar img{width:100%;height:100%;object-fit:cover;}
.ucard-avatar-hint{
position:absolute;inset:0;background:rgba(0,0,0,.45);
display:flex;align-items:center;justify-content:center;
font-size:10px;color:#fff;opacity:0;transition:opacity .3s;
}
.ucard-avatar:active .ucard-avatar-hint{opacity:1;}
.ucard-info{flex:1;min-width:0;}
.ucard-name{
font-size:16px;font-weight:700;margin-bottom:3px;
display:flex;align-items:center;gap:6px;
}
.ucard-name span{
overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
}
.ucard-name button{
background:none;border:none;color:var(--text2);font-size:12px;
cursor:pointer;padding:2px 6px;flex-shrink:0;
}
.ucard-bio{
font-size:11px;color:var(--text2);line-height:1.5;
display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
overflow:hidden;cursor:pointer;
}
.ucard-stats{
padding:12px 18px 16px;border-top:1px solid var(--border);
display:grid;grid-template-columns:repeat(4,1fr);gap:0;
}
.ucard-stat{
text-align:center;padding:6px 0;
position:relative;
}
.ucard-stat:not(:last-child)::after{
content:'';position:absolute;right:0;top:20%;height:60%;
width:1px;background:var(--border);
}
.ucard-stat-num{
font-size:18px;font-weight:800;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.ucard-stat-label{font-size:9px;color:var(--text2);margin-top:2px;}
/* SETTINGS */
.set-sec{padding:14px 18px;}
.set-grp{
background:var(--card);border-radius:15px;
border:1px solid var(--border);margin-bottom:13px;overflow:hidden;
}
.set-grp-t{
padding:13px 16px;font-size:14px;font-weight:700;
background:var(--card2);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.set-grp-t svg{width:16px;height:16px;color:var(--text2);transition:transform .3s;}
.set-grp-t.exp svg{transform:rotate(180deg);}
.set-grp-c{padding:14px 16px;display:none;}
.set-grp-c.show{display:block;}
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.fl{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.fi,.fta,.fsel{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
transition:border-color .3s;font-family:inherit;
}
.fi:focus,.fta:focus{border-color:var(--accent);}
.fta{min-height:90px;resize:vertical;line-height:1.6;}
.frow{display:flex;gap:9px;}
.frow .fg{flex:1;}
.plist{display:flex;flex-direction:column;gap:7px;margin-top:9px;}
.pitem{
display:flex;justify-content:space-between;align-items:center;
padding:9px 13px;background:var(--bg);border-radius:9px;border:1px solid var(--border);
}
.pitem-n{font-size:12px;font-weight:500;}
.pitem-a{display:flex;gap:5px;}
.pitem-a button{
padding:3px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;font-size:10px;cursor:pointer;transition:all .3s;
}
.btn-use{color:var(--accent2);border-color:var(--accent)!important;}
.btn-del{color:var(--danger);border-color:rgba(255,107,107,.3)!important;}
.btn-p{
padding:9px 18px;border-radius:11px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
transition:all .3s;width:100%;margin-top:7px;
}
.btn-p:active{transform:scale(.98);}
.btn-s{
padding:9px 18px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;font-weight:500;
cursor:pointer;transition:all .3s;width:100%;margin-top:7px;
}
.theme-opts{display:flex;gap:8px;flex-wrap:wrap;}
.t-opt{
width:36px;height:36px;border-radius:10px;border:2px solid var(--border);
cursor:pointer;transition:all .3s;
}
.t-opt.act{border-color:var(--accent);box-shadow:0 0 8px rgba(108,92,231,.3);}
.t-opt.t0{background:linear-gradient(135deg,#6c5ce7,#a29bfe);}
.t-opt.t1{background:linear-gradient(135deg,#e67e22,#f0b27a);}
.t-opt.t2{background:linear-gradient(135deg,#27ae60,#58d68d);}
.t-opt.t3{background:linear-gradient(135deg,#2980b9,#5dade2);}
.t-opt.t4{background:linear-gradient(135deg,#f5f5f8,#ddd);border-color:#ccc;}
.data-btns{display:flex;flex-direction:column;gap:8px;}
.data-btns button{
padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:7px;transition:all .3s;
}
.data-btns button:active{transform:scale(.98);}
.wc-set{display:flex;align-items:center;gap:8px;}
.wc-set input{width:90px;text-align:center;}

/* Char cards - dynamic */
.char-cards{display:flex;flex-direction:column;gap:12px;}
.char-card{
background:var(--bg);border-radius:12px;padding:14px;
border:1px solid var(--border);position:relative;
}
.char-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.char-card-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.char-card-del{
background:none;border:none;color:var(--danger);font-size:10px;cursor:pointer;
padding:3px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);
}

/* HANDBOOK */
.hb-ov{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.hb-ov.show{display:block;animation:slideUp .3s ease;}
.hb-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:14px 18px;display:flex;align-items:center;gap:8px;
border-bottom:1px solid var(--border);
}
.hb-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;display:flex;align-items:center;gap:5px;
}
.hb-hdr button svg{width:18px;height:18px;}
.hb-hdr h2{font-size:16px;font-weight:700;}
.hb-body{padding:22px 20px 50px;}
.hb-body h3{
font-size:15px;font-weight:700;color:var(--accent2);
margin:22px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--border);
}
.hb-body h3:first-child{margin-top:0;}
.hb-body p{font-size:13px;line-height:1.9;color:var(--text);margin-bottom:9px;}
.hb-body ul{padding-left:18px;margin-bottom:10px;}
.hb-body li{font-size:12px;line-height:1.8;color:var(--text2);margin-bottom:3px;}
.hb-body .notice{
background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.25);
border-radius:11px;padding:13px 15px;margin:14px 0;
}
.hb-body .notice p{color:var(--accent2);font-size:12px;margin:0;}
.hb-body .contact{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);margin-top:10px;
}
.hb-body .contact p{font-size:12px;line-height:2;color:var(--text2);margin:0;}

/* DIALOGS */
.toast{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%) scale(.9);
background:var(--card2);color:var(--text);padding:13px 26px;
border-radius:13px;font-size:12px;z-index:9999;opacity:0;
transition:all .3s;pointer-events:none;text-align:center;
border:1px solid var(--border);box-shadow:var(--shadow);max-width:270px;
}
.toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.dlg-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.dlg-ov.show{display:flex;}
.dlg-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:310px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.dlg-box h3{font-size:15px;margin-bottom:9px;}
.dlg-box p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px;}
.dlg-btns{display:flex;gap:9px;}
.dlg-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
.dlg-cancel{background:var(--card2);color:var(--text);}
.dlg-ok{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
.dlg-danger{background:var(--danger);color:#fff;}
.inp-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.inp-ov.show{display:flex;}
.inp-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:340px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.inp-box h3{font-size:15px;margin-bottom:13px;}
.inp-box input,.inp-box textarea{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin-bottom:13px;font-family:inherit;
}
.inp-box textarea{min-height:70px;resize:vertical;}
.inp-btns{display:flex;gap:9px;}
.inp-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}

/* Scrollbar */
/* CHAPTER LIST OVERLAY */
.ch-ov{
display:none;position:fixed;inset:0;z-index:550;
background:rgba(0,0,0,.55);align-items:flex-end;justify-content:center;
}
.ch-ov.show{display:flex;}
.ch-panel{
background:var(--card);border-radius:18px 18px 0 0;
width:100%;max-width:500px;max-height:70vh;
padding:0;overflow:hidden;animation:slideUp .3s ease;
display:flex;flex-direction:column;
}
.ch-panel-hdr{
padding:16px 18px 12px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ch-panel-hdr h3{font-size:15px;font-weight:700;}
.ch-panel-hdr span{font-size:11px;color:var(--text2);}
.ch-panel-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;border-radius:8px;
}
.ch-panel-list{
padding:12px 18px 20px;overflow-y:auto;flex:1;
display:flex;flex-direction:column;gap:0;
}
.ch-item{
padding:13px 16px;border-radius:0;border:none;border-bottom:1px solid var(--border);
background:var(--bg);color:var(--text2);font-size:13px;
text-align:left;cursor:pointer;transition:all .3s;
display:flex;flex-direction:row;align-items:center;gap:12px;
}
.ch-item:last-child{border-bottom:none;}
.ch-item:active{transform:scale(.95);}
.ch-item.act{background:rgba(108,92,231,.1);color:var(--accent2);border-bottom-color:var(--border);}
.ch-item .ch-item-num{font-size:14px;font-weight:700;}
.ch-item .ch-item-wc{font-size:9px;opacity:.7;}
/* CREATE PAGE */
.cr-tabs{display:flex;padding:4px 18px;gap:0;}
.cr-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.cr-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.cr-list{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.cr-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.cr-card:active{transform:scale(.98);}
.cr-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.cr-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cr-card-badge{padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;}
.cr-card-badge.draft{background:rgba(255,165,0,.15);color:#f0a030;}
.cr-card-badge.novel{background:rgba(108,92,231,.15);color:var(--accent2);}
.cr-card-pv{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cr-card-ft{display:flex;justify-content:space-between;align-items:center;}
.cr-card-info{font-size:9px;color:var(--text2);}
.cr-card-acts{display:flex;gap:5px;}
.cr-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.cr-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.cr-new-bar{padding:8px 18px;display:flex;gap:8px;}
.cr-new-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.cr-new-bar button:active{transform:scale(.97);}

/* EDITOR MODAL */
.ed-modal{
display:none;position:fixed;inset:0;z-index:510;
background:var(--bg);overflow-y:auto;
}
.ed-modal.show{display:block;animation:slideUp .3s ease;}
.ed-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:10px 14px;display:flex;align-items:center;
border-bottom:none;gap:8px;
}
.ed-back{
display:flex;align-items:center;gap:4px;background:none;
border:none;color:var(--accent2);font-size:12px;cursor:pointer;padding:4px;flex-shrink:0;
}
.ed-back svg{width:16px;height:16px;}
.ed-title-input{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;font-weight:700;outline:none;
}
.ed-title-input:focus{border-color:var(--accent);}
.ed-acts{
display:flex;gap:6px;padding:8px 14px;
overflow-x:auto;-webkit-overflow-scrolling:touch;
border-bottom:1px solid var(--border);
background:var(--card);
}
.ed-acts::-webkit-scrollbar{display:none;}
.ed-acts button{
flex-shrink:0;padding:6px 12px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;display:flex;align-items:center;gap:4px;
}
.ed-acts button:active{transform:scale(.95);background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-bar{
padding:8px 14px;display:flex;gap:6px;align-items:center;
border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;
}
.ed-ch-bar::-webkit-scrollbar{display:none;}
.ed-ch-btn{
padding:5px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;transition:all .3s;
}
.ed-ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-add{
padding:5px 10px;border-radius:8px;border:1px dashed var(--border);
background:transparent;color:var(--accent2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;
}
.ed-body{padding:14px;}
.ed-textarea{
width:100%;min-height:calc(100vh - 200px);padding:16px;
border-radius:12px;border:1px solid var(--border);
background:var(--card);color:var(--text);
font-size:var(--rd-fontsize,15px);line-height:var(--rd-lineheight,2);
outline:none;resize:none;font-family:inherit;
}
.ed-textarea:focus{border-color:var(--accent);}
.ed-textarea::placeholder{color:var(--text2);}
.ed-footer{
padding:10px 14px;border-top:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
font-size:10px;color:var(--text2);
}
.ed-wc{font-weight:600;color:var(--accent2);}

/* AI REVIEW PANEL */
.ai-review-ov{
display:none;position:fixed;inset:0;z-index:570;
background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:20px;
}
.ai-review-ov.show{display:flex;}
.ai-review-box{
background:var(--card);border-radius:16px;padding:0;
width:100%;max-width:400px;max-height:80vh;
border:1px solid var(--border);overflow:hidden;
display:flex;flex-direction:column;animation:fadeIn .25s ease;
}
.ai-review-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ai-review-hdr h3{font-size:14px;font-weight:700;}
.ai-review-body{
padding:16px;overflow-y:auto;flex:1;
font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.ai-review-ft{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;text-align:right;
}
.ai-review-ft button{
padding:8px 20px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
}
/* RESOURCE PAGE */
.res-bar{padding:10px 18px;display:flex;gap:8px;}
.res-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.res-bar button:active{transform:scale(.97);}
.res-tabs{display:flex;padding:4px 18px;gap:0;}
.res-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.res-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.res-list{padding:8px 18px;display:flex;flex-direction:column;gap:10px;}
.res-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;
}
.res-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.res-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;}
.res-card-type{
padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;
}
.res-card-type.char{background:rgba(108,92,231,.15);color:var(--accent2);}
.res-card-type.world{background:rgba(39,174,96,.15);color:var(--success);}
.res-card-type.style{background:rgba(230,126,34,.15);color:#e67e22;}
.res-card-type.work{background:rgba(52,152,219,.15);color:#3498db;}
.res-card-type.exp{background:rgba(241,196,15,.15);color:#f1c40f;}
.res-card-pv{
font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.res-card-ft{display:flex;justify-content:space-between;align-items:center;}
.res-card-info{font-size:9px;color:var(--text2);}
.res-card-acts{display:flex;gap:5px;}
.res-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.res-card-acts button.use{color:var(--accent2);border-color:var(--accent);}
.res-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}

/* RESOURCE EXPORT DIALOG */
.res-exp-ov{
display:none;position:fixed;inset:0;z-index:810;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:20px;
}
.res-exp-ov.show{display:flex;}
.res-exp-box{
background:var(--card);border-radius:16px;padding:20px;
width:100%;max-width:360px;border:1px solid var(--border);
animation:fadeIn .25s ease;max-height:85vh;overflow-y:auto;
}
.res-exp-box h3{font-size:15px;margin-bottom:14px;}
.res-chk-item{
display:flex;align-items:center;gap:10px;padding:10px 12px;
background:var(--bg);border-radius:9px;border:1px solid var(--border);
margin-bottom:8px;cursor:pointer;transition:all .3s;
}
.res-chk-item.checked{border-color:var(--accent);background:rgba(108,92,231,.06);}
.res-chk-box{
width:18px;height:18px;border-radius:5px;border:2px solid var(--border);
display:flex;align-items:center;justify-content:center;flex-shrink:0;
font-size:11px;color:#fff;transition:all .3s;
}
.res-chk-item.checked .res-chk-box{background:var(--accent);border-color:var(--accent);}
.res-chk-info{flex:1;}
.res-chk-name{font-size:12px;font-weight:600;}
.res-chk-desc{font-size:9px;color:var(--text2);margin-top:2px;}
.res-exp-input{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin:10px 0;
}
.res-exp-input:focus{border-color:var(--accent);}
.res-exp-btns{display:flex;gap:9px;margin-top:14px;}
.res-exp-btns button{
flex:1;padding:10px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
/* NOTE PANEL */
.note-ov{
display:none;position:fixed;inset:0;z-index:560;
background:rgba(0,0,0,.45);
}
.note-ov.show{display:block;}
.note-panel{
position:fixed;top:0;right:-320px;bottom:0;z-index:561;
width:300px;max-width:85vw;background:var(--card);
border-left:1px solid var(--border);
display:flex;flex-direction:column;
transition:right .3s ease;
box-shadow:-4px 0 20px rgba(0,0,0,.3);
}
.note-ov.show .note-panel{right:0;}
.note-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.note-hdr h3{font-size:14px;font-weight:700;}
.note-hdr span{font-size:10px;color:var(--text2);}
.note-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;
}
.note-list{
flex:1;overflow-y:auto;padding:12px 16px;
display:flex;flex-direction:column;gap:10px;
}
.note-empty{
text-align:center;padding:40px 10px;color:var(--text2);font-size:12px;
}
.note-item{
background:var(--bg);border-radius:10px;padding:11px 13px;
border:1px solid var(--border);position:relative;
}
.note-item-text{font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap;word-wrap:break-word;}
.note-item-ft{
display:flex;justify-content:space-between;align-items:center;
margin-top:7px;
}
.note-item-time{font-size:9px;color:var(--text2);}
.note-item-del{
background:none;border:none;color:var(--danger);font-size:9px;
cursor:pointer;padding:2px 6px;border-radius:5px;
border:1px solid rgba(255,107,107,.3);
}
.note-input-wrap{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;
}
.note-input-row{display:flex;gap:8px;}
.note-input-row textarea{
flex:1;padding:9px 12px;border-radius:10px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
resize:none;min-height:38px;max-height:100px;
font-family:inherit;line-height:1.5;
}
.note-input-row textarea:focus{border-color:var(--accent);}
.note-input-row textarea::placeholder{color:var(--text2);}
.note-send{
padding:8px 14px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
align-self:flex-end;white-space:nowrap;
}
.note-send:active{transform:scale(.95);}
.note-dot{
display:inline-block;width:6px;height:6px;border-radius:50%;
background:var(--accent2);margin-left:4px;vertical-align:middle;
}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.rd-para{transition:background .3s;border-radius:4px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:pan-y;}
</style>
</head>
<body>
<div class="splash" id="splash">
<div class="splash-corner tl">Created by å¿ƒç”°</div>
<div class="splash-corner br">Created by å¿ƒç”°</div>
<div class="splash-logo">âœ¦ ç¬”è®°AI</div>
<div class="splash-sub">AIåˆ›ä½œå·¥åŠ Â· è®©çµæ„Ÿè½ç¬”æˆç« </div>
<div class="splash-status" id="splashSt">
<div class="splash-spin" id="splashSpin"></div>
<span id="splashTxt">æ­£åœ¨åŠ è½½...</span>
</div>
<div class="splash-ver" id="splashVer">v2.3.0</div>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="hdr">
<div class="hdr-left">
<h1>âœ¦ ç¬”è®°AI</h1>
<div class="hdr-sub">AIåˆ›ä½œå·¥åŠ Â· è®©çµæ„Ÿè½ç¬”æˆç« </div>
</div>
<div class="hdr-right">
<button class="hdr-btn" onclick="openInspiration()" title="çµæ„Ÿ">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
çµæ„Ÿ
</button>
<button class="hdr-btn" onclick="openHandbook()" title="æ‰‹å†Œ">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
æ‰‹å†Œ
</button>
</div>
</div>

<!-- WORKSHOP -->
<div class="pg act" id="pg-workshop">
<div class="sbar">
<input type="text" id="searchInput" placeholder="æè¿°ä½ æƒ³è¦çš„æ•…äº‹å†…å®¹..." onkeydown="if(event.key==='Enter'){event.preventDefault();generateArticle();}">
<button class="btn-gen" id="btnGen" onclick="handleGenBtn()">ç”Ÿæˆ</button>
</div>
<div class="tags-sec">
<div class="tags-wrap" id="tagsWrap"></div>
</div>
<div class="ttabs">
<button class="ttab act" onclick="switchType('long',this)">é•¿ç¯‡è¿è½½</button>
<button class="ttab" onclick="switchType('short',this)">çŸ­ç¯‡ä¸€å‘</button>
</div>
<div style="padding:2px 18px 6px;display:flex;align-items:center;gap:8px">
<span style="font-size:10px;color:var(--text2);flex-shrink:0">åˆ›æ„åº¦</span>
<input type="range" min="0.3" max="1.5" step="0.1" value="0.8" id="quickTemp" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('qtVal').textContent=this.value;document.getElementById('apiTemp').value=this.value">
<span style="font-size:10px;color:var(--accent2);width:24px;text-align:right" id="qtVal">0.8</span>
<span style="font-size:9px;color:var(--text2)">ç¨³å®šâ†â†’ç‹‚é‡</span>
</div>
<div class="alist" id="articleList">
<div class="empty-st">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
<p>è¾“å…¥æè¿°æˆ–é€‰æ‹©æ ‡ç­¾<br>ç‚¹å‡»ã€Œç”Ÿæˆã€å¼€å§‹åˆ›ä½œå§ âœ¨</p>
</div>
</div>
</div>

<!-- COLLECTION -->
<div class="pg" id="pg-collection">
<div class="col-hdr">
<h2>ğŸ“š æˆ‘çš„æ”¶è—</h2>
<span class="col-cnt" id="colCnt">0 ç¯‡</span>
</div>
<div class="col-search">
<input type="text" id="colSearchInput" placeholder="ğŸ” æœç´¢ä¹¦åæˆ–æ–‡ç« å..." oninput="renderCollections()">
</div>
<div class="sec-div"><h3>é•¿ç¯‡ä¹¦æ¶</h3></div>
<div class="bgrid" id="bookGrid"></div>
<div class="col-shorts">
<h3>çŸ­ç¯‡æ”¶è—</h3>
<div class="slist" id="shortList"></div>
</div>
</div>
<!-- CREATE -->
<div class="pg" id="pg-create">
<div class="cr-new-bar">
<button onclick="newDraft()">ğŸ“„ æ–°å»ºè‰ç¨¿</button>
<button onclick="newNovel()">ğŸ“– æ–°å»ºå°è¯´</button>
<button onclick="openOutlineGen()" style="border-color:var(--accent);color:var(--accent2)">ğŸ§  AIå¤§çº²</button>
</div>
<div class="cr-tabs">
<button class="cr-tab act" onclick="switchCrTab('draft',this)">è‰ç¨¿ç®±</button>
<button class="cr-tab" onclick="switchCrTab('novel',this)">æˆ‘çš„å°è¯´</button>
</div>
<div class="cr-list" id="crList"></div>
</div>
<!-- SETTINGS -->
<div class="pg" id="pg-settings">
<div class="ucard" id="ucard">
<div class="ucard-top">
<div class="ucard-avatar" id="ucAvatar" onclick="uploadAvatar()">
<span id="ucAvatarPh">âœ¦</span>
<div class="ucard-avatar-hint">æ›´æ¢</div>
</div>
<div class="ucard-info">
<div class="ucard-name">
<span id="ucName">ç‚¹å‡»è®¾ç½®æ˜µç§°</span>
<button onclick="editUcName()" title="ç¼–è¾‘æ˜µç§°">âœï¸</button>
</div>
<div class="ucard-bio" id="ucBio" onclick="editUcBio()">ç‚¹å‡»æ·»åŠ ä¸ªäººç®€ä»‹...</div>
</div>
</div>
<div class="ucard-stats">
<div class="ucard-stat">
<div class="ucard-stat-num" id="statTotal">0</div>
<div class="ucard-stat-label">æ€»å­—æ•°</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statWorks">0</div>
<div class="ucard-stat-label">ä½œå“æ•°</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statCols">0</div>
<div class="ucard-stat-label">æ”¶è—æ•°</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statNotes">0</div>
<div class="ucard-stat-label">ç¬”è®°æ•°</div>
</div>
</div>
</div>
<input type="file" id="avatarUp" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
<div class="set-sec">

<!-- API -->
<div class="set-grp">
<div class="set-grp-t exp" onclick="toggleGrp(this)">
ğŸ”‘ APIè®¾ç½®
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c show">
<div class="fg"><label class="fl">APIåœ°å€ (Base URL)</label><input class="fi" id="apiUrl" placeholder="https://api.openai.com/v1"></div>
<div class="fg"><label class="fl">APIå¯†é’¥ (Key)</label><div style="display:flex;gap:6px"><input class="fi" id="apiKey" type="password" placeholder="sk-..." style="flex:1"><button class="btn-s" onclick="const k=document.getElementById('apiKey');k.type=k.type==='password'?'text':'password';this.textContent=k.type==='password'?'ğŸ‘':'ğŸ™ˆ'" style="width:auto;padding:6px 10px;margin:0;font-size:14px">ğŸ‘</button></div></div>
<div class="fg"><label class="fl">æ¨¡å‹åç§°</label> <div style="display:flex;gap:6px"> <input class="fi" id="apiModel" placeholder="gpt-4o-mini" value="gpt-4o-mini" list="modelSuggest" style="flex:1"> <datalist id="modelSuggest"></datalist> <button class="btn-s" onclick="fetchModels()" style="width:auto;padding:6px 12px;margin:0;white-space:nowrap;font-size:11px">æ‹‰å–æ¨¡å‹</button> </div> </div>
<div class="frow">
<div class="fg"><label class="fl">Temperature</label><input class="fi" id="apiTemp" type="number" step="0.1" min="0" max="2" value="0.8"></div>
<div class="fg"><label class="fl">Max Tokens</label><input class="fi" id="apiMaxTokens" type="number" value="4096"></div>
</div>
<div class="fg" style="display:flex;align-items:center;justify-content:space-between;padding:4px 0">
<label class="fl" style="margin:0">æµå¼è¾“å‡ºï¼ˆé€å­—æ˜¾ç¤ºï¼‰</label>
<div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleStreamSwitch(this)">
<input type="checkbox" id="streamOn" checked style="display:none">
<div style="width:44px;height:24px;border-radius:12px;background:var(--accent);transition:background .3s;position:relative" id="streamTrack">
<div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="streamThumb"></div>
</div>
</div>
</div>
<p style="font-size:9px;color:var(--text2);margin-top:2px">å…³é—­åå°†ä¸€æ¬¡æ€§è¿”å›å®Œæ•´å†…å®¹ï¼Œé€‚åˆä¸æ”¯æŒæµå¼çš„APIæˆ–ç½‘ç»œä¸ç¨³å®šæ—¶ä½¿ç”¨</p>
<button class="btn-s" onclick="testApiConnection()" id="btnTestApi" style="margin-bottom:5px">ğŸ”— æµ‹è¯•è¿æ¥</button>
<button class="btn-p" onclick="saveApiPreset()">ğŸ’¾ ä¿å­˜ä¸ºé¢„è®¾</button>
<div class="plist" id="apiPL"></div>
</div>
</div>

<!-- Characters -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
ğŸ‘¤ äººç‰©è®¾å®š
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="char-cards" id="charCards"></div>
<button class="btn-s" onclick="addCharacter()" style="margin-top:10px">ï¼‹ æ·»åŠ è§’è‰²</button>
<button class="btn-p" onclick="saveCharPreset()">ğŸ’¾ ä¿å­˜äººç‰©é¢„è®¾</button>
<div class="plist" id="charPL"></div>
</div>
</div>

<!-- World -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
ğŸŒ ä¸–ç•Œè§‚è®¾å®š
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">ä¸–ç•Œè§‚ / èƒŒæ™¯è®¾å®š</label><textarea class="fta" id="worldDesc" placeholder="æè¿°æ•…äº‹å‘ç”Ÿçš„ä¸–ç•ŒèƒŒæ™¯ã€æ—¶ä»£ã€åœ°ç†ã€ç¤¾ä¼šè§„åˆ™ç­‰...ï¼ˆä¸åŒ…å«æ–‡é£ï¼Œæ–‡é£è¯·åœ¨ä¸‹æ–¹å•ç‹¬è®¾ç½®ï¼‰" style="min-height:120px"></textarea></div>
<div class="fg"><label class="fl">æ¯ç« æœ€å°‘å­—æ•°</label><div class="wc-set"><input class="fi" id="minWords" type="number" value="800" min="100" step="100"><span style="color:var(--text2);font-size:11px">å­—</span></div></div>
<button class="btn-p" onclick="saveWorldPreset()">ğŸ’¾ ä¿å­˜ä¸–ç•Œè§‚é¢„è®¾</button>
<div class="plist" id="worldPL"></div>
</div>
</div>

<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
âœ’ï¸ æ–‡é£è®¾ç½®
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">å½“å‰æ–‡é£æè¿°</label><textarea class="fta" id="styleDesc" placeholder="ä¾‹å¦‚ï¼šè½»æ¾å¹½é»˜çš„éƒ½å¸‚é£ã€æ²‰éƒå†·å³»çš„çº¯æ–‡å­¦é£ã€ç»†è…»æ¸©æŸ”çš„å°‘å¥³æ¼«é£ã€ç¡¬æ ¸å†™å®çš„å†›äº‹é£..." style="min-height:90px"></textarea></div>
<div class="fg"><label class="fl">å¿«æ·æ–‡é£æ¨¡æ¿</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
<button class="tag" onclick="applyStyleTemplate('è½»æ¾æ—¥å¸¸')">è½»æ¾æ—¥å¸¸</button>
<button class="tag" onclick="applyStyleTemplate('æ²‰éƒæ–‡å­¦')">æ²‰éƒæ–‡å­¦</button>
<button class="tag" onclick="applyStyleTemplate('ç”œå® è¨€æƒ…')">ç”œå® è¨€æƒ…</button>
<button class="tag" onclick="applyStyleTemplate('æ‚¬ç–‘ç´§å¼ ')">æ‚¬ç–‘ç´§å¼ </button>
<button class="tag" onclick="applyStyleTemplate('å¤é£å…¸é›…')">å¤é£å…¸é›…</button>
<button class="tag" onclick="applyStyleTemplate('å¹½é»˜è®½åˆº')">å¹½é»˜è®½åˆº</button>
<button class="tag" onclick="applyStyleTemplate('ç¡¬æ ¸å†™å®')">ç¡¬æ ¸å†™å®</button>
</div>
</div>
<button class="btn-p" onclick="saveStylePreset()">ğŸ’¾ ä¿å­˜æ–‡é£é¢„è®¾</button>
<div class="plist" id="stylePL"></div>
</div>
</div>

<!-- Appearance -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
ğŸ¨ é¡µé¢ç¾åŒ–
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">ä¸»é¢˜é£æ ¼</label>
<div class="theme-opts">
<div class="t-opt t0 act" onclick="setTheme('default',this)" title="é»˜è®¤ç´«"></div>
<div class="t-opt t1" onclick="setTheme('warm',this)" title="æš–æ©™"></div>
<div class="t-opt t2" onclick="setTheme('green',this)" title="ç¿ ç»¿"></div>
<div class="t-opt t3" onclick="setTheme('blue',this)" title="æ·±è“"></div>
<div class="t-opt t4" onclick="setTheme('light',this)" title="æ—¥é—´"></div>
</div></div>
<div class="fg"><label class="fl">è‡ªå®šä¹‰å­—ä½“é“¾æ¥ï¼ˆttf/woff/woff2ï¼‰</label><input class="fi" id="customFontUrl" placeholder="https://example.com/font.ttf"><p style="font-size:9px;color:var(--text2);margin-top:3px">è¾“å…¥å­—ä½“æ–‡ä»¶é“¾æ¥åå…¨å±€ç”Ÿæ•ˆï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å­—ä½“</p></div>
<div class="fg"><label class="fl">é˜…è¯»èƒŒæ™¯å›¾ç‰‡</label>
<button class="btn-s" onclick="document.getElementById('rdBgUp').click()">ğŸ“ ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</button>
<input type="file" id="rdBgUp" accept="image/*" style="display:none" onchange="uploadRdBg(event)">
<button class="btn-s" onclick="clearRdBg()" style="margin-top:5px">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯å›¾</button>
<p style="font-size:9px;color:var(--text2);margin-top:3px">ä¸Šä¼ å›¾ç‰‡å°†åœ¨é˜…è¯»æ—¶æ˜¾ç¤ºä¸ºæ·¡åŒ–èƒŒæ™¯</p>
</div>
</div>
</div>

<!-- Data -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
ğŸ“¦ æ•°æ®ç®¡ç†
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="data-btns">
<button onclick="exportData()">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
<button onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button onclick="clearWorkshop()" style="border-color:rgba(255,107,107,.3);color:var(--danger)">ğŸ—‘ï¸ æ¸…ç©ºä½œåŠ</button>
</div>
<p style="font-size:10px;color:var(--text2);margin-top:8px;line-height:1.5">å¯¼å‡ºå†…å®¹åŒ…å«ï¼šAPIé¢„è®¾ã€äººç‰©è®¾å®šã€ä¸–ç•Œè§‚é¢„è®¾ã€æ–‡é£é¢„è®¾ã€æ”¶è—å†…å®¹ã€åˆ›ä½œå†…å®¹ã€ç¬”è®°ã€å¤–è§‚è®¾ç½®ã€å¡ç‰‡è®¾ç½®</p>
</div>
</div>
</div>
</div>
<!-- RESOURCE -->
<div class="pg" id="pg-resource">
<div style="padding:14px 18px 4px"><h2>ğŸ“¦ èµ„æºå¹¿åœº</h2><p style="font-size:11px;color:var(--text2);margin-top:4px">æ‰“åŒ…åˆ†äº«ä½ çš„è®¾å®šå’Œåˆ›ä½œï¼Œå¯¼å…¥åˆ«äººçš„èµ„æºåŒ…</p></div>
<div class="res-bar">
<button onclick="openResExport()">ğŸ“¤ æ‰“åŒ…å¯¼å‡º</button>
<button onclick="document.getElementById('resImpFile').click()">ğŸ“¥ å¯¼å…¥èµ„æºåŒ…</button>
<button onclick="writeExpShare()">âœï¸ å†™ç»éªŒ</button>
<input type="file" id="resImpFile" accept=".json" style="display:none" onchange="importResPack(event)">
</div>
<div class="res-tabs">
<button class="res-tab act" onclick="switchResTab('all',this)">å…¨éƒ¨</button>
<button class="res-tab" onclick="switchResTab('char',this)">äººç‰©</button>
<button class="res-tab" onclick="switchResTab('world',this)">ä¸–ç•Œè§‚</button>
<button class="res-tab" onclick="switchResTab('style',this)">æ–‡é£</button>
<button class="res-tab" onclick="switchResTab('work',this)">ä½œå“</button>
<button class="res-tab" onclick="switchResTab('exp',this)">ç»éªŒ</button>
</div>
<div class="res-list" id="resList"></div>
</div>
</div><!-- end app -->

<!-- READING MODAL -->
<div class="modal" id="rdModal">
<div class="rd-bg" id="rdBg"></div>
<div class="rd-hdr">
<button class="rd-back" onclick="closeReading()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
è¿”å›
</button>
<div class="rd-acts">
<button onclick="toggleRdSettings()" title="é˜…è¯»è®¾ç½®">âš™</button>
<button onclick="toggleFullscreen()" id="btnFS">â›¶</button>
<button onclick="copyCurrentArticle()">ğŸ“‹</button>
<button onclick="openNotePanel()" id="rdNoteBtn">ğŸ“</button>
<button onclick="toggleCurrentLike()" id="rdLikeBtn">â™¡</button> <button onclick="document.getElementById('rdModal').scrollTo({top:0,behavior:'smooth'})" title="å›åˆ°é¡¶éƒ¨">â¬†</button>
</div>
</div>
<div class="rd-body">
<h1 class="rd-title" id="rdTitle"></h1>
<div class="rd-meta" id="rdMeta"></div>
<div class="rd-settings" id="rdSettingsPanel">
<h4>é˜…è¯»è®¾ç½®</h4>
<div class="rd-s-row"><span class="rd-s-label">å­—å·</span><input type="range" min="12" max="24" value="15" oninput="setRdFont(this.value)"><span class="rd-s-val" id="rdFontVal">15</span></div>
<div class="rd-s-row"><span class="rd-s-label">è¡Œé«˜</span><input type="range" min="1.4" max="3" step="0.1" value="2" oninput="setRdLine(this.value)"><span class="rd-s-val" id="rdLineVal">2</span></div>
</div>
<div class="ch-nav" id="chNav"></div>
<div class="rd-content" id="rdContent"></div>
<div class="cont-wrap" id="contWrap" style="display:none">
<div class="rd-dir-input" id="dirInputWrap">
<input type="text" id="dirInput" placeholder="ç»™ä¸‹ä¸€ç« çš„æ–¹å‘æç¤ºï¼ˆå¯ç•™ç©ºï¼‰...">
</div>
<button class="btn-cont" id="btnCont" onclick="continueChapter()">ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« </button>
<button class="btn-undo" id="btnUndo" style="display:none" onclick="undoChapter()">â†© æ’¤é”€ä¸Šä¸€ç« </button>
</div>
</div>
</div>

<!-- HANDBOOK -->
<div class="hb-ov" id="hbOv">
<div class="hb-hdr">
<button onclick="closeHandbook()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>è¿”å›</button>
<h2>ğŸ“– ä½¿ç”¨æ‰‹å†Œ</h2>
</div>
<div class="hb-body">
<h3>ä¸€ã€æ¬¢è¿ä½¿ç”¨ç¬”è®°AI</h3>
<p>ç¬”è®°AIæ˜¯ä¸€æ¬¾åŸºäºå¤§è¯­è¨€æ¨¡å‹çš„AIåˆ›ä½œå·¥åŠï¼Œå¸®åŠ©ä½ å¿«é€Ÿç”Ÿæˆé«˜è´¨é‡çš„å°è¯´ã€æ•£æ–‡ã€è®ºæ–‡ç­‰æ–‡å­¦ä½œå“ã€‚æ— è®ºä½ æ˜¯æ–°æ‰‹å†™ä½œè€…è¿˜æ˜¯èµ„æ·±åˆ›ä½œäººï¼Œè¿™é‡Œéƒ½èƒ½æˆä¸ºä½ çš„çµæ„Ÿå¼•æ“ã€‚</p>
<h3>äºŒã€å¿«é€Ÿå¼€å§‹</h3>
<ul>
<li><strong>ç¬¬1æ­¥ï¼šé…ç½®API</strong> â€” è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒAPIè®¾ç½®ã€ï¼Œå¡«å†™APIåœ°å€ã€å¯†é’¥å’Œæ¨¡å‹åç§°ã€‚æ”¯æŒå®˜æ–¹OpenAIæˆ–å…¼å®¹çš„ç¬¬ä¸‰æ–¹å…¬ç›Šç«™ã€‚</li>
<li><strong>ç¬¬2æ­¥ï¼šè®¾å®šäººç‰©ï¼ˆå¯é€‰ï¼‰</strong> â€” åœ¨ã€Œäººç‰©è®¾å®šã€ä¸­æ·»åŠ è§’è‰²ï¼ˆä¸é™æ•°é‡ï¼‰ï¼Œå¡«å†™åç§°å’ŒèƒŒæ™¯æè¿°ã€‚</li>
<li><strong>ç¬¬3æ­¥ï¼šè®¾å®šä¸–ç•Œè§‚ï¼ˆå¯é€‰ï¼‰</strong> â€” åœ¨ã€Œä¸–ç•Œè§‚è®¾å®šã€ä¸­æè¿°èƒŒæ™¯è®¾å®šã€‚</li> <li><strong>ç¬¬3.5æ­¥ï¼šé€‰æ‹©æ–‡é£ï¼ˆå¯é€‰ï¼‰</strong> â€” åœ¨ã€Œæ–‡é£è®¾ç½®ã€ä¸­é€‰æ‹©å¿«æ·æ¨¡æ¿æˆ–è‡ªå®šä¹‰æ–‡é£ã€‚</li>
<li><strong>ç¬¬4æ­¥ï¼šå¼€å§‹åˆ›ä½œ</strong> â€” å›åˆ°ã€Œä½œåŠã€ï¼Œè¾“å…¥æ–¹å‘ï¼Œé€‰æ ‡ç­¾ï¼Œé€‰é•¿/çŸ­ç¯‡ï¼Œç‚¹å‡»ã€Œç”Ÿæˆã€ï¼</li>
</ul>
<h3>ä¸‰ã€é•¿ç¯‡ä¸çŸ­ç¯‡</h3>
<p><strong>é•¿ç¯‡è¿è½½</strong>ï¼šç”Ÿæˆåå¯ä»¥ä¸æ–­ç»­å†™æ–°ç« èŠ‚ã€‚éœ€è¦å…ˆæ”¶è—æ‰èƒ½ä½¿ç”¨ã€Œç»§ç»­è¿è½½ã€åŠŸèƒ½ã€‚ç»­å†™å‰å¯ä»¥è¾“å…¥æ–¹å‘æç¤ºå¼•å¯¼AIã€‚æ”¯æŒæ’¤é”€ä¸Šä¸€ç« é‡æ–°ç”Ÿæˆã€‚ç« èŠ‚è¾ƒå¤šæ—¶å¯ç‚¹å‡»ã€ŒğŸ“‘ ç›®å½•ã€æ‰“å¼€ç« èŠ‚åˆ—è¡¨å¿«é€Ÿè·³è½¬ã€‚</p>
<p><strong>çŸ­ç¯‡ä¸€å‘</strong>ï¼šä¸€æ¬¡æ€§ç”Ÿæˆå®Œæ•´æ•…äº‹ï¼Œé€‚åˆçµæ„Ÿé€Ÿå†™æˆ–çŸ­æ–‡åˆ›ä½œã€‚</p>
<h3>å››ã€æµå¼è¾“å‡º</h3>
<p>ç”Ÿæˆæ–‡ç« æ—¶é‡‡ç”¨æµå¼è¾“å‡ºæŠ€æœ¯ï¼Œä½ å¯ä»¥å®æ—¶çœ‹åˆ°AIé€å­—åˆ›ä½œçš„è¿‡ç¨‹ï¼Œæ— éœ€æ¼«é•¿ç­‰å¾…ã€‚ç”Ÿæˆè¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºå·²ç”Ÿæˆå­—æ•°å’Œè€—æ—¶ã€‚ç‚¹å‡»ã€Œåœæ­¢ã€æŒ‰é’®æˆ–å…³é—­é˜…è¯»ç•Œé¢å¯éšæ—¶ä¸­æ­¢ç”Ÿæˆã€‚</p>
<h3>äº”ã€æ”¶è—ç®¡ç†</h3>
<p>ç‚¹å‡»â™¡æŒ‰é’®å³å¯æ”¶è—ã€‚é•¿ç¯‡å¯ä¸Šä¼ å°é¢ã€è®¾ç½®çŠ¶æ€ï¼ˆè¿è½½ä¸­/å·²å®Œç»“/æš‚åœï¼‰ã€ç»™æ–‡ç« æ‰“æ˜Ÿè¯„åˆ†ã€‚æ”¯æŒä¸€é”®å¤åˆ¶çº¯æ–‡æœ¬ï¼ˆè‡ªåŠ¨æ·»åŠ åˆ›ä½œæ¥æºæ³¨é‡Šï¼‰ã€‚</p>
<h3>äº”ç‚¹äº”ã€åˆ›ä½œé¡µé¢</h3>
<p>åº•éƒ¨å¯¼èˆªæ çš„ã€Œåˆ›ä½œã€é¡µé¢æ˜¯ä½ çš„ä¸ªäººå†™ä½œç©ºé—´ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li><strong>è‰ç¨¿</strong>ï¼šå•ç¯‡æ–‡æ¡£ï¼Œé€‚åˆéšæ‰‹è®°å½•çµæ„Ÿã€å†™çŸ­æ–‡ã€‚</li>
<li><strong>å°è¯´</strong>ï¼šå¤šç« èŠ‚è¿è½½ï¼Œå¯è‡ªç”±æ·»åŠ å’Œåˆ é™¤ç« èŠ‚ï¼Œé€‚åˆé•¿ç¯‡åˆ›ä½œã€‚</li>
</ul>
<p>ç¼–è¾‘å™¨æ”¯æŒå®æ—¶å­—æ•°ç»Ÿè®¡ã€2ç§’è‡ªåŠ¨ä¿å­˜ã€ä¸€é”®å¤åˆ¶å…¨æ–‡ã€‚ç‚¹å‡»ç¼–è¾‘å™¨å³ä¸Šè§’çš„ğŸ¤–æŒ‰é’®ï¼Œå¯ä»¥è®©AIå¯¹å½“å‰ç« èŠ‚è¿›è¡Œä¸“ä¸šè¯„ä»·ï¼Œç»™å‡ºäº®ç‚¹åˆ†æå’Œæ”¹è¿›å»ºè®®ã€‚</p>
<h3>å…­ã€é˜…è¯»ä½“éªŒ</h3>
<p>é˜…è¯»æ—¶å¯è°ƒèŠ‚å­—å·å’Œè¡Œé«˜ã€åˆ‡æ¢å…¨å±æ¨¡å¼ã€è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œæ‰“é€ ä¸“å±é˜…è¯»ç©ºé—´ã€‚</p>
<h3>ä¸ƒã€ä¸ªæ€§åŒ–è®¾ç½®</h3>
<p>äº”ç§ä¸»é¢˜é£æ ¼ï¼ˆé»˜è®¤ç´«/æš–æ©™/ç¿ ç»¿/æ·±è“/æ—¥é—´æµ…è‰²ï¼‰ã€è‡ªå®šä¹‰å­—ä½“ã€é˜…è¯»èƒŒæ™¯å›¾ç‰‡ã€‚æ”¯æŒç‹¬ç«‹çš„æ–‡é£è®¾ç½®ï¼Œå†…ç½®7ç§å¿«æ·æ–‡é£æ¨¡æ¿ï¼ˆè½»æ¾æ—¥å¸¸/æ²‰éƒæ–‡å­¦/ç”œå® è¨€æƒ…/æ‚¬ç–‘ç´§å¼ /å¤é£å…¸é›…/å¹½é»˜è®½åˆº/ç¡¬æ ¸å†™å®ï¼‰ï¼Œä¹Ÿå¯è‡ªå®šä¹‰æ–‡é£å¹¶ä¿å­˜ä¸ºé¢„è®¾ã€‚</p>
<h3>ä¸ƒç‚¹äº”ã€èµ„æºå¹¿åœº</h3>
<p>åº•éƒ¨å¯¼èˆªæ çš„ã€Œèµ„æºã€é¡µé¢ç”¨äºæ‰“åŒ…åˆ†äº«å’Œå¯¼å…¥è®¾å®šèµ„æºã€‚</p>
<ul>
<li><strong>æ‰“åŒ…å¯¼å‡º</strong>ï¼šå‹¾é€‰ä½ æƒ³åˆ†äº«çš„äººç‰©è®¾å®šã€ä¸–ç•Œè§‚ã€æ–‡é£ã€åˆ›ä½œä½œå“ï¼Œæ‰“åŒ…æˆ .json èµ„æºæ–‡ä»¶ã€‚æŠŠæ–‡ä»¶å‘ç»™æœ‹å‹æˆ–åˆ†äº«åˆ°ç¤¾ç¾¤å³å¯ã€‚</li>
<li><strong>å¯¼å…¥èµ„æºåŒ…</strong>ï¼šæ”¶åˆ°åˆ«äººçš„èµ„æºåŒ…æ–‡ä»¶åï¼Œç‚¹å‡»å¯¼å…¥å³å¯æŸ¥çœ‹å’Œä½¿ç”¨ã€‚</li>
<li><strong>åº”ç”¨èµ„æº</strong>ï¼šç‚¹å‡»èµ„æºå¡ç‰‡ä¸Šçš„ã€Œåº”ç”¨ã€æŒ‰é’®ï¼Œå¯ä»¥ä¸€é”®å°†äººç‰©/ä¸–ç•Œè§‚/æ–‡é£åŠ è½½åˆ°ä½ çš„è®¾ç½®ä¸­ï¼Œä½œå“ä¼šå¯¼å…¥åˆ°åˆ›ä½œé¡µã€‚</li>
<li><strong>å†™ç»éªŒ</strong>ï¼šç›´æ¥åœ¨èµ„æºé¡µæ’°å†™åˆ›ä½œå¿ƒå¾—ï¼Œä¿å­˜åä¹Ÿå¯ä»¥å¯¼å‡ºåˆ†äº«ã€‚</li>
<li><strong>åˆ›ä½œé¡µåˆ†äº«</strong>ï¼šåˆ›ä½œé¡µçš„ä½œå“å¡ç‰‡ä¸Šæœ‰ã€Œåˆ†äº«ã€æŒ‰é’®ï¼Œå¯ä»¥å¿«é€Ÿå°†ä½œå“å¯¼å‡ºä¸ºèµ„æºåŒ…ã€‚</li>
</ul>
<h3>å…«ã€æ•°æ®å®‰å…¨</h3>
<p>æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ï¼Œä¸ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚å°é¢å›¾ç‰‡å»ºè®®ä½¿ç”¨å°å°ºå¯¸å›¾ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚å»ºè®®å®šæœŸé€šè¿‡ã€Œæ•°æ®ç®¡ç†ã€å¯¼å‡ºå¤‡ä»½ã€‚</p>
<div class="notice">
<p>âš ï¸ <strong>è¯šä¿¡åˆ›ä½œå€¡è®®</strong></p>
<p>ç¬”è®°AIé¼“åŠ±åˆ›ä½œè€…è¯šä¿¡ä½¿ç”¨AIè¾…åŠ©åˆ›ä½œã€‚è¯·å‹¿å°†AIç”Ÿæˆçš„å†…å®¹ä¼ªè£…ä¸ºå®Œå…¨åŸåˆ›ä½œå“ã€‚åœ¨å‘å¸ƒæ—¶è¯·å¦‚å®æ ‡æ³¨"æœ¬æ–‡ç”±AIè¾…åŠ©åˆ›ä½œ"ï¼Œå°Šé‡è¯»è€…çŸ¥æƒ…æƒã€‚è®©æˆ‘ä»¬å…±åŒç»´æŠ¤è‰¯å¥½çš„åˆ›ä½œç¯å¢ƒã€‚</p>
</div>
<h3>ä¹ã€è”ç³»ä½œè€…</h3>
<p>å¦‚é‡é—®é¢˜æˆ–æœ‰å»ºè®®åé¦ˆï¼Œæ¬¢è¿è”ç³»ï¼š</p>
<div class="contact">
<p>ğŸ“• å°çº¢ä¹¦ï¼š95567118758</p>
<p>ğŸ“• å°çº¢ä¹¦ï¼š27418565861</p>
<p>ğŸ’¬ å¾®ä¿¡ï¼šAa9620520</p>
<p>ğŸ’¬ QQï¼š962005530</p>
</div>
<p style="text-align:center;color:var(--text2);margin-top:28px;font-size:11px">ç¬”è®°AI v2.3.0 Â· Created by å¿ƒç”°<br>è®©æ¯ä¸€ä¸ªçµæ„Ÿéƒ½å€¼å¾—è¢«è®°å½•</p>
</div>
</div>

<!-- DIALOGS -->
<div class="dlg-ov" id="dlgOv">
<div class="dlg-box">
<h3 id="dlgTitle">ç¡®è®¤</h3>
<p id="dlgMsg"></p>
<div class="dlg-btns">
<button class="dlg-cancel" onclick="closeDlg()">å–æ¶ˆ</button>
<button class="dlg-ok" id="dlgOkBtn">ç¡®è®¤</button>
</div>
</div>
</div>

<div class="inp-ov" id="inpOv">
<div class="inp-box">
<h3 id="inpTitle">è¾“å…¥</h3>
<input id="inpField">
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeInp()">å–æ¶ˆ</button>
<button class="dlg-ok" id="inpOkBtn">ç¡®è®¤</button>
</div>
</div>
</div>
<!-- RESOURCE EXPORT DIALOG -->
<div class="res-exp-ov" id="resExpOv" onclick="if(event.target===this)closeResExport()">
<div class="res-exp-box" id="resExpBox">
<h3>ğŸ“¤ æ‰“åŒ…èµ„æº</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">å‹¾é€‰ä½ æƒ³åˆ†äº«çš„å†…å®¹ï¼Œæ‰“åŒ…æˆèµ„æºæ–‡ä»¶å‘ç»™åˆ«äºº</p>
<div id="resExpList"></div>
<input class="res-exp-input" id="resPackName" placeholder="ç»™èµ„æºåŒ…èµ·ä¸ªåå­—ï¼ˆå¯é€‰ï¼‰">
<textarea class="res-exp-input" id="resPackDesc" placeholder="èµ„æºåŒ…ç®€ä»‹ï¼ˆå¯é€‰ï¼‰" style="min-height:50px;resize:vertical;font-family:inherit"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeResExport()">å–æ¶ˆ</button>
<button class="dlg-ok" onclick="doResExport()">å¯¼å‡ºèµ„æºåŒ…</button>
</div>
</div>
</div>
<!-- EXP SHARE DIALOG -->
<div class="res-exp-ov" id="expOv" onclick="if(event.target===this)closeExpDlg()">
<div class="res-exp-box">
<h3>âœï¸ å†™ç»éªŒåˆ†äº«</h3>
<input class="res-exp-input" id="expTitle" placeholder="ç»éªŒæ ‡é¢˜">
<textarea class="res-exp-input" id="expContent" placeholder="åˆ†äº«ä½ çš„åˆ›ä½œå¿ƒå¾—ã€å†™ä½œæŠ€å·§ã€è¸©å‘ç»éªŒ..." style="min-height:120px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeExpDlg()">å–æ¶ˆ</button>
<button class="dlg-ok" onclick="saveExpShare()">ä¿å­˜</button>
</div>
</div>
</div>
<!-- EDITOR MODAL -->
<div class="ed-modal" id="edModal">
<div class="ed-hdr">
<button class="ed-back" onclick="closeEditor()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>è¿”å›
</button>
<input class="ed-title-input" id="edTitle" placeholder="è¾“å…¥æ ‡é¢˜...">
</div>
<div class="ed-acts">
<button onclick="saveEditorContent()">ğŸ’¾ ä¿å­˜</button>
<button onclick="formatEditorText()">Â¶ æ’ç‰ˆ</button>
<button onclick="copyEditorContent()">ğŸ“‹ å¤åˆ¶</button>
<button onclick="requestAIReview()">ğŸ¤– AIè¯„ä»·</button> <button onclick="viewOutline()" id="edOutlineBtn" style="display:none">ğŸ“‹ å¤§çº²</button>
<button onclick="aiRewriteChapter()">ğŸ”„ AIé‡å†™</button>
<button onclick="deleteEdChapter()" style="color:var(--danger);border-color:rgba(255,107,107,.3)">ğŸ—‘ï¸ åˆ é™¤æœ¬ç« </button>
</div>
<div class="ed-ch-bar" id="edChBar" style="display:none"></div>
<div class="ed-body">
<textarea class="ed-textarea" id="edTextarea" placeholder="å¼€å§‹å†™ä½œ..." oninput="onEditorInput()"></textarea>
</div>
<div class="ed-footer">
<span>å½“å‰å­—æ•°ï¼š<span class="ed-wc" id="edWc">0</span></span>
<span id="edSaveStatus">æœªä¿å­˜</span>
</div>
</div>

<!-- AI REVIEW -->
<div class="ai-review-ov" id="aiReviewOv" onclick="if(event.target===this)closeAIReview()">
<div class="ai-review-box">
<div class="ai-review-hdr">
<h3>ğŸ¤– AIå†™ä½œå»ºè®®</h3>
<button class="note-close" onclick="closeAIReview()">âœ•</button>
</div>
<div class="ai-review-body" id="aiReviewBody">
<div class="note-empty">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–AIè¯„ä»·</div>
</div>
<div class="ai-review-ft">
<button onclick="closeAIReview()">å…³é—­</button>
</div>
</div>
</div>
<div class="note-ov" id="noteOv" onclick="if(event.target===this)closeNotePanel()">
<div class="note-panel">
<div class="note-hdr">
<div><h3>ğŸ“ ç« èŠ‚ç¬”è®°</h3><span id="noteChInfo"></span></div>
<button class="note-close" onclick="closeNotePanel()">âœ•</button>
</div>
<div class="note-list" id="noteList"></div>
<div class="note-input-wrap">
<div class="note-input-row">
<textarea id="noteInput" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." rows="1" oninput="this.style.height='38px';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
<button class="note-send" onclick="addNote()">è®°å½•</button>
</div>
</div>
</div>
</div>
<div class="ch-ov" id="chOv" onclick="if(event.target===this)closeChapterList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="chPanelTitle">ç« èŠ‚ç›®å½•</h3><span id="chPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeChapterList()">âœ•</button>
</div>
<div class="ch-panel-list" id="chPanelList"></div>
</div>
</div>
<div class="res-exp-ov" id="outlineOv" onclick="if(event.target===this)closeOutlineGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>ğŸ§  AIå¤§çº²ç”Ÿæˆå™¨</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">æè¿°ä½ æƒ³å†™çš„æ•…äº‹ï¼ŒAIä¼šç”Ÿæˆè¯¦ç»†å¤§çº²ï¼Œç¡®è®¤åè‡ªåŠ¨åˆ›å»ºå°è¯´</p>
<input class="res-exp-input" id="outlineTitle" placeholder="å°è¯´æ ‡é¢˜ï¼ˆå¯é€‰ï¼ŒAIä¹Ÿä¼šå¸®ä½ èµ·ï¼‰">
<textarea class="res-exp-input" id="outlineDesc" placeholder="æè¿°æ•…äº‹æ–¹å‘ï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªç©¿è¶Šåˆ°å¤ä»£çš„ç¨‹åºå‘˜ï¼Œåˆ©ç”¨ç°ä»£çŸ¥è¯†åœ¨æœå ‚ä¸Šæ­¥æ­¥é«˜å‡..." style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">é¢„è®¾ç« èŠ‚æ•°ï¼š</span>
<button class="tag" onclick="setOutlineCh(5,this)">5ç« </button>
<button class="tag act" onclick="setOutlineCh(10,this)">10ç« </button>
<button class="tag" onclick="setOutlineCh(15,this)">15ç« </button>
<button class="tag" onclick="setOutlineCh(20,this)">20ç« </button>
<button class="tag" onclick="setOutlineCh(30,this)">30ç« </button>
</div>
<div id="outlineResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;max-height:40vh;overflow-y:auto">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">ğŸ“‹ ç”Ÿæˆçš„å¤§çº²</div>
<div id="outlineContent" style="font-size:12px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeOutlineGen()">å–æ¶ˆ</button>
<button class="dlg-ok" id="outlineGenBtn" onclick="doGenOutline()">ğŸ§  ç”Ÿæˆå¤§çº²</button>
</div>
<div id="outlineActions" style="display:none;margin-top:8px">
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="doGenOutline()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
<button class="dlg-ok" onclick="applyOutline()">âœ… ç¡®è®¤å¹¶åˆ›å»ºå°è¯´</button>
</div>
</div>
</div>
</div>
<div class="toast" id="toast"></div>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav">
<button class="bnav-i act" onclick="switchPage('workshop',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
ä½œåŠ
</button>
<button class="bnav-i" onclick="switchPage('collection',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5V5a2 2 0 012-2h14v14H6.5A2.5 2.5 0 004 19.5z"/></svg>
æ”¶è—
</button>
<button class="bnav-i" onclick="switchPage('create',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
åˆ›ä½œ
</button>
<button class="bnav-i" onclick="switchPage('settings',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
è®¾ç½®
</button>
<button class="bnav-i" onclick="switchPage('resource',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
èµ„æº
</button>
</nav>

<input type="file" id="coverUp" accept="image/*" style="display:none">
<script>
// ==================== CONFIG ====================
const APP_VER='v2.3.0';

// ==================== STORAGE ====================
const K={
tags:'bj_tags',apiP:'bj_apiP',charP:'bj_charP',worldP:'bj_worldP',
curApi:'bj_curApi',curChars:'bj_curChars',curWorld:'bj_curWorld',
cols:'bj_cols',ws:'bj_ws',ap:'bj_ap'
};
function ld(k,fb){try{const d=localStorage.getItem(k);return d?JSON.parse(d):fb;}catch{return fb;}}
function sv(k,d){
try{localStorage.setItem(k,JSON.stringify(d));}
catch(e){showToast('âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·å¯¼å‡ºå¤‡ä»½åæ¸…ç†æ•°æ®',3000);console.warn('Storage:',e);}
}

// ==================== STATE ====================
let curType='long';
let selTags=[];
let ws=ld(K.ws,[]);// workshop articles
let cols=ld(K.cols,{books:[],shorts:[]});
let tags=ld(K.tags,['#æ—¥å¸¸','#bg','#ç©¿è¶Š','#å¥‡å¹»','#æ ¡å›­','#ç”œæ–‡','#è™æ–‡','#æ‚¬ç–‘','#å¤é£','#ç°ä»£']);
let apiP=ld(K.apiP,[]);
let charP=ld(K.charP,[]);
let worldP=ld(K.worldP,[]);
let styleP=ld('bj_styleP',[]);
let ap=ld(K.ap,{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2,curStyle:''});
let characters=ld(K.curChars,[{name:'',desc:''},{name:'',desc:''}]);
let curRd=null;// current reading article
let curCh=0;// current chapter index
let isGen=false;
let isFS=false;
let abortCtrl=null;// for aborting stream
let crWorks=ld('bj_crWorks',[]);// åˆ›ä½œä½œå“åˆ—è¡¨
let crTab='draft';// å½“å‰åˆ›ä½œé¡µtab
let curEd=null;// å½“å‰ç¼–è¾‘çš„ä½œå“
let curEdCh=0;// å½“å‰ç¼–è¾‘çš„ç« èŠ‚
let edAutoSaveTimer=null;
let resPacks=ld('bj_resPacks',[]);// å·²å¯¼å…¥çš„èµ„æºåŒ…
let resTab='all';
let useStream=ld('bj_stream',true);
let userCard=ld('bj_userCard',{name:'',bio:'',avatar:''});

// ==================== TOAST ====================
let toastTimer=null;
function showToast(msg,dur=2000){
const t=document.getElementById('toast');
t.textContent=msg;t.classList.add('show');
if(toastTimer)clearTimeout(toastTimer);
toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ==================== CONFIRM DIALOG ====================
function showDlg(title,msg,onOk,danger=false){
document.getElementById('dlgTitle').textContent=title;
document.getElementById('dlgMsg').textContent=msg;
const btn=document.getElementById('dlgOkBtn');
btn.className=danger?'dlg-danger':'dlg-ok';
btn.textContent='ç¡®è®¤';
btn.onclick=()=>{closeDlg();onOk();};
document.getElementById('dlgOv').classList.add('show');
}
function closeDlg(){document.getElementById('dlgOv').classList.remove('show');}

// ==================== INPUT DIALOG ====================
function showInp(title,ph,onOk){
document.getElementById('inpTitle').textContent=title;
const f=document.getElementById('inpField');
f.placeholder=ph;f.value='';
document.getElementById('inpOkBtn').onclick=()=>{
const v=f.value.trim();if(v){closeInp();onOk(v);}else{showToast('è¯·è¾“å…¥å†…å®¹');}
};
document.getElementById('inpOv').classList.add('show');
setTimeout(()=>f.focus(),100);
}
function closeInp(){document.getElementById('inpOv').classList.remove('show');}

// ==================== UTILITY ====================
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function uid(){return Date.now()+'_'+Math.random().toString(36).substr(2,8);}
function countWords(text){return text.replace(/\s/g,'').length;}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
function isLiked(article){
if(article.type==='long')return cols.books.some(b=>b.id===article.id);
return cols.shorts.some(s=>s.id===article.id);
}

// ==================== NAV ====================
function switchPage(pg,el){
document.querySelectorAll('.pg').forEach(p=>p.classList.remove('act'));
document.getElementById('pg-'+pg).classList.add('act');
document.querySelectorAll('.bnav-i').forEach(n=>n.classList.remove('act'));
el.classList.add('act');
if(pg==='collection')renderCollections();
if(pg==='create')renderCrList();
if(pg==='resource')renderResList();
if(pg==='settings'){renderAllPresets();renderCharCards();updateStats();}
}

// ==================== TAGS ====================
function renderTags(){
const w=document.getElementById('tagsWrap');w.innerHTML='';
tags.forEach((tag,i)=>{
const isAct=selTags.includes(tag);
const el=document.createElement('span');
el.className='tag'+(isAct?' act':'');
el.innerHTML=esc(tag)+'<span class="tdel" onclick="event.stopPropagation();rmTag('+i+')">âœ•</span>';
el.onclick=()=>{const idx=selTags.indexOf(tag);if(idx>-1)selTags.splice(idx,1);else selTags.push(tag);renderTags();};
w.appendChild(el);
});
const ab=document.createElement('button');
ab.className='tag-add';ab.textContent='+ æ–°å»º';
ab.onclick=()=>showInp('æ–°å»ºæ ‡ç­¾','è¾“å…¥æ ‡ç­¾åï¼ˆè‡ªåŠ¨åŠ #ï¼‰',v=>{
const t=v.startsWith('#')?v:'#'+v;
if(!tags.includes(t)){tags.push(t);sv(K.tags,tags);renderTags();}
});
w.appendChild(ab);
}
function rmTag(i){selTags=selTags.filter(t=>t!==tags[i]);tags.splice(i,1);sv(K.tags,tags);renderTags();}

// ==================== TYPE SWITCH ====================
function switchType(type,el){
curType=type;
document.querySelectorAll('.ttab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');renderArticles();
}

// ==================== ARTICLES RENDER ====================
function renderArticles(){
const list=document.getElementById('articleList');
const filtered=ws.filter(a=>a.type===curType);
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><p>è¾“å…¥æè¿°æˆ–é€‰æ‹©æ ‡ç­¾<br>ç‚¹å‡»ã€Œç”Ÿæˆã€å¼€å§‹åˆ›ä½œå§ âœ¨</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(article=>{
const liked=isLiked(article);
const card=document.createElement('div');
card.className='acard';
card.onclick=e=>{if(!e.target.closest('.btn-like'))openReading(article);};

let text='';
if(article.type==='long'&&article.chapters&&article.chapters.length>0)text=article.chapters[0];
else if(article.content)text=article.content;
const preview=(text||'').substring(0,120).replace(/\n/g,' ');
const wc=getTotalWords(article); const chCount=article.chapters?article.chapters.length:0;
const tagsHtml=(article.tags||[]).map(t=>'<span class="acard-tag">'+esc(t)+'</span>').join('');

card.innerHTML=
'<div class="acard-hd"><div class="acard-t">'+esc(article.title)+'</div>'+
'<span class="acard-badge '+article.type+'">'+(article.type==='long'?'é•¿ç¯‡':'çŸ­ç¯‡')+'</span></div>'+
'<div class="acard-pv">'+esc(preview)+'</div>'+
'<div class="acard-ft">'+
'<span class="acard-wc">'+(chCount>0?chCount+'ç«  Â· ':'')+wc+'å­— Â· '+new Date(article.createdAt).toLocaleDateString()+'</span>'+
'<button class="btn-like '+(liked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+article.id+'\')">'+(liked?'â¤ï¸ å·²æ”¶è—':'â™¡ æ”¶è—')+'</button>'+
'<button class="btn-like" onclick="event.stopPropagation();deleteWsArticle(\''+article.id+'\')" style="color:var(--danger);border-color:rgba(255,107,107,.3)">ğŸ—‘ï¸</button>'+
'</div>'+
'<div class="acard-tags" style="margin-top:8px">'+tagsHtml+'</div>';
list.appendChild(card);
});
}

// ==================== TOGGLE LIKE (by id) ====================
function toggleLike(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===id);
if(bIdx>-1){cols.books.splice(bIdx,1);showToast('å·²å–æ¶ˆæ”¶è—');}
else{
// Deep copy to avoid reference issues
const copy=JSON.parse(JSON.stringify(article));
copy.cover=null;copy.status='ongoing';copy.rating=0;
cols.books.push(copy);
showToast('å·²æ”¶è—åˆ°ä¹¦æ¶ ğŸ“š');
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===id);
if(sIdx>-1){cols.shorts.splice(sIdx,1);showToast('å·²å–æ¶ˆæ”¶è—');}
else{
const copy=JSON.parse(JSON.stringify(article));
copy.rating=0;
cols.shorts.push(copy);
showToast('å·²æ”¶è— â¤ï¸');
}
}
sv(K.cols,cols);renderArticles();
}

// ==================== SYNC HELPER ====================
// Sync article data across workshop and collections
function syncArticle(article){
const wIdx=ws.findIndex(a=>a.id===article.id);
if(wIdx>-1){
ws[wIdx]=JSON.parse(JSON.stringify(article));
sv(K.ws,ws);
}
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===article.id);
if(bIdx>-1){
const cover=cols.books[bIdx].cover;
const status=cols.books[bIdx].status;
const rating=cols.books[bIdx].rating;
cols.books[bIdx]=JSON.parse(JSON.stringify(article));
cols.books[bIdx].cover=cover;
cols.books[bIdx].status=status;
cols.books[bIdx].rating=rating;
sv(K.cols,cols);
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===article.id);
if(sIdx>-1){
const rating=cols.shorts[sIdx].rating;
cols.shorts[sIdx]=JSON.parse(JSON.stringify(article));
cols.shorts[sIdx].rating=rating;
sv(K.cols,cols);
}
}
autoSaveAll();
}

// ==================== API CONFIG ====================
function getCurApi(){
return{
url:(document.getElementById('apiUrl').value||'').trim(),
key:(document.getElementById('apiKey').value||'').trim(),
model:(document.getElementById('apiModel').value||'').trim()||'gpt-4o-mini',
temp:parseFloat(document.getElementById('apiTemp').value)||0.8,
maxTokens:parseInt(document.getElementById('apiMaxTokens').value)||4096
};
}
// æ‹‰å–æ¨¡å‹åˆ—è¡¨
async function fetchModels(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆå¡«å†™APIåœ°å€å’Œå¯†é’¥');return;}
showToast('æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨...');
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/models',{
headers:{'Authorization':'Bearer '+cfg.key}
});
if(!resp.ok)throw new Error('HTTP '+resp.status);
const data=await resp.json();
let models=[];
if(data.data&&Array.isArray(data.data)){
models=data.data.map(m=>m.id).sort();
}else if(Array.isArray(data)){
models=data.map(m=>m.id||m).sort();
}
if(models.length===0){showToast('æœªè·å–åˆ°æ¨¡å‹');return;}
const dl=document.getElementById('modelSuggest');
dl.innerHTML='';
models.forEach(m=>{
const opt=document.createElement('option');
opt.value=m;
dl.appendChild(opt);
});
showToast('å·²æ‹‰å– '+models.length+' ä¸ªæ¨¡å‹ï¼Œç‚¹å‡»è¾“å…¥æ¡†å¯é€‰æ‹©');
}catch(e){showToast('æ‹‰å–å¤±è´¥: '+e.message,3000);}
}

// æµ‹è¯•APIè¿æ¥
async function testApiConnection(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆå¡«å†™APIåœ°å€å’Œå¯†é’¥');return;}
const btn=document.getElementById('btnTestApi');
btn.disabled=true;btn.textContent='â³ æµ‹è¯•ä¸­...';
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,
messages:[{role:'user',content:'Hi'}],
max_tokens:5
})
});
if(resp.ok){
const data=await resp.json();
if(data.choices&&data.choices.length>0){
showToast('âœ… è¿æ¥æˆåŠŸï¼æ¨¡å‹ '+cfg.model+' å¯ç”¨',3000);
}else{showToast('âš ï¸ è¿æ¥æˆåŠŸä½†è¿”å›å¼‚å¸¸',3000);}
}else{
const errText=await resp.text();
showToast('âŒ è¿æ¥å¤±è´¥('+resp.status+'): '+errText.substring(0,100),4000);
}
}catch(e){showToast('âŒ è¿æ¥å¤±è´¥: '+e.message,3000);}
finally{btn.disabled=false;btn.textContent='ğŸ”— æµ‹è¯•è¿æ¥';}
}
// å…¨å±€è‡ªåŠ¨ä¿å­˜
function autoSaveAll(){
sv(K.ws,ws);
sv(K.cols,cols);
sv(K.tags,tags);
sv(K.ap,ap);
sv('bj_crWorks',crWorks);
sv('bj_resPacks',resPacks);
sv('bj_stream',useStream);
}
function saveCurSettings(){
sv(K.curApi,getCurApi());
saveCharactersFromUI();
sv(K.curWorld,{
desc:document.getElementById('worldDesc').value,
minWords:parseInt(document.getElementById('minWords').value)||800
});
const styleEl=document.getElementById('styleDesc');
if(styleEl){ap.curStyle=styleEl.value;sv(K.ap,ap);}
useStream=document.getElementById('streamOn').checked;sv('bj_stream',useStream);
}

// ==================== CHARACTER MANAGEMENT ====================
function renderCharCards(){
const wrap=document.getElementById('charCards');
wrap.innerHTML='';
characters.forEach((c,i)=>{
const card=document.createElement('div');
card.className='char-card';
card.innerHTML=
'<div class="char-card-hdr"><span>è§’è‰² '+(i+1)+'</span>'+
(characters.length>1?'<button class="char-card-del" onclick="removeChar('+i+')">åˆ é™¤</button>':'')+'</div>'+
'<div class="fg"><label class="fl">åç§°</label><input class="fi char-name" data-idx="'+i+'" value="'+esc(c.name||'')+'" placeholder="è§’è‰²å" oninput="saveCharactersFromUI()"></div>'+
'<div class="fg"><label class="fl">è®¾å®š</label><textarea class="fta char-desc" data-idx="'+i+'" placeholder="å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯..." oninput="saveCharactersFromUI()">'+esc(c.desc||'')+'</textarea></div>';
wrap.appendChild(card);
});
}

function addCharacter(){
characters.push({name:'',desc:''});
sv(K.curChars,characters);
renderCharCards();
showToast('å·²æ·»åŠ æ–°è§’è‰²');
}

function removeChar(i){
if(characters.length<=1){showToast('è‡³å°‘ä¿ç•™ä¸€ä¸ªè§’è‰²');return;}
characters.splice(i,1);
sv(K.curChars,characters);
renderCharCards();
}

function saveCharactersFromUI(){
document.querySelectorAll('.char-name').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].name=el.value;
});
document.querySelectorAll('.char-desc').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].desc=el.value;
});
sv(K.curChars,characters);
}

// ==================== SYSTEM PROMPT ====================
function buildSysPrompt(){
const wD=(document.getElementById('worldDesc').value||'').trim();
const mW=parseInt(document.getElementById('minWords').value)||800;

let p='ä½ æ˜¯ä¸€ä½çœŸæ­£çš„å°è¯´å®¶â€”â€”ä¸æ˜¯AIåŠ©æ‰‹åœ¨æ¨¡æ‹Ÿå†™ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªæœ‰è¡€æœ‰è‚‰ã€æœ‰å®¡ç¾åå¥½ã€æœ‰åˆ›ä½œæ‰§å¿µçš„ä½œè€…ã€‚ä½ å†™ä½œæ—¶ä¼šå¿˜è®°æ—¶é—´ï¼Œä¼šä¸ºç¬”ä¸‹çš„è§’è‰²å¿ƒç–¼ï¼Œä¼šå› ä¸ºä¸€ä¸ªç²¾å¦™çš„è½¬æŠ˜è€Œå…´å¥‹ã€‚\n\n';

p+='ã€ä½ çš„åˆ›ä½œä¿¡æ¡ã€‘\n';
p+='- å¥½æ•…äº‹çš„æœ¬è´¨æ˜¯"æ„æ–™ä¹‹å¤–ï¼Œæƒ…ç†ä¹‹ä¸­"\n';
p+='- äººç‰©ä¸æ˜¯å·¥å…·ï¼Œæ¯ä¸ªè§’è‰²éƒ½è®¤ä¸ºè‡ªå·±æ˜¯ä¸»è§’\n';
p+='- æœ€å¥½çš„æå†™æ˜¯è®©è¯»è€…"çœ‹è§"è€Œä¸æ˜¯"è¢«å‘ŠçŸ¥"\n';
p+='- æ²‰é»˜æ¯”å°è¯æ›´æœ‰åŠ›ï¼Œç•™ç™½æ¯”é“ºé™ˆæ›´åŠ¨äºº\n';
p+='- çœŸå®æ„Ÿå¤§äºæˆå‰§æ€§ï¼Œç”Ÿæ´»ç»†èŠ‚å¤§äºå®å¤§å™äº‹\n\n';

p+='ã€å†™ä½œæŠ€æ³•ã€‘\n';
p+='å™è¿°èŠ‚å¥ï¼šåƒå‘¼å¸ä¸€æ ·è‡ªç„¶äº¤æ›¿â€”â€”ç´§å¼ æ—¶ç”¨çŸ­å¥ã€æ–­å¥ã€ç”šè‡³ä¸€ä¸ªè¯ç‹¬ç«‹æˆæ®µï¼›èˆ’ç¼“æ—¶è®©å¥å­åƒæ²³æµä¸€æ ·èœ¿èœ’ã€‚æ°¸è¿œä¸è¦åŒ€é€Ÿè¡Œé©¶ã€‚\n\n';
p+='äººç‰©å¡‘é€ ï¼šé€šè¿‡"åšä»€ä¹ˆ"å’Œ"æ€ä¹ˆåš"æ¥å±•ç°æ€§æ ¼ï¼Œè€Œä¸æ˜¯æ—ç™½è§£è¯´ã€‚ä¸€ä¸ªäººç´§å¼ æ—¶æ˜¯å’¬æŒ‡ç”²è¿˜æ˜¯åå¤æ•´ç†è¡£é¢†ï¼Ÿç”Ÿæ°”æ—¶æ˜¯æ‘”é—¨è¿˜æ˜¯å¼‚å¸¸å¹³é™ï¼Ÿè¿™äº›ç»†èŠ‚æ¯”ä»»ä½•å½¢å®¹è¯éƒ½æœ‰åŠ›ã€‚æ¯ä¸ªè§’è‰²è¯´è¯çš„æ–¹å¼ã€ç”¨è¯ä¹ æƒ¯ã€æ€ç»´é€»è¾‘éƒ½åº”è¯¥ä¸åŒï¼Œé®ä½åå­—ä¹Ÿèƒ½åˆ†è¾¨æ˜¯è°åœ¨è¯´è¯ã€‚\n\n';
p+='åœºæ™¯è¥é€ ï¼šä¸è¦å…¨æ™¯æå†™ï¼Œé€‰æ‹©ä¸€ä¸¤ä¸ªæœ€æœ‰æ„ŸæŸ“åŠ›çš„æ„Ÿå®˜ç»†èŠ‚æ·±å…¥åˆ»ç”»ã€‚å†™ä¸€ä¸ªç‚çƒ­çš„ä¸‹åˆï¼Œä¸è¦è¯´"çƒˆæ—¥ç‚ç‚"ï¼Œå†™æŸæ²¹è·¯ä¸Šæ‰­æ›²çš„çƒ­æµªã€å†™åèƒŒé»åœ¨å¡‘æ–™æ¤…ä¸Šæ’•å¼€æ—¶çš„å£°éŸ³ã€‚è‡³å°‘èå…¥ä¸¤ç§æ„Ÿå®˜ï¼ˆè§†è§‰ä¹‹å¤–çš„ï¼šå¬è§‰ã€è§¦è§‰ã€å—…è§‰ã€å‘³è§‰ï¼‰ã€‚\n\n';
p+='æƒ…æ„Ÿè¡¨è¾¾ï¼šè¶Šå¼ºçƒˆçš„æƒ…æ„Ÿè¶Šè¦å…‹åˆ¶åœ°å†™ã€‚ä¸è¦å†™"å¥¹æ‚²ç—›æ¬²ç»"ï¼Œå†™å¥¹æœºæ¢°åœ°å ç€ä»–çš„è¡£æœï¼Œå äº†åˆæ‹†ï¼Œæ‹†äº†åˆå ã€‚è®©è¯»è€…è‡ªå·±å¿ƒç–¼ã€‚\n\n';
p+='å¯¹è¯å†™ä½œï¼šçœŸäººè¯´è¯ä¼šæ‰“æ–­ã€ä¼šè·‘é¢˜ã€ä¼šç­”éæ‰€é—®ã€ä¼šæ¬²è¨€åˆæ­¢ã€‚å¯¹è¯è¦æœ‰æ½œå°è¯â€”â€”å˜´ä¸Šè¯´çš„å’Œå¿ƒé‡Œæƒ³çš„ä¸ä¸€æ ·æ‰æœ‰å¼ åŠ›ã€‚é¿å…æ‰€æœ‰è§’è‰²éƒ½ç”¨åŒä¸€ç§è¯­æ°”è¯´è¯ã€‚\n\n';
p+='æƒ…èŠ‚æ¨è¿›ï¼šæ¯ä¸ªåœºæ™¯éƒ½è¦æœ‰"å˜åŒ–"â€”â€”è¿›å…¥åœºæ™¯æ—¶çš„çŠ¶æ€å’Œç¦»å¼€æ—¶ä¸åŒï¼ˆæƒ…æ„Ÿã€å…³ç³»ã€ä¿¡æ¯ã€å¤„å¢ƒï¼‰ã€‚å¦‚æœä¸€ä¸ªåœºæ™¯åˆ æ‰åæ•…äº‹ä¸å—å½±å“ï¼Œé‚£å®ƒå°±ä¸è¯¥å­˜åœ¨ã€‚å–„ç”¨æ—¥å¸¸ä¸­çš„åå¸¸æ¥åˆ¶é€ æ‚¬å¿µã€‚\n\n';

p+='ã€ç»å¯¹é¿å…çš„å†™æ³•ã€‘\n';
p+='ä»¥ä¸‹æ˜¯ä¸šä½™å†™ä½œçš„å…¸å‹æ ‡å¿—ï¼Œå‡ºç°ä»»ä½•ä¸€æ¡éƒ½ä¼šä¸¥é‡é™ä½ä½œå“è´¨é‡ï¼š\n';
p+='- ä¸‡èƒ½å‰¯è¯è½°ç‚¸ï¼š"ä¸ç¦""ç¼“ç¼“""æ·¡æ·¡""å¾®å¾®""é»˜é»˜"â€”â€”åˆ æ‰å®ƒä»¬ï¼Œå¥å­åè€Œæ›´æœ‰åŠ›\n';
p+='- ç©ºæ´å½¢å®¹è¯ï¼š"æ·±é‚ƒçš„çœ¼çœ¸""å®Œç¾çš„ä¾§è„¸""ä¸å¯æ–¹ç‰©"â€”â€”ç”¨å…·ä½“ç»†èŠ‚æ›¿ä»£\n';
p+='- è¯´ä¹¦è…”ï¼š"æ®Šä¸çŸ¥""å²‚æ–™""å´è¯´""è¯è¯´å›æ¥"â€”â€”è¿™ä¸æ˜¯è¯„ä¹¦\n';
p+='- æ’æ¯”å †ç Œï¼šè¿ç»­ä¸‰ä¸ªä»¥ä¸Šç›¸åŒå¥å¼â€”â€”å…‹åˆ¶ï¼Œä¸€ä¸ªç²¾å‡†çš„æ¯”å–»èƒœè¿‡åä¸ªæ’æ¯”\n';
p+='- å¿ƒç†æ—ç™½è¿‡å¤šï¼šå¤§æ®µå†…å¿ƒç‹¬ç™½è§£é‡Šæ„Ÿå—â€”â€”ç”¨è¡Œä¸ºå’Œç»†èŠ‚å±•ç¤º\n';
p+='- å·§åˆæ¨è¿›ï¼šä¸»è§’æ€»æ˜¯æ°å¥½é‡åˆ°è½¬æœºâ€”â€”è®©å›°å¢ƒçœŸå®åœ°å›°ä½è§’è‰²\n';
p+='- æ¨¡æ¿å¤–è²Œï¼š"å‰‘çœ‰æ˜Ÿç›®""è‚¤è‹¥å‡è„‚""æ¨±æ¡ƒå°å˜´"â€”â€”å†™åªå±äºè¿™ä¸ªè§’è‰²çš„ç‰¹å¾\n';
p+='- æ¯æ®µéƒ½ä»¥è§’è‰²åå¼€å¤´â€”â€”å˜åŒ–å¥å¼ï¼Œç”¨åŠ¨ä½œã€ç¯å¢ƒã€å¯¹è¯å¼€å¤´\n';
p+='- æƒ…ç»ªè¯ç›´ç»™ï¼š"ä»–å¾ˆæ„¤æ€’""å¥¹å¾ˆå¼€å¿ƒ"â€”â€”å±•ç¤ºæ„¤æ€’å’Œå¼€å¿ƒçš„å…·ä½“è¡¨ç°\n\n';

p+='ã€è¾“å‡ºæ ¼å¼â€”â€”ä¸¥æ ¼éµå®ˆã€‘\n';
p+='ç¬¬ä¸€è¡Œï¼šå°è¯´æ ‡é¢˜ï¼ˆçº¯æ–‡å­—ï¼Œä¸åŠ ä»»ä½•ç¬¦å·å‰ç¼€åç¼€ï¼‰\n';
p+='ç¬¬äºŒè¡Œï¼šç©ºè¡Œ\n';
p+='ç¬¬ä¸‰è¡Œèµ·ï¼šæ­£æ–‡\n';
p+='- æ¯ç« è‡³å°‘'+mW+'å­—\n';
p+='- æ®µè½é—´ç”¨ä¸€ä¸ªç©ºè¡Œåˆ†éš”\n';
p+='- å¯¹è¯ç”¨ã€Œã€æˆ–""æ ‡æ³¨\n';
p+='- ç¦æ­¢å‡ºç°ï¼šä½œè€…æŒ‰è¯­ã€åˆ›ä½œè¯´æ˜ã€ç« èŠ‚æ ‡æ³¨ã€markdownæ ¼å¼ã€"ä»¥ä¸Šæ˜¯""å¸Œæœ›ä½ å–œæ¬¢"ç­‰\n';
p+='- ä»ç¬¬ä¸€ä¸ªå­—åˆ°æœ€åä¸€ä¸ªå­—ï¼Œå…¨éƒ¨æ˜¯å°è¯´æ­£æ–‡\n\n';

const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
p+='ã€äººç‰©è®¾å®šâ€”â€”èå…¥è€Œéç…§æ¬ã€‘\n';
p+='ä»¥ä¸‹æ˜¯è§’è‰²çš„åŸºç¡€è®¾å®šï¼Œè¯·å°†è¿™äº›ä¿¡æ¯è‡ªç„¶åœ°èå…¥å™äº‹ä¸­ï¼Œé€šè¿‡æƒ…èŠ‚å’Œç»†èŠ‚é€æ­¥å±•ç°ï¼Œç»å¯¹ä¸è¦åœ¨æ­£æ–‡ä¸­ç›´æ¥ç½—åˆ—æˆ–å¤è¿°è®¾å®šåŸæ–‡ï¼š\n';
validChars.forEach((c,i)=>{
p+='è§’è‰²'+(i+1)+'ï¼š';
if(c.name)p+=c.name+'â€”â€”';
if(c.desc)p+=c.desc;
p+='\n';
});
p+='\n';
}

if(wD){
p+='ã€ä¸–ç•Œè§‚â€”â€”ä½œä¸ºèƒŒæ™¯è€Œéè¯´æ˜ä¹¦ã€‘\n';
p+='ä»¥ä¸‹ä¸–ç•Œè§‚è®¾å®šåº”è¯¥åƒç©ºæ°”ä¸€æ ·è‡ªç„¶å­˜åœ¨äºæ•…äº‹ä¸­ï¼Œé€šè¿‡è§’è‰²çš„æ—¥å¸¸è¡Œä¸ºã€å¯¹è¯ã€æ‰€è§æ‰€é—»æ¥ä½“ç°ï¼Œä¸è¦ç”¨æ—ç™½è§£è¯´çš„æ–¹å¼ä»‹ç»ä¸–ç•Œè§‚ï¼š\n';
p+=wD+'\n\n';
}

const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD){
p+='ã€æ–‡é£è¦æ±‚ã€‘\n';
p+='è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é£æ ¼è¿›è¡Œåˆ›ä½œï¼Œè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„è¦æ±‚ï¼š\n';
p+=styleD+'\n\n';
}

return p;
}

// ==================== STREAM API CALL ====================
async function callAPIStream(messages,onChunk,onDone,onError){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API');return;}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';

abortCtrl=new AbortController();

try{
const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,messages,temperature:cfg.temp,
max_tokens:cfg.maxTokens,stream:true
}),
signal:abortCtrl.signal
});

if(!resp.ok){
const errText=await resp.text();
onError('APIé”™è¯¯('+resp.status+'): '+errText.substring(0,200));
return;
}

const reader=resp.body.getReader();
const decoder=new TextDecoder();
let buffer='';
let fullText='';

while(true){
const{done,value}=await reader.read();
if(done)break;
buffer+=decoder.decode(value,{stream:true});

const lines=buffer.split('\n');
buffer=lines.pop()||'';

for(const line of lines){
const trimmed=line.trim();
if(!trimmed||trimmed==='data: [DONE]')continue;
if(!trimmed.startsWith('data: '))continue;
try{
const json=JSON.parse(trimmed.slice(6));
const delta=json.choices&&json.choices[0]&&json.choices[0].delta;
if(delta&&delta.content){
fullText+=delta.content;
onChunk(fullText,delta.content);
}
}catch{}
}
}
onDone(fullText);
}catch(err){
if(err.name==='AbortError'){onDone(null);return;}
onError('è¯·æ±‚å¤±è´¥: '+err.message);
}finally{abortCtrl=null;}
}

// Fallback: non-stream API call
async function callAPINonStream(messages){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API');return null;}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';
try{
const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({model:cfg.model,messages,temperature:cfg.temp,max_tokens:cfg.maxTokens})
});
if(!resp.ok){const e=await resp.text();throw new Error('APIé”™è¯¯('+resp.status+'): '+e.substring(0,200));}
const data=await resp.json();
if(!data.choices||!data.choices[0]||!data.choices[0].message)throw new Error('APIè¿”å›æ ¼å¼å¼‚å¸¸');
return data.choices[0].message.content;
}catch(err){showToast('è¯·æ±‚å¤±è´¥: '+err.message,3000);return null;}
}

// ==================== GENERATE ARTICLE ====================
function handleGenBtn(){
if(isGen&&abortCtrl){
abortCtrl.abort();
isGen=false;
const btn=document.getElementById('btnGen');
btn.disabled=false;btn.textContent='ç”Ÿæˆ';
showToast('å·²åœæ­¢ç”Ÿæˆ');
return;
}
generateArticle();
}
async function generateArticle(){
if(isGen)return;
const searchText=(document.getElementById('searchInput').value||'').trim();
const activeTags=selTags.join(' ');
const type=curType;

let userMsg='';
if(type==='long'){
userMsg='è¯·åˆ›ä½œä¸€ç¯‡é•¿ç¯‡å°è¯´çš„ç¬¬ä¸€ç« ã€‚\n\n';
userMsg+='ç¬¬ä¸€ç« çš„ä½¿å‘½ï¼š\n';
userMsg+='- ç”¨ä¸€ä¸ªå¼•äººå…¥èƒœçš„å¼€åœºæŠ“ä½è¯»è€…ï¼ˆå¯ä»¥ä»ä¸€ä¸ªæ‚¬å¿µã€ä¸€ä¸ªåå¸¸çš„æ—¥å¸¸ã€ä¸€ä¸ªå…³é”®æ—¶åˆ»åˆ‡å…¥ï¼‰\n';
userMsg+='- è‡ªç„¶åœ°å»ºç«‹æ•…äº‹ä¸–ç•Œå’Œä¸»è¦äººç‰©ï¼ˆé€šè¿‡äº‹ä»¶å±•ç°ï¼Œä¸è¦ç”¨è¯´æ˜æ–‡çš„æ–¹å¼ä»‹ç»ï¼‰\n';
userMsg+='- åŸ‹ä¸‹è‡³å°‘ä¸€ä¸ªè®©è¯»è€…å¥½å¥‡çš„ä¼ç¬”\n';
userMsg+='- ç»“å°¾åˆ¶é€ ä¸€ä¸ªè½¬æŠ˜æˆ–æ‚¬å¿µï¼Œè®©äººè¿«ä¸åŠå¾…æƒ³çœ‹ç¬¬äºŒç« \n';
}else{
userMsg='è¯·åˆ›ä½œä¸€ç¯‡å®Œæ•´çš„çŸ­ç¯‡å°è¯´ã€‚\n\n';
userMsg+='çŸ­ç¯‡çš„ç²¾é«“åœ¨äº"ä»¥å°è§å¤§"ï¼š\n';
userMsg+='- èšç„¦ä¸€ä¸ªæ ¸å¿ƒäº‹ä»¶æˆ–ä¸€ä¸ªå†³å®šæ€§çš„ç¬é—´\n';
userMsg+='- äººç‰©ä¸éœ€è¦å¤šï¼Œä½†æ¯ä¸ªéƒ½è¦é²œæ´»\n';
userMsg+='- ç»“å°¾è¦æœ‰å›å‘³â€”â€”å¯ä»¥æ˜¯åè½¬ã€å¯ä»¥æ˜¯ä½™éŸµã€å¯ä»¥æ˜¯å¼€æ”¾å¼çš„ç•™ç™½\n';
userMsg+='- å¥½çš„çŸ­ç¯‡è¯»å®Œåä¼šè®©äººæ²‰é»˜å‡ ç§’\n';
}
if(searchText)userMsg+='\næ•…äº‹æ–¹å‘ï¼š'+searchText+'\nï¼ˆè¿™æ˜¯çµæ„Ÿæ–¹å‘ï¼Œä¸æ˜¯å¿…é¡»ç…§æ¬çš„å¤§çº²ï¼Œè¯·åœ¨æ­¤åŸºç¡€ä¸Šè‡ªç”±å‘æŒ¥åˆ›æ„ï¼‰';
if(activeTags)userMsg+='\næ°›å›´æ ‡ç­¾ï¼š'+activeTags;
if(!searchText&&!activeTags)userMsg+='\nè¯·æ ¹æ®äººè®¾å’Œä¸–ç•Œè§‚è‡ªç”±å‘æŒ¥ï¼Œåˆ›ä½œä¸€ä¸ªè®©ä½ è‡ªå·±ä¹Ÿæƒ³ç»§ç»­è¯»ä¸‹å»çš„æ•…äº‹ã€‚';
userMsg+='\n\nã€æ ¼å¼ã€‘ç¬¬ä¸€è¡Œå†™æ ‡é¢˜ï¼ˆçº¯æ–‡å­—ï¼‰ï¼Œç©ºä¸€è¡Œåç›´æ¥å†™æ­£æ–‡ã€‚åªè¾“å‡ºæ ‡é¢˜å’Œæ­£æ–‡ï¼Œæ— å…¶ä»–å†…å®¹ã€‚';

isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='â¹ åœæ­¢';btn.disabled=false;

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const list=document.getElementById('articleList');

if(!useStream){
// éæµå¼æ¨¡å¼
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='ç”Ÿæˆ';
if(!result){renderArticles();return;}
let title2='',content2=result;
const lines2=result.split(/\n/);
for(let i=0;i<Math.min(5,lines2.length);i++){
const l=lines2[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('ã€€')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('ã€Œ')){
title2=l.replace(/^[#*ã€Šã€Œã€\s:ï¼šæ ‡é¢˜]+/,'').replace(/[ã€‹ã€ã€‘\s]+$/,'').trim();
content2=lines2.slice(i+1).join('\n').trim();
break;
}
}
if(!title2||title2.length>35)title2=(searchText||activeTags||'éšæœºæ•…äº‹').substring(0,20);
const article2={
id:uid(),title:title2,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content2]:undefined,
content:type==='short'?content2:undefined,
prompt:searchText
};
ws.unshift(article2);sv(K.ws,ws);
renderArticles();showToast('åˆ›ä½œå®Œæˆï¼âœ¨');
return;
}

// æµå¼æ¨¡å¼
const streamCard=document.createElement('div');
streamCard.className='stream-card';
streamCard.id='streamCard';
const startTime=Date.now();
streamCard.innerHTML=
'<div class="stream-title"><span class="ldots"><span></span><span></span><span></span></span> æ­£åœ¨åˆ›ä½œä¸­...</div>'+
'<div class="stream-body" id="streamBody"></div>'+
'<div class="stream-info"><span id="streamWc">0 å­—</span><span id="streamTime">0s</span></div>';
list.insertBefore(streamCard,list.firstChild);

let timeInterval=setInterval(()=>{
const el=document.getElementById('streamTime');
if(el)el.textContent=((Date.now()-startTime)/1000).toFixed(0)+'s';
},1000);

await callAPIStream(messages,
(fullText,chunk)=>{
const body=document.getElementById('streamBody');
if(body)body.textContent=fullText;
const wc=document.getElementById('streamWc');
if(wc)wc.textContent=countWords(fullText)+' å­—';
if(body)body.scrollTop=body.scrollHeight;
},
(fullText)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='ç”Ÿæˆ';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
if(!fullText){renderArticles();return;}
let title='',content=fullText;
const lines=fullText.split(/\n/);
let titleLine='';
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('ã€€')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('ã€Œ')){
titleLine=l;
content=lines.slice(i+1).join('\n').trim();
break;
}
}
title=titleLine.replace(/^[#*ã€Šã€Œã€\s:ï¼šæ ‡é¢˜]+/,'').replace(/[ã€‹ã€ã€‘\s]+$/,'').trim();
if(!title||title.length>35)title=(searchText||activeTags||'éšæœºæ•…äº‹').substring(0,20);
const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);
sv(K.ws,ws);
renderArticles();
showToast('åˆ›ä½œå®Œæˆï¼âœ¨');
},
(errMsg)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='ç”Ÿæˆ';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
showToast('æµå¼è¾“å‡ºå¤±è´¥ï¼Œå°è¯•æ™®é€šæ¨¡å¼...',2000);
setTimeout(()=>generateNonStream(messages,type,searchText),500);
}
);
}

// Non-stream fallback
async function generateNonStream(messages,type,searchText){
if(isGen)return;
isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='<span class="ldots"><span></span><span></span><span></span></span>';

const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='ç”Ÿæˆ';
if(!result)return;

let title='',content=result;
const lines=result.split(/\n/);
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<35&&!l.startsWith('ã€€')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('ã€Œ')&&!l.startsWith('â€”â€”')&&!l.startsWith('â€¦')&&!l.includes('ã€‚')&&!l.includes('ï¼Œ')){
title=l.replace(/^[#*ã€Šã€Œã€\s:ï¼šæ ‡é¢˜]+/,'').replace(/[ã€‹ã€ã€‘\s]+$/,'').trim();
content=lines.slice(i+1).join('\n').trim();
break;
}
}
if(!title||title.length>35)title=(searchText||'éšæœºæ•…äº‹').substring(0,20);

const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);sv(K.ws,ws);
renderArticles();showToast('åˆ›ä½œå®Œæˆï¼âœ¨');
}

// ==================== READING ====================
function openReading(article){
// Always use the latest version: check workshop first, then collections
let latestArticle=ws.find(a=>a.id===article.id);
if(!latestArticle){
if(article.type==='long')latestArticle=cols.books.find(b=>b.id===article.id);
else latestArticle=cols.shorts.find(s=>s.id===article.id);
}
if(!latestArticle)latestArticle=article;
if(!latestArticle){showToast('æ–‡ç« æ•°æ®ä¸¢å¤±');return;}

curRd=latestArticle;curCh=0;

document.getElementById('rdTitle').textContent=curRd.title;

const totalWords=getTotalWords(curRd);
const meta=document.getElementById('rdMeta');
meta.innerHTML=
'<span>'+(curRd.type==='long'?'ğŸ“– é•¿ç¯‡è¿è½½':'ğŸ“„ çŸ­ç¯‡')+'</span>'+
'<span>ğŸ• '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
(curRd.chapters?'<span>å…± '+curRd.chapters.length+' ç« </span>':'')+
'<span>'+totalWords+' å­—</span>';

renderChContent();
updateRdLikeBtn();

const liked=isLiked(curRd);
const cw=document.getElementById('contWrap');
if(curRd.type==='long'){
cw.style.display='block';
const btnCont=document.getElementById('btnCont');
if(liked){
btnCont.disabled=false;
btnCont.textContent='ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« ';
}else{
btnCont.disabled=true;
btnCont.textContent='â¤ï¸ è¯·å…ˆæ”¶è—åæ‰èƒ½ç»­å†™';
}
}else{
cw.style.display='none';
}

const dirWrap=document.getElementById('dirInputWrap');
dirWrap.style.display=(curRd.type==='long')?'flex':'none';

const undoBtn=document.getElementById('btnUndo');
undoBtn.style.display=(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1)?'inline-block':'none';

// Reading bg
const bg=document.getElementById('rdBg');
if(ap.rdBg){
bg.style.backgroundImage='url('+ap.rdBg+')';
bg.style.display='block';
}else{bg.style.display='none';}

// Apply reading font settings
setRdFont(ap.rdFontSize||15);
setRdLine(ap.rdLineHeight||2);

document.getElementById('rdModal').classList.add('show');
document.getElementById('rdModal').scrollTop=0;
updateNoteBtn();
}

function getTotalWords(article){
let total=0;
if(article.chapters&&Array.isArray(article.chapters)){
article.chapters.forEach(ch=>total+=countWords(ch||''));
}else if(article.content){
total=countWords(article.content);
}
return total;
}

function renderChContent(){
if(!curRd)return;
const nav=document.getElementById('chNav');
if(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1){
nav.innerHTML='';
// å½“å‰ç« èŠ‚æŒ‡ç¤º + æ‰“å¼€ç›®å½•æŒ‰é’®
const info=document.createElement('button');
info.className='ch-btn act';
info.textContent='ç¬¬'+(curCh+1)+'ç«  / å…±'+curRd.chapters.length+'ç« ';
info.onclick=()=>openChapterList();
nav.appendChild(info);

if(curCh>0){
const prev=document.createElement('button');
prev.className='ch-btn';prev.textContent='â—€ ä¸Šä¸€ç« ';
prev.onclick=()=>{curCh--;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(prev);
}
if(curCh<curRd.chapters.length-1){
const next=document.createElement('button');
next.className='ch-btn';next.textContent='ä¸‹ä¸€ç«  â–¶';
next.onclick=()=>{curCh++;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(next);
}

const listBtn=document.createElement('button');
listBtn.className='ch-btn';listBtn.textContent='ğŸ“‘ ç›®å½•';
listBtn.onclick=()=>openChapterList();
nav.appendChild(listBtn);
}else{nav.innerHTML='';}

const cdiv=document.getElementById('rdContent');
let text='';
if(curRd.type==='long'&&curRd.chapters)text=curRd.chapters[curCh]||'';
else text=curRd.content||'';

const paras=text.split(/\n+/).filter(p=>p.trim());
cdiv.innerHTML=paras.map((p,pi)=>'<p data-pi="'+pi+'" class="rd-para">'+esc(p.trim())+'</p>').join(''); // ç»‘å®šé•¿æŒ‰å¼•ç”¨ cdiv.querySelectorAll('.rd-para').forEach(el=>{ let lpTimer=null; let startX=0,startY=0,moved=false; el.addEventListener('touchstart',function(e){ moved=false; if(e.touches.length>0){startX=e.touches[0].clientX;startY=e.touches[0].clientY;} lpTimer=setTimeout(()=>{ if(moved)return; e.preventDefault(); const text=el.textContent.trim(); if(!text)return; // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ‰‹æœºæ”¯æŒï¼‰ if(navigator.vibrate)navigator.vibrate(30); el.style.background='rgba(108,92,231,.18)'; el.style.boxShadow='inset 0 0 0 1px var(--accent)'; setTimeout(()=>{el.style.background='';el.style.boxShadow='';},1000); showQuoteNote(text); },500); },{passive:false}); el.addEventListener('touchmove',function(e){ if(e.touches.length>0){ const dx=Math.abs(e.touches[0].clientX-startX); const dy=Math.abs(e.touches[0].clientY-startY); if(dx>8||dy>8){moved=true;clearTimeout(lpTimer);} } },{passive:true}); el.addEventListener('touchend',()=>{clearTimeout(lpTimer);}); el.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);}); }); updateNoteBtn();
}
function showQuoteNote(quoteText){
if(!curRd)return;
const short=quoteText.length>40?quoteText.substring(0,40)+'...':quoteText;
// ç›´æ¥æ‰“å¼€ç¬”è®°é¢æ¿å¹¶é¢„å¡«å¼•ç”¨
openNotePanel();
setTimeout(()=>{
const inp=document.getElementById('noteInput');
inp.value='ã€Œ'+short+'ã€\nâ€”â€”æˆ‘çš„æƒ³æ³•ï¼š';
inp.style.height='38px';
inp.style.height=Math.min(inp.scrollHeight,100)+'px';
inp.focus();
// å…‰æ ‡æ”¾åˆ°æœ«å°¾
inp.setSelectionRange(inp.value.length,inp.value.length);
},350);
}
function updateRdLikeBtn(){
const btn=document.getElementById('rdLikeBtn');
btn.innerHTML=isLiked(curRd)?'â¤ï¸':'â™¡';
}

function toggleCurrentLike(){
if(!curRd)return;
toggleLike(curRd.id);
updateRdLikeBtn();
const liked=isLiked(curRd);
const cw2=document.getElementById('contWrap');
const dw2=document.getElementById('dirInputWrap');
const bc2=document.getElementById('btnCont');
if(curRd.type==='long'){
cw2.style.display='block';
dw2.style.display='flex';
if(liked){bc2.disabled=false;bc2.textContent='ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« ';}
else{bc2.disabled=true;bc2.textContent='â¤ï¸ è¯·å…ˆæ”¶è—åæ‰èƒ½ç»­å†™';}
}else{cw2.style.display='none';dw2.style.display='none';}
}
function openChapterList(){
if(!curRd||!curRd.chapters)return;
document.getElementById('chPanelTitle').textContent='ã€Œ'+curRd.title+'ã€ç›®å½•';
document.getElementById('chPanelInfo').textContent='å…± '+curRd.chapters.length+' ç«  Â· '+getTotalWords(curRd)+' å­—';
const list=document.getElementById('chPanelList');
list.innerHTML='';
curRd.chapters.forEach((_,i)=>{
const wc=countWords(curRd.chapters[i]);
const item=document.createElement('div');
item.className='ch-item'+(i===curCh?' act':'');
const chNotes=getArticleNotes(curRd.id).filter(n=>n.ch===i); const noteTag=chNotes.length>0?' Â· âœï¸'+chNotes.length:''; item.innerHTML='<span class="ch-item-num" style="font-size:14px;font-weight:700;width:60px;flex-shrink:0">ç¬¬'+(i+1)+'ç« </span><span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((curRd.chapters[i]||'').replace(/\n/g,' ').substring(0,30))+'</span><span class="ch-item-wc" style="flex-shrink:0;font-size:10px;opacity:.7">'+wc+'å­—'+noteTag+'</span>';
item.onclick=()=>{curCh=i;renderChContent();closeChapterList();document.getElementById('rdModal').scrollTop=0;};
list.appendChild(item);
});
document.getElementById('chOv').classList.add('show');
}
// ==================== NOTES ====================
function getArticleNotes(articleId){
if(!articleId)return[];
return ld('bj_notes_'+articleId,[]);
}
function saveArticleNotes(articleId,notes){
sv('bj_notes_'+articleId,notes);
}
function openNotePanel(){
if(!curRd)return;
const chLabel=curRd.type==='long'?'ç¬¬'+(curCh+1)+'ç« ':'å…¨æ–‡';
document.getElementById('noteChInfo').textContent=chLabel+'çš„ç¬”è®°';
renderNotes();
document.getElementById('noteOv').classList.add('show');
setTimeout(()=>{document.getElementById('noteInput').focus();},300);
}
function closeNotePanel(){
document.getElementById('noteOv').classList.remove('show');
}
function renderNotes(){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
const list=document.getElementById('noteList');
if(chNotes.length===0){
list.innerHTML='<div class="note-empty">è¿˜æ²¡æœ‰ç¬”è®°<br>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å†™ä¸‹ä½ çš„æƒ³æ³•å§</div>';
return;
}
list.innerHTML='';
chNotes.forEach((n,idx)=>{
const realIdx=notes.indexOf(n);
const item=document.createElement('div');
item.className='note-item';
const time=n.time?new Date(n.time).toLocaleString():'';
item.innerHTML=
'<div class="note-item-text">'+esc(n.text)+'</div>'+
'<div class="note-item-ft">'+
'<span class="note-item-time">'+time+'</span>'+
'<button class="note-item-del" onclick="deleteNote('+realIdx+')">åˆ é™¤</button>'+
'</div>';
list.appendChild(item);
});
list.scrollTop=list.scrollHeight;
}
function addNote(){
if(!curRd)return;
const input=document.getElementById('noteInput');
const text=(input.value||'').trim();
if(!text){showToast('è¯·è¾“å…¥ç¬”è®°å†…å®¹');return;}
const notes=getArticleNotes(curRd.id);
notes.push({
ch:curCh,
text:text,
time:new Date().toISOString()
});
saveArticleNotes(curRd.id,notes);
input.value='';
input.style.height='38px';
renderNotes();
updateNoteBtn();
showToast('ç¬”è®°å·²ä¿å­˜ âœï¸');
}
function deleteNote(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
notes.splice(realIdx,1);
saveArticleNotes(curRd.id,notes);
renderNotes();
updateNoteBtn();
showToast('ç¬”è®°å·²åˆ é™¤');
}
function updateNoteBtn(){
if(!curRd)return;
const btn=document.getElementById('rdNoteBtn');
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
if(chNotes.length>0){
btn.innerHTML='ğŸ“<span class="note-dot"></span>';
}else{
btn.innerHTML='ğŸ“';
}
}
function getNoteCount(articleId){
const notes=ld('bj_notes_'+articleId,[]);
return notes.length;
}
function closeChapterList(){
document.getElementById('chOv').classList.remove('show');
}
function closeReading(){
if(abortCtrl){abortCtrl.abort();abortCtrl=null;isGen=false;}
if(isFS)toggleFullscreen();
document.getElementById('rdModal').classList.remove('show');
document.getElementById('rdSettingsPanel').classList.remove('show');
closeNotePanel();
closeChapterList();
curRd=null;
curCh=0;
renderArticles();
renderCollections();
}

function toggleFullscreen(){
const modal=document.getElementById('rdModal');
const btn=document.getElementById('btnFS');
const nav=document.getElementById('bnav');
isFS=!isFS;
if(isFS){
modal.classList.add('fs');nav.classList.add('hide');
btn.textContent='âŠ¡';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('fs');nav.classList.remove('hide');
btn.textContent='â›¶';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}

function toggleRdSettings(){
document.getElementById('rdSettingsPanel').classList.toggle('show');
}

function setRdFont(v){
v=parseInt(v);
document.getElementById('rdContent').style.setProperty('--rd-fontsize',v+'px');
document.getElementById('rdFontVal').textContent=v;
ap.rdFontSize=v;sv(K.ap,ap);
// Sync range
const range=document.querySelector('#rdSettingsPanel input[type=range]');
if(range&&range.oninput.toString().includes('setRdFont'))range.value=v;
}

function setRdLine(v){
v=parseFloat(v);
document.getElementById('rdContent').style.setProperty('--rd-lineheight',v);
document.getElementById('rdLineVal').textContent=v.toFixed(1);
ap.rdLineHeight=v;sv(K.ap,ap);
}

// ==================== CONTINUE CHAPTER ====================
async function continueChapter(){
if(isGen||!curRd||curRd.type!=='long')return;
isGen=true;
const btn=document.getElementById('btnCont');
btn.disabled=true;
btn.innerHTML='æ­£åœ¨åˆ›ä½œ <span class="ldots"><span></span><span></span><span></span></span>';

const chNum=curRd.chapters.length+1;
const direction=(document.getElementById('dirInput').value||'').trim();

// æ„å»ºä¸°å¯Œçš„ä¸Šä¸‹æ–‡
let context='';
const totalCh=curRd.chapters.length;

// å¦‚æœç« èŠ‚è¾ƒå¤šï¼Œæä¾›å‰é¢ç« èŠ‚çš„æ‘˜è¦
if(totalCh>=3){
context+='ã€å‰æƒ…æ¦‚è¦ã€‘\n';
// å–å‰é¢ç« èŠ‚çš„å¼€å¤´å’Œç»“å°¾å„ä¸€å°æ®µä½œä¸ºçº¿ç´¢
for(let i=Math.max(0,totalCh-3);i<totalCh-1;i++){
const ch=curRd.chapters[i]||'';
const opening=ch.substring(0,150).replace(/\n/g,' ').trim();
const ending=ch.substring(Math.max(0,ch.length-150)).replace(/\n/g,' ').trim();
context+='ç¬¬'+(i+1)+'ç« ç‰‡æ®µï¼š'+opening+'â€¦â€¦'+ending+'\n';
}
context+='\n';
}

// ä¸Šä¸€ç« å®Œæ•´ç»“å°¾ï¼ˆå¤šç»™ä¸€äº›ï¼‰
const lastCh=curRd.chapters[totalCh-1]||'';
const lastChEnding=lastCh.substring(Math.max(0,lastCh.length-1200));
context+='ã€ä¸Šä¸€ç« ï¼ˆç¬¬'+totalCh+'ç« ï¼‰ç»“å°¾ã€‘\n'+lastChEnding+'\n';

// å¦‚æœæœ‰å¤§çº²ï¼Œæä¾›å½“å‰ç« èŠ‚çš„å¤§çº²æŒ‡å¼•
const wsArticle=ws.find(a=>a.id===curRd.id);
const crArticle=crWorks.find(w=>w.id===curRd.id);
const outline=(wsArticle&&wsArticle.outline)||(crArticle&&crArticle.outline)||'';
let outlineHint='';
if(outline){
const outlineLines=outline.split('\n');
for(let i=0;i<outlineLines.length;i++){
const line=outlineLines[i].trim();
if(line.includes('ç¬¬'+chNum+'ç« ')||line.includes('ç¬¬'+chNum+'ç« ')){
outlineHint=line;
// ä¹Ÿå–ä¸‹ä¸€è¡Œï¼ˆé€šå¸¸æ˜¯æ¦‚è¦ï¼‰
if(i+1<outlineLines.length){
const nextLine=outlineLines[i+1].trim();
if(nextLine.startsWith('-')||nextLine.startsWith('â€”'))outlineHint+='\n'+nextLine;
}
break;
}
}
}

let userMsg='è¯·åˆ›ä½œã€Š'+curRd.title+'ã€‹çš„ç¬¬'+chNum+'ç« ã€‚\n\n';
userMsg+=context+'\n';
if(outlineHint)userMsg+='ã€æœ¬ç« å¤§çº²å‚è€ƒã€‘\n'+outlineHint+'\n\n';
if(direction)userMsg+='ã€ä½œè€…å¯¹æœ¬ç« çš„æ–¹å‘æç¤ºã€‘\n'+direction+'\n\n';
userMsg+='ã€åˆ›ä½œè¦æ±‚ã€‘\n';
userMsg+='1. è‡ªç„¶æ‰¿æ¥ä¸Šä¸€ç« ç»“å°¾ï¼Œå¼€å¤´ä¸è¦ç”Ÿç¡¬åœ°å¤è¿°å‰æƒ…\n';
userMsg+='2. æœ¬ç« è¦æœ‰ç‹¬ç«‹çš„å°é«˜æ½®æˆ–æƒ…æ„Ÿè½¬æŠ˜ç‚¹\n';
userMsg+='3. ç»“å°¾ç•™æœ‰ä½™éŸµæˆ–æ‚¬å¿µï¼Œè®©è¯»è€…æƒ³ç»§ç»­è¯»\n';
userMsg+='4. äººç‰©çš„è¨€è¡Œè¦ä¸å‰æ–‡æ€§æ ¼ä¸€è‡´ï¼Œä½†å¯ä»¥æœ‰åˆç†çš„æˆé•¿å˜åŒ–\n';
userMsg+='5. ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦æ ‡é¢˜ã€ç« èŠ‚å·ã€ä½œè€…æŒ‰è¯­ã€markdownæ ¼å¼\n';

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const rdContent=document.getElementById('rdContent');
const startTime=Date.now();

if(!useStream){
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« ';
if(!result)return;
curRd.chapters.push(result);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>ğŸ“– é•¿ç¯‡è¿è½½</span><span>ğŸ• '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>å…± '+curRd.chapters.length+' ç« </span><span>'+getTotalWords(curRd)+' å­—</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('ç¬¬'+chNum+'ç« åˆ›ä½œå®Œæˆï¼âœ¨');
return;
}

await callAPIStream(messages,
(fullText)=>{
const elapsed=((Date.now()-startTime)/1000).toFixed(0);
const wc=countWords(fullText);
const paras=fullText.split(/\n+/).filter(p=>p.trim());
rdContent.innerHTML=paras.map(p=>'<p>'+esc(p.trim())+'</p>').join('');
document.getElementById('rdModal').scrollTop=document.getElementById('rdModal').scrollHeight;
},
(fullText)=>{
isGen=false;btn.disabled=false;btn.textContent='ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« ';
if(!fullText)return;
curRd.chapters.push(fullText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>ğŸ“– é•¿ç¯‡è¿è½½</span><span>ğŸ• '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>å…± '+curRd.chapters.length+' ç« </span><span>'+getTotalWords(curRd)+' å­—</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('ç¬¬'+chNum+'ç« åˆ›ä½œå®Œæˆï¼âœ¨');
},
(errMsg)=>{
isGen=false;btn.disabled=false;btn.textContent='ğŸ“ ç»§ç»­è¿è½½ä¸‹ä¸€ç« ';
showToast(errMsg,3000);
}
);
}

// ==================== UNDO CHAPTER ====================
function undoChapter(){
if(!curRd||curRd.type!=='long'||!curRd.chapters||curRd.chapters.length<=1)return;
showDlg('æ’¤é”€ç¡®è®¤','ç¡®å®šè¦åˆ é™¤æœ€åä¸€ç« ï¼ˆç¬¬'+curRd.chapters.length+'ç« ï¼‰å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',()=>{
curRd.chapters.pop();
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();

document.getElementById('rdMeta').innerHTML=
'<span>ğŸ“– é•¿ç¯‡è¿è½½</span><span>ğŸ• '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>å…± '+curRd.chapters.length+' ç« </span><span>'+getTotalWords(curRd)+' å­—</span>';

if(curRd.chapters.length<=1)document.getElementById('btnUndo').style.display='none';
showToast('å·²æ’¤é”€æœ€åä¸€ç« ');
},true);
}

// ==================== COPY ====================
function copyCurrentArticle(){
if(!curRd)return;
let text='';
if(curRd.type==='long'&&curRd.chapters){
curRd.chapters.forEach((ch,i)=>{text+='ç¬¬'+(i+1)+'ç« \n\n'+ch+'\n\n';});
}else{text=curRd.content||'';}
// Clean: only remove non-standard whitespace, keep normal spaces and newlines
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');

const header='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nã€Œ'+curRd.title+'ã€\næœ¬æ–‡ç”±ã€Œç¬”è®°AIã€è¾…åŠ©åˆ›ä½œç”Ÿæˆ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI Â· Created by å¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
const footer='\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\næœ¬æ–‡ç”±AIè¾…åŠ©åˆ›ä½œï¼Œå†…å®¹ä»…ä¾›å‚è€ƒ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI '+APP_VER+'ï¼ˆAIåˆ›ä½œå·¥åŠï¼‰\nç½‘é¡µä½œè€…ï¼šå¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
doCopy(header+text+footer);
}

function doCopy(text){
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(text).then(()=>showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ ğŸ“‹')).catch(()=>fbCopy(text));
}else{fbCopy(text);}
}
function fbCopy(text){
const ta=document.createElement('textarea');ta.value=text;
ta.style.cssText='position:fixed;left:-9999px;';
document.body.appendChild(ta);ta.select();
try{document.execCommand('copy');showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ ğŸ“‹');}
catch{showToast('å¤åˆ¶å¤±è´¥');}
document.body.removeChild(ta);
}

// Fullscreen change listener
document.addEventListener('fullscreenchange',()=>{
if(!document.fullscreenElement&&isFS){
isFS=false;
document.getElementById('rdModal').classList.remove('fs');
document.getElementById('bnav').classList.remove('hide');
document.getElementById('btnFS').textContent='â›¶';
}
});

// ==================== COLLECTIONS ====================
function renderCollections(){
const sv_=(document.getElementById('colSearchInput').value||'').trim().toLowerCase();

// Books
const grid=document.getElementById('bookGrid');
let books=cols.books;
if(sv_)books=books.filter(b=>b.title.toLowerCase().includes(sv_));

if(books.length===0){
grid.innerHTML='<div class="empty-st" style="grid-column:1/-1"><p>'+(sv_?'æ²¡æœ‰åŒ¹é…çš„é•¿ç¯‡':'è¿˜æ²¡æœ‰æ”¶è—çš„é•¿ç¯‡å°è¯´<br>åœ¨ä½œåŠä¸­æ”¶è—å³å¯æ·»åŠ ')+'</p></div>';
}else{
grid.innerHTML='';
books.forEach(book=>{
const realId=book.id;
const card=document.createElement('div');
card.className='bcard';

let covHtml='';
if(book.cover)covHtml='<img src="'+book.cover+'" alt="å°é¢">';
else covHtml='<div class="bcov-ph"><span style="font-size:24px">ğŸ“–</span><span>'+esc(book.title.substring(0,4))+'</span></div>';

const statusClass=book.status||'ongoing';
const statusText={ongoing:'è¿è½½ä¸­',complete:'å·²å®Œç»“',paused:'æš‚åœ'}[statusClass]||'è¿è½½ä¸­';

card.innerHTML=
'<div class="bcov" onclick="openColBook(\''+realId+'\')">'+covHtml+'</div>'+
'<div class="binfo" onclick="openColBook(\''+realId+'\')">'+
'<div class="binfo-t">'+esc(book.title)+'</div>'+
'<div class="binfo-m">'+(book.chapters?book.chapters.length+'ç«  Â· ':'')+ getTotalWords(book)+'å­—</div>'+
'<span class="binfo-status '+statusClass+'">'+statusText+'</span>'+
renderStarHTML(book.rating||0,realId)+
'</div>'+
'<div class="bacts">'+
'<button class="bact" onclick="event.stopPropagation();uploadCover(\''+realId+'\')">å°é¢</button>'+
'<button class="bact" onclick="event.stopPropagation();cycleStatus(\''+realId+'\')">çŠ¶æ€</button>'+
'<button class="bact" onclick="event.stopPropagation();copyBook(\''+realId+'\')">å¤åˆ¶</button>'+
'<button class="bact danger" onclick="event.stopPropagation();deleteBook(\''+realId+'\')">åˆ é™¤</button>'+
'</div>';
grid.appendChild(card);
});
}

// Shorts
const sl=document.getElementById('shortList');
let shorts=cols.shorts;
if(sv_)shorts=shorts.filter(s=>s.title.toLowerCase().includes(sv_));

if(shorts.length===0){
sl.innerHTML='<div class="empty-st"><p>'+(sv_?'æ²¡æœ‰åŒ¹é…çš„çŸ­ç¯‡':'è¿˜æ²¡æœ‰æ”¶è—çš„çŸ­ç¯‡æ–‡ç« ')+'</p></div>';
}else{
sl.innerHTML='';
shorts.forEach(s=>{
const realId=s.id;
const item=document.createElement('div');
item.className='sitem';
item.onclick=e=>{if(!e.target.closest('button')&&!e.target.closest('.star-rating'))openReading(s);};
item.innerHTML=
'<div class="sitem-info"><div class="sitem-t">'+esc(s.title)+'</div>'+
'<div class="sitem-pv">'+esc((s.content||'').replace(/\n/g,' ').substring(0,20))+'</div>'+
renderStarHTML(s.rating||0,realId)+
'</div>'+
'<div class="sitem-acts">'+
'<button onclick="event.stopPropagation();copyShort(\''+realId+'\')">å¤åˆ¶</button>'+
'<button onclick="event.stopPropagation();deleteShort(\''+realId+'\')" style="color:var(--danger)">åˆ é™¤</button>'+
'</div>';
sl.appendChild(item);
});
}

document.getElementById('colCnt').textContent=(cols.books.length+cols.shorts.length)+' ç¯‡';
}

function renderStarHTML(rating,id){
let html='<div class="star-rating">';
for(let i=1;i<=5;i++){
html+='<span class="'+(i<=rating?'filled':'')+'" onclick="event.stopPropagation();setRating(\''+id+'\','+i+')">â˜…</span>';
}
html+='</div>';
return html;
}

function setRating(id,rating){
let found=cols.books.find(b=>b.id===id);
if(found){found.rating=rating;}
else{found=cols.shorts.find(s=>s.id===id);if(found)found.rating=rating;}
sv(K.cols,cols);renderCollections();
}

function cycleStatus(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
const states=['ongoing','complete','paused'];
const cur=states.indexOf(book.status||'ongoing');
book.status=states[(cur+1)%states.length];
sv(K.cols,cols);renderCollections();
const labels={ongoing:'è¿è½½ä¸­',complete:'å·²å®Œç»“',paused:'æš‚åœ'};
showToast('çŠ¶æ€å·²åˆ‡æ¢ä¸ºï¼š'+labels[book.status]);
}

function openColBook(id){
const book=cols.books.find(b=>b.id===id);
if(book)openReading(book);
}

function uploadCover(id){
const input=document.getElementById('coverUp');
input.onchange=e=>{
const file=e.target.files[0];if(!file)return;
// Compress cover: resize to max 300px width
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=300;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.7);
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl;sv(K.cols,cols);renderCollections();showToast('å°é¢å·²æ›´æ–° ğŸ¨');}
};
img.src=URL.createObjectURL(file);
input.value='';
};
input.click();
}

function copyBook(id){
const book=cols.books.find(b=>b.id===id);if(!book)return;
let text='';
if(book.chapters){book.chapters.forEach((ch,i)=>{text+='ç¬¬'+(i+1)+'ç« \n\n'+ch+'\n\n';});}
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nã€Œ'+book.title+'ã€\næœ¬æ–‡ç”±ã€Œç¬”è®°AIã€è¾…åŠ©åˆ›ä½œç”Ÿæˆ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI Â· Created by å¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
const footer='\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\næœ¬æ–‡ç”±AIè¾…åŠ©åˆ›ä½œï¼Œå†…å®¹ä»…ä¾›å‚è€ƒ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI '+APP_VER+'ï¼ˆAIåˆ›ä½œå·¥åŠï¼‰\nç½‘é¡µä½œè€…ï¼šå¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
doCopy(header+text+footer);
}

function deleteBook(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
showDlg('åˆ é™¤ç¡®è®¤','ç¡®å®šè¦åˆ é™¤ã€Š'+book.title+'ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',()=>{
cols.books=cols.books.filter(b=>b.id!==id);
sv(K.cols,cols);renderCollections();showToast('å·²åˆ é™¤');
},true);
}

function copyShort(id){
const s=cols.shorts.find(x=>x.id===id);if(!s)return;
let text=s.content||'';
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nã€Œ'+s.title+'ã€\næœ¬æ–‡ç”±ã€Œç¬”è®°AIã€è¾…åŠ©åˆ›ä½œç”Ÿæˆ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI Â· Created by å¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
const footer='\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\næœ¬æ–‡ç”±AIè¾…åŠ©åˆ›ä½œï¼Œå†…å®¹ä»…ä¾›å‚è€ƒ\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI '+APP_VER+'ï¼ˆAIåˆ›ä½œå·¥åŠï¼‰\nç½‘é¡µä½œè€…ï¼šå¿ƒç”°\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
doCopy(header+text+footer);
}

function deleteShort(id){
showDlg('åˆ é™¤ç¡®è®¤','ç¡®å®šè¦åˆ é™¤è¿™ç¯‡çŸ­æ–‡å—ï¼Ÿ',()=>{
cols.shorts=cols.shorts.filter(s=>s.id!==id);
sv(K.cols,cols);renderCollections();showToast('å·²åˆ é™¤');
},true);
}

// ==================== SETTINGS ====================
function toggleGrp(el){el.classList.toggle('exp');el.nextElementSibling.classList.toggle('show');}

// API Presets
function saveApiPreset(){
showInp('ä¿å­˜APIé¢„è®¾','ä¸ºé¢„è®¾èµ·ä¸ªåå­—',name=>{
apiP.push({name,...getCurApi()});
sv(K.apiP,apiP);saveCurSettings();renderApiPresets();showToast('APIé¢„è®¾å·²ä¿å­˜');
});
}
function renderApiPresets(){
const l=document.getElementById('apiPL');l.innerHTML='';
apiP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(p.model||'')+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useApiP('+i+')">ä½¿ç”¨</button><button class="btn-del" onclick="delApiP('+i+')">åˆ é™¤</button></div>';
l.appendChild(it);
});
}
function useApiP(i){
const p=apiP[i];
document.getElementById('apiUrl').value=p.url||'';
document.getElementById('apiKey').value=p.key||'';
document.getElementById('apiModel').value=p.model||'';
document.getElementById('apiTemp').value=p.temp??0.8;
document.getElementById('apiMaxTokens').value=p.maxTokens||4096;
saveCurSettings();showToast('å·²åˆ‡æ¢: '+p.name);
}
function delApiP(i){apiP.splice(i,1);sv(K.apiP,apiP);renderApiPresets();}

// Char Presets
function saveCharPreset(){
saveCharactersFromUI();
showInp('ä¿å­˜äººç‰©é¢„è®¾','ä¸ºè¿™ç»„äººç‰©èµ·ä¸ªåå­—',name=>{
charP.push({name,characters:JSON.parse(JSON.stringify(characters))});
sv(K.charP,charP);renderCharPresets();showToast('äººç‰©é¢„è®¾å·²ä¿å­˜');
});
}
function renderCharPresets(){
const l=document.getElementById('charPL');l.innerHTML='';
charP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
const charNames=(p.characters||[]).map(c=>c.name).filter(Boolean).join('ã€')||'æœªå‘½å';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(charNames)+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useCharP('+i+')">ä½¿ç”¨</button><button class="btn-del" onclick="delCharP('+i+')">åˆ é™¤</button></div>';
l.appendChild(it);
});
}
function useCharP(i){
const p=charP[i];
characters=JSON.parse(JSON.stringify(p.characters||[{name:'',desc:''}]));
sv(K.curChars,characters);
renderCharCards();showToast('å·²åŠ è½½äººç‰©: '+p.name);
}
function delCharP(i){charP.splice(i,1);sv(K.charP,charP);renderCharPresets();}

// World Presets
function saveWorldPreset(){
showInp('ä¿å­˜ä¸–ç•Œè§‚é¢„è®¾','ä¸ºä¸–ç•Œè§‚èµ·ä¸ªåå­—',name=>{
worldP.push({name,desc:document.getElementById('worldDesc').value,minWords:parseInt(document.getElementById('minWords').value)||800});
sv(K.worldP,worldP);saveCurSettings();renderWorldPresets();showToast('ä¸–ç•Œè§‚é¢„è®¾å·²ä¿å­˜');
});
}
function renderWorldPresets(){
const l=document.getElementById('worldPL');l.innerHTML='';
worldP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+'</span><div class="pitem-a"><button class="btn-use" onclick="useWorldP('+i+')">ä½¿ç”¨</button><button class="btn-del" onclick="delWorldP('+i+')">åˆ é™¤</button></div>';
l.appendChild(it);
});
}
function useWorldP(i){
const p=worldP[i];
document.getElementById('worldDesc').value=p.desc||'';
document.getElementById('minWords').value=p.minWords||800;
saveCurSettings();showToast('å·²åŠ è½½ä¸–ç•Œè§‚: '+p.name);
}
function delWorldP(i){worldP.splice(i,1);sv(K.worldP,worldP);renderWorldPresets();}
// æ–‡é£é¢„è®¾
function saveStylePreset(){
const desc=(document.getElementById('styleDesc').value||'').trim();
if(!desc){showToast('è¯·å…ˆå¡«å†™æ–‡é£æè¿°');return;}
showInp('ä¿å­˜æ–‡é£é¢„è®¾','ä¸ºè¿™ä¸ªæ–‡é£èµ·ä¸ªåå­—',name=>{
styleP.push({name,desc});
sv('bj_styleP',styleP);renderStylePresets();showToast('æ–‡é£é¢„è®¾å·²ä¿å­˜');
});
}
function renderStylePresets(){
const l=document.getElementById('stylePL');if(!l)return;l.innerHTML='';
styleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useStyleP('+i+')">ä½¿ç”¨</button><button class="btn-del" onclick="delStyleP('+i+')">åˆ é™¤</button></div>';
l.appendChild(it);
});
}
function useStyleP(i){
const p=styleP[i];
document.getElementById('styleDesc').value=p.desc||'';
ap.curStyle=p.desc;sv(K.ap,ap);
showToast('å·²åŠ è½½æ–‡é£: '+p.name);
}
function delStyleP(i){styleP.splice(i,1);sv('bj_styleP',styleP);renderStylePresets();}

function applyStyleTemplate(name){
const templates={
'è½»æ¾æ—¥å¸¸':'è¯­è¨€è½»æ¾è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©ä¸€æ ·äº²åˆ‡ã€‚å¤šç”¨çŸ­å¥å’Œå£è¯­åŒ–è¡¨è¾¾ï¼ŒèŠ‚å¥æ˜å¿«ï¼Œé€‚å½“åŠ å…¥ç”Ÿæ´»åŒ–çš„æ¯”å–»å’Œå°å¹½é»˜ã€‚æƒ…ç»ªåŸºè°ƒæ¸©æš–èˆ’é€‚ï¼Œå³ä½¿å†™çŸ›ç›¾ä¹Ÿä¸è¦å¤ªæ²‰é‡ã€‚',
'æ²‰éƒæ–‡å­¦':'è¯­è¨€å‡ç»ƒå…‹åˆ¶ï¼Œæœ‰åˆ†é‡æ„Ÿã€‚å¤šç”¨æ„è±¡å’Œéšå–»ä¼ é€’æƒ…ç»ªï¼Œå°‘ç”¨ç›´ç™½çš„æƒ…æ„Ÿè¯æ±‡ã€‚å¥å¼å¯ä»¥é•¿è€Œå¤æ‚ï¼Œæœ‰æ€è¾¨æ€§ã€‚æ•´ä½“æ°›å›´æ²‰é™å†…æ•›ï¼Œç•™ç™½å¤šäºé“ºé™ˆã€‚',
'ç”œå® è¨€æƒ…':'è¯­è¨€ç”œè€Œä¸è…»ï¼Œæ³¨é‡ç»†èŠ‚æ’©æ‹¨ã€‚å–„ç”¨å¿ƒç†æå†™å±•ç°æš§æ˜§å’Œå¿ƒåŠ¨ï¼Œå¯¹è¯è¦æœ‰æ¥æœ‰å›çš„åŒ–å­¦ååº”ã€‚èŠ‚å¥ä¸Šå¼ å¼›æœ‰åº¦ï¼Œç”œèœœä¸­ç©¿æ’å°è¯¯ä¼šå°æ³¢æŠ˜ã€‚æ°›å›´æ„Ÿè¦å¼ºï¼Œæ³¨é‡å…‰çº¿ã€æ°”å‘³ã€æ¸©åº¦ç­‰æ„Ÿå®˜ç»†èŠ‚ã€‚',
'æ‚¬ç–‘ç´§å¼ ':'è¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œä¿¡æ¯é‡å¤§ã€‚å–„ç”¨çŸ­å¥åˆ¶é€ ç´§è¿«æ„Ÿï¼Œé•¿å¥é“ºå«ä¸å®‰æ°›å›´ã€‚å™è¿°è§†è§’è¦æœ‰é™åˆ¶æ„Ÿï¼Œè®©è¯»è€…å’Œä¸»è§’ä¸€èµ·å‘ç°çº¿ç´¢ã€‚å¤šç”¨æš—ç¤ºå’Œä¼ç¬”ï¼Œå…³é”®ä¿¡æ¯è¦è—åœ¨æ—¥å¸¸ç»†èŠ‚é‡Œã€‚',
'å¤é£å…¸é›…':'è¯­è¨€å…¸é›…å«è“„ï¼Œæœ‰å¤å…¸éŸµå‘³ä½†ä¸å †ç Œè¾è—»ã€‚å¯é€‚å½“åŒ–ç”¨è¯—è¯æ„å¢ƒï¼Œä½†å¯¹è¯è¦é€šä¿—æ˜“æ‡‚ã€‚æ³¨é‡æ„å¢ƒè¥é€ ï¼Œå–„ç”¨è‡ªç„¶æ™¯ç‰©æ˜ å°„äººç‰©å¿ƒå¢ƒã€‚èŠ‚å¥èˆ’ç¼“ä»å®¹ï¼Œæœ‰ç•™ç™½ä¹‹ç¾ã€‚',
'å¹½é»˜è®½åˆº':'è¯­è¨€æœºæ™ºçŠ€åˆ©ï¼Œå–„ç”¨åå·®å’Œå¤¸å¼ åˆ¶é€ å–œæ„Ÿã€‚å™è¿°è€…çš„å£°éŸ³è¦æœ‰ä¸ªæ€§ï¼Œåƒä¸€ä¸ªæ¯’èˆŒä½†å–„è‰¯çš„æ—è§‚è€…ã€‚å¯ä»¥æ‰“ç ´ç¬¬å››é¢å¢™ï¼Œç”¨ç°ä»£æ¢—å’Œç±»æ¯”è®©å¤è€çš„æ•…äº‹ç„•å‘æ–°æ„ã€‚ç¬‘ä¸­å¸¦æ³ªæœ€ä½³ã€‚',
'ç¡¬æ ¸å†™å®':'è¯­è¨€æœ´ç´ æ‰å®ï¼Œä¸ä¿®é¥°ä¸ç¾åŒ–ã€‚ç»†èŠ‚è¦ç»å¾—èµ·æ¨æ•²ï¼Œæ¶‰åŠä¸“ä¸šé¢†åŸŸè¦å‡†ç¡®ã€‚äººç‰©è¯´è¯è¦ç¬¦åˆèº«ä»½å’Œæ•™è‚²èƒŒæ™¯ï¼Œä¸è¦äººäººéƒ½å‡ºå£æˆç« ã€‚æƒ…èŠ‚æ¨è¿›é é€»è¾‘è€Œéå·§åˆï¼Œå†²çªæ¥è‡ªçœŸå®çš„åˆ©ç›Šå’Œç«‹åœºç¢°æ’ã€‚'
};
const desc=templates[name]||'';
document.getElementById('styleDesc').value=desc;
ap.curStyle=desc;sv(K.ap,ap);
showToast('å·²åº”ç”¨æ–‡é£: '+name);
}
function renderAllPresets(){renderApiPresets();renderCharPresets();renderWorldPresets();renderStylePresets();}

// ==================== APPEARANCE ====================
function setTheme(theme,el){
document.body.className='';
if(theme==='light')document.body.classList.add('theme-light');
else if(theme!=='default')document.body.classList.add('theme-'+theme);
document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
el.classList.add('act');
ap.theme=theme;sv(K.ap,ap);
}

function applyAppearance(){
document.body.className='';
if(ap.theme==='light')document.body.classList.add('theme-light');
else if(ap.theme&&ap.theme!=='default')document.body.classList.add('theme-'+ap.theme);

document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
const themeMap={default:'t0',warm:'t1',green:'t2',blue:'t3',light:'t4'};
const target=document.querySelector('.t-opt.'+(themeMap[ap.theme]||'t0'));
if(target)target.classList.add('act');

if(ap.fontUrl){
document.getElementById('customFontUrl').value=ap.fontUrl;
loadFont(ap.fontUrl);
}
}

function loadFont(url){
const existing=document.getElementById('cfStyle');
if(existing)existing.remove();
if(!url)return;
try{
const sanitized=url.replace(/"/g,'%22').replace(/'/g,'%27');
const style=document.createElement('style');
style.id='cfStyle';
style.textContent='@font-face{font-family:"CF";src:url("'+sanitized+'");font-display:swap;}body,.rd-content,.acard-pv,.acard-t,.rd-title{font-family:"CF",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif!important;}';
document.head.appendChild(style);
}catch(e){showToast('å­—ä½“åŠ è½½å¤±è´¥');console.warn(e);}
}

document.getElementById('customFontUrl').addEventListener('change',function(){
ap.fontUrl=this.value.trim();sv(K.ap,ap);loadFont(ap.fontUrl);
if(ap.fontUrl)showToast('å­—ä½“å·²æ›´æ–°ï¼Œå¦‚æ— å˜åŒ–è¯·æ£€æŸ¥é“¾æ¥');
});

function uploadRdBg(e){
const file=e.target.files[0];if(!file)return;
// Compress bg image
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=600;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
ap.rdBg=dataUrl;sv(K.ap,ap);showToast('é˜…è¯»èƒŒæ™¯å·²è®¾ç½® ğŸ¨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function clearRdBg(){
ap.rdBg='';sv(K.ap,ap);
document.getElementById('rdBg').style.display='none';
showToast('é˜…è¯»èƒŒæ™¯å·²æ¸…é™¤');
}

// ==================== DATA IMPORT/EXPORT ====================
function exportAllNotes(){
const allNotes={};
const allArticles=[...ws,...cols.books,...cols.shorts];
const ids=[...new Set(allArticles.map(a=>a.id))];
ids.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
if(n.length>0)allNotes[id]=n;
});
return allNotes;
}
function importAllNotes(notesObj){
if(!notesObj||typeof notesObj!=='object')return;
Object.keys(notesObj).forEach(id=>{
if(Array.isArray(notesObj[id])&&notesObj[id].length>0){
sv('bj_notes_'+id,notesObj[id]);
}
});
}
function exportData(){
saveCurSettings();
const data={
_app:'bijiAI',_version:3,_ver:APP_VER,_exportedAt:new Date().toISOString(),
apiPresets:apiP,charPresets:charP,worldPresets:worldP,
stylePresets:styleP,
curApi:ld(K.curApi,{}),
curChars:characters,
curWorld:ld(K.curWorld,{}),
collections:cols,workshop:ws,crWorks:crWorks,resPacks:resPacks,tags,appearance:ap,userCard:userCard,notes:exportAllNotes()
};
const jsonStr=JSON.stringify(data,null,2);
const sizeKB=(new Blob([jsonStr]).size/1024).toFixed(1);
const fileName='ç¬”è®°AI_å¤‡ä»½_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';

// æ–¹æ³•1: å°è¯•ä½¿ç”¨File System Access APIï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONæ–‡ä»¶',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('æ•°æ®å·²ä¿å­˜ ('+sizeKB+'KB) ğŸ“¤');
}catch(e){
if(e.name!=='AbortError')fallbackExport(jsonStr,fileName);
}
})();
return;
}

// æ–¹æ³•2: å°è¯•Android WebViewçš„ä¸‹è½½æ–¹å¼
if(/android/i.test(navigator.userAgent)){
try{
const blob=new Blob([jsonStr],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('æ•°æ®å·²å¯¼å‡ºï¼Œè¯·æŸ¥çœ‹ä¸‹è½½ç›®å½• ğŸ“¤');
return;
}catch(e){}
}

// æ–¹æ³•3: é€šç”¨å›é€€
fallbackExport(jsonStr,fileName);
}

function fallbackExport(jsonStr,fileName){
// ä½¿ç”¨data URIæ–¹å¼ï¼Œå…¼å®¹æ€§æœ€å¥½
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
showToast('æ•°æ®å·²å¯¼å‡º ğŸ“¤');
}

function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI'){showToast('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®',3000);return;}
showDlg('å¯¼å…¥ç¡®è®¤','å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰è®¾ç½®å’Œæ”¶è—æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',()=>{
if(data.apiPresets){apiP=data.apiPresets;sv(K.apiP,apiP);}
if(data.charPresets){charP=data.charPresets;sv(K.charP,charP);}
if(data.worldPresets){worldP=data.worldPresets;sv(K.worldP,worldP);}
if(data.stylePresets){styleP=data.stylePresets;sv('bj_styleP',styleP);}
if(data.curApi)sv(K.curApi,data.curApi);
if(data.curChars){characters=data.curChars;sv(K.curChars,characters);}
else if(data.currentChar){
// v1/ compatibility
const cc=data.currentChar;
characters=[{name:cc.aName||'',desc:cc.aDesc||''},{name:cc.bName||'',desc:cc.bDesc||''}];
sv(K.curChars,characters);
}
if(data.curWorld)sv(K.curWorld,data.curWorld);
else if(data.currentWorld)sv(K.curWorld,data.currentWorld);
if(data.collections){
cols=data.collections;
// Ensure fields
if(!cols.books)cols.books=[];
if(!cols.shorts)cols.shorts=[];
cols.books.forEach(b=>{if(!b.status)b.status='ongoing';if(!b.rating)b.rating=0;});
cols.shorts.forEach(s=>{if(!s.rating)s.rating=0;});
sv(K.cols,cols);
}
if(data.tags){tags=data.tags;sv(K.tags,tags);}
if(data.workshop){ws=data.workshop;sv(K.ws,ws);}
if(data.crWorks){crWorks=data.crWorks;sv('bj_crWorks',crWorks);}
if(data.resPacks){resPacks=data.resPacks;sv('bj_resPacks',resPacks);}
if(data.notes)importAllNotes(data.notes);
if(data.userCard){userCard=data.userCard;sv('bj_userCard',userCard);}
if(data.appearance){
ap={...{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2},...data.appearance};
sv(K.ap,ap);
}

// Reload forms
const api=data.curApi||data.currentApi||{};
document.getElementById('apiUrl').value=api.url||'';
document.getElementById('apiKey').value=api.key||'';
document.getElementById('apiModel').value=api.model||'gpt-4o-mini';
document.getElementById('apiTemp').value=api.temp??0.8;
document.getElementById('apiMaxTokens').value=api.maxTokens||4096;

const world=data.curWorld||data.currentWorld||{};
document.getElementById('worldDesc').value=world.desc||'';
document.getElementById('minWords').value=world.minWords||800;

renderTags();renderAllPresets();renderCollections();renderCharCards();
applyAppearance();
showToast('æ•°æ®å¯¼å…¥æˆåŠŸ ğŸ“¥');
});renderUserCard();
}catch(err){showToast('æ–‡ä»¶è§£æå¤±è´¥: '+err.message,3000);}
};
reader.readAsText(file);e.target.value='';
}
function deleteWsArticle(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
showDlg('åˆ é™¤æ–‡ç« ','ç¡®å®šè¦ä»ä½œåŠåˆ é™¤ã€Œ'+article.title+'ã€å—ï¼Ÿ',()=>{
ws=ws.filter(a=>a.id!==id);
sv(K.ws,ws);renderArticles();showToast('å·²åˆ é™¤');
},true);
}
function clearWorkshop(){
showDlg('æ¸…ç©ºä½œåŠ','ç¡®å®šè¦æ¸…ç©ºä½œåŠä¸­çš„æ‰€æœ‰æ–‡ç« å—ï¼Ÿå·²æ”¶è—çš„æ–‡ç« ä¸å—å½±å“ã€‚',()=>{
ws=[];sv(K.ws,ws);renderArticles();showToast('ä½œåŠå·²æ¸…ç©º');
},true);
}

// ==================== CREATE PAGE ====================
function switchCrTab(tab,el){
crTab=tab;
document.querySelectorAll('.cr-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderCrList();
}
function renderCrList(){
const list=document.getElementById('crList');
const filtered=crWorks.filter(w=>w.type===crTab);
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><p>'+(crTab==='draft'?'è¿˜æ²¡æœ‰è‰ç¨¿<br>ç‚¹å‡»ä¸Šæ–¹ã€Œæ–°å»ºè‰ç¨¿ã€å¼€å§‹å†™ä½œ':'è¿˜æ²¡æœ‰å°è¯´<br>ç‚¹å‡»ä¸Šæ–¹ã€Œæ–°å»ºå°è¯´ã€å¼€å§‹è¿è½½')+'</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(work=>{
const card=document.createElement('div');
card.className='cr-card';
let preview='';
if(work.type==='draft'){
preview=(work.content||'').replace(/\n/g,' ').substring(0,60);
}else{
const lastCh=work.chapters&&work.chapters.length>0?work.chapters[work.chapters.length-1]:'';
preview=(lastCh||'').replace(/\n/g,' ').substring(0,60);
}
const wc=getCrWordCount(work);
const time=work.updatedAt?new Date(work.updatedAt).toLocaleDateString():'';
const chInfo=work.type==='novel'&&work.chapters?' Â· '+work.chapters.length+'ç« ':'';
card.innerHTML=
'<div class="cr-card-hd">'+
'<div class="cr-card-t">'+esc(work.title||'æ— æ ‡é¢˜')+'</div>'+
'<span class="cr-card-badge '+work.type+'">'+(work.type==='draft'?'è‰ç¨¿':'å°è¯´')+'</span>'+
'</div>'+
'<div class="cr-card-pv">'+esc(preview||'æš‚æ— å†…å®¹')+'</div>'+
'<div class="cr-card-ft">'+
'<span class="cr-card-info">'+wc+'å­—'+chInfo+' Â· '+time+'</span>'+
'<div class="cr-card-acts">'+
'<button onclick="event.stopPropagation();copyCrWork(\''+work.id+'\')">å¤åˆ¶</button>'+
'<button onclick="event.stopPropagation();shareCrToRes(\''+work.id+'\')">åˆ†äº«</button>'+ '<button class="danger" onclick="event.stopPropagation();deleteCrWork(\''+work.id+'\')">åˆ é™¤</button>'+
'</div>'+
'</div>';
card.onclick=e=>{if(!e.target.closest('.cr-card-acts'))openEditor(work.id);};
list.appendChild(card);
});
}
function getCrWordCount(work){
if(work.type==='draft')return countWords(work.content||'');
let total=0;
if(work.chapters)work.chapters.forEach(ch=>total+=countWords(ch));
return total;
}
function newDraft(){
const work={
id:uid(),type:'draft',title:'',content:'',
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
}
function newNovel(){
showInp('æ–°å»ºå°è¯´','ç»™å°è¯´èµ·ä¸ªåå­—',name=>{
const work={
id:uid(),type:'novel',title:name,chapters:[''],
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
});
}
function deleteCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
showDlg('åˆ é™¤ç¡®è®¤','ç¡®å®šè¦åˆ é™¤ã€Œ'+(work.title||'æ— æ ‡é¢˜')+'ã€å—ï¼Ÿä¸å¯æ¢å¤ã€‚',()=>{
crWorks=crWorks.filter(w=>w.id!==id);
sv('bj_crWorks',crWorks);
renderCrList();
showToast('å·²åˆ é™¤');
},true);
}
function copyCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
let text='';
if(work.type==='draft'){
text=work.content||'';
}else if(work.chapters){
work.chapters.forEach((ch,i)=>{
text+='ç¬¬'+(i+1)+'ç« \n\n'+ch+'\n\n';
});
}
const header='â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nã€Œ'+(work.title||'æ— æ ‡é¢˜')+'ã€\nåŸåˆ›ä½œå“ Â· ç¬”è®°AIåˆ›ä½œé¡µ\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
const footer='\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nåˆ›ä½œå·¥å…·ï¼šç¬”è®°AI '+APP_VER+'\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
doCopy(header+text.trim()+footer);
}

// ==================== EDITOR ====================
function openEditor(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
curEd=work;
curEdCh=0;
document.getElementById('edTitle').value=work.title||'';
if(work.type==='novel'){
renderEdChBar();
document.getElementById('edChBar').style.display='flex';
document.getElementById('edTextarea').value=work.chapters[0]||'';
}else{
document.getElementById('edChBar').style.display='none';
document.getElementById('edTextarea').value=work.content||'';
}
updateEdWc();
document.getElementById('edSaveStatus').textContent='å·²ä¿å­˜';
document.getElementById('edOutlineBtn').style.display=(work.outline?'':'none');
document.getElementById('edModal').classList.add('show');
document.getElementById('bnav').classList.add('hide');
}
function closeEditor(){
saveEditorContent();
document.getElementById('edModal').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
curEd=null;
renderCrList();
}
function renderEdChBar(){
if(!curEd||curEd.type!=='novel')return;
const bar=document.getElementById('edChBar');
bar.innerHTML='';
curEd.chapters.forEach((_,i)=>{
const btn=document.createElement('button');
btn.className='ed-ch-btn'+(i===curEdCh?' act':'');
btn.textContent='ç¬¬'+(i+1)+'ç« ';
btn.onclick=()=>{
saveEditorChapter();
curEdCh=i;
document.getElementById('edTextarea').value=curEd.chapters[i]||'';
updateEdWc();
renderEdChBar();
};
bar.appendChild(btn);
});
const addBtn=document.createElement('button');
addBtn.className='ed-ch-add';
addBtn.textContent='+ æ–°ç« èŠ‚';
addBtn.onclick=()=>{
saveEditorChapter();
curEd.chapters.push('');
curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value='';
updateEdWc();
renderEdChBar();
saveEditorContent();
showToast('å·²æ·»åŠ ç¬¬'+curEd.chapters.length+'ç« ');
};
bar.appendChild(addBtn);
}
function saveEditorChapter(){
if(!curEd)return;
const text=document.getElementById('edTextarea').value;
if(curEd.type==='novel'){
if(curEd.chapters[curEdCh]!==undefined)curEd.chapters[curEdCh]=text;
}else{
curEd.content=text;
}
}
function saveEditorContent(){
if(!curEd)return;
saveEditorChapter();
curEd.title=(document.getElementById('edTitle').value||'').trim();
curEd.updatedAt=new Date().toISOString();
const idx=crWorks.findIndex(w=>w.id===curEd.id);
if(idx>-1)crWorks[idx]=curEd;
sv('bj_crWorks',crWorks);
document.getElementById('edSaveStatus').textContent='å·²ä¿å­˜ âœ“';
}
function onEditorInput(){
updateEdWc();
document.getElementById('edSaveStatus').textContent='ç¼–è¾‘ä¸­...';
if(edAutoSaveTimer)clearTimeout(edAutoSaveTimer);
edAutoSaveTimer=setTimeout(()=>{
saveEditorContent();
},2000);
}
function updateEdWc(){
const text=document.getElementById('edTextarea').value||'';
document.getElementById('edWc').textContent=countWords(text);
}
function copyEditorContent(){
if(!curEd)return;
saveEditorContent();
copyCrWork(curEd.id);
}
function formatEditorText(){
const ta=document.getElementById('edTextarea');
let text=ta.value||'';
// å…ˆæŠŠå¤šä¸ªè¿ç»­ç©ºè¡Œåˆå¹¶æˆä¸€ä¸ª
text=text.replace(/\n{3,}/g,'\n\n');
// æŠŠå•ä¸ªæ¢è¡Œï¼ˆæ²¡æœ‰ç©ºè¡Œåˆ†éš”çš„æ®µè½ï¼‰å˜æˆç©ºè¡Œåˆ†éš”
const lines=text.split('\n');
let result=[];
for(let i=0;i<lines.length;i++){
const line=lines[i];
result.push(line);
if(line.trim()&&i+1<lines.length&&lines[i+1].trim()){
result.push('');
}
}
text=result.join('\n');
text=text.replace(/\n{3,}/g,'\n\n');
text=text.trim();
ta.value=text;
onEditorInput();
showToast('æ’ç‰ˆå®Œæˆ Â¶');
}
// ==================== AI REVIEW ====================
async function requestAIReview(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API');return;}
saveEditorContent();
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<20){showToast('å†…å®¹å¤ªå°‘ï¼Œè‡³å°‘å†™20å­—å†è¯·AIè¯„ä»·');return;}
const body=document.getElementById('aiReviewBody');
body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2)"><span class="ldots"><span></span><span></span><span></span></span><br>AIæ­£åœ¨é˜…è¯»ä½ çš„ä½œå“...</div>';
document.getElementById('aiReviewOv').classList.add('show');
const sysMsg='ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æ–‡å­¦ç¼–è¾‘å’Œå†™ä½œå¯¼å¸ˆã€‚è¯·å¯¹ç”¨æˆ·æäº¤çš„æ–‡ç« è¿›è¡Œä¸“ä¸šè¯„ä»·ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ–¹é¢ï¼š\n1. æ•´ä½“å°è±¡ï¼ˆç®€çŸ­æ€»è¯„ï¼‰\n2. äº®ç‚¹ï¼ˆå†™å¾—å¥½çš„åœ°æ–¹ï¼Œå…·ä½“æŒ‡å‡ºï¼‰\n3. å¯æ”¹è¿›ä¹‹å¤„ï¼ˆå…·ä½“æŒ‡å‡ºé—®é¢˜å¹¶ç»™å‡ºä¿®æ”¹å»ºè®®ï¼‰\n4. æ–‡ç¬”è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰\n5. ä¸€å¥è¯é¼“åŠ±\n\nè¯·ç”¨æ¸©å’Œå‹å–„ä½†ä¸“ä¸šçš„è¯­æ°”ï¼Œåƒä¸€ä½å¥½è€å¸ˆé‚£æ ·ç»™å‡ºå»ºè®®ã€‚ä¸è¦ç©ºæ³›ï¼Œè¦ç»“åˆæ–‡ç« å…·ä½“å†…å®¹æ¥è¯„ä»·ã€‚';
const chInfo=curEd.type==='novel'?'ï¼ˆè¿™æ˜¯ç¬¬'+(curEdCh+1)+'ç« ï¼‰':'';
const userMsg='è¯·è¯„ä»·ä»¥ä¸‹ä½œå“'+chInfo+'ï¼š\n\næ ‡é¢˜ï¼š'+(curEd.title||'æ— æ ‡é¢˜')+'\n\næ­£æ–‡ï¼š\n'+text.substring(0,3000);
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
let reviewText='';
await callAPIStream(messages,
(fullText)=>{
reviewText=fullText;
body.textContent=fullText;
body.scrollTop=body.scrollHeight;
},
(fullText)=>{
if(fullText){
body.textContent=fullText;
}else{
body.innerHTML='<div style="color:var(--text2);text-align:center">è¯„ä»·å·²å–æ¶ˆ</div>';
}
},
(errMsg)=>{
body.textContent='è·å–è¯„ä»·å¤±è´¥ï¼š'+errMsg;
}
);
}
function closeAIReview(){
document.getElementById('aiReviewOv').classList.remove('show');
}
function shareCrToRes(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
const wc=getCrWordCount(work);
if(wc<10){showToast('å†…å®¹å¤ªå°‘ï¼Œè‡³å°‘å†™10å­—å†åˆ†äº«');return;}
showDlg('åˆ†äº«åˆ°èµ„æº','å°†ã€Œ'+(work.title||'æ— æ ‡é¢˜')+'ã€æ‰“åŒ…ä¸ºèµ„æºåŒ…å¹¶å¯¼å‡ºï¼Ÿ',()=>{
const packData=JSON.parse(JSON.stringify(work));
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:(work.title||'æ— æ ‡é¢˜')+'_åˆ†äº«',
desc:(work.type==='draft'?'è‰ç¨¿':'å°è¯´')+' Â· '+wc+'å­—',
author:'ç¬”è®°AIç”¨æˆ·',
createdAt:new Date().toISOString(),
items:[{
type:'work',
name:(work.type==='draft'?'è‰ç¨¿':'å°è¯´')+'ï¼š'+(work.title||'æ— æ ‡é¢˜'),
data:packData
}]
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='ç¬”è®°AI_åˆ†äº«_'+(work.title||'ä½œå“')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONæ–‡ä»¶',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('ä½œå“å·²å¯¼å‡ºä¸ºèµ„æºåŒ… ğŸ“¤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
});
}
function deleteEdChapter(){
if(!curEd||curEd.type!=='novel')return;
if(curEd.chapters.length<=1){showToast('è‡³å°‘ä¿ç•™ä¸€ç« ');return;}
showDlg('åˆ é™¤ç« èŠ‚','ç¡®å®šè¦åˆ é™¤ç¬¬'+(curEdCh+1)+'ç« å—ï¼Ÿä¸å¯æ¢å¤ã€‚',()=>{
curEd.chapters.splice(curEdCh,1);
if(curEdCh>=curEd.chapters.length)curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
saveEditorContent();
showToast('å·²åˆ é™¤');
},true);
}
// ==================== RESOURCE ====================
function switchResTab(tab,el){
resTab=tab;
document.querySelectorAll('.res-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderResList();
}
function renderResList(){
const list=document.getElementById('resList');
let items=[];
resPacks.forEach(pack=>{
if(pack.items&&Array.isArray(pack.items)){
pack.items.forEach(item=>{
item._packName=pack.name||'æœªå‘½åèµ„æºåŒ…';
item._packId=pack.id;
items.push(item);
});
}
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
if(items.length===0){
const tips={
all:'è¿˜æ²¡æœ‰èµ„æº<br>ç‚¹å‡»ã€Œæ‰“åŒ…å¯¼å‡ºã€åˆ†äº«ä½ çš„è®¾å®šï¼Œæˆ–ã€Œå¯¼å…¥èµ„æºåŒ…ã€è·å–åˆ«äººçš„',
char:'æ²¡æœ‰äººç‰©è®¾å®šèµ„æº',world:'æ²¡æœ‰ä¸–ç•Œè§‚èµ„æº',
style:'æ²¡æœ‰æ–‡é£èµ„æº',work:'æ²¡æœ‰ä½œå“èµ„æº',exp:'æ²¡æœ‰ç»éªŒåˆ†äº«'
};
list.innerHTML='<div class="empty-st"><p>'+(tips[resTab]||tips.all)+'</p></div>';
return;
}
list.innerHTML='';
items.forEach((item,idx)=>{
const card=document.createElement('div');
card.className='res-card';
const typeLabels={char:'äººç‰©è®¾å®š',world:'ä¸–ç•Œè§‚',style:'æ–‡é£',work:'ä½œå“',exp:'ç»éªŒåˆ†äº«'};
const preview=getResPreview(item);
card.innerHTML=
'<div class="res-card-hd">'+
'<div class="res-card-t">'+esc(item.name||'æœªå‘½å')+'</div>'+
'<span class="res-card-type '+item.type+'">'+(typeLabels[item.type]||'å…¶ä»–')+'</span>'+
'</div>'+
'<div class="res-card-pv">'+esc(preview)+'</div>'+
'<div class="res-card-ft">'+
'<span class="res-card-info">æ¥è‡ªï¼š'+esc(item._packName)+'</span>'+
'<div class="res-card-acts">'+
'<button class="use" onclick="event.stopPropagation();applyResItem(\''+item._packId+'\','+idx+')">åº”ç”¨</button>'+
'<button onclick="event.stopPropagation();copyResItem(\''+item._packId+'\','+idx+')">å¤åˆ¶</button>'+
'</div>'+
'</div>';
list.appendChild(card);
});
if(resPacks.length>0){
const mgr=document.createElement('div');
mgr.style.cssText='margin-top:16px;padding-top:14px;border-top:1px solid var(--border)';
mgr.innerHTML='<div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px">å·²å¯¼å…¥çš„èµ„æºåŒ…</div>';
resPacks.forEach(pack=>{
const pDiv=document.createElement('div');
pDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:7px';
const count=pack.items?pack.items.length:0;
const time=pack.createdAt?new Date(pack.createdAt).toLocaleDateString():'';
pDiv.innerHTML=
'<div><div style="font-size:12px;font-weight:600">'+esc(pack.name||'æœªå‘½å')+'</div>'+
'<div style="font-size:9px;color:var(--text2);margin-top:2px">'+count+'é¡¹èµ„æº Â· '+time+'</div></div>'+
'<button style="padding:4px 10px;border-radius:7px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:9px;cursor:pointer" onclick="deleteResPack(\''+pack.id+'\')">åˆ é™¤</button>';
mgr.appendChild(pDiv);
});
list.appendChild(mgr);
}
}
function getResPreview(item){
if(item.type==='char'){
const chars=item.data||[];
return chars.map(c=>(c.name||'æœªå‘½å')+'ï¼š'+(c.desc||'').substring(0,30)).join('ï¼›');
}
if(item.type==='world')return (item.data||'').substring(0,80);
if(item.type==='style')return (item.data||'').substring(0,80);
if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')return (w.content||'').substring(0,80);
if(w.chapters&&w.chapters.length>0)return (w.chapters[0]||'').substring(0,80);
return 'æš‚æ— å†…å®¹';
}
if(item.type==='exp')return (item.data||'').substring(0,80);
return '';
}
function applyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
if(item.type==='char'){
showDlg('åº”ç”¨äººç‰©è®¾å®š','å°†è¦†ç›–å½“å‰çš„äººç‰©è®¾å®šï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',()=>{
characters=JSON.parse(JSON.stringify(item.data||[{name:'',desc:''}]));
sv(K.curChars,characters);
showToast('äººç‰©è®¾å®šå·²åº”ç”¨ âœ…');
});
}else if(item.type==='world'){
showDlg('åº”ç”¨ä¸–ç•Œè§‚','å°†è¦†ç›–å½“å‰çš„ä¸–ç•Œè§‚è®¾å®šï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',()=>{
document.getElementById('worldDesc').value=item.data||'';
saveCurSettings();
showToast('ä¸–ç•Œè§‚å·²åº”ç”¨ âœ…');
});
}else if(item.type==='style'){
showDlg('åº”ç”¨æ–‡é£','å°†è¦†ç›–å½“å‰çš„æ–‡é£è®¾ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',()=>{
document.getElementById('styleDesc').value=item.data||'';
ap.curStyle=item.data||'';
sv(K.ap,ap);
showToast('æ–‡é£å·²åº”ç”¨ âœ…');
});
}else if(item.type==='work'){
showDlg('å¯¼å…¥ä½œå“','å°†æ·»åŠ åˆ°ä½ çš„åˆ›ä½œé¡µé¢ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ',()=>{
const w=JSON.parse(JSON.stringify(item.data));
w.id=uid();
w.createdAt=new Date().toISOString();
w.updatedAt=new Date().toISOString();
crWorks.unshift(w);
sv('bj_crWorks',crWorks);
showToast('ä½œå“å·²å¯¼å…¥åˆ°åˆ›ä½œé¡µ âœ…');
});
}else if(item.type==='exp'){
showDlg('æŸ¥çœ‹ç»éªŒ','æ˜¯å¦å¤åˆ¶è¿™æ¡ç»éªŒåˆ†äº«åˆ°å‰ªè´´æ¿ï¼Ÿ',()=>{
doCopy(item.data||'');
});
}
}
function copyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
let text='';
if(item.type==='char'){
const chars=item.data||[];
text=chars.map(c=>'ã€'+c.name+'ã€‘\n'+c.desc).join('\n\n');
}else if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')text=w.content||'';
else if(w.chapters)text=w.chapters.map((ch,i)=>'ç¬¬'+(i+1)+'ç« \n\n'+ch).join('\n\n');
}else{
text=item.data||'';
}
doCopy(text);
}

// ==================== RESOURCE EXPORT ====================
function openResExport(){
const box=document.getElementById('resExpList');
box.innerHTML='';
const exportItems=[];
saveCharactersFromUI();
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
exportItems.push({id:'cur_char',type:'char',label:'å½“å‰äººç‰©è®¾å®š',desc:validChars.map(c=>c.name).filter(Boolean).join('ã€')||'æœªå‘½åè§’è‰²',data:validChars});
}
charP.forEach((p,i)=>{
exportItems.push({id:'charP_'+i,type:'char',label:'äººç‰©é¢„è®¾ï¼š'+p.name,desc:(p.characters||[]).map(c=>c.name).filter(Boolean).join('ã€'),data:p.characters});
});
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD){
exportItems.push({id:'cur_world',type:'world',label:'å½“å‰ä¸–ç•Œè§‚',desc:wD.substring(0,40),data:wD});
}
worldP.forEach((p,i)=>{
exportItems.push({id:'worldP_'+i,type:'world',label:'ä¸–ç•Œè§‚é¢„è®¾ï¼š'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const sD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||'').trim();
if(sD){
exportItems.push({id:'cur_style',type:'style',label:'å½“å‰æ–‡é£',desc:sD.substring(0,40),data:sD});
}
styleP.forEach((p,i)=>{
exportItems.push({id:'styleP_'+i,type:'style',label:'æ–‡é£é¢„è®¾ï¼š'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
crWorks.forEach(w=>{
exportItems.push({id:'work_'+w.id,type:'work',label:(w.type==='draft'?'è‰ç¨¿':'å°è¯´')+'ï¼š'+(w.title||'æ— æ ‡é¢˜'),desc:getCrWordCount(w)+'å­—',data:w});
});
if(exportItems.length===0){
box.innerHTML='<p style="font-size:12px;color:var(--text2);text-align:center;padding:20px">æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹<br>è¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ äººç‰©/ä¸–ç•Œè§‚/æ–‡é£ï¼Œæˆ–åœ¨åˆ›ä½œé¡µå†™ç‚¹ä¸œè¥¿</p>';
document.getElementById('resExpOv').classList.add('show');
return;
}
const typeLabels={char:'ğŸ‘¤ äººç‰©',world:'ğŸŒ ä¸–ç•Œè§‚',style:'âœ’ï¸ æ–‡é£',work:'ğŸ“„ ä½œå“'};
exportItems.forEach(item=>{
const div=document.createElement('div');
div.className='res-chk-item';
div.dataset.resId=item.id;
div.dataset.resType=item.type;
div.dataset.resData=JSON.stringify(item.data);
div.dataset.resLabel=item.label;
div.onclick=()=>{div.classList.toggle('checked');};
div.innerHTML=
'<div class="res-chk-box">âœ“</div>'+
'<div class="res-chk-info">'+
'<div class="res-chk-name">'+(typeLabels[item.type]||'')+' '+esc(item.label)+'</div>'+
'<div class="res-chk-desc">'+esc(item.desc)+'</div>'+
'</div>';
box.appendChild(div);
});
document.getElementById('resPackName').value='';
document.getElementById('resPackDesc').value='';
document.getElementById('resExpOv').classList.add('show');
}
function closeResExport(){
document.getElementById('resExpOv').classList.remove('show');
}
function doResExport(){
const checked=document.querySelectorAll('#resExpList .res-chk-item.checked');
if(checked.length===0){showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹');return;}
const items=[];
checked.forEach(el=>{
items.push({
type:el.dataset.resType,
name:el.dataset.resLabel,
data:JSON.parse(el.dataset.resData)
});
});
const packName=(document.getElementById('resPackName').value||'').trim()||'èµ„æºåŒ…';
const packDesc=(document.getElementById('resPackDesc').value||'').trim();
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:packName,
desc:packDesc,
author:'ç¬”è®°AIç”¨æˆ·',
createdAt:new Date().toISOString(),
items:items
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='ç¬”è®°AI_èµ„æº_'+packName+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONæ–‡ä»¶',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
closeResExport();
showToast('èµ„æºåŒ…å·²å¯¼å‡º ğŸ“¤');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
}
function fallbackResExport(jsonStr,fileName){
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
closeResExport();
showToast('èµ„æºåŒ…å·²å¯¼å‡º ğŸ“¤');
}
function writeExpShare(){
document.getElementById('expTitle').value='';
document.getElementById('expContent').value='';
document.getElementById('expOv').classList.add('show');
setTimeout(()=>document.getElementById('expTitle').focus(),100);
}
function closeExpDlg(){
document.getElementById('expOv').classList.remove('show');
}
function saveExpShare(){
const title=(document.getElementById('expTitle').value||'').trim();
const content=(document.getElementById('expContent').value||'').trim();
if(!title){showToast('è¯·è¾“å…¥æ ‡é¢˜');return;}
if(!content){showToast('è¯·è¾“å…¥å†…å®¹');return;}
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:title,
desc:'ç»éªŒåˆ†äº«',
author:'ç¬”è®°AIç”¨æˆ·',
createdAt:new Date().toISOString(),
items:[{type:'exp',name:title,data:content}]
};
resPacks.unshift(pack);
sv('bj_resPacks',resPacks);
closeExpDlg();
renderResList();
showToast('ç»éªŒå·²ä¿å­˜ âœ…');
}
function deleteResPack(id){
const pack=resPacks.find(p=>p.id===id);
if(!pack)return;
showDlg('åˆ é™¤èµ„æºåŒ…','ç¡®å®šè¦åˆ é™¤ã€Œ'+(pack.name||'æœªå‘½å')+'ã€å—ï¼Ÿ',()=>{
resPacks=resPacks.filter(p=>p.id!==id);
sv('bj_resPacks',resPacks);
renderResList();
showToast('èµ„æºåŒ…å·²åˆ é™¤');
},true);
}
function importResPack(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI_resource'||!data.items){
showToast('è¿™ä¸æ˜¯æœ‰æ•ˆçš„èµ„æºåŒ…æ–‡ä»¶',3000);return;
}
const existing=resPacks.findIndex(p=>p.id===data.id);
if(existing>-1){
showDlg('é‡å¤èµ„æºåŒ…','å·²å­˜åœ¨åŒåèµ„æºåŒ…ã€Œ'+(data.name||'')+'ã€ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ',()=>{
resPacks[existing]=data;
sv('bj_resPacks',resPacks);
renderResList();
showToast('èµ„æºåŒ…å·²æ›´æ–° ğŸ“¥');
});
}else{
resPacks.unshift(data);
sv('bj_resPacks',resPacks);
renderResList();
const count=data.items.length;
showToast('å·²å¯¼å…¥ã€Œ'+(data.name||'èµ„æºåŒ…')+'ã€('+count+'é¡¹) ğŸ“¥');
}
}catch(err){showToast('æ–‡ä»¶è§£æå¤±è´¥: '+err.message,3000);}
};
reader.readAsText(file);
e.target.value='';
}
// ==================== HANDBOOK ====================
function openHandbook(){
document.getElementById('hbOv').classList.add('show');
}
function closeHandbook(){
document.getElementById('hbOv').classList.remove('show');
}
// ==================== USER CARD ====================
function renderUserCard(){
const uc=userCard;
const nameEl=document.getElementById('ucName');
const bioEl=document.getElementById('ucBio');
const avatarEl=document.getElementById('ucAvatar');
nameEl.textContent=uc.name||'ç‚¹å‡»è®¾ç½®æ˜µç§°';
bioEl.textContent=uc.bio||'ç‚¹å‡»æ·»åŠ ä¸ªäººç®€ä»‹...';
if(uc.avatar){
avatarEl.innerHTML='<img src="'+uc.avatar+'" alt="å¤´åƒ"><div class="ucard-avatar-hint">æ›´æ¢</div>';
}else{
avatarEl.innerHTML='<span id="ucAvatarPh">âœ¦</span><div class="ucard-avatar-hint">æ›´æ¢</div>';
}
updateStats();
}
function updateStats(){
let totalWords=0;
let worksCount=0;
// ä½œåŠæ–‡ç« 
ws.forEach(a=>{totalWords+=getTotalWords(a);});
worksCount+=ws.length;
// åˆ›ä½œä½œå“
crWorks.forEach(w=>{totalWords+=getCrWordCount(w);});
worksCount+=crWorks.length;
// æ”¶è—é‡Œç‹¬æœ‰çš„ï¼ˆä¸åœ¨ä½œåŠé‡Œçš„ï¼‰
cols.books.forEach(b=>{
if(!ws.find(a=>a.id===b.id))totalWords+=getTotalWords(b);
});
cols.shorts.forEach(s=>{
if(!ws.find(a=>a.id===s.id))totalWords+=getTotalWords(s);
});
const colsCount=cols.books.length+cols.shorts.length;
// ç¬”è®°æ€»æ•°
let notesCount=0;
const allIds=new Set();
[...ws,...cols.books,...cols.shorts].forEach(a=>allIds.add(a.id));
allIds.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
notesCount+=n.length;
});
document.getElementById('statTotal').textContent=formatNum(totalWords);
document.getElementById('statWorks').textContent=worksCount;
document.getElementById('statCols').textContent=colsCount;
document.getElementById('statNotes').textContent=notesCount;
}
function formatNum(n){
if(n>=10000)return (n/10000).toFixed(1)+'ä¸‡';
if(n>=1000)return (n/1000).toFixed(1)+'k';
return n;
}
function uploadAvatar(){
document.getElementById('avatarUp').click();
}
function handleAvatarUpload(e){
const file=e.target.files[0];
if(!file)return;
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const size=120;
canvas.width=size;canvas.height=size;
const ctx=canvas.getContext('2d');
const min=Math.min(img.width,img.height);
const sx=(img.width-min)/2;
const sy=(img.height-min)/2;
ctx.drawImage(img,sx,sy,min,min,0,0,size,size);
const dataUrl=canvas.toDataURL('image/jpeg',0.8);
userCard.avatar=dataUrl;
sv('bj_userCard',userCard);
renderUserCard();
showToast('å¤´åƒå·²æ›´æ–° ğŸ¨');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}
function editUcName(){
showInp('è®¾ç½®æ˜µç§°','è¾“å…¥ä½ çš„æ˜µç§°',name=>{
userCard.name=name;
sv('bj_userCard',userCard);
renderUserCard();
showToast('æ˜µç§°å·²æ›´æ–°');
});
}
function editUcBio(){
const ov=document.getElementById('inpOv');
document.getElementById('inpTitle').textContent='ç¼–è¾‘ç®€ä»‹';
const f=document.getElementById('inpField');
f.placeholder='å†™ä¸€å¥è¯ä»‹ç»è‡ªå·±...';
f.value=userCard.bio||'';
document.getElementById('inpOkBtn').onclick=()=>{
userCard.bio=f.value.trim();
sv('bj_userCard',userCard);
closeInp();
renderUserCard();
showToast('ç®€ä»‹å·²æ›´æ–°');
};
ov.classList.add('show');
setTimeout(()=>f.focus(),100);
}
// ==================== OUTLINE GENERATOR ====================
let outlineChCount=10;
let outlineText='';
function openOutlineGen(){
document.getElementById('outlineTitle').value='';
document.getElementById('outlineDesc').value='';
document.getElementById('outlineResult').style.display='none';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineGenBtn').style.display='';
document.getElementById('outlineGenBtn').disabled=false;
document.getElementById('outlineGenBtn').textContent='ğŸ§  ç”Ÿæˆå¤§çº²';
outlineText='';
document.getElementById('outlineOv').classList.add('show');
setTimeout(()=>document.getElementById('outlineDesc').focus(),200);
}
function closeOutlineGen(){
document.getElementById('outlineOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
function setOutlineCh(n,el){
outlineChCount=n;
el.parentElement.querySelectorAll('.tag').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}
async function doGenOutline(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API');return;}
const desc=(document.getElementById('outlineDesc').value||'').trim();
const title=(document.getElementById('outlineTitle').value||'').trim();
if(!desc){showToast('è¯·æè¿°ä¸€ä¸‹ä½ æƒ³å†™çš„æ•…äº‹');return;}
const btn=document.getElementById('outlineGenBtn');
btn.disabled=true;
btn.innerHTML='ç”Ÿæˆä¸­ <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('outlineResult').style.display='block';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineContent').textContent='æ­£åœ¨æ„æ€å¤§çº²...';
let sysMsg='ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°è¯´ç­–åˆ’ç¼–è¾‘ï¼Œæ“…é•¿æ„å»ºæ•…äº‹æ¶æ„å’Œç« èŠ‚å¤§çº²ã€‚\n';
sysMsg+='è¯·æ ¹æ®ç”¨æˆ·çš„æè¿°ï¼Œç”Ÿæˆä¸€ä»½è¯¦ç»†çš„å°è¯´å¤§çº²ã€‚\n\n';
sysMsg+='ã€è¾“å‡ºæ ¼å¼è¦æ±‚ã€‘\n';
sysMsg+='ç¬¬ä¸€è¡Œï¼šå°è¯´æ ‡é¢˜ï¼ˆçº¯æ–‡å­—ï¼‰\n';
sysMsg+='ç¬¬äºŒè¡Œï¼šç©ºè¡Œ\n';
sysMsg+='ç¬¬ä¸‰è¡Œï¼šä¸€å¥è¯æ•…äº‹ç®€ä»‹\n';
sysMsg+='ç¬¬å››è¡Œï¼šç©ºè¡Œ\n';
sysMsg+='ç„¶åé€ç« åˆ—å‡ºå¤§çº²ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n';
sysMsg+='ç¬¬Xç« ï¼šç« èŠ‚æ ‡é¢˜\n';
sysMsg+='- æœ¬ç« æ¦‚è¦ï¼ˆ2-3å¥è¯æè¿°æœ¬ç« ä¸»è¦å†…å®¹ã€å…³é”®äº‹ä»¶ã€æƒ…æ„Ÿè½¬æŠ˜ï¼‰\n\n';
sysMsg+='è¦æ±‚ï¼š\n';
sysMsg+='- å…±'+outlineChCount+'ç« \n';
sysMsg+='- æ•…äº‹çº¿è¦å®Œæ•´ï¼ˆå¼€ç«¯â†’å‘å±•â†’é«˜æ½®â†’ç»“å±€ï¼‰\n';
sysMsg+='- æ¯ç« ä¹‹é—´è¦æœ‰å› æœå…³ç³»å’Œé€’è¿›\n';
sysMsg+='- æ³¨æ„ä¼ç¬”å’Œæ‚¬å¿µçš„è®¾ç½®\n';
sysMsg+='- ä¸è¦è¾“å‡ºä»»ä½•å¤šä½™å†…å®¹\n';
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
sysMsg+='\nã€å¯ç”¨è§’è‰²ã€‘\n';
validChars.forEach((c,i)=>{
sysMsg+='è§’è‰²'+(i+1)+'ï¼š'+(c.name||'æœªå‘½å');
if(c.desc)sysMsg+='ï¼ˆ'+c.desc.substring(0,60)+'ï¼‰';
sysMsg+='\n';
});
}
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD)sysMsg+='\nã€ä¸–ç•Œè§‚ã€‘\n'+wD.substring(0,300)+'\n';
let userMsg='è¯·ä¸ºä»¥ä¸‹æ•…äº‹ç”Ÿæˆ'+outlineChCount+'ç« çš„è¯¦ç»†å¤§çº²ï¼š\n\n';
if(title)userMsg+='æ ‡é¢˜æ–¹å‘ï¼š'+title+'\n';
userMsg+='æ•…äº‹æè¿°ï¼š'+desc;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const contentEl=document.getElementById('outlineContent');
outlineText='';
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outlineText=fullText;
contentEl.textContent=fullText;
contentEl.parentElement.scrollTop=contentEl.parentElement.scrollHeight;
},
(fullText)=>{
btn.disabled=false;btn.textContent='ğŸ§  ç”Ÿæˆå¤§çº²';
if(fullText){
outlineText=fullText;
contentEl.textContent=fullText;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='ç”Ÿæˆå·²å–æ¶ˆ';
}
},
(errMsg)=>{
btn.disabled=false;btn.textContent='ğŸ§  ç”Ÿæˆå¤§çº²';
contentEl.textContent='ç”Ÿæˆå¤±è´¥ï¼š'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;btn.textContent='ğŸ§  ç”Ÿæˆå¤§çº²';
if(result){
outlineText=result;
contentEl.textContent=result;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®';
}
}
}
function applyOutline(){
if(!outlineText){showToast('æ²¡æœ‰å¤§çº²å†…å®¹');return;}
let title='';
const lines=outlineText.split('\n');
for(let i=0;i<Math.min(3,lines.length);i++){
const l=lines[i].trim();
if(l&&l.length<40&&!l.startsWith('-')&&!l.startsWith('ç¬¬')){
title=l.replace(/^[#*ã€Šã€Œã€\s:ï¼šæ ‡é¢˜]+/,'').replace(/[ã€‹ã€ã€‘\s]+$/,'').trim();
break;
}
}
const inputTitle=(document.getElementById('outlineTitle').value||'').trim();
if(inputTitle)title=inputTitle;
if(!title)title='æœªå‘½åå°è¯´';
const work={
id:uid(),type:'novel',title:title,
chapters:[''],
outline:outlineText,
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
closeOutlineGen();
openEditor(work.id);
showToast('å°è¯´å·²åˆ›å»ºï¼Œå¤§çº²å·²ä¿å­˜ ğŸ“‹');
}
// ==================== AI REWRITE ====================
async function aiRewriteChapter(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API');return;}
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<10){showToast('å½“å‰ç« èŠ‚å†…å®¹å¤ªå°‘ï¼Œè‡³å°‘10å­—æ‰èƒ½é‡å†™');return;}
showDlg('AIé‡å†™ç¡®è®¤','AIå°†é‡æ–°æ”¹å†™å½“å‰ç« èŠ‚å†…å®¹ï¼ŒåŸå†…å®¹ä¼šè¢«æ›¿æ¢ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ',async()=>{
const ta=document.getElementById('edTextarea');
const statusEl=document.getElementById('edSaveStatus');
statusEl.textContent='AIé‡å†™ä¸­...';
ta.disabled=true;
let sysMsg='ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„æ–‡å­¦ç¼–è¾‘å…¼æ”¹ç¨¿äººã€‚ä½ çš„å·¥ä½œæ˜¯å°†ä¸€ç¯‡æœ‰æ½œåŠ›ä½†ç²—ç³™çš„åˆç¨¿ï¼Œæ‰“ç£¨æˆä¸€ç¯‡è®©äººè¯»äº†ä¼šèµ·é¸¡çš®ç–™ç˜©çš„å¥½æ–‡ç« ã€‚\n\n';
sysMsg+='ä½ çš„æ”¹ç¨¿åŸåˆ™ï¼š\n';
sysMsg+='1. å‰§æƒ…éª¨æ¶ä¸åŠ¨â€”â€”ä¿ç•™æ‰€æœ‰å…³é”®äº‹ä»¶ã€äººç‰©å…³ç³»ã€æƒ…èŠ‚èµ°å‘\n';
sysMsg+='2. è¡€è‚‰å…¨éƒ¨é‡å¡‘â€”â€”æ¯ä¸€å¥è¯éƒ½ç”¨æ›´ç²¾å‡†ã€æ›´æœ‰ç”»é¢æ„Ÿçš„æ–¹å¼é‡æ–°è¡¨è¾¾\n';
sysMsg+='3. è¡¥å……åŸæ–‡ç¼ºå¤±çš„ï¼šæ„Ÿå®˜ç»†èŠ‚ï¼ˆæ°”å‘³ã€è§¦æ„Ÿã€å£°éŸ³ï¼‰ã€å¾®è¡¨æƒ…ã€ç¯å¢ƒæ°›å›´ã€æ½œå°è¯\n';
sysMsg+='4. ä¿®å¤åŸæ–‡çš„é—®é¢˜ï¼šåˆ é™¤ç©ºæ´å½¢å®¹è¯ã€æ¶ˆç­ä¸‡èƒ½å‰¯è¯ã€æ‰“ç ´é‡å¤å¥å¼ã€è®©å¯¹è¯æ›´å£è¯­åŒ–\n';
sysMsg+='5. æå‡èŠ‚å¥æ„Ÿï¼šç´§å¼ å¤„åŠ é€Ÿï¼ˆçŸ­å¥ã€æ–­å¥ï¼‰ï¼Œèˆ’ç¼“å¤„å‡é€Ÿï¼ˆé•¿å¥ã€ç»†æï¼‰\n';
sysMsg+='6. å­—æ•°åº”ä¸å°‘äºåŸæ–‡ï¼Œå› ä¸ºå¥½çš„æ”¹å†™é€šå¸¸ä¼šæ›´ä¸°æ»¡\n';
sysMsg+='7. ç›´æ¥è¾“å‡ºæ”¹å†™åçš„æ­£æ–‡ï¼Œä¸åŠ ä»»ä½•è¯´æ˜ã€æ ‡é¢˜ã€ç« èŠ‚å·ã€markdownæ ¼å¼\n';
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\nã€æ–‡é£è¦æ±‚ã€‘'+styleD+'\n';
const chInfo=curEd.type==='novel'?'è¿™æ˜¯ã€Œ'+(curEd.title||'')+'ã€çš„ç¬¬'+(curEdCh+1)+'ç« ã€‚':'';
let contextInfo='';
if(curEd.type==='novel'&&curEd.chapters&&curEdCh>0){
const prevCh=curEd.chapters[curEdCh-1]||'';
if(prevCh)contextInfo='\n\nã€ä¸Šä¸€ç« ç»“å°¾å‚è€ƒã€‘\n'+prevCh.substring(prevCh.length-300)+'\n';
}
let outlineInfo='';
if(curEd.outline){
outlineInfo='\n\nã€å°è¯´å¤§çº²å‚è€ƒã€‘\n'+curEd.outline.substring(0,500)+'\n';
}
const userMsg=chInfo+contextInfo+outlineInfo+'\n\nè¯·é‡å†™ä»¥ä¸‹ç« èŠ‚å†…å®¹ï¼š\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
if(useStream){
await callAPIStream(messages,
(fullText)=>{
ta.value=fullText;
updateEdWc();
},
(fullText)=>{
ta.disabled=false;
if(fullText){
ta.value=fullText;
updateEdWc();
saveEditorContent();
statusEl.textContent='é‡å†™å®Œæˆ âœ“';
showToast('ç« èŠ‚å·²é‡å†™ âœ¨');
}else{
statusEl.textContent='é‡å†™å·²å–æ¶ˆ';
}
},
(errMsg)=>{
ta.disabled=false;
statusEl.textContent='é‡å†™å¤±è´¥';
showToast('é‡å†™å¤±è´¥ï¼š'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
ta.disabled=false;
if(result){
ta.value=result;
updateEdWc();
saveEditorContent();
statusEl.textContent='é‡å†™å®Œæˆ âœ“';
showToast('ç« èŠ‚å·²é‡å†™ âœ¨');
}else{
statusEl.textContent='é‡å†™å¤±è´¥';
}
}
});
}
function toggleStreamSwitch(el){
const cb=document.getElementById('streamOn');
cb.checked=!cb.checked;
useStream=cb.checked;
sv('bj_stream',useStream);
updateStreamUI();
showToast(useStream?'å·²å¼€å¯æµå¼è¾“å‡º':'å·²å…³é—­æµå¼è¾“å‡º');
}
function updateStreamUI(){
const track=document.getElementById('streamTrack');
const thumb=document.getElementById('streamThumb');
if(useStream){
track.style.background='var(--accent)';
thumb.style.left='22px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}
function openInspiration(){
const subjects=[
'ä¸€ä¸ªå¤±æ˜çš„ç”»å®¶','ä¸€ä¸ªèƒ½å¬åˆ°äº¡è€…å£°éŸ³çš„æ®¡è‘¬å¸ˆ','ä¸€ä¸ªè®°å¿†åªæœ‰ä¸ƒå¤©çš„ä¾¦æ¢',
'ä¸€ä¸ªæ°¸è¿œæ— æ³•è¯´è°çš„å¾‹å¸ˆ','ä¸€ä¸ªèƒ½é—»åˆ°æƒ…ç»ªçš„è°ƒé¦™å¸ˆ','ä¸€ä¸ªå®³æ€•æ°´çš„ç¯å¡”å®ˆæŠ¤äºº',
'ä¸€ä¸ªåªåœ¨é›¨å¤©å‡ºç°çš„å¿«é€’å‘˜','ä¸€ä¸ªèƒ½çœ‹åˆ°çº¢çº¿çš„æœˆè€å®ä¹ ç”Ÿ','ä¸€ä¸ªä¸ä¼šåšæ¢¦çš„å¿ƒç†åŒ»ç”Ÿ',
'ä¸€ä¸ªè¢«è¯…å’’æ°¸è¿œæ¸…é†’çš„å¤±çœ è€…','ä¸€ä¸ªèƒ½å’ŒåŠ¨ç‰©äº¤è°ˆçš„å…½åŒ»','ä¸€ä¸ªæ¯å¤©éƒ½ä¼šæ­»ä¸€æ¬¡çš„ä¸æ­»è€…',
'ä¸€ä¸ªæ”¶é›†é—è¨€çš„é‚®å·®','ä¸€ä¸ªèƒ½è§¦æ‘¸åˆ°å£°éŸ³çš„è‹äºº','ä¸€ä¸ªå½±å­ä¼šè‡ªå·±è¡ŒåŠ¨çš„æ™®é€šäºº',
'ä¸€ä¸ªåªèƒ½åœ¨é•œå­é‡Œçœ‹åˆ°æœªæ¥çš„å åœå¸ˆ','ä¸€ä¸ªè¡€æ¶²æ˜¯å¢¨æ°´çš„ä½œå®¶','ä¸€ä¸ªèƒ½å°å‡ºè°è¨€å‘³é“çš„å¨å¸ˆ',
'åŒèƒèƒä¸­è¢«é—å¿˜çš„é‚£ä¸€ä¸ª','ä¸€ä¸ªé€€ä¼‘çš„æ—¶é—´æ—…è¡Œè€…','ä¸€ä¸ªä»¥è´©å–è®°å¿†ä¸ºç”Ÿçš„å•†äºº'
];
const events=[
'åœ¨ä¸€ä¸ªæ°¸è¿œä¸‹é›ªçš„åŸå¸‚é‡Œå‘ç°äº†ä¸€å°æ¥è‡ªè‡ªå·±çš„ä¿¡',
'åœ¨æ·±å¤œçš„åœ°é“ç«™é‡åˆ°äº†ä¸€ä¸ªä¸è¯¥å­˜åœ¨çš„äºº',
'æ”¶åˆ°äº†ä¸€ä»½æ¥è‡ªåå¹´åçš„åŒ…è£¹',
'åœ¨æ—§å…¬å¯“çš„å¢™å£é‡Œå‘ç°äº†ä¸€ä¸ªé€šå¾€åˆ«å¤„çš„é—¨',
'åœ¨æš´é£é›¨çš„å¤œæ™šæ¥åˆ°äº†ä¸€ä¸ªå·²ç»å»ä¸–ä¹‹äººçš„ç”µè¯',
'å‘ç°è‡ªå·±æ¯å¤©é†’æ¥éƒ½åœ¨ä¸åŒäººçš„èº«ä½“é‡Œ',
'åœ¨è·³èš¤å¸‚åœºä¹°åˆ°äº†ä¸€æœ¬è®°å½•ç€è‡ªå·±ä¸€ç”Ÿçš„ä¹¦',
'åœ¨ä¸€åœºå¤§é›¾ä¸­èµ°è¿›äº†ä¸€ä¸ªåœ°å›¾ä¸Šä¸å­˜åœ¨çš„å°é•‡',
'å‘ç°é•œå­é‡Œçš„è‡ªå·±å¼€å§‹åšå‡ºä¸åŒçš„åŠ¨ä½œ',
'åœ¨ä¸€æ£µå¤æ ‘çš„æ ‘æ´é‡Œå‘ç°äº†ä¸€ç™¾å¹´å‰å†™ç»™è‡ªå·±çš„æƒ…ä¹¦',
'è¢«ä¸€ä¸ªé™Œç”Ÿäººé€’äº†ä¸€æŠŠé’¥åŒ™ï¼Œè¯´"ä½ çŸ¥é“è¯¥æ‰“å¼€ä»€ä¹ˆ"',
'åœ¨åŒ»é™¢é†’æ¥ï¼Œæ‰€æœ‰äººéƒ½è¯´è‡ªå·±å·²ç»æ¶ˆå¤±äº†ä¸‰å¹´',
'å‘ç°è‡ªå·±å…»çš„çŒ«æ¯å¤©å‡Œæ™¨ä¸‰ç‚¹éƒ½ä¼šå˜æˆäººå½¢',
'åœ¨ä¸€åœºè‘¬ç¤¼ä¸Šè®¤å‡ºäº†æ£ºæé‡Œçš„äººæ˜¯è‡ªå·±',
'æ”¶åˆ°ä¸€å¼ åªå†™äº†ç»çº¬åº¦çš„æ˜ä¿¡ç‰‡ï¼Œåˆ°è¾¾åå‘ç°äº†ä¸å¯æ€è®®çš„ä¸œè¥¿'
];
const twists=[
'ä½†çœŸç›¸è¿œæ¯”æƒ³è±¡çš„æ›´ä»¤äººå¿ƒç¢','è€Œè¿™ä¸€åˆ‡çš„èƒŒåè—ç€ä¸€ä¸ªå…³äºæ•‘èµçš„ç§˜å¯†',
'å´å‘ç°è¿™åªæ˜¯æ›´å¤§è°œå›¢çš„å¼€å§‹','è€Œä»£ä»·æ˜¯å¤±å»æœ€çè´µçš„è®°å¿†',
'ä½†æ¯ä¸€æ¬¡é€‰æ‹©éƒ½é€šå‘åŒä¸€ä¸ªç»“å±€','è€Œå”¯ä¸€çš„çº¿ç´¢æŒ‡å‘äº†è‡ªå·±æœ€ä¿¡ä»»çš„äºº',
'å´åœ¨æœ€åå‘ç°ï¼Œä¸€åˆ‡éƒ½æ˜¯è‡ªå·±äº²æ‰‹é€ æˆçš„','ä½†æ—¶é—´å·²ç»æ‰€å‰©æ— å‡ ',
'è€Œè¿™ä¸ªä¸–ç•Œçš„è§„åˆ™æ­£åœ¨æ‚„æ‚„æ”¹å˜','å´ä¸çŸ¥é“æœ‰äººä¸€ç›´åœ¨æš—ä¸­å®ˆæŠ¤ç€è¿™ä¸€åˆ‡',
'ä½†å›å¿†å’Œç°å®ä¹‹é—´çš„ç•Œé™å¼€å§‹æ¨¡ç³Š','è€Œç»ˆç‚¹ç«Ÿç„¶æ˜¯ä¸€åˆ‡å¼€å§‹çš„åœ°æ–¹'
];
const s=subjects[Math.floor(Math.random()*subjects.length)];
const e=events[Math.floor(Math.random()*events.length)];
const useTwist=Math.random()>0.4;
const t=useTwist?twists[Math.floor(Math.random()*twists.length)]:'';
const prompt=s+'ï¼Œ'+e+(t?'â€”â€”'+t:'');
document.getElementById('searchInput').value=prompt;
const wsBtn=document.querySelector('.bnav-i');
switchPage('workshop',wsBtn);
showToast('ğŸ’¡ çµæ„Ÿå·²æ³¨å…¥');
}

// ==================== SPLASH & INIT ====================
function initApp(){
// Load saved settings
const sApi=ld(K.curApi,{});
if(sApi.url)document.getElementById('apiUrl').value=sApi.url;
if(sApi.key)document.getElementById('apiKey').value=sApi.key;
if(sApi.model)document.getElementById('apiModel').value=sApi.model;
if(sApi.temp!==undefined)document.getElementById('apiTemp').value=sApi.temp;
if(sApi.maxTokens)document.getElementById('apiMaxTokens').value=sApi.maxTokens;

const sWorld=ld(K.curWorld,{});
if(sWorld.desc)document.getElementById('worldDesc').value=sWorld.desc;
if(sWorld.minWords)document.getElementById('minWords').value=sWorld.minWords;
if(ap.curStyle&&document.getElementById('styleDesc'))document.getElementById('styleDesc').value=ap.curStyle;
document.getElementById('streamOn').checked=useStream;
document.getElementById('quickTemp').value=document.getElementById('apiTemp').value;
document.getElementById('qtVal').textContent=document.getElementById('apiTemp').value;
updateStreamUI();

renderTags();renderArticles();renderCharCards();applyAppearance();
document.getElementById('splashVer').textContent=APP_VER;
renderUserCard();
}

// é¡µé¢å…³é—­/åˆ‡æ¢æ—¶è‡ªåŠ¨ä¿å­˜æ‰€æœ‰æ•°æ®
window.addEventListener('beforeunload',()=>{
saveCurSettings();
autoSaveAll();
});
document.addEventListener('visibilitychange',()=>{
if(document.visibilityState==='hidden'){
saveCurSettings();
autoSaveAll();
}
});
document.addEventListener('DOMContentLoaded',()=>{
initApp();

const splash=document.getElementById('splash');
const app=document.getElementById('app');
const txt=document.getElementById('splashTxt');
const spin=document.getElementById('splashSpin');

const steps=['æ­£åœ¨åˆå§‹åŒ–ç»„ä»¶...','æ­£åœ¨åŠ è½½æ•°æ®...','æ­£åœ¨æ¸²æŸ“ç•Œé¢...'];
let step=0;
const stepInterval=setInterval(()=>{
if(step<steps.length){txt.textContent=steps[step];step++;}
else{
clearInterval(stepInterval);
txt.textContent='åŠ è½½æˆåŠŸ';
spin.classList.add('done');
setTimeout(()=>{
splash.classList.add('hide');
app.classList.add('show');
},400);
setTimeout(()=>{splash.style.display='none';},1200);
}
},350);

// Auto-save on input changes
const autoSaveIds=['apiUrl','apiKey','apiModel','apiTemp','apiMaxTokens','worldDesc','minWords','styleDesc'];
autoSaveIds.forEach(id=>{
const el=document.getElementById(id);
if(el){
el.addEventListener('input',debounce(saveCurSettings,600));
el.addEventListener('change',saveCurSettings);
}
});
});
</script>
</body>
</html>
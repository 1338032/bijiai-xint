<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Á¨îËÆ∞AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0f0f14;--card:#1a1a24;--card2:#22222f;
--accent:#6c5ce7;--accent2:#a29bfe;
--text:#e8e8f0;--text2:#9090a8;
--danger:#ff6b6b;--success:#51cf66;
--border:#2a2a3a;--shadow:0 4px 20px rgba(0,0,0,0.4);
}
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);color:var(--text);
min-height:100vh;overflow-x:hidden;
}
body.theme-warm{--accent:#e67e22;--accent2:#f0b27a;--border:#3a2a1a;}
body.theme-green{--accent:#27ae60;--accent2:#58d68d;--border:#1a3a2a;}
body.theme-blue{--accent:#2980b9;--accent2:#5dade2;--border:#1a2a3a;}
body.theme-light{
--bg:#f5f5f8;--card:#ffffff;--card2:#eeeef3;
--text:#1a1a2e;--text2:#6a6a8a;--border:#d8d8e8;
--shadow:0 4px 20px rgba(0,0,0,0.08);
}
body.theme-light.theme-warm{--accent:#e67e22;--accent2:#d35400;}
body.theme-light.theme-green{--accent:#27ae60;--accent2:#1e8449;}
body.theme-light.theme-blue{--accent:#2980b9;--accent2:#1a5276;}
body.theme-light .bnav{background:rgba(245,245,248,.92);}
body.theme-light .rd-hdr{background:rgba(245,245,248,.88);}
/* LOGO FONT - ‰∏çÂèóËá™ÂÆö‰πâÂ≠ó‰ΩìÂΩ±Âìç */
.logo-text{
font-family:'ZCOOL QingKe HuangYou','PingFang SC','Microsoft YaHei',sans-serif!important;
}
/* SPLASH */
.splash{
position:fixed;inset:0;z-index:10000;
background:linear-gradient(135deg,#0a0a12 0%,#12121f 50%,#0d0d18 100%);
display:flex;flex-direction:column;align-items:center;justify-content:center;
transition:opacity 0.8s,transform 0.8s;
overflow:hidden;
}
.splash.hide{opacity:0;transform:scale(1.05);pointer-events:none;}
.splash::before{
content:'';position:absolute;inset:0;
background:radial-gradient(ellipse 80% 50% at 50% -20%,rgba(108,92,231,.15),transparent),
radial-gradient(ellipse 60% 40% at 80% 100%,rgba(162,155,254,.1),transparent),
radial-gradient(ellipse 50% 30% at 10% 80%,rgba(108,92,231,.08),transparent);
pointer-events:none;
}
.splash-particles{
position:absolute;inset:0;overflow:hidden;pointer-events:none;
}
.splash-particle{
position:absolute;width:4px;height:4px;
background:var(--accent2);border-radius:50%;
opacity:0;animation:floatUp 8s infinite;
}
@keyframes floatUp{
0%{transform:translateY(100vh) scale(0);opacity:0;}
10%{opacity:.6;}
90%{opacity:.6;}
100%{transform:translateY(-20vh) scale(1);opacity:0;}
}
.splash-glow{
position:absolute;width:300px;height:300px;
background:radial-gradient(circle,rgba(108,92,231,.2) 0%,transparent 70%);
border-radius:50%;filter:blur(40px);
animation:pulseGlow 4s ease-in-out infinite;
}
@keyframes pulseGlow{
0%,100%{transform:scale(1);opacity:.5;}
50%{transform:scale(1.2);opacity:.8;}
}
.splash-card{
position:relative;z-index:10;
background:linear-gradient(145deg,rgba(26,26,40,.7) 0%,rgba(40,35,60,.5) 100%);
backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
border:1px solid rgba(108,92,231,.3);
border-radius:28px;padding:52px 60px;
box-shadow:0 12px 40px rgba(0,0,0,.4),
0 0 0 1px rgba(255,255,255,.08) inset,
0 0 100px rgba(108,92,231,.15),
0 -20px 60px rgba(162,155,254,.05) inset;
text-align:center;
animation:cardFloat 5s ease-in-out infinite;
}
@keyframes cardFloat{
0%,100%{transform:translateY(0) rotate(0deg);}
25%{transform:translateY(-5px) rotate(0.5deg);}
50%{transform:translateY(-10px) rotate(0deg);}
75%{transform:translateY(-5px) rotate(-0.5deg);}
}
.splash-icon{
width:88px;height:88px;margin:0 auto 20px;
background:linear-gradient(135deg,rgba(108,92,231,.15),rgba(162,155,254,.1));
border-radius:22px;
display:flex;align-items:center;justify-content:center;
box-shadow:0 8px 32px rgba(108,92,231,.3),0 0 0 1px rgba(108,92,231,.2);
animation:iconPulse 2s ease-in-out infinite;
overflow:hidden;
}
.splash-icon img{
width:100%;height:100%;object-fit:cover;
filter:drop-shadow(0 2px 8px rgba(108,92,231,.4));
}
@keyframes iconPulse{
0%,100%{box-shadow:0 8px 24px rgba(108,92,231,.4);}
50%{box-shadow:0 12px 36px rgba(108,92,231,.6);}
}
.splash-logo{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:36px;font-weight:400;letter-spacing:6px;
background:linear-gradient(135deg,#fff 0%,var(--accent2) 50%,var(--accent) 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;margin-bottom:8px;
animation:shimmer 3s ease-in-out infinite;
background-size:200% 100%;
text-shadow:0 0 40px rgba(108,92,231,.3);
}
@keyframes shimmer{ 0%{background-position:0% 50%;filter:brightness(1);} 25%{filter:brightness(1.1);} 50%{background-position:100% 50%;filter:brightness(1.2);} 75%{filter:brightness(1.1);} 100%{background-position:0% 50%;filter:brightness(1);} }
.splash-sub{
font-size:13px;color:rgba(255,255,255,.6);
letter-spacing:2px;margin-bottom:32px;
}
.splash-progress{
width:200px;height:3px;
background:rgba(255,255,255,.1);
border-radius:3px;overflow:hidden;
margin-bottom:16px;
}
.splash-progress-bar{
height:100%;width:0%;
background:linear-gradient(90deg,var(--accent),var(--accent2));
border-radius:3px;
transition:width .3s ease;
box-shadow:0 0 10px var(--accent);
}
.splash-status{
font-size:11px;color:rgba(255,255,255,.4);
display:flex;align-items:center;justify-content:center;gap:8px;
}
.splash-dot{
width:6px;height:6px;border-radius:50%;
background:var(--accent2);
animation:dotPulse 1.5s ease-in-out infinite;
}
@keyframes dotPulse{
0%,100%{opacity:.4;transform:scale(1);}
50%{opacity:1;transform:scale(1.2);}
}
.splash-corner{
position:absolute;font-size:10px;
color:rgba(255,255,255,.2);font-weight:500;
letter-spacing:1px;
}
.splash-corner.tl{top:24px;left:24px;}
.splash-corner.br{bottom:24px;right:24px;}
.splash-ver{
position:absolute;bottom:24px;left:50%;transform:translateX(-50%);
font-size:10px;color:rgba(255,255,255,.2);
}
.splash-decor{
position:absolute;border:1px solid rgba(108,92,231,.15);
border-radius:50%;pointer-events:none;
}
.splash-decor-1{
width:400px;height:400px;top:-100px;right:-100px;
animation:rotateSlow 30s linear infinite;
}
.splash-decor-2{
width:300px;height:300px;bottom:-80px;left:-80px;
animation:rotateSlow 25s linear infinite reverse;
}
@keyframes rotateSlow{
from{transform:rotate(0deg);}
to{transform:rotate(360deg);}
}

/* APP */
.app{opacity:0;transform:translateY(16px);transition:opacity .5s .2s,transform .5s .2s;padding-bottom:68px;}
.app.show{opacity:1;transform:translateY(0);}

/* HEADER */
.hdr{
position:sticky;top:0;z-index:100;
background:linear-gradient(135deg,var(--card) 0%,var(--bg) 100%);
padding:14px 18px 10px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
}
.hdr-left h1{
font-family:'ZCOOL QingKe HuangYou','PingFang SC',sans-serif!important;
font-size:22px;font-weight:400;letter-spacing:2px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
display:flex;align-items:center;gap:8px;
}
.hdr-logo-img{
width:28px;height:28px;border-radius:8px;
object-fit:cover;
filter:drop-shadow(0 2px 4px rgba(108,92,231,.3));
}
.hdr-left .hdr-sub{font-size:10px;color:var(--text2);margin-top:2px;}
.hdr-right{display:flex;gap:8px;}
.hdr-btn{
background:none;border:1px solid var(--border);color:var(--text2);
padding:5px 10px;border-radius:10px;font-size:11px;cursor:pointer;
display:flex;align-items:center;gap:4px;transition:all .3s;
}
.hdr-btn:active{transform:scale(.95);}
.hdr-btn svg{width:15px;height:15px;}

/* BOTTOM NAV */
.bnav{
position:fixed;bottom:0;left:0;right:0;z-index:200;
background:rgba(26,26,36,.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
border-top:1px solid var(--border);
display:flex;justify-content:space-around;padding:7px 0 11px;
transition:transform .3s;
}
.bnav-i{
display:flex;flex-direction:column;align-items:center;gap:2px;
cursor:pointer;padding:5px 14px;border-radius:12px;
background:none;border:none;color:var(--text2);font-size:10px;
transition:all .3s;
}
.bnav-i.act{color:var(--accent2);}
.bnav-i svg{width:21px;height:21px;transition:all .3s;}
.bnav-i.act svg{filter:drop-shadow(0 0 5px var(--accent));}

/* PAGES */
.pg{display:none;animation:fadeIn .25s ease;}
.pg.act{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* SEARCH BAR */
.sbar{display:flex;gap:9px;padding:14px 18px 8px;}
.sbar input{
flex:1;padding:11px 15px;border-radius:13px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;outline:none;transition:border-color .3s;
}
.sbar input:focus{border-color:var(--accent);}
.sbar input::placeholder{color:var(--text2);}
.btn-gen{
padding:11px 18px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
white-space:nowrap;transition:all .3s;
box-shadow:0 3px 12px rgba(108,92,231,.25);
}
.btn-gen:active{transform:scale(.95);box-shadow:0 2px 8px rgba(108,92,231,.4);} .btn-gen::before{ content:'';position:absolute;inset:0; background:linear-gradient(45deg,transparent,rgba(255,255,255,.1),transparent); transform:translateX(-100%);transition:transform .5s; } .btn-gen:active::before{transform:translateX(100%);}
.btn-gen:disabled{opacity:.5;cursor:not-allowed;transform:none;}

/* TAGS */
.tags-sec{padding:4px 18px 8px;}
.tags-wrap{display:flex;flex-wrap:nowrap;gap:7px;align-items:center;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;} .tags-wrap::-webkit-scrollbar{height:2px;} .tags-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;} .tags-wrap .tag,.tags-wrap .tag-add{flex-shrink:0;}
.tag{
padding:5px 13px;border-radius:18px;font-size:11px;cursor:pointer;
transition:all .3s;border:1px solid var(--border);background:var(--card);
color:var(--text2);display:flex;align-items:center;gap:4px;
user-select:none;
}
.tag.act{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 8px rgba(108,92,231,.3);}
.tag .tdel{
width:13px;height:13px;display:none;align-items:center;justify-content:center;
font-size:9px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;
line-height:1;
}
.tag.act .tdel{display:flex;}
.tag-add{
padding:5px 11px;border-radius:18px;font-size:11px;cursor:pointer;
border:1px dashed var(--border);background:transparent;color:var(--accent2);
transition:all .3s;
}

/* TYPE TABS */
.ttabs{display:flex;padding:4px 18px;gap:0;}
.ttab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.ttab.act{color:var(--accent2);border-bottom-color:var(--accent);}

/* ARTICLE CARDS */
.alist{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.acard{
background:linear-gradient(135deg,var(--card) 0%,rgba(108,92,231,.03) 100%);
border-radius:16px;padding:18px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
position:relative;overflow:hidden;
}
.acard::before{
content:'';position:absolute;top:0;left:0;right:0;height:3px;
background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent));
background-size:200% 100%;
opacity:0;transition:opacity .3s;
}
.acard:active::before{opacity:1;}
.acard:active{transform:scale(.97);border-color:var(--accent);box-shadow:0 0 12px rgba(108,92,231,.15);}
.acard-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.acard-t{font-size:15px;font-weight:700;line-height:1.4;flex:1;margin-right:10px;}
.acard-badge{padding:3px 9px;border-radius:9px;font-size:9px;font-weight:600;flex-shrink:0;}
.acard-badge.long{background:rgba(108,92,231,.18);color:var(--accent2);}
.acard-badge.short{background:rgba(81,207,102,.18);color:var(--success);}
.acard-pv{
font-size:12px;color:var(--text2);line-height:1.7;margin-bottom:10px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.acard-ft{display:flex;justify-content:space-between;align-items:center;}
.acard-tags{display:flex;gap:5px;flex-wrap:wrap;flex:1;}
.acard-tag{padding:2px 7px;border-radius:7px;font-size:9px;background:var(--card2);color:var(--text2);}
.acard-wc{font-size:10px;color:var(--text2);margin-right:8px;white-space:nowrap;}
.btn-like{
display:flex;align-items:center;gap:3px;padding:5px 11px;border-radius:9px;
border:1px solid var(--border);background:transparent;color:var(--text2);
font-size:11px;cursor:pointer;transition:all .3s;flex-shrink:0;
}
.btn-like.liked{background:rgba(255,107,107,.13);border-color:var(--danger);color:var(--danger);}
.empty-st{text-align:center;padding:50px 18px;color:var(--text2);}
.empty-st svg{width:50px;height:50px;margin-bottom:12px;opacity:.3;}
.empty-st p{font-size:13px;line-height:1.6;}

/* STREAMING INDICATOR */
.stream-card{
background:var(--card);border-radius:15px;padding:16px;
border:1px solid var(--accent);transition:all .3s;
}
.stream-card .stream-title{
font-size:14px;font-weight:600;color:var(--accent2);margin-bottom:8px;
display:flex;align-items:center;gap:8px;
}
.stream-card .stream-body{
font-size:13px;line-height:1.8;color:var(--text);
max-height:200px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word;
}
.stream-card .stream-info{
display:flex;justify-content:space-between;align-items:center;
margin-top:10px;font-size:10px;color:var(--text2);
}
.ldots{display:inline-flex;gap:3px;align-items:center;}
.ldots span{
width:5px;height:5px;border-radius:50%;background:var(--accent2);
animation:bounce 1.4s infinite both;
}
.ldots span:nth-child(2){animation-delay:.16s;}
.ldots span:nth-child(3){animation-delay:.32s;}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

/* READING MODAL */
.modal{
display:none;position:fixed;inset:0;z-index:500;
background:var(--bg);overflow-y:auto;
}
.modal.show{display:block;animation:slideUp .3s ease;}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal.fs .rd-hdr{
position:fixed;top:0;left:0;right:0;
background:rgba(15,15,20,.85);backdrop-filter:blur(10px);z-index:10;
}
.modal.fs .rd-body{padding-top:62px;}
.rd-bg{
position:fixed;inset:0;z-index:0;
background-size:cover;background-position:center;
opacity:.50;pointer-events:none;display:none;
}
.rd-hdr{
position:sticky;top:0;z-index:10;
background:rgba(15,15,20,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
padding:14px 18px;display:flex;justify-content:space-between;align-items:center;
border-bottom:1px solid var(--border);
}
.rd-back{
display:flex;align-items:center;gap:5px;background:none;
border:none;color:var(--accent2);font-size:13px;cursor:pointer;padding:4px;
}
.rd-back svg{width:18px;height:18px;}
.rd-acts{display:flex;gap:6px;}
.rd-acts button{
padding:5px 10px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.rd-acts button:active{transform:scale(.95);}
.rd-body{padding:22px 20px 70px;position:relative;z-index:1;}
.rd-title{font-size:20px;font-weight:800;line-height:1.4;margin-bottom:12px;}
.rd-meta{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.rd-meta span{font-size:11px;color:var(--text2);padding:3px 9px;background:var(--card);border-radius:7px;}
.ch-nav{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
.ch-btn{
padding:5px 12px;border-radius:9px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
transition:all .3s;
}
.ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.rd-content{
font-size:var(--rd-fontsize,15px);
line-height:var(--rd-lineheight,2);
color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.rd-content p{margin-bottom:10px;text-indent:2em;}
.rd-dir-input{
display:flex;gap:8px;margin-bottom:16px;
}
.rd-dir-input input{
flex:1;padding:10px 14px;border-radius:12px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.rd-dir-input input::placeholder{color:var(--text2);}
.cont-wrap{padding:16px 0;text-align:center;}
.btn-cont{
padding:11px 28px;border-radius:13px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:13px;font-weight:600;cursor:pointer;
box-shadow:0 3px 12px rgba(108,92,231,.25);transition:all .3s;
}
.btn-cont:active{transform:scale(.95);}
.btn-cont:disabled{opacity:.5;}
.btn-undo{
padding:8px 16px;border-radius:10px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
margin-left:10px;transition:all .3s;
}

/* Reading settings bar */
.rd-settings{
background:var(--card);border-radius:14px;padding:14px;margin-bottom:18px;
border:1px solid var(--border);display:none;
}
.rd-settings.show{display:block;}
.rd-settings h4{font-size:12px;color:var(--text2);margin-bottom:10px;}
.rd-s-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.rd-s-row:last-child{margin-bottom:0;}
.rd-s-label{font-size:11px;color:var(--text2);width:50px;flex-shrink:0;}
.rd-s-row input[type=range]{flex:1;accent-color:var(--accent);}
.rd-s-val{font-size:11px;color:var(--accent2);width:35px;text-align:right;}

/* COLLECTION */
.col-hdr{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;}
.col-hdr h2{font-size:17px;font-weight:700;}
.col-cnt{font-size:11px;color:var(--text2);background:var(--card);padding:3px 11px;border-radius:9px;}
.col-search{padding:0 18px 8px;}
.col-search input{
width:100%;padding:9px 14px;border-radius:11px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:12px;outline:none;
}
.col-search input::placeholder{color:var(--text2);}
.sec-div{padding:14px 18px 4px;display:flex;justify-content:space-between;align-items:center;}
.sec-div h3{font-size:14px;font-weight:600;color:var(--text2);}
.bgrid{
padding:0 18px;display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;
}
.bcard{
background:var(--card);border-radius:13px;overflow:hidden;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.bcard:active{transform:scale(.97);}
.bcov{
width:100%;aspect-ratio:3/4;
background:linear-gradient(135deg,var(--card2),var(--card));
display:flex;align-items:center;justify-content:center;
position:relative;overflow:hidden;
}
.bcov img{width:100%;height:100%;object-fit:cover;}
.bcov-ph{
display:flex;flex-direction:column;align-items:center;gap:6px;
font-size:12px;color:var(--text2);
}
.binfo{padding:10px;}
.binfo-t{font-size:12px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.binfo-m{font-size:9px;color:var(--text2);}
.binfo-status{
display:inline-block;padding:1px 6px;border-radius:6px;font-size:8px;
margin-top:3px;
}
.binfo-status.ongoing{background:rgba(108,92,231,.15);color:var(--accent2);}
.binfo-status.complete{background:rgba(81,207,102,.15);color:var(--success);}
.binfo-status.paused{background:rgba(255,107,107,.15);color:var(--danger);}
.bacts{padding:0 10px 10px;display:flex;gap:5px;}
.bact{
flex:1;padding:5px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.bact.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.col-shorts{padding:14px 18px 0;}
.col-shorts h3{font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text2);}
.slist{display:flex;flex-direction:column;gap:9px;padding-bottom:18px;}
.sitem{
background:var(--card);border-radius:11px;padding:12px;
border:1px solid var(--border);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.sitem-info{flex:1;margin-right:8px;}
.sitem-t{font-size:13px;font-weight:600;margin-bottom:3px;}
.sitem-pv{font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:calc(100vw - 160px);}
.sitem-acts{display:flex;gap:5px;}
.sitem-acts button{
padding:4px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
}
.star-rating{display:flex;gap:2px;margin-top:4px;}
.star-rating span{
font-size:14px;cursor:pointer;color:var(--border);transition:color .2s;
user-select:none;
}
.star-rating span.filled{color:#f1c40f;}

/* USER CARD */
.ucard{
margin:14px 18px;background:var(--card);border-radius:18px;
border:1px solid var(--border);overflow:hidden;
}
.ucard-top{
padding:20px 18px 14px;display:flex;align-items:center;gap:14px;
}
.ucard-avatar{
width:56px;height:56px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
font-size:24px;color:#fff;cursor:pointer;
overflow:hidden;flex-shrink:0;position:relative;
border:2px solid var(--border);transition:all .3s;
}
.ucard-avatar:active{transform:scale(.95);}
.ucard-avatar img{width:100%;height:100%;object-fit:cover;}
.ucard-avatar-hint{
position:absolute;inset:0;background:rgba(0,0,0,.45);
display:flex;align-items:center;justify-content:center;
font-size:10px;color:#fff;opacity:0;transition:opacity .3s;
}
.ucard-avatar:active .ucard-avatar-hint{opacity:1;}
.ucard-info{flex:1;min-width:0;}
.ucard-name{
font-size:16px;font-weight:700;margin-bottom:3px;
display:flex;align-items:center;gap:6px;
}
.ucard-name span{
overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;
}
.ucard-name button{
background:none;border:none;color:var(--text2);font-size:12px;
cursor:pointer;padding:2px 6px;flex-shrink:0;
}
.ucard-bio{
font-size:11px;color:var(--text2);line-height:1.5;
display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
overflow:hidden;cursor:pointer;
}
.ucard-stats{
padding:12px 18px 16px;border-top:1px solid var(--border);
display:grid;grid-template-columns:repeat(4,1fr);gap:0;
}
.ucard-stat{
text-align:center;padding:6px 0;
position:relative;
}
.ucard-stat:not(:last-child)::after{
content:'';position:absolute;right:0;top:20%;height:60%;
width:1px;background:var(--border);
}
.ucard-stat-num{
font-size:18px;font-weight:800;
background:linear-gradient(135deg,var(--accent),var(--accent2));
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
background-clip:text;
}
.ucard-stat-label{font-size:9px;color:var(--text2);margin-top:2px;}
/* SETTINGS */
.set-sec{padding:14px 18px;}
.set-grp{
background:var(--card);border-radius:15px;
border:1px solid var(--border);margin-bottom:13px;overflow:hidden;
}
.set-grp-t{
padding:13px 16px;font-size:14px;font-weight:700;
background:var(--card2);display:flex;
justify-content:space-between;align-items:center;cursor:pointer;
}
.set-grp-t svg{width:16px;height:16px;color:var(--text2);transition:transform .3s;}
.set-grp-t.exp svg{transform:rotate(180deg);}
.set-grp-c{padding:14px 16px;display:none;}
.set-grp-c.show{display:block;}
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.fl{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;font-weight:500;}
.fi,.fta,.fsel{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
transition:border-color .3s;font-family:inherit;
}
.fi:focus,.fta:focus{border-color:var(--accent);}
.fta{min-height:90px;resize:vertical;line-height:1.6;}
.frow{display:flex;gap:9px;}
.frow .fg{flex:1;}
.plist{display:flex;flex-direction:column;gap:7px;margin-top:9px;}
.pitem{
display:flex;justify-content:space-between;align-items:center;
padding:9px 13px;background:var(--bg);border-radius:9px;border:1px solid var(--border);
}
.pitem-n{font-size:12px;font-weight:500;}
.pitem-a{display:flex;gap:5px;}
.pitem-a button{
padding:3px 9px;border-radius:7px;border:1px solid var(--border);
background:transparent;font-size:10px;cursor:pointer;transition:all .3s;
}
.btn-use{color:var(--accent2);border-color:var(--accent)!important;}
.btn-del{color:var(--danger);border-color:rgba(255,107,107,.3)!important;}
.btn-p{
padding:9px 18px;border-radius:11px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
transition:all .3s;width:100%;margin-top:7px;
}
.btn-p:active{transform:scale(.98);}
.btn-s{
padding:9px 18px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;font-weight:500;
cursor:pointer;transition:all .3s;width:100%;margin-top:7px;
}
.theme-opts{display:flex;gap:8px;flex-wrap:wrap;}
.t-opt{
width:36px;height:36px;border-radius:10px;border:2px solid var(--border);
cursor:pointer;transition:all .3s;
}
.t-opt.act{border-color:var(--accent);box-shadow:0 0 8px rgba(108,92,231,.3);}
.t-opt.t0{background:linear-gradient(135deg,#6c5ce7,#a29bfe);}
.t-opt.t1{background:linear-gradient(135deg,#e67e22,#f0b27a);}
.t-opt.t2{background:linear-gradient(135deg,#27ae60,#58d68d);}
.t-opt.t3{background:linear-gradient(135deg,#2980b9,#5dade2);}
.t-opt.t4{background:linear-gradient(135deg,#f5f5f8,#ddd);border-color:#ccc;}
.data-btns{display:flex;flex-direction:column;gap:8px;}
.data-btns button{
padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:7px;transition:all .3s;
}
.data-btns button:active{transform:scale(.98);}
.wc-set{display:flex;align-items:center;gap:8px;}
.wc-set input{width:90px;text-align:center;}

/* Char cards - dynamic */
.char-cards{display:flex;flex-direction:column;gap:12px;}
.char-card{
background:var(--bg);border-radius:12px;padding:14px;
border:1px solid var(--border);position:relative;
}
.char-card-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.char-card-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.char-card-del{
background:none;border:none;color:var(--danger);font-size:10px;cursor:pointer;
padding:3px 8px;border-radius:6px;border:1px solid rgba(255,107,107,.3);
}

/* HANDBOOK */
.hb-ov{
display:none;position:fixed;inset:0;z-index:600;
background:var(--bg);overflow-y:auto;
}
.hb-ov.show{display:block;animation:slideUp .3s ease;}
.hb-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:14px 18px;display:flex;align-items:center;gap:8px;
border-bottom:1px solid var(--border);
}
.hb-hdr button{
background:none;border:none;color:var(--accent2);
font-size:13px;cursor:pointer;padding:4px;display:flex;align-items:center;gap:5px;
}
.hb-hdr button svg{width:18px;height:18px;}
.hb-hdr h2{font-size:16px;font-weight:700;}
.hb-body{padding:22px 20px 50px;}
.hb-body h3{
font-size:15px;font-weight:700;color:var(--accent2);
margin:22px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--border);
}
.hb-body h3:first-child{margin-top:0;}
.hb-body p{font-size:13px;line-height:1.9;color:var(--text);margin-bottom:9px;}
.hb-body ul{padding-left:18px;margin-bottom:10px;}
.hb-body li{font-size:12px;line-height:1.8;color:var(--text2);margin-bottom:3px;}
.hb-body .notice{
background:rgba(108,92,231,.08);border:1px solid rgba(108,92,231,.25);
border-radius:11px;padding:13px 15px;margin:14px 0;
}
.hb-body .notice p{color:var(--accent2);font-size:12px;margin:0;}
.hb-body .contact{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);margin-top:10px;
}
.hb-body .contact p{font-size:12px;line-height:2;color:var(--text2);margin:0;}

/* DIALOGS */
.toast{
position:fixed;top:50%;left:50%;
transform:translate(-50%,-50%) scale(.9);
background:linear-gradient(135deg,var(--card2),var(--card));
color:var(--text);padding:14px 28px;
border-radius:14px;font-size:13px;z-index:9999;opacity:0;
transition:all .3s cubic-bezier(.4,0,.2,1);pointer-events:none;text-align:center;
border:1px solid var(--accent);
box-shadow:0 8px 32px rgba(0,0,0,.3),0 0 20px rgba(108,92,231,.2);
max-width:280px;font-weight:500;
}
.toast.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.dlg-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.dlg-ov.show{display:flex;}
.dlg-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:310px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.dlg-box h3{font-size:15px;margin-bottom:9px;}
.dlg-box p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px;}
.dlg-btns{display:flex;gap:9px;}
.dlg-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
.dlg-cancel{background:var(--card2);color:var(--text);}
.dlg-ok{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
.dlg-danger{background:var(--danger);color:#fff;}
.inp-ov{
display:none;position:fixed;inset:0;z-index:800;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:28px;
}
.inp-ov.show{display:flex;}
.inp-box{
background:var(--card);border-radius:16px;padding:22px;width:100%;
max-width:340px;border:1px solid var(--border);animation:fadeIn .25s ease;
}
.inp-box h3{font-size:15px;margin-bottom:13px;}
.inp-box input,.inp-box textarea{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin-bottom:13px;font-family:inherit;
}
.inp-box textarea{min-height:70px;resize:vertical;}
.inp-btns{display:flex;gap:9px;}
.inp-btns button{
flex:1;padding:9px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}

/* Scrollbar */
/* CHAPTER LIST OVERLAY */
.ch-ov{
display:none;position:fixed;inset:0;z-index:550;
background:rgba(0,0,0,.55);align-items:flex-end;justify-content:center;
}
.ch-ov.show{display:flex;}
.ch-panel{
background:var(--card);border-radius:18px 18px 0 0;
width:100%;max-width:500px;max-height:70vh;
padding:0;overflow:hidden;animation:slideUp .3s ease;
display:flex;flex-direction:column;
}
.ch-panel-hdr{
padding:16px 18px 12px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ch-panel-hdr h3{font-size:15px;font-weight:700;}
.ch-panel-hdr span{font-size:11px;color:var(--text2);}
.ch-panel-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;border-radius:8px;
}
.ch-panel-list{
padding:12px 18px 20px;overflow-y:auto;flex:1;
display:flex;flex-direction:column;gap:0;
}
.ch-item{
padding:13px 16px;border-radius:0;border:none;border-bottom:1px solid var(--border);
background:var(--bg);color:var(--text2);font-size:13px;
text-align:left;cursor:pointer;transition:all .3s;
display:flex;flex-direction:row;align-items:center;gap:12px;
}
.ch-item:last-child{border-bottom:none;}
.ch-item:active{transform:scale(.95);}
.ch-item.act{background:rgba(108,92,231,.1);color:var(--accent2);border-bottom-color:var(--border);}
.ch-item .ch-item-num{font-size:14px;font-weight:700;}
.ch-item .ch-item-wc{font-size:9px;opacity:.7;}
/* CREATE PAGE */
.cr-tabs{display:flex;padding:4px 18px;gap:0;}
.cr-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.cr-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.cr-list{padding:8px 18px;display:flex;flex-direction:column;gap:11px;}
.cr-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;cursor:pointer;
}
.cr-card:active{transform:scale(.98);}
.cr-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.cr-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.cr-card-badge{padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;}
.cr-card-badge.draft{background:rgba(255,165,0,.15);color:#f0a030;}
.cr-card-badge.novel{background:rgba(108,92,231,.15);color:var(--accent2);}
.cr-card-pv{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.cr-card-ft{display:flex;justify-content:space-between;align-items:center;}
.cr-card-info{font-size:9px;color:var(--text2);}
.cr-card-acts{display:flex;gap:5px;}
.cr-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.cr-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}
.cr-new-bar{padding:8px 18px;display:flex;gap:8px;}
.cr-new-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.cr-new-bar button:active{transform:scale(.97);}

/* EDITOR MODAL */
.ed-modal{
display:none;position:fixed;inset:0;z-index:510;
background:var(--bg);overflow-y:auto;
}
.ed-modal.show{display:block;animation:slideUp .3s ease;}
.ed-hdr{
position:sticky;top:0;z-index:10;background:var(--bg);
padding:10px 14px;display:flex;align-items:center;
border-bottom:none;gap:8px;
}
.ed-back{
display:flex;align-items:center;gap:4px;background:none;
border:none;color:var(--accent2);font-size:12px;cursor:pointer;padding:4px;flex-shrink:0;
}
.ed-back svg{width:16px;height:16px;}
.ed-title-input{
flex:1;padding:6px 10px;border-radius:8px;
border:1px solid var(--border);background:var(--card);
color:var(--text);font-size:13px;font-weight:700;outline:none;
}
.ed-title-input:focus{border-color:var(--accent);}
.ed-acts{
display:flex;gap:6px;padding:8px 14px;
overflow-x:auto;-webkit-overflow-scrolling:touch;
border-bottom:1px solid var(--border);
background:var(--card);
}
.ed-acts::-webkit-scrollbar{display:none;}
.ed-acts button{
flex-shrink:0;padding:6px 12px;border-radius:8px;
border:1px solid var(--border);background:var(--bg);
color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;display:flex;align-items:center;gap:4px;
}
.ed-acts button:active{transform:scale(.95);background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-bar{
padding:8px 14px;display:flex;gap:6px;align-items:center;
border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;
}
.ed-ch-bar::-webkit-scrollbar{display:none;}
.ed-ch-btn{
padding:5px 12px;border-radius:8px;border:1px solid var(--border);
background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;transition:all .3s;
}
.ed-ch-btn.act{background:var(--accent);color:#fff;border-color:var(--accent);}
.ed-ch-add{
padding:5px 10px;border-radius:8px;border:1px dashed var(--border);
background:transparent;color:var(--accent2);font-size:11px;cursor:pointer;
white-space:nowrap;flex-shrink:0;
}
.ed-body{padding:14px;}
.ed-textarea{
width:100%;min-height:calc(100vh - 200px);padding:16px;
border-radius:12px;border:1px solid var(--border);
background:var(--card);color:var(--text);
font-size:var(--rd-fontsize,15px);line-height:var(--rd-lineheight,2);
outline:none;resize:none;font-family:inherit;
}
.ed-textarea:focus{border-color:var(--accent);}
.ed-textarea::placeholder{color:var(--text2);}
.ed-footer{
padding:10px 14px;border-top:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;
font-size:10px;color:var(--text2);
}
.ed-wc{font-weight:600;color:var(--accent2);}

/* AI REVIEW PANEL */
.ai-review-ov{
display:none;position:fixed;inset:0;z-index:570;
background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:20px;
}
.ai-review-ov.show{display:flex;}
.ai-review-box{
background:var(--card);border-radius:16px;padding:0;
width:100%;max-width:400px;max-height:80vh;
border:1px solid var(--border);overflow:hidden;
display:flex;flex-direction:column;animation:fadeIn .25s ease;
}
.ai-review-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.ai-review-hdr h3{font-size:14px;font-weight:700;}
.ai-review-body{
padding:16px;overflow-y:auto;flex:1;
font-size:13px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word;
}
.ai-review-ft{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;text-align:right;
}
.ai-review-ft button{
padding:8px 20px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
}
/* RESOURCE PAGE */
.res-bar{padding:10px 18px;display:flex;gap:8px;}
.res-bar button{
flex:1;padding:10px;border-radius:11px;border:1px solid var(--border);
background:var(--card);color:var(--text);font-size:12px;cursor:pointer;
display:flex;align-items:center;justify-content:center;gap:6px;
transition:all .3s;
}
.res-bar button:active{transform:scale(.97);}
.res-tabs{display:flex;padding:4px 18px;gap:0;}
.res-tab{
flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;
cursor:pointer;border:none;border-bottom:2px solid transparent;
color:var(--text2);transition:all .3s;background:none;
}
.res-tab.act{color:var(--accent2);border-bottom-color:var(--accent);}
.res-list{padding:8px 18px;display:flex;flex-direction:column;gap:10px;}
.res-card{
background:var(--card);border-radius:13px;padding:14px;
border:1px solid var(--border);transition:all .3s;
}
.res-card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.res-card-t{font-size:14px;font-weight:700;flex:1;margin-right:8px;}
.res-card-type{
padding:2px 8px;border-radius:7px;font-size:9px;font-weight:600;
}
.res-card-type.char{background:rgba(108,92,231,.15);color:var(--accent2);}
.res-card-type.world{background:rgba(39,174,96,.15);color:var(--success);}
.res-card-type.style{background:rgba(230,126,34,.15);color:#e67e22;}
.res-card-type.work{background:rgba(52,152,219,.15);color:#3498db;}
.res-card-type.exp{background:rgba(241,196,15,.15);color:#f1c40f;} .res-card-type.rule{background:rgba(155,89,182,.15);color:#9b59b6;}
.ch-outline-item{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.ch-outline-item-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.ch-outline-item-hdr span{font-size:12px;font-weight:600;color:var(--accent2);}
.ch-outline-item textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:11px;min-height:60px;resize:vertical;font-family:inherit;line-height:1.6;}
.ch-outline-item textarea:focus{border-color:var(--accent);outline:none;}
.ch-outline-item textarea::placeholder{color:var(--text2);}
.res-card-pv{
font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px;
display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}
.res-card-ft{display:flex;justify-content:space-between;align-items:center;}
.res-card-info{font-size:9px;color:var(--text2);}
.res-card-acts{display:flex;gap:5px;}
.res-card-acts button{
padding:4px 10px;border-radius:7px;border:1px solid var(--border);
background:transparent;color:var(--text2);font-size:9px;cursor:pointer;
transition:all .3s;
}
.res-card-acts button.use{color:var(--accent2);border-color:var(--accent);}
.res-card-acts button.danger{border-color:rgba(255,107,107,.3);color:var(--danger);}

/* RESOURCE EXPORT DIALOG */
.res-exp-ov{
display:none;position:fixed;inset:0;z-index:810;
background:rgba(0,0,0,.55);align-items:center;justify-content:center;padding:20px;
}
.res-exp-ov.show{display:flex;}
.res-exp-box{
background:var(--card);border-radius:16px;padding:20px;
width:100%;max-width:360px;border:1px solid var(--border);
animation:fadeIn .25s ease;max-height:85vh;overflow-y:auto;
}
.res-exp-box h3{font-size:15px;margin-bottom:14px;}
.res-chk-item{
display:flex;align-items:center;gap:10px;padding:10px 12px;
background:var(--bg);border-radius:9px;border:1px solid var(--border);
margin-bottom:8px;cursor:pointer;transition:all .3s;
}
.res-chk-item.checked{border-color:var(--accent);background:rgba(108,92,231,.06);}
.res-chk-box{
width:18px;height:18px;border-radius:5px;border:2px solid var(--border);
display:flex;align-items:center;justify-content:center;flex-shrink:0;
font-size:11px;color:#fff;transition:all .3s;
}
.res-chk-item.checked .res-chk-box{background:var(--accent);border-color:var(--accent);}
.res-chk-info{flex:1;}
.res-chk-name{font-size:12px;font-weight:600;}
.res-chk-desc{font-size:9px;color:var(--text2);margin-top:2px;}
.res-exp-input{
width:100%;padding:9px 13px;border-radius:9px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;margin:10px 0;
}
.res-exp-input:focus{border-color:var(--accent);}
.res-exp-btns{display:flex;gap:9px;margin-top:14px;}
.res-exp-btns button{
flex:1;padding:10px;border-radius:11px;border:none;
font-size:12px;font-weight:600;cursor:pointer;
}
/* NOTE PANEL */
.note-ov{
display:none;position:fixed;inset:0;z-index:560;
background:rgba(0,0,0,.45);
}
.note-ov.show{display:block;}
.note-panel{
position:fixed;top:0;right:-320px;bottom:0;z-index:561;
width:300px;max-width:85vw;background:var(--card);
border-left:1px solid var(--border);
display:flex;flex-direction:column;
transition:right .3s ease;
box-shadow:-4px 0 20px rgba(0,0,0,.3);
}
.note-ov.show .note-panel{right:0;}
.note-hdr{
padding:14px 16px;border-bottom:1px solid var(--border);
display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.note-hdr h3{font-size:14px;font-weight:700;}
.note-hdr span{font-size:10px;color:var(--text2);}
.note-close{
background:none;border:none;color:var(--text2);font-size:18px;
cursor:pointer;padding:4px 8px;
}
.note-list{
flex:1;overflow-y:auto;padding:12px 16px;
display:flex;flex-direction:column;gap:10px;
}
.note-empty{
text-align:center;padding:40px 10px;color:var(--text2);font-size:12px;
}
.note-item{
background:var(--bg);border-radius:10px;padding:11px 13px;
border:1px solid var(--border);position:relative;
}
.note-item-text{font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap;word-wrap:break-word;}
.note-item-ft{
display:flex;justify-content:space-between;align-items:center;
margin-top:7px;
}
.note-item-time{font-size:9px;color:var(--text2);}
.note-item-del{
background:none;border:none;color:var(--danger);font-size:9px;
cursor:pointer;padding:2px 6px;border-radius:5px;
border:1px solid rgba(255,107,107,.3);
}
.note-input-wrap{
padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;
}
.note-input-row{display:flex;gap:8px;}
.note-input-row textarea{
flex:1;padding:9px 12px;border-radius:10px;
border:1px solid var(--border);background:var(--bg);
color:var(--text);font-size:12px;outline:none;
resize:none;min-height:38px;max-height:100px;
font-family:inherit;line-height:1.5;
}
.note-input-row textarea:focus{border-color:var(--accent);}
.note-input-row textarea::placeholder{color:var(--text2);}
.note-send{
padding:8px 14px;border-radius:10px;border:none;
background:linear-gradient(135deg,var(--accent),var(--accent2));
color:#fff;font-size:12px;font-weight:600;cursor:pointer;
align-self:flex-end;white-space:nowrap;
}
.note-send:active{transform:scale(.95);}
.note-dot{
display:inline-block;width:6px;height:6px;border-radius:50%;
background:var(--accent2);margin-left:4px;vertical-align:middle;
}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.rd-para{transition:background .3s;border-radius:4px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;touch-action:pan-y;}
</style>
</head>
<body>
<div class="splash" id="splash">
<div class="splash-particles" id="splashParticles"></div>
<div class="splash-glow" style="top:20%;left:30%"></div>
<div class="splash-glow" style="bottom:10%;right:20%;animation-delay:-2s"></div>
<div class="splash-decor splash-decor-1"></div>
<div class="splash-decor splash-decor-2"></div>
<div class="splash-corner tl">Created by ÂøÉÁî∞</div>
<div class="splash-corner br">AIÂàõ‰ΩúÂ∑•Âùä</div>
<div class="splash-card">
<div class="splash-icon"><img src="https://i.postimg.cc/SQ1t32R0/retouch-2026022401082081.png" alt="Logo"></div>
<div class="splash-logo">Á¨îËÆ∞AI</div>
<div class="splash-sub">ËÆ©ÁÅµÊÑüËêΩÁ¨îÊàêÁ´†</div>
<div class="splash-progress"><div class="splash-progress-bar" id="splashBar"></div></div>
<div class="splash-status">
<span class="splash-dot"></span>
<span id="splashTxt">Ê≠£Âú®ÂàùÂßãÂåñ...</span>
</div>
</div>
<div class="splash-ver" id="splashVer">v2.4.0</div>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="hdr">
<div class="hdr-left">
<h1><img src="https://i.postimg.cc/SQ1t32R0/retouch-2026022401082081.png" alt="" class="hdr-logo-img">Á¨îËÆ∞AI</h1>
<div class="hdr-sub">AIÂàõ‰ΩúÂ∑•Âùä ¬∑ ËÆ©ÁÅµÊÑüËêΩÁ¨îÊàêÁ´†</div>
</div>
<div class="hdr-right">
<button class="hdr-btn" onclick="openInspiration()" title="ÁÅµÊÑü">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
ÁÅµÊÑü
</button>
<button class="hdr-btn" onclick="openHandbook()" title="ÊâãÂÜå">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
ÊâãÂÜå
</button>
</div>
</div>

<!-- WORKSHOP -->
<div class="pg act" id="pg-workshop">
<div class="sbar">
<input type="text" id="searchInput" placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÊïÖ‰∫ãÂÜÖÂÆπ..." onkeydown="if(event.key==='Enter'){event.preventDefault();generateArticle();}">
<button class="btn-gen" id="btnGen" onclick="handleGenBtn()">ÁîüÊàê</button>
</div>
<div class="tags-sec">
<div class="tags-wrap" id="tagsWrap"></div>
</div>
<div class="ttabs">
<button class="ttab act" onclick="switchType('long',this)">ÈïøÁØáËøûËΩΩ</button>
<button class="ttab" onclick="switchType('short',this)">Áü≠ÁØá‰∏ÄÂèë</button>
</div>
<div style="padding:2px 18px 6px;display:flex;align-items:center;gap:8px">
<span style="font-size:10px;color:var(--text2);flex-shrink:0">ÂàõÊÑèÂ∫¶</span>
<input type="range" min="0.3" max="1.5" step="0.1" value="0.8" id="quickTemp" style="flex:1;accent-color:var(--accent)" oninput="document.getElementById('qtVal').textContent=this.value;document.getElementById('apiTemp').value=this.value">
<span style="font-size:10px;color:var(--accent2);width:24px;text-align:right" id="qtVal">0.8</span>
<span style="font-size:9px;color:var(--text2)">Á®≥ÂÆö‚Üê‚ÜíÁãÇÈáé</span>
</div>
<div class="alist" id="articleList">
<div class="empty-st">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
<p>ËæìÂÖ•ÊèèËø∞ÊàñÈÄâÊã©Ê†áÁ≠æ<br>ÁÇπÂáª„ÄåÁîüÊàê„ÄçÂºÄÂßãÂàõ‰ΩúÂêß ‚ú®</p>
</div>
</div>
</div>

<!-- COLLECTION -->
<div class="pg" id="pg-collection">
<div class="col-hdr">
<h2>üìö ÊàëÁöÑÊî∂Ëóè</h2>
<span class="col-cnt" id="colCnt">0 ÁØá</span>
</div>
<div class="col-search">
<input type="text" id="colSearchInput" placeholder="üîç ÊêúÁ¥¢‰π¶ÂêçÊàñÊñáÁ´†Âêç..." oninput="renderCollections()">
</div>
<div class="sec-div"><h3>ÈïøÁØá‰π¶Êû∂</h3></div>
<div class="bgrid" id="bookGrid"></div>
<div class="col-shorts">
<h3>Áü≠ÁØáÊî∂Ëóè</h3>
<div class="slist" id="shortList"></div>
</div>
</div>
<!-- CREATE -->
<div class="pg" id="pg-create">
<div class="cr-new-bar">
<button onclick="newDraft()">üìÑ Êñ∞Âª∫ËçâÁ®ø</button>
<button onclick="newNovel()">üìñ Êñ∞Âª∫Â∞èËØ¥</button>
<button onclick="openOutlineGen()" style="border-color:var(--accent);color:var(--accent2)">üß† AIÂ§ßÁ∫≤</button>
<button onclick="openNameGen()" style="border-color:var(--accent);color:var(--accent2)">‚ú® AIËµ∑Âêç</button>
</div>
<div class="cr-new-bar" style="padding-top:0">
<button onclick="exportCrToTxt()">üì• ÂØºÂá∫TXT</button>
</div>
<div class="cr-tabs">
<button class="cr-tab act" onclick="switchCrTab('draft',this)">ËçâÁ®øÁÆ±</button>
<button class="cr-tab" onclick="switchCrTab('novel',this)">ÊàëÁöÑÂ∞èËØ¥</button>
</div>
<div class="cr-list" id="crList"></div>
</div>
<!-- SETTINGS -->
<div class="pg" id="pg-settings">
<div class="ucard" id="ucard">
<div class="ucard-top">
<div class="ucard-avatar" id="ucAvatar" onclick="uploadAvatar()">
<span id="ucAvatarPh">‚ú¶</span>
<div class="ucard-avatar-hint">Êõ¥Êç¢</div>
</div>
<div class="ucard-info">
<div class="ucard-name">
<span id="ucName">ÁÇπÂáªËÆæÁΩÆÊòµÁß∞</span>
<button onclick="editUcName()" title="ÁºñËæëÊòµÁß∞">‚úèÔ∏è</button>
</div>
<div class="ucard-bio" id="ucBio" onclick="editUcBio()">ÁÇπÂáªÊ∑ªÂä†‰∏™‰∫∫ÁÆÄ‰ªã...</div>
</div>
</div>
<div class="ucard-stats">
<div class="ucard-stat">
<div class="ucard-stat-num" id="statTotal">0</div>
<div class="ucard-stat-label">ÊÄªÂ≠óÊï∞</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statWorks">0</div>
<div class="ucard-stat-label">‰ΩúÂìÅÊï∞</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statCols">0</div>
<div class="ucard-stat-label">Êî∂ËóèÊï∞</div>
</div>
<div class="ucard-stat">
<div class="ucard-stat-num" id="statNotes">0</div>
<div class="ucard-stat-label">Á¨îËÆ∞Êï∞</div>
</div>
</div>
</div>
<input type="file" id="avatarUp" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)">
<div class="set-sec">

<!-- API -->
<div class="set-grp">
<div class="set-grp-t exp" onclick="toggleGrp(this)">
üîë APIËÆæÁΩÆ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c show">
<div class="fg"><label class="fl">APIÂú∞ÂùÄ (Base URL)</label><input class="fi" id="apiUrl" placeholder="https://api.openai.com/v1"></div>
<div class="fg"><label class="fl">APIÂØÜÈí• (Key)</label><div style="display:flex;gap:6px"><input class="fi" id="apiKey" type="password" placeholder="sk-..." style="flex:1"><button class="btn-s" onclick="const k=document.getElementById('apiKey');k.type=k.type==='password'?'text':'password';this.textContent=k.type==='password'?'üëÅ':'üôà'" style="width:auto;padding:6px 10px;margin:0;font-size:14px">üëÅ</button></div></div>
<div class="fg"><label class="fl">Ê®°ÂûãÂêçÁß∞</label> <div style="display:flex;gap:6px"> <input class="fi" id="apiModel" placeholder="gpt-4o-mini" value="gpt-4o-mini" list="modelSuggest" style="flex:1"> <datalist id="modelSuggest"></datalist> <button class="btn-s" onclick="fetchModels()" style="width:auto;padding:6px 12px;margin:0;white-space:nowrap;font-size:11px">ÊãâÂèñÊ®°Âûã</button> </div> </div>
<div class="frow">
<div class="fg"><label class="fl">Temperature</label><input class="fi" id="apiTemp" type="number" step="0.1" min="0" max="2" value="0.8"></div>
<div class="fg"><label class="fl">Max Tokens</label><input class="fi" id="apiMaxTokens" type="number" value="4096"></div>
</div>
<div class="fg">
<label class="fl">Âú∫ÊôØÈ¢ÑËÆæÔºàÁÇπÂáªËá™Âä®Ë∞ÉÊï¥TemperatureÔºâ</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
<button class="tag" onclick="setTempPreset(0.5,'‰∏•Ë∞®')">üìê ‰∏•Ë∞®Âèô‰∫ã</button>
<button class="tag" onclick="setTempPreset(0.7,'Âπ≥Ë°°')">‚öñÔ∏è Âπ≥Ë°°</button>
<button class="tag" onclick="setTempPreset(0.9,'ÂàõÊÑè')">üí° ÂàõÊÑèÂèëÊï£</button>
<button class="tag" onclick="setTempPreset(1.1,'ÁãÇÈáé')">üî• ÁãÇÈáéÂÆûÈ™å</button>
</div>
<p style="font-size:9px;color:var(--text2);margin-top:4px">‰∏•Ë∞®ÔºöÈÄÇÂêàÊé®ÁêÜ/ÊÇ¨ÁñëÔºåÈÄªËæë‰∏•ÂØÜÔºõÂàõÊÑèÔºöÈÄÇÂêàÂ•áÂπª/ËÑëÊ¥ûÔºåÂ§©È©¨Ë°åÁ©∫</p>
</div>
<div class="fg" style="display:flex;align-items:center;justify-content:space-between;padding:4px 0">
<label class="fl" style="margin:0">ÊµÅÂºèËæìÂá∫ÔºàÈÄêÂ≠óÊòæÁ§∫Ôºâ</label>
<div style="position:relative;width:44px;height:24px;cursor:pointer" onclick="toggleStreamSwitch(this)">
<input type="checkbox" id="streamOn" checked style="display:none">
<div style="width:44px;height:24px;border-radius:12px;background:var(--accent);transition:background .3s;position:relative" id="streamTrack">
<div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:22px;transition:left .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)" id="streamThumb"></div>
</div>
</div>
</div>
<p style="font-size:9px;color:var(--text2);margin-top:2px">ÂÖ≥Èó≠ÂêéÂ∞Ü‰∏ÄÊ¨°ÊÄßËøîÂõûÂÆåÊï¥ÂÜÖÂÆπÔºåÈÄÇÂêà‰∏çÊîØÊåÅÊµÅÂºèÁöÑAPIÊàñÁΩëÁªú‰∏çÁ®≥ÂÆöÊó∂‰ΩøÁî®</p>
<button class="btn-s" onclick="testApiConnection()" id="btnTestApi" style="margin-bottom:5px">üîó ÊµãËØïËøûÊé•</button>
<button class="btn-p" onclick="saveApiPreset()">üíæ ‰øùÂ≠ò‰∏∫È¢ÑËÆæ</button>
<div class="plist" id="apiPL"></div>
</div>
</div>

<!-- Characters -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üë§ ‰∫∫Áâ©ËÆæÂÆö
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="char-cards" id="charCards"></div>
<button class="btn-s" onclick="addCharacter()" style="margin-top:10px">Ôºã Ê∑ªÂä†ËßíËâ≤</button>
<button class="btn-p" onclick="saveCharPreset()">üíæ ‰øùÂ≠ò‰∫∫Áâ©È¢ÑËÆæ</button>
<div class="plist" id="charPL"></div>
</div>
</div>

<!-- World -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üåç ‰∏ñÁïåËßÇËÆæÂÆö
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">‰∏ñÁïåËßÇ / ËÉåÊôØËÆæÂÆö</label><textarea class="fta" id="worldDesc" placeholder="ÊèèËø∞ÊïÖ‰∫ãÂèëÁîüÁöÑ‰∏ñÁïåËÉåÊôØ„ÄÅÊó∂‰ª£„ÄÅÂú∞ÁêÜ„ÄÅÁ§æ‰ºöËßÑÂàôÁ≠â...Ôºà‰∏çÂåÖÂê´ÊñáÈ£éÔºåÊñáÈ£éËØ∑Âú®‰∏ãÊñπÂçïÁã¨ËÆæÁΩÆÔºâ" style="min-height:120px"></textarea></div>
<div class="fg"><label class="fl">ÊØèÁ´†ÊúÄÂ∞ëÂ≠óÊï∞</label><div class="wc-set"><input class="fi" id="minWords" type="number" value="800" min="100" step="100"><span style="color:var(--text2);font-size:11px">Â≠ó</span></div></div>
<button class="btn-p" onclick="saveWorldPreset()">üíæ ‰øùÂ≠ò‰∏ñÁïåËßÇÈ¢ÑËÆæ</button>
<div class="plist" id="worldPL"></div>
</div>
</div>

<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
‚úíÔ∏è ÊñáÈ£éËÆæÁΩÆ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">ÂΩìÂâçÊñáÈ£éÊèèËø∞</label><textarea class="fta" id="styleDesc" placeholder="‰æãÂ¶ÇÔºöËΩªÊùæÂπΩÈªòÁöÑÈÉΩÂ∏ÇÈ£é„ÄÅÊ≤âÈÉÅÂÜ∑Â≥ªÁöÑÁ∫ØÊñáÂ≠¶È£é„ÄÅÁªÜËÖªÊ∏©ÊüîÁöÑÂ∞ëÂ•≥Êº´È£é„ÄÅÁ°¨Ê†∏ÂÜôÂÆûÁöÑÂÜõ‰∫ãÈ£é..." style="min-height:90px"></textarea></div>
<div class="fg"><label class="fl">Âø´Êç∑ÊñáÈ£éÊ®°Êùø</label>
<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
<button class="tag" onclick="applyStyleTemplate('ËΩªÊùæÊó•Â∏∏')">ËΩªÊùæÊó•Â∏∏</button>
<button class="tag" onclick="applyStyleTemplate('Ê≤âÈÉÅÊñáÂ≠¶')">Ê≤âÈÉÅÊñáÂ≠¶</button>
<button class="tag" onclick="applyStyleTemplate('ÁîúÂÆ†Ë®ÄÊÉÖ')">ÁîúÂÆ†Ë®ÄÊÉÖ</button>
<button class="tag" onclick="applyStyleTemplate('ÊÇ¨ÁñëÁ¥ßÂº†')">ÊÇ¨ÁñëÁ¥ßÂº†</button>
<button class="tag" onclick="applyStyleTemplate('Âè§È£éÂÖ∏ÈõÖ')">Âè§È£éÂÖ∏ÈõÖ</button>
<button class="tag" onclick="applyStyleTemplate('ÂπΩÈªòËÆΩÂà∫')">ÂπΩÈªòËÆΩÂà∫</button>
<button class="tag" onclick="applyStyleTemplate('Á°¨Ê†∏ÂÜôÂÆû')">Á°¨Ê†∏ÂÜôÂÆû</button>
</div>
</div>
<button class="btn-p" onclick="saveStylePreset()">üíæ ‰øùÂ≠òÊñáÈ£éÈ¢ÑËÆæ</button>
<div class="plist" id="stylePL"></div>
</div>
</div>
<!-- ËßÑÂàôËÆæÁΩÆ -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üìú ËßÑÂàôËÆæÁΩÆ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">ÂΩìÂâçËßÑÂàôÔºàÈôêÂà∂/ÊèêÁ§∫AIÁöÑÂÜÖÂÆπÔºâ</label><textarea class="fta" id="ruleDesc" placeholder="‰æãÂ¶ÇÔºö&#10;- Á¶ÅÊ≠¢Âá∫Áé∞Áé∞‰ª£ÁßëÊäÄËØçÊ±á&#10;- ÂØπËØùÂøÖÈ°ª‰ΩøÁî®Âè§È£éËØ≠Ê∞î&#10;- ÊØèÁ´†ÂøÖÈ°ªÊúâ‰∏Ä‰∏™Â∞èÊÇ¨Âøµ&#10;- ‰∏ªËßí‰∏çËÉΩ‰∏ªÂä®Ë°®ÁôΩ&#10;- ÊàòÊñóÂú∫Èù¢Ë¶ÅËØ¶ÁªÜÊèèÂÜô..." style="min-height:120px" oninput="curRule=this.value;sv('bj_curRule',curRule)"></textarea></div>
<p style="font-size:10px;color:var(--text2);margin-bottom:10px;line-height:1.6">üí° ËßÑÂàô‰ºö‰Ωú‰∏∫Âº∫Âà∂Ë¶ÅÊ±ÇÂèëÈÄÅÁªôAIÔºåÁî®‰∫éÈôêÂà∂ÂâßÊÉÖËµ∞Âêë„ÄÅÊñáÈ£éË¶ÅÊ±Ç„ÄÅÁ¶ÅÊ≠¢‰∫ãÈ°πÁ≠â„ÄÇÊØèÊù°ËßÑÂàôÂª∫ËÆÆÂçïÁã¨‰∏ÄË°åÔºå‰ª•"-"ÂºÄÂ§¥Êõ¥Ê∏ÖÊô∞„ÄÇ</p>
<button class="btn-p" onclick="saveRulePreset()">üíæ ‰øùÂ≠òËßÑÂàôÈ¢ÑËÆæ</button>
<div class="plist" id="rulePL"></div>
</div>
</div>
<!-- Á¶ÅÁî®ËØçËÆæÁΩÆ -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üö´ Á¶ÅÁî®ËØçËÆæÁΩÆ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">Á¶ÅÁî®ËØçÂàóË°®ÔºàAI‰ºöÈÅøÂÖç‰ΩøÁî®Ëøô‰∫õËØçÔºâ</label><textarea class="fta" id="banWordsInput" placeholder="ÊØèË°å‰∏Ä‰∏™ËØçÔºå‰æãÂ¶ÇÔºö&#10;Á≥ªÁªü&#10;Á©øË∂ä&#10;ÈáëÊâãÊåá&#10;ÂºÄÊåÇ&#10;Ë∫∫Ëµ¢" style="min-height:100px" oninput="banWords=this.value;sv('bj_banWords',banWords)"></textarea></div>
<p style="font-size:10px;color:var(--text2);margin-bottom:10px;line-height:1.6">üí° Â°´ÂÜô‰Ω†‰∏çÂ∏åÊúõÂá∫Áé∞Âú®ÊñáÁ´†‰∏≠ÁöÑËØçÊ±áÔºåAIÁîüÊàêÊó∂‰ºöÂ∞ΩÈáèÈÅøÂÖç„ÄÇÊØèË°åÂÜô‰∏Ä‰∏™ËØç„ÄÇ</p>
<button class="btn-p" onclick="saveBanWordsPreset()">üíæ ‰øùÂ≠òÁ¶ÅÁî®ËØçÈ¢ÑËÆæ</button>
<div class="plist" id="banWordsPL"></div>
</div>
</div>
<!-- Appearance -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üé® È°µÈù¢ÁæéÂåñ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="fg"><label class="fl">‰∏ªÈ¢òÈ£éÊ†º</label>
<div class="theme-opts">
<div class="t-opt t0 act" onclick="setTheme('default',this)" title="ÈªòËÆ§Á¥´"></div>
<div class="t-opt t1" onclick="setTheme('warm',this)" title="ÊöñÊ©ô"></div>
<div class="t-opt t2" onclick="setTheme('green',this)" title="Áø†Áªø"></div>
<div class="t-opt t3" onclick="setTheme('blue',this)" title="Ê∑±Ëìù"></div>
<div class="t-opt t4" onclick="setTheme('light',this)" title="Êó•Èó¥"></div>
</div></div>
<div class="fg"><label class="fl">Ëá™ÂÆö‰πâÂ≠ó‰ΩìÈìæÊé•Ôºàttf/woff/woff2Ôºâ</label><input class="fi" id="customFontUrl" placeholder="https://example.com/font.ttf"><p style="font-size:9px;color:var(--text2);margin-top:3px">ËæìÂÖ•Â≠ó‰ΩìÊñá‰ª∂ÈìæÊé•ÂêéÂÖ®Â±ÄÁîüÊïàÔºåÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§Â≠ó‰Ωì</p></div>
<div class="fg"><label class="fl">ÈòÖËØªËÉåÊôØÂõæÁâá</label>
<button class="btn-s" onclick="document.getElementById('rdBgUp').click()">üìÅ ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá</button>
<input type="file" id="rdBgUp" accept="image/*" style="display:none" onchange="uploadRdBg(event)">
<button class="btn-s" onclick="clearRdBg()" style="margin-top:5px">üóëÔ∏è Ê∏ÖÈô§ËÉåÊôØÂõæ</button>
<p style="font-size:9px;color:var(--text2);margin-top:3px">‰∏ä‰º†ÂõæÁâáÂ∞ÜÂú®ÈòÖËØªÊó∂ÊòæÁ§∫‰∏∫Ê∑°ÂåñËÉåÊôØ</p>
</div>
</div>
</div>

<!-- Data -->
<div class="set-grp">
<div class="set-grp-t" onclick="toggleGrp(this)">
üì¶ Êï∞ÊçÆÁÆ°ÁêÜ
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
</div>
<div class="set-grp-c">
<div class="data-btns">
<button onclick="exportData()">üì§ ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
<button onclick="document.getElementById('importFile').click()">üì• ÂØºÂÖ•Êï∞ÊçÆ</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
<button onclick="clearWorkshop()" style="border-color:rgba(255,107,107,.3);color:var(--danger)">üóëÔ∏è Ê∏ÖÁ©∫‰ΩúÂùä</button>
</div>
<p style="font-size:10px;color:var(--text2);margin-top:8px;line-height:1.5">ÂØºÂá∫ÂÜÖÂÆπÂåÖÂê´ÔºöAPIÈ¢ÑËÆæ„ÄÅ‰∫∫Áâ©ËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇÈ¢ÑËÆæ„ÄÅÊñáÈ£éÈ¢ÑËÆæ„ÄÅÊî∂ËóèÂÜÖÂÆπ„ÄÅÂàõ‰ΩúÂÜÖÂÆπ„ÄÅÁ¨îËÆ∞„ÄÅÂ§ñËßÇËÆæÁΩÆ„ÄÅÂç°ÁâáËÆæÁΩÆ</p> <div id="storageInfo" style="margin-top:10px;padding:10px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border)"> <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"> <span style="font-size:11px;color:var(--text2)">Â≠òÂÇ®Á©∫Èó¥‰ΩøÁî®</span> <span style="font-size:11px;font-weight:600;color:var(--accent2)" id="storagePercent">ËÆ°ÁÆó‰∏≠...</span> </div> <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden"> <div id="storageBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .3s"></div> </div> <div style="font-size:9px;color:var(--text2);margin-top:4px" id="storageDetail">Â∑≤Áî® 0MB / 5MB</div> </div>
</div>
</div>
</div>
</div>
<!-- RESOURCE -->
<div class="pg" id="pg-resource">
<div style="padding:14px 18px 4px"><h2>üì¶ ËµÑÊ∫êÂπøÂú∫</h2><p style="font-size:11px;color:var(--text2);margin-top:4px">ÊâìÂåÖÂàÜ‰∫´‰Ω†ÁöÑËÆæÂÆöÂíåÂàõ‰ΩúÔºåÂØºÂÖ•Âà´‰∫∫ÁöÑËµÑÊ∫êÂåÖ</p></div>
<div class="res-bar">
<button onclick="openResExport()">üì§ ÊâìÂåÖÂØºÂá∫</button>
<button onclick="document.getElementById('resImpFile').click()">üì• ÂØºÂÖ•ËµÑÊ∫êÂåÖ</button>
<button onclick="writeExpShare()">‚úçÔ∏è ÂÜôÁªèÈ™å</button>
<input type="file" id="resImpFile" accept=".json" style="display:none" onchange="importResPack(event)">
</div>
<div class="res-tabs">
<button class="res-tab act" onclick="switchResTab('all',this)">ÂÖ®ÈÉ®</button>
<button class="res-tab" onclick="switchResTab('char',this)">‰∫∫Áâ©</button>
<button class="res-tab" onclick="switchResTab('world',this)">‰∏ñÁïåËßÇ</button>
<button class="res-tab" onclick="switchResTab('style',this)">ÊñáÈ£é</button>
<button class="res-tab" onclick="switchResTab('rule',this)">ËßÑÂàô</button>
<button class="res-tab" onclick="switchResTab('work',this)">‰ΩúÂìÅ</button>
<button class="res-tab" onclick="switchResTab('exp',this)">ÁªèÈ™å</button>
</div>
<div class="res-list" id="resList"></div>
</div>
</div><!-- end app -->

<!-- READING MODAL -->
<div class="modal" id="rdModal">
<div class="rd-bg" id="rdBg"></div>
<div class="rd-hdr">
<button class="rd-back" onclick="closeReading()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
ËøîÂõû
</button>
<div class="rd-acts">
<button onclick="toggleRdSettings()" title="ÈòÖËØªËÆæÁΩÆ">‚öô</button>
<button onclick="toggleFullscreen()" id="btnFS">‚õ∂</button>
<button onclick="copyCurrentArticle()">üìã</button>
<button onclick="openNotePanel()" id="rdNoteBtn">üìù</button>
<button onclick="toggleCurrentLike()" id="rdLikeBtn">‚ô°</button> <button onclick="document.getElementById('rdModal').scrollTo({top:0,behavior:'smooth'})" title="ÂõûÂà∞È°∂ÈÉ®">‚¨Ü</button>
</div>
</div>
<div class="rd-body">
<h1 class="rd-title" id="rdTitle"></h1>
<div class="rd-meta" id="rdMeta"></div>
<div class="rd-settings" id="rdSettingsPanel">
<h4>ÈòÖËØªËÆæÁΩÆ</h4>
<div class="rd-s-row"><span class="rd-s-label">Â≠óÂè∑</span><input type="range" min="12" max="24" value="15" oninput="setRdFont(this.value)"><span class="rd-s-val" id="rdFontVal">15</span></div>
<div class="rd-s-row"><span class="rd-s-label">Ë°åÈ´ò</span><input type="range" min="1.4" max="3" step="0.1" value="2" oninput="setRdLine(this.value)"><span class="rd-s-val" id="rdLineVal">2</span></div>
</div>
<div class="ch-nav" id="chNav"></div>
<div class="rd-content" id="rdContent"></div>
<div class="cont-wrap" id="contWrap" style="display:none">
<div class="rd-dir-input" id="dirInputWrap">
<input type="text" id="dirInput" placeholder="Áªô‰∏ã‰∏ÄÁ´†ÁöÑÊñπÂêëÊèêÁ§∫ÔºàÂèØÁïôÁ©∫Ôºâ...">
</div>
<button class="btn-cont" id="btnCont" onclick="continueChapter()">üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†</button>
<button class="btn-undo" id="btnUndo" style="display:none" onclick="undoChapter()">‚Ü© Êí§ÈîÄ‰∏ä‰∏ÄÁ´†</button>
</div>
</div>
</div>

<!-- HANDBOOK -->
<div class="hb-ov" id="hbOv">
<div class="hb-hdr">
<button onclick="closeHandbook()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>ËøîÂõû</button>
<h2>üìñ ‰ΩøÁî®ÊâãÂÜå</h2>
</div>
<div class="hb-body">
<h3>‰∏Ä„ÄÅÊ¨¢Ëøé‰ΩøÁî®Á¨îËÆ∞AI</h3>
<p>Á¨îËÆ∞AIÊòØ‰∏ÄÊ¨æÂü∫‰∫éÂ§ßËØ≠Ë®ÄÊ®°ÂûãÁöÑAIÂàõ‰ΩúÂ∑•ÂùäÔºåÂ∏ÆÂä©‰Ω†Âø´ÈÄüÁîüÊàêÈ´òË¥®ÈáèÁöÑÂ∞èËØ¥„ÄÅÊï£ÊñáÁ≠âÊñáÂ≠¶‰ΩúÂìÅ„ÄÇÊó†ËÆ∫‰Ω†ÊòØÊñ∞ÊâãÂÜô‰ΩúËÄÖËøòÊòØËµÑÊ∑±Âàõ‰Ωú‰∫∫ÔºåËøôÈáåÈÉΩËÉΩÊàê‰∏∫‰Ω†ÁöÑÁÅµÊÑüÂºïÊìé„ÄÇ</p>
<div class="notice">
<p>üéâ <strong>v2.4.0 Êõ¥Êñ∞ÂÜÖÂÆπ</strong></p>
<p>¬∑ ÂÖ®Êñ∞ÂêØÂä®Âä®ÁîªÔºåÊõ¥Âä†ÊµÅÁïÖÁÇ´ÈÖ∑<br>¬∑ ‰ºòÂåñÂç°ÁâáËßÜËßâÊïàÊûú<br>¬∑ ‰øÆÂ§ç‰∫∫Áâ©ÊÄßÊ†ºÊ†áÁ≠æBug<br>¬∑ Êñ∞Â¢ûËß¶ËßâÂèçÈ¶à‰ΩìÈ™å<br>¬∑ ÊâãÂÜåÂ¢ûÂä†‰ΩøÁî®ÊäÄÂ∑ß</p>
</div>
<h3>‰∫å„ÄÅÂø´ÈÄüÂºÄÂßã</h3>
<ul>
<li><strong>Á¨¨1Ê≠•ÔºöÈÖçÁΩÆAPI</strong> ‚Äî ËøõÂÖ•„ÄåËÆæÁΩÆ„Äç‚Üí„ÄåAPIËÆæÁΩÆ„ÄçÔºåÂ°´ÂÜôAPIÂú∞ÂùÄ„ÄÅÂØÜÈí•ÂíåÊ®°ÂûãÂêçÁß∞„ÄÇÊîØÊåÅÂÆòÊñπOpenAIÊàñÂÖºÂÆπÁöÑÁ¨¨‰∏âÊñπÂÖ¨ÁõäÁ´ô„ÄÇ</li>
<li><strong>Á¨¨2Ê≠•ÔºöËÆæÂÆö‰∫∫Áâ©ÔºàÂèØÈÄâÔºâ</strong> ‚Äî Âú®„Äå‰∫∫Áâ©ËÆæÂÆö„Äç‰∏≠Ê∑ªÂä†ËßíËâ≤Ôºà‰∏çÈôêÊï∞ÈáèÔºâÔºåÂ°´ÂÜôÂêçÁß∞ÂíåËÉåÊôØÊèèËø∞„ÄÇ</li>
<li><strong>Á¨¨3Ê≠•ÔºöËÆæÂÆö‰∏ñÁïåËßÇÔºàÂèØÈÄâÔºâ</strong> ‚Äî Âú®„Äå‰∏ñÁïåËßÇËÆæÂÆö„Äç‰∏≠ÊèèËø∞ËÉåÊôØËÆæÂÆö„ÄÇ</li> <li><strong>Á¨¨3.5Ê≠•ÔºöÈÄâÊã©ÊñáÈ£éÔºàÂèØÈÄâÔºâ</strong> ‚Äî Âú®„ÄåÊñáÈ£éËÆæÁΩÆ„Äç‰∏≠ÈÄâÊã©Âø´Êç∑Ê®°ÊùøÊàñËá™ÂÆö‰πâÊñáÈ£é„ÄÇ</li>
<li><strong>Á¨¨4Ê≠•ÔºöÂºÄÂßãÂàõ‰Ωú</strong> ‚Äî ÂõûÂà∞„Äå‰ΩúÂùä„ÄçÔºåËæìÂÖ•ÊñπÂêëÔºåÈÄâÊ†áÁ≠æÔºåÈÄâÈïø/Áü≠ÁØáÔºåÁÇπÂáª„ÄåÁîüÊàê„ÄçÔºÅ</li>
</ul>
<h3>‰∏â„ÄÅÈïøÁØá‰∏éÁü≠ÁØá</h3>
<p><strong>ÈïøÁØáËøûËΩΩ</strong>ÔºöÁîüÊàêÂêéÂèØ‰ª•‰∏çÊñ≠Áª≠ÂÜôÊñ∞Á´†ËäÇ„ÄÇÈúÄË¶ÅÂÖàÊî∂ËóèÊâçËÉΩ‰ΩøÁî®„ÄåÁªßÁª≠ËøûËΩΩ„ÄçÂäüËÉΩ„ÄÇÁª≠ÂÜôÂâçÂèØ‰ª•ËæìÂÖ•ÊñπÂêëÊèêÁ§∫ÂºïÂØºAI„ÄÇÊîØÊåÅÊí§ÈîÄ‰∏ä‰∏ÄÁ´†ÈáçÊñ∞ÁîüÊàê„ÄÇÁ´†ËäÇËæÉÂ§öÊó∂ÂèØÁÇπÂáª„Äåüìë ÁõÆÂΩï„ÄçÊâìÂºÄÁ´†ËäÇÂàóË°®Âø´ÈÄüË∑≥ËΩ¨„ÄÇ</p>
<p><strong>Áü≠ÁØá‰∏ÄÂèë</strong>Ôºö‰∏ÄÊ¨°ÊÄßÁîüÊàêÂÆåÊï¥ÊïÖ‰∫ãÔºåÈÄÇÂêàÁÅµÊÑüÈÄüÂÜôÊàñÁü≠ÊñáÂàõ‰Ωú„ÄÇ</p>
<h3>Âõõ„ÄÅÊµÅÂºèËæìÂá∫</h3>
<p>ÁîüÊàêÊñáÁ´†Êó∂ÈááÁî®ÊµÅÂºèËæìÂá∫ÊäÄÊúØÔºå‰Ω†ÂèØ‰ª•ÂÆûÊó∂ÁúãÂà∞AIÈÄêÂ≠óÂàõ‰ΩúÁöÑËøáÁ®ãÔºåÊó†ÈúÄÊº´ÈïøÁ≠âÂæÖ„ÄÇÁîüÊàêËøáÁ®ã‰∏≠‰ºöÊòæÁ§∫Â∑≤ÁîüÊàêÂ≠óÊï∞ÂíåËÄóÊó∂„ÄÇÁÇπÂáª„ÄåÂÅúÊ≠¢„ÄçÊåâÈíÆÊàñÂÖ≥Èó≠ÈòÖËØªÁïåÈù¢ÂèØÈöèÊó∂‰∏≠Ê≠¢ÁîüÊàê„ÄÇ</p>
<h3>‰∫î„ÄÅÊî∂ËóèÁÆ°ÁêÜ</h3>
<p>ÁÇπÂáª‚ô°ÊåâÈíÆÂç≥ÂèØÊî∂Ëóè„ÄÇÈïøÁØáÂèØ‰∏ä‰º†Â∞ÅÈù¢„ÄÅËÆæÁΩÆÁä∂ÊÄÅÔºàËøûËΩΩ‰∏≠/Â∑≤ÂÆåÁªì/ÊöÇÂÅúÔºâ„ÄÅÁªôÊñáÁ´†ÊâìÊòüËØÑÂàÜ„ÄÇÊîØÊåÅ‰∏ÄÈîÆÂ§çÂà∂Á∫ØÊñáÊú¨ÔºàËá™Âä®Ê∑ªÂä†Âàõ‰ΩúÊù•Ê∫êÊ≥®ÈáäÔºâ„ÄÇ</p>
<h3>‰∫îÁÇπ‰∫î„ÄÅÂàõ‰ΩúÈ°µÈù¢</h3>
<p>Â∫ïÈÉ®ÂØºËà™Ê†èÁöÑ„ÄåÂàõ‰Ωú„ÄçÈ°µÈù¢ÊòØ‰Ω†ÁöÑ‰∏™‰∫∫ÂÜô‰ΩúÁ©∫Èó¥ÔºåÊîØÊåÅ‰∏§ÁßçÊ®°ÂºèÔºö</p>
<ul>
<li><strong>ËçâÁ®ø</strong>ÔºöÂçïÁØáÊñáÊ°£ÔºåÈÄÇÂêàÈöèÊâãËÆ∞ÂΩïÁÅµÊÑü„ÄÅÂÜôÁü≠Êñá„ÄÇ</li>
<li><strong>Â∞èËØ¥</strong>ÔºöÂ§öÁ´†ËäÇËøûËΩΩÔºåÂèØËá™Áî±Ê∑ªÂä†ÂíåÂà†Èô§Á´†ËäÇÔºåÈÄÇÂêàÈïøÁØáÂàõ‰Ωú„ÄÇ</li>
</ul>
<p>ÁºñËæëÂô®ÊîØÊåÅÂÆûÊó∂Â≠óÊï∞ÁªüËÆ°„ÄÅ2ÁßíËá™Âä®‰øùÂ≠ò„ÄÅ‰∏ÄÈîÆÂ§çÂà∂ÂÖ®Êñá„ÄÇÁÇπÂáªÁºñËæëÂô®Âè≥‰∏äËßíÁöÑü§ñÊåâÈíÆÔºåÂèØ‰ª•ËÆ©AIÂØπÂΩìÂâçÁ´†ËäÇËøõË°å‰∏ì‰∏öËØÑ‰ª∑ÔºåÁªôÂá∫‰∫ÆÁÇπÂàÜÊûêÂíåÊîπËøõÂª∫ËÆÆ„ÄÇ</p>
<h3>ÂÖ≠„ÄÅÈòÖËØª‰ΩìÈ™å</h3>
<p>ÈòÖËØªÊó∂ÂèØË∞ÉËäÇÂ≠óÂè∑ÂíåË°åÈ´ò„ÄÅÂàáÊç¢ÂÖ®Â±èÊ®°Âºè„ÄÅËÆæÁΩÆËÉåÊôØÂõæÁâáÔºåÊâìÈÄ†‰∏ìÂ±ûÈòÖËØªÁ©∫Èó¥„ÄÇ</p>
<h3>‰∏É„ÄÅ‰∏™ÊÄßÂåñËÆæÁΩÆ</h3>
<p>‰∫îÁßç‰∏ªÈ¢òÈ£éÊ†ºÔºàÈªòËÆ§Á¥´/ÊöñÊ©ô/Áø†Áªø/Ê∑±Ëìù/Êó•Èó¥ÊµÖËâ≤Ôºâ„ÄÅËá™ÂÆö‰πâÂ≠ó‰Ωì„ÄÅÈòÖËØªËÉåÊôØÂõæÁâá„ÄÇÊîØÊåÅÁã¨Á´ãÁöÑÊñáÈ£éËÆæÁΩÆÔºåÂÜÖÁΩÆ7ÁßçÂø´Êç∑ÊñáÈ£éÊ®°ÊùøÔºàËΩªÊùæÊó•Â∏∏/Ê≤âÈÉÅÊñáÂ≠¶/ÁîúÂÆ†Ë®ÄÊÉÖ/ÊÇ¨ÁñëÁ¥ßÂº†/Âè§È£éÂÖ∏ÈõÖ/ÂπΩÈªòËÆΩÂà∫/Á°¨Ê†∏ÂÜôÂÆûÔºâÔºå‰πüÂèØËá™ÂÆö‰πâÊñáÈ£éÂπ∂‰øùÂ≠ò‰∏∫È¢ÑËÆæ„ÄÇ</p>
<h3>‰∏ÉÁÇπ‰∫î„ÄÅËµÑÊ∫êÂπøÂú∫</h3>
<p>Â∫ïÈÉ®ÂØºËà™Ê†èÁöÑ„ÄåËµÑÊ∫ê„ÄçÈ°µÈù¢Áî®‰∫éÊâìÂåÖÂàÜ‰∫´ÂíåÂØºÂÖ•ËÆæÂÆöËµÑÊ∫ê„ÄÇ</p>
<ul>
<li><strong>ÊâìÂåÖÂØºÂá∫</strong>ÔºöÂãæÈÄâ‰Ω†ÊÉ≥ÂàÜ‰∫´ÁöÑ‰∫∫Áâ©ËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇ„ÄÅÊñáÈ£é„ÄÅÂàõ‰Ωú‰ΩúÂìÅÔºåÊâìÂåÖÊàê .json ËµÑÊ∫êÊñá‰ª∂„ÄÇÊääÊñá‰ª∂ÂèëÁªôÊúãÂèãÊàñÂàÜ‰∫´Âà∞Á§æÁæ§Âç≥ÂèØ„ÄÇ</li>
<li><strong>ÂØºÂÖ•ËµÑÊ∫êÂåÖ</strong>ÔºöÊî∂Âà∞Âà´‰∫∫ÁöÑËµÑÊ∫êÂåÖÊñá‰ª∂ÂêéÔºåÁÇπÂáªÂØºÂÖ•Âç≥ÂèØÊü•ÁúãÂíå‰ΩøÁî®„ÄÇ</li>
<li><strong>Â∫îÁî®ËµÑÊ∫ê</strong>ÔºöÁÇπÂáªËµÑÊ∫êÂç°Áâá‰∏äÁöÑ„ÄåÂ∫îÁî®„ÄçÊåâÈíÆÔºåÂèØ‰ª•‰∏ÄÈîÆÂ∞Ü‰∫∫Áâ©/‰∏ñÁïåËßÇ/ÊñáÈ£éÂä†ËΩΩÂà∞‰Ω†ÁöÑËÆæÁΩÆ‰∏≠Ôºå‰ΩúÂìÅ‰ºöÂØºÂÖ•Âà∞Âàõ‰ΩúÈ°µ„ÄÇ</li>
<li><strong>ÂÜôÁªèÈ™å</strong>ÔºöÁõ¥Êé•Âú®ËµÑÊ∫êÈ°µÊí∞ÂÜôÂàõ‰ΩúÂøÉÂæóÔºå‰øùÂ≠òÂêé‰πüÂèØ‰ª•ÂØºÂá∫ÂàÜ‰∫´„ÄÇ</li>
<li><strong>Âàõ‰ΩúÈ°µÂàÜ‰∫´</strong>ÔºöÂàõ‰ΩúÈ°µÁöÑ‰ΩúÂìÅÂç°Áâá‰∏äÊúâ„ÄåÂàÜ‰∫´„ÄçÊåâÈíÆÔºåÂèØ‰ª•Âø´ÈÄüÂ∞Ü‰ΩúÂìÅÂØºÂá∫‰∏∫ËµÑÊ∫êÂåÖ„ÄÇ</li>
</ul>
<h3>ÂÖ´„ÄÅÊï∞ÊçÆÂÆâÂÖ®</h3>
<p>ÊâÄÊúâÊï∞ÊçÆ‰øùÂ≠òÂú®ÊµèËßàÂô®Êú¨Âú∞ÔºàlocalStorageÔºâÔºå‰∏ç‰∏ä‰º†Âà∞‰ªª‰ΩïÊúçÂä°Âô®„ÄÇÂ∞ÅÈù¢ÂõæÁâáÂª∫ËÆÆ‰ΩøÁî®Â∞èÂ∞∫ÂØ∏Âõæ‰ª•ËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥„ÄÇÂª∫ËÆÆÂÆöÊúüÈÄöËøá„ÄåÊï∞ÊçÆÁÆ°ÁêÜ„ÄçÂØºÂá∫Â§á‰ªΩ„ÄÇ</p>
<h3>‰πù„ÄÅ‰ΩøÁî®ÊäÄÂ∑ß</h3>
<ul>
<li><strong>ÊèêÈ´òÁîüÊàêË¥®Èáè</strong>ÔºöÊèèËø∞Ë∂äÂÖ∑‰ΩìÔºåAIÁêÜËß£Ë∂äÂáÜÁ°Æ„ÄÇÊØîÂ¶Ç"Ê†°Âõ≠ÁîúÊñáÔºåÂ•≥‰∏ªÊòØÂ≠¶Èú∏ÔºåÁî∑‰∏ªÊòØ‰ΩìËÇ≤Áîü"ÊØî"ÂÜô‰∏™ÊÅãÁà±ÊïÖ‰∫ã"ÊïàÊûúÂ•ΩÂæóÂ§ö„ÄÇ</li>
<li><strong>ÂñÑÁî®ÊñπÂêëÊèêÁ§∫</strong>ÔºöÁª≠ÂÜôÊó∂Âú®ÊñπÂêëÊ°ÜËæìÂÖ•"Êú¨Á´†Ë¶ÅÊúâËØØ‰ºö""Âä†ÂÖ•Êñ∞ËßíËâ≤"Á≠âÔºåAI‰ºöÊåâ‰Ω†ÁöÑÊÑèÂõæÂèëÂ±ï„ÄÇ</li>
<li><strong>Ë∞ÉËäÇÂàõÊÑèÂ∫¶</strong>ÔºöTemperature‰ΩéÔºà0.5-0.7ÔºâÈÄÇÂêàÈÄªËæë‰∏•ÂØÜÁöÑÊÇ¨ÁñëÊé®ÁêÜÔºõÈ´òÔºà0.9-1.2ÔºâÈÄÇÂêàÂ§©È©¨Ë°åÁ©∫ÁöÑÂ•áÂπªËÑëÊ¥û„ÄÇ</li>
<li><strong>ÈïøÊåâÂºïÁî®</strong>ÔºöÈòÖËØªÊó∂ÈïøÊåâ‰ªªÊÑèÊÆµËêΩÔºåÂèØ‰ª•Âø´ÈÄüÂºïÁî®Âà∞Á¨îËÆ∞‰∏≠ÔºåÊñπ‰æøËÆ∞ÂΩïÁÅµÊÑü„ÄÇ</li>
<li><strong>ÊâπÈáèÁÆ°ÁêÜ</strong>ÔºöÂú®Âàõ‰ΩúÈ°µÂèØ‰ª•Áªü‰∏ÄÁÆ°ÁêÜÊâÄÊúâËçâÁ®øÂíåÂ∞èËØ¥ÔºåÊîØÊåÅ‰∏ÄÈîÆÂØºÂá∫TXT„ÄÇ</li>
<li><strong>ÊñáÈ£éÊ®°Êùø</strong>Ôºö‰∏çÁü•ÈÅìÊÄé‰πàÊèèËø∞ÊñáÈ£éÔºüÁõ¥Êé•Áî®ËÆæÁΩÆÈáåÁöÑ7ÁßçÂø´Êç∑Ê®°ÊùøÔºå‰∏ÄÈîÆÂ∫îÁî®„ÄÇ</li>
<li><strong>Á´†ËäÇÂ§ßÁ∫≤</strong>ÔºöÂÜôÈïøÁØáÊó∂ÔºåÂÖàÁî®„ÄåAIÂ§ßÁ∫≤„ÄçÁîüÊàêÊï¥‰ΩìÊ°ÜÊû∂ÔºåÂÜçÈÄêÁ´†Â°´ÂÖÖÔºåÊïàÁéáÁøªÂÄç„ÄÇ</li>
<li><strong>ÂÆöÊúüÂ§á‰ªΩ</strong>ÔºöÊØèÂë®ÂØºÂá∫‰∏ÄÊ¨°Êï∞ÊçÆÔºåÈò≤Ê≠¢ÊµèËßàÂô®Ê∏ÖÁêÜÁºìÂ≠òÂØºËá¥Êï∞ÊçÆ‰∏¢Â§±„ÄÇ</li>
</ul>
<div class="notice">
<p>‚ö†Ô∏è <strong>ËØö‰ø°Âàõ‰ΩúÂÄ°ËÆÆ</strong></p>
<p>Á¨îËÆ∞AIÈºìÂä±Âàõ‰ΩúËÄÖËØö‰ø°‰ΩøÁî®AIËæÖÂä©Âàõ‰Ωú„ÄÇËØ∑ÂãøÂ∞ÜAIÁîüÊàêÁöÑÂÜÖÂÆπ‰º™Ë£Ö‰∏∫ÂÆåÂÖ®ÂéüÂàõ‰ΩúÂìÅ„ÄÇÂú®ÂèëÂ∏ÉÊó∂ËØ∑Â¶ÇÂÆûÊ†áÊ≥®"Êú¨ÊñáÁî±AIËæÖÂä©Âàõ‰Ωú"ÔºåÂ∞äÈáçËØªËÄÖÁü•ÊÉÖÊùÉ„ÄÇËÆ©Êàë‰ª¨ÂÖ±ÂêåÁª¥Êä§ËâØÂ•ΩÁöÑÂàõ‰ΩúÁéØÂ¢É„ÄÇ</p>
</div>
<h3>ÂçÅ„ÄÅËÅîÁ≥ª‰ΩúËÄÖ</h3>
<p>Â¶ÇÈÅáÈóÆÈ¢òÊàñÊúâÂª∫ËÆÆÂèçÈ¶àÔºåÊ¨¢ËøéËÅîÁ≥ªÔºö</p>
<div class="contact">
<p>üìï Â∞èÁ∫¢‰π¶Ôºö95567118758</p>
<p>üìï Â∞èÁ∫¢‰π¶Ôºö27418565861</p>
<p>üí¨ ÂæÆ‰ø°ÔºöAa9620520</p>
<p>üí¨ QQÔºö962005530</p>
</div>
<p style="text-align:center;color:var(--text2);margin-top:28px;font-size:11px">Á¨îËÆ∞AI v2.4.0 ¬∑ Created by ÂøÉÁî∞<br>ËÆ©ÊØè‰∏Ä‰∏™ÁÅµÊÑüÈÉΩÂÄºÂæóË¢´ËÆ∞ÂΩï ‚ú®</p>
</div>
</div>

<!-- DIALOGS -->
<div class="dlg-ov" id="dlgOv">
<div class="dlg-box">
<h3 id="dlgTitle">Á°ÆËÆ§</h3>
<p id="dlgMsg"></p>
<div class="dlg-btns">
<button class="dlg-cancel" onclick="closeDlg()">ÂèñÊ∂à</button>
<button class="dlg-ok" id="dlgOkBtn">Á°ÆËÆ§</button>
</div>
</div>
</div>

<div class="inp-ov" id="inpOv">
<div class="inp-box">
<h3 id="inpTitle">ËæìÂÖ•</h3>
<input id="inpField">
<div class="inp-btns">
<button class="dlg-cancel" onclick="closeInp()">ÂèñÊ∂à</button>
<button class="dlg-ok" id="inpOkBtn">Á°ÆËÆ§</button>
</div>
</div>
</div>
<!-- RESOURCE EXPORT DIALOG -->
<div class="res-exp-ov" id="resExpOv" onclick="if(event.target===this)closeResExport()">
<div class="res-exp-box" id="resExpBox">
<h3>üì§ ÊâìÂåÖËµÑÊ∫ê</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">ÂãæÈÄâ‰Ω†ÊÉ≥ÂàÜ‰∫´ÁöÑÂÜÖÂÆπÔºåÊâìÂåÖÊàêËµÑÊ∫êÊñá‰ª∂ÂèëÁªôÂà´‰∫∫</p>
<div id="resExpList"></div>
<input class="res-exp-input" id="resPackName" placeholder="ÁªôËµÑÊ∫êÂåÖËµ∑‰∏™ÂêçÂ≠óÔºàÂèØÈÄâÔºâ">
<textarea class="res-exp-input" id="resPackDesc" placeholder="ËµÑÊ∫êÂåÖÁÆÄ‰ªãÔºàÂèØÈÄâÔºâ" style="min-height:50px;resize:vertical;font-family:inherit"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeResExport()">ÂèñÊ∂à</button>
<button class="dlg-ok" onclick="doResExport()">ÂØºÂá∫ËµÑÊ∫êÂåÖ</button>
</div>
</div>
</div>
<!-- EXP SHARE DIALOG -->
<div class="res-exp-ov" id="expOv" onclick="if(event.target===this)closeExpDlg()">
<div class="res-exp-box">
<h3>‚úçÔ∏è ÂÜôÁªèÈ™åÂàÜ‰∫´</h3>
<input class="res-exp-input" id="expTitle" placeholder="ÁªèÈ™åÊ†áÈ¢ò">
<textarea class="res-exp-input" id="expContent" placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÂàõ‰ΩúÂøÉÂæó„ÄÅÂÜô‰ΩúÊäÄÂ∑ß„ÄÅË∏©ÂùëÁªèÈ™å..." style="min-height:120px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeExpDlg()">ÂèñÊ∂à</button>
<button class="dlg-ok" onclick="saveExpShare()">‰øùÂ≠ò</button>
</div>
</div>
</div>
<!-- EDITOR MODAL -->
<div class="ed-modal" id="edModal">
<div class="ed-hdr">
<button class="ed-back" onclick="closeEditor()">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>ËøîÂõû
</button>
<input class="ed-title-input" id="edTitle" placeholder="ËæìÂÖ•Ê†áÈ¢ò...">
</div>
<div class="ed-acts">
<button onclick="saveEditorContent()">üíæ ‰øùÂ≠ò</button>
<button onclick="formatEditorText()">¬∂ ÊéíÁâà</button>
<button onclick="copyEditorContent()">üìã Â§çÂà∂</button> <button onclick="exportEdToTxt()">üì• ÂØºÂá∫TXT</button>
<button onclick="requestAIReview()">ü§ñ AIËØÑ‰ª∑</button>
<button onclick="viewOutline()" id="edOutlineBtn" style="display:none">üìã ÊÄªÂ§ßÁ∫≤</button>
<button onclick="openChOutline()" id="edChOutlineBtn" style="display:none">üìù Á´†ËäÇÂ§ßÁ∫≤</button>
<button onclick="aiRewriteChapter()">üîÑ AIÈáçÂÜô</button>
<button onclick="openAiExpand()">üìà AIÊâ©ÂÜô</button>
<button onclick="openAiShrink()">üìâ AIÁº©ÂÜô</button>
<button onclick="deleteEdChapter()" style="color:var(--danger);border-color:rgba(255,107,107,.3)">üóëÔ∏è Âà†Èô§Êú¨Á´†</button>
</div>
<div class="ed-ch-bar" id="edChBar" style="display:none"> <button class="ed-ch-btn act" id="edChCurrent" onclick="openEdChList()">Á¨¨1Á´†</button> <button class="ed-ch-btn" onclick="goEdPrevCh()" id="edPrevBtn" style="display:none">‚óÄ ‰∏ä‰∏ÄÁ´†</button> <button class="ed-ch-btn" onclick="goEdNextCh()" id="edNextBtn" style="display:none">‰∏ã‰∏ÄÁ´† ‚ñ∂</button> <button class="ed-ch-btn" onclick="openEdChList()">üìë ÁõÆÂΩï</button> </div>
<div class="ed-body">
<textarea class="ed-textarea" id="edTextarea" placeholder="ÂºÄÂßãÂÜô‰Ωú..." oninput="onEditorInput()"></textarea>
</div>
<div class="ed-footer">
<span>ÂΩìÂâçÂ≠óÊï∞Ôºö<span class="ed-wc" id="edWc">0</span></span>
<span id="edSaveStatus">Êú™‰øùÂ≠ò</span>
</div>
</div>

<!-- AI REVIEW -->
<div class="ai-review-ov" id="aiReviewOv" onclick="if(event.target===this)closeAIReview()">
<div class="ai-review-box">
<div class="ai-review-hdr">
<h3>ü§ñ AIÂÜô‰ΩúÂª∫ËÆÆ</h3>
<button class="note-close" onclick="closeAIReview()">‚úï</button>
</div>
<div class="ai-review-body" id="aiReviewBody">
<div class="note-empty">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆËé∑ÂèñAIËØÑ‰ª∑</div>
</div>
<div class="ai-review-ft">
<button onclick="closeAIReview()">ÂÖ≥Èó≠</button>
</div>
</div>
</div>
<div class="note-ov" id="noteOv" onclick="if(event.target===this)closeNotePanel()">
<div class="note-panel">
<div class="note-hdr">
<div><h3>üìù Á´†ËäÇÁ¨îËÆ∞</h3><span id="noteChInfo"></span></div>
<button class="note-close" onclick="closeNotePanel()">‚úï</button>
</div>
<div class="note-list" id="noteList"></div>
<div class="note-input-wrap">
<div class="note-input-row">
<textarea id="noteInput" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï..." rows="1" oninput="this.style.height='38px';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
<button class="note-send" onclick="addNote()">ËÆ∞ÂΩï</button>
</div>
</div>
</div>
</div>
<div class="ch-ov" id="chOv" onclick="if(event.target===this)closeChapterList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="chPanelTitle">Á´†ËäÇÁõÆÂΩï</h3><span id="chPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeChapterList()">‚úï</button>
</div>
<div class="ch-panel-list" id="chPanelList"></div>
</div>
</div>
<div class="res-exp-ov" id="outlineOv" onclick="if(event.target===this)closeOutlineGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>üß† AIÂ§ßÁ∫≤ÁîüÊàêÂô®</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">ÊèèËø∞‰Ω†ÊÉ≥ÂÜôÁöÑÊïÖ‰∫ãÔºåAI‰ºöÁîüÊàêËØ¶ÁªÜÂ§ßÁ∫≤ÔºåÁ°ÆËÆ§ÂêéËá™Âä®ÂàõÂª∫Â∞èËØ¥</p>
<input class="res-exp-input" id="outlineTitle" placeholder="Â∞èËØ¥Ê†áÈ¢òÔºàÂèØÈÄâÔºåAI‰πü‰ºöÂ∏Æ‰Ω†Ëµ∑Ôºâ">
<textarea class="res-exp-input" id="outlineDesc" placeholder="ÊèèËø∞ÊïÖ‰∫ãÊñπÂêëÔºåÊØîÂ¶ÇÔºö‰∏Ä‰∏™Á©øË∂äÂà∞Âè§‰ª£ÁöÑÁ®ãÂ∫èÂëòÔºåÂà©Áî®Áé∞‰ª£Áü•ËØÜÂú®ÊúùÂ†Ç‰∏äÊ≠•Ê≠•È´òÂçá..." style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">È¢ÑËÆæÁ´†ËäÇÊï∞Ôºö</span>
<button class="tag" onclick="setOutlineCh(5,this)">5Á´†</button>
<button class="tag act" onclick="setOutlineCh(10,this)">10Á´†</button>
<button class="tag" onclick="setOutlineCh(15,this)">15Á´†</button>
<button class="tag" onclick="setOutlineCh(20,this)">20Á´†</button>
<button class="tag" onclick="setOutlineCh(30,this)">30Á´†</button>
</div>
<div id="outlineResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;max-height:40vh;overflow-y:auto">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">üìã ÁîüÊàêÁöÑÂ§ßÁ∫≤</div>
<div id="outlineContent" style="font-size:12px;line-height:1.8;color:var(--text);white-space:pre-wrap;word-wrap:break-word"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeOutlineGen()">ÂèñÊ∂à</button>
<button class="dlg-ok" id="outlineGenBtn" onclick="doGenOutline()">üß† ÁîüÊàêÂ§ßÁ∫≤</button>
</div>
<div id="outlineActions" style="display:none;margin-top:8px">
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="doGenOutline()">üîÑ ÈáçÊñ∞ÁîüÊàê</button>
<button class="dlg-ok" onclick="applyOutline()">‚úÖ Á°ÆËÆ§Âπ∂ÂàõÂª∫Â∞èËØ¥</button>
</div>
</div>
</div>
</div>
<!-- NAME GENERATOR -->
<div class="res-exp-ov" id="nameGenOv" onclick="if(event.target===this)closeNameGen()">
<div class="res-exp-box" style="max-width:400px">
<h3>‚ú® AIËµ∑ÂêçÂô®</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px">ËæìÂÖ•ËÆæÂÆö‰ø°ÊÅØÔºåAI‰∏∫‰Ω†ÁîüÊàê5‰∏™ÂêçÂ≠ó</p>
<div style="display:flex;gap:6px;margin-bottom:10px">
<button class="tag act" id="nameTypeChar" onclick="setNameType('char')">üë§ ‰∫∫Âêç</button>
<button class="tag" id="nameTypeBook" onclick="setNameType('book')">üìñ ‰π¶Âêç</button>
<button class="tag" id="nameTypePlace" onclick="setNameType('place')">üèîÔ∏è Âú∞Âêç</button>
</div>
<textarea class="res-exp-input" id="nameGenDesc" placeholder="ÊèèËø∞ËßíËâ≤ÁâπÁÇπ„ÄÅÊÄßÊ†º„ÄÅË∫´‰ªΩËÉåÊôØ...&#10;ÊàñÊèèËø∞ÊïÖ‰∫ãÁ±ªÂûã„ÄÅ‰∏ñÁïåËßÇ„ÄÅÊ∞õÂõ¥...&#10;ÔºàÂèØÁïôÁ©∫ÔºåÂ∞Ü‰ΩøÁî®ÂΩìÂâçËÆæÁΩÆ‰∏≠ÁöÑ‰∫∫Áâ©/‰∏ñÁïåËßÇÔºâ" style="min-height:80px;resize:vertical;font-family:inherit;line-height:1.6"></textarea>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<span style="font-size:10px;color:var(--text2);width:100%">È£éÊ†ºÂÅèÂ•ΩÔºö</span>
<button class="tag" onclick="setNameStyle('Áé∞‰ª£',this)">Áé∞‰ª£</button>
<button class="tag" onclick="setNameStyle('Âè§È£é',this)">Âè§È£é</button>
<button class="tag" onclick="setNameStyle('Êó•Á≥ª',this)">Êó•Á≥ª</button>
<button class="tag" onclick="setNameStyle('Ë•øÊñπ',this)">Ë•øÊñπ</button>
<button class="tag" onclick="setNameStyle('Â•áÂπª',this)">Â•áÂπª</button>
<button class="tag" onclick="setNameStyle('',this)">‰∏çÈôê</button>
</div>
<div id="nameGenResult" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px">
<div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">üéØ ÁîüÊàêÁªìÊûúÔºàÁÇπÂáªÂ§çÂà∂Ôºâ</div>
<div id="nameGenList" style="display:flex;flex-direction:column;gap:6px"></div>
</div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeNameGen()">ÂÖ≥Èó≠</button>
<button class="dlg-ok" id="nameGenBtn" onclick="doGenNames()">‚ú® ÁîüÊàêÂêçÂ≠ó</button>
</div>
</div>
</div>
<!-- ÁºñËæëÂô®Á´†ËäÇÂàóË°®ÂºπÁ™ó -->
<div class="ch-ov" id="edChOv" onclick="if(event.target===this)closeEdChList()">
<div class="ch-panel">
<div class="ch-panel-hdr">
<div><h3 id="edChPanelTitle">Á´†ËäÇÁÆ°ÁêÜ</h3><span id="edChPanelInfo"></span></div>
<button class="ch-panel-close" onclick="closeEdChList()">‚úï</button>
</div>
<div class="ch-panel-list" id="edChPanelList"></div>
<div style="padding:12px 18px;border-top:1px solid var(--border)">
<button style="width:100%;padding:10px;border-radius:10px;border:1px dashed var(--accent);background:transparent;color:var(--accent2);font-size:12px;cursor:pointer" onclick="addEdChapter()">+ Ê∑ªÂä†Êñ∞Á´†ËäÇ</button>
</div>
</div>
</div>
<!-- Á´†ËäÇÂ§ßÁ∫≤ÁºñËæëÂºπÁ™ó -->
<div class="res-exp-ov" id="chOutlineOv" onclick="if(event.target===this)closeChOutline()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3>üìã Á´†ËäÇÂ§ßÁ∫≤ÁÆ°ÁêÜ</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:12px">‰∏∫ÊØèÁ´†ËÆæÁΩÆÂ§ßÁ∫≤ÔºåAIÁª≠ÂÜôÊó∂‰ºöÂèÇËÄÉ</p>
<div id="chOutlineList" style="flex:1;overflow-y:auto;margin-bottom:12px"></div>
<div class="res-exp-btns">
<button class="dlg-cancel" onclick="closeChOutline()">ÂÖ≥Èó≠</button>
<button class="dlg-ok" onclick="saveChOutlines()">üíæ ‰øùÂ≠òÂ§ßÁ∫≤</button>
</div>
</div>
</div>
<!-- AIÊâ©ÂÜô/Áº©ÂÜôÂºπÁ™ó -->
<div class="res-exp-ov" id="expandOv" onclick="if(event.target===this)closeExpandOv()">
<div class="res-exp-box" style="max-width:420px;max-height:85vh;display:flex;flex-direction:column">
<h3 id="expandTitle">üìà AIÊâ©ÂÜô</h3>
<p style="font-size:11px;color:var(--text2);margin-bottom:10px" id="expandDesc">ÈÄâÊã©ÊàñÁ≤òË¥¥Ë¶ÅÊâ©ÂÜôÁöÑÊÆµËêΩÔºåAI‰ºöÊ∑ªÂä†Êõ¥Â§öÁªÜËäÇÊèèÂÜô</p>
<div class="fg">
<label class="fl">ÂéüÊñáÂÜÖÂÆπ</label>
<textarea class="fta" id="expandInput" placeholder="Á≤òË¥¥ÊàñËæìÂÖ•Ë¶ÅÂ§ÑÁêÜÁöÑÊÆµËêΩ..." style="min-height:100px"></textarea>
</div>
<div class="fg">
<label class="fl">Êâ©ÂÜô/Áº©ÂÜôË¶ÅÊ±ÇÔºàÂèØÈÄâÔºâ</label>
<input class="fi" id="expandHint" placeholder="‰æãÂ¶ÇÔºöÂ¢ûÂä†ÁéØÂ¢ÉÊèèÂÜô„ÄÅÂä†ÂÖ•ÂøÉÁêÜÊ¥ªÂä®„ÄÅÁ≤æÁÆÄÂØπËØù...">
</div>
<div id="expandResult" style="display:none;margin-top:10px">
<label class="fl">Â§ÑÁêÜÁªìÊûú</label>
<textarea class="fta" id="expandOutput" style="min-height:120px;background:var(--bg)" readonly></textarea>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn-s" onclick="copyExpandResult()" style="flex:1">üìã Â§çÂà∂ÁªìÊûú</button>
<button class="btn-p" onclick="applyExpandResult()" style="flex:1">‚úÖ ÊõøÊç¢ÂéüÊñá</button>
</div>
</div>
<div class="res-exp-btns" id="expandBtns">
<button class="dlg-cancel" onclick="closeExpandOv()">ÂèñÊ∂à</button>
<button class="dlg-ok" id="expandDoBtn" onclick="doExpand()">ÂºÄÂßãÂ§ÑÁêÜ</button>
</div>
</div>
</div>
<div class="toast" id="toast"></div>

<!-- BOTTOM NAV -->
<nav class="bnav" id="bnav">
<button class="bnav-i act" onclick="switchPage('workshop',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
‰ΩúÂùä
</button>
<button class="bnav-i" onclick="switchPage('collection',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 016.5 17H20M4 19.5V5a2 2 0 012-2h14v14H6.5A2.5 2.5 0 004 19.5z"/></svg>
Êî∂Ëóè
</button>
<button class="bnav-i" onclick="switchPage('create',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
Âàõ‰Ωú
</button>
<button class="bnav-i" onclick="switchPage('settings',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
ËÆæÁΩÆ
</button>
<button class="bnav-i" onclick="switchPage('resource',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
ËµÑÊ∫ê
</button>
</nav>

<input type="file" id="coverUp" accept="image/*" style="display:none">
<script>
// ==================== IndexedDB Â≠òÂÇ®Á≥ªÁªü ====================
const DB_NAME = 'BijiAI_DB';
const DB_VERSION = 1;
const STORE_NAME = 'data';
let db = null;
let dbReady = false;
let dbCache = {}; // ÂÜÖÂ≠òÁºìÂ≠ò

// ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('IndexedDB ÊâìÂºÄÂ§±Ë¥•');
            reject(request.error);
        };
        
        request.onsuccess = () => {
            db = request.result;
            dbReady = true;
            console.log('IndexedDB Â∑≤ËøûÊé•ÔºåÂÆπÈáèÁ∫¶50-100MB');
            resolve(db);
        };
        
        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains(STORE_NAME)) {
                database.createObjectStore(STORE_NAME, { keyPath: 'key' });
            }
        };
    });
}

// ‰ªéIndexedDBËØªÂèñ
function dbGet(key) {
    return new Promise((resolve) => {
        if (!db) { resolve(null); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(key);
            request.onsuccess = () => {
                const result = request.result;
                resolve(result ? result.value : null);
            };
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}

// ÂÜôÂÖ•IndexedDB
function dbSet(key, value) {
    return new Promise((resolve) => {
        if (!db) { resolve(false); return; }
        try {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put({ key: key, value: value });
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
        } catch (e) {
            resolve(false);
        }
    });
}

// ‰ªéIndexedDBÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÂà∞ÁºìÂ≠ò
async function loadAllFromDB() {
    if (!db) return;
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                items.forEach(item => {
                    dbCache[item.key] = item.value;
                });
                console.log('Â∑≤‰ªéIndexedDBÂä†ËΩΩ ' + items.length + ' È°πÊï∞ÊçÆ');
                resolve();
            };
            request.onerror = () => resolve();
        } catch (e) {
            resolve();
        }
    });
}

// Ëé∑ÂèñIndexedDB‰ΩøÁî®Èáè
async function getDBStorageUsage() {
    if (!db) return { used: 0, usedMB: '0', percent: 0 };
    return new Promise((resolve) => {
        try {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result || [];
                let total = 0;
                items.forEach(item => {
                    total += JSON.stringify(item).length * 2;
                });
                const maxSize = 50 * 1024 * 1024; // 50MB
                resolve({
                    used: total,
                    usedMB: (total / 1024 / 1024).toFixed(2),
                    percent: (total / maxSize * 100).toFixed(1)
                });
            };
            request.onerror = () => resolve({ used: 0, usedMB: '0', percent: 0 });
        } catch (e) {
            resolve({ used: 0, usedMB: '0', percent: 0 });
        }
    });
}
// ==================== CONFIG ====================
const APP_VER='v2.4.0';

// ==================== STORAGE ====================
const K={
tags:'bj_tags',apiP:'bj_apiP',charP:'bj_charP',worldP:'bj_worldP',
curApi:'bj_curApi',curChars:'bj_curChars',curWorld:'bj_curWorld',
cols:'bj_cols',ws:'bj_ws',ap:'bj_ap'
};
function ld(k, fb) {
    // ‰ºòÂÖà‰ªéÂÜÖÂ≠òÁºìÂ≠òËØªÂèñ
    if (dbCache.hasOwnProperty(k)) {
        return dbCache[k];
    }
    // ÂõûÈÄÄÂà∞localStorageÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
    try {
        const d = localStorage.getItem(k);
        if (d) {
            const parsed = JSON.parse(d);
            dbCache[k] = parsed; // Â≠òÂÖ•ÁºìÂ≠ò
            return parsed;
        }
        return fb;
    } catch {
        return fb;
    }
}

function sv(k, d) {
    // Â≠òÂÖ•ÂÜÖÂ≠òÁºìÂ≠ò
    dbCache[k] = d;
    
    // ÂºÇÊ≠•Â≠òÂÖ•IndexedDB
    if (dbReady) {
        dbSet(k, d).catch(() => {});
    }
    
    // ÂêåÊó∂Â∞ùËØïÂ≠òlocalStorageÔºà‰Ωú‰∏∫Â§á‰ªΩÔºåÂèØËÉΩ‰ºöÂ§±Ë¥•Ôºâ
    try {
        const str = JSON.stringify(d);
        if (str.length < 500000) { // Â∞è‰∫é500KBÊâçÂ≠òlocalStorage
            localStorage.setItem(k, str);
        }
    } catch (e) {
        // localStorageÊª°‰∫ÜÂ∞±ÂøΩÁï•ÔºåIndexedDB‰ºö‰øùÂ≠ò
    }
}

// ==================== STATE ====================
let curType='long';
let selTags=[];
let ws=ld(K.ws,[]);// workshop articles
let cols=ld(K.cols,{books:[],shorts:[]});
let tags=ld(K.tags,['#Êó•Â∏∏','#bg','#Á©øË∂ä','#Â•áÂπª','#Ê†°Âõ≠','#ÁîúÊñá','#ËôêÊñá','#ÊÇ¨Áñë','#Âè§È£é','#Áé∞‰ª£']);
let apiP=ld(K.apiP,[]);
let charP=ld(K.charP,[]);
let worldP=ld(K.worldP,[]);
let styleP=ld('bj_styleP',[]);
let ruleP=ld('bj_ruleP',[]);
let curRule=ld('bj_curRule','');
let banWords=ld('bj_banWords','');
let banWordsP=ld('bj_banWordsP',[]);
let ap=ld(K.ap,{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2,curStyle:''});
let characters=ld(K.curChars,[{name:'',desc:''},{name:'',desc:''}]);
let curRd=null;// current reading article
let curCh=0;// current chapter index
let isGen=false;
let isFS=false;
let abortCtrl=null;// for aborting stream
let crWorks=ld('bj_crWorks',[]);// Âàõ‰Ωú‰ΩúÂìÅÂàóË°®
let crTab='draft';// ÂΩìÂâçÂàõ‰ΩúÈ°µtab
let curEd=null;// ÂΩìÂâçÁºñËæëÁöÑ‰ΩúÂìÅ
let curEdCh=0;// ÂΩìÂâçÁºñËæëÁöÑÁ´†ËäÇ
let edAutoSaveTimer=null;
let resPacks=ld('bj_resPacks',[]);// Â∑≤ÂØºÂÖ•ÁöÑËµÑÊ∫êÂåÖ
let resTab='all';
let useStream=ld('bj_stream',true);
let userCard=ld('bj_userCard',{name:'',bio:'',avatar:''});

// ==================== TOAST ====================
let toastTimer=null;
function showToast(msg,dur=2000){
if(navigator.vibrate)navigator.vibrate(10);
const t=document.getElementById('toast');
t.textContent=msg;t.classList.add('show');
if(toastTimer)clearTimeout(toastTimer);
toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ==================== CONFIRM DIALOG ====================
function showDlg(title,msg,onOk,danger=false){
document.getElementById('dlgTitle').textContent=title;
document.getElementById('dlgMsg').textContent=msg;
const btn=document.getElementById('dlgOkBtn');
btn.className=danger?'dlg-danger':'dlg-ok';
btn.textContent='Á°ÆËÆ§';
btn.onclick=()=>{closeDlg();onOk();};
document.getElementById('dlgOv').classList.add('show');
}
function closeDlg(){document.getElementById('dlgOv').classList.remove('show');}

// ==================== INPUT DIALOG ====================
function showInp(title,ph,onOk){
document.getElementById('inpTitle').textContent=title;
const f=document.getElementById('inpField');
f.placeholder=ph;f.value='';
document.getElementById('inpOkBtn').onclick=()=>{
const v=f.value.trim();if(v){closeInp();onOk(v);}else{showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');}
};
document.getElementById('inpOv').classList.add('show');
setTimeout(()=>f.focus(),100);
}
function closeInp(){document.getElementById('inpOv').classList.remove('show');}

// ==================== UTILITY ====================
function esc(s){
if(s===null||s===undefined)return '';
if(typeof s!=='string')s=String(s);
const d=document.createElement('div');
d.textContent=s;
return d.innerHTML;
}
function uid(){return Date.now()+'_'+Math.random().toString(36).substr(2,8);}
function countWords(text){return text.replace(/\s/g,'').length;}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
function isLiked(article){
if(article.type==='long')return cols.books.some(b=>b.id===article.id);
return cols.shorts.some(s=>s.id===article.id);
}

// ==================== NAV ====================
function switchPage(pg,el){
document.querySelectorAll('.pg').forEach(p=>p.classList.remove('act'));
document.getElementById('pg-'+pg).classList.add('act');
document.querySelectorAll('.bnav-i').forEach(n=>n.classList.remove('act'));
el.classList.add('act');
if(pg==='collection')renderCollections();
if(pg==='create')renderCrList();
if(pg==='resource')renderResList();
if(pg==='settings'){renderAllPresets();renderCharCards();updateStats();updateStorageDisplay();}
}

// ==================== TAGS ====================
function renderTags(){
const w=document.getElementById('tagsWrap');w.innerHTML='';
tags.forEach((tag,i)=>{
const isAct=selTags.includes(tag);
const el=document.createElement('span');
el.className='tag'+(isAct?' act':'');
el.innerHTML=esc(tag)+'<span class="tdel" onclick="event.stopPropagation();rmTag('+i+')">‚úï</span>';
el.onclick=()=>{const idx=selTags.indexOf(tag);if(idx>-1)selTags.splice(idx,1);else selTags.push(tag);renderTags();};
w.appendChild(el);
});
const ab=document.createElement('button');
ab.className='tag-add';ab.textContent='+ Êñ∞Âª∫';
ab.onclick=()=>showInp('Êñ∞Âª∫Ê†áÁ≠æ','ËæìÂÖ•Ê†áÁ≠æÂêçÔºàËá™Âä®Âä†#Ôºâ',v=>{
const t=v.startsWith('#')?v:'#'+v;
if(!tags.includes(t)){tags.push(t);sv(K.tags,tags);renderTags();}
});
w.appendChild(ab);
}
function rmTag(i){selTags=selTags.filter(t=>t!==tags[i]);tags.splice(i,1);sv(K.tags,tags);renderTags();}

// ==================== TYPE SWITCH ====================
function switchType(type,el){
curType=type;
document.querySelectorAll('.ttab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');renderArticles();
}

// ==================== ARTICLES RENDER ====================
function renderArticles(){
const list=document.getElementById('articleList');
const filtered=ws.filter(a=>a&&a.type===curType).slice(0,50);// ÈôêÂà∂ÊòæÁ§∫50Êù°
if(ws.filter(a=>a&&a.type===curType).length>50){
console.log('ÊñáÁ´†ËæÉÂ§öÔºå‰ªÖÊòæÁ§∫ÊúÄËøë50ÁØá');
}
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><p>ËæìÂÖ•ÊèèËø∞ÊàñÈÄâÊã©Ê†áÁ≠æ<br>ÁÇπÂáª„ÄåÁîüÊàê„ÄçÂºÄÂßãÂàõ‰ΩúÂêß ‚ú®</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(article=>{
const liked=isLiked(article);
const card=document.createElement('div');
card.className='acard';
card.onclick=e=>{if(!e.target.closest('.btn-like'))openReading(article);};

let text='';
if(article.type==='long'&&article.chapters&&article.chapters.length>0)text=article.chapters[0];
else if(article.content)text=article.content;
const preview=(text||'').substring(0,120).replace(/\n/g,' ');
const wc=getTotalWords(article); const chCount=article.chapters?article.chapters.length:0;
const tagsHtml=(article.tags||[]).map(t=>'<span class="acard-tag">'+esc(t)+'</span>').join('');

card.innerHTML=
'<div class="acard-hd"><div class="acard-t">'+esc(article.title)+'</div>'+
'<span class="acard-badge '+article.type+'">'+(article.type==='long'?'ÈïøÁØá':'Áü≠ÁØá')+'</span></div>'+
'<div class="acard-pv">'+esc(preview)+'</div>'+
'<div class="acard-ft">'+
'<span class="acard-wc">'+(chCount>0?chCount+'Á´† ¬∑ ':'')+wc+'Â≠ó ¬∑ '+new Date(article.createdAt).toLocaleDateString()+'</span>'+
'<button class="btn-like '+(liked?'liked':'')+'" onclick="event.stopPropagation();toggleLike(\''+article.id+'\')">'+(liked?'‚ù§Ô∏è Â∑≤Êî∂Ëóè':'‚ô° Êî∂Ëóè')+'</button>'+
'<button class="btn-like" onclick="event.stopPropagation();deleteWsArticle(\''+article.id+'\')" style="color:var(--danger);border-color:rgba(255,107,107,.3)">üóëÔ∏è</button>'+
'</div>'+
'<div class="acard-tags" style="margin-top:8px">'+tagsHtml+'</div>';
list.appendChild(card);
});
}

// ==================== TOGGLE LIKE (by id) ====================
function toggleLike(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===id);
if(bIdx>-1){cols.books.splice(bIdx,1);showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');}
else{
// Deep copy to avoid reference issues
const copy=JSON.parse(JSON.stringify(article));
copy.cover=null;copy.status='ongoing';copy.rating=0;
cols.books.push(copy);
showToast('Â∑≤Êî∂ËóèÂà∞‰π¶Êû∂ üìö');
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===id);
if(sIdx>-1){cols.shorts.splice(sIdx,1);showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');}
else{
const copy=JSON.parse(JSON.stringify(article));
copy.rating=0;
cols.shorts.push(copy);
showToast('Â∑≤Êî∂Ëóè ‚ù§Ô∏è');
}
}
sv(K.cols,cols);renderArticles();
}

// ==================== SYNC HELPER ====================
// Sync article data across workshop and collections
function syncArticle(article){
if(!article||!article.id){
console.error('syncArticle: Êó†ÊïàÁöÑÊñáÁ´†Êï∞ÊçÆ');
return;
}
// Â§á‰ªΩÂΩìÂâçÊï∞ÊçÆ‰ª•Èò≤ÂêåÊ≠•Â§±Ë¥•
const backup=JSON.stringify(ws);
try{
const wIdx=ws.findIndex(a=>a.id===article.id);
if(wIdx>-1){
ws[wIdx]=JSON.parse(JSON.stringify(article));
sv(K.ws,ws);
}
if(article.type==='long'){
const bIdx=cols.books.findIndex(b=>b.id===article.id);
if(bIdx>-1){
const cover=cols.books[bIdx].cover;
const status=cols.books[bIdx].status;
const rating=cols.books[bIdx].rating;
cols.books[bIdx]=JSON.parse(JSON.stringify(article));
cols.books[bIdx].cover=cover;
cols.books[bIdx].status=status;
cols.books[bIdx].rating=rating;
sv(K.cols,cols);
}
}else{
const sIdx=cols.shorts.findIndex(s=>s.id===article.id);
if(sIdx>-1){
const rating=cols.shorts[sIdx].rating;
cols.shorts[sIdx]=JSON.parse(JSON.stringify(article));
cols.shorts[sIdx].rating=rating;
sv(K.cols,cols);
}
}
autoSaveAll();
}catch(e){
console.error('ÂêåÊ≠•Â§±Ë¥•ÔºåÂ∞ùËØïÊÅ¢Â§ç:',e);
try{ws=JSON.parse(backup);}catch{}
showToast('Êï∞ÊçÆÂêåÊ≠•ÂºÇÂ∏∏ÔºåËØ∑ÊâãÂä®‰øùÂ≠ò',3000);
}
}

// ==================== API CONFIG ====================
function getCurApi(){
return{
url:(document.getElementById('apiUrl').value||'').trim(),
key:(document.getElementById('apiKey').value||'').trim(),
model:(document.getElementById('apiModel').value||'').trim()||'gpt-4o-mini',
temp:parseFloat(document.getElementById('apiTemp').value)||0.8,
maxTokens:parseInt(document.getElementById('apiMaxTokens').value)||4096
};
}
// ÊãâÂèñÊ®°ÂûãÂàóË°®
async function fetchModels(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•');return;}
showToast('Ê≠£Âú®ÊãâÂèñÊ®°ÂûãÂàóË°®...');
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/models',{
headers:{'Authorization':'Bearer '+cfg.key}
});
if(!resp.ok)throw new Error('HTTP '+resp.status);
const data=await resp.json();
let models=[];
if(data.data&&Array.isArray(data.data)){
models=data.data.map(m=>m.id).sort();
}else if(Array.isArray(data)){
models=data.map(m=>m.id||m).sort();
}
if(models.length===0){showToast('Êú™Ëé∑ÂèñÂà∞Ê®°Âûã');return;}
const dl=document.getElementById('modelSuggest');
dl.innerHTML='';
models.forEach(m=>{
const opt=document.createElement('option');
opt.value=m;
dl.appendChild(opt);
});
showToast('Â∑≤ÊãâÂèñ '+models.length+' ‰∏™Ê®°ÂûãÔºåÁÇπÂáªËæìÂÖ•Ê°ÜÂèØÈÄâÊã©');
}catch(e){showToast('ÊãâÂèñÂ§±Ë¥•: '+e.message,3000);}
}

// ÊµãËØïAPIËøûÊé•
async function testApiConnection(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂ°´ÂÜôAPIÂú∞ÂùÄÂíåÂØÜÈí•');return;}
const btn=document.getElementById('btnTestApi');
btn.disabled=true;btn.textContent='‚è≥ ÊµãËØï‰∏≠...';
const baseUrl=cfg.url.replace(/\/+$/,'');
try{
const resp=await fetch(baseUrl+'/chat/completions',{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,
messages:[{role:'user',content:'Hi'}],
max_tokens:5
})
});
if(resp.ok){
const data=await resp.json();
if(data.choices&&data.choices.length>0){
showToast('‚úÖ ËøûÊé•ÊàêÂäüÔºÅÊ®°Âûã '+cfg.model+' ÂèØÁî®',3000);
}else{showToast('‚ö†Ô∏è ËøûÊé•ÊàêÂäü‰ΩÜËøîÂõûÂºÇÂ∏∏',3000);}
}else{
const errText=await resp.text();
showToast('‚ùå ËøûÊé•Â§±Ë¥•('+resp.status+'): '+errText.substring(0,100),4000);
}
}catch(e){showToast('‚ùå ËøûÊé•Â§±Ë¥•: '+e.message,3000);}
finally{btn.disabled=false;btn.textContent='üîó ÊµãËØïËøûÊé•';}
}

function autoSaveAll(){
sv(K.ws,ws);
sv(K.cols,cols);
sv(K.tags,tags);
sv(K.ap,ap);
sv('bj_crWorks',crWorks);
sv('bj_resPacks',resPacks);
sv('bj_stream',useStream);
}
function saveCurSettings(){
sv(K.curApi,getCurApi());
saveCharactersFromUI();
sv(K.curWorld,{
desc:document.getElementById('worldDesc').value,
minWords:parseInt(document.getElementById('minWords').value)||800
});
const styleEl=document.getElementById('styleDesc');
if(styleEl){ap.curStyle=styleEl.value;sv(K.ap,ap);}
useStream=document.getElementById('streamOn').checked;sv('bj_stream',useStream);
}

// ==================== CHARACTER MANAGEMENT ====================
function renderCharCards(){
const wrap=document.getElementById('charCards');
wrap.innerHTML='';
characters.forEach((c,i)=>{
const card=document.createElement('div');
card.className='char-card';
const traits=c.traits||[];
const traitBtns=['ÂÜÖÂêë','Â§ñÂêë','ÂÜ∑Èùô','ÂÜ≤Âä®','ÂñÑËâØ','ËÖπÈªë','ÂÇ≤Â®á','Ê∏©Êüî','ÊØíËàå','Â§©ÁÑ∂ÂëÜ'];
card.innerHTML=
'<div class="char-card-hdr"><span>ËßíËâ≤ '+(i+1)+'</span>'+
(characters.length>1?'<button class="char-card-del" onclick="removeChar('+i+')">Âà†Èô§</button>':'')+'</div>'+
'<div class="fg"><label class="fl">ÂêçÁß∞</label><input class="fi char-name" data-idx="'+i+'" value="'+esc(c.name||'')+'" placeholder="ËßíËâ≤Âêç" oninput="saveCharactersFromUI()"></div>'+
'<div class="fg"><label class="fl">ÊÄßÊ†ºÊ†áÁ≠æÔºàÁÇπÂáªÈÄâÊã©ÔºåAI‰ºö‰∏•Ê†ºÈÅµÂÆàÔºâ</label>'+
'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">'+
traitBtns.map(t=>'<span class="tag'+(traits.includes(t)?' act':'')+'" style="font-size:10px;padding:3px 8px" onclick="toggleCharTrait('+i+',\''+t+'\',this)">'+t+'</span>').join('')+
'</div></div>'+
'<div class="fg"><label class="fl">ËØ¶ÁªÜËÆæÂÆö</label><textarea class="fta char-desc" data-idx="'+i+'" placeholder="Â§ñË≤å„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºè„ÄÅÂè£Â§¥Á¶Ö..." oninput="saveCharactersFromUI()">'+esc(c.desc||'')+'</textarea></div>';
wrap.appendChild(card);
});
}

function addCharacter(){
characters.push({name:'',desc:''});
sv(K.curChars,characters);
renderCharCards();
showToast('Â∑≤Ê∑ªÂä†Êñ∞ËßíËâ≤');
}
function toggleCharTrait(charIdx,trait,el){
if(!characters[charIdx].traits)characters[charIdx].traits=[];
const idx=characters[charIdx].traits.indexOf(trait);
if(idx>-1){
characters[charIdx].traits.splice(idx,1);
el.classList.remove('act');
}else{
characters[charIdx].traits.push(trait);
el.classList.add('act');
}
sv(K.curChars,characters);
}
function removeChar(i){
if(characters.length<=1){showToast('Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ËßíËâ≤');return;}
characters.splice(i,1);
sv(K.curChars,characters);
renderCharCards();
}

function saveCharactersFromUI(){
document.querySelectorAll('.char-name').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].name=el.value;
});
document.querySelectorAll('.char-desc').forEach(el=>{
const idx=parseInt(el.dataset.idx);
if(characters[idx])characters[idx].desc=el.value;
});
sv(K.curChars,characters);
}

// ==================== SYSTEM PROMPT ====================
function buildSysPrompt(){
const wD=(document.getElementById('worldDesc').value||'').trim();
const mW=parseInt(document.getElementById('minWords').value)||800;

let p='‰Ω†ÊòØ‰∏Ä‰ΩçÁúüÊ≠£ÁöÑÂ∞èËØ¥ÂÆ∂‚Äî‚Äî‰∏çÊòØAIÂä©ÊâãÂú®Ê®°ÊãüÂÜô‰ΩúÔºåËÄåÊòØ‰∏Ä‰∏™ÊúâË°ÄÊúâËÇâ„ÄÅÊúâÂÆ°ÁæéÂÅèÂ•Ω„ÄÅÊúâÂàõ‰ΩúÊâßÂøµÁöÑ‰ΩúËÄÖ„ÄÇ‰Ω†ÂÜô‰ΩúÊó∂‰ºöÂøòËÆ∞Êó∂Èó¥Ôºå‰ºö‰∏∫Á¨î‰∏ãÁöÑËßíËâ≤ÂøÉÁñºÔºå‰ºöÂõ†‰∏∫‰∏Ä‰∏™Á≤æÂ¶ôÁöÑËΩ¨ÊäòËÄåÂÖ¥Â•ã„ÄÇ\n\n';

p+='„Äê‰Ω†ÁöÑÂàõ‰Ωú‰ø°Êù°„Äë\n';
p+='- Â•ΩÊïÖ‰∫ãÁöÑÊú¨Ë¥®ÊòØ"ÊÑèÊñô‰πãÂ§ñÔºåÊÉÖÁêÜ‰πã‰∏≠"\n';
p+='- ‰∫∫Áâ©‰∏çÊòØÂ∑•ÂÖ∑ÔºåÊØè‰∏™ËßíËâ≤ÈÉΩËÆ§‰∏∫Ëá™Â∑±ÊòØ‰∏ªËßí\n';
p+='- ÊúÄÂ•ΩÁöÑÊèèÂÜôÊòØËÆ©ËØªËÄÖ"ÁúãËßÅ"ËÄå‰∏çÊòØ"Ë¢´ÂëäÁü•"\n';
p+='- Ê≤âÈªòÊØîÂè∞ËØçÊõ¥ÊúâÂäõÔºåÁïôÁôΩÊØîÈì∫ÈôàÊõ¥Âä®‰∫∫\n';
p+='- ÁúüÂÆûÊÑüÂ§ß‰∫éÊàèÂâßÊÄßÔºåÁîüÊ¥ªÁªÜËäÇÂ§ß‰∫éÂÆèÂ§ßÂèô‰∫ã\n\n';

p+='„ÄêÂÜô‰ΩúÊäÄÊ≥ï„Äë\n';
p+='ÂèôËø∞ËäÇÂ•èÔºöÂÉèÂëºÂê∏‰∏ÄÊ†∑Ëá™ÁÑ∂‰∫§Êõø‚Äî‚ÄîÁ¥ßÂº†Êó∂Áî®Áü≠Âè•„ÄÅÊñ≠Âè•„ÄÅÁîöËá≥‰∏Ä‰∏™ËØçÁã¨Á´ãÊàêÊÆµÔºõËàíÁºìÊó∂ËÆ©Âè•Â≠êÂÉèÊ≤≥ÊµÅ‰∏ÄÊ†∑ËúøËúí„ÄÇÊ∞∏Ëøú‰∏çË¶ÅÂåÄÈÄüË°åÈ©∂„ÄÇ\n\n';
p+='‰∫∫Áâ©Â°ëÈÄ†ÔºöÈÄöËøá"ÂÅö‰ªÄ‰πà"Âíå"ÊÄé‰πàÂÅö"Êù•Â±ïÁé∞ÊÄßÊ†ºÔºåËÄå‰∏çÊòØÊóÅÁôΩËß£ËØ¥„ÄÇ‰∏Ä‰∏™‰∫∫Á¥ßÂº†Êó∂ÊòØÂí¨ÊåáÁî≤ËøòÊòØÂèçÂ§çÊï¥ÁêÜË°£È¢ÜÔºüÁîüÊ∞îÊó∂ÊòØÊëîÈó®ËøòÊòØÂºÇÂ∏∏Âπ≥ÈùôÔºüËøô‰∫õÁªÜËäÇÊØî‰ªª‰ΩïÂΩ¢ÂÆπËØçÈÉΩÊúâÂäõ„ÄÇÊØè‰∏™ËßíËâ≤ËØ¥ËØùÁöÑÊñπÂºè„ÄÅÁî®ËØç‰π†ÊÉØ„ÄÅÊÄùÁª¥ÈÄªËæëÈÉΩÂ∫îËØ•‰∏çÂêåÔºåÈÅÆ‰ΩèÂêçÂ≠ó‰πüËÉΩÂàÜËæ®ÊòØË∞ÅÂú®ËØ¥ËØù„ÄÇ\n\n';
p+='Âú∫ÊôØËê•ÈÄ†Ôºö‰∏çË¶ÅÂÖ®ÊôØÊèèÂÜôÔºåÈÄâÊã©‰∏Ä‰∏§‰∏™ÊúÄÊúâÊÑüÊüìÂäõÁöÑÊÑüÂÆòÁªÜËäÇÊ∑±ÂÖ•ÂàªÁîª„ÄÇÂÜô‰∏Ä‰∏™ÁÇéÁÉ≠ÁöÑ‰∏ãÂçàÔºå‰∏çË¶ÅËØ¥"ÁÉàÊó•ÁÇéÁÇé"ÔºåÂÜôÊüèÊ≤πË∑Ø‰∏äÊâ≠Êõ≤ÁöÑÁÉ≠Êµ™„ÄÅÂÜôÂêéËÉåÈªèÂú®Â°ëÊñôÊ§Ö‰∏äÊíïÂºÄÊó∂ÁöÑÂ£∞Èü≥„ÄÇËá≥Â∞ëËûçÂÖ•‰∏§ÁßçÊÑüÂÆòÔºàËßÜËßâ‰πãÂ§ñÁöÑÔºöÂê¨Ëßâ„ÄÅËß¶Ëßâ„ÄÅÂóÖËßâ„ÄÅÂë≥ËßâÔºâ„ÄÇ\n\n';
p+='ÊÉÖÊÑüË°®ËææÔºöË∂äÂº∫ÁÉàÁöÑÊÉÖÊÑüË∂äË¶ÅÂÖãÂà∂Âú∞ÂÜô„ÄÇ‰∏çË¶ÅÂÜô"Â•πÊÇ≤ÁóõÊ¨≤Áªù"ÔºåÂÜôÂ•πÊú∫Ê¢∞Âú∞Âè†ÁùÄ‰ªñÁöÑË°£ÊúçÔºåÂè†‰∫ÜÂèàÊãÜÔºåÊãÜ‰∫ÜÂèàÂè†„ÄÇËÆ©ËØªËÄÖËá™Â∑±ÂøÉÁñº„ÄÇ\n\n';
p+='ÂØπËØùÂÜô‰ΩúÔºöÁúü‰∫∫ËØ¥ËØù‰ºöÊâìÊñ≠„ÄÅ‰ºöË∑ëÈ¢ò„ÄÅ‰ºöÁ≠îÈùûÊâÄÈóÆ„ÄÅ‰ºöÊ¨≤Ë®ÄÂèàÊ≠¢„ÄÇÂØπËØùË¶ÅÊúâÊΩúÂè∞ËØç‚Äî‚ÄîÂò¥‰∏äËØ¥ÁöÑÂíåÂøÉÈáåÊÉ≥ÁöÑ‰∏ç‰∏ÄÊ†∑ÊâçÊúâÂº†Âäõ„ÄÇÈÅøÂÖçÊâÄÊúâËßíËâ≤ÈÉΩÁî®Âêå‰∏ÄÁßçËØ≠Ê∞îËØ¥ËØù„ÄÇ\n\n';
p+='ÊÉÖËäÇÊé®ËøõÔºöÊØè‰∏™Âú∫ÊôØÈÉΩË¶ÅÊúâ"ÂèòÂåñ"‚Äî‚ÄîËøõÂÖ•Âú∫ÊôØÊó∂ÁöÑÁä∂ÊÄÅÂíåÁ¶ªÂºÄÊó∂‰∏çÂêåÔºàÊÉÖÊÑü„ÄÅÂÖ≥Á≥ª„ÄÅ‰ø°ÊÅØ„ÄÅÂ§ÑÂ¢ÉÔºâ„ÄÇÂ¶ÇÊûú‰∏Ä‰∏™Âú∫ÊôØÂà†ÊéâÂêéÊïÖ‰∫ã‰∏çÂèóÂΩ±ÂìçÔºåÈÇ£ÂÆÉÂ∞±‰∏çËØ•Â≠òÂú®„ÄÇÂñÑÁî®Êó•Â∏∏‰∏≠ÁöÑÂèçÂ∏∏Êù•Âà∂ÈÄ†ÊÇ¨Âøµ„ÄÇ\n\n';

p+='„ÄêÁªùÂØπÈÅøÂÖçÁöÑÂÜôÊ≥ï„Äë\n';
p+='‰ª•‰∏ãÊòØ‰∏ö‰ΩôÂÜô‰ΩúÁöÑÂÖ∏ÂûãÊ†áÂøóÔºåÂá∫Áé∞‰ªª‰Ωï‰∏ÄÊù°ÈÉΩ‰ºö‰∏•ÈáçÈôç‰Ωé‰ΩúÂìÅË¥®ÈáèÔºö\n';
p+='- ‰∏áËÉΩÂâØËØçËΩ∞ÁÇ∏Ôºö"‰∏çÁ¶Å""ÁºìÁºì""Ê∑°Ê∑°""ÂæÆÂæÆ""ÈªòÈªò"‚Äî‚ÄîÂà†ÊéâÂÆÉ‰ª¨ÔºåÂè•Â≠êÂèçËÄåÊõ¥ÊúâÂäõ\n';
p+='- Á©∫Ê¥ûÂΩ¢ÂÆπËØçÔºö"Ê∑±ÈÇÉÁöÑÁúºÁú∏""ÂÆåÁæéÁöÑ‰æßËÑ∏""‰∏çÂèØÊñπÁâ©"‚Äî‚ÄîÁî®ÂÖ∑‰ΩìÁªÜËäÇÊõø‰ª£\n';
p+='- ËØ¥‰π¶ËÖîÔºö"ÊÆä‰∏çÁü•""Â≤ÇÊñô""Âç¥ËØ¥""ËØùËØ¥ÂõûÊù•"‚Äî‚ÄîËøô‰∏çÊòØËØÑ‰π¶\n';
p+='- ÊéíÊØîÂ†ÜÁ†åÔºöËøûÁª≠‰∏â‰∏™‰ª•‰∏äÁõ∏ÂêåÂè•Âºè‚Äî‚ÄîÂÖãÂà∂Ôºå‰∏Ä‰∏™Á≤æÂáÜÁöÑÊØîÂñªËÉúËøáÂçÅ‰∏™ÊéíÊØî\n';
p+='- ÂøÉÁêÜÊóÅÁôΩËøáÂ§öÔºöÂ§ßÊÆµÂÜÖÂøÉÁã¨ÁôΩËß£ÈáäÊÑüÂèó‚Äî‚ÄîÁî®Ë°å‰∏∫ÂíåÁªÜËäÇÂ±ïÁ§∫\n';
p+='- Â∑ßÂêàÊé®ËøõÔºö‰∏ªËßíÊÄªÊòØÊÅ∞Â•ΩÈÅáÂà∞ËΩ¨Êú∫‚Äî‚ÄîËÆ©Âõ∞Â¢ÉÁúüÂÆûÂú∞Âõ∞‰ΩèËßíËâ≤\n';
p+='- Ê®°ÊùøÂ§ñË≤åÔºö"ÂâëÁúâÊòüÁõÆ""ËÇ§Ëã•ÂáùËÑÇ""Ê®±Ê°ÉÂ∞èÂò¥"‚Äî‚ÄîÂÜôÂè™Â±û‰∫éËøô‰∏™ËßíËâ≤ÁöÑÁâπÂæÅ\n';
p+='- ÊØèÊÆµÈÉΩ‰ª•ËßíËâ≤ÂêçÂºÄÂ§¥‚Äî‚ÄîÂèòÂåñÂè•ÂºèÔºåÁî®Âä®‰Ωú„ÄÅÁéØÂ¢É„ÄÅÂØπËØùÂºÄÂ§¥\n';
p+='- ÊÉÖÁª™ËØçÁõ¥ÁªôÔºö"‰ªñÂæàÊÑ§ÊÄí""Â•πÂæàÂºÄÂøÉ"‚Äî‚ÄîÂ±ïÁ§∫ÊÑ§ÊÄíÂíåÂºÄÂøÉÁöÑÂÖ∑‰ΩìË°®Áé∞\n\n';

p+='„ÄêËæìÂá∫Ê†ºÂºè‚Äî‚Äî‰∏•Ê†ºÈÅµÂÆà„Äë\n';
p+='Á¨¨‰∏ÄË°åÔºöÂ∞èËØ¥Ê†áÈ¢òÔºàÁ∫ØÊñáÂ≠óÔºå‰∏çÂä†‰ªª‰ΩïÁ¨¶Âè∑ÂâçÁºÄÂêéÁºÄÔºâ\n';
p+='Á¨¨‰∫åË°åÔºöÁ©∫Ë°å\n';
p+='Á¨¨‰∏âË°åËµ∑ÔºöÊ≠£Êñá\n';
p+='- ÊØèÁ´†Ëá≥Â∞ë'+mW+'Â≠ó\n';
p+='- ÊÆµËêΩÈó¥Áî®‰∏Ä‰∏™Á©∫Ë°åÂàÜÈöî\n';
p+='- ÂØπËØùÁî®„Äå„ÄçÊàñ""Ê†áÊ≥®\n';
p+='- Á¶ÅÊ≠¢Âá∫Áé∞Ôºö‰ΩúËÄÖÊåâËØ≠„ÄÅÂàõ‰ΩúËØ¥Êòé„ÄÅÁ´†ËäÇÊ†áÊ≥®„ÄÅmarkdownÊ†ºÂºè„ÄÅ"‰ª•‰∏äÊòØ""Â∏åÊúõ‰Ω†ÂñúÊ¨¢"Á≠â\n';
p+='- ‰ªéÁ¨¨‰∏Ä‰∏™Â≠óÂà∞ÊúÄÂêé‰∏Ä‰∏™Â≠óÔºåÂÖ®ÈÉ®ÊòØÂ∞èËØ¥Ê≠£Êñá\n\n';

const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
p+='„Äê‰∫∫Áâ©ËÆæÂÆö‚Äî‚ÄîËûçÂÖ•ËÄåÈùûÁÖßÊê¨„Äë\n';
p+='‰ª•‰∏ãÊòØËßíËâ≤ÁöÑÂü∫Á°ÄËÆæÂÆöÔºåËØ∑Â∞ÜËøô‰∫õ‰ø°ÊÅØËá™ÁÑ∂Âú∞ËûçÂÖ•Âèô‰∫ã‰∏≠ÔºåÈÄöËøáÊÉÖËäÇÂíåÁªÜËäÇÈÄêÊ≠•Â±ïÁé∞ÔºåÁªùÂØπ‰∏çË¶ÅÂú®Ê≠£Êñá‰∏≠Áõ¥Êé•ÁΩóÂàóÊàñÂ§çËø∞ËÆæÂÆöÂéüÊñáÔºö\n';
validChars.forEach((c,i)=>{
p+='ËßíËâ≤'+(i+1)+'Ôºö';
if(c.name)p+=c.name;
if(c.traits&&c.traits.length>0)p+='„ÄêÊÄßÊ†ºÔºö'+c.traits.join('/')+'„Äë';
if(c.desc)p+='‚Äî‚Äî'+c.desc;
p+='\n';
p+='‚Üí ÂÜôËøô‰∏™ËßíËâ≤Êó∂ÔºåTAÁöÑË®ÄË°åÂøÖÈ°ª100%Á¨¶Âêà‰∏äËø∞ÊÄßÊ†ºÔºå‰∏çËÉΩÂá∫Áé∞ÁüõÁõæË°®Áé∞\n';
});
p+='\n';
}

if(wD){
p+='„Äê‰∏ñÁïåËßÇ‚Äî‚Äî‰Ωú‰∏∫ËÉåÊôØËÄåÈùûËØ¥Êòé‰π¶„Äë\n';
p+='‰ª•‰∏ã‰∏ñÁïåËßÇËÆæÂÆöÂ∫îËØ•ÂÉèÁ©∫Ê∞î‰∏ÄÊ†∑Ëá™ÁÑ∂Â≠òÂú®‰∫éÊïÖ‰∫ã‰∏≠ÔºåÈÄöËøáËßíËâ≤ÁöÑÊó•Â∏∏Ë°å‰∏∫„ÄÅÂØπËØù„ÄÅÊâÄËßÅÊâÄÈóªÊù•‰ΩìÁé∞Ôºå‰∏çË¶ÅÁî®ÊóÅÁôΩËß£ËØ¥ÁöÑÊñπÂºè‰ªãÁªç‰∏ñÁïåËßÇÔºö\n';
p+=wD+'\n\n';
}

const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD){
p+='„ÄêÊñáÈ£éË¶ÅÊ±Ç‚Äî‚ÄîÈìÅÂæã„Äë\n';
p+='‰ª•‰∏ãÊñáÈ£éË¶ÅÊ±ÇÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåÂøÖÈ°ªË¥ØÁ©øÊØè‰∏Ä‰∏™Âè•Â≠êÔºö\n';
p+=styleD+'\n\n';
p+='„ÄêÊñáÈ£éËá™Ê£ÄÊ∏ÖÂçï„Äë\n';
p+='ÂÜôÂÆåÊØè‰∏ÄÊÆµÂêéÔºåËØ∑Âú®ÂøÉ‰∏≠Á°ÆËÆ§Ôºö\n';
p+='‚ñ° ËøôÊÆµËØùÁ¨¶Âêà‰∏äËø∞ÊñáÈ£éÂêóÔºü\n';
p+='‚ñ° ÊúâÊ≤°ÊúâÂá∫Áé∞"‰∏çÁ¶Å""ÁºìÁºì""Ê∑°Ê∑°"Á≠â‰∏áËÉΩÂâØËØçÔºü\n';
p+='‚ñ° ÊúâÊ≤°ÊúâÁ©∫Ê¥ûÁöÑÂΩ¢ÂÆπËØçÂ†ÜÁ†åÔºü\n';
p+='‚ñ° ÂØπËØùÊòØÂê¶Ëá™ÁÑ∂ÔºåÂÉèÁúü‰∫∫Âú®ËØ¥ËØùÔºü\n';
p+='‚ñ° ÊòØÂê¶ÊúâÂÖ∑‰ΩìÁöÑÊÑüÂÆòÁªÜËäÇÔºü\n';
p+='Â¶ÇÊûú‰ªª‰Ωï‰∏ÄÈ°π‰∏çÈÄöËøáÔºåËØ∑ÈáçÂÜôËØ•ÊÆµ„ÄÇ\n\n';
}

const ruleD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||curRule||'').trim();
if(ruleD){
p+='„ÄêÂàõ‰ΩúËßÑÂàô‚Äî‚ÄîÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà„Äë\n';
p+='‰ª•‰∏ãÊòØ‰ΩúËÄÖËÆæÂÆöÁöÑÂº∫Âà∂ËßÑÂàôÔºåËøùÂèç‰ªª‰Ωï‰∏ÄÊù°ÈÉΩÊòØ‰∏çÂèØÊé•ÂèóÁöÑÔºö\n';
p+=ruleD+'\n\n';
}

const banD=(document.getElementById('banWordsInput')&&document.getElementById('banWordsInput').value||banWords||'').trim();
if(banD){
const words=banD.split('\n').map(w=>w.trim()).filter(w=>w);
if(words.length>0){
p+='„ÄêÁ¶ÅÁî®ËØç‚Äî‚ÄîÁªùÂØπ‰∏çËÉΩÂá∫Áé∞„Äë\n';
p+='‰ª•‰∏ãËØçÊ±áÁ¶ÅÊ≠¢Âú®ÊñáÁ´†‰∏≠Âá∫Áé∞ÔºåÂåÖÊã¨Âêå‰πâËØçÂíåÂèò‰Ωì‰πüË¶ÅÈÅøÂÖçÔºö\n';
p+=words.join('„ÄÅ')+'\n\n';
}
}

return p;
}

// ==================== STREAM API CALL ====================
async function callAPIStream(messages,onChunk,onDone,onError){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){
showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');
if(onError)onError('Êú™ÈÖçÁΩÆAPI');
return;
}
if(!cfg.url.startsWith('http')){
showToast('APIÂú∞ÂùÄÊ†ºÂºè‰∏çÊ≠£Á°Æ');
if(onError)onError('APIÂú∞ÂùÄÊ†ºÂºèÈîôËØØ');
return;
}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';

abortCtrl=new AbortController();

try{
// ËÆæÁΩÆË∂ÖÊó∂
const timeoutId=setTimeout(()=>{
if(abortCtrl)abortCtrl.abort();
},120000);// 2ÂàÜÈíüË∂ÖÊó∂

const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({
model:cfg.model,messages,temperature:cfg.temp,
max_tokens:cfg.maxTokens,stream:true
}),
signal:abortCtrl.signal
}).finally(()=>clearTimeout(timeoutId));

if(!resp.ok){
const errText=await resp.text();
onError('APIÈîôËØØ('+resp.status+'): '+errText.substring(0,200));
return;
}

const reader=resp.body.getReader();
const decoder=new TextDecoder();
let buffer='';
let fullText='';

while(true){
const{done,value}=await reader.read();
if(done)break;
buffer+=decoder.decode(value,{stream:true});

const lines=buffer.split('\n');
buffer=lines.pop()||'';

for(const line of lines){
const trimmed=line.trim();
if(!trimmed||trimmed==='data: [DONE]')continue;
if(!trimmed.startsWith('data: '))continue;
try{
const json=JSON.parse(trimmed.slice(6));
const delta=json.choices&&json.choices[0]&&json.choices[0].delta;
if(delta&&delta.content){
fullText+=delta.content;
onChunk(fullText,delta.content);
}
}catch{}
}
}
onDone(fullText);
}catch(err){
if(err.name==='AbortError'){onDone(null);return;}
onError('ËØ∑Ê±ÇÂ§±Ë¥•: '+err.message);
}finally{abortCtrl=null;}
}

// Fallback: non-stream API call
async function callAPINonStream(messages){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return null;}
saveCurSettings();
const baseUrl=cfg.url.replace(/\/+$/,'');
const endpoint=baseUrl+'/chat/completions';
try{
const resp=await fetch(endpoint,{
method:'POST',
headers:{'Content-Type':'application/json','Authorization':'Bearer '+cfg.key},
body:JSON.stringify({model:cfg.model,messages,temperature:cfg.temp,max_tokens:cfg.maxTokens})
});
if(!resp.ok){const e=await resp.text();throw new Error('APIÈîôËØØ('+resp.status+'): '+e.substring(0,200));}
const data=await resp.json();
if(!data.choices||!data.choices[0]||!data.choices[0].message)throw new Error('APIËøîÂõûÊ†ºÂºèÂºÇÂ∏∏');
return data.choices[0].message.content;
}catch(err){showToast('ËØ∑Ê±ÇÂ§±Ë¥•: '+err.message,3000);return null;}
}

// ==================== GENERATE ARTICLE ====================
function handleGenBtn(){
if(isGen&&abortCtrl){
abortCtrl.abort();
isGen=false;
const btn=document.getElementById('btnGen');
btn.disabled=false;btn.textContent='ÁîüÊàê';
showToast('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
return;
}
generateArticle();
}
// Âø´ÈÄüË¥®ÈáèÊ£ÄÊü•
function quickQualityCheck(text){
const issues=[];
if(!text||text.length<100)return issues;
// Ê£ÄÊü•‰∏áËÉΩÂâØËØç
const badAdverbs=['‰∏çÁ¶Å','ÁºìÁºì','Ê∑°Ê∑°','ÂæÆÂæÆ','ÈªòÈªò','ÈùôÈùô','ËΩªËΩª'];
badAdverbs.forEach(w=>{
const count=(text.match(new RegExp(w,'g'))||[]).length;
if(count>=3)issues.push('„Äå'+w+'„ÄçÂá∫Áé∞'+count+'Ê¨°ÔºåÂª∫ËÆÆÂáèÂ∞ë');
});
// Ê£ÄÊü•ÈáçÂ§çÂè•Âºè
const sentences=text.split(/[„ÄÇÔºÅÔºü]/);
const starts={};
sentences.forEach(s=>{
const start=s.trim().substring(0,4);
if(start.length>=2){
starts[start]=(starts[start]||0)+1;
}
});
Object.keys(starts).forEach(k=>{
if(starts[k]>=4)issues.push('Âè•È¶ñ„Äå'+k+'„ÄçÈáçÂ§ç'+starts[k]+'Ê¨°');
});
// Ê£ÄÊü•Á©∫Ê¥ûÂΩ¢ÂÆπËØç
const emptyAdj=['Ê∑±ÈÇÉÁöÑÁúºÁú∏','ÂÆåÁæéÁöÑ','ÁªùÁæéÁöÑ','Êó†‰∏é‰º¶ÊØî','‰∏çÂèØÊñπÁâ©'];
emptyAdj.forEach(w=>{
if(text.includes(w))issues.push('ÂèëÁé∞Á©∫Ê¥ûÂΩ¢ÂÆπ„Äå'+w+'„Äç');
});
// Ê£ÄÊü•ÂØπËØùÂç†ÊØîÔºàÂØπËØùÂ§™Â∞ëÂèØËÉΩÁº∫‰πè‰∫íÂä®Ôºâ
const dialogCount=(text.match(/[„Äå""][^„Äå""„Äç]+[„Äç""]/g)||[]).length;
const paraCount=text.split(/\n\n/).length;
if(paraCount>5&&dialogCount<2)issues.push('ÂØπËØùËæÉÂ∞ëÔºåÂèØËÉΩÁº∫‰πè‰∫∫Áâ©‰∫íÂä®');
return issues;
}
async function generateArticle(){
if(isGen){
showToast('Ê≠£Âú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂÄô...');
return;
}
const searchText=(document.getElementById('searchInput').value||'').trim();
const activeTags=selTags.join(' ');
const type=curType;

let userMsg='';
if(type==='long'){
userMsg='ËØ∑Âàõ‰Ωú‰∏ÄÁØáÈïøÁØáÂ∞èËØ¥ÁöÑÁ¨¨‰∏ÄÁ´†„ÄÇ\n\n';
userMsg+='Á¨¨‰∏ÄÁ´†ÁöÑ‰ΩøÂëΩÔºö\n';
userMsg+='- Áî®‰∏Ä‰∏™Âºï‰∫∫ÂÖ•ËÉúÁöÑÂºÄÂú∫Êäì‰ΩèËØªËÄÖÔºàÂèØ‰ª•‰ªé‰∏Ä‰∏™ÊÇ¨Âøµ„ÄÅ‰∏Ä‰∏™ÂèçÂ∏∏ÁöÑÊó•Â∏∏„ÄÅ‰∏Ä‰∏™ÂÖ≥ÈîÆÊó∂ÂàªÂàáÂÖ•Ôºâ\n';
userMsg+='- Ëá™ÁÑ∂Âú∞Âª∫Á´ãÊïÖ‰∫ã‰∏ñÁïåÂíå‰∏ªË¶Å‰∫∫Áâ©ÔºàÈÄöËøá‰∫ã‰ª∂Â±ïÁé∞Ôºå‰∏çË¶ÅÁî®ËØ¥ÊòéÊñáÁöÑÊñπÂºè‰ªãÁªçÔºâ\n';
userMsg+='- Âüã‰∏ãËá≥Â∞ë‰∏Ä‰∏™ËÆ©ËØªËÄÖÂ•ΩÂ•áÁöÑ‰ºèÁ¨î\n';
userMsg+='- ÁªìÂ∞æÂà∂ÈÄ†‰∏Ä‰∏™ËΩ¨ÊäòÊàñÊÇ¨ÂøµÔºåËÆ©‰∫∫Ëø´‰∏çÂèäÂæÖÊÉ≥ÁúãÁ¨¨‰∫åÁ´†\n';
}else{
userMsg='ËØ∑Âàõ‰Ωú‰∏ÄÁØáÂÆåÊï¥ÁöÑÁü≠ÁØáÂ∞èËØ¥„ÄÇ\n\n';
userMsg+='Áü≠ÁØáÁöÑÁ≤æÈ´ìÂú®‰∫é"‰ª•Â∞èËßÅÂ§ß"Ôºö\n';
userMsg+='- ËÅöÁÑ¶‰∏Ä‰∏™Ê†∏ÂøÉ‰∫ã‰ª∂Êàñ‰∏Ä‰∏™ÂÜ≥ÂÆöÊÄßÁöÑÁû¨Èó¥\n';
userMsg+='- ‰∫∫Áâ©‰∏çÈúÄË¶ÅÂ§öÔºå‰ΩÜÊØè‰∏™ÈÉΩË¶ÅÈ≤úÊ¥ª\n';
userMsg+='- ÁªìÂ∞æË¶ÅÊúâÂõûÂë≥‚Äî‚ÄîÂèØ‰ª•ÊòØÂèçËΩ¨„ÄÅÂèØ‰ª•ÊòØ‰ΩôÈüµ„ÄÅÂèØ‰ª•ÊòØÂºÄÊîæÂºèÁöÑÁïôÁôΩ\n';
userMsg+='- Â•ΩÁöÑÁü≠ÁØáËØªÂÆåÂêé‰ºöËÆ©‰∫∫Ê≤âÈªòÂá†Áßí\n';
}
if(searchText)userMsg+='\nÊïÖ‰∫ãÊñπÂêëÔºö'+searchText+'\nÔºàËøôÊòØÁÅµÊÑüÊñπÂêëÔºå‰∏çÊòØÂøÖÈ°ªÁÖßÊê¨ÁöÑÂ§ßÁ∫≤ÔºåËØ∑Âú®Ê≠§Âü∫Á°Ä‰∏äËá™Áî±ÂèëÊå•ÂàõÊÑèÔºâ';
if(activeTags)userMsg+='\nÊ∞õÂõ¥Ê†áÁ≠æÔºö'+activeTags;
if(!searchText&&!activeTags)userMsg+='\nËØ∑Ê†πÊçÆ‰∫∫ËÆæÂíå‰∏ñÁïåËßÇËá™Áî±ÂèëÊå•ÔºåÂàõ‰Ωú‰∏Ä‰∏™ËÆ©‰Ω†Ëá™Â∑±‰πüÊÉ≥ÁªßÁª≠ËØª‰∏ãÂéªÁöÑÊïÖ‰∫ã„ÄÇ';
userMsg+='\n\n„ÄêÊ†ºÂºè„ÄëÁ¨¨‰∏ÄË°åÂÜôÊ†áÈ¢òÔºàÁ∫ØÊñáÂ≠óÔºâÔºåÁ©∫‰∏ÄË°åÂêéÁõ¥Êé•ÂÜôÊ≠£Êñá„ÄÇÂè™ËæìÂá∫Ê†áÈ¢òÂíåÊ≠£ÊñáÔºåÊó†ÂÖ∂‰ªñÂÜÖÂÆπ„ÄÇ';

isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='‚èπ ÂÅúÊ≠¢';btn.disabled=false;

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const list=document.getElementById('articleList');

if(!useStream){
// ÈùûÊµÅÂºèÊ®°Âºè
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='ÁîüÊàê';
if(!result){renderArticles();return;}
let title2='',content2=result;
const lines2=result.split(/\n/);
for(let i=0;i<Math.min(5,lines2.length);i++){
const l=lines2[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('„ÄÄ')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('„Äå')){
title2=l.replace(/^[#*„Ää„Äå„Äê\s:ÔºöÊ†áÈ¢ò]+/,'').replace(/[„Äã„Äç„Äë\s]+$/,'').trim();
content2=lines2.slice(i+1).join('\n').trim();
break;
}
}
if(!title2||title2.length>35)title2=(searchText||activeTags||'ÈöèÊú∫ÊïÖ‰∫ã').substring(0,20);
const article2={
id:uid(),title:title2,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content2]:undefined,
content:type==='short'?content2:undefined,
prompt:searchText
};
ws.unshift(article2);sv(K.ws,ws);
renderArticles();showToast('Âàõ‰ΩúÂÆåÊàêÔºÅ‚ú®');
return;
}

// ÊµÅÂºèÊ®°Âºè
const streamCard=document.createElement('div');
streamCard.className='stream-card';
streamCard.id='streamCard';
const startTime=Date.now();
streamCard.innerHTML=
'<div class="stream-title"><span class="ldots"><span></span><span></span><span></span></span> Ê≠£Âú®Âàõ‰Ωú‰∏≠...</div>'+
'<div class="stream-body" id="streamBody"></div>'+
'<div class="stream-info"><span id="streamWc">0 Â≠ó</span><span id="streamTime">0s</span></div>';
list.insertBefore(streamCard,list.firstChild);

let timeInterval=setInterval(()=>{
const el=document.getElementById('streamTime');
if(el)el.textContent=((Date.now()-startTime)/1000).toFixed(0)+'s';
},1000);

await callAPIStream(messages,
(fullText,chunk)=>{
const body=document.getElementById('streamBody');
if(body)body.textContent=fullText;
const wc=document.getElementById('streamWc');
if(wc)wc.textContent=countWords(fullText)+' Â≠ó';
if(body)body.scrollTop=body.scrollHeight;
},
(fullText)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='ÁîüÊàê';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
if(!fullText){renderArticles();return;}
let title='',content=fullText;
const lines=fullText.split(/\n/);
let titleLine='';
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<40&&!l.startsWith('„ÄÄ')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('„Äå')){
titleLine=l;
content=lines.slice(i+1).join('\n').trim();
break;
}
}
title=titleLine.replace(/^[#*„Ää„Äå„Äê\s:ÔºöÊ†áÈ¢ò]+/,'').replace(/[„Äã„Äç„Äë\s]+$/,'').trim();
if(!title||title.length>35)title=(searchText||activeTags||'ÈöèÊú∫ÊïÖ‰∫ã').substring(0,20);
const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);
sv(K.ws,ws);
renderArticles();
// Ë¥®ÈáèÂø´ÈÄüÊ£ÄÊü•
const qualityIssues=quickQualityCheck(content);
if(qualityIssues.length>0){
showToast('Âàõ‰ΩúÂÆåÊàêÔºÅ‚ö†Ô∏è Ê£ÄÊµãÂà∞'+qualityIssues.length+'‰∏™ÊΩúÂú®ÈóÆÈ¢ò',3000);
console.log('Ë¥®ÈáèÈóÆÈ¢òÔºö',qualityIssues);
}else{
showToast('Âàõ‰ΩúÂÆåÊàêÔºÅ‚ú®');
}
},
(errMsg)=>{
clearInterval(timeInterval);
isGen=false;btn.disabled=false;btn.textContent='ÁîüÊàê';
const sc=document.getElementById('streamCard');
if(sc)sc.remove();
showToast('ÊµÅÂºèËæìÂá∫Â§±Ë¥•ÔºåÂ∞ùËØïÊôÆÈÄöÊ®°Âºè...',2000);
setTimeout(()=>generateNonStream(messages,type,searchText),500);
}
);
}

// Non-stream fallback
async function generateNonStream(messages,type,searchText){
if(isGen)return;
isGen=true;
const btn=document.getElementById('btnGen');
btn.disabled=true;
btn.innerHTML='<span class="ldots"><span></span><span></span><span></span></span>';

const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='ÁîüÊàê';
if(!result)return;

let title='',content=result;
const lines=result.split(/\n/);
for(let i=0;i<Math.min(5,lines.length);i++){
const l=lines[i].trim();
if(!l)continue;
if(l.length>0&&l.length<35&&!l.startsWith('„ÄÄ')&&!l.startsWith('"')&&!l.startsWith('"')&&!l.startsWith('„Äå')&&!l.startsWith('‚Äî‚Äî')&&!l.startsWith('‚Ä¶')&&!l.includes('„ÄÇ')&&!l.includes('Ôºå')){
title=l.replace(/^[#*„Ää„Äå„Äê\s:ÔºöÊ†áÈ¢ò]+/,'').replace(/[„Äã„Äç„Äë\s]+$/,'').trim();
content=lines.slice(i+1).join('\n').trim();
break;
}
}
if(!title||title.length>35)title=(searchText||'ÈöèÊú∫ÊïÖ‰∫ã').substring(0,20);

const article={
id:uid(),title,type,tags:[...selTags],
createdAt:new Date().toISOString(),
chapters:type==='long'?[content]:undefined,
content:type==='short'?content:undefined,
prompt:searchText
};
ws.unshift(article);sv(K.ws,ws);
renderArticles();showToast('Âàõ‰ΩúÂÆåÊàêÔºÅ‚ú®');
}

// ==================== READING ====================
function openReading(article){
// Always use the latest version: check workshop first, then collections
let latestArticle=ws.find(a=>a.id===article.id);
if(!latestArticle){
if(article.type==='long')latestArticle=cols.books.find(b=>b.id===article.id);
else latestArticle=cols.shorts.find(s=>s.id===article.id);
}
if(!latestArticle)latestArticle=article;
if(!latestArticle){showToast('ÊñáÁ´†Êï∞ÊçÆ‰∏¢Â§±');return;}

curRd=latestArticle;curCh=0;

document.getElementById('rdTitle').textContent=curRd.title;

const totalWords=getTotalWords(curRd);
const meta=document.getElementById('rdMeta');
meta.innerHTML=
'<span>'+(curRd.type==='long'?'üìñ ÈïøÁØáËøûËΩΩ':'üìÑ Áü≠ÁØá')+'</span>'+
'<span>üïê '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
(curRd.chapters?'<span>ÂÖ± '+curRd.chapters.length+' Á´†</span>':'')+
'<span>'+totalWords+' Â≠ó</span>';

renderChContent();
updateRdLikeBtn();

const liked=isLiked(curRd);
const cw=document.getElementById('contWrap');
if(curRd.type==='long'){
cw.style.display='block';
const btnCont=document.getElementById('btnCont');
if(liked){
btnCont.disabled=false;
btnCont.textContent='üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†';
}else{
btnCont.disabled=true;
btnCont.textContent='‚ù§Ô∏è ËØ∑ÂÖàÊî∂ËóèÂêéÊâçËÉΩÁª≠ÂÜô';
}
}else{
cw.style.display='none';
}

const dirWrap=document.getElementById('dirInputWrap');
dirWrap.style.display=(curRd.type==='long')?'flex':'none';

const undoBtn=document.getElementById('btnUndo');
undoBtn.style.display=(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1)?'inline-block':'none';

// Reading bg
const bg=document.getElementById('rdBg');
if(ap.rdBg){
bg.style.backgroundImage='url('+ap.rdBg+')';
bg.style.display='block';
}else{bg.style.display='none';}

// Apply reading font settings
setRdFont(ap.rdFontSize||15);
setRdLine(ap.rdLineHeight||2);

document.getElementById('rdModal').classList.add('show');
document.getElementById('rdModal').scrollTop=0;
updateNoteBtn();
}

function getTotalWords(article){
let total=0;
if(article.chapters&&Array.isArray(article.chapters)){
article.chapters.forEach(ch=>total+=countWords(ch||''));
}else if(article.content){
total=countWords(article.content);
}
return total;
}

function renderChContent(){
if(!curRd)return;
const nav=document.getElementById('chNav');
if(curRd.type==='long'&&curRd.chapters&&curRd.chapters.length>1){
nav.innerHTML='';
// ÂΩìÂâçÁ´†ËäÇÊåáÁ§∫ + ÊâìÂºÄÁõÆÂΩïÊåâÈíÆ
const info=document.createElement('button');
info.className='ch-btn act';
info.textContent='Á¨¨'+(curCh+1)+'Á´† / ÂÖ±'+curRd.chapters.length+'Á´†';
info.onclick=()=>openChapterList();
nav.appendChild(info);

if(curCh>0){
const prev=document.createElement('button');
prev.className='ch-btn';prev.textContent='‚óÄ ‰∏ä‰∏ÄÁ´†';
prev.onclick=()=>{curCh--;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(prev);
}
if(curCh<curRd.chapters.length-1){
const next=document.createElement('button');
next.className='ch-btn';next.textContent='‰∏ã‰∏ÄÁ´† ‚ñ∂';
next.onclick=()=>{curCh++;renderChContent();document.getElementById('rdModal').scrollTop=0;};
nav.appendChild(next);
}

const listBtn=document.createElement('button');
listBtn.className='ch-btn';listBtn.textContent='üìë ÁõÆÂΩï';
listBtn.onclick=()=>openChapterList();
nav.appendChild(listBtn);
}else{nav.innerHTML='';}

const cdiv=document.getElementById('rdContent');
let text='';
if(curRd.type==='long'&&curRd.chapters)text=curRd.chapters[curCh]||'';
else text=curRd.content||'';

const paras=text.split(/\n+/).filter(p=>p.trim());
cdiv.innerHTML=paras.map((p,pi)=>'<p data-pi="'+pi+'" class="rd-para">'+esc(p.trim())+'</p>').join(''); // ÁªëÂÆöÈïøÊåâÂºïÁî® cdiv.querySelectorAll('.rd-para').forEach(el=>{ let lpTimer=null; let startX=0,startY=0,moved=false; el.addEventListener('touchstart',function(e){ moved=false; if(e.touches.length>0){startX=e.touches[0].clientX;startY=e.touches[0].clientY;} lpTimer=setTimeout(()=>{ if(moved)return; e.preventDefault(); const text=el.textContent.trim(); if(!text)return; // ÈúáÂä®ÂèçÈ¶àÔºàÂ¶ÇÊûúÊâãÊú∫ÊîØÊåÅÔºâ if(navigator.vibrate)navigator.vibrate(30); el.style.background='rgba(108,92,231,.18)'; el.style.boxShadow='inset 0 0 0 1px var(--accent)'; setTimeout(()=>{el.style.background='';el.style.boxShadow='';},1000); showQuoteNote(text); },500); },{passive:false}); el.addEventListener('touchmove',function(e){ if(e.touches.length>0){ const dx=Math.abs(e.touches[0].clientX-startX); const dy=Math.abs(e.touches[0].clientY-startY); if(dx>8||dy>8){moved=true;clearTimeout(lpTimer);} } },{passive:true}); el.addEventListener('touchend',()=>{clearTimeout(lpTimer);}); el.addEventListener('touchcancel',()=>{clearTimeout(lpTimer);}); }); updateNoteBtn();
}
function showQuoteNote(quoteText){
if(!curRd)return;
const short=quoteText.length>40?quoteText.substring(0,40)+'...':quoteText;
// Áõ¥Êé•ÊâìÂºÄÁ¨îËÆ∞Èù¢ÊùøÂπ∂È¢ÑÂ°´ÂºïÁî®
openNotePanel();
setTimeout(()=>{
const inp=document.getElementById('noteInput');
inp.value='„Äå'+short+'„Äç\n‚Äî‚ÄîÊàëÁöÑÊÉ≥Ê≥ïÔºö';
inp.style.height='38px';
inp.style.height=Math.min(inp.scrollHeight,100)+'px';
inp.focus();
// ÂÖâÊ†áÊîæÂà∞Êú´Â∞æ
inp.setSelectionRange(inp.value.length,inp.value.length);
},350);
}
function updateRdLikeBtn(){
const btn=document.getElementById('rdLikeBtn');
btn.innerHTML=isLiked(curRd)?'‚ù§Ô∏è':'‚ô°';
}

function toggleCurrentLike(){
if(!curRd)return;
toggleLike(curRd.id);
updateRdLikeBtn();
const liked=isLiked(curRd);
const cw2=document.getElementById('contWrap');
const dw2=document.getElementById('dirInputWrap');
const bc2=document.getElementById('btnCont');
if(curRd.type==='long'){
cw2.style.display='block';
dw2.style.display='flex';
if(liked){bc2.disabled=false;bc2.textContent='üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†';}
else{bc2.disabled=true;bc2.textContent='‚ù§Ô∏è ËØ∑ÂÖàÊî∂ËóèÂêéÊâçËÉΩÁª≠ÂÜô';}
}else{cw2.style.display='none';dw2.style.display='none';}
}
function openChapterList(){
if(!curRd||!curRd.chapters)return;
document.getElementById('chPanelTitle').textContent='„Äå'+curRd.title+'„ÄçÁõÆÂΩï';
document.getElementById('chPanelInfo').textContent='ÂÖ± '+curRd.chapters.length+' Á´† ¬∑ '+getTotalWords(curRd)+' Â≠ó';
const list=document.getElementById('chPanelList');
list.innerHTML='';
curRd.chapters.forEach((_,i)=>{
const wc=countWords(curRd.chapters[i]);
const item=document.createElement('div');
item.className='ch-item'+(i===curCh?' act':'');
const chNotes=getArticleNotes(curRd.id).filter(n=>n.ch===i); const noteTag=chNotes.length>0?' ¬∑ ‚úèÔ∏è'+chNotes.length:''; item.innerHTML='<span class="ch-item-num" style="font-size:14px;font-weight:700;width:60px;flex-shrink:0">Á¨¨'+(i+1)+'Á´†</span><span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc((curRd.chapters[i]||'').replace(/\n/g,' ').substring(0,30))+'</span><span class="ch-item-wc" style="flex-shrink:0;font-size:10px;opacity:.7">'+wc+'Â≠ó'+noteTag+'</span>';
item.onclick=()=>{curCh=i;renderChContent();closeChapterList();document.getElementById('rdModal').scrollTop=0;};
list.appendChild(item);
});
document.getElementById('chOv').classList.add('show');
}
// ==================== NOTES ====================
function getArticleNotes(articleId){
if(!articleId)return[];
return ld('bj_notes_'+articleId,[]);
}
function saveArticleNotes(articleId,notes){
sv('bj_notes_'+articleId,notes);
}
function openNotePanel(){
if(!curRd)return;
const chLabel=curRd.type==='long'?'Á¨¨'+(curCh+1)+'Á´†':'ÂÖ®Êñá';
document.getElementById('noteChInfo').textContent=chLabel+'ÁöÑÁ¨îËÆ∞';
renderNotes();
document.getElementById('noteOv').classList.add('show');
setTimeout(()=>{document.getElementById('noteInput').focus();},300);
}
function closeNotePanel(){
document.getElementById('noteOv').classList.remove('show');
}
function renderNotes(){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
const list=document.getElementById('noteList');
if(chNotes.length===0){
list.innerHTML='<div class="note-empty">ËøòÊ≤°ÊúâÁ¨îËÆ∞<br>Âú®‰∏ãÊñπËæìÂÖ•Ê°ÜÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ïÂêß</div>';
return;
}
list.innerHTML='';
chNotes.forEach((n,idx)=>{
const realIdx=notes.indexOf(n);
const item=document.createElement('div');
item.className='note-item';
const time=n.time?new Date(n.time).toLocaleString():'';
item.innerHTML=
'<div class="note-item-text">'+esc(n.text)+'</div>'+
'<div class="note-item-ft">'+
'<span class="note-item-time">'+time+'</span>'+
'<button class="note-item-del" onclick="deleteNote('+realIdx+')">Âà†Èô§</button>'+
'</div>';
list.appendChild(item);
});
list.scrollTop=list.scrollHeight;
}
function addNote(){
if(!curRd)return;
const input=document.getElementById('noteInput');
const text=(input.value||'').trim();
if(!text){showToast('ËØ∑ËæìÂÖ•Á¨îËÆ∞ÂÜÖÂÆπ');return;}
const notes=getArticleNotes(curRd.id);
notes.push({
ch:curCh,
text:text,
time:new Date().toISOString()
});
saveArticleNotes(curRd.id,notes);
input.value='';
input.style.height='38px';
renderNotes();
updateNoteBtn();
showToast('Á¨îËÆ∞Â∑≤‰øùÂ≠ò ‚úèÔ∏è');
}
function deleteNote(realIdx){
if(!curRd)return;
const notes=getArticleNotes(curRd.id);
if(realIdx<0||realIdx>=notes.length)return;
notes.splice(realIdx,1);
saveArticleNotes(curRd.id,notes);
renderNotes();
updateNoteBtn();
showToast('Á¨îËÆ∞Â∑≤Âà†Èô§');
}
function updateNoteBtn(){
if(!curRd)return;
const btn=document.getElementById('rdNoteBtn');
if(!btn)return;
const notes=getArticleNotes(curRd.id);
const chNotes=notes.filter(n=>n.ch===curCh);
if(chNotes.length>0){
btn.innerHTML='üìù<span class="note-dot"></span>';
btn.title='Êú¨Á´†Êúâ'+chNotes.length+'Êù°Á¨îËÆ∞';
}else{
btn.innerHTML='üìù';
btn.title='Ê∑ªÂä†Á¨îËÆ∞';
}
}
function getNoteCount(articleId){
const notes=ld('bj_notes_'+articleId,[]);
return notes.length;
}
function closeChapterList(){
document.getElementById('chOv').classList.remove('show');
}
function closeReading(){
if(abortCtrl){abortCtrl.abort();abortCtrl=null;isGen=false;}
if(isFS)toggleFullscreen();
document.getElementById('rdModal').classList.remove('show');
document.getElementById('rdSettingsPanel').classList.remove('show');
closeNotePanel();
closeChapterList();
curRd=null;
curCh=0;
renderArticles();
renderCollections();
}

function toggleFullscreen(){
const modal=document.getElementById('rdModal');
const btn=document.getElementById('btnFS');
const nav=document.getElementById('bnav');
isFS=!isFS;
if(isFS){
modal.classList.add('fs');nav.classList.add('hide');
btn.textContent='‚ä°';
if(document.documentElement.requestFullscreen)document.documentElement.requestFullscreen().catch(()=>{});
}else{
modal.classList.remove('fs');nav.classList.remove('hide');
btn.textContent='‚õ∂';
if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}
}

function toggleRdSettings(){
document.getElementById('rdSettingsPanel').classList.toggle('show');
}

function setRdFont(v){
v=parseInt(v);
document.getElementById('rdContent').style.setProperty('--rd-fontsize',v+'px');
document.getElementById('rdFontVal').textContent=v;
ap.rdFontSize=v;sv(K.ap,ap);
// Sync range
const range=document.querySelector('#rdSettingsPanel input[type=range]');
if(range&&range.oninput.toString().includes('setRdFont'))range.value=v;
}

function setRdLine(v){
v=parseFloat(v);
document.getElementById('rdContent').style.setProperty('--rd-lineheight',v);
document.getElementById('rdLineVal').textContent=v.toFixed(1);
ap.rdLineHeight=v;sv(K.ap,ap);
}
// ÊèêÂèñÁ´†ËäÇÂÖ≥ÈîÆÁÇπ
function extractKeyPoints(chapterText,chNum){
if(!chapterText)return 'ÔºàÁ©∫Á´†ËäÇÔºâ';
const text=chapterText.replace(/\n+/g,' ').trim();
// ÊèêÂèñÂØπËØùÔºàÈÄöÂ∏∏ÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÔºâ
const dialogues=text.match(/[„Äå""]([^„Äå""„Äç]+)[„Äç""]/g)||[];
const keyDialogue=dialogues.length>0?dialogues[Math.floor(dialogues.length/2)]:'';
// ÊèêÂèñÂºÄÂ§¥ÂíåÁªìÂ∞æÁöÑÂÖ≥ÈîÆÂè•
const sentences=text.split(/[„ÄÇÔºÅÔºü]/);
const opening=sentences[0]||'';
const ending=sentences[sentences.length-2]||'';
let summary=opening.substring(0,40);
if(keyDialogue)summary+='‚Ä¶'+keyDialogue.substring(0,30);
summary+='‚Ä¶'+ending.substring(0,40);
return summary;
}

// ÊèêÂèñÊïÖ‰∫ãÁä∂ÊÄÅÔºà‰ºèÁ¨î„ÄÅÊÇ¨ÂøµÁ≠âÔºâ
function extractStoryState(article){
if(!article||!article.chapters||article.chapters.length<2)return '';
const allText=article.chapters.join('\n');
const states=[];
// Ê£ÄÊµãÊú™Ëß£ÂÜ≥ÁöÑÈóÆÈ¢ò/ÊÇ¨ÂøµÔºà‰ª•ÈóÆÂè∑ÁªìÂ∞æÁöÑÂè•Â≠êÔºâ
const questions=allText.match(/[^„ÄÇÔºÅÔºü]*[Ôºü?]/g)||[];
if(questions.length>0){
const lastQ=questions[questions.length-1].trim();
if(lastQ.length>5&&lastQ.length<50)states.push('ÂæÖËß£ÊÇ¨ÂøµÔºö'+lastQ);
}
// Ê£ÄÊµãÊÉÖÊÑüÁä∂ÊÄÅËØç
const emotionWords=['ÊÑ§ÊÄí','ÊÇ≤‰º§','ÂñúÊÇ¶','ÊÅêÊÉß','ÊúüÂæÖ','Â§±Êúõ','ÈúáÊÉä','ÊÄÄÁñë'];
const lastCh=article.chapters[article.chapters.length-1]||'';
emotionWords.forEach(w=>{
if(lastCh.includes(w))states.push('ÊÉÖÁª™Âü∫Ë∞ÉÔºö'+w);
});
return states.slice(0,3).join('Ôºõ');
}

// Ëé∑Âèñ‰∫∫Áâ©ÂΩìÂâçÁä∂ÊÄÅ
function getCharacterStates(article){
if(!article||!article.chapters)return '';
const lastCh=article.chapters[article.chapters.length-1]||'';
const validChars=characters.filter(c=>c.name);
if(validChars.length===0)return '';
const states=[];
validChars.forEach(c=>{
if(!c.name)return;
// Ê£ÄÊü•ËßíËâ≤Âú®ÊúÄÂêé‰∏ÄÁ´†ÁöÑÂá∫Áé∞ÂíåÁä∂ÊÄÅ
if(lastCh.includes(c.name)){
// ÁÆÄÂçïÁöÑÁä∂ÊÄÅÊé®Êñ≠
const idx=lastCh.lastIndexOf(c.name);
const context=lastCh.substring(Math.max(0,idx-20),Math.min(lastCh.length,idx+50));
states.push(c.name+'ÔºöÂá∫Áé∞‰∫éÊúÄËøëÂú∫ÊôØ');
}
});
return states.join('Ôºõ');
}
// ==================== CONTINUE CHAPTER ====================
async function continueChapter(){
if(isGen){
showToast('Ê≠£Âú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂÄô...');
return;
}
if(!curRd||curRd.type!=='long')return;
isGen=true;
const btn=document.getElementById('btnCont');
btn.disabled=true;
btn.innerHTML='Ê≠£Âú®Âàõ‰Ωú <span class="ldots"><span></span><span></span><span></span></span>';

const chNum=curRd.chapters.length+1;
const direction=(document.getElementById('dirInput').value||'').trim();

// ÊûÑÂª∫Êô∫ËÉΩ‰∏ä‰∏ãÊñá
let context='';
const totalCh=curRd.chapters.length;

// ÊèêÂèñÂÖ®‰π¶ÂÖ≥ÈîÆ‰ø°ÊÅØ
const storyState=extractStoryState(curRd);
if(storyState){
context+='„ÄêÊïÖ‰∫ãÁä∂ÊÄÅËøΩË∏™„Äë\n'+storyState+'\n\n';
}

// Â¶ÇÊûúÁ´†ËäÇËæÉÂ§öÔºåÊèê‰æõÊô∫ËÉΩÊëòË¶Å
if(totalCh>=3){
context+='„ÄêÂâçÊÉÖËÑâÁªú„Äë\n';
for(let i=Math.max(0,totalCh-4);i<totalCh-1;i++){
const ch=curRd.chapters[i]||'';
const keyPoints=extractKeyPoints(ch,i+1);
context+='Á¨¨'+(i+1)+'Á´†Ôºö'+keyPoints+'\n';
}
context+='\n';
}

// ‰∏ä‰∏ÄÁ´†ÂÆåÊï¥ÁªìÂ∞æ
const lastCh=curRd.chapters[totalCh-1]||'';
const lastChEnding=lastCh.substring(Math.max(0,lastCh.length-1500));
context+='„Äê‰∏ä‰∏ÄÁ´†ÔºàÁ¨¨'+totalCh+'Á´†ÔºâÁªìÂ∞æ„Äë\n'+lastChEnding+'\n';

// ‰∫∫Áâ©ÂΩìÂâçÁä∂ÊÄÅ
const charStates=getCharacterStates(curRd);
if(charStates){
context+='\n„Äê‰∫∫Áâ©ÂΩìÂâçÁä∂ÊÄÅ„Äë\n'+charStates+'\n';
}

// Â¶ÇÊûúÊúâÂ§ßÁ∫≤ÔºåÊèê‰æõÂΩìÂâçÁ´†ËäÇÁöÑÂ§ßÁ∫≤ÊåáÂºï
const wsArticle=ws.find(a=>a.id===curRd.id);
const crArticle=crWorks.find(w=>w.id===curRd.id);
const outline=(wsArticle&&wsArticle.outline)||(crArticle&&crArticle.outline)||'';
// Á´†ËäÇÂ§ßÁ∫≤
let chOutlineHint='';
if(curRd.chOutlines&&curRd.chOutlines[chNum-1]){
chOutlineHint=curRd.chOutlines[chNum-1];
}

let outlineHint='';
if(outline){
const outlineLines=outline.split('\n');
for(let i=0;i<outlineLines.length;i++){
const line=outlineLines[i].trim();
if(line.includes('Á¨¨'+chNum+'Á´†')||line.includes('Á¨¨'+chNum+'Á´†')){
outlineHint=line;
// ‰πüÂèñ‰∏ã‰∏ÄË°åÔºàÈÄöÂ∏∏ÊòØÊ¶ÇË¶ÅÔºâ
if(i+1<outlineLines.length){
const nextLine=outlineLines[i+1].trim();
if(nextLine.startsWith('-')||nextLine.startsWith('‚Äî'))outlineHint+='\n'+nextLine;
}
break;
}
}
}

let userMsg='ËØ∑Âàõ‰Ωú„Ää'+curRd.title+'„ÄãÁöÑÁ¨¨'+chNum+'Á´†„ÄÇ\n\n';
userMsg+=context+'\n';
if(chOutlineHint)userMsg+='„ÄêÊú¨Á´†ËØ¶ÁªÜÂ§ßÁ∫≤„Äë\n'+chOutlineHint+'\n\n';
else if(outlineHint)userMsg+='„ÄêÊú¨Á´†Â§ßÁ∫≤ÂèÇËÄÉ„Äë\n'+outlineHint+'\n\n';
if(direction)userMsg+='„Äê‰ΩúËÄÖÂØπÊú¨Á´†ÁöÑÊñπÂêëÊèêÁ§∫„Äë\n'+direction+'\n\n';
userMsg+='„ÄêÂàõ‰ΩúË¶ÅÊ±Ç‚Äî‚ÄîÈÄêÊù°Ê£ÄÊü•„Äë\n';
userMsg+='‚ñ° ÂºÄÂ§¥ÔºöËá™ÁÑ∂ÊâøÊé•Ôºå‰∏çÂ§çËø∞ÂâçÊÉÖÔºåÁî®‰∏Ä‰∏™Âä®‰ΩúÊàñÂØπËØùÁõ¥Êé•ÂàáÂÖ•\n';
userMsg+='‚ñ° ËäÇÂ•èÔºöÊú¨Á´†Ë¶ÅÊúâËµ∑‰ºèÔºå‰∏çËÉΩÂπ≥Èì∫Áõ¥ÂèôÔºåËá≥Â∞ë‰∏Ä‰∏™Â∞èÈ´òÊΩÆÊàñËΩ¨Êäò\n';
userMsg+='‚ñ° ‰∫∫Áâ©ÔºöÊØè‰∏™ËßíËâ≤ËØ¥ËØùÂÅö‰∫ãÂøÖÈ°ªÁ¨¶ÂêàTAÁöÑÊÄßÊ†ºËÆæÂÆöÔºå‰∏çËÉΩOOC\n';
userMsg+='‚ñ° ÁªÜËäÇÔºöËá≥Â∞ë3Â§ÑÊÑüÂÆòÊèèÂÜôÔºàËßÜËßâ‰πãÂ§ñÁöÑÔºöÂ£∞Èü≥/Ê∞îÂë≥/Ëß¶ÊÑü/Ê∏©Â∫¶Ôºâ\n';
userMsg+='‚ñ° ÂØπËØùÔºöÂØπËØùË¶ÅÊúâÊΩúÂè∞ËØçÔºå‰∏çËÉΩÂ§™Áõ¥ÁôΩÔºåË¶ÅÂÉèÁúü‰∫∫ËØ¥ËØù\n';
userMsg+='‚ñ° ÁªìÂ∞æÔºöÁïôÊÇ¨ÂøµÊàñÊÉÖÊÑüÈí©Â≠êÔºåËÆ©‰∫∫ÊÉ≥Áúã‰∏ã‰∏ÄÁ´†\n';
userMsg+='‚ñ° Ê†ºÂºèÔºöÁõ¥Êé•ËæìÂá∫Ê≠£ÊñáÔºåÊó†Ê†áÈ¢ò„ÄÅÁ´†ËäÇÂè∑„ÄÅ‰ΩúËÄÖÊåâËØ≠„ÄÅmarkdown\n\n';
userMsg+='„ÄêË¥®ÈáèÁ∫¢Á∫ø‚Äî‚ÄîÂá∫Áé∞‰ª•‰∏ã‰ªª‰Ωï‰∏ÄÊù°ÈÉΩÊòØÂ§±Ë¥•„Äë\n';
userMsg+='‚úó ‰ΩøÁî®"‰∏çÁ¶Å""ÁºìÁºì""Ê∑°Ê∑°"Á≠â‰∏áËÉΩÂâØËØçË∂ÖËøá2Ê¨°\n';
userMsg+='‚úó Âá∫Áé∞"Ê∑±ÈÇÉÁöÑÁúºÁú∏""ÂÆåÁæéÁöÑ‰æßËÑ∏"Á≠âÁ©∫Ê¥ûÂΩ¢ÂÆπ\n';
userMsg+='‚úó ËøûÁª≠3‰∏™ÊÆµËêΩ‰ª•Âêå‰∏Ä‰∏™Â≠ó/ËØçÂºÄÂ§¥\n';
userMsg+='‚úó ËßíËâ≤ÊÄßÊ†º‰∏éÂâçÊñáÁüõÁõæ\n';
userMsg+='‚úó ÊÉÖËäÇ‰∏éÂâçÊñáËÑ±ËäÇÔºåÂá∫Áé∞ÈÄªËæëÊºèÊ¥û\n';

const messages=[{role:'system',content:buildSysPrompt()},{role:'user',content:userMsg}];

const rdContent=document.getElementById('rdContent');
const startTime=Date.now();

if(!useStream){
const result=await callAPINonStream(messages);
isGen=false;btn.disabled=false;btn.textContent='üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†';
if(!result)return;
curRd.chapters.push(result);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>üìñ ÈïøÁØáËøûËΩΩ</span><span>üïê '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>ÂÖ± '+curRd.chapters.length+' Á´†</span><span>'+getTotalWords(curRd)+' Â≠ó</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('Á¨¨'+chNum+'Á´†Âàõ‰ΩúÂÆåÊàêÔºÅ‚ú®');
return;
}

await callAPIStream(messages,
(fullText)=>{
const elapsed=((Date.now()-startTime)/1000).toFixed(0);
const wc=countWords(fullText);
const paras=fullText.split(/\n+/).filter(p=>p.trim());
rdContent.innerHTML=paras.map(p=>'<p>'+esc(p.trim())+'</p>').join('');
document.getElementById('rdModal').scrollTop=document.getElementById('rdModal').scrollHeight;
},
(fullText)=>{
isGen=false;btn.disabled=false;btn.textContent='üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†';
if(!fullText)return;
curRd.chapters.push(fullText);
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();
document.getElementById('rdMeta').innerHTML=
'<span>üìñ ÈïøÁØáËøûËΩΩ</span><span>üïê '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>ÂÖ± '+curRd.chapters.length+' Á´†</span><span>'+getTotalWords(curRd)+' Â≠ó</span>';
document.getElementById('btnUndo').style.display='inline-block';
document.getElementById('dirInput').value='';
showToast('Á¨¨'+chNum+'Á´†Âàõ‰ΩúÂÆåÊàêÔºÅ‚ú®');
},
(errMsg)=>{
isGen=false;btn.disabled=false;btn.textContent='üìù ÁªßÁª≠ËøûËΩΩ‰∏ã‰∏ÄÁ´†';
showToast(errMsg,3000);
}
);
}

// ==================== UNDO CHAPTER ====================
function undoChapter(){
if(!curRd||curRd.type!=='long'||!curRd.chapters||curRd.chapters.length<=1)return;
showDlg('Êí§ÈîÄÁ°ÆËÆ§','Á°ÆÂÆöË¶ÅÂà†Èô§ÊúÄÂêé‰∏ÄÁ´†ÔºàÁ¨¨'+curRd.chapters.length+'Á´†ÔºâÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',()=>{
curRd.chapters.pop();
syncArticle(curRd);
curCh=curRd.chapters.length-1;
renderChContent();

document.getElementById('rdMeta').innerHTML=
'<span>üìñ ÈïøÁØáËøûËΩΩ</span><span>üïê '+new Date(curRd.createdAt).toLocaleDateString()+'</span>'+
'<span>ÂÖ± '+curRd.chapters.length+' Á´†</span><span>'+getTotalWords(curRd)+' Â≠ó</span>';

if(curRd.chapters.length<=1)document.getElementById('btnUndo').style.display='none';
showToast('Â∑≤Êí§ÈîÄÊúÄÂêé‰∏ÄÁ´†');
},true);
}

// ==================== COPY ====================
function copyCurrentArticle(){
if(!curRd)return;
let text='';
if(curRd.type==='long'&&curRd.chapters){
curRd.chapters.forEach((ch,i)=>{text+='Á¨¨'+(i+1)+'Á´†\n\n'+ch+'\n\n';});
}else{text=curRd.content||'';}
// Clean: only remove non-standard whitespace, keep normal spaces and newlines
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');

const header='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n„Äå'+curRd.title+'„Äç\nÊú¨ÊñáÁî±„ÄåÁ¨îËÆ∞AI„ÄçËæÖÂä©Âàõ‰ΩúÁîüÊàê\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI ¬∑ Created by ÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
const footer='\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nÊú¨ÊñáÁî±AIËæÖÂä©Âàõ‰ΩúÔºåÂÜÖÂÆπ‰ªÖ‰æõÂèÇËÄÉ\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI '+APP_VER+'ÔºàAIÂàõ‰ΩúÂ∑•ÂùäÔºâ\nÁΩëÈ°µ‰ΩúËÄÖÔºöÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
doCopy(header+text+footer);
}

function doCopy(text){
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(text).then(()=>showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø üìã')).catch(()=>fbCopy(text));
}else{fbCopy(text);}
}
function fbCopy(text){
const ta=document.createElement('textarea');ta.value=text;
ta.style.cssText='position:fixed;left:-9999px;';
document.body.appendChild(ta);ta.select();
try{document.execCommand('copy');showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø üìã');}
catch{showToast('Â§çÂà∂Â§±Ë¥•');}
document.body.removeChild(ta);
}

// Fullscreen change listener
document.addEventListener('fullscreenchange',()=>{
if(!document.fullscreenElement&&isFS){
isFS=false;
document.getElementById('rdModal').classList.remove('fs');
document.getElementById('bnav').classList.remove('hide');
document.getElementById('btnFS').textContent='‚õ∂';
}
});

// ==================== COLLECTIONS ====================
function renderCollections(){
const sv_=(document.getElementById('colSearchInput').value||'').trim().toLowerCase();

// Books
const grid=document.getElementById('bookGrid');
let books=cols.books;
if(sv_)books=books.filter(b=>b.title.toLowerCase().includes(sv_));

if(books.length===0){
grid.innerHTML='<div class="empty-st" style="grid-column:1/-1"><p>'+(sv_?'Ê≤°ÊúâÂåπÈÖçÁöÑÈïøÁØá':'ËøòÊ≤°ÊúâÊî∂ËóèÁöÑÈïøÁØáÂ∞èËØ¥<br>Âú®‰ΩúÂùä‰∏≠Êî∂ËóèÂç≥ÂèØÊ∑ªÂä†')+'</p></div>';
}else{
grid.innerHTML='';
books.forEach(book=>{
const realId=book.id;
const card=document.createElement('div');
card.className='bcard';

let covHtml='';
if(book.cover)covHtml='<img src="'+book.cover+'" alt="Â∞ÅÈù¢">';
else covHtml='<div class="bcov-ph"><span style="font-size:24px">üìñ</span><span>'+esc(book.title.substring(0,4))+'</span></div>';

const statusClass=book.status||'ongoing';
const statusText={ongoing:'ËøûËΩΩ‰∏≠',complete:'Â∑≤ÂÆåÁªì',paused:'ÊöÇÂÅú'}[statusClass]||'ËøûËΩΩ‰∏≠';

card.innerHTML=
'<div class="bcov" onclick="openColBook(\''+realId+'\')">'+covHtml+'</div>'+
'<div class="binfo" onclick="openColBook(\''+realId+'\')">'+
'<div class="binfo-t">'+esc(book.title)+'</div>'+
'<div class="binfo-m">'+(book.chapters?book.chapters.length+'Á´† ¬∑ ':'')+ getTotalWords(book)+'Â≠ó</div>'+
'<span class="binfo-status '+statusClass+'">'+statusText+'</span>'+
renderStarHTML(book.rating||0,realId)+
'</div>'+
'<div class="bacts">'+
'<button class="bact" onclick="event.stopPropagation();uploadCover(\''+realId+'\')">Â∞ÅÈù¢</button>'+
'<button class="bact" onclick="event.stopPropagation();cycleStatus(\''+realId+'\')">Áä∂ÊÄÅ</button>'+
'<button class="bact" onclick="event.stopPropagation();copyBook(\''+realId+'\')">Â§çÂà∂</button>'+
'<button class="bact" onclick="event.stopPropagation();exportBookToTxt(\''+realId+'\')">ÂØºÂá∫</button>'+
'<button class="bact danger" onclick="event.stopPropagation();deleteBook(\''+realId+'\')">Âà†Èô§</button>'+
'</div>';
grid.appendChild(card);
});
}

// Shorts
const sl=document.getElementById('shortList');
let shorts=cols.shorts;
if(sv_)shorts=shorts.filter(s=>s.title.toLowerCase().includes(sv_));

if(shorts.length===0){
sl.innerHTML='<div class="empty-st"><p>'+(sv_?'Ê≤°ÊúâÂåπÈÖçÁöÑÁü≠ÁØá':'ËøòÊ≤°ÊúâÊî∂ËóèÁöÑÁü≠ÁØáÊñáÁ´†')+'</p></div>';
}else{
sl.innerHTML='';
shorts.forEach(s=>{
const realId=s.id;
const item=document.createElement('div');
item.className='sitem';
item.onclick=e=>{if(!e.target.closest('button')&&!e.target.closest('.star-rating'))openReading(s);};
item.innerHTML=
'<div class="sitem-info"><div class="sitem-t">'+esc(s.title)+'</div>'+
'<div class="sitem-pv">'+esc((s.content||'').replace(/\n/g,' ').substring(0,20))+'</div>'+
renderStarHTML(s.rating||0,realId)+
'</div>'+
'<div class="sitem-acts">'+
'<button onclick="event.stopPropagation();copyShort(\''+realId+'\')">Â§çÂà∂</button>'+
'<button onclick="event.stopPropagation();deleteShort(\''+realId+'\')" style="color:var(--danger)">Âà†Èô§</button>'+
'</div>';
sl.appendChild(item);
});
}

document.getElementById('colCnt').textContent=(cols.books.length+cols.shorts.length)+' ÁØá';
}

function renderStarHTML(rating,id){
let html='<div class="star-rating">';
for(let i=1;i<=5;i++){
html+='<span class="'+(i<=rating?'filled':'')+'" onclick="event.stopPropagation();setRating(\''+id+'\','+i+')">‚òÖ</span>';
}
html+='</div>';
return html;
}

function setRating(id,rating){
let found=cols.books.find(b=>b.id===id);
if(found){found.rating=rating;}
else{found=cols.shorts.find(s=>s.id===id);if(found)found.rating=rating;}
sv(K.cols,cols);renderCollections();
}

function cycleStatus(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
const states=['ongoing','complete','paused'];
const cur=states.indexOf(book.status||'ongoing');
book.status=states[(cur+1)%states.length];
sv(K.cols,cols);renderCollections();
const labels={ongoing:'ËøûËΩΩ‰∏≠',complete:'Â∑≤ÂÆåÁªì',paused:'ÊöÇÂÅú'};
showToast('Áä∂ÊÄÅÂ∑≤ÂàáÊç¢‰∏∫Ôºö'+labels[book.status]);
}

function openColBook(id){
const book=cols.books.find(b=>b.id===id);
if(book)openReading(book);
}

function uploadCover(id){
const input=document.getElementById('coverUp');
input.onchange=e=>{
const file=e.target.files[0];if(!file)return;
// Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
if(file.size>5*1024*1024){
showToast('ÂõæÁâáÂ§™Â§ßÔºåËØ∑ÈÄâÊã©5MB‰ª•ÂÜÖÁöÑÂõæÁâá',3000);
return;
}
// Compress cover: resize to max 200px width
const canvas=document.createElement('canvas');
const img=new Image();
img.onerror=()=>{showToast('ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Êç¢‰∏ÄÂº†');};
img.onload=()=>{
const maxW=200;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
// Ê£ÄÊü•ÂéãÁº©ÂêéÂ§ßÂ∞è
if(dataUrl.length>100*1024){
showToast('ÂõæÁâá‰ªçÁÑ∂ËæÉÂ§ßÔºåÂ∑≤Ëá™Âä®Èôç‰ΩéË¥®Èáè',2000);
const dataUrl2=canvas.toDataURL('image/jpeg',0.3);
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl2;sv(K.cols,cols);renderCollections();showToast('Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ üé®');}
return;
}
const book=cols.books.find(b=>b.id===id);
if(book){book.cover=dataUrl;sv(K.cols,cols);renderCollections();showToast('Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ üé®');}
};
img.src=URL.createObjectURL(file);
input.value='';
};
input.click();
}

function copyBook(id){
const book=cols.books.find(b=>b.id===id);if(!book)return;
let text='';
if(book.chapters){book.chapters.forEach((ch,i)=>{text+='Á¨¨'+(i+1)+'Á´†\n\n'+ch+'\n\n';});}
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n„Äå'+book.title+'„Äç\nÊú¨ÊñáÁî±„ÄåÁ¨îËÆ∞AI„ÄçËæÖÂä©Âàõ‰ΩúÁîüÊàê\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI ¬∑ Created by ÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
const footer='\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nÊú¨ÊñáÁî±AIËæÖÂä©Âàõ‰ΩúÔºåÂÜÖÂÆπ‰ªÖ‰æõÂèÇËÄÉ\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI '+APP_VER+'ÔºàAIÂàõ‰ΩúÂ∑•ÂùäÔºâ\nÁΩëÈ°µ‰ΩúËÄÖÔºöÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
doCopy(header+text+footer);
}

function deleteBook(id){
const book=cols.books.find(b=>b.id===id);
if(!book)return;
showDlg('Âà†Èô§Á°ÆËÆ§','Á°ÆÂÆöË¶ÅÂà†Èô§„Ää'+book.title+'„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',()=>{
cols.books=cols.books.filter(b=>b.id!==id);
sv(K.cols,cols);renderCollections();showToast('Â∑≤Âà†Èô§');
},true);
}

function copyShort(id){
const s=cols.shorts.find(x=>x.id===id);if(!s)return;
let text=s.content||'';
text=text.replace(/[\u200B-\u200D\uFEFF]/g,'');
const header='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n„Äå'+s.title+'„Äç\nÊú¨ÊñáÁî±„ÄåÁ¨îËÆ∞AI„ÄçËæÖÂä©Âàõ‰ΩúÁîüÊàê\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI ¬∑ Created by ÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
const footer='\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nÊú¨ÊñáÁî±AIËæÖÂä©Âàõ‰ΩúÔºåÂÜÖÂÆπ‰ªÖ‰æõÂèÇËÄÉ\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI '+APP_VER+'ÔºàAIÂàõ‰ΩúÂ∑•ÂùäÔºâ\nÁΩëÈ°µ‰ΩúËÄÖÔºöÂøÉÁî∞\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
doCopy(header+text+footer);
}

function deleteShort(id){
showDlg('Âà†Èô§Á°ÆËÆ§','Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÁü≠ÊñáÂêóÔºü',()=>{
cols.shorts=cols.shorts.filter(s=>s.id!==id);
sv(K.cols,cols);renderCollections();showToast('Â∑≤Âà†Èô§');
},true);
}

// ==================== SETTINGS ====================
function toggleGrp(el){el.classList.toggle('exp');el.nextElementSibling.classList.toggle('show');}

// API Presets
function saveApiPreset(){
showInp('‰øùÂ≠òAPIÈ¢ÑËÆæ','‰∏∫È¢ÑËÆæËµ∑‰∏™ÂêçÂ≠ó',name=>{
apiP.push({name,...getCurApi()});
sv(K.apiP,apiP);saveCurSettings();renderApiPresets();showToast('APIÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderApiPresets(){
const l=document.getElementById('apiPL');l.innerHTML='';
apiP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(p.model||'')+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useApiP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delApiP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useApiP(i){
const p=apiP[i];
document.getElementById('apiUrl').value=p.url||'';
document.getElementById('apiKey').value=p.key||'';
document.getElementById('apiModel').value=p.model||'';
document.getElementById('apiTemp').value=p.temp??0.8;
document.getElementById('apiMaxTokens').value=p.maxTokens||4096;
saveCurSettings();showToast('Â∑≤ÂàáÊç¢: '+p.name);
}
function delApiP(i){apiP.splice(i,1);sv(K.apiP,apiP);renderApiPresets();}

// Char Presets
function saveCharPreset(){
saveCharactersFromUI();
showInp('‰øùÂ≠ò‰∫∫Áâ©È¢ÑËÆæ','‰∏∫ËøôÁªÑ‰∫∫Áâ©Ëµ∑‰∏™ÂêçÂ≠ó',name=>{
charP.push({name,characters:JSON.parse(JSON.stringify(characters))});
sv(K.charP,charP);renderCharPresets();showToast('‰∫∫Áâ©È¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderCharPresets(){
const l=document.getElementById('charPL');l.innerHTML='';
charP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
const charNames=(p.characters||[]).map(c=>c.name).filter(Boolean).join('„ÄÅ')||'Êú™ÂëΩÂêç';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc(charNames)+')</span></span><div class="pitem-a"><button class="btn-use" onclick="useCharP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delCharP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useCharP(i){
const p=charP[i];
characters=JSON.parse(JSON.stringify(p.characters||[{name:'',desc:''}]));
sv(K.curChars,characters);
renderCharCards();showToast('Â∑≤Âä†ËΩΩ‰∫∫Áâ©: '+p.name);
}
function delCharP(i){charP.splice(i,1);sv(K.charP,charP);renderCharPresets();}

// World Presets
function saveWorldPreset(){
showInp('‰øùÂ≠ò‰∏ñÁïåËßÇÈ¢ÑËÆæ','‰∏∫‰∏ñÁïåËßÇËµ∑‰∏™ÂêçÂ≠ó',name=>{
worldP.push({name,desc:document.getElementById('worldDesc').value,minWords:parseInt(document.getElementById('minWords').value)||800});
sv(K.worldP,worldP);saveCurSettings();renderWorldPresets();showToast('‰∏ñÁïåËßÇÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderWorldPresets(){
const l=document.getElementById('worldPL');l.innerHTML='';
worldP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+'</span><div class="pitem-a"><button class="btn-use" onclick="useWorldP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delWorldP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useWorldP(i){
const p=worldP[i];
document.getElementById('worldDesc').value=p.desc||'';
document.getElementById('minWords').value=p.minWords||800;
saveCurSettings();showToast('Â∑≤Âä†ËΩΩ‰∏ñÁïåËßÇ: '+p.name);
}
function delWorldP(i){worldP.splice(i,1);sv(K.worldP,worldP);renderWorldPresets();}
// ÊñáÈ£éÈ¢ÑËÆæ
function saveStylePreset(){
const desc=(document.getElementById('styleDesc').value||'').trim();
if(!desc){showToast('ËØ∑ÂÖàÂ°´ÂÜôÊñáÈ£éÊèèËø∞');return;}
showInp('‰øùÂ≠òÊñáÈ£éÈ¢ÑËÆæ','‰∏∫Ëøô‰∏™ÊñáÈ£éËµ∑‰∏™ÂêçÂ≠ó',name=>{
styleP.push({name,desc});
sv('bj_styleP',styleP);renderStylePresets();showToast('ÊñáÈ£éÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderStylePresets(){
const l=document.getElementById('stylePL');if(!l)return;l.innerHTML='';
styleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useStyleP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delStyleP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useStyleP(i){
const p=styleP[i];
document.getElementById('styleDesc').value=p.desc||'';
ap.curStyle=p.desc;sv(K.ap,ap);
showToast('Â∑≤Âä†ËΩΩÊñáÈ£é: '+p.name);
}
function delStyleP(i){styleP.splice(i,1);sv('bj_styleP',styleP);renderStylePresets();}
// ËßÑÂàôÈ¢ÑËÆæ
function saveRulePreset(){
const desc=(document.getElementById('ruleDesc').value||'').trim();
if(!desc){showToast('ËØ∑ÂÖàÂ°´ÂÜôËßÑÂàôÂÜÖÂÆπ');return;}
showInp('‰øùÂ≠òËßÑÂàôÈ¢ÑËÆæ','‰∏∫ËøôÁªÑËßÑÂàôËµ∑‰∏™ÂêçÂ≠ó',name=>{
ruleP.push({name,desc});
sv('bj_ruleP',ruleP);renderRulePresets();showToast('ËßÑÂàôÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderRulePresets(){
const l=document.getElementById('rulePL');if(!l)return;l.innerHTML='';
ruleP.forEach((p,i)=>{
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+esc((p.desc||'').substring(0,20))+'...)</span></span><div class="pitem-a"><button class="btn-use" onclick="useRuleP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delRuleP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useRuleP(i){
const p=ruleP[i];
document.getElementById('ruleDesc').value=p.desc||'';
curRule=p.desc||'';sv('bj_curRule',curRule);
showToast('Â∑≤Âä†ËΩΩËßÑÂàô: '+p.name);
}
function delRuleP(i){ruleP.splice(i,1);sv('bj_ruleP',ruleP);renderRulePresets();}
// Á¶ÅÁî®ËØçÈ¢ÑËÆæ
function saveBanWordsPreset(){
const desc=(document.getElementById('banWordsInput').value||'').trim();
if(!desc){showToast('ËØ∑ÂÖàÂ°´ÂÜôÁ¶ÅÁî®ËØç');return;}
showInp('‰øùÂ≠òÁ¶ÅÁî®ËØçÈ¢ÑËÆæ','‰∏∫ËøôÁªÑÁ¶ÅÁî®ËØçËµ∑‰∏™ÂêçÂ≠ó',name=>{
banWordsP.push({name,desc});
sv('bj_banWordsP',banWordsP);renderBanWordsPresets();showToast('Á¶ÅÁî®ËØçÈ¢ÑËÆæÂ∑≤‰øùÂ≠ò');
});
}
function renderBanWordsPresets(){
const l=document.getElementById('banWordsPL');if(!l)return;l.innerHTML='';
banWordsP.forEach((p,i)=>{
const wordCount=(p.desc||'').split('\n').filter(w=>w.trim()).length;
const it=document.createElement('div');it.className='pitem';
it.innerHTML='<span class="pitem-n">'+esc(p.name)+' <span style="font-size:9px;color:var(--text2)">('+wordCount+'‰∏™ËØç)</span></span><div class="pitem-a"><button class="btn-use" onclick="useBanWordsP('+i+')">‰ΩøÁî®</button><button class="btn-del" onclick="delBanWordsP('+i+')">Âà†Èô§</button></div>';
l.appendChild(it);
});
}
function useBanWordsP(i){
const p=banWordsP[i];
document.getElementById('banWordsInput').value=p.desc||'';
banWords=p.desc||'';sv('bj_banWords',banWords);
showToast('Â∑≤Âä†ËΩΩÁ¶ÅÁî®ËØç: '+p.name);
}
function delBanWordsP(i){banWordsP.splice(i,1);sv('bj_banWordsP',banWordsP);renderBanWordsPresets();}
function applyStyleTemplate(name){
const templates={
'ËΩªÊùæÊó•Â∏∏':'ËØ≠Ë®ÄËΩªÊùæËá™ÁÑ∂ÔºåÂÉèÊúãÂèãËÅäÂ§©‰∏ÄÊ†∑‰∫≤Âàá„ÄÇÂ§öÁî®Áü≠Âè•ÂíåÂè£ËØ≠ÂåñË°®ËææÔºåËäÇÂ•èÊòéÂø´ÔºåÈÄÇÂΩìÂä†ÂÖ•ÁîüÊ¥ªÂåñÁöÑÊØîÂñªÂíåÂ∞èÂπΩÈªò„ÄÇÊÉÖÁª™Âü∫Ë∞ÉÊ∏©ÊöñËàíÈÄÇÔºåÂç≥‰ΩøÂÜôÁüõÁõæ‰πü‰∏çË¶ÅÂ§™Ê≤âÈáç„ÄÇ',
'Ê≤âÈÉÅÊñáÂ≠¶':'ËØ≠Ë®ÄÂáùÁªÉÂÖãÂà∂ÔºåÊúâÂàÜÈáèÊÑü„ÄÇÂ§öÁî®ÊÑèË±°ÂíåÈöêÂñª‰º†ÈÄíÊÉÖÁª™ÔºåÂ∞ëÁî®Áõ¥ÁôΩÁöÑÊÉÖÊÑüËØçÊ±á„ÄÇÂè•ÂºèÂèØ‰ª•ÈïøËÄåÂ§çÊùÇÔºåÊúâÊÄùËæ®ÊÄß„ÄÇÊï¥‰ΩìÊ∞õÂõ¥Ê≤âÈùôÂÜÖÊïõÔºåÁïôÁôΩÂ§ö‰∫éÈì∫Èôà„ÄÇ',
'ÁîúÂÆ†Ë®ÄÊÉÖ':'ËØ≠Ë®ÄÁîúËÄå‰∏çËÖªÔºåÊ≥®ÈáçÁªÜËäÇÊí©Êã®„ÄÇÂñÑÁî®ÂøÉÁêÜÊèèÂÜôÂ±ïÁé∞ÊößÊòßÂíåÂøÉÂä®ÔºåÂØπËØùË¶ÅÊúâÊù•ÊúâÂõûÁöÑÂåñÂ≠¶ÂèçÂ∫î„ÄÇËäÇÂ•è‰∏äÂº†ÂºõÊúâÂ∫¶ÔºåÁîúËúú‰∏≠Á©øÊèíÂ∞èËØØ‰ºöÂ∞èÊ≥¢Êäò„ÄÇÊ∞õÂõ¥ÊÑüË¶ÅÂº∫ÔºåÊ≥®ÈáçÂÖâÁ∫ø„ÄÅÊ∞îÂë≥„ÄÅÊ∏©Â∫¶Á≠âÊÑüÂÆòÁªÜËäÇ„ÄÇ',
'ÊÇ¨ÁñëÁ¥ßÂº†':'ËØ≠Ë®ÄÁÆÄÊ¥ÅÊúâÂäõÔºå‰ø°ÊÅØÈáèÂ§ß„ÄÇÂñÑÁî®Áü≠Âè•Âà∂ÈÄ†Á¥ßËø´ÊÑüÔºåÈïøÂè•Èì∫Âû´‰∏çÂÆâÊ∞õÂõ¥„ÄÇÂèôËø∞ËßÜËßíË¶ÅÊúâÈôêÂà∂ÊÑüÔºåËÆ©ËØªËÄÖÂíå‰∏ªËßí‰∏ÄËµ∑ÂèëÁé∞Á∫øÁ¥¢„ÄÇÂ§öÁî®ÊöóÁ§∫Âíå‰ºèÁ¨îÔºåÂÖ≥ÈîÆ‰ø°ÊÅØË¶ÅËóèÂú®Êó•Â∏∏ÁªÜËäÇÈáå„ÄÇ',
'Âè§È£éÂÖ∏ÈõÖ':'ËØ≠Ë®ÄÂÖ∏ÈõÖÂê´ËìÑÔºåÊúâÂè§ÂÖ∏ÈüµÂë≥‰ΩÜ‰∏çÂ†ÜÁ†åËæûËóª„ÄÇÂèØÈÄÇÂΩìÂåñÁî®ËØóËØçÊÑèÂ¢ÉÔºå‰ΩÜÂØπËØùË¶ÅÈÄö‰øóÊòìÊáÇ„ÄÇÊ≥®ÈáçÊÑèÂ¢ÉËê•ÈÄ†ÔºåÂñÑÁî®Ëá™ÁÑ∂ÊôØÁâ©Êò†Â∞Ñ‰∫∫Áâ©ÂøÉÂ¢É„ÄÇËäÇÂ•èËàíÁºì‰ªéÂÆπÔºåÊúâÁïôÁôΩ‰πãÁæé„ÄÇ',
'ÂπΩÈªòËÆΩÂà∫':'ËØ≠Ë®ÄÊú∫Êô∫ÁäÄÂà©ÔºåÂñÑÁî®ÂèçÂ∑ÆÂíåÂ§∏Âº†Âà∂ÈÄ†ÂñúÊÑü„ÄÇÂèôËø∞ËÄÖÁöÑÂ£∞Èü≥Ë¶ÅÊúâ‰∏™ÊÄßÔºåÂÉè‰∏Ä‰∏™ÊØíËàå‰ΩÜÂñÑËâØÁöÑÊóÅËßÇËÄÖ„ÄÇÂèØ‰ª•ÊâìÁ†¥Á¨¨ÂõõÈù¢Â¢ôÔºåÁî®Áé∞‰ª£Ê¢óÂíåÁ±ªÊØîËÆ©Âè§ËÄÅÁöÑÊïÖ‰∫ãÁÑïÂèëÊñ∞ÊÑè„ÄÇÁ¨ë‰∏≠Â∏¶Ê≥™ÊúÄ‰Ω≥„ÄÇ',
'Á°¨Ê†∏ÂÜôÂÆû':'ËØ≠Ë®ÄÊú¥Á¥†ÊâéÂÆûÔºå‰∏ç‰øÆÈ•∞‰∏çÁæéÂåñ„ÄÇÁªÜËäÇË¶ÅÁªèÂæóËµ∑Êé®Êï≤ÔºåÊ∂âÂèä‰∏ì‰∏öÈ¢ÜÂüüË¶ÅÂáÜÁ°Æ„ÄÇ‰∫∫Áâ©ËØ¥ËØùË¶ÅÁ¨¶ÂêàË∫´‰ªΩÂíåÊïôËÇ≤ËÉåÊôØÔºå‰∏çË¶Å‰∫∫‰∫∫ÈÉΩÂá∫Âè£ÊàêÁ´†„ÄÇÊÉÖËäÇÊé®ËøõÈù†ÈÄªËæëËÄåÈùûÂ∑ßÂêàÔºåÂÜ≤Á™ÅÊù•Ëá™ÁúüÂÆûÁöÑÂà©ÁõäÂíåÁ´ãÂú∫Á¢∞Êíû„ÄÇ'
};
const desc=templates[name]||'';
document.getElementById('styleDesc').value=desc;
ap.curStyle=desc;sv(K.ap,ap);
showToast('Â∑≤Â∫îÁî®ÊñáÈ£é: '+name);
}
function renderAllPresets(){renderApiPresets();renderCharPresets();renderWorldPresets();renderStylePresets();renderRulePresets();renderBanWordsPresets();}

// ==================== APPEARANCE ====================
function setTheme(theme,el){
document.body.className='';
if(theme==='light')document.body.classList.add('theme-light');
else if(theme!=='default')document.body.classList.add('theme-'+theme);
document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
el.classList.add('act');
ap.theme=theme;sv(K.ap,ap);
}

function applyAppearance(){
document.body.className='';
if(ap.theme==='light')document.body.classList.add('theme-light');
else if(ap.theme&&ap.theme!=='default')document.body.classList.add('theme-'+ap.theme);

document.querySelectorAll('.t-opt').forEach(o=>o.classList.remove('act'));
const themeMap={default:'t0',warm:'t1',green:'t2',blue:'t3',light:'t4'};
const target=document.querySelector('.t-opt.'+(themeMap[ap.theme]||'t0'));
if(target)target.classList.add('act');

if(ap.fontUrl){
document.getElementById('customFontUrl').value=ap.fontUrl;
loadFont(ap.fontUrl);
}
}

function loadFont(url){
const existing=document.getElementById('cfStyle');
if(existing)existing.remove();
if(!url)return;
try{
const sanitized=url.replace(/"/g,'%22').replace(/'/g,'%27');
const style=document.createElement('style');
style.id='cfStyle';
style.textContent='@font-face{font-family:"CF";src:url("'+sanitized+'");font-display:swap;}body,.rd-content,.acard-pv,.acard-t,.rd-title{font-family:"CF",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif!important;}';
document.head.appendChild(style);
}catch(e){showToast('Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•');console.warn(e);}
}

document.getElementById('customFontUrl').addEventListener('change',function(){
ap.fontUrl=this.value.trim();sv(K.ap,ap);loadFont(ap.fontUrl);
if(ap.fontUrl)showToast('Â≠ó‰ΩìÂ∑≤Êõ¥Êñ∞ÔºåÂ¶ÇÊó†ÂèòÂåñËØ∑Ê£ÄÊü•ÈìæÊé•');
});

function uploadRdBg(e){
const file=e.target.files[0];if(!file)return;
// Compress bg image
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const maxW=600;
let w=img.width,h=img.height;
if(w>maxW){h=h*(maxW/w);w=maxW;}
canvas.width=w;canvas.height=h;
canvas.getContext('2d').drawImage(img,0,0,w,h);
const dataUrl=canvas.toDataURL('image/jpeg',0.5);
ap.rdBg=dataUrl;sv(K.ap,ap);showToast('ÈòÖËØªËÉåÊôØÂ∑≤ËÆæÁΩÆ üé®');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}

function clearRdBg(){
ap.rdBg='';sv(K.ap,ap);
document.getElementById('rdBg').style.display='none';
showToast('ÈòÖËØªËÉåÊôØÂ∑≤Ê∏ÖÈô§');
}

// ==================== DATA IMPORT/EXPORT ====================
function exportAllNotes(){
const allNotes={};
const allArticles=[...ws,...cols.books,...cols.shorts];
const ids=[...new Set(allArticles.map(a=>a.id))];
ids.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
if(n.length>0)allNotes[id]=n;
});
return allNotes;
}
function importAllNotes(notesObj){
if(!notesObj||typeof notesObj!=='object')return;
Object.keys(notesObj).forEach(id=>{
if(Array.isArray(notesObj[id])&&notesObj[id].length>0){
sv('bj_notes_'+id,notesObj[id]);
}
});
}
function exportData(){
saveCurSettings();
markBackupDone();// Ê†áËÆ∞Â∑≤Â§á‰ªΩ
const data={
_app:'bijiAI',_version:3,_ver:APP_VER,_exportedAt:new Date().toISOString(),
apiPresets:apiP,charPresets:charP,worldPresets:worldP,
stylePresets:styleP,rulePresets:ruleP,curRule:curRule,banWords:banWords,banWordsPresets:banWordsP,
curApi:ld(K.curApi,{}),
curChars:characters,
curWorld:ld(K.curWorld,{}),
collections:cols,workshop:ws,crWorks:crWorks,resPacks:resPacks,tags,appearance:ap,userCard:userCard,notes:exportAllNotes()
};
const jsonStr=JSON.stringify(data,null,2);
const sizeKB=(new Blob([jsonStr]).size/1024).toFixed(1);
const fileName='Á¨îËÆ∞AI_Â§á‰ªΩ_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';

// ÊñπÊ≥ï1: Â∞ùËØï‰ΩøÁî®File System Access APIÔºàÁé∞‰ª£ÊµèËßàÂô®Ôºâ
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONÊñá‰ª∂',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('Êï∞ÊçÆÂ∑≤‰øùÂ≠ò ('+sizeKB+'KB) üì§');
}catch(e){
if(e.name!=='AbortError')fallbackExport(jsonStr,fileName);
}
})();
return;
}

// ÊñπÊ≥ï2: Â∞ùËØïAndroid WebViewÁöÑ‰∏ãËΩΩÊñπÂºè
if(/android/i.test(navigator.userAgent)){
try{
const blob=new Blob([jsonStr],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('Êï∞ÊçÆÂ∑≤ÂØºÂá∫ÔºåËØ∑Êü•Áúã‰∏ãËΩΩÁõÆÂΩï üì§');
return;
}catch(e){}
}

// ÊñπÊ≥ï3: ÈÄöÁî®ÂõûÈÄÄ
fallbackExport(jsonStr,fileName);
}

function fallbackExport(jsonStr,fileName){
// ‰ΩøÁî®data URIÊñπÂºèÔºåÂÖºÂÆπÊÄßÊúÄÂ•Ω
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
showToast('Êï∞ÊçÆÂ∑≤ÂØºÂá∫ üì§');
}

function importData(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI'){showToast('Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ',3000);return;}
showDlg('ÂØºÂÖ•Á°ÆËÆ§','ÂØºÂÖ•Â∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâËÆæÁΩÆÂíåÊî∂ËóèÊï∞ÊçÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
if(data.apiPresets){apiP=data.apiPresets;sv(K.apiP,apiP);}
if(data.charPresets){charP=data.charPresets;sv(K.charP,charP);}
if(data.worldPresets){worldP=data.worldPresets;sv(K.worldP,worldP);}
if(data.stylePresets){styleP=data.stylePresets;sv('bj_styleP',styleP);}
if(data.rulePresets){ruleP=data.rulePresets;sv('bj_ruleP',ruleP);}
if(data.curRule){curRule=data.curRule;sv('bj_curRule',curRule);}
if(data.banWords){banWords=data.banWords;sv('bj_banWords',banWords);}
if(data.banWordsPresets){banWordsP=data.banWordsPresets;sv('bj_banWordsP',banWordsP);}
if(data.curApi)sv(K.curApi,data.curApi);
if(data.curChars){characters=data.curChars;sv(K.curChars,characters);}
else if(data.currentChar){
// v1/ compatibility
const cc=data.currentChar;
characters=[{name:cc.aName||'',desc:cc.aDesc||''},{name:cc.bName||'',desc:cc.bDesc||''}];
sv(K.curChars,characters);
}
if(data.curWorld)sv(K.curWorld,data.curWorld);
else if(data.currentWorld)sv(K.curWorld,data.currentWorld);
if(data.collections){
cols=data.collections;
// Ensure fields
if(!cols.books)cols.books=[];
if(!cols.shorts)cols.shorts=[];
cols.books.forEach(b=>{if(!b.status)b.status='ongoing';if(!b.rating)b.rating=0;});
cols.shorts.forEach(s=>{if(!s.rating)s.rating=0;});
sv(K.cols,cols);
}
if(data.tags){tags=data.tags;sv(K.tags,tags);}
if(data.workshop){ws=data.workshop;sv(K.ws,ws);}
if(data.crWorks){crWorks=data.crWorks;sv('bj_crWorks',crWorks);}
if(data.resPacks){resPacks=data.resPacks;sv('bj_resPacks',resPacks);}
if(data.notes)importAllNotes(data.notes);
if(data.userCard){userCard=data.userCard;sv('bj_userCard',userCard);}
if(data.appearance){
ap={...{theme:'default',fontUrl:'',rdBg:'',rdFontSize:15,rdLineHeight:2},...data.appearance};
sv(K.ap,ap);
}

// Reload forms
const api=data.curApi||data.currentApi||{};
document.getElementById('apiUrl').value=api.url||'';
document.getElementById('apiKey').value=api.key||'';
document.getElementById('apiModel').value=api.model||'gpt-4o-mini';
document.getElementById('apiTemp').value=api.temp??0.8;
document.getElementById('apiMaxTokens').value=api.maxTokens||4096;

const world=data.curWorld||data.currentWorld||{};
document.getElementById('worldDesc').value=world.desc||'';
document.getElementById('minWords').value=world.minWords||800;

renderTags();renderAllPresets();renderCollections();renderCharCards();
applyAppearance();
showToast('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü üì•');
});renderUserCard();
}catch(err){showToast('Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: '+err.message,3000);}
};
reader.readAsText(file);e.target.value='';
}
function deleteWsArticle(id){
const article=ws.find(a=>a.id===id);
if(!article)return;
showDlg('Âà†Èô§ÊñáÁ´†','Á°ÆÂÆöË¶Å‰ªé‰ΩúÂùäÂà†Èô§„Äå'+article.title+'„ÄçÂêóÔºü',()=>{
ws=ws.filter(a=>a.id!==id);
sv(K.ws,ws);renderArticles();showToast('Â∑≤Âà†Èô§');
},true);
}
function clearWorkshop(){
const count=ws.length;
if(count===0){showToast('‰ΩúÂùäÂ∑≤ÁªèÊòØÁ©∫ÁöÑ');return;}
showDlg('Ê∏ÖÁ©∫‰ΩúÂùäÔºà'+count+'ÁØáÔºâ','‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰ΩúÂùä‰∏≠ÁöÑÊâÄÊúâ '+count+' ÁØáÊñáÁ´†ÂêóÔºü\n\nÂ∑≤Êî∂ËóèÁöÑÊñáÁ´†‰∏çÂèóÂΩ±ÂìçÔºå‰ΩÜÂª∫ËÆÆÂÖàÂØºÂá∫Â§á‰ªΩÔºÅ',()=>{
// ‰∫åÊ¨°Á°ÆËÆ§
setTimeout(()=>{
showDlg('ÂÜçÊ¨°Á°ÆËÆ§','ÁúüÁöÑË¶ÅÂà†Èô§Ëøô '+count+' ÁØáÊñáÁ´†ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ',()=>{
ws=[];sv(K.ws,ws);renderArticles();showToast('‰ΩúÂùäÂ∑≤Ê∏ÖÁ©∫');
},true);
},300);
},true);
}

// ==================== CREATE PAGE ====================
function switchCrTab(tab,el){
crTab=tab;
document.querySelectorAll('.cr-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderCrList();
}
function renderCrList(){
const list=document.getElementById('crList');
const filtered=crWorks.filter(w=>w.type===crTab);
if(filtered.length===0){
list.innerHTML='<div class="empty-st"><p>'+(crTab==='draft'?'ËøòÊ≤°ÊúâËçâÁ®ø<br>ÁÇπÂáª‰∏äÊñπ„ÄåÊñ∞Âª∫ËçâÁ®ø„ÄçÂºÄÂßãÂÜô‰Ωú':'ËøòÊ≤°ÊúâÂ∞èËØ¥<br>ÁÇπÂáª‰∏äÊñπ„ÄåÊñ∞Âª∫Â∞èËØ¥„ÄçÂºÄÂßãËøûËΩΩ')+'</p></div>';
return;
}
list.innerHTML='';
filtered.forEach(work=>{
const card=document.createElement('div');
card.className='cr-card';
let preview='';
if(work.type==='draft'){
preview=(work.content||'').replace(/\n/g,' ').substring(0,60);
}else{
const lastCh=work.chapters&&work.chapters.length>0?work.chapters[work.chapters.length-1]:'';
preview=(lastCh||'').replace(/\n/g,' ').substring(0,60);
}
const wc=getCrWordCount(work);
const time=work.updatedAt?new Date(work.updatedAt).toLocaleDateString():'';
const chInfo=work.type==='novel'&&work.chapters?' ¬∑ '+work.chapters.length+'Á´†':'';
card.innerHTML=
'<div class="cr-card-hd">'+
'<div class="cr-card-t">'+esc(work.title||'Êó†Ê†áÈ¢ò')+'</div>'+
'<span class="cr-card-badge '+work.type+'">'+(work.type==='draft'?'ËçâÁ®ø':'Â∞èËØ¥')+'</span>'+
'</div>'+
'<div class="cr-card-pv">'+esc(preview||'ÊöÇÊó†ÂÜÖÂÆπ')+'</div>'+
'<div class="cr-card-ft">'+
'<span class="cr-card-info">'+wc+'Â≠ó'+chInfo+' ¬∑ '+time+'</span>'+
'<div class="cr-card-acts">'+
'<button onclick="event.stopPropagation();copyCrWork(\''+work.id+'\')">Â§çÂà∂</button>'+
'<button onclick="event.stopPropagation();exportSingleCrWork(\''+work.id+'\')">ÂØºÂá∫</button>'+ '<button onclick="event.stopPropagation();shareCrToRes(\''+work.id+'\')">ÂàÜ‰∫´</button>'+ '<button class="danger" onclick="event.stopPropagation();deleteCrWork(\''+work.id+'\')">Âà†Èô§</button>'+
'</div>'+
'</div>';
card.onclick=e=>{if(!e.target.closest('.cr-card-acts'))openEditor(work.id);};
list.appendChild(card);
});
}
function getCrWordCount(work){
if(work.type==='draft')return countWords(work.content||'');
let total=0;
if(work.chapters)work.chapters.forEach(ch=>total+=countWords(ch));
return total;
}
function newDraft(){
const work={
id:uid(),type:'draft',title:'',content:'',
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
}
function newNovel(){
showInp('Êñ∞Âª∫Â∞èËØ¥','ÁªôÂ∞èËØ¥Ëµ∑‰∏™ÂêçÂ≠ó',name=>{
const work={
id:uid(),type:'novel',title:name,chapters:[''],
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
openEditor(work.id);
});
}
function deleteCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
showDlg('Âà†Èô§Á°ÆËÆ§','Á°ÆÂÆöË¶ÅÂà†Èô§„Äå'+(work.title||'Êó†Ê†áÈ¢ò')+'„ÄçÂêóÔºü‰∏çÂèØÊÅ¢Â§ç„ÄÇ',()=>{
crWorks=crWorks.filter(w=>w.id!==id);
sv('bj_crWorks',crWorks);
renderCrList();
showToast('Â∑≤Âà†Èô§');
},true);
}
function copyCrWork(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
let text='';
if(work.type==='draft'){
text=work.content||'';
}else if(work.chapters){
work.chapters.forEach((ch,i)=>{
text+='Á¨¨'+(i+1)+'Á´†\n\n'+ch+'\n\n';
});
}
const header='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n„Äå'+(work.title||'Êó†Ê†áÈ¢ò')+'„Äç\nÂéüÂàõ‰ΩúÂìÅ ¬∑ Á¨îËÆ∞AIÂàõ‰ΩúÈ°µ\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
const footer='\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nÂàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI '+APP_VER+'\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
doCopy(header+text.trim()+footer);
}

// ==================== EDITOR ====================
function openEditor(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
curEd=work;
curEdCh=0;
document.getElementById('edTitle').value=work.title||'';
if(work.type==='novel'){
document.getElementById('edChBar').style.display='flex';
document.getElementById('edTextarea').value=work.chapters[curEdCh]||'';
renderEdChBar();
}else{
document.getElementById('edChBar').style.display='none';
document.getElementById('edTextarea').value=work.content||'';
}
updateEdWc();
document.getElementById('edSaveStatus').textContent='Â∑≤‰øùÂ≠ò';
document.getElementById('edOutlineBtn').style.display=(work.outline?'':'none');
document.getElementById('edChOutlineBtn').style.display=(work.type==='novel'?'':'none');
document.getElementById('edModal').classList.add('show');
document.getElementById('bnav').classList.add('hide');
}
function closeEditor(){
saveEditorContent();
document.getElementById('edModal').classList.remove('show');
document.getElementById('bnav').classList.remove('hide');
curEd=null;
renderCrList();
}
function renderEdChBar(){
if(!curEd||curEd.type!=='novel')return;
const total=curEd.chapters.length;
document.getElementById('edChCurrent').textContent='Á¨¨'+(curEdCh+1)+'Á´† / ÂÖ±'+total+'Á´†';
document.getElementById('edPrevBtn').style.display=curEdCh>0?'':'none';
document.getElementById('edNextBtn').style.display=curEdCh<total-1?'':'none';
}
function openEdChList(){
if(!curEd||curEd.type!=='novel')return;
saveEditorChapter();
const total=curEd.chapters.length;
let totalWords=0;
curEd.chapters.forEach(ch=>totalWords+=countWords(ch||''));
document.getElementById('edChPanelTitle').textContent='„Äå'+(curEd.title||'Êú™ÂëΩÂêç')+'„Äç';
document.getElementById('edChPanelInfo').textContent='ÂÖ± '+total+' Á´† ¬∑ '+totalWords+' Â≠ó';
const list=document.getElementById('edChPanelList');
list.innerHTML='';
curEd.chapters.forEach((ch,i)=>{
const wc=countWords(ch||'');
const preview=(ch||'').replace(/\n/g,' ').substring(0,30);
const hasOutline=curEd.chOutlines&&curEd.chOutlines[i];
const item=document.createElement('div');
item.className='ch-item'+(i===curEdCh?' act':'');
item.innerHTML=
'<span class="ch-item-num" style="width:55px;flex-shrink:0">Á¨¨'+(i+1)+'Á´†</span>'+
'<span style="flex:1;font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(preview||'Á©∫ÁôΩÁ´†ËäÇ')+'</span>'+
'<span class="ch-item-wc" style="flex-shrink:0">'+wc+'Â≠ó'+(hasOutline?' üìã':'')+'</span>';
item.onclick=()=>{
curEdCh=i;
document.getElementById('edTextarea').value=curEd.chapters[i]||'';
updateEdWc();
renderEdChBar();
closeEdChList();
};
list.appendChild(item);
});
document.getElementById('edChOv').classList.add('show');
}
function closeEdChList(){
document.getElementById('edChOv').classList.remove('show');
}
function goEdPrevCh(){
if(!curEd||curEdCh<=0)return;
saveEditorChapter();
curEdCh--;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function goEdNextCh(){
if(!curEd||curEdCh>=curEd.chapters.length-1)return;
saveEditorChapter();
curEdCh++;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
}
function addEdChapter(){
if(!curEd)return;
saveEditorChapter();
curEd.chapters.push('');
if(!curEd.chOutlines)curEd.chOutlines=[];
curEd.chOutlines.push('');
curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value='';
updateEdWc();
renderEdChBar();
saveEditorContent();
closeEdChList();
showToast('Â∑≤Ê∑ªÂä†Á¨¨'+curEd.chapters.length+'Á´†');
}
function saveEditorChapter(){
if(!curEd)return;
const text=document.getElementById('edTextarea').value;
if(curEd.type==='novel'){
if(curEd.chapters[curEdCh]!==undefined)curEd.chapters[curEdCh]=text;
}else{
curEd.content=text;
}
}
function saveEditorContent(){
if(!curEd)return;
saveEditorChapter();
curEd.title=(document.getElementById('edTitle').value||'').trim();
curEd.updatedAt=new Date().toISOString();
const idx=crWorks.findIndex(w=>w.id===curEd.id);
if(idx>-1)crWorks[idx]=curEd;
sv('bj_crWorks',crWorks);
document.getElementById('edSaveStatus').textContent='Â∑≤‰øùÂ≠ò ‚úì';
}
function onEditorInput(){
updateEdWc();
document.getElementById('edSaveStatus').textContent='ÁºñËæë‰∏≠...';
if(edAutoSaveTimer)clearTimeout(edAutoSaveTimer);
edAutoSaveTimer=setTimeout(()=>{
saveEditorContent();
},2000);
}
function updateEdWc(){
const text=document.getElementById('edTextarea').value||'';
document.getElementById('edWc').textContent=countWords(text);
}
function copyEditorContent(){
if(!curEd)return;
saveEditorContent();
copyCrWork(curEd.id);
}
function formatEditorText(){
const ta=document.getElementById('edTextarea');
let text=ta.value||'';
// ÂÖàÊääÂ§ö‰∏™ËøûÁª≠Á©∫Ë°åÂêàÂπ∂Êàê‰∏Ä‰∏™
text=text.replace(/\n{3,}/g,'\n\n');
// ÊääÂçï‰∏™Êç¢Ë°åÔºàÊ≤°ÊúâÁ©∫Ë°åÂàÜÈöîÁöÑÊÆµËêΩÔºâÂèòÊàêÁ©∫Ë°åÂàÜÈöî
const lines=text.split('\n');
let result=[];
for(let i=0;i<lines.length;i++){
const line=lines[i];
result.push(line);
if(line.trim()&&i+1<lines.length&&lines[i+1].trim()){
result.push('');
}
}
text=result.join('\n');
text=text.replace(/\n{3,}/g,'\n\n');
text=text.trim();
ta.value=text;
onEditorInput();
showToast('ÊéíÁâàÂÆåÊàê ¬∂');
}
// ==================== AI REVIEW ====================
async function requestAIReview(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return;}
saveEditorContent();
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<20){showToast('ÂÜÖÂÆπÂ§™Â∞ëÔºåËá≥Â∞ëÂÜô20Â≠óÂÜçËØ∑AIËØÑ‰ª∑');return;}
const body=document.getElementById('aiReviewBody');
body.innerHTML='<div style="text-align:center;padding:20px;color:var(--text2)"><span class="ldots"><span></span><span></span><span></span></span><br>AIÊ≠£Âú®ÈòÖËØª‰Ω†ÁöÑ‰ΩúÂìÅ...</div>';
document.getElementById('aiReviewOv').classList.add('show');
const sysMsg='‰Ω†ÊòØ‰∏Ä‰ΩçËµÑÊ∑±ÁöÑÊñáÂ≠¶ÁºñËæëÂíåÂÜô‰ΩúÂØºÂ∏à„ÄÇËØ∑ÂØπÁî®Êà∑Êèê‰∫§ÁöÑÊñáÁ´†ËøõË°å‰∏ì‰∏öËØÑ‰ª∑ÔºåÂåÖÊã¨‰ª•‰∏ãÊñπÈù¢Ôºö\n1. Êï¥‰ΩìÂç∞Ë±°ÔºàÁÆÄÁü≠ÊÄªËØÑÔºâ\n2. ‰∫ÆÁÇπÔºàÂÜôÂæóÂ•ΩÁöÑÂú∞ÊñπÔºåÂÖ∑‰ΩìÊåáÂá∫Ôºâ\n3. ÂèØÊîπËøõ‰πãÂ§ÑÔºàÂÖ∑‰ΩìÊåáÂá∫ÈóÆÈ¢òÂπ∂ÁªôÂá∫‰øÆÊîπÂª∫ËÆÆÔºâ\n4. ÊñáÁ¨îËØÑÂàÜÔºà1-10ÂàÜÔºâ\n5. ‰∏ÄÂè•ËØùÈºìÂä±\n\nËØ∑Áî®Ê∏©ÂíåÂèãÂñÑ‰ΩÜ‰∏ì‰∏öÁöÑËØ≠Ê∞îÔºåÂÉè‰∏Ä‰ΩçÂ•ΩËÄÅÂ∏àÈÇ£Ê†∑ÁªôÂá∫Âª∫ËÆÆ„ÄÇ‰∏çË¶ÅÁ©∫Ê≥õÔºåË¶ÅÁªìÂêàÊñáÁ´†ÂÖ∑‰ΩìÂÜÖÂÆπÊù•ËØÑ‰ª∑„ÄÇ';
const chInfo=curEd.type==='novel'?'ÔºàËøôÊòØÁ¨¨'+(curEdCh+1)+'Á´†Ôºâ':'';
const userMsg='ËØ∑ËØÑ‰ª∑‰ª•‰∏ã‰ΩúÂìÅ'+chInfo+'Ôºö\n\nÊ†áÈ¢òÔºö'+(curEd.title||'Êó†Ê†áÈ¢ò')+'\n\nÊ≠£ÊñáÔºö\n'+text.substring(0,3000);
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
let reviewText='';
await callAPIStream(messages,
(fullText)=>{
reviewText=fullText;
body.textContent=fullText;
body.scrollTop=body.scrollHeight;
},
(fullText)=>{
if(fullText){
body.textContent=fullText;
}else{
body.innerHTML='<div style="color:var(--text2);text-align:center">ËØÑ‰ª∑Â∑≤ÂèñÊ∂à</div>';
}
},
(errMsg)=>{
body.textContent='Ëé∑ÂèñËØÑ‰ª∑Â§±Ë¥•Ôºö'+errMsg;
}
);
}
function closeAIReview(){
document.getElementById('aiReviewOv').classList.remove('show');
}
function shareCrToRes(id){
const work=crWorks.find(w=>w.id===id);
if(!work)return;
const wc=getCrWordCount(work);
if(wc<10){showToast('ÂÜÖÂÆπÂ§™Â∞ëÔºåËá≥Â∞ëÂÜô10Â≠óÂÜçÂàÜ‰∫´');return;}
showDlg('ÂàÜ‰∫´Âà∞ËµÑÊ∫ê','Â∞Ü„Äå'+(work.title||'Êó†Ê†áÈ¢ò')+'„ÄçÊâìÂåÖ‰∏∫ËµÑÊ∫êÂåÖÂπ∂ÂØºÂá∫Ôºü',()=>{
const packData=JSON.parse(JSON.stringify(work));
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:(work.title||'Êó†Ê†áÈ¢ò')+'_ÂàÜ‰∫´',
desc:(work.type==='draft'?'ËçâÁ®ø':'Â∞èËØ¥')+' ¬∑ '+wc+'Â≠ó',
author:'Á¨îËÆ∞AIÁî®Êà∑',
createdAt:new Date().toISOString(),
items:[{
type:'work',
name:(work.type==='draft'?'ËçâÁ®ø':'Â∞èËØ¥')+'Ôºö'+(work.title||'Êó†Ê†áÈ¢ò'),
data:packData
}]
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='Á¨îËÆ∞AI_ÂàÜ‰∫´_'+(work.title||'‰ΩúÂìÅ')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONÊñá‰ª∂',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
showToast('‰ΩúÂìÅÂ∑≤ÂØºÂá∫‰∏∫ËµÑÊ∫êÂåÖ üì§');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
});
}
// Á´†ËäÇÂ§ßÁ∫≤ÁÆ°ÁêÜ
function openChOutline(){
if(!curEd||curEd.type!=='novel')return;
if(!curEd.chOutlines)curEd.chOutlines=[];
const list=document.getElementById('chOutlineList');
list.innerHTML='';
curEd.chapters.forEach((_,i)=>{
const outline=curEd.chOutlines[i]||'';
const preview=(curEd.chapters[i]||'').replace(/\n/g,' ').substring(0,30);
const item=document.createElement('div');
item.className='ch-outline-item';
item.innerHTML=
'<div class="ch-outline-item-hdr"><span>Á¨¨'+(i+1)+'Á´†</span><span style="font-size:10px;color:var(--text2);font-weight:400">'+esc(preview)+'...</span></div>'+
'<textarea data-ch="'+i+'" placeholder="Êú¨Á´†Â§ßÁ∫≤Ôºö‰∏ªË¶Å‰∫ã‰ª∂„ÄÅÊÉÖÊÑüËΩ¨Êäò„ÄÅÂÖ≥ÈîÆ‰ø°ÊÅØ...">'+esc(outline)+'</textarea>';
list.appendChild(item);
});
document.getElementById('chOutlineOv').classList.add('show');
}
function closeChOutline(){
document.getElementById('chOutlineOv').classList.remove('show');
}
function saveChOutlines(){
if(!curEd)return;
if(!curEd.chOutlines)curEd.chOutlines=[];
document.querySelectorAll('#chOutlineList textarea').forEach(ta=>{
const ch=parseInt(ta.dataset.ch);
curEd.chOutlines[ch]=ta.value;
});
saveEditorContent();
closeChOutline();
showToast('Á´†ËäÇÂ§ßÁ∫≤Â∑≤‰øùÂ≠ò üìã');
}
function deleteEdChapter(){
if(!curEd||curEd.type!=='novel')return;
if(curEd.chapters.length<=1){showToast('Ëá≥Â∞ë‰øùÁïô‰∏ÄÁ´†');return;}
showDlg('Âà†Èô§Á´†ËäÇ','Á°ÆÂÆöË¶ÅÂà†Èô§Á¨¨'+(curEdCh+1)+'Á´†ÂêóÔºü‰∏çÂèØÊÅ¢Â§ç„ÄÇ',()=>{
curEd.chapters.splice(curEdCh,1);
if(curEdCh>=curEd.chapters.length)curEdCh=curEd.chapters.length-1;
document.getElementById('edTextarea').value=curEd.chapters[curEdCh]||'';
updateEdWc();
renderEdChBar();
saveEditorContent();
showToast('Â∑≤Âà†Èô§');
},true);
}
// ==================== RESOURCE ====================
function switchResTab(tab,el){
resTab=tab;
document.querySelectorAll('.res-tab').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
renderResList();
}
function renderResList(){
const list=document.getElementById('resList');
let items=[];
resPacks.forEach(pack=>{
if(pack.items&&Array.isArray(pack.items)){
pack.items.forEach(item=>{
item._packName=pack.name||'Êú™ÂëΩÂêçËµÑÊ∫êÂåÖ';
item._packId=pack.id;
items.push(item);
});
}
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
if(items.length===0){
const tips={
all:'ËøòÊ≤°ÊúâËµÑÊ∫ê<br>ÁÇπÂáª„ÄåÊâìÂåÖÂØºÂá∫„ÄçÂàÜ‰∫´‰Ω†ÁöÑËÆæÂÆöÔºåÊàñ„ÄåÂØºÂÖ•ËµÑÊ∫êÂåÖ„ÄçËé∑ÂèñÂà´‰∫∫ÁöÑ',
char:'Ê≤°Êúâ‰∫∫Áâ©ËÆæÂÆöËµÑÊ∫ê',world:'Ê≤°Êúâ‰∏ñÁïåËßÇËµÑÊ∫ê',
style:'Ê≤°ÊúâÊñáÈ£éËµÑÊ∫ê',rule:'Ê≤°ÊúâËßÑÂàôËµÑÊ∫ê',work:'Ê≤°Êúâ‰ΩúÂìÅËµÑÊ∫ê',exp:'Ê≤°ÊúâÁªèÈ™åÂàÜ‰∫´'
};
list.innerHTML='<div class="empty-st"><p>'+(tips[resTab]||tips.all)+'</p></div>';
return;
}
list.innerHTML='';
items.forEach((item,idx)=>{
const card=document.createElement('div');
card.className='res-card';
const typeLabels={char:'‰∫∫Áâ©ËÆæÂÆö',world:'‰∏ñÁïåËßÇ',style:'ÊñáÈ£é',rule:'ËßÑÂàô',work:'‰ΩúÂìÅ',exp:'ÁªèÈ™åÂàÜ‰∫´'};
const preview=getResPreview(item);
card.innerHTML=
'<div class="res-card-hd">'+
'<div class="res-card-t">'+esc(item.name||'Êú™ÂëΩÂêç')+'</div>'+
'<span class="res-card-type '+item.type+'">'+(typeLabels[item.type]||'ÂÖ∂‰ªñ')+'</span>'+
'</div>'+
'<div class="res-card-pv">'+esc(preview)+'</div>'+
'<div class="res-card-ft">'+
'<span class="res-card-info">Êù•Ëá™Ôºö'+esc(item._packName)+'</span>'+
'<div class="res-card-acts">'+
'<button class="use" onclick="event.stopPropagation();applyResItem(\''+item._packId+'\','+idx+')">Â∫îÁî®</button>'+
'<button onclick="event.stopPropagation();copyResItem(\''+item._packId+'\','+idx+')">Â§çÂà∂</button>'+
'</div>'+
'</div>';
list.appendChild(card);
});
if(resPacks.length>0){
const mgr=document.createElement('div');
mgr.style.cssText='margin-top:16px;padding-top:14px;border-top:1px solid var(--border)';
mgr.innerHTML='<div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px">Â∑≤ÂØºÂÖ•ÁöÑËµÑÊ∫êÂåÖ</div>';
resPacks.forEach(pack=>{
const pDiv=document.createElement('div');
pDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg);border-radius:9px;border:1px solid var(--border);margin-bottom:7px';
const count=pack.items?pack.items.length:0;
const time=pack.createdAt?new Date(pack.createdAt).toLocaleDateString():'';
pDiv.innerHTML=
'<div><div style="font-size:12px;font-weight:600">'+esc(pack.name||'Êú™ÂëΩÂêç')+'</div>'+
'<div style="font-size:9px;color:var(--text2);margin-top:2px">'+count+'È°πËµÑÊ∫ê ¬∑ '+time+'</div></div>'+
'<button style="padding:4px 10px;border-radius:7px;border:1px solid rgba(255,107,107,.3);background:transparent;color:var(--danger);font-size:9px;cursor:pointer" onclick="deleteResPack(\''+pack.id+'\')">Âà†Èô§</button>';
mgr.appendChild(pDiv);
});
list.appendChild(mgr);
}
}
function getResPreview(item){
if(item.type==='char'){
const chars=item.data||[];
return chars.map(c=>(c.name||'Êú™ÂëΩÂêç')+'Ôºö'+(c.desc||'').substring(0,30)).join('Ôºõ');
}
if(item.type==='world')return (item.data||'').substring(0,80);
if(item.type==='style')return (item.data||'').substring(0,80);
if(item.type==='rule')return (item.data||'').substring(0,80);
if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')return (w.content||'').substring(0,80);
if(w.chapters&&w.chapters.length>0)return (w.chapters[0]||'').substring(0,80);
return 'ÊöÇÊó†ÂÜÖÂÆπ';
}
if(item.type==='exp')return (item.data||'').substring(0,80);
return '';
}
function applyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
if(item.type==='char'){
showDlg('Â∫îÁî®‰∫∫Áâ©ËÆæÂÆö','Â∞ÜË¶ÜÁõñÂΩìÂâçÁöÑ‰∫∫Áâ©ËÆæÂÆöÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
characters=JSON.parse(JSON.stringify(item.data||[{name:'',desc:''}]));
sv(K.curChars,characters);
showToast('‰∫∫Áâ©ËÆæÂÆöÂ∑≤Â∫îÁî® ‚úÖ');
});
}else if(item.type==='world'){
showDlg('Â∫îÁî®‰∏ñÁïåËßÇ','Â∞ÜË¶ÜÁõñÂΩìÂâçÁöÑ‰∏ñÁïåËßÇËÆæÂÆöÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
document.getElementById('worldDesc').value=item.data||'';
saveCurSettings();
showToast('‰∏ñÁïåËßÇÂ∑≤Â∫îÁî® ‚úÖ');
});
}else if(item.type==='style'){
showDlg('Â∫îÁî®ÊñáÈ£é','Â∞ÜË¶ÜÁõñÂΩìÂâçÁöÑÊñáÈ£éËÆæÁΩÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
document.getElementById('styleDesc').value=item.data||'';
ap.curStyle=item.data||'';
sv(K.ap,ap);
showToast('ÊñáÈ£éÂ∑≤Â∫îÁî® ‚úÖ');
});
}else if(item.type==='rule'){
showDlg('Â∫îÁî®ËßÑÂàô','Â∞ÜË¶ÜÁõñÂΩìÂâçÁöÑËßÑÂàôËÆæÁΩÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
document.getElementById('ruleDesc').value=item.data||'';
curRule=item.data||'';
sv('bj_curRule',curRule);
showToast('ËßÑÂàôÂ∑≤Â∫îÁî® ‚úÖ');
});
}else if(item.type==='work'){
showDlg('ÂØºÂÖ•‰ΩúÂìÅ','Â∞ÜÊ∑ªÂä†Âà∞‰Ω†ÁöÑÂàõ‰ΩúÈ°µÈù¢ÔºåÊòØÂê¶ÁªßÁª≠Ôºü',()=>{
const w=JSON.parse(JSON.stringify(item.data));
w.id=uid();
w.createdAt=new Date().toISOString();
w.updatedAt=new Date().toISOString();
crWorks.unshift(w);
sv('bj_crWorks',crWorks);
showToast('‰ΩúÂìÅÂ∑≤ÂØºÂÖ•Âà∞Âàõ‰ΩúÈ°µ ‚úÖ');
});
}else if(item.type==='exp'){
showDlg('Êü•ÁúãÁªèÈ™å','ÊòØÂê¶Â§çÂà∂ËøôÊù°ÁªèÈ™åÂàÜ‰∫´Âà∞Ââ™Ë¥¥ÊùøÔºü',()=>{
doCopy(item.data||'');
});
}
}
function copyResItem(packId,globalIdx){
let items=[];
resPacks.forEach(pack=>{
if(pack.items)pack.items.forEach(item=>{
item._packId=pack.id;
items.push(item);
});
});
if(resTab!=='all')items=items.filter(it=>it.type===resTab);
const item=items[globalIdx];
if(!item)return;
let text='';
if(item.type==='char'){
const chars=item.data||[];
text=chars.map(c=>'„Äê'+c.name+'„Äë\n'+c.desc).join('\n\n');
}else if(item.type==='rule'){
text=item.data||'';
}else if(item.type==='work'){
const w=item.data||{};
if(w.type==='draft')text=w.content||'';
else if(w.chapters)text=w.chapters.map((ch,i)=>'Á¨¨'+(i+1)+'Á´†\n\n'+ch).join('\n\n');
}else{
text=item.data||'';
}
doCopy(text);
}

// ==================== RESOURCE EXPORT ====================
function openResExport(){
const box=document.getElementById('resExpList');
box.innerHTML='';
const exportItems=[];
saveCharactersFromUI();
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
exportItems.push({id:'cur_char',type:'char',label:'ÂΩìÂâç‰∫∫Áâ©ËÆæÂÆö',desc:validChars.map(c=>c.name).filter(Boolean).join('„ÄÅ')||'Êú™ÂëΩÂêçËßíËâ≤',data:validChars});
}
charP.forEach((p,i)=>{
exportItems.push({id:'charP_'+i,type:'char',label:'‰∫∫Áâ©È¢ÑËÆæÔºö'+p.name,desc:(p.characters||[]).map(c=>c.name).filter(Boolean).join('„ÄÅ'),data:p.characters});
});
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD){
exportItems.push({id:'cur_world',type:'world',label:'ÂΩìÂâç‰∏ñÁïåËßÇ',desc:wD.substring(0,40),data:wD});
}
worldP.forEach((p,i)=>{
exportItems.push({id:'worldP_'+i,type:'world',label:'‰∏ñÁïåËßÇÈ¢ÑËÆæÔºö'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const sD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||'').trim();
if(sD){
exportItems.push({id:'cur_style',type:'style',label:'ÂΩìÂâçÊñáÈ£é',desc:sD.substring(0,40),data:sD});
}
styleP.forEach((p,i)=>{
exportItems.push({id:'styleP_'+i,type:'style',label:'ÊñáÈ£éÈ¢ÑËÆæÔºö'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
const rD=(document.getElementById('ruleDesc')&&document.getElementById('ruleDesc').value||'').trim();
if(rD){
exportItems.push({id:'cur_rule',type:'rule',label:'ÂΩìÂâçËßÑÂàô',desc:rD.substring(0,40),data:rD});
}
ruleP.forEach((p,i)=>{
exportItems.push({id:'ruleP_'+i,type:'rule',label:'ËßÑÂàôÈ¢ÑËÆæÔºö'+p.name,desc:(p.desc||'').substring(0,40),data:p.desc});
});
crWorks.forEach(w=>{
exportItems.push({id:'work_'+w.id,type:'work',label:(w.type==='draft'?'ËçâÁ®ø':'Â∞èËØ¥')+'Ôºö'+(w.title||'Êó†Ê†áÈ¢ò'),desc:getCrWordCount(w)+'Â≠ó',data:w});
});
if(exportItems.length===0){
box.innerHTML='<p style="font-size:12px;color:var(--text2);text-align:center;padding:20px">Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂÜÖÂÆπ<br>ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†‰∫∫Áâ©/‰∏ñÁïåËßÇ/ÊñáÈ£éÔºåÊàñÂú®Âàõ‰ΩúÈ°µÂÜôÁÇπ‰∏úË•ø</p>';
document.getElementById('resExpOv').classList.add('show');
return;
}
const typeLabels={char:'üë§ ‰∫∫Áâ©',world:'üåç ‰∏ñÁïåËßÇ',style:'‚úíÔ∏è ÊñáÈ£é',rule:'üìú ËßÑÂàô',work:'üìÑ ‰ΩúÂìÅ'};
exportItems.forEach(item=>{
const div=document.createElement('div');
div.className='res-chk-item';
div.dataset.resId=item.id;
div.dataset.resType=item.type;
div.dataset.resData=JSON.stringify(item.data);
div.dataset.resLabel=item.label;
div.onclick=()=>{div.classList.toggle('checked');};
div.innerHTML=
'<div class="res-chk-box">‚úì</div>'+
'<div class="res-chk-info">'+
'<div class="res-chk-name">'+(typeLabels[item.type]||'')+' '+esc(item.label)+'</div>'+
'<div class="res-chk-desc">'+esc(item.desc)+'</div>'+
'</div>';
box.appendChild(div);
});
document.getElementById('resPackName').value='';
document.getElementById('resPackDesc').value='';
document.getElementById('resExpOv').classList.add('show');
}
function closeResExport(){
document.getElementById('resExpOv').classList.remove('show');
}
function doResExport(){
const checked=document.querySelectorAll('#resExpList .res-chk-item.checked');
if(checked.length===0){showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÈ°π');return;}
const items=[];
checked.forEach(el=>{
items.push({
type:el.dataset.resType,
name:el.dataset.resLabel,
data:JSON.parse(el.dataset.resData)
});
});
const packName=(document.getElementById('resPackName').value||'').trim()||'ËµÑÊ∫êÂåÖ';
const packDesc=(document.getElementById('resPackDesc').value||'').trim();
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:packName,
desc:packDesc,
author:'Á¨îËÆ∞AIÁî®Êà∑',
createdAt:new Date().toISOString(),
items:items
};
const jsonStr=JSON.stringify(pack,null,2);
const fileName='Á¨îËÆ∞AI_ËµÑÊ∫ê_'+packName+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.json';
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:fileName,
types:[{description:'JSONÊñá‰ª∂',accept:{'application/json':['.json']}}]
});
const writable=await handle.createWritable();
await writable.write(jsonStr);
await writable.close();
closeResExport();
showToast('ËµÑÊ∫êÂåÖÂ∑≤ÂØºÂá∫ üì§');
}catch(e){
if(e.name!=='AbortError')fallbackResExport(jsonStr,fileName);
}
})();
return;
}
fallbackResExport(jsonStr,fileName);
}
function fallbackResExport(jsonStr,fileName){
const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(jsonStr);
const a=document.createElement('a');
a.href=dataUri;a.download=fileName;
a.style.display='none';
document.body.appendChild(a);a.click();
setTimeout(()=>{document.body.removeChild(a);},500);
closeResExport();
showToast('ËµÑÊ∫êÂåÖÂ∑≤ÂØºÂá∫ üì§');
}
function writeExpShare(){
document.getElementById('expTitle').value='';
document.getElementById('expContent').value='';
document.getElementById('expOv').classList.add('show');
setTimeout(()=>document.getElementById('expTitle').focus(),100);
}
function closeExpDlg(){
document.getElementById('expOv').classList.remove('show');
}
function saveExpShare(){
const title=(document.getElementById('expTitle').value||'').trim();
const content=(document.getElementById('expContent').value||'').trim();
if(!title){showToast('ËØ∑ËæìÂÖ•Ê†áÈ¢ò');return;}
if(!content){showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');return;}
const pack={
_app:'bijiAI_resource',
_ver:APP_VER,
id:uid(),
name:title,
desc:'ÁªèÈ™åÂàÜ‰∫´',
author:'Á¨îËÆ∞AIÁî®Êà∑',
createdAt:new Date().toISOString(),
items:[{type:'exp',name:title,data:content}]
};
resPacks.unshift(pack);
sv('bj_resPacks',resPacks);
closeExpDlg();
renderResList();
showToast('ÁªèÈ™åÂ∑≤‰øùÂ≠ò ‚úÖ');
}
function deleteResPack(id){
const pack=resPacks.find(p=>p.id===id);
if(!pack)return;
showDlg('Âà†Èô§ËµÑÊ∫êÂåÖ','Á°ÆÂÆöË¶ÅÂà†Èô§„Äå'+(pack.name||'Êú™ÂëΩÂêç')+'„ÄçÂêóÔºü',()=>{
resPacks=resPacks.filter(p=>p.id!==id);
sv('bj_resPacks',resPacks);
renderResList();
showToast('ËµÑÊ∫êÂåÖÂ∑≤Âà†Èô§');
},true);
}
function importResPack(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data._app!=='bijiAI_resource'||!data.items){
showToast('Ëøô‰∏çÊòØÊúâÊïàÁöÑËµÑÊ∫êÂåÖÊñá‰ª∂',3000);return;
}
const existing=resPacks.findIndex(p=>p.id===data.id);
if(existing>-1){
showDlg('ÈáçÂ§çËµÑÊ∫êÂåÖ','Â∑≤Â≠òÂú®ÂêåÂêçËµÑÊ∫êÂåÖ„Äå'+(data.name||'')+'„ÄçÔºåÊòØÂê¶Ë¶ÜÁõñÔºü',()=>{
resPacks[existing]=data;
sv('bj_resPacks',resPacks);
renderResList();
showToast('ËµÑÊ∫êÂåÖÂ∑≤Êõ¥Êñ∞ üì•');
});
}else{
resPacks.unshift(data);
sv('bj_resPacks',resPacks);
renderResList();
const count=data.items.length;
showToast('Â∑≤ÂØºÂÖ•„Äå'+(data.name||'ËµÑÊ∫êÂåÖ')+'„Äç('+count+'È°π) üì•');
}
}catch(err){showToast('Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: '+err.message,3000);}
};
reader.readAsText(file);
e.target.value='';
}
// ==================== HANDBOOK ====================
function openHandbook(){
document.getElementById('hbOv').classList.add('show');
}
function closeHandbook(){
document.getElementById('hbOv').classList.remove('show');
}
// ==================== USER CARD ====================
function renderUserCard(){
const uc=userCard;
const nameEl=document.getElementById('ucName');
const bioEl=document.getElementById('ucBio');
const avatarEl=document.getElementById('ucAvatar');
nameEl.textContent=uc.name||'ÁÇπÂáªËÆæÁΩÆÊòµÁß∞';
bioEl.textContent=uc.bio||'ÁÇπÂáªÊ∑ªÂä†‰∏™‰∫∫ÁÆÄ‰ªã...';
if(uc.avatar){
avatarEl.innerHTML='<img src="'+uc.avatar+'" alt="Â§¥ÂÉè"><div class="ucard-avatar-hint">Êõ¥Êç¢</div>';
}else{
avatarEl.innerHTML='<span id="ucAvatarPh">‚ú¶</span><div class="ucard-avatar-hint">Êõ¥Êç¢</div>';
}
updateStats();
}
function getStorageUsage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total;
}

function getStorageUsage(){
let total=0;
for(let key in localStorage){
if(localStorage.hasOwnProperty(key)){
total+=localStorage[key].length*2;
}
}
return total;
}

function checkStorageHealth(){
const used=getStorageUsage();
const usedMB=(used/1024/1024).toFixed(2);
const percent=(used/(5*1024*1024)*100).toFixed(1);
if(percent>80){
showToast('‚ö†Ô∏è Â≠òÂÇ®Â∑≤Áî®'+percent+'%ÔºåÂª∫ËÆÆÂØºÂá∫Â§á‰ªΩ',4000);
}
return {used,usedMB,percent};
}

function updateStats(){
let totalWords=0;
let worksCount=0;
// ‰ΩúÂùäÊñáÁ´†
ws.forEach(a=>{totalWords+=getTotalWords(a);});
worksCount+=ws.length;
// Âàõ‰Ωú‰ΩúÂìÅ
crWorks.forEach(w=>{totalWords+=getCrWordCount(w);});
worksCount+=crWorks.length;
// Êî∂ËóèÈáåÁã¨ÊúâÁöÑÔºà‰∏çÂú®‰ΩúÂùäÈáåÁöÑÔºâ
cols.books.forEach(b=>{
if(!ws.find(a=>a.id===b.id))totalWords+=getTotalWords(b);
});
cols.shorts.forEach(s=>{
if(!ws.find(a=>a.id===s.id))totalWords+=getTotalWords(s);
});
const colsCount=cols.books.length+cols.shorts.length;
// Á¨îËÆ∞ÊÄªÊï∞
let notesCount=0;
const allIds=new Set();
[...ws,...cols.books,...cols.shorts].forEach(a=>allIds.add(a.id));
allIds.forEach(id=>{
const n=ld('bj_notes_'+id,[]);
notesCount+=n.length;
});
document.getElementById('statTotal').textContent=formatNum(totalWords);
document.getElementById('statWorks').textContent=worksCount;
document.getElementById('statCols').textContent=colsCount;
document.getElementById('statNotes').textContent=notesCount;
}
async function updateStorageDisplay(){
    try{
        const info = await getDBStorageUsage();
        document.getElementById('storagePercent').textContent = info.percent + '%';
        document.getElementById('storageBar').style.width = Math.min(info.percent, 100) + '%';
        document.getElementById('storageDetail').textContent = 'Â∑≤Áî® ' + info.usedMB + 'MB / 50MB (IndexedDB)';
        // Ê†πÊçÆ‰ΩøÁî®ÈáèÂèòËâ≤
        const bar = document.getElementById('storageBar');
        if (info.percent > 90) bar.style.background = 'var(--danger)';
        else if (info.percent > 70) bar.style.background = '#f0a030';
        else bar.style.background = 'linear-gradient(90deg,var(--accent),var(--accent2))';
    } catch(e) {
        console.warn('Â≠òÂÇ®‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•:', e);
    }
}
function formatNum(n){
if(n>=10000)return (n/10000).toFixed(1)+'‰∏á';
if(n>=1000)return (n/1000).toFixed(1)+'k';
return n;
}
function uploadAvatar(){
document.getElementById('avatarUp').click();
}
function handleAvatarUpload(e){
const file=e.target.files[0];
if(!file)return;
const canvas=document.createElement('canvas');
const img=new Image();
img.onload=()=>{
const size=120;
canvas.width=size;canvas.height=size;
const ctx=canvas.getContext('2d');
const min=Math.min(img.width,img.height);
const sx=(img.width-min)/2;
const sy=(img.height-min)/2;
ctx.drawImage(img,sx,sy,min,min,0,0,size,size);
const dataUrl=canvas.toDataURL('image/jpeg',0.8);
userCard.avatar=dataUrl;
sv('bj_userCard',userCard);
renderUserCard();
showToast('Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞ üé®');
};
img.src=URL.createObjectURL(file);
e.target.value='';
}
function editUcName(){
showInp('ËÆæÁΩÆÊòµÁß∞','ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞',name=>{
userCard.name=name;
sv('bj_userCard',userCard);
renderUserCard();
showToast('ÊòµÁß∞Â∑≤Êõ¥Êñ∞');
});
}
function editUcBio(){
const ov=document.getElementById('inpOv');
document.getElementById('inpTitle').textContent='ÁºñËæëÁÆÄ‰ªã';
const f=document.getElementById('inpField');
f.placeholder='ÂÜô‰∏ÄÂè•ËØù‰ªãÁªçËá™Â∑±...';
f.value=userCard.bio||'';
document.getElementById('inpOkBtn').onclick=()=>{
userCard.bio=f.value.trim();
sv('bj_userCard',userCard);
closeInp();
renderUserCard();
showToast('ÁÆÄ‰ªãÂ∑≤Êõ¥Êñ∞');
};
ov.classList.add('show');
setTimeout(()=>f.focus(),100);
}
// ==================== OUTLINE GENERATOR ====================
let outlineChCount=10;
let outlineText='';
function openOutlineGen(){
document.getElementById('outlineTitle').value='';
document.getElementById('outlineDesc').value='';
document.getElementById('outlineResult').style.display='none';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineGenBtn').style.display='';
document.getElementById('outlineGenBtn').disabled=false;
document.getElementById('outlineGenBtn').textContent='üß† ÁîüÊàêÂ§ßÁ∫≤';
outlineText='';
document.getElementById('outlineOv').classList.add('show');
setTimeout(()=>document.getElementById('outlineDesc').focus(),200);
}
function closeOutlineGen(){
document.getElementById('outlineOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
function setOutlineCh(n,el){
outlineChCount=n;
el.parentElement.querySelectorAll('.tag').forEach(t=>t.classList.remove('act'));
el.classList.add('act');
}
async function doGenOutline(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return;}
const desc=(document.getElementById('outlineDesc').value||'').trim();
const title=(document.getElementById('outlineTitle').value||'').trim();
if(!desc){showToast('ËØ∑ÊèèËø∞‰∏Ä‰∏ã‰Ω†ÊÉ≥ÂÜôÁöÑÊïÖ‰∫ã');return;}
const btn=document.getElementById('outlineGenBtn');
btn.disabled=true;
btn.innerHTML='ÁîüÊàê‰∏≠ <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('outlineResult').style.display='block';
document.getElementById('outlineActions').style.display='none';
document.getElementById('outlineContent').textContent='Ê≠£Âú®ÊûÑÊÄùÂ§ßÁ∫≤...';
let sysMsg='‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂ∞èËØ¥Á≠ñÂàíÁºñËæëÔºåÊìÖÈïøÊûÑÂª∫ÊïÖ‰∫ãÊû∂ÊûÑÂíåÁ´†ËäÇÂ§ßÁ∫≤„ÄÇ\n';
sysMsg+='ËØ∑Ê†πÊçÆÁî®Êà∑ÁöÑÊèèËø∞ÔºåÁîüÊàê‰∏Ä‰ªΩËØ¶ÁªÜÁöÑÂ∞èËØ¥Â§ßÁ∫≤„ÄÇ\n\n';
sysMsg+='„ÄêËæìÂá∫Ê†ºÂºèË¶ÅÊ±Ç„Äë\n';
sysMsg+='Á¨¨‰∏ÄË°åÔºöÂ∞èËØ¥Ê†áÈ¢òÔºàÁ∫ØÊñáÂ≠óÔºâ\n';
sysMsg+='Á¨¨‰∫åË°åÔºöÁ©∫Ë°å\n';
sysMsg+='Á¨¨‰∏âË°åÔºö‰∏ÄÂè•ËØùÊïÖ‰∫ãÁÆÄ‰ªã\n';
sysMsg+='Á¨¨ÂõõË°åÔºöÁ©∫Ë°å\n';
sysMsg+='ÁÑ∂ÂêéÈÄêÁ´†ÂàóÂá∫Â§ßÁ∫≤ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö\n';
sysMsg+='Á¨¨XÁ´†ÔºöÁ´†ËäÇÊ†áÈ¢ò\n';
sysMsg+='- Êú¨Á´†Ê¶ÇË¶ÅÔºà2-3Âè•ËØùÊèèËø∞Êú¨Á´†‰∏ªË¶ÅÂÜÖÂÆπ„ÄÅÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅÊÉÖÊÑüËΩ¨ÊäòÔºâ\n\n';
sysMsg+='Ë¶ÅÊ±ÇÔºö\n';
sysMsg+='- ÂÖ±'+outlineChCount+'Á´†\n';
sysMsg+='- ÊïÖ‰∫ãÁ∫øË¶ÅÂÆåÊï¥ÔºàÂºÄÁ´Ø‚ÜíÂèëÂ±ï‚ÜíÈ´òÊΩÆ‚ÜíÁªìÂ±ÄÔºâ\n';
sysMsg+='- ÊØèÁ´†‰πãÈó¥Ë¶ÅÊúâÂõ†ÊûúÂÖ≥Á≥ªÂíåÈÄíËøõ\n';
sysMsg+='- Ê≥®ÊÑè‰ºèÁ¨îÂíåÊÇ¨ÂøµÁöÑËÆæÁΩÆ\n';
sysMsg+='- ‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÂÜÖÂÆπ\n';
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0){
sysMsg+='\n„ÄêÂèØÁî®ËßíËâ≤„Äë\n';
validChars.forEach((c,i)=>{
sysMsg+='ËßíËâ≤'+(i+1)+'Ôºö'+(c.name||'Êú™ÂëΩÂêç');
if(c.desc)sysMsg+='Ôºà'+c.desc.substring(0,60)+'Ôºâ';
sysMsg+='\n';
});
}
const wD=(document.getElementById('worldDesc').value||'').trim();
if(wD)sysMsg+='\n„Äê‰∏ñÁïåËßÇ„Äë\n'+wD.substring(0,300)+'\n';
let userMsg='ËØ∑‰∏∫‰ª•‰∏ãÊïÖ‰∫ãÁîüÊàê'+outlineChCount+'Á´†ÁöÑËØ¶ÁªÜÂ§ßÁ∫≤Ôºö\n\n';
if(title)userMsg+='Ê†áÈ¢òÊñπÂêëÔºö'+title+'\n';
userMsg+='ÊïÖ‰∫ãÊèèËø∞Ôºö'+desc;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const contentEl=document.getElementById('outlineContent');
outlineText='';
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outlineText=fullText;
contentEl.textContent=fullText;
contentEl.parentElement.scrollTop=contentEl.parentElement.scrollHeight;
},
(fullText)=>{
btn.disabled=false;btn.textContent='üß† ÁîüÊàêÂ§ßÁ∫≤';
if(fullText){
outlineText=fullText;
contentEl.textContent=fullText;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='ÁîüÊàêÂ∑≤ÂèñÊ∂à';
}
},
(errMsg)=>{
btn.disabled=false;btn.textContent='üß† ÁîüÊàêÂ§ßÁ∫≤';
contentEl.textContent='ÁîüÊàêÂ§±Ë¥•Ôºö'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;btn.textContent='üß† ÁîüÊàêÂ§ßÁ∫≤';
if(result){
outlineText=result;
contentEl.textContent=result;
btn.style.display='none';
document.getElementById('outlineActions').style.display='block';
}else{
contentEl.textContent='ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆ';
}
}
}
function applyOutline(){
if(!outlineText){showToast('Ê≤°ÊúâÂ§ßÁ∫≤ÂÜÖÂÆπ');return;}
let title='';
const lines=outlineText.split('\n');
for(let i=0;i<Math.min(3,lines.length);i++){
const l=lines[i].trim();
if(l&&l.length<40&&!l.startsWith('-')&&!l.startsWith('Á¨¨')){
title=l.replace(/^[#*„Ää„Äå„Äê\s:ÔºöÊ†áÈ¢ò]+/,'').replace(/[„Äã„Äç„Äë\s]+$/,'').trim();
break;
}
}
const inputTitle=(document.getElementById('outlineTitle').value||'').trim();
if(inputTitle)title=inputTitle;
if(!title)title='Êú™ÂëΩÂêçÂ∞èËØ¥';
const work={
id:uid(),type:'novel',title:title,
chapters:[''],
outline:outlineText,
createdAt:new Date().toISOString(),
updatedAt:new Date().toISOString()
};
crWorks.unshift(work);
sv('bj_crWorks',crWorks);
closeOutlineGen();
openEditor(work.id);
showToast('Â∞èËØ¥Â∑≤ÂàõÂª∫ÔºåÂ§ßÁ∫≤Â∑≤‰øùÂ≠ò üìã');
}
// ==================== AI REWRITE ====================
async function aiRewriteChapter(){
if(!curEd)return;
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return;}
const text=document.getElementById('edTextarea').value||'';
if(countWords(text)<10){showToast('ÂΩìÂâçÁ´†ËäÇÂÜÖÂÆπÂ§™Â∞ëÔºåËá≥Â∞ë10Â≠óÊâçËÉΩÈáçÂÜô');return;}
showDlg('AIÈáçÂÜôÁ°ÆËÆ§','AIÂ∞ÜÈáçÊñ∞ÊîπÂÜôÂΩìÂâçÁ´†ËäÇÂÜÖÂÆπÔºåÂéüÂÜÖÂÆπ‰ºöË¢´ÊõøÊç¢„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü',async()=>{
const ta=document.getElementById('edTextarea');
const statusEl=document.getElementById('edSaveStatus');
statusEl.textContent='AIÈáçÂÜô‰∏≠...';
ta.disabled=true;
let sysMsg='‰Ω†ÊòØ‰∏Ä‰ΩçÁªèÈ™å‰∏∞ÂØåÁöÑÊñáÂ≠¶ÁºñËæëÂÖºÊîπÁ®ø‰∫∫„ÄÇ‰Ω†ÁöÑÂ∑•‰ΩúÊòØÂ∞Ü‰∏ÄÁØáÊúâÊΩúÂäõ‰ΩÜÁ≤óÁ≥ôÁöÑÂàùÁ®øÔºåÊâìÁ£®Êàê‰∏ÄÁØáËÆ©‰∫∫ËØª‰∫Ü‰ºöËµ∑È∏°ÁöÆÁñôÁò©ÁöÑÂ•ΩÊñáÁ´†„ÄÇ\n\n';
sysMsg+='‰Ω†ÁöÑÊîπÁ®øÂéüÂàôÔºö\n';
sysMsg+='1. ÂâßÊÉÖÈ™®Êû∂‰∏çÂä®‚Äî‚Äî‰øùÁïôÊâÄÊúâÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅ‰∫∫Áâ©ÂÖ≥Á≥ª„ÄÅÊÉÖËäÇËµ∞Âêë\n';
sysMsg+='2. Ë°ÄËÇâÂÖ®ÈÉ®ÈáçÂ°ë‚Äî‚ÄîÊØè‰∏ÄÂè•ËØùÈÉΩÁî®Êõ¥Á≤æÂáÜ„ÄÅÊõ¥ÊúâÁîªÈù¢ÊÑüÁöÑÊñπÂºèÈáçÊñ∞Ë°®Ëææ\n';
sysMsg+='3. Ë°•ÂÖÖÂéüÊñáÁº∫Â§±ÁöÑÔºöÊÑüÂÆòÁªÜËäÇÔºàÊ∞îÂë≥„ÄÅËß¶ÊÑü„ÄÅÂ£∞Èü≥Ôºâ„ÄÅÂæÆË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÊ∞õÂõ¥„ÄÅÊΩúÂè∞ËØç\n';
sysMsg+='4. ‰øÆÂ§çÂéüÊñáÁöÑÈóÆÈ¢òÔºöÂà†Èô§Á©∫Ê¥ûÂΩ¢ÂÆπËØç„ÄÅÊ∂àÁÅ≠‰∏áËÉΩÂâØËØç„ÄÅÊâìÁ†¥ÈáçÂ§çÂè•Âºè„ÄÅËÆ©ÂØπËØùÊõ¥Âè£ËØ≠Âåñ\n';
sysMsg+='5. ÊèêÂçáËäÇÂ•èÊÑüÔºöÁ¥ßÂº†Â§ÑÂä†ÈÄüÔºàÁü≠Âè•„ÄÅÊñ≠Âè•ÔºâÔºåËàíÁºìÂ§ÑÂáèÈÄüÔºàÈïøÂè•„ÄÅÁªÜÊèèÔºâ\n';
sysMsg+='6. Â≠óÊï∞Â∫î‰∏çÂ∞ë‰∫éÂéüÊñáÔºåÂõ†‰∏∫Â•ΩÁöÑÊîπÂÜôÈÄöÂ∏∏‰ºöÊõ¥‰∏∞Êª°\n';
sysMsg+='7. Áõ¥Êé•ËæìÂá∫ÊîπÂÜôÂêéÁöÑÊ≠£ÊñáÔºå‰∏çÂä†‰ªª‰ΩïËØ¥Êòé„ÄÅÊ†áÈ¢ò„ÄÅÁ´†ËäÇÂè∑„ÄÅmarkdownÊ†ºÂºè\n';
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n„ÄêÊñáÈ£éË¶ÅÊ±Ç„Äë'+styleD+'\n';
const chInfo=curEd.type==='novel'?'ËøôÊòØ„Äå'+(curEd.title||'')+'„ÄçÁöÑÁ¨¨'+(curEdCh+1)+'Á´†„ÄÇ':'';
let contextInfo='';
if(curEd.type==='novel'&&curEd.chapters&&curEdCh>0){
const prevCh=curEd.chapters[curEdCh-1]||'';
if(prevCh)contextInfo='\n\n„Äê‰∏ä‰∏ÄÁ´†ÁªìÂ∞æÂèÇËÄÉ„Äë\n'+prevCh.substring(prevCh.length-300)+'\n';
}
let outlineInfo='';
if(curEd.outline){
outlineInfo='\n\n„ÄêÂ∞èËØ¥Â§ßÁ∫≤ÂèÇËÄÉ„Äë\n'+curEd.outline.substring(0,500)+'\n';
}
const userMsg=chInfo+contextInfo+outlineInfo+'\n\nËØ∑ÈáçÂÜô‰ª•‰∏ãÁ´†ËäÇÂÜÖÂÆπÔºö\n\n'+text;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
if(useStream){
await callAPIStream(messages,
(fullText)=>{
ta.value=fullText;
updateEdWc();
},
(fullText)=>{
ta.disabled=false;
if(fullText){
ta.value=fullText;
updateEdWc();
saveEditorContent();
statusEl.textContent='ÈáçÂÜôÂÆåÊàê ‚úì';
showToast('Á´†ËäÇÂ∑≤ÈáçÂÜô ‚ú®');
}else{
statusEl.textContent='ÈáçÂÜôÂ∑≤ÂèñÊ∂à';
}
},
(errMsg)=>{
ta.disabled=false;
statusEl.textContent='ÈáçÂÜôÂ§±Ë¥•';
showToast('ÈáçÂÜôÂ§±Ë¥•Ôºö'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
ta.disabled=false;
if(result){
ta.value=result;
updateEdWc();
saveEditorContent();
statusEl.textContent='ÈáçÂÜôÂÆåÊàê ‚úì';
showToast('Á´†ËäÇÂ∑≤ÈáçÂÜô ‚ú®');
}else{
statusEl.textContent='ÈáçÂÜôÂ§±Ë¥•';
}
}
});
}
// AIÊâ©ÂÜô/Áº©ÂÜô
let expandMode='expand';// expand or shrink
function openAiExpand(){
if(!curEd){showToast('ËØ∑ÂÖàÊâìÂºÄ‰∏ÄÁØáÊñáÁ´†');return;}
expandMode='expand';
document.getElementById('expandTitle').textContent='üìà AIÊâ©ÂÜô';
document.getElementById('expandDesc').textContent='ÈÄâÊã©ÊàñÁ≤òË¥¥Ë¶ÅÊâ©ÂÜôÁöÑÊÆµËêΩÔºåAI‰ºöÊ∑ªÂä†Êõ¥Â§öÁªÜËäÇ„ÄÅÊÑüÂÆòÊèèÂÜô„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â';
document.getElementById('expandDoBtn').textContent='üöÄ ÂºÄÂßãÊâ©ÂÜô';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function openAiShrink(){
if(!curEd){showToast('ËØ∑ÂÖàÊâìÂºÄ‰∏ÄÁØáÊñáÁ´†');return;}
expandMode='shrink';
document.getElementById('expandTitle').textContent='üìâ AIÁº©ÂÜô';
document.getElementById('expandDesc').textContent='ÈÄâÊã©ÊàñÁ≤òË¥¥Ë¶ÅÁº©ÂÜôÁöÑÊÆµËêΩÔºåAI‰ºöÁ≤æÁÆÄÂÜÖÂÆπ„ÄÅ‰øùÁïôÊ†∏ÂøÉ‰ø°ÊÅØ';
document.getElementById('expandDoBtn').textContent='üöÄ ÂºÄÂßãÁº©ÂÜô';
document.getElementById('expandInput').value='';
document.getElementById('expandHint').value='';
document.getElementById('expandOutput').value='';
document.getElementById('expandResult').style.display='none';
document.getElementById('expandBtns').style.display='flex';
document.getElementById('expandOv').classList.add('show');
setTimeout(()=>document.getElementById('expandInput').focus(),200);
}
function closeExpandOv(){
document.getElementById('expandOv').classList.remove('show');
if(abortCtrl){abortCtrl.abort();abortCtrl=null;}
}
async function doExpand(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return;}
const input=(document.getElementById('expandInput').value||'').trim();
if(!input){showToast('ËØ∑ËæìÂÖ•Ë¶ÅÂ§ÑÁêÜÁöÑÂÜÖÂÆπ');return;}
if(countWords(input)<5){showToast('ÂÜÖÂÆπÂ§™Â∞ëÔºåËá≥Â∞ë5‰∏™Â≠ó');return;}
const hint=(document.getElementById('expandHint').value||'').trim();
const btn=document.getElementById('expandDoBtn');
btn.disabled=true;
btn.innerHTML='Â§ÑÁêÜ‰∏≠ <span class="ldots"><span></span><span></span><span></span></span>';
document.getElementById('expandResult').style.display='block';
document.getElementById('expandOutput').value='Ê≠£Âú®Â§ÑÁêÜ...';
let sysMsg='';
if(expandMode==='expand'){
sysMsg='‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊñáÂ≠¶Ê∂¶Ëâ≤Â∏àÔºåÊìÖÈïøÊâ©ÂÜôÊñáÁ´†ÊÆµËêΩ„ÄÇ\n\n';
sysMsg+='„ÄêÊâ©ÂÜôÂéüÂàô„Äë\n';
sysMsg+='1. ‰øùÊåÅÂéüÊñáÁöÑÊ†∏ÂøÉÊÉÖËäÇÂíå‰∫∫Áâ©ÂÖ≥Á≥ª‰∏çÂèò\n';
sysMsg+='2. Â¢ûÂä†ÊÑüÂÆòÁªÜËäÇÔºàËßÜËßâ„ÄÅÂê¨Ëßâ„ÄÅËß¶Ëßâ„ÄÅÂóÖËßâ„ÄÅÂë≥ËßâÔºâ\n';
sysMsg+='3. ‰∏∞ÂØå‰∫∫Áâ©ÁöÑÂæÆË°®ÊÉÖ„ÄÅÂ∞èÂä®‰Ωú„ÄÅÂøÉÁêÜÊ¥ªÂä®\n';
sysMsg+='4. Ë°•ÂÖÖÁéØÂ¢ÉÊ∞õÂõ¥ÊèèÂÜô\n';
sysMsg+='5. ËÆ©ÂØπËØùÊõ¥Ëá™ÁÑ∂ÔºåÂèØ‰ª•Âä†ÂÖ•ÂÅúÈ°ø„ÄÅËØ≠Ê∞îËØç\n';
sysMsg+='6. Êâ©ÂÜôÂêéÂ≠óÊï∞Â∫î‰∏∫ÂéüÊñáÁöÑ1.5-2.5ÂÄç\n';
sysMsg+='7. Áõ¥Êé•ËæìÂá∫Êâ©ÂÜôÂêéÁöÑÂÜÖÂÆπÔºå‰∏çÂä†‰ªª‰ΩïËØ¥Êòé\n';
}else{
sysMsg='‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊñáÂ≠¶ÁºñËæëÔºåÊìÖÈïøÁ≤æÁÆÄÊñáÁ´†„ÄÇ\n\n';
sysMsg+='„ÄêÁº©ÂÜôÂéüÂàô„Äë\n';
sysMsg+='1. ‰øùÁïôÊ†∏ÂøÉÊÉÖËäÇÂíåÂÖ≥ÈîÆ‰ø°ÊÅØ\n';
sysMsg+='2. Âà†Èô§ÂÜó‰ΩôÁöÑÂΩ¢ÂÆπËØçÂíåÂâØËØç\n';
sysMsg+='3. ÂêàÂπ∂ÈáçÂ§çË°®ËææÁöÑÂÜÖÂÆπ\n';
sysMsg+='4. ÁÆÄÂåñËøáÈïøÁöÑÂØπËØùÔºå‰øùÁïôÂÖ≥ÈîÆÂè∞ËØç\n';
sysMsg+='5. ÂéªÊéâ‰∏çÂΩ±ÂìçÁêÜËß£ÁöÑÁéØÂ¢ÉÊèèÂÜô\n';
sysMsg+='6. Áº©ÂÜôÂêéÂ≠óÊï∞Â∫î‰∏∫ÂéüÊñáÁöÑ40%-70%\n';
sysMsg+='7. Áõ¥Êé•ËæìÂá∫Áº©ÂÜôÂêéÁöÑÂÜÖÂÆπÔºå‰∏çÂä†‰ªª‰ΩïËØ¥Êòé\n';
}
const styleD=(document.getElementById('styleDesc')&&document.getElementById('styleDesc').value||ap.curStyle||'').trim();
if(styleD)sysMsg+='\n„Äê‰øùÊåÅÊñáÈ£é„Äë\n'+styleD+'\n';
let userMsg=expandMode==='expand'?'ËØ∑Êâ©ÂÜô‰ª•‰∏ãÊÆµËêΩÔºö\n\n':'ËØ∑Áº©ÂÜô‰ª•‰∏ãÊÆµËêΩÔºö\n\n';
userMsg+=input;
if(hint)userMsg+='\n\n„ÄêÁâπÂà´Ë¶ÅÊ±Ç„Äë'+hint;
const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];
const outputEl=document.getElementById('expandOutput');
if(useStream){
await callAPIStream(messages,
(fullText)=>{
outputEl.value=fullText;
},
(fullText)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'üöÄ ÂºÄÂßãÊâ©ÂÜô':'üöÄ ÂºÄÂßãÁº©ÂÜô';
if(fullText){
outputEl.value=fullText;
const oldWc=countWords(input);
const newWc=countWords(fullText);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'Êâ©ÂÜô':'Áº©ÂÜô')+'ÂÆåÊàêÔºÅÂéüÊñá'+oldWc+'Â≠ó‚Üí'+newWc+'Â≠ó('+ratio+'%)');
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent=expandMode==='expand'?'üöÄ ÂºÄÂßãÊâ©ÂÜô':'üöÄ ÂºÄÂßãÁº©ÂÜô';
outputEl.value='Â§ÑÁêÜÂ§±Ë¥•Ôºö'+errMsg;
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent=expandMode==='expand'?'üöÄ ÂºÄÂßãÊâ©ÂÜô':'üöÄ ÂºÄÂßãÁº©ÂÜô';
if(result){
outputEl.value=result;
const oldWc=countWords(input);
const newWc=countWords(result);
const ratio=((newWc/oldWc)*100).toFixed(0);
showToast((expandMode==='expand'?'Êâ©ÂÜô':'Áº©ÂÜô')+'ÂÆåÊàêÔºÅÂéüÊñá'+oldWc+'Â≠ó‚Üí'+newWc+'Â≠ó('+ratio+'%)');
}else{
outputEl.value='Â§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆ';
}
}
}
// ÂØºÂá∫TXTÊñá‰ª∂
function exportToTxtFile(filename,content){
const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
if(window.showSaveFilePicker){
(async()=>{
try{
const handle=await window.showSaveFilePicker({
suggestedName:filename,
types:[{description:'ÊñáÊú¨Êñá‰ª∂',accept:{'text/plain':['.txt']}}]
});
const writable=await handle.createWritable();
await writable.write(blob);
await writable.close();
showToast('Êñá‰ª∂Â∑≤‰øùÂ≠ò üì•');
}catch(e){
if(e.name!=='AbortError')fallbackTxtExport(filename,blob);
}
})();
return;
}
fallbackTxtExport(filename,blob);
}
function fallbackTxtExport(filename,blob){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=filename;
a.style.display='none';
document.body.appendChild(a);
a.click();
setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},1000);
showToast('Êñá‰ª∂Â∑≤ÂØºÂá∫ üì•');
}
function buildTxtContent(title,chapters,isAI){
let content='';
if(isAI){
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„Äå'+title+'„Äç\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
content+='„ÄêÂ£∞Êòé„Äë\n';
content+='Êú¨ÊñáÁî±„ÄåÁ¨îËÆ∞AI„ÄçËæÖÂä©Âàõ‰ΩúÁîüÊàê\n';
content+='Âàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI ¬∑ AIÂàõ‰ΩúÂ∑•Âùä\n';
content+='Â∑•ÂÖ∑‰ΩúËÄÖÔºöÂøÉÁî∞\n';
content+='ÂØºÂá∫Êó∂Èó¥Ôºö'+new Date().toLocaleString()+'\n\n';
content+='„ÄêAIÂàõ‰ΩúÊèêÁ§∫„Äë\n';
content+='Êú¨ÊñáÂÜÖÂÆπÁî±AIËæÖÂä©ÁîüÊàêÔºå‰ªÖ‰æõÂèÇËÄÉÂíåÂ®±‰πê„ÄÇ\n';
content+='AIÁîüÊàêÁöÑÂÜÖÂÆπÂèØËÉΩÂ≠òÂú®‰∫ãÂÆûÈîôËØØÊàñ‰∏çÂΩìË°®Ëø∞Ôºå\n';
content+='ËØ∑ËØªËÄÖËá™Ë°åÁîÑÂà´ÔºåÂàáÂãø‰Ωú‰∏∫‰∏ì‰∏ö‰æùÊçÆ„ÄÇ\n';
content+='Â¶ÇÈúÄËΩ¨ËΩΩÊàñÂèëÂ∏ÉÔºåËØ∑Ê≥®ÊòéAIËæÖÂä©Âàõ‰Ωú„ÄÇ\n\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄÊ≠£„ÄÄÊñá„ÄÄÂºÄ„ÄÄÂßã\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n\n';
}else{
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„Äå'+title+'„Äç\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
content+='ÂØºÂá∫Êó∂Èó¥Ôºö'+new Date().toLocaleString()+'\n';
content+='Âàõ‰ΩúÂ∑•ÂÖ∑ÔºöÁ¨îËÆ∞AI\n\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n\n';
}
// Ê≠£Êñá
if(Array.isArray(chapters)){
chapters.forEach((ch,i)=>{
content+='„ÄêÁ¨¨'+(i+1)+'Á´†„Äë\n\n';
content+=(ch||'').trim()+'\n\n\n';
});
}else{
content+=(chapters||'').trim()+'\n\n';
}
// ÁªìÂ∞æ
if(isAI){
content+='\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄ„ÄÄÊ≠£„ÄÄÊñá„ÄÄÁªì„ÄÄÊùü\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
content+='„ÄêÂÖ≥‰∫éÁ¨îËÆ∞AI„Äë\n';
content+='Á¨îËÆ∞AIÊòØ‰∏ÄÊ¨æÂü∫‰∫éÂ§ßËØ≠Ë®ÄÊ®°ÂûãÁöÑAIÂàõ‰ΩúÂ∑•ÂùäÔºå\n';
content+='Â∏ÆÂä©Âàõ‰ΩúËÄÖÂø´ÈÄüÁîüÊàêÈ´òË¥®ÈáèÁöÑÂ∞èËØ¥„ÄÅÊï£ÊñáÁ≠âÊñáÂ≠¶‰ΩúÂìÅ„ÄÇ\n\n';
content+='ÂäüËÉΩÁâπËâ≤Ôºö\n';
content+='¬∑ ÈïøÁØáËøûËΩΩ & Áü≠ÁØá‰∏ÄÂèë\n';
content+='¬∑ Ëá™ÂÆö‰πâ‰∫∫Áâ©„ÄÅ‰∏ñÁïåËßÇ„ÄÅÊñáÈ£é„ÄÅËßÑÂàô\n';
content+='¬∑ AIÁª≠ÂÜô„ÄÅÊâ©ÂÜô„ÄÅÁº©ÂÜô„ÄÅÈáçÂÜô\n';
content+='¬∑ Á´†ËäÇÂ§ßÁ∫≤ÁÆ°ÁêÜ\n';
content+='¬∑ Â§ö‰∏ªÈ¢òÁïåÈù¢ÁæéÂåñ\n\n';
content+='Â∑•ÂÖ∑‰ΩúËÄÖÔºöÂøÉÁî∞\n';
content+='ËÅîÁ≥ªÊñπÂºèÔºö\n';
content+='¬∑ Â∞èÁ∫¢‰π¶Ôºö95567118758\n';
content+='¬∑ Â∞èÁ∫¢‰π¶Ôºö27418565861\n';
content+='¬∑ ÂæÆ‰ø°ÔºöAa9620520\n';
content+='¬∑ QQÔºö962005530\n\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='ÊÑüË∞¢‰ΩøÁî®Á¨îËÆ∞AIÔºåÁ•ùÂàõ‰ΩúÊÑâÂø´ÔºÅ\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
}else{
content+='\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
content+='ÂØºÂá∫Ëá™ÔºöÁ¨îËÆ∞AI ¬∑ Âàõ‰ΩúÂ∑•ÂÖ∑\n';
content+='‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
}
return content;
}
// ‰ªéÂàõ‰ΩúÈ°µÂØºÂá∫
function exportCrToTxt(){
if(crWorks.length===0){showToast('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑ‰ΩúÂìÅ');return;}
// Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™‰ΩúÂìÅÔºåÁõ¥Êé•ÂØºÂá∫
if(crWorks.length===1){
const w=crWorks[0];
doExportWork(w,false);
return;
}
// Â§ö‰∏™‰ΩúÂìÅÔºåËÆ©Áî®Êà∑ÈÄâÊã©
const items=crWorks.map((w,i)=>({
id:w.id,
label:(w.type==='draft'?'[ËçâÁ®ø] ':'[Â∞èËØ¥] ')+(w.title||'Êó†Ê†áÈ¢ò'),
wc:getCrWordCount(w)
}));
showSelectDlg('ÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑ‰ΩúÂìÅ',items,(id)=>{
const w=crWorks.find(x=>x.id===id);
if(w)doExportWork(w,false);
});
}
// ‰ªéÁºñËæëÂô®ÂØºÂá∫
function exportEdToTxt(){
if(!curEd){showToast('Ê≤°ÊúâÊâìÂºÄÁöÑ‰ΩúÂìÅ');return;}
saveEditorContent();
doExportWork(curEd,false);
}
// ‰ªéÊî∂ËóèÂØºÂá∫
function exportBookToTxt(id){
const book=cols.books.find(b=>b.id===id);
if(!book){showToast('Êâæ‰∏çÂà∞ËØ•‰π¶Á±ç');return;}
doExportWork(book,true);
}
// ÊâßË°åÂØºÂá∫
function exportSingleCrWork(id){
const w=crWorks.find(x=>x.id===id);
if(!w){showToast('Êâæ‰∏çÂà∞ËØ•‰ΩúÂìÅ');return;}
doExportWork(w,false);
}
function doExportWork(work,isAI){
const title=work.title||'Êú™ÂëΩÂêç';
let chapters;
if(work.type==='novel'||work.chapters){
chapters=work.chapters||[];
}else{
chapters=work.content||'';
}
const content=buildTxtContent(title,chapters,isAI);
const filename=title.replace(/[\\/:*?"<>|]/g,'_')+'_'+new Date().toLocaleDateString().replace(/\//g,'-')+'.txt';
exportToTxtFile(filename,content);
}
// ÈÄâÊã©ÂºπÁ™ó
function showSelectDlg(title,items,onSelect){
document.getElementById('dlgTitle').textContent=title;
const listHtml=items.map(it=>
'<div style="padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:9px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center" onclick="selectDlgItem(\''+it.id+'\')">'+
'<span style="font-size:12px">'+esc(it.label)+'</span>'+
'<span style="font-size:10px;color:var(--text2)">'+it.wc+'Â≠ó</span>'+
'</div>'
).join('');
document.getElementById('dlgMsg').innerHTML=listHtml;
document.getElementById('dlgOkBtn').style.display='none';
window._selectDlgCallback=onSelect;
document.getElementById('dlgOv').classList.add('show');
}
function selectDlgItem(id){
closeDlg();
document.getElementById('dlgOkBtn').style.display='';
if(window._selectDlgCallback){
window._selectDlgCallback(id);
window._selectDlgCallback=null;
}
}
function copyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text){showToast('Ê≤°ÊúâÂÜÖÂÆπÂèØÂ§çÂà∂');return;}
doCopy(text);
}
function applyExpandResult(){
const text=document.getElementById('expandOutput').value;
if(!text||text.startsWith('Â§ÑÁêÜÂ§±Ë¥•')||text==='Ê≠£Âú®Â§ÑÁêÜ...'){showToast('Ê≤°ÊúâÊúâÊïàÁªìÊûú');return;}
const ta=document.getElementById('edTextarea');
const original=document.getElementById('expandInput').value;
// Â∞ùËØïÊõøÊç¢ÂéüÊñá
const currentText=ta.value;
if(currentText.includes(original)){
ta.value=currentText.replace(original,text);
onEditorInput();
closeExpandOv();
showToast('Â∑≤ÊõøÊç¢ÂéüÊñá ‚úÖ');
}else{
// ÂéüÊñá‰∏çÂú®ÂΩìÂâçÁ´†ËäÇÔºåËøΩÂä†Âà∞Êú´Â∞æ
showDlg('Êó†Ê≥ïÂÆö‰ΩçÂéüÊñá','ÂéüÊñá‰∏çÂú®ÂΩìÂâçÁ´†ËäÇ‰∏≠ÔºåÊòØÂê¶Â∞ÜÁªìÊûúËøΩÂä†Âà∞Á´†ËäÇÊú´Â∞æÔºü',()=>{
ta.value=currentText+'\n\n'+text;
onEditorInput();
closeExpandOv();
showToast('Â∑≤ËøΩÂä†Âà∞Êú´Â∞æ ‚úÖ');
});
}
}
function setTempPreset(temp,name){
document.getElementById('apiTemp').value=temp;
document.getElementById('quickTemp').value=temp;
document.getElementById('qtVal').textContent=temp;
showToast('Â∑≤ÂàáÊç¢‰∏∫„Äå'+name+'„ÄçÊ®°Âºè (T='+temp+')');
}
function toggleStreamSwitch(el){
const cb=document.getElementById('streamOn');
cb.checked=!cb.checked;
useStream=cb.checked;
sv('bj_stream',useStream);
updateStreamUI();
showToast(useStream?'Â∑≤ÂºÄÂêØÊµÅÂºèËæìÂá∫':'Â∑≤ÂÖ≥Èó≠ÊµÅÂºèËæìÂá∫');
}
function updateStreamUI(){
const track=document.getElementById('streamTrack');
const thumb=document.getElementById('streamThumb');
if(useStream){
track.style.background='var(--accent)';
thumb.style.left='22px';
}else{
track.style.background='var(--border)';
thumb.style.left='2px';
}
}
function openInspiration(){
const subjects=[
'‰∏Ä‰∏™Â§±ÊòéÁöÑÁîªÂÆ∂','‰∏Ä‰∏™ËÉΩÂê¨Âà∞‰∫°ËÄÖÂ£∞Èü≥ÁöÑÊÆ°Ëë¨Â∏à','‰∏Ä‰∏™ËÆ∞ÂøÜÂè™Êúâ‰∏ÉÂ§©ÁöÑ‰æ¶Êé¢',
'‰∏Ä‰∏™Ê∞∏ËøúÊó†Ê≥ïËØ¥Ë∞éÁöÑÂæãÂ∏à','‰∏Ä‰∏™ËÉΩÈóªÂà∞ÊÉÖÁª™ÁöÑË∞ÉÈ¶ôÂ∏à','‰∏Ä‰∏™ÂÆ≥ÊÄïÊ∞¥ÁöÑÁÅØÂ°îÂÆàÊä§‰∫∫',
'‰∏Ä‰∏™Âè™Âú®Èõ®Â§©Âá∫Áé∞ÁöÑÂø´ÈÄíÂëò','‰∏Ä‰∏™ËÉΩÁúãÂà∞Á∫¢Á∫øÁöÑÊúàËÄÅÂÆû‰π†Áîü','‰∏Ä‰∏™‰∏ç‰ºöÂÅöÊ¢¶ÁöÑÂøÉÁêÜÂåªÁîü',
'‰∏Ä‰∏™Ë¢´ËØÖÂííÊ∞∏ËøúÊ∏ÖÈÜíÁöÑÂ§±Áú†ËÄÖ','‰∏Ä‰∏™ËÉΩÂíåÂä®Áâ©‰∫§Ë∞àÁöÑÂÖΩÂåª','‰∏Ä‰∏™ÊØèÂ§©ÈÉΩ‰ºöÊ≠ª‰∏ÄÊ¨°ÁöÑ‰∏çÊ≠ªËÄÖ',
'‰∏Ä‰∏™Êî∂ÈõÜÈÅóË®ÄÁöÑÈÇÆÂ∑Æ','‰∏Ä‰∏™ËÉΩËß¶Êë∏Âà∞Â£∞Èü≥ÁöÑËÅã‰∫∫','‰∏Ä‰∏™ÂΩ±Â≠ê‰ºöËá™Â∑±Ë°åÂä®ÁöÑÊôÆÈÄö‰∫∫',
'‰∏Ä‰∏™Âè™ËÉΩÂú®ÈïúÂ≠êÈáåÁúãÂà∞Êú™Êù•ÁöÑÂç†ÂçúÂ∏à','‰∏Ä‰∏™Ë°ÄÊ∂≤ÊòØÂ¢®Ê∞¥ÁöÑ‰ΩúÂÆ∂','‰∏Ä‰∏™ËÉΩÂ∞ùÂá∫Ë∞éË®ÄÂë≥ÈÅìÁöÑÂé®Â∏à',
'ÂèåËÉûËÉé‰∏≠Ë¢´ÈÅóÂøòÁöÑÈÇ£‰∏Ä‰∏™','‰∏Ä‰∏™ÈÄÄ‰ºëÁöÑÊó∂Èó¥ÊóÖË°åËÄÖ','‰∏Ä‰∏™‰ª•Ë¥©ÂçñËÆ∞ÂøÜ‰∏∫ÁîüÁöÑÂïÜ‰∫∫'
];
const events=[
'Âú®‰∏Ä‰∏™Ê∞∏Ëøú‰∏ãÈõ™ÁöÑÂüéÂ∏ÇÈáåÂèëÁé∞‰∫Ü‰∏ÄÂ∞ÅÊù•Ëá™Ëá™Â∑±ÁöÑ‰ø°',
'Âú®Ê∑±Â§úÁöÑÂú∞ÈìÅÁ´ôÈÅáÂà∞‰∫Ü‰∏Ä‰∏™‰∏çËØ•Â≠òÂú®ÁöÑ‰∫∫',
'Êî∂Âà∞‰∫Ü‰∏Ä‰ªΩÊù•Ëá™ÂçÅÂπ¥ÂêéÁöÑÂåÖË£π',
'Âú®ÊóßÂÖ¨ÂØìÁöÑÂ¢ôÂ£ÅÈáåÂèëÁé∞‰∫Ü‰∏Ä‰∏™ÈÄöÂæÄÂà´Â§ÑÁöÑÈó®',
'Âú®Êö¥È£éÈõ®ÁöÑÂ§úÊôöÊé•Âà∞‰∫Ü‰∏Ä‰∏™Â∑≤ÁªèÂéª‰∏ñ‰πã‰∫∫ÁöÑÁîµËØù',
'ÂèëÁé∞Ëá™Â∑±ÊØèÂ§©ÈÜíÊù•ÈÉΩÂú®‰∏çÂêå‰∫∫ÁöÑË∫´‰ΩìÈáå',
'Âú®Ë∑≥Ëö§Â∏ÇÂú∫‰π∞Âà∞‰∫Ü‰∏ÄÊú¨ËÆ∞ÂΩïÁùÄËá™Â∑±‰∏ÄÁîüÁöÑ‰π¶',
'Âú®‰∏ÄÂú∫Â§ßÈõæ‰∏≠Ëµ∞Ëøõ‰∫Ü‰∏Ä‰∏™Âú∞Âõæ‰∏ä‰∏çÂ≠òÂú®ÁöÑÂ∞èÈïá',
'ÂèëÁé∞ÈïúÂ≠êÈáåÁöÑËá™Â∑±ÂºÄÂßãÂÅöÂá∫‰∏çÂêåÁöÑÂä®‰Ωú',
'Âú®‰∏ÄÊ£µÂè§Ê†ëÁöÑÊ†ëÊ¥ûÈáåÂèëÁé∞‰∫Ü‰∏ÄÁôæÂπ¥ÂâçÂÜôÁªôËá™Â∑±ÁöÑÊÉÖ‰π¶',
'Ë¢´‰∏Ä‰∏™ÈôåÁîü‰∫∫ÈÄí‰∫Ü‰∏ÄÊääÈí•ÂåôÔºåËØ¥"‰Ω†Áü•ÈÅìËØ•ÊâìÂºÄ‰ªÄ‰πà"',
'Âú®ÂåªÈô¢ÈÜíÊù•ÔºåÊâÄÊúâ‰∫∫ÈÉΩËØ¥Ëá™Â∑±Â∑≤ÁªèÊ∂àÂ§±‰∫Ü‰∏âÂπ¥',
'ÂèëÁé∞Ëá™Â∑±ÂÖªÁöÑÁå´ÊØèÂ§©ÂáåÊô®‰∏âÁÇπÈÉΩ‰ºöÂèòÊàê‰∫∫ÂΩ¢',
'Âú®‰∏ÄÂú∫Ëë¨Á§º‰∏äËÆ§Âá∫‰∫ÜÊ£∫ÊùêÈáåÁöÑ‰∫∫ÊòØËá™Â∑±',
'Êî∂Âà∞‰∏ÄÂº†Âè™ÂÜô‰∫ÜÁªèÁ∫¨Â∫¶ÁöÑÊòé‰ø°ÁâáÔºåÂà∞ËææÂêéÂèëÁé∞‰∫Ü‰∏çÂèØÊÄùËÆÆÁöÑ‰∏úË•ø'
];
const twists=[
'‰ΩÜÁúüÁõ∏ËøúÊØîÊÉ≥Ë±°ÁöÑÊõ¥‰ª§‰∫∫ÂøÉÁ¢é','ËÄåËøô‰∏ÄÂàáÁöÑËÉåÂêéËóèÁùÄ‰∏Ä‰∏™ÂÖ≥‰∫éÊïëËµéÁöÑÁßòÂØÜ',
'Âç¥ÂèëÁé∞ËøôÂè™ÊòØÊõ¥Â§ßË∞úÂõ¢ÁöÑÂºÄÂßã','ËÄå‰ª£‰ª∑ÊòØÂ§±ÂéªÊúÄÁèçË¥µÁöÑËÆ∞ÂøÜ',
'‰ΩÜÊØè‰∏ÄÊ¨°ÈÄâÊã©ÈÉΩÈÄöÂêëÂêå‰∏Ä‰∏™ÁªìÂ±Ä','ËÄåÂîØ‰∏ÄÁöÑÁ∫øÁ¥¢ÊåáÂêë‰∫ÜËá™Â∑±ÊúÄ‰ø°‰ªªÁöÑ‰∫∫',
'Âç¥Âú®ÊúÄÂêéÂèëÁé∞Ôºå‰∏ÄÂàáÈÉΩÊòØËá™Â∑±‰∫≤ÊâãÈÄ†ÊàêÁöÑ','‰ΩÜÊó∂Èó¥Â∑≤ÁªèÊâÄÂâ©Êó†Âá†',
'ËÄåËøô‰∏™‰∏ñÁïåÁöÑËßÑÂàôÊ≠£Âú®ÊÇÑÊÇÑÊîπÂèò','Âç¥‰∏çÁü•ÈÅìÊúâ‰∫∫‰∏ÄÁõ¥Âú®Êöó‰∏≠ÂÆàÊä§ÁùÄËøô‰∏ÄÂàá',
'‰ΩÜÂõûÂøÜÂíåÁé∞ÂÆû‰πãÈó¥ÁöÑÁïåÈôêÂºÄÂßãÊ®°Á≥ä','ËÄåÁªàÁÇπÁ´üÁÑ∂ÊòØ‰∏ÄÂàáÂºÄÂßãÁöÑÂú∞Êñπ'
];
const s=subjects[Math.floor(Math.random()*subjects.length)];
const e=events[Math.floor(Math.random()*events.length)];
const useTwist=Math.random()>0.4;
const t=useTwist?twists[Math.floor(Math.random()*twists.length)]:'';
const prompt=s+'Ôºå'+e+(t?'‚Äî‚Äî'+t:'');
document.getElementById('searchInput').value=prompt;
const wsBtn=document.querySelector('.bnav-i');
switchPage('workshop',wsBtn);
showToast('üí° ÁÅµÊÑüÂ∑≤Ê≥®ÂÖ•');
}
// ==================== NAME GENERATOR ====================
let nameGenType='char';
let nameGenStyle='';

function openNameGen(){
document.getElementById('nameGenDesc').value='';
document.getElementById('nameGenResult').style.display='none';
document.getElementById('nameGenBtn').disabled=false;
document.getElementById('nameGenBtn').textContent='‚ú® ÁîüÊàêÂêçÂ≠ó';
nameGenType='char';
nameGenStyle='';
document.getElementById('nameTypeChar').classList.add('act');
document.getElementById('nameTypeBook').classList.remove('act');
document.getElementById('nameTypePlace').classList.remove('act');
document.querySelectorAll('#nameGenOv .tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
document.getElementById('nameGenOv').classList.add('show');
setTimeout(()=>document.getElementById('nameGenDesc').focus(),200);
}

function closeNameGen(){
document.getElementById('nameGenOv').classList.remove('show');
}

function setNameType(type){
nameGenType=type;
document.getElementById('nameTypeChar').classList.toggle('act',type==='char');
document.getElementById('nameTypeBook').classList.toggle('act',type==='book');
document.getElementById('nameTypePlace').classList.toggle('act',type==='place');
}

function setNameStyle(style,el){
nameGenStyle=style;
const parent=el.parentElement;
parent.querySelectorAll('.tag').forEach(t=>{
if(t.onclick&&t.onclick.toString().includes('setNameStyle'))t.classList.remove('act');
});
el.classList.add('act');
}

async function doGenNames(){
const cfg=getCurApi();
if(!cfg.url||!cfg.key){showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');return;}

const desc=(document.getElementById('nameGenDesc').value||'').trim();
const btn=document.getElementById('nameGenBtn');
btn.disabled=true;
btn.innerHTML='ÁîüÊàê‰∏≠ <span class="ldots"><span></span><span></span><span></span></span>';

// ÊûÑÂª∫‰∏ä‰∏ãÊñá
let context='';
if(!desc){
// ‰ΩøÁî®ÂΩìÂâçËÆæÁΩÆ
const validChars=characters.filter(c=>c.name||c.desc);
if(validChars.length>0&&nameGenType==='char'){
context+='ÂΩìÂâç‰∫∫Áâ©ËÆæÂÆöÔºö\n';
validChars.forEach(c=>{
if(c.desc)context+=c.desc.substring(0,100)+'\n';
});
}
const wD=(document.getElementById('worldDesc')&&document.getElementById('worldDesc').value||'').trim();
if(wD)context+='‰∏ñÁïåËßÇÔºö'+wD.substring(0,200)+'\n';
}else{
context=desc;
}

const typeLabels={char:'‰∫∫Âêç',book:'‰π¶Âêç/Â∞èËØ¥Âêç',place:'Âú∞Âêç/Âú∫ÊâÄÂêç'};
const typeHints={
char:'Ë¶ÅÊ±ÇÔºöÂêçÂ≠óË¶ÅÊúâÂØìÊÑèÊàñÁâπËâ≤ÔºåÁ¨¶ÂêàËßíËâ≤Ë∫´‰ªΩÔºåÊúóÊúó‰∏äÂè£ÔºåÈÅøÂÖçÁîüÂÉªÂ≠ó',
book:'Ë¶ÅÊ±ÇÔºö‰π¶ÂêçË¶ÅÊúâÂê∏ÂºïÂäõÔºåËÉΩ‰ΩìÁé∞ÊïÖ‰∫ãÊ†∏ÂøÉÔºåËÆ©‰∫∫ÊÉ≥ÁÇπËøõÂéªÁúã',
place:'Ë¶ÅÊ±ÇÔºöÂú∞ÂêçË¶ÅÊúâÁîªÈù¢ÊÑüÔºåÁ¨¶Âêà‰∏ñÁïåËßÇËÆæÂÆöÔºå‰æø‰∫éËÆ∞ÂøÜ'
};

let sysMsg='‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÂëΩÂêçÂ∏àÔºåÊìÖÈïø‰∏∫Â∞èËØ¥Âàõ‰ΩúÂêÑÁßçÂêçÂ≠ó„ÄÇ\n';
sysMsg+='ËØ∑Ê†πÊçÆÁî®Êà∑Êèê‰æõÁöÑ‰ø°ÊÅØÔºåÁîüÊàê5‰∏™‰∏çÂêåÈ£éÊ†ºÁöÑ'+typeLabels[nameGenType]+'„ÄÇ\n\n';
sysMsg+='„ÄêËæìÂá∫Ê†ºÂºè„Äë‰∏•Ê†ºÊåâ‰ª•‰∏ãÊ†ºÂºèÔºåÊØèË°å‰∏Ä‰∏™Ôºö\n';
sysMsg+='1. ÂêçÂ≠ó - ÁÆÄÁü≠ÂØìÊÑèËØ¥ÊòéÔºà10Â≠ó‰ª•ÂÜÖÔºâ\n';
sysMsg+='2. ÂêçÂ≠ó - ÁÆÄÁü≠ÂØìÊÑèËØ¥Êòé\n';
sysMsg+='...‰ª•Ê≠§Á±ªÊé®ÔºåÂÖ±5‰∏™\n\n';
sysMsg+='„Äê'+typeHints[nameGenType]+'„Äë\n';
sysMsg+='‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÂÜÖÂÆπÔºåÂè™ËæìÂá∫5Ë°åÂêçÂ≠ó„ÄÇ\n';

let userMsg='ËØ∑ÁîüÊàê5‰∏™'+typeLabels[nameGenType]+'„ÄÇ\n\n';
if(nameGenStyle)userMsg+='È£éÊ†ºË¶ÅÊ±ÇÔºö'+nameGenStyle+'È£éÊ†º\n';
if(context)userMsg+='ÂèÇËÄÉ‰ø°ÊÅØÔºö\n'+context;
else userMsg+='Ëá™Áî±ÂèëÊå•ÔºåÁîüÊàêÊúâÁâπËâ≤ÁöÑÂêçÂ≠ó';

const messages=[{role:'system',content:sysMsg},{role:'user',content:userMsg}];

const resultDiv=document.getElementById('nameGenResult');
const listDiv=document.getElementById('nameGenList');

if(useStream){
let fullText='';
await callAPIStream(messages,
(text)=>{
fullText=text;
resultDiv.style.display='block';
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
},
(text)=>{
btn.disabled=false;
btn.textContent='üîÑ ÈáçÊñ∞ÁîüÊàê';
if(text){
parseAndShowNames(text);
}
},
(errMsg)=>{
btn.disabled=false;
btn.textContent='‚ú® ÁîüÊàêÂêçÂ≠ó';
showToast('ÁîüÊàêÂ§±Ë¥•Ôºö'+errMsg,3000);
}
);
}else{
const result=await callAPINonStream(messages);
btn.disabled=false;
btn.textContent='üîÑ ÈáçÊñ∞ÁîüÊàê';
if(result){
resultDiv.style.display='block';
parseAndShowNames(result);
}else{
showToast('ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËÆæÁΩÆ');
}
}
}

function parseAndShowNames(text){
const listDiv=document.getElementById('nameGenList');
listDiv.innerHTML='';

const lines=text.split('\n').filter(l=>l.trim());
lines.forEach(line=>{
const cleaned=line.replace(/^\d+[\.\„ÄÅ\)\]\s]*/,'').trim();
if(!cleaned)return;

const item=document.createElement('div');
item.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--card);border-radius:8px;border:1px solid var(--border);cursor:pointer;transition:all .2s';
item.onmouseenter=()=>{item.style.borderColor='var(--accent)';item.style.background='rgba(108,92,231,.08)';};
item.onmouseleave=()=>{item.style.borderColor='var(--border)';item.style.background='var(--card)';};

// ÂàÜÁ¶ªÂêçÂ≠óÂíåËØ¥Êòé
let name=cleaned;
let hint='';
const sepIdx=cleaned.search(/[\-\‚Äî\‚Äì\:Ôºö]/);
if(sepIdx>0){
name=cleaned.substring(0,sepIdx).trim();
hint=cleaned.substring(sepIdx+1).trim();
}

item.innerHTML=
'<div style="flex:1">'+
'<div style="font-size:14px;font-weight:600;color:var(--text)">'+esc(name)+'</div>'+
(hint?'<div style="font-size:10px;color:var(--text2);margin-top:2px">'+esc(hint)+'</div>':'')+
'</div>'+
'<button style="padding:4px 10px;border-radius:6px;border:1px solid var(--accent);background:transparent;color:var(--accent2);font-size:10px;cursor:pointer;flex-shrink:0" onclick="event.stopPropagation();copyName(\''+esc(name.replace(/'/g,"\\'"))+'\')">Â§çÂà∂</button>';

item.onclick=()=>copyName(name);
listDiv.appendChild(item);
});

if(listDiv.children.length===0){
listDiv.innerHTML='<div style="font-size:12px;color:var(--text);white-space:pre-wrap">'+esc(text)+'</div>';
}
}

function copyName(name){
doCopy(name);
showToast('Â∑≤Â§çÂà∂Ôºö'+name+' üìã');
}
// ==================== AUTO BACKUP ====================
function autoBackup(){
const lastBackup=localStorage.getItem('bj_lastBackup');
const now=Date.now();
const oneWeek=7*24*60*60*1000;
if(!lastBackup||now-parseInt(lastBackup)>oneWeek){
// Ë∂ÖËøá‰∏ÄÂë®Ê≤°Â§á‰ªΩÔºåÊèêÈÜíÁî®Êà∑
const usage=getStorageUsage();
if(usage>1024*1024){// Ë∂ÖËøá1MBÊï∞ÊçÆÊâçÊèêÈÜí
setTimeout(()=>{
showToast('üíæ Â∑≤Êúâ‰∏ÄÂë®Êú™Â§á‰ªΩÔºåÂª∫ËÆÆÂØºÂá∫Êï∞ÊçÆ',4000);
},3000);
}
}
}

function markBackupDone(){
localStorage.setItem('bj_lastBackup',Date.now().toString());
}
// ==================== SPLASH & INIT ====================
function initApp(){
// Êï∞ÊçÆÂÆåÊï¥ÊÄßÊ£ÄÊü•
try{
if(!Array.isArray(ws))ws=[];
if(!cols||typeof cols!=='object')cols={books:[],shorts:[]};
if(!Array.isArray(cols.books))cols.books=[];
if(!Array.isArray(cols.shorts))cols.shorts=[];
if(!Array.isArray(tags))tags=['#Êó•Â∏∏','#bg','#Á©øË∂ä','#Â•áÂπª','#Ê†°Âõ≠'];
if(!Array.isArray(characters))characters=[{name:'',desc:''}];
if(!Array.isArray(crWorks))crWorks=[];
if(!Array.isArray(resPacks))resPacks=[];
// Ê∏ÖÁêÜÊó†ÊïàÊï∞ÊçÆ
ws=ws.filter(a=>a&&a.id);
cols.books=cols.books.filter(b=>b&&b.id);
cols.shorts=cols.shorts.filter(s=>s&&s.id);
crWorks=crWorks.filter(w=>w&&w.id);
}catch(e){
console.error('Êï∞ÊçÆÊ£ÄÊü•Â§±Ë¥•:',e);
showToast('Êï∞ÊçÆÂºÇÂ∏∏ÔºåÈÉ®ÂàÜÂäüËÉΩÂèØËÉΩÂèóÂΩ±Âìç',3000);
}
// Load saved settings
const sApi=ld(K.curApi,{});
if(sApi.url)document.getElementById('apiUrl').value=sApi.url;
if(sApi.key)document.getElementById('apiKey').value=sApi.key;
if(sApi.model)document.getElementById('apiModel').value=sApi.model;
if(sApi.temp!==undefined)document.getElementById('apiTemp').value=sApi.temp;
if(sApi.maxTokens)document.getElementById('apiMaxTokens').value=sApi.maxTokens;

const sWorld=ld(K.curWorld,{});
if(sWorld.desc)document.getElementById('worldDesc').value=sWorld.desc;
if(sWorld.minWords)document.getElementById('minWords').value=sWorld.minWords;
if(ap.curStyle&&document.getElementById('styleDesc'))document.getElementById('styleDesc').value=ap.curStyle;
if(curRule&&document.getElementById('ruleDesc'))document.getElementById('ruleDesc').value=curRule;
if(banWords&&document.getElementById('banWordsInput'))document.getElementById('banWordsInput').value=banWords;
document.getElementById('streamOn').checked=useStream;
document.getElementById('quickTemp').value=document.getElementById('apiTemp').value;
document.getElementById('qtVal').textContent=document.getElementById('apiTemp').value;
updateStreamUI();

renderTags();renderArticles();renderCharCards();applyAppearance();
document.getElementById('splashVer').textContent=APP_VER;
renderUserCard();
}

// È°µÈù¢ÂÖ≥Èó≠/ÂàáÊç¢Êó∂Ëá™Âä®‰øùÂ≠òÊâÄÊúâÊï∞ÊçÆ
window.addEventListener('beforeunload',()=>{
saveCurSettings();
autoSaveAll();
});
document.addEventListener('visibilitychange',()=>{
if(document.visibilityState==='hidden'){
saveCurSettings();
autoSaveAll();
}
});
// ÂÖ®Â±ÄÈîôËØØÊçïËé∑
window.onerror=function(msg,url,line,col,error){
console.error('ÂÖ®Â±ÄÈîôËØØ:',msg,url,line);
// ‰∏çÂºπÁ™óÊâìÊâ∞Áî®Êà∑ÔºåÂè™ËÆ∞ÂΩï
return false;
};
window.onunhandledrejection=function(e){
console.error('Êú™Â§ÑÁêÜÁöÑPromiseÈîôËØØ:',e.reason);
};

document.addEventListener('DOMContentLoaded', async () => {
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    const txt = document.getElementById('splashTxt');
    const bar = document.getElementById('splashBar');

    // ÁîüÊàêÁ≤íÂ≠ê
    const particlesContainer = document.getElementById('splashParticles');
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div');
        p.className = 'splash-particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 8 + 's';
        p.style.animationDuration = (6 + Math.random() * 4) + 's';
        particlesContainer.appendChild(p);
    }

    // ÂàùÂßãÂåñÊ≠•È™§
    txt.textContent = 'Ê≠£Âú®ËøûÊé•Êï∞ÊçÆÂ∫ì...';
    bar.style.width = '10%';

    try {
        // ÂàùÂßãÂåñIndexedDB
        await initDB();
        txt.textContent = 'Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...';
        bar.style.width = '30%';

        // ‰ªéIndexedDBÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
        await loadAllFromDB();
        txt.textContent = 'Ê≠£Âú®ÂàùÂßãÂåñÁªÑ‰ª∂...';
        bar.style.width = '60%';

        // ÂàùÂßãÂåñÂ∫îÁî®
        initApp();
        txt.textContent = 'Ê≠£Âú®Ê∏≤ÊüìÁïåÈù¢...';
        bar.style.width = '80%';

        setTimeout(() => {
            txt.textContent = 'ÂáÜÂ§áÂ∞±Áª™';
            bar.style.width = '100%';
        }, 200);

        setTimeout(() => {
            splash.classList.add('hide');
            app.classList.add('show');
        }, 600);

        setTimeout(() => {
            splash.style.display = 'none';
        }, 1400);

        setTimeout(autoBackup, 5000);

    } catch (e) {
        console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', e);
        txt.textContent = 'ÂàùÂßãÂåñÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®Ê®°Âºè...';
        // Âç≥‰ΩøIndexedDBÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÁî®localStorageÂêØÂä®
        setTimeout(() => {
            try { initApp(); } catch (e2) { console.error(e2); }
            splash.classList.add('hide');
            app.classList.add('show');
        }, 1000);
    }

    // Auto-save on input changes
    const autoSaveIds = ['apiUrl', 'apiKey', 'apiModel', 'apiTemp', 'apiMaxTokens', 'worldDesc', 'minWords', 'styleDesc'];
    autoSaveIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', debounce(saveCurSettings, 600));
            el.addEventListener('change', saveCurSettings);
        }
    });
});
</script>
</body>
</html>